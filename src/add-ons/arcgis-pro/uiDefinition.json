{
  "$schema": "https://schema.management.azure.com/schemas/2021-09-09/uiFormDefinition.schema.json",
  "view": {
    "kind": "Form",
    "properties": {
      "title": "Mission Landing Zone Add-On: ArcGIS Pro",
      "steps": [
        {
          "name": "basics",
          "label": "Basics",
          "elements": [
            {
              "name": "description",
              "type": "Microsoft.Common.TextBlock",
              "options": {
                "text": "The ArcGIS Pro add-on reduces the complexity in deploying ArcGIS Pro with SCCA and zero trust compliance.",
                "link": {
                  "label": "Click here to learn more about the ArcGIS Pro add-on",
                  "uri": "https://github.com/Azure/missionlz/blob/main/src/add-ons/arcgis-pro/README.md"
                }
              }
            },
            {
              "name": "scope",
              "type": "Microsoft.Common.ResourceScope",
              "instanceDetailsLabel": "",
              "location": {
                "resourceTypes": [
                  "Microsoft.Compute/availabilitySets",
                  "Microsoft.Compute/diskAccesses",
                  "Microsoft.Compute/diskEncryptionSets",
                  "Microsoft.Compute/virtualMachines",
                  "Microsoft.DesktopVirtualization/applicationGroups",
                  "Microsoft.DesktopVirtualization/hostPools",
                  "Microsoft.DesktopVirtualization/scalingPlans",
                  "Microsoft.DesktopVirtualization/workspaces",
                  "Microsoft.Insights/components",
                  "Microsoft.Insights/dataCollectionEndpoints",
                  "Microsoft.Insights/dataCollectionRules",
                  "Microsoft.Insights/privateLinkScopes",
                  "Microsoft.KeyVault/vaults",
                  "Microsoft.ManagedIdentity/userAssignedIdentities",
                  "Microsoft.NetApp/netAppAccounts",
                  "Microsoft.Network/azureFirewalls",
                  "Microsoft.Network/bastionHosts",
                  "Microsoft.Network/firewallPolicies",
                  "Microsoft.Network/networkInterfaces",
                  "Microsoft.Network/networkSecurityGroups",
                  "Microsoft.Network/privateDnsZones",
                  "Microsoft.Network/privateEndpoints",
                  "Microsoft.Network/publicIPAddresses",
                  "Microsoft.Network/routeTables",
                  "Microsoft.Network/virtualNetworks",
                  "Microsoft.OperationalInsights/workspaces",
                  "Microsoft.OperationsManagement/solutions",
                  "Microsoft.Resources/resourceGroups",
                  "Microsoft.Storage/storageAccounts",
                  "Microsoft.Web/serverfarms",
                  "Microsoft.Web/sites"
                ]
              }
            },
            {
              "name": "naming",
              "type": "Microsoft.Common.Section",
              "label": "Naming Components",
              "elements": [
                {
                  "name": "description",
                  "type": "Microsoft.Common.TextBlock",
                  "options": {
                    "text": "The values selected below will be used as components in your naming convention to name your Azure resource groups and resources.",
                    "link": {
                      "label": "Click here for more information on the naming convention used in this solution.",
                      "uri": "https://github.com/Azure/missionlz/blob/main/src/add-ons/azure-virtual-desktop/docs/design/naming.md"
                    }
                  }
                },
                {
                  "name": "identifier",
                  "type": "Microsoft.Common.TextBox",
                  "label": "Identifier",
                  "toolTip": "Input a 3 character identifier for the resource group and resource names created with this solution. The identifier should represent a unique value within your organization, such as a business unit or project.",
                  "placeholder": "Example: it1",
                  "constraints": {
                    "required": true,
                    "regex": "^[a-z][a-z0-9]{1,2}$",
                    "validationMessage": "The value must be 1 - 3 characters in length, alphanumeric, and lowercase."
                  }
                },
                {
                  "name": "environment",
                  "type": "Microsoft.Common.DropDown",
                  "visible": true,
                  "label": "Environment Abbreviation",
                  "defaultValue": "Development (dev)",
                  "toolTip": "Select the target environment for the solution. The single letter environment abbreviation will be used as part of the naming convention for the resoure groups and resources.",
                  "constraints": {
                    "required": true,
                    "allowedValues": [
                      {
                        "label": "Development (dev)",
                        "value": "dev"
                      },
                      {
                        "label": "Production (prod)",
                        "value": "prod"
                      },
                      {
                        "label": "Test (test)",
                        "value": "test"
                      }
                    ]
                  }
                }
              ]
            },
            {
              "name": "servicePrincipalsApi",
              "type": "Microsoft.Solutions.GraphApiControl",
              "request": {
                "method": "GET",
                "path": "/v1.0/serviceprincipals?$filter=appId eq '9cdead84-a844-4324-93f2-b2e6bb768d07'"
              }
            }
          ]
        },
        {
          "name": "identity",
          "label": "Identity",
          "elements": [
            {
              "name": "forestSection",
              "label": "Forest settings",
              "type": "Microsoft.Common.Section",
              "visible": true,
              "elements": [
                {
                  "name": "domainName",
                  "label": "Domain name",
                  "type": "Microsoft.Common.TextBox",
                  "toolTip": "Provide domain name for the selected Active Directory solution.",
                  "placeholder": "Example: contoso.com",
                  "constraints": {
                    "required": true
                  }
                }
              ]
            },
            {
              "name": "vmSection",
              "label": "Virtual machine settings",
              "type": "Microsoft.Common.Section",
              "visible": true,
              "elements": [
                {
                  "name": "hybridUseBenefit",
                  "type": "Microsoft.Common.CheckBox",
                  "label": "Enable hybrid use benefit?",
                  "toolTip": "Check here to enable the Hybrid Use Benefit on the domain controllers.",
                  "constraints": {
                    "required": false
                  }
                },
                {
                  "name": "vmSize",
                  "label": "Size",
                  "type": "Microsoft.Compute.SizeSelector",
                  "toolTip": "Select the size of the virtual machines for the domain controllers.",
                  "recommendedSizes": [
                    "Standard_D2s_v3"
                  ],
                  "osPlatform": "Windows",
                  "count": 2
                }
              ]
            },
            {
              "name": "domainAdministratorSection",
              "label": "Domain administrator settings",
              "type": "Microsoft.Common.Section",
              "visible": true,
              "elements": [
                {
                  "name": "username",
                  "type": "Microsoft.Compute.UserNameTextBox",
                  "label": "Username",
                  "defaultValue": "",
                  "toolTip": "Specify the username for the local administrator account on the domain controllers.",
                  "constraints": {
                    "required": true,
                    "regex": "^[a-z0-9A-Z]{1,30}$",
                    "validationMessage": "Only alphanumeric characters are allowed, and the value must be 1-30 characters long."
                  },
                  "osPlatform": "Windows"
                },
                {
                  "name": "password",
                  "type": "Microsoft.Common.PasswordBox",
                  "label": {
                    "password": "Password",
                    "confirmPassword": "Confirm password"
                  },
                  "defaultValue": "",
                  "toolTip": "Specify the password for the local administrator account on the domain controllers.",
                  "constraints": {
                    "required": true,
                    "regex": "^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!@$%^&*-]).{12,72}$",
                    "validationMessage": "The password must be alphanumeric, contain at least 12 characters, and have at least 1 letter, 1 number and one special character."
                  },
                  "options": {
                    "hideConfirmation": false
                  }
                }
              ]
            },
            {
              "name": "domainUserSection",
              "label": "Domain user settings",
              "type": "Microsoft.Common.Section",
              "visible": true,
              "elements": [
                {
                  "name": "username",
                  "type": "Microsoft.Compute.UserNameTextBox",
                  "label": "Username",
                  "defaultValue": "",
                  "toolTip": "Specify the username for the local administrator account on the domain controllers.",
                  "constraints": {
                    "required": true,
                    "regex": "^[a-z0-9A-Z]{1,30}$",
                    "validationMessage": "Only alphanumeric characters are allowed, and the value must be 1-30 characters long."
                  },
                  "osPlatform": "Windows"
                },
                {
                  "name": "password",
                  "type": "Microsoft.Common.PasswordBox",
                  "label": {
                    "password": "Password",
                    "confirmPassword": "Confirm password"
                  },
                  "defaultValue": "",
                  "toolTip": "Specify the password for the local administrator account on the domain controllers.",
                  "constraints": {
                    "required": true,
                    "regex": "^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!@$%^&*-]).{12,72}$",
                    "validationMessage": "The password must be alphanumeric, contain at least 12 characters, and have at least 1 letter, 1 number and one special character."
                  },
                  "options": {
                    "hideConfirmation": false
                  }
                }
              ]
            }
          ]
        },
        {
          "name": "avd",
          "label": "Azure Virtual Desktop",
          "elements": [
            {
              "name": "startVmOnConnect",
              "type": "Microsoft.Common.Section",
              "visible": true,
              "label": "Start VM On Connect",
              "elements": [
                {
                  "name": "description",
                  "type": "Microsoft.Common.TextBlock",
                  "options": {
                    "text": "Start VM On Connect is a feature of AVD that allows the AVD service to start virtual machines in your host pool when a user requests a session and the host is in a stopped or deallocated state. To configure this feature, you must enter the object ID for the \"Azure Virtual Desktop\" or \"Windows Virtual Desktop\" service principal that can be found in Entra ID.",
                    "link": {
                      "label": "Click here to learn more about finding the AVD Object ID.",
                      "uri": "https://learn.microsoft.com/azure/virtual-desktop/service-principal-assign-roles?tabs=portal#assign-an-azure-rbac-role-to-an-azure-virtual-desktop-service-principal"
                    }
                  }
                },
                {
                  "name": "avdObjectId",
                  "type": "Microsoft.Common.TextBox",
                  "label": "AVD Object ID",
                  "toolTip": "Input the object ID for the \"Azure Virtual Desktop\" or \"Windows Virtual Desktop\" service principal.",
                  "defaultValue": "[first(map(steps('basics').servicePrincipalsApi.value, (item) => item.id))]",
                  "constraints": {
                    "required": true,
                    "regex": "[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}$",
                    "validationMessage": "The value must be in GUID format."
                  }
                }
              ]
            },
            {
              "name": "assignment",
              "type": "Microsoft.Common.Section",
              "label": "Assignment",
              "visible": true,
              "elements": [
                {
                  "name": "description",
                  "type": "Microsoft.Common.TextBlock",
                  "visible": true,
                  "options": {
                    "text": "To access Azure Virtual Desktop, your end users will need to be assigned roles on the desktop application group and virtual machines. Select the desired security group below to give access to this AVD stamp.",
                    "link": {
                      "label": "Learn more about FSLogix storage options for sizing your groups.",
                      "uri": "https://learn.microsoft.com/azure/virtual-desktop/store-fslogix-profile"
                    }
                  }
                },
                {
                  "name": "groupPickerBlade",
                  "type": "Microsoft.Solutions.BladeInvokeControl",
                  "openBladeStatus": "[steps('avd').assignment.groupSelector.changing]",
                  "bladeReference": {
                    "name": "ObjectPickerBlade",
                    "extension": "Microsoft_AAD_IAM",
                    "parameters": {
                      "queries": 32,
                      "disablers": 4,
                      "bladeSubtitle": "Pick the group to assign",
                      "additionalQueriesOnSearch": 0,
                      "advancedQueryOptions": {
                        "suggestedObjectsOptions": {}
                      },
                      "selectionMaximum": 1,
                      "selectionMinimum": 1,
                      "bladeTitle": "Select Group",
                      "informationHeader": {
                        "informationText": "Select the group that requires access to the AVD stamp",
                        "informationLink": ""
                      },
                      "inviteEnabled": true,
                      "searchBoxLabel": "Search for a group",
                      "searchBoxPlaceHolderText": "Enter a string in the group name",
                      "searchBoxTooltip": "This is the tooltip",
                      "searchGridNoRowsMessage": "No groups found",
                      "selectButtonText": "Select Group",
                      "selectedGridLabel": "Selected Group",
                      "selectedGridNoRowsMessage": "You must select a group"
                    },
                    "inFullScreen": false
                  },
                  "transforms": {
                    "selection": "selectedObjects|[*].{displayName:displayName, objectId:id}"
                  }
                },
                {
                  "name": "groupSelector",
                  "type": "Microsoft.Common.Selector",
                  "label": "Select Group",
                  "keyPath": "displayName",
                  "descriptionKeyPath": "id",
                  "value": "[steps('avd').assignment.groupPickerBlade.transformed.selection]",
                  "visible": true,
                  "barColor": "[if(empty(steps('avd').assignment.groupPickerBlade), '#FF0000', '#7fba00')]",
                  "constraints": {
                    "required": true
                  },
                  "link": "[if(empty(steps('avd').assignment.groupPickerBlade), 'Select group', 'Re-select group')]"
                },
                {
                  "name": "groupOutput",
                  "type": "Microsoft.Common.InfoBox",
                  "visible": "[not(empty(steps('avd').assignment.groupSelector.value))]",
                  "options": {
                    "style": "None",
                    "text": "[replace(replace(replace(replace(string(map(steps('avd').assignment.groupSelector.value, (item) => item.displayName)), '[', ''), ']', ''), '\"', ''), ',', ', ')]"
                  }
                }
              ]
            },
            {
              "name": "workloadSection",
              "type": "Microsoft.Common.Section",
              "visible": true,
              "label": "Workload Type",
              "elements": [
                {
                  "name": "description",
                  "type": "Microsoft.Common.TextBlock",
                  "options": {
                    "text": "The workload type determines the size of the virtual machine deployed for the AVD session host. The sizes available for selection are optimized for graphics-intensive workloads like ArcGIS Pro. Be sure to select the appropriate workload type based on the performance needs of your users. If you are unsure which workload type to select, start with the Medium workload type and adjust as needed based on user feedback and performance metrics.",
                    "link": {
                      "label": "Click here to learn more about GPU accelerated virtual machines.",
                      "uri": "https://learn.microsoft.com/azure/virtual-machines/sizes/overview?tabs=breakdownseries%2Cgeneralsizelist%2Ccomputesizelist%2Cmemorysizelist%2Cstoragesizelist%2Cgpusizelist%2Cfpgasizelist%2Chpcsizelist#gpu-accelerated"
                    }
                  }
                },
                {
                  "name": "workloadType",
                  "type": "Microsoft.Common.DropDown",
                  "label": "Workload Type",
                  "visible": true,
                  "filter": true,
                  "defaultValue": "Medium",
                  "toolTip": "Select the type of image to deploy on the session hosts.",
                  "multiLine": true,
                  "constraints": {
                    "required": true,
                    "allowedValues": [
                      {
                        "label": "Light",
                        "description": "Simple 2-D map visualizations, basic analyses, and reporting.",
                        "value": "light"
                      },
                      {
                        "label": "Medium",
                        "description": "Advanced 2-D or 3-D map visualizations, multi-source data analyses leveraging geoprocessing tools, reporting, and editing.",
                        "value": "medium"
                      },
                      {
                        "label": "Heavy",
                        "description": "Complex 2-D or 3-D map visualizations including advanced symbology, analyses with visability and line of site, reporting, and editing.",
                        "value": "heavy"
                      }
                    ]
                  }
                },
                {
                  "name": "resourceSkusApi",
                  "type": "Microsoft.Solutions.ArmApiControl",
                  "request": {
                    "method": "GET",
                    "path": "[concat(steps('basics').scope.subscription.id, '/providers/Microsoft.Compute/skus?api-version=2021-07-01&$filter=location eq ', decodeUriComponent('%27'), steps('basics').scope.location.name, decodeUriComponent('%27'))]"
                  }
                },
                {
                  "name": "usageApi",
                  "type": "Microsoft.Solutions.ArmApiControl",
                  "condition": "[not(empty(steps('avd').workloadSection.resourceSkusApi))]",
                  "request": {
                    "method": "GET",
                    "path": "[concat(steps('basics').scope.subscription.id, '/providers/Microsoft.Compute/locations/', steps('basics').scope.location.name, '/usages?api-version=2025-04-01')]"
                  }
                },
                {
                  "name": "sizeLight",
                  "type": "Microsoft.Compute.SizeSelector",
                  "label": "Size",
                  "toolTip": "Select the size of the virtual machine for the AVD session host.",
                  "recommendedSizes": [
                    "Standard_NV4ads_V710_v5"
                  ],
                  "constraints": {
                    "allowedSizes": [
                      "Standard_NV4ads_V710_v5",
                      "Standard_NV8ads_V710_v5",
                      "Standard_NV4as_v4",
                      "Standard_NV8as_v4"
                    ]
                  },
                  "osPlatform": "Windows",
                  "imageReference": {
                    "publisher": "esri",
                    "offer": "pro-byol",
                    "sku": "pro-byol-36"
                  },
                  "count": 1,
                  "visible": "[equals(steps('avd').workloadSection.workloadType, 'light')]"
                },
                {
                  "name": "sizeLightQuotaError",
                  "type": "Microsoft.Common.InfoBox",
                  "visible": "[and(equals(steps('avd').workloadSection.workloadType, 'light'), less(coalesce(first(map(filter(steps('avd').workloadSection.usageApi.value, (item) => equals(item.name.value, first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeLight)), (item) => item.family)))), (item) => item.limit)), 0), add(mul(coalesce(parse(first(map(filter(first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeLight)), (item) => item.capabilities)), (item) => equals(item.name, 'vCPUs')), (item) => item.value))), 1), 1), coalesce(first(map(filter(steps('avd').workloadSection.usageApi.value, (item) => equals(item.name.value, first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeLight)), (item) => item.family)))), (item) => item.currentValue)), 0))))]",
                  "options": {
                    "style": "Error",
                    "text": "[concat('ERROR <br><br>The selected subscription does not have enough quota for the requested vCPUs: <br><br><b>Family:</b> ', replace(replace(replace(first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeLight)), (item) => item.family)), 'standard', 'Standard '), 'Family', ' Family vCPUs'), '  ', ' '), '<br><b>Current vCPU Quota:</b> ', string(coalesce(first(map(filter(steps('avd').workloadSection.usageApi.value, (item) => equals(item.name.value, first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeLight)), (item) => item.family)))), (item) => item.limit)), 0)), '<br><b>Current vCPU Usage:</b> ', string(coalesce(first(map(filter(steps('avd').workloadSection.usageApi.value, (item) => equals(item.name.value, first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeLight)), (item) => item.family)))), (item) => item.currentValue)), 0)), '<br><b>Requested vCPUs:</b> ', string(mul(parse(first(map(filter(first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeLight)), (item) => item.capabilities)), (item) => equals(item.name, 'vCPUs')), (item) => item.value))), 1)))]"
                  }
                },
                {
                  "name": "sizeMedium",
                  "type": "Microsoft.Compute.SizeSelector",
                  "label": "Size",
                  "toolTip": "Select the size of the virtual machine for the AVD session host.",
                  "recommendedSizes": [
                    "Standard_NV12ads_V710_v5"
                  ],
                  "constraints": {
                    "allowedSizes": [
                      "Standard_NV12ads_V710_v5",
                      "Standard_NV6ads_A10_v5",
                      "Standard_NC4as_T4_v3",
                      "Standard_NC8as_T4_v3",
                      "Standard_NV16as_v4"
                    ]
                  },
                  "osPlatform": "Windows",
                  "imageReference": {
                    "publisher": "esri",
                    "offer": "pro-byol",
                    "sku": "pro-byol-36"
                  },
                  "count": 1,
                  "visible": "[equals(steps('avd').workloadSection.workloadType, 'medium')]"
                },
                {
                  "name": "sizeMediumQuotaError",
                  "type": "Microsoft.Common.InfoBox",
                  "visible": "[and(equals(steps('avd').workloadSection.workloadType, 'medium'), less(coalesce(first(map(filter(steps('avd').workloadSection.usageApi.value, (item) => equals(item.name.value, first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeMedium)), (item) => item.family)))), (item) => item.limit)), 0), add(mul(coalesce(parse(first(map(filter(first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeMedium)), (item) => item.capabilities)), (item) => equals(item.name, 'vCPUs')), (item) => item.value))), 1), 1), coalesce(first(map(filter(steps('avd').workloadSection.usageApi.value, (item) => equals(item.name.value, first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeMedium)), (item) => item.family)))), (item) => item.currentValue)), 0))))]",
                  "options": {
                    "style": "Error",
                    "text": "[concat('ERROR <br><br>The selected subscription does not have enough quota for the requested vCPUs: <br><br><b>Family:</b> ', replace(replace(replace(first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeMedium)), (item) => item.family)), 'standard', 'Standard '), 'Family', ' Family vCPUs'), '  ', ' '), '<br><b>Current vCPU Quota:</b> ', string(coalesce(first(map(filter(steps('avd').workloadSection.usageApi.value, (item) => equals(item.name.value, first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeMedium)), (item) => item.family)))), (item) => item.limit)), 0)), '<br><b>Current vCPU Usage:</b> ', string(coalesce(first(map(filter(steps('avd').workloadSection.usageApi.value, (item) => equals(item.name.value, first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeMedium)), (item) => item.family)))), (item) => item.currentValue)), 0)), '<br><b>Requested vCPUs:</b> ', string(mul(parse(first(map(filter(first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeMedium)), (item) => item.capabilities)), (item) => equals(item.name, 'vCPUs')), (item) => item.value))), 1)))]"
                  }
                },
                {
                  "name": "sizeHeavy",
                  "type": "Microsoft.Compute.SizeSelector",
                  "label": "Size",
                  "toolTip": "Select the size of the virtual machine for the AVD session host.",
                  "recommendedSizes": [
                    "Standard_NV24ads_V710_v5"
                  ],
                  "constraints": {
                    "allowedSizes": [
                      "Standard_NV24ads_V710_v5",
                      "Standard_NV28adms_V710_v5",
                      "Standard_NV12ads_A10_v5",
                      "Standard_NV18ads_A10_v5",
                      "Standard_NC16as_T4_v3"
                    ]
                  },
                  "osPlatform": "Windows",
                  "imageReference": {
                    "publisher": "esri",
                    "offer": "pro-byol",
                    "sku": "pro-byol-36"
                  },
                  "count": 1,
                  "visible": "[equals(steps('avd').workloadSection.workloadType, 'heavy')]"
                },
                {
                  "name": "sizeHeavyQuotaError",
                  "type": "Microsoft.Common.InfoBox",
                  "visible": "[and(equals(steps('avd').workloadSection.workloadType, 'heavy'), less(coalesce(first(map(filter(steps('avd').workloadSection.usageApi.value, (item) => equals(item.name.value, first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeHeavy)), (item) => item.family)))), (item) => item.limit)), 0), add(mul(coalesce(parse(first(map(filter(first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeHeavy)), (item) => item.capabilities)), (item) => equals(item.name, 'vCPUs')), (item) => item.value))), 1), 1), coalesce(first(map(filter(steps('avd').workloadSection.usageApi.value, (item) => equals(item.name.value, first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeHeavy)), (item) => item.family)))), (item) => item.currentValue)), 0))))]",
                  "options": {
                    "style": "Error",
                    "text": "[concat('ERROR <br><br>The selected subscription does not have enough quota for the requested vCPUs: <br><br><b>Family:</b> ', replace(replace(replace(first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeHeavy)), (item) => item.family)), 'standard', 'Standard '), 'Family', ' Family vCPUs'), '  ', ' '), '<br><b>Current vCPU Quota:</b> ', string(coalesce(first(map(filter(steps('avd').workloadSection.usageApi.value, (item) => equals(item.name.value, first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeHeavy)), (item) => item.family)))), (item) => item.limit)), 0)), '<br><b>Current vCPU Usage:</b> ', string(coalesce(first(map(filter(steps('avd').workloadSection.usageApi.value, (item) => equals(item.name.value, first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeHeavy)), (item) => item.family)))), (item) => item.currentValue)), 0)), '<br><b>Requested vCPUs:</b> ', string(mul(parse(first(map(filter(first(map(filter(steps('avd').workloadSection.resourceSkusApi.value, (item) => contains(item.name, steps('avd').workloadSection.sizeHeavy)), (item) => item.capabilities)), (item) => equals(item.name, 'vCPUs')), (item) => item.value))), 1)))]"
                  }
                },
                {
                  "name": "ncast4v3Description",
                  "type": "Microsoft.Common.InfoBox",
                  "visible": "[endsWith(if(equals(steps('avd').workloadSection.workloadType, 'light'), steps('avd').workloadSection.sizeLight, if(equals(steps('avd').workloadSection.workloadType, 'medium'), steps('avd').workloadSection.sizeMedium, steps('avd').workloadSection.sizeHeavy)), 'as_T4_v3')]",
                  "options": {
                    "style": "Warning",
                    "text": "The NCasT4_v3 VM series does not support the installation of the GRID driver using the VM extension. Please ensure to manually install the driver after the deployment. Click this box to open a link to the driver documentation.",
                    "uri": "https://learn.microsoft.com/azure/virtual-machines/windows/n-series-driver-setup#nvidia-gridvgpu-drivers"
                  }
                }
              ]
            }
          ]
        },
        {
          "name": "compliance",
          "label": "Compliance",
          "elements": [
            {
              "name": "policySection",
              "label": "Azure Policy",
              "type": "Microsoft.Common.Section",
              "elements": [
                {
                  "name": "policySubsetDetailsTextBlock",
                  "type": "Microsoft.Common.TextBlock",
                  "options": {
                    "text": "Mission Landing Zone comes bundled with a relevant subset of available Azure policies."
                  }
                },
                {
                  "name": "policyOptionalTextBlock",
                  "type": "Microsoft.Common.TextBlock",
                  "options": {
                    "text": "Enabling policies is optional, but recommended."
                  }
                },
                {
                  "name": "deployPolicy",
                  "type": "Microsoft.Common.CheckBox",
                  "label": "Deploy policy assignments?",
                  "toolTip": "Check here to create policy assignments for the resources created by Mission Landing Zone.",
                  "constraints": {
                    "required": false
                  }
                },
                {
                  "name": "policy",
                  "type": "Microsoft.Common.DropDown",
                  "label": "Policy Assignment",
                  "placeholder": "",
                  "defaultValue": "NIST SP 800-53",
                  "toolTip": "DoD IL5 is only available in AzureUsGovernment and will switch to NISTRev4 if tried in AzureCloud.",
                  "multiselect": false,
                  "selectAll": false,
                  "filter": true,
                  "filterPlaceholder": "Filter items ...",
                  "multiLine": true,
                  "defaultDescription": "Select one of the bundled built-in policy assignments.",
                  "constraints": {
                    "allowedValues": [
                      {
                        "label": "NIST SP 800-53 Rev4",
                        "description": "The US National Institute of Standards and Technology (NIST) publishes a catalog of security and privacy controls, Special Publication (SP) 800-53, for all federal information systems in the United States (except those related to national security).",
                        "value": "NISTRev4"
                      },
                      {
                        "label": "NIST SP 800-53 Rev5",
                        "description": "The US National Institute of Standards and Technology (NIST) publishes a catalog of security and privacy controls, Special Publication (SP) 800-53, for all federal information systems in the United States (except those related to national security).",
                        "value": "NISTRev5"
                      },
                      {
                        "label": "DoD IL5",
                        "description": "The Defense Information Systems Agency (DISA) is an agency of the US Department of Defense (DoD) that is responsible for developing and maintaining the DoD Cloud Computing Security Requirements Guide (SRG). These policies are only available for AzureUsGovernment and will switch to NISTRev4 if tried in AzureCloud.",
                        "value": "IL5"
                      },
                      {
                        "label": "CMMC",
                        "description": "The Cybersecurity Maturity Model Certification (CMMC) is a new framework developed by the US Department of Defense (DoD) that requires formal third-party audits of defense industrial base (DIB) contractor cybersecurity practices.",
                        "value": "CMMC"
                      }
                    ]
                  },
                  "visible": "[steps('compliance').policySection.deployPolicy]"
                }
              ]
            }
          ]
        },
        {
          "name": "tags",
          "label": "Tags",
          "elements": [
            {
              "name": "tags",
              "type": "Microsoft.Common.TagsByResource",
              "resources": [
                "Microsoft.Compute/availabilitySets",
                "Microsoft.Compute/diskAccesses",
                "Microsoft.Compute/diskEncryptionSets",
                "Microsoft.Compute/virtualMachines",
                "Microsoft.DesktopVirtualization/applicationGroups",
                "Microsoft.DesktopVirtualization/hostPools",
                "Microsoft.DesktopVirtualization/scalingPlans",
                "Microsoft.DesktopVirtualization/workspaces",
                "Microsoft.Insights/components",
                "Microsoft.Insights/dataCollectionEndpoints",
                "Microsoft.Insights/dataCollectionRules",
                "Microsoft.Insights/privateLinkScopes",
                "Microsoft.KeyVault/vaults",
                "Microsoft.ManagedIdentity/userAssignedIdentities",
                "Microsoft.NetApp/netAppAccounts",
                "Microsoft.Network/azureFirewalls",
                "Microsoft.Network/bastionHosts",
                "Microsoft.Network/firewallPolicies",
                "Microsoft.Network/networkInterfaces",
                "Microsoft.Network/networkSecurityGroups",
                "Microsoft.Network/privateDnsZones",
                "Microsoft.Network/privateEndpoints",
                "Microsoft.Network/publicIPAddresses",
                "Microsoft.Network/routeTables",
                "Microsoft.Network/virtualNetworks",
                "Microsoft.OperationalInsights/workspaces",
                "Microsoft.OperationsManagement/solutions",
                "Microsoft.Resources/resourceGroups",
                "Microsoft.Storage/storageAccounts",
                "Microsoft.Web/serverfarms",
                "Microsoft.Web/sites"
              ]
            }
          ]
        }
      ]
    },
    "outputs": {
      "parameters": {
        "addsDomainName": "[steps('identity').forestSection.domainName]",
        "addsVmSize": "[steps('identity').vmSection.vmSize]",
        "avdObjectId": "[steps('avd').startVmOnConnect.avdObjectId]",
        "deployPolicy": "[steps('compliance').policySection.deployPolicy]",
        "domainAdministratorPassword": "[steps('identity').domainAdministratorSection.password]",
        "domainAdministratorUsername": "[steps('identity').domainAdministratorSection.username]",
        "domainUserPassword": "[steps('identity').domainUserSection.password]",
        "domainUserUsername": "[steps('identity').domainUserSection.username]",
        "environmentAbbreviation": "[steps('basics').naming.environment]",
        "hybridUseBenefit": "[steps('identity').vmSection.hybridUseBenefit]",
        "identifier": "[steps('basics').naming.identifier]",
        "policy": "[steps('compliance').policySection.policy]",
        "securityPrincipals": "[steps('avd').assignment.groupPickerBlade.transformed.selection]",
        "tags": "[steps('tags').tags]",
        "virtualMachineSize": "[if(equals(steps('avd').workloadSection.workloadType, 'light'), steps('avd').workloadSection.sizeLight, if(equals(steps('avd').workloadSection.workloadType, 'medium'), steps('avd').workloadSection.sizeMedium, steps('avd').workloadSection.sizeHeavy))]"
      },
      "kind": "Subscription",
      "location": "[steps('basics').scope.location.name]",
      "subscriptionId": "[steps('basics').scope.subscription.id]"
    }
  }
}