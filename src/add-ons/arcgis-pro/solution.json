{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "7590631334218635911"
    }
  },
  "parameters": {
    "addsDomainName": {
      "type": "string",
      "metadata": {
        "description": "The root domain name for the new forest in Active Directory Domain Services. Required when deployActiveDirectoryDomainServices is true."
      }
    },
    "addsVmSize": {
      "type": "string",
      "defaultValue": "Standard_D2s_v3",
      "metadata": {
        "description": "The virtual machine size for the Active Directory Domain Services (ADDS) domain controllers."
      }
    },
    "avdObjectId": {
      "type": "string",
      "metadata": {
        "description": "The object ID for the Azure Virtual Desktop enterprise application in Microsoft Entra ID.  The object ID can found by selecting Microsoft Applications using the Application type filter in the Enterprise Applications blade of Microsoft Entra ID."
      }
    },
    "deploymentNameSuffix": {
      "type": "string",
      "defaultValue": "[utcNow()]",
      "metadata": {
        "description": "The suffix used for naming deployments uniquely. It defaults to a timestamp with the utcNow function."
      }
    },
    "deployPolicy": {
      "type": "bool",
      "metadata": {
        "description": "Choose whether to deploy a policy assignment."
      }
    },
    "domainAdministratorPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the domain administrator account."
      }
    },
    "domainAdministratorUsername": {
      "type": "string",
      "metadata": {
        "description": "The username for the domain administrator account."
      }
    },
    "domainUserPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the domain user account."
      }
    },
    "domainUserUsername": {
      "type": "string",
      "metadata": {
        "description": "The username for the domain user account."
      }
    },
    "environmentAbbreviation": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "prod",
        "test"
      ],
      "metadata": {
        "description": "[dev/prod/test] The abbreviation for the target environment."
      }
    },
    "hybridUseBenefit": {
      "type": "bool",
      "metadata": {
        "description": "Determines whether to use the hybrid use benefit for the Windows virtual machines."
      }
    },
    "identifier": {
      "type": "string",
      "minLength": 1,
      "maxLength": 3,
      "metadata": {
        "description": "1-3 alphanumeric characters without whitespace, used to name resources and generate uniqueness for resources within your subscription. Ideally, the value should represent an organization, department, or business unit."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[deployment().location]",
      "metadata": {
        "description": "The region to deploy resources into. It defaults to the deployment location."
      }
    },
    "policy": {
      "type": "string",
      "defaultValue": "NISTRev4",
      "allowedValues": [
        "NISTRev4",
        "NISTRev5",
        "IL5",
        "CMMC"
      ],
      "metadata": {
        "description": "[NISTRev4/NISTRev5/IL5/CMMC] Built-in policy assignments to assign, Default value = \"NISTRev4\". IL5 is only available for AzureUsGovernment and will switch to NISTRev4 if tried in AzureCloud."
      }
    },
    "securityPrincipals": {
      "type": "array",
      "metadata": {
        "description": "The array of Security Principals with their object IDs and display names to assign to the AVD Application Group and FSLogix Storage."
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "A string dictionary of tags to add to deployed resources. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-resource-manager/management/tag-resources?tabs=json#arm-templates."
      }
    },
    "virtualMachineSize": {
      "type": "string",
      "defaultValue": "Standard_NV4ads_V710_v5",
      "metadata": {
        "description": "The virtual machine size for the Azure Virtual Desktop session hosts."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-mission-landing-zone-{0}', parameters('deploymentNameSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "addsDomainName": {
            "value": "[parameters('addsDomainName')]"
          },
          "addsSafeModeAdminPassword": {
            "value": "[parameters('domainAdministratorPassword')]"
          },
          "addsAdministratorPassword": {
            "value": "[parameters('domainAdministratorPassword')]"
          },
          "addsAdministratorUsername": {
            "value": "[parameters('domainAdministratorUsername')]"
          },
          "addsVmImageSku": {
            "value": "2022-datacenter-g2"
          },
          "addsVmSize": {
            "value": "[parameters('addsVmSize')]"
          },
          "customFirewallRuleCollectionGroups": {
            "value": [
              {
                "name": "MLZ-DefaultCollectionGroup",
                "properties": {
                  "priority": 100,
                  "ruleCollections": [
                    {
                      "name": "NetworkRules",
                      "priority": 100,
                      "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                      "action": {
                        "type": "Allow"
                      },
                      "rules": [
                        {
                          "name": "Allow-Any-Any",
                          "ruleType": "NetworkRule",
                          "ipProtocols": [
                            "Any"
                          ],
                          "sourceAddresses": [
                            "*"
                          ],
                          "destinationAddresses": [
                            "*"
                          ],
                          "destinationPorts": [
                            "*"
                          ]
                        }
                      ]
                    },
                    {
                      "name": "ApplicationRules",
                      "priority": 200,
                      "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                      "action": {
                        "type": "Allow"
                      },
                      "rules": []
                    }
                  ]
                }
              }
            ]
          },
          "deployActiveDirectoryDomainServices": {
            "value": true
          },
          "deployBastion": {
            "value": true
          },
          "deployIdentity": {
            "value": true
          },
          "deployNetworkWatcherTrafficAnalytics": {
            "value": true
          },
          "environmentAbbreviation": {
            "value": "[parameters('environmentAbbreviation')]"
          },
          "firewallSkuTier": {
            "value": "Standard"
          },
          "hybridUseBenefit": {
            "value": "[parameters('hybridUseBenefit')]"
          },
          "identifier": {
            "value": "[parameters('identifier')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "policy": {
            "value": "[parameters('policy')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "846304372949038169"
            }
          },
          "parameters": {
            "addsDomainName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The root domain name for the new forest in Active Directory Domain Services. Required when deployActiveDirectoryDomainServices is true."
              }
            },
            "addsSafeModeAdminPassword": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "The password for the safe mode administrator account. Required when deployActiveDirectoryDomainServices is true."
              }
            },
            "addsAdministratorPassword": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "The password for the domain administrator account on the Active Directory Domain Services (ADDS) domain controllers. Required when deployActiveDirectoryDomainServices is true."
              }
            },
            "addsAdministratorUsername": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The username for the domain administrator account on the Active Directory Domain Services (ADDS) domain controllers. Required when deployActiveDirectoryDomainServices is true."
              }
            },
            "addsVmImageSku": {
              "type": "string",
              "defaultValue": "2019-datacenter-gensecond",
              "allowedValues": [
                "2019-datacenter-core-g2",
                "2019-datacenter-gensecond",
                "2022-datacenter-core-g2",
                "2022-datacenter-g2"
              ],
              "metadata": {
                "description": "The Windows image SKU in the Azure marketplace for the Active Directory Domain Services (ADDS) domain controllers."
              }
            },
            "addsVmSize": {
              "type": "string",
              "defaultValue": "Standard_D2s_v3",
              "metadata": {
                "description": "The virtual machine size for the Active Directory Domain Services (ADDS) domain controllers."
              }
            },
            "azureGatewaySubnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.129.192/26",
              "metadata": {
                "description": "The CIDR Subnet Address Prefix for the Azure Gateway Subnet. It must be in the Hub Virtual Network space. It must be /26."
              }
            },
            "bastionDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "BastionAuditLogs",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Bastion Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/bastion/monitor-bastion#collect-data-with-azure-monitor."
              }
            },
            "bastionDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AllMetrics",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Bastion Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/bastion/monitor-bastion#collect-data-with-azure-monitor."
              }
            },
            "bastionHostPublicIPAddressAvailabilityZones": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The Azure Bastion Public IP Address Availability Zones. Default value = \"No-Zone\" because Availability Zones are not available in every cloud. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-network/ip-services/public-ip-addresses#sku."
              }
            },
            "bastionHostSubnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.128.192/26",
              "metadata": {
                "description": "The CIDR Subnet Address Prefix for the Azure Bastion Subnet. It must be in the Hub Virtual Network space \"hubVirtualNetworkAddressPrefix\" parameter value. It must be /27 or larger."
              }
            },
            "blobDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "categoryGroup": "allLogs",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Blob Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/blobs/monitor-blob-storage?tabs=azure-portal#enable-diagnostic-logging."
              }
            },
            "blobDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "Transaction",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Blob Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/blobs/monitor-blob-storage?tabs=azure-portal#enable-metrics."
              }
            },
            "customFirewallRuleCollectionGroups": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The firewall rules that will be applied to the Azure Firewall."
              }
            },
            "additionalFwPipCount": {
              "type": "int",
              "defaultValue": 0,
              "minValue": 0,
              "maxValue": 10,
              "metadata": {
                "description": "Number of additional static public IP addresses to create for the Azure Firewall. Default value = \"0\". These will be static/reserved IP addresses that can be used for NAT rules."
              }
            },
            "defenderSkuTier": {
              "type": "string",
              "defaultValue": "Free",
              "allowedValues": [
                "Standard",
                "Free"
              ],
              "metadata": {
                "description": "[Standard/Free] The SKU for Defender for Cloud. Default value = \"Free\"."
              }
            },
            "deployActiveDirectoryDomainServices": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When set to \"true\", deploys Active Directory Domain Services (ADDS) domain controllers in the identity tier. Requires deployIdentity to be true. Default value = \"false\"."
              }
            },
            "deployAzureGatewaySubnet": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When set to \"true\", provisions Azure Gateway Subnet only. Default value = \"false\"."
              }
            },
            "deployBastion": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When set to \"true\", provisions Azure Bastion Host using the Standard SKU. Default value = \"false\"."
              }
            },
            "deployDefender": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "When set to \"true\", enables Microsoft Defender for Cloud for the subscriptions used in the deployment. Default value = \"false\"."
              }
            },
            "deployDefenderPlans": {
              "type": "array",
              "defaultValue": [
                "VirtualMachines"
              ],
              "metadata": {
                "description": "The Paid Workload Protection plans for Defender for Cloud. Default value = \"VirtualMachines\". See the following URL for valid settings: https://learn.microsoft.com/rest/api/defenderforcloud-composite/pricings/update?view=rest-defenderforcloud-composite-latest&tabs=HTTP."
              }
            },
            "deployIdentity": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Choose to deploy the identity resources. The identity resoures are not required if you plan to use cloud identities."
              }
            },
            "deployLinuxVirtualMachine": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When set to \"true\", provisions Linux Virtual Machine Host only. Default value = \"false\"."
              }
            },
            "deploymentNameSuffix": {
              "type": "string",
              "defaultValue": "[utcNow()]",
              "metadata": {
                "description": "A suffix to use for naming deployments uniquely. Default value = \"utcNow()\"."
              }
            },
            "deployNetworkWatcherTrafficAnalytics": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When set to true, deploys Network Watcher Traffic Analytics. Default value = \"false\"."
              }
            },
            "deployPolicy": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When set to \"true\", deploys the Azure Policy set defined at by the parameter \"policy\" to the resource groups generated in the deployment. Default value = \"false\"."
              }
            },
            "deploySentinel": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When set to \"true\", enables Microsoft Sentinel within the Log Analytics Workspace created in this deployment. Default value = \"false\"."
              }
            },
            "deployWindowsVirtualMachine": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When set to \"true\", provisions Windows Virtual Machine Host only. Default value = \"false\"."
              }
            },
            "dnsServers": {
              "type": "array",
              "defaultValue": [
                "168.63.129.16"
              ],
              "metadata": {
                "description": "The Azure Firewall DNS Proxy will forward all DNS traffic. When this value is set to true, you must provide a value for \"servers\". This should be a comma separated list of IP addresses to forward DNS traffic."
              }
            },
            "emailSecurityContact": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The email address for Defender for Cloud alert notifications, in the form of john@contoso.com."
              }
            },
            "enableProxy": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "The Azure Firewall DNS Proxy will forward all DNS traffic. Default value = \"true\"."
              }
            },
            "environmentAbbreviation": {
              "type": "string",
              "defaultValue": "dev",
              "allowedValues": [
                "dev",
                "prod",
                "test"
              ],
              "metadata": {
                "description": "[dev/prod/test] The abbreviation for the target environment."
              }
            },
            "fileDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "categoryGroup": "allLogs",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of File Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/files/monitor-file-storage?tabs=azure-portal#enable-diagnostic-logging."
              }
            },
            "fileDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "Transaction",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of File Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/files/monitor-file-storage?tabs=azure-portal#enable-metrics."
              }
            },
            "firewallClientPublicIPAddressAvailabilityZones": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "An array of Azure Firewall Public IP Address Availability Zones. Default value = \"[]\" because Availability Zones are not available in every cloud. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-network/ip-services/public-ip-addresses#sku."
              }
            },
            "firewallClientSubnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.128.0/26",
              "metadata": {
                "description": "The CIDR Subnet Address Prefix for the Azure Firewall Subnet. It must be in the Hub Virtual Network space. It must be /26."
              }
            },
            "firewallDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AzureFirewallApplicationRule",
                  "enabled": true
                },
                {
                  "category": "AzureFirewallNetworkRule",
                  "enabled": true
                },
                {
                  "category": "AzureFirewallDnsProxy",
                  "enabled": "[parameters('enableProxy')]"
                },
                {
                  "category": "AZFWNetworkRule",
                  "enabled": true
                },
                {
                  "category": "AZFWApplicationRule",
                  "enabled": true
                },
                {
                  "category": "AZFWNatRule",
                  "enabled": true
                },
                {
                  "category": "AZFWThreatIntel",
                  "enabled": true
                },
                {
                  "category": "AZFWIdpsSignature",
                  "enabled": true
                },
                {
                  "category": "AZFWDnsQuery",
                  "enabled": true
                },
                {
                  "category": "AZFWFqdnResolveFailure",
                  "enabled": true
                },
                {
                  "category": "AZFWFatFlow",
                  "enabled": true
                },
                {
                  "category": "AZFWFlowTrace",
                  "enabled": true
                },
                {
                  "category": "AZFWApplicationRuleAggregation",
                  "enabled": true
                },
                {
                  "category": "AZFWNetworkRuleAggregation",
                  "enabled": true
                },
                {
                  "category": "AZFWNatRuleAggregation",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Firewall Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/firewall/monitor-firewall#enable-diagnostic-logging-through-the-azure-portal."
              }
            },
            "firewallDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AllMetrics",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Firewall Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/firewall/monitor-firewall#enable-diagnostic-logging-through-the-azure-portal."
              }
            },
            "firewallIntrusionDetectionMode": {
              "type": "string",
              "defaultValue": "Alert",
              "allowedValues": [
                "Alert",
                "Deny",
                "Off"
              ],
              "metadata": {
                "description": "[Alert/Deny/Off] The Azure Firewall Intrusion Detection mode. Valid values are \"Alert\", \"Deny\", or \"Off\". The default value is \"Alert\"."
              }
            },
            "firewallManagementPublicIPAddressAvailabilityZones": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "An array of Azure Firewall Public IP Address Availability Zones. Default value = \"[]\" because Availability Zones are not available in every cloud. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-network/ip-services/public-ip-addresses#sku."
              }
            },
            "firewallManagementSubnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.128.64/26",
              "metadata": {
                "description": "The CIDR Subnet Address Prefix for the Azure Firewall Management Subnet. It must be in the Hub Virtual Network space. It must be /26."
              }
            },
            "firewallSkuTier": {
              "type": "string",
              "defaultValue": "Premium",
              "allowedValues": [
                "Premium",
                "Standard"
              ],
              "metadata": {
                "description": "[Premium/Standard] The SKU for Azure Firewall. Default value = \"Premium\". Selecting a value other than Premium is not recommended for environments that are required to be SCCA compliant."
              }
            },
            "firewallSupernetIPAddress": {
              "type": "string",
              "defaultValue": "10.0.128.0/18",
              "metadata": {
                "description": "Supernet CIDR address for the entire network of vnets, this address allows for communication between spokes. Recommended to use a Supernet calculator if modifying vnet addresses."
              }
            },
            "firewallThreatIntelMode": {
              "type": "string",
              "defaultValue": "Alert",
              "allowedValues": [
                "Alert",
                "Deny",
                "Off"
              ],
              "metadata": {
                "description": "[Alert/Deny/Off] The Azure Firewall Threat Intelligence Rule triggered logging behavior. Valid values are \"Alert\", \"Deny\", or \"Off\". The default value is \"Alert\"."
              }
            },
            "hubNetworkSecurityGroupDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "NetworkSecurityGroupEvent",
                  "enabled": true
                },
                {
                  "category": "NetworkSecurityGroupRuleCounter",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Network Security Group diagnostic logs to apply to the Hub Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-network/virtual-network-nsg-manage-log#log-categories."
              }
            },
            "hubNetworkSecurityGroupRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "An array of Network Security Group Rules to apply to the Hub Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/templates/microsoft.network/networksecuritygroups/securityrules?tabs=bicep&pivots=deployment-language-bicep#securityrulepropertiesformat."
              }
            },
            "hubSubnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.128.128/26",
              "metadata": {
                "description": "The CIDR Subnet Address Prefix for the default Hub subnet. It must be in the Hub Virtual Network space."
              }
            },
            "hubSubscriptionId": {
              "type": "string",
              "defaultValue": "[subscription().subscriptionId]",
              "metadata": {
                "description": "The subscription ID for the Hub Network and resources. Default value = \"subscription().subscriptionId\"."
              }
            },
            "hubVirtualNetworkAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.128.0/23",
              "metadata": {
                "description": "The CIDR Virtual Network Address Prefix for the Hub Virtual Network."
              }
            },
            "hubVirtualNetworkDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "VMProtectionAlerts",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Network Diagnostic Logs to enable for the Hub Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#logs."
              }
            },
            "hubVirtualNetworkDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AllMetrics",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Network Diagnostic Metrics to enable for the Hub Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#metrics."
              }
            },
            "hybridUseBenefit": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "The hybrid use benefit provides a discount on virtual machines when a customer has an on-premises Windows Server license with Software Assurance. Default value = \"false\"."
              }
            },
            "identifier": {
              "type": "string",
              "minLength": 1,
              "maxLength": 5,
              "metadata": {
                "description": "1-5 alphanumeric characters without whitespace, used to name resources and generate uniqueness for resources within your subscription. Ideally, the value should represent an organization, department, or business unit."
              }
            },
            "identityNetworkSecurityGroupDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "NetworkSecurityGroupEvent",
                  "enabled": true
                },
                {
                  "category": "NetworkSecurityGroupRuleCounter",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Network Security Group diagnostic logs to apply to the Identity Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-network/virtual-network-nsg-manage-log#log-categories."
              }
            },
            "identityNetworkSecurityGroupRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "An array of Network Security Group Rules to apply to the Identity Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/templates/microsoft.network/networksecuritygroups/securityrules?tabs=bicep#securityrulepropertiesformat."
              }
            },
            "identitySubnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.130.0/24",
              "metadata": {
                "description": "The CIDR Subnet Address Prefix for the default Identity subnet. It must be in the Identity Virtual Network space."
              }
            },
            "identitySubscriptionId": {
              "type": "string",
              "defaultValue": "[subscription().subscriptionId]",
              "metadata": {
                "description": "The subscription ID for the Identity Network and resources. Default value = \"subscription().subscriptionId\"."
              }
            },
            "identityVirtualNetworkAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.130.0/24",
              "metadata": {
                "description": "The CIDR Virtual Network Address Prefix for the Identity Virtual Network."
              }
            },
            "identityVirtualNetworkDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "VMProtectionAlerts",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Network Diagnostic Logs to enable for the Identity Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#logs."
              }
            },
            "identityVirtualNetworkDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AllMetrics",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Network Diagnostic Metrics to enable for the Identity Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#metrics."
              }
            },
            "keyVaultDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AuditEvent",
                  "enabled": true
                },
                {
                  "category": "AzurePolicyEvaluationDetails",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Key Vault Diagnostic Logs categories to collect. See the following URL for valid settings: \"https://learn.microsoft.com/azure/key-vault/general/logging?tabs=Vault\"."
              }
            },
            "keyVaultDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AllMetrics",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "The Key Vault Diagnostic Metrics to collect. See the following URL for valid settings: \"https://learn.microsoft.com/azure/key-vault/general/logging?tabs=Vault\"."
              }
            },
            "linuxVmAdminPasswordOrKey": {
              "type": "securestring",
              "defaultValue": "[if(parameters('deployLinuxVirtualMachine'), '', newGuid())]",
              "minLength": 12,
              "metadata": {
                "description": "The administrator password or public SSH key for the Linux Virtual Machine for remote access. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-machines/linux/faq#what-are-the-password-requirements-when-creating-a-vm-."
              }
            },
            "linuxVmAdminUsername": {
              "type": "string",
              "defaultValue": "xadmin",
              "metadata": {
                "description": "The administrator username for the Linux Virtual Machine for remote access. Default value = \"xadmin\"."
              }
            },
            "linuxVmAuthenticationType": {
              "type": "string",
              "defaultValue": "password",
              "allowedValues": [
                "sshPublicKey",
                "password"
              ],
              "metadata": {
                "description": "[sshPublicKey/password] The authentication type for the Linux Virtual Machine for remote access. Default value = \"password\"."
              }
            },
            "linuxVmImageOffer": {
              "type": "string",
              "defaultValue": "0001-com-ubuntu-server-focal",
              "allowedValues": [
                "ubuntuserver",
                "0001-com-ubuntu-server-focal",
                "0001-com-ubuntu-server-jammy",
                "RHEL",
                "Debian-12"
              ],
              "metadata": {
                "description": "[ubuntuserver/0001-com-ubuntu-server-focal/0001-com-ubuntu-server-jammy/RHEL/Debian-12] The Linux image offer in the Azure marketplace. Default value = \"0001-com-ubuntu-server-focal\"."
              }
            },
            "linuxVmImagePublisher": {
              "type": "string",
              "defaultValue": "Canonical",
              "allowedValues": [
                "Canonical",
                "RedHat",
                "Debian"
              ],
              "metadata": {
                "description": "[Canonical/RedHat/Debian] The Linux image publisher in the Azure marketplace. Default value = \"Canonical\"."
              }
            },
            "linuxVmImageSku": {
              "type": "string",
              "defaultValue": "20_04-lts-gen2",
              "metadata": {
                "description": "The Linux image SKU in the Azure marketplace. Default value = \"20_04-lts-gen2\"."
              }
            },
            "linuxVmImageVersion": {
              "type": "string",
              "defaultValue": "latest",
              "metadata": {
                "description": "The Linux image version in the Azure marketplace. Default value = \"latest\"."
              }
            },
            "linuxVmOsDiskType": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "metadata": {
                "description": "The disk type of the Linux Virtual Machine for remote access. Default value = \"Standard_LRS\"."
              }
            },
            "linuxVmSize": {
              "type": "string",
              "defaultValue": "Standard_D2s_v3",
              "metadata": {
                "description": "The size of the Linux virtual machine. Default value = \"Standard_D2s_v3\"."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[deployment().location]",
              "metadata": {
                "description": "The region to deploy resources into. Default value = \"deployment().location\"."
              }
            },
            "logAnalyticsWorkspaceCappingDailyQuotaGb": {
              "type": "int",
              "defaultValue": -1,
              "metadata": {
                "description": "The daily quota for Log Analytics Workspace logs in Gigabytes. Default value = \"-1\", meaning no quota."
              }
            },
            "logAnalyticsWorkspaceRetentionInDays": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "The number of days to retain Log Analytics Workspace logs without Sentinel. Default value = \"30\"."
              }
            },
            "logAnalyticsWorkspaceSkuName": {
              "type": "string",
              "defaultValue": "PerGB2018",
              "allowedValues": [
                "Free",
                "Standard",
                "Premium",
                "PerNode",
                "PerGB2018",
                "Standalone"
              ],
              "metadata": {
                "description": "[Free/Standard/Premium/PerNode/PerGB2018/Standalone] The SKU for the Log Analytics Workspace. Default value = \"PerGB2018\". See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/logs/resource-manager-workspace."
              }
            },
            "logStorageSkuName": {
              "type": "string",
              "defaultValue": "Standard_GRS",
              "metadata": {
                "description": "The Storage Account SKU to use for log storage. Default value = \"Standard_GRS\". See the following URL for valid settings: https://learn.microsoft.com/rest/api/storagerp/srp_sku_types."
              }
            },
            "networkInterfaceDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AllMetrics",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of metrics to enable on the diagnostic setting for network interfaces."
              }
            },
            "networkWatcherFlowLogsRetentionDays": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "The number of days to retain Network Watcher Flow Logs. Default value = \"30\"."
              }
            },
            "networkWatcherFlowLogsType": {
              "type": "string",
              "defaultValue": "VirtualNetwork",
              "allowedValues": [
                "NetworkSecurityGroup",
                "VirtualNetwork"
              ],
              "metadata": {
                "description": "[NetworkSecurityGroup/VirtualNetwork] The type of network watcher flow logs to enable. Default value = \"VirtualNetwork\" since they provide more data and NSG flow logs will be deprecated in June 2025."
              }
            },
            "operationsNetworkSecurityGroupDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "NetworkSecurityGroupEvent",
                  "enabled": true
                },
                {
                  "category": "NetworkSecurityGroupRuleCounter",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Network Security Group diagnostic logs to apply to the Operations Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-network/virtual-network-nsg-manage-log#log-categories."
              }
            },
            "operationsNetworkSecurityGroupRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "An array of Network Security Group rules to apply to the Operations Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/templates/microsoft.network/networksecuritygroups/securityrules?tabs=bicep#securityrulepropertiesformat."
              }
            },
            "operationsSubnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.131.0/24",
              "metadata": {
                "description": "The CIDR Subnet Address Prefix for the default Operations subnet. It must be in the Operations Virtual Network space."
              }
            },
            "operationsSubscriptionId": {
              "type": "string",
              "defaultValue": "[subscription().subscriptionId]",
              "metadata": {
                "description": "The subscription ID for the Operations Network and resources. Default value = \"subscription().subscriptionId\"."
              }
            },
            "operationsVirtualNetworkAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.131.0/24",
              "metadata": {
                "description": "The CIDR Virtual Network Address Prefix for the Operations Virtual Network."
              }
            },
            "operationsVirtualNetworkDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "VMProtectionAlerts",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Network Diagnostic Logs to enable for the Operations Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#logs."
              }
            },
            "operationsVirtualNetworkDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AllMetrics",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Network Diagnostic Metrics to enable for the Operations Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#metrics."
              }
            },
            "policy": {
              "type": "string",
              "defaultValue": "NISTRev4",
              "allowedValues": [
                "NISTRev4",
                "NISTRev5",
                "IL5",
                "CMMC"
              ],
              "metadata": {
                "description": "[NISTRev4/NISTRev5/IL5/CMMC] Built-in policy assignments to assign, Default value = \"NISTRev4\". IL5 is only available for AzureUsGovernment and will switch to NISTRev4 if tried in AzureCloud."
              }
            },
            "publicIPAddressDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "DDoSProtectionNotifications",
                  "enabled": true
                },
                {
                  "category": "DDoSMitigationFlowLogs",
                  "enabled": true
                },
                {
                  "category": "DDoSMitigationReports",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Public IP Address Diagnostic Logs for the Azure Firewall. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/tutorial-resource-logs?tabs=DDoSProtectionNotifications#configure-ddos-diagnostic-logs."
              }
            },
            "publicIPAddressDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AllMetrics",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Public IP Address Diagnostic Metrics for the Azure Firewall. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/tutorial-resource-logs?tabs=DDoSProtectionNotifications."
              }
            },
            "queueDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "categoryGroup": "allLogs",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Queue Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/queues/monitor-queue-storage?tabs=azure-portal#enable-diagnostic-logging."
              }
            },
            "queueDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "Transaction",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Queue Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/queues/monitor-queue-storage?tabs=azure-portal#enable-metrics."
              }
            },
            "sharedServicesNetworkSecurityGroupDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "NetworkSecurityGroupEvent",
                  "enabled": true
                },
                {
                  "category": "NetworkSecurityGroupRuleCounter",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Network Security Group diagnostic logs to apply to the SharedServices Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-network/virtual-network-nsg-manage-log#log-categories."
              }
            },
            "sharedServicesNetworkSecurityGroupRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "An array of Network Security Group rules to apply to the SharedServices Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/templates/microsoft.network/networksecuritygroups/securityrules?tabs=bicep#securityrulepropertiesformat."
              }
            },
            "sharedServicesSubnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.132.0/24",
              "metadata": {
                "description": "The CIDR Subnet Address Prefix for the default Shared Services subnet. It must be in the Shared Services Virtual Network space. Default value = \"10.0.132.0/24\"."
              }
            },
            "sharedServicesSubscriptionId": {
              "type": "string",
              "defaultValue": "[subscription().subscriptionId]",
              "metadata": {
                "description": "The subscription ID for the Shared Services Network and resources. Default value = \"subscription().subscriptionId\"."
              }
            },
            "sharedServicesVirtualNetworkAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.132.0/24",
              "metadata": {
                "description": "The CIDR Virtual Network Address Prefix for the Shared Services Virtual Network. Default value = \"10.0.132.0/24\"."
              }
            },
            "sharedServicesVirtualNetworkDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "VMProtectionAlerts",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Network Diagnostic Logs to enable for the SharedServices Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#logs."
              }
            },
            "sharedServicesVirtualNetworkDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AllMetrics",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Network Diagnostic Metrics to enable for the SharedServices Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#metrics."
              }
            },
            "storageAccountDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "An array of Storage Account Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/common/monitor-storage?tabs=azure-portal#enable-diagnostic-logging."
              }
            },
            "storageAccountDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "Transaction",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Storage Account Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/common/monitor-storage?tabs=azure-portal#enable-metrics."
              }
            },
            "supportedClouds": {
              "type": "array",
              "defaultValue": [
                "AzureCloud",
                "AzureUSGovernment"
              ],
              "metadata": {
                "description": "The Azure clouds that support specific service features. Default value = \"['AzureCloud','AzureUSGovernment']\"."
              }
            },
            "tableDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "categoryGroup": "allLogs",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Table Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/tables/monitor-table-storage?tabs=azure-portal#enable-diagnostic-logging."
              }
            },
            "tableDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "Transaction",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Table Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/tables/monitor-table-storage?tabs=azure-portal#enable-metrics."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "A string dictionary of tags to add to deployed resources. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-resource-manager/management/tag-resources?tabs=json#arm-templates."
              }
            },
            "windowsVmAdminPassword": {
              "type": "securestring",
              "defaultValue": "[if(parameters('deployWindowsVirtualMachine'), '', newGuid())]",
              "minLength": 12,
              "metadata": {
                "description": "The administrator password the Windows Virtual Machine for remote access. It must be > 12 characters in length. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-machines/windows/faq#what-are-the-password-requirements-when-creating-a-vm-."
              }
            },
            "windowsVmAdminUsername": {
              "type": "string",
              "defaultValue": "xadmin",
              "metadata": {
                "description": "The administrator username for the Windows Virtual Machine for remote access. Default value = \"xadmin\"."
              }
            },
            "windowsVmImageOffer": {
              "type": "string",
              "defaultValue": "WindowsServer",
              "metadata": {
                "description": "The Windows image offer in the Azure marketplace. Default value = \"WindowsServer\"."
              }
            },
            "windowsVmImagePublisher": {
              "type": "string",
              "defaultValue": "MicrosoftWindowsServer",
              "metadata": {
                "description": "The Windows image publisher in the Azure marketplace. Default value = \"MicrosoftWindowsServer\"."
              }
            },
            "windowsVmImageSku": {
              "type": "string",
              "defaultValue": "2019-datacenter-gensecond",
              "allowedValues": [
                "2019-datacenter-gensecond",
                "2022-datacenter-g2"
              ],
              "metadata": {
                "description": "[2019-datacenter-gensecond/2022-datacenter-g2] The Windows image SKU in the Azure marketplace. Default value = \"2019-datacenter-gensecond\"."
              }
            },
            "windowsVmImageVersion": {
              "type": "string",
              "defaultValue": "latest",
              "metadata": {
                "description": "The Windows image version in the Azure marketplace. Default value = \"latest\"."
              }
            },
            "windowsVmSize": {
              "type": "string",
              "defaultValue": "Standard_DS1_v2",
              "metadata": {
                "description": "The size of the Windows Virtual Machine for remote access. Default value = \"Standard_DS1_v2\"."
              }
            },
            "windowsVmStorageAccountType": {
              "type": "string",
              "defaultValue": "StandardSSD_LRS",
              "metadata": {
                "description": "The storage account type of the Windows Virtual Machine for remote access. Default value = \"StandardSSD_LRS\"."
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "firewallClientUsableIpAddresses",
                "count": "[length(range(0, 4))]",
                "input": "[cidrHost(parameters('firewallClientSubnetAddressPrefix'), range(0, 4)[copyIndex('firewallClientUsableIpAddresses')])]"
              }
            ],
            "firewallClientPrivateIpAddress": "[variables('firewallClientUsableIpAddresses')[3]]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-networking-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('hubSubscriptionId')]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "bastionHostSubnetAddressPrefix": {
                    "value": "[parameters('bastionHostSubnetAddressPrefix')]"
                  },
                  "azureGatewaySubnetAddressPrefix": {
                    "value": "[parameters('azureGatewaySubnetAddressPrefix')]"
                  },
                  "deployIdentity": {
                    "value": "[parameters('deployIdentity')]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "deployBastion": {
                    "value": "[parameters('deployBastion')]"
                  },
                  "deployAzureGatewaySubnet": {
                    "value": "[parameters('deployAzureGatewaySubnet')]"
                  },
                  "dnsServers": {
                    "value": "[parameters('dnsServers')]"
                  },
                  "enableProxy": {
                    "value": "[parameters('enableProxy')]"
                  },
                  "environmentAbbreviation": {
                    "value": "[parameters('environmentAbbreviation')]"
                  },
                  "firewallSettings": {
                    "value": {
                      "clientPrivateIpAddress": "[variables('firewallClientPrivateIpAddress')]",
                      "clientPublicIPAddressAvailabilityZones": "[parameters('firewallClientPublicIPAddressAvailabilityZones')]",
                      "clientSubnetAddressPrefix": "[parameters('firewallClientSubnetAddressPrefix')]",
                      "customPipCount": "[parameters('additionalFwPipCount')]",
                      "intrusionDetectionMode": "[parameters('firewallIntrusionDetectionMode')]",
                      "managementPublicIPAddressAvailabilityZones": "[parameters('firewallManagementPublicIPAddressAvailabilityZones')]",
                      "managementSubnetAddressPrefix": "[parameters('firewallManagementSubnetAddressPrefix')]",
                      "skuTier": "[parameters('firewallSkuTier')]",
                      "supernetIPAddress": "[parameters('firewallSupernetIPAddress')]",
                      "threatIntelMode": "[parameters('firewallThreatIntelMode')]"
                    }
                  },
                  "firewallRuleCollectionGroups": "[if(empty(parameters('customFirewallRuleCollectionGroups')), createObject('value', createArray(createObject('name', 'MLZ-DefaultCollectionGroup', 'properties', createObject('priority', 100, 'ruleCollections', createArray(createObject('name', 'NetworkRules', 'priority', 100, 'ruleCollectionType', 'FirewallPolicyFilterRuleCollection', 'action', createObject('type', 'Allow'), 'rules', union(createArray(createObject('name', 'Allow-LAW-TCP', 'ruleType', 'NetworkRule', 'ipProtocols', createArray('Tcp'), 'sourceAddresses', createArray(parameters('firewallSupernetIPAddress')), 'destinationAddresses', createArray(cidrHost(parameters('operationsVirtualNetworkAddressPrefix'), 3)), 'destinationPorts', createArray('443')), createObject('name', 'Allow-AAD-TCP', 'ruleType', 'NetworkRule', 'ipProtocols', createArray('Tcp'), 'sourceAddresses', createArray(parameters('firewallSupernetIPAddress')), 'destinationAddresses', createArray('AzureActiveDirectory'), 'destinationPorts', createArray('443')), createObject('name', 'Allow-KV-TCP', 'ruleType', 'NetworkRule', 'ipProtocols', createArray('Tcp'), 'sourceAddresses', createArray(parameters('firewallSupernetIPAddress')), 'destinationAddresses', createArray('AzureKeyVault'), 'destinationPorts', createArray('443')), createObject('name', 'Allow-KV-TCP', 'ruleType', 'NetworkRule', 'ipProtocols', createArray('Tcp'), 'sourceAddresses', createArray(parameters('firewallSupernetIPAddress')), 'destinationAddresses', createArray('AzureKeyVault'), 'destinationPorts', createArray('443')), createObject('name', 'Allow-ARM-TCP', 'ruleType', 'NetworkRule', 'ipProtocols', createArray('Tcp'), 'sourceAddresses', createArray(parameters('firewallSupernetIPAddress')), 'destinationAddresses', createArray('AzureResourceManager'), 'destinationPorts', createArray('443'))), if(parameters('deployActiveDirectoryDomainServices'), createArray(createObject('name', 'Allow-ADDS-TCP', 'ruleType', 'NetworkRule', 'ipProtocols', createArray('TCP'), 'sourceAddresses', createArray(parameters('firewallSupernetIPAddress')), 'destinationAddresses', createArray(cidrHost(parameters('identityVirtualNetworkAddressPrefix'), 5), cidrHost(parameters('identityVirtualNetworkAddressPrefix'), 6)), 'destinationPorts', createArray('53', '88', '135', '389', '445', '464', '636', '3268', '3269')), createObject('name', 'Allow-ADDS-UDP', 'ruleType', 'NetworkRule', 'ipProtocols', createArray('UDP'), 'sourceAddresses', createArray(parameters('firewallSupernetIPAddress')), 'destinationAddresses', createArray(cidrHost(parameters('identitySubnetAddressPrefix'), 5), cidrHost(parameters('identitySubnetAddressPrefix'), 6)), 'destinationPorts', createArray('53', '88', '123', '389', '464'))), createArray()), if(or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), createArray(createObject('name', 'Allow-KMS-TCP', 'ruleType', 'NetworkRule', 'ipProtocols', createArray('Tcp'), 'sourceAddresses', union(if(and(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), createArray(cidrHost(parameters('hubSubnetAddressPrefix'), 4), cidrHost(parameters('hubSubnetAddressPrefix'), 5)), createArray(cidrHost(parameters('hubSubnetAddressPrefix'), 4))), if(parameters('deployActiveDirectoryDomainServices'), createArray(cidrHost(parameters('identitySubnetAddressPrefix'), 5), cidrHost(parameters('identitySubnetAddressPrefix'), 6)), createArray())), 'destinationAddresses', createArray(), 'destinationFqdns', createArray(format('azkms.{0}', environment().suffixes.storage), format('kms.{0}', environment().suffixes.storage)), 'destinationPorts', createArray('1688'), 'sourceIpGroups', createArray(), 'destinationIpGroups', createArray())), createArray()))), createObject('name', 'ApplicationRules', 'priority', 200, 'ruleCollectionType', 'FirewallPolicyFilterRuleCollection', 'action', createObject('type', 'Allow'), 'rules', if(or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), createArray(createObject('name', 'Allow-WindowsUpdate', 'ruleType', 'ApplicationRule', 'protocols', createArray(createObject('protocolType', 'Https', 'port', 443)), 'fqdnTags', createArray('WindowsUpdate'), 'webCategories', createArray(), 'targetFqdns', createArray(), 'targetUrls', createArray(), 'terminateTLS', false(), 'sourceAddresses', union(if(and(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), createArray(cidrHost(parameters('hubSubnetAddressPrefix'), 4), cidrHost(parameters('hubSubnetAddressPrefix'), 5)), createArray(cidrHost(parameters('hubSubnetAddressPrefix'), 4))), if(parameters('deployActiveDirectoryDomainServices'), createArray(cidrHost(parameters('identitySubnetAddressPrefix'), 5), cidrHost(parameters('identitySubnetAddressPrefix'), 6)), createArray())), 'destinationAddresses', createArray(), 'sourceIpGroups', createArray())), createArray()))))))), createObject('value', parameters('customFirewallRuleCollectionGroups')))]",
                  "identifier": {
                    "value": "[parameters('identifier')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "networks": {
                    "value": "[union(createArray(createObject('name', 'hub', 'shortName', 'hub', 'subscriptionId', parameters('hubSubscriptionId'), 'nsgDiagLogs', parameters('hubNetworkSecurityGroupDiagnosticsLogs'), 'nsgRules', parameters('hubNetworkSecurityGroupRules'), 'vnetAddressPrefix', parameters('hubVirtualNetworkAddressPrefix'), 'vnetDiagLogs', parameters('hubVirtualNetworkDiagnosticsLogs'), 'vnetDiagMetrics', parameters('hubVirtualNetworkDiagnosticsMetrics'), 'subnetAddressPrefix', parameters('hubSubnetAddressPrefix')), createObject('name', 'operations', 'shortName', 'ops', 'subscriptionId', parameters('operationsSubscriptionId'), 'nsgDiagLogs', parameters('operationsNetworkSecurityGroupDiagnosticsLogs'), 'nsgRules', parameters('operationsNetworkSecurityGroupRules'), 'vnetAddressPrefix', parameters('operationsVirtualNetworkAddressPrefix'), 'vnetDiagLogs', parameters('operationsVirtualNetworkDiagnosticsLogs'), 'vnetDiagMetrics', parameters('operationsVirtualNetworkDiagnosticsMetrics'), 'subnetAddressPrefix', parameters('operationsSubnetAddressPrefix')), createObject('name', 'sharedServices', 'shortName', 'svcs', 'subscriptionId', parameters('sharedServicesSubscriptionId'), 'nsgDiagLogs', parameters('sharedServicesNetworkSecurityGroupDiagnosticsLogs'), 'nsgRules', parameters('sharedServicesNetworkSecurityGroupRules'), 'vnetAddressPrefix', parameters('sharedServicesVirtualNetworkAddressPrefix'), 'vnetDiagLogs', parameters('sharedServicesVirtualNetworkDiagnosticsLogs'), 'vnetDiagMetrics', parameters('sharedServicesVirtualNetworkDiagnosticsMetrics'), 'subnetAddressPrefix', parameters('sharedServicesSubnetAddressPrefix'))), if(parameters('deployIdentity'), createArray(createObject('name', 'identity', 'shortName', 'id', 'subscriptionId', parameters('identitySubscriptionId'), 'nsgDiagLogs', parameters('identityNetworkSecurityGroupDiagnosticsLogs'), 'nsgRules', parameters('identityNetworkSecurityGroupRules'), 'vnetAddressPrefix', parameters('identityVirtualNetworkAddressPrefix'), 'vnetDiagLogs', parameters('identityVirtualNetworkDiagnosticsLogs'), 'vnetDiagMetrics', parameters('identityVirtualNetworkDiagnosticsMetrics'), 'subnetAddressPrefix', parameters('identitySubnetAddressPrefix'))), createArray()))]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "13917300836651152808"
                    }
                  },
                  "parameters": {
                    "azureGatewaySubnetAddressPrefix": {
                      "type": "string"
                    },
                    "bastionHostSubnetAddressPrefix": {
                      "type": "string"
                    },
                    "deployAzureGatewaySubnet": {
                      "type": "bool"
                    },
                    "deployBastion": {
                      "type": "bool"
                    },
                    "deployIdentity": {
                      "type": "bool"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "dnsServers": {
                      "type": "array"
                    },
                    "enableProxy": {
                      "type": "bool"
                    },
                    "environmentAbbreviation": {
                      "type": "string"
                    },
                    "firewallRuleCollectionGroups": {
                      "type": "array"
                    },
                    "firewallSettings": {
                      "type": "object"
                    },
                    "identifier": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "networks": {
                      "type": "array"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "variables": {
                    "hubSubscriptionId": "[filter(parameters('networks'), lambda('network', equals(lambdaVariables('network').name, 'hub')))[0].subscriptionId]",
                    "spokes": "[filter(parameters('networks'), lambda('network', not(equals(lambdaVariables('network').name, 'hub'))))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('get-logic-{0}', parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "delimiter": {
                            "value": "-"
                          },
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "environmentAbbreviation": {
                            "value": "[parameters('environmentAbbreviation')]"
                          },
                          "identifier": {
                            "value": "[parameters('identifier')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "networks": {
                            "value": "[parameters('networks')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "14956586253638960991"
                            }
                          },
                          "parameters": {
                            "delimiter": {
                              "type": "string"
                            },
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "environmentAbbreviation": {
                              "type": "string"
                            },
                            "identifier": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "networks": {
                              "type": "array"
                            },
                            "stampIndex": {
                              "type": "string",
                              "defaultValue": ""
                            }
                          },
                          "variables": {
                            "$fxv#0": {
                              "AzureChina": {
                                "chinaeast": {
                                  "abbreviation": "cne",
                                  "recoveryServicesGeo": "sha",
                                  "timeDifference": "+8:00",
                                  "timeZone": "China Standard Time"
                                },
                                "chinaeast2": {
                                  "abbreviation": "cne2",
                                  "recoveryServicesGeo": "sha2",
                                  "timeDifference": "+8:00",
                                  "timeZone": "China Standard Time"
                                },
                                "chinanorth": {
                                  "abbreviation": "cnn",
                                  "recoveryServicesGeo": "bjb",
                                  "timeDifference": "+8:00",
                                  "timeZone": "China Standard Time"
                                },
                                "chinanorth2": {
                                  "abbreviation": "cnn2",
                                  "recoveryServicesGeo": "bjb2",
                                  "timeDifference": "+8:00",
                                  "timeZone": "China Standard Time"
                                }
                              },
                              "AzureCloud": {
                                "australiacentral": {
                                  "abbreviation": "auc",
                                  "recoveryServicesGeo": "acl",
                                  "timeDifference": "+10:00",
                                  "timeZone": "AUS Eastern Standard Time"
                                },
                                "australiacentral2": {
                                  "abbreviation": "auc2",
                                  "recoveryServicesGeo": "acl2",
                                  "timeDifference": "+10:00",
                                  "timeZone": "AUS Eastern Standard Time"
                                },
                                "australiaeast": {
                                  "abbreviation": "aue",
                                  "recoveryServicesGeo": "ae",
                                  "timeDifference": "+10:00",
                                  "timeZone": "AUS Eastern Standard Time"
                                },
                                "australiasoutheast": {
                                  "abbreviation": "ause",
                                  "recoveryServicesGeo": "ase",
                                  "timeDifference": "+10:00",
                                  "timeZone": "AUS Eastern Standard Time"
                                },
                                "brazilsouth": {
                                  "abbreviation": "brs",
                                  "recoveryServicesGeo": "brs",
                                  "timeDifference": "-3:00",
                                  "timeZone": "E. South America Standard Time"
                                },
                                "brazilsoutheast": {
                                  "abbreviation": "brse",
                                  "recoveryServicesGeo": "bse",
                                  "timeDifference": "-3:00",
                                  "timeZone": "E. South America Standard Time"
                                },
                                "canadacentral": {
                                  "abbreviation": "cac",
                                  "recoveryServicesGeo": "cnc",
                                  "timeDifference": "-5:00",
                                  "timeZone": "Eastern Standard Time"
                                },
                                "canadaeast": {
                                  "abbreviation": "cae",
                                  "recoveryServicesGeo": "cne",
                                  "timeDifference": "-5:00",
                                  "timeZone": "Eastern Standard Time"
                                },
                                "centralindia": {
                                  "abbreviation": "inc",
                                  "recoveryServicesGeo": "inc",
                                  "timeDifference": "+5:30",
                                  "timeZone": "India Standard Time"
                                },
                                "centralus": {
                                  "abbreviation": "usc",
                                  "recoveryServicesGeo": "cus",
                                  "timeDifference": "-6:00",
                                  "timeZone": "Central Standard Time"
                                },
                                "eastasia": {
                                  "abbreviation": "ase",
                                  "recoveryServicesGeo": "ea",
                                  "timeDifference": "+8:00",
                                  "timeZone": "China Standard Time"
                                },
                                "eastus": {
                                  "abbreviation": "use",
                                  "recoveryServicesGeo": "eus",
                                  "timeDifference": "-5:00",
                                  "timeZone": "Eastern Standard Time"
                                },
                                "eastus2": {
                                  "abbreviation": "use2",
                                  "recoveryServicesGeo": "eus2",
                                  "timeDifference": "-5:00",
                                  "timeZone": "Eastern Standard Time"
                                },
                                "francecentral": {
                                  "abbreviation": "frc",
                                  "recoveryServicesGeo": "frc",
                                  "timeDifference": "+1:00",
                                  "timeZone": "Central Europe Standard Time"
                                },
                                "francesouth": {
                                  "abbreviation": "frs",
                                  "recoveryServicesGeo": "frs",
                                  "timeDifference": "+1:00",
                                  "timeZone": "Central Europe Standard Time"
                                },
                                "germanynorth": {
                                  "abbreviation": "den",
                                  "recoveryServicesGeo": "gn",
                                  "timeDifference": "+1:00",
                                  "timeZone": "Central Europe Standard Time"
                                },
                                "germanywestcentral": {
                                  "abbreviation": "dewc",
                                  "recoveryServicesGeo": "gwc",
                                  "timeDifference": "+1:00",
                                  "timeZone": "Central Europe Standard Time"
                                },
                                "israelcentral": {
                                  "abbreviation": "ilc",
                                  "recoveryServicesGeo": "ilc",
                                  "timeDifference": "+2:00",
                                  "timeZone": "Israel Standard Time"
                                },
                                "italynorth": {
                                  "abbreviation": "itn",
                                  "recoveryServicesGeo": "itn",
                                  "timeDifference": "+1:00",
                                  "timeZone": "Central Europe Standard Time"
                                },
                                "japaneast": {
                                  "abbreviation": "jpe",
                                  "recoveryServicesGeo": "jpe",
                                  "timeDifference": "+9:00",
                                  "timeZone": "Tokyo Standard Time"
                                },
                                "japanwest": {
                                  "abbreviation": "jpw",
                                  "recoveryServicesGeo": "jpw",
                                  "timeDifference": "+9:00",
                                  "timeZone": "Tokyo Standard Time"
                                },
                                "jioindiacentral": {
                                  "abbreviation": "injc",
                                  "recoveryServicesGeo": "jic",
                                  "timeDifference": "+5:30",
                                  "timeZone": "India Standard Time"
                                },
                                "jioindiawest": {
                                  "abbreviation": "injw",
                                  "recoveryServicesGeo": "jiw",
                                  "timeDifference": "+5:30",
                                  "timeZone": "India Standard Time"
                                },
                                "koreacentral": {
                                  "abbreviation": "krc",
                                  "recoveryServicesGeo": "krc",
                                  "timeDifference": "+9:00",
                                  "timeZone": "Korea Standard Time"
                                },
                                "koreasouth": {
                                  "abbreviation": "krs",
                                  "recoveryServicesGeo": "krs",
                                  "timeDifference": "+9:00",
                                  "timeZone": "Korea Standard Time"
                                },
                                "northcentralus": {
                                  "abbreviation": "usnc",
                                  "recoveryServicesGeo": "ncus",
                                  "timeDifference": "-6:00",
                                  "timeZone": "Central Standard Time"
                                },
                                "northeurope": {
                                  "abbreviation": "eun",
                                  "recoveryServicesGeo": "ne",
                                  "timeDifference": "0:00",
                                  "timeZone": "GMT Standard Time"
                                },
                                "norwayeast": {
                                  "abbreviation": "noe",
                                  "recoveryServicesGeo": "nwe",
                                  "timeDifference": "+1:00",
                                  "timeZone": "Central Europe Standard Time"
                                },
                                "norwaywest": {
                                  "abbreviation": "now",
                                  "recoveryServicesGeo": "nww",
                                  "timeDifference": "+1:00",
                                  "timeZone": "Central Europe Standard Time"
                                },
                                "polandcentral": {
                                  "abbreviation": "plc",
                                  "recoveryServicesGeo": "plc",
                                  "timeDifference": "+1:00",
                                  "timeZone": "Central Europe Standard Time"
                                },
                                "qatarcentral": {
                                  "abbreviation": "qac",
                                  "recoveryServicesGeo": "qac",
                                  "timeDifference": "+3:00",
                                  "timeZone": "Arabian Standard Time"
                                },
                                "southafricanorth": {
                                  "abbreviation": "zan",
                                  "recoveryServicesGeo": "san",
                                  "timeDifference": "+2:00",
                                  "timeZone": "South Africa Standard Time"
                                },
                                "southafricawest": {
                                  "abbreviation": "zaw",
                                  "recoveryServicesGeo": "saw",
                                  "timeDifference": "+2:00",
                                  "timeZone": "South Africa Standard Time"
                                },
                                "southcentralus": {
                                  "abbreviation": "ussc",
                                  "recoveryServicesGeo": "scus",
                                  "timeDifference": "-6:00",
                                  "timeZone": "Central Standard Time"
                                },
                                "southeastasia": {
                                  "abbreviation": "asse",
                                  "recoveryServicesGeo": "sea",
                                  "timeDifference": "+8:00",
                                  "timeZone": "Singapore Standard Time"
                                },
                                "southindia": {
                                  "abbreviation": "ins",
                                  "recoveryServicesGeo": "ins",
                                  "timeDifference": "+5:30",
                                  "timeZone": "India Standard Time"
                                },
                                "swedencentral": {
                                  "abbreviation": "sec",
                                  "recoveryServicesGeo": "sdc",
                                  "timeDifference": "+1:00",
                                  "timeZone": "Central Europe Standard Time"
                                },
                                "switzerlandnorth": {
                                  "abbreviation": "chn",
                                  "recoveryServicesGeo": "szn",
                                  "timeDifference": "+1:00",
                                  "timeZone": "Central Europe Standard Time"
                                },
                                "switzerlandwest": {
                                  "abbreviation": "chw",
                                  "recoveryServicesGeo": "szw",
                                  "timeDifference": "+1:00",
                                  "timeZone": "Central Europe Standard Time"
                                },
                                "uaecentral": {
                                  "abbreviation": "aec",
                                  "recoveryServicesGeo": "uac",
                                  "timeDifference": "+3:00",
                                  "timeZone": "Arabian Standard Time"
                                },
                                "uaenorth": {
                                  "abbreviation": "aen",
                                  "recoveryServicesGeo": "uan",
                                  "timeDifference": "+3:00",
                                  "timeZone": "Arabian Standard Time"
                                },
                                "uksouth": {
                                  "abbreviation": "uks",
                                  "recoveryServicesGeo": "uks",
                                  "timeDifference": "0:00",
                                  "timeZone": "GMT Standard Time"
                                },
                                "ukwest": {
                                  "abbreviation": "ukw",
                                  "recoveryServicesGeo": "ukw",
                                  "timeDifference": "0:00",
                                  "timeZone": "GMT Standard Time"
                                },
                                "westcentralus": {
                                  "abbreviation": "uswc",
                                  "recoveryServicesGeo": "wcus",
                                  "timeDifference": "-7:00",
                                  "timeZone": "Mountain Standard Time"
                                },
                                "westeurope": {
                                  "abbreviation": "euw",
                                  "recoveryServicesGeo": "we",
                                  "timeDifference": "+1:00",
                                  "timeZone": "Central Europe Standard Time"
                                },
                                "westindia": {
                                  "abbreviation": "inw",
                                  "recoveryServicesGeo": "inw",
                                  "timeDifference": "+5:30",
                                  "timeZone": "India Standard Time"
                                },
                                "westus": {
                                  "abbreviation": "usw",
                                  "recoveryServicesGeo": "wus",
                                  "timeDifference": "-8:00",
                                  "timeZone": "Pacific Standard Time"
                                },
                                "westus2": {
                                  "abbreviation": "usw2",
                                  "recoveryServicesGeo": "wus2",
                                  "timeDifference": "-8:00",
                                  "timeZone": "Pacific Standard Time"
                                },
                                "westus3": {
                                  "abbreviation": "usw3",
                                  "recoveryServicesGeo": "wus3",
                                  "timeDifference": "-7:00",
                                  "timeZone": "Mountain Standard Time"
                                }
                              },
                              "AzureUSGovernment": {
                                "usdodcentral": {
                                  "abbreviation": "dodc",
                                  "recoveryServicesGeo": "udc",
                                  "timeDifference": "-6:00",
                                  "timeZone": "Central Standard Time"
                                },
                                "usdodeast": {
                                  "abbreviation": "dode",
                                  "recoveryServicesGeo": "ude",
                                  "timeDifference": "-5:00",
                                  "timeZone": "Eastern Standard Time"
                                },
                                "usgovarizona": {
                                  "abbreviation": "az",
                                  "recoveryServicesGeo": "uga",
                                  "timeDifference": "-7:00",
                                  "timeZone": "Mountain Standard Time"
                                },
                                "usgovtexas": {
                                  "abbreviation": "tx",
                                  "recoveryServicesGeo": "ugt",
                                  "timeDifference": "-6:00",
                                  "timeZone": "Central Standard Time"
                                },
                                "usgovvirginia": {
                                  "abbreviation": "va",
                                  "recoveryServicesGeo": "ugv",
                                  "timeDifference": "-5:00",
                                  "timeZone": "Eastern Standard Time"
                                }
                              }
                            },
                            "$fxv#1": "1.0.0",
                            "$fxv#2": {
                              "actionGroups": "ag",
                              "applicationGroups": "vdag",
                              "applicationInsights": "appi",
                              "appServicePlans": "asp",
                              "automationAccounts": "aa",
                              "availabilitySets": "avail",
                              "azureFirewalls": "afw",
                              "bastionHosts": "bas",
                              "computeGallieries": "cg",
                              "dataCollectionEndpoints": "dce",
                              "dataCollectionRuleAssociations": "dcra",
                              "dataCollectionRules": "dcr",
                              "diagnosticSettings": "diag",
                              "diskAccesses": "da",
                              "diskEncryptionSets": "des",
                              "disks": "disk",
                              "firewallPolicies": "afwp",
                              "applicationGateways": "agw",
                              "applicationGatewayWafPolicies": "agwwafp",
                              "functionApps": "func",
                              "hostPools": "vdpool",
                              "ipConfigurations": "ipconf",
                              "keyVaults": "kv",
                              "localNetworkGateways": "lgw",
                              "logAnalyticsWorkspaces": "log",
                              "natGateways": "ng",
                              "netAppAccounts": "naa",
                              "netAppAccountsCapacityPools": "cp",
                              "networkInterfaces": "nic",
                              "networkSecurityGroups": "nsg",
                              "networkWatchers": "nw",
                              "networkWatchersFlowLogs": "fl",
                              "privateEndpoints": "pe",
                              "privateLinkScopes": "pls",
                              "publicIPAddresses": "pip",
                              "publicIPPrefixes": "ippre",
                              "recoveryServicesVaults": "rsv",
                              "remoteApplicationGroups": "vdag",
                              "resourceGroups": "rg",
                              "routeTables": "rt",
                              "scalingPlans": "vdscaling",
                              "storageAccounts": "st",
                              "subnets": "snet",
                              "userAssignedIdentities": "id",
                              "virtualMachines": "vm",
                              "virtualNetworkGateways": "vgw",
                              "virtualNetworks": "vnet",
                              "workspaces": "vdws"
                            },
                            "directionShortNames": {
                              "east": "e",
                              "eastcentral": "ec",
                              "north": "n",
                              "northcentral": "nc",
                              "south": "s",
                              "southcentral": "sc",
                              "west": "w",
                              "westcentral": "wc"
                            },
                            "environmentName": {
                              "dev": "Development",
                              "prod": "Production",
                              "test": "Test"
                            },
                            "locations": "[coalesce(tryGet(variables('$fxv#0'), environment().name), createObject(format('{0}', parameters('location')), createObject('abbreviation', variables('directionShortNames')[skip(parameters('location'), sub(length(parameters('location')), 4))], 'timeDifference', if(contains(parameters('location'), 'east'), '-5:00', if(contains(parameters('location'), 'west'), '-8:00', '0:00')), 'timeZone', if(contains(parameters('location'), 'east'), 'Eastern Standard Time', if(contains(parameters('location'), 'west'), 'Pacific Standard Time', 'GMT Standard Time')))))]",
                            "mlzTags": {
                              "environment": "[variables('environmentName')[parameters('environmentAbbreviation')]]",
                              "identifier": "[parameters('identifier')]",
                              "landingZoneName": "MissionLandingZone",
                              "landingZoneVersion": "[variables('$fxv#1')]"
                            },
                            "resourceAbbreviations": "[variables('$fxv#2')]"
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "namingConventions",
                                "count": "[length(parameters('networks'))]"
                              },
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('naming-convention-{0}-{1}', parameters('networks')[copyIndex()].shortName, parameters('deploymentNameSuffix'))]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "delimiter": {
                                    "value": "[parameters('delimiter')]"
                                  },
                                  "environmentAbbreviation": {
                                    "value": "[parameters('environmentAbbreviation')]"
                                  },
                                  "identifier": {
                                    "value": "[parameters('identifier')]"
                                  },
                                  "locationAbbreviation": {
                                    "value": "[variables('locations')[parameters('location')].abbreviation]"
                                  },
                                  "networkName": {
                                    "value": "[parameters('networks')[copyIndex()].name]"
                                  },
                                  "resourceAbbreviations": {
                                    "value": "[variables('resourceAbbreviations')]"
                                  },
                                  "stampIndex": {
                                    "value": "[parameters('stampIndex')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "6403027296801861578"
                                    }
                                  },
                                  "parameters": {
                                    "delimiter": {
                                      "type": "string",
                                      "allowedValues": [
                                        "",
                                        "-"
                                      ]
                                    },
                                    "environmentAbbreviation": {
                                      "type": "string"
                                    },
                                    "identifier": {
                                      "type": "string"
                                    },
                                    "locationAbbreviation": {
                                      "type": "string"
                                    },
                                    "networkName": {
                                      "type": "string"
                                    },
                                    "resourceAbbreviations": {
                                      "type": "object"
                                    },
                                    "stampIndex": {
                                      "type": "string",
                                      "defaultValue": ""
                                    }
                                  },
                                  "variables": {
                                    "tokens": {
                                      "purpose": "purpose_token",
                                      "resource": "resource_token",
                                      "service": "service_token"
                                    },
                                    "namingConvention": "[format('{0}{1}{2}{3}{4}{5}{6}{7}{8}{9}{10}{11}', toLower(parameters('identifier')), parameters('delimiter'), parameters('environmentAbbreviation'), parameters('delimiter'), parameters('locationAbbreviation'), parameters('delimiter'), parameters('networkName'), parameters('delimiter'), variables('tokens').resource, parameters('delimiter'), variables('tokens').purpose, if(empty(parameters('stampIndex')), '', format('{0}{1}', parameters('delimiter'), parameters('stampIndex'))))]",
                                    "namingConvention_Service": "[format('{0}{1}{2}{3}{4}{5}{6}{7}{8}{9}{10}{11}{12}{13}', toLower(parameters('identifier')), parameters('delimiter'), parameters('environmentAbbreviation'), parameters('delimiter'), parameters('locationAbbreviation'), parameters('delimiter'), parameters('networkName'), parameters('delimiter'), variables('tokens').service, parameters('delimiter'), variables('tokens').resource, parameters('delimiter'), variables('tokens').purpose, if(empty(parameters('stampIndex')), '', format('{0}{1}', parameters('delimiter'), parameters('stampIndex'))))]",
                                    "names": {
                                      "actionGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').actionGroups)]",
                                      "applicationGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationGroups)]",
                                      "applicationInsights": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationInsights)]",
                                      "appServicePlan": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').appServicePlans)]",
                                      "automationAccount": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').automationAccounts)]",
                                      "automationAccountDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').automationAccounts)]",
                                      "automationAccountNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').automationAccounts)]",
                                      "automationAccountPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').automationAccounts)]",
                                      "availabilitySet": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').availabilitySets)]",
                                      "azureFirewall": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').azureFirewalls)]",
                                      "azureFirewallPublicIPAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').azureFirewalls)]",
                                      "azureFirewallPublicIPAddressDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').publicIPAddresses, parameters('delimiter'), parameters('resourceAbbreviations').azureFirewalls))]",
                                      "azureFirewallDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').azureFirewalls)]",
                                      "azureFirewallPolicy": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').firewallPolicies)]",
                                      "applicationGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationGateways)]",
                                      "applicationGatewayPublicIPAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                                      "applicationGatewayDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                                      "applicationGatewayWafPolicy": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationGatewayWafPolicies)]",
                                      "applicationGatewayWafPolicyDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').applicationGatewayWafPolicies)]",
                                      "applicationGatewayRouteTable": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').routeTables), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                                      "applicationGatewayNetworkSecurityGroup": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkSecurityGroups), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                                      "bastionHost": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').bastionHosts)]",
                                      "bastionHostDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').bastionHosts)]",
                                      "bastionHostNetworkSecurityGroup": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkSecurityGroups), variables('tokens').service, parameters('resourceAbbreviations').bastionHosts)]",
                                      "bastionHostNetworkSecurityGroupDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').networkSecurityGroups, parameters('delimiter'), parameters('resourceAbbreviations').bastionHosts))]",
                                      "bastionHostPublicIPAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').bastionHosts)]",
                                      "bastionHostPublicIPAddressDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').publicIPAddresses, parameters('delimiter'), parameters('resourceAbbreviations').bastionHosts))]",
                                      "computeGallery": "[replace(replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').computeGallieries), parameters('delimiter'), if(empty(parameters('delimiter')), '', '_'))]",
                                      "dataCollectionEndpoint": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').dataCollectionEndpoints)]",
                                      "dataCollectionRuleAssociation": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').dataCollectionRuleAssociations)]",
                                      "dataCollectionRule": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').dataCollectionRules)]",
                                      "diskAccess": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').diskAccesses)]",
                                      "diskAccessNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').diskAccesses)]",
                                      "diskAccessPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').diskAccesses)]",
                                      "diskEncryptionSet": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').diskEncryptionSets)]",
                                      "functionApp": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').functionApps)]",
                                      "functionAppNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').functionApps)]",
                                      "functionAppPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').functionApps)]",
                                      "hostPool": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').hostPools)]",
                                      "hostPoolDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').hostPools)]",
                                      "hostPoolNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').hostPools)]",
                                      "hostPoolPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').hostPools)]",
                                      "keyVault": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').keyVaults)]",
                                      "keyVaultDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').keyVaults)]",
                                      "keyVaultNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').keyVaults)]",
                                      "keyVaultPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').keyVaults)]",
                                      "localNetworkGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').localNetworkGateways)]",
                                      "logAnalyticsWorkspace": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').logAnalyticsWorkspaces)]",
                                      "logAnalyticsWorkspaceDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').logAnalyticsWorkspaces)]",
                                      "natGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').natGateways)]",
                                      "natGatewayPublicIPPrefix": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPPrefixes), variables('tokens').service, parameters('resourceAbbreviations').natGateways)]",
                                      "netAppAccount": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').netAppAccounts)]",
                                      "netAppAccountCapacityPool": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').netAppAccountsCapacityPools), variables('tokens').service, parameters('resourceAbbreviations').netAppAccounts)]",
                                      "netAppAccountSmbServer": "[replace(replace(replace(replace(variables('namingConvention'), variables('tokens').resource, ''), parameters('environmentAbbreviation'), first(parameters('environmentAbbreviation'))), parameters('networkName'), ''), parameters('delimiter'), '')]",
                                      "networkSecurityGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').networkSecurityGroups)]",
                                      "networkSecurityGroupDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').networkSecurityGroups)]",
                                      "networkWatcherFlowLogsNetworkSecurityGroup": "[replace(variables('namingConvention'), variables('tokens').resource, format('{0}{1}{2}{3}{4}', parameters('resourceAbbreviations').networkWatchers, parameters('delimiter'), parameters('resourceAbbreviations').networkWatchersFlowLogs, parameters('delimiter'), parameters('resourceAbbreviations').networkSecurityGroups))]",
                                      "networkWatcherFlowLogsVirtualNetwork": "[replace(variables('namingConvention'), variables('tokens').resource, format('{0}{1}{2}{3}{4}', parameters('resourceAbbreviations').networkWatchers, parameters('delimiter'), parameters('resourceAbbreviations').networkWatchersFlowLogs, parameters('delimiter'), parameters('resourceAbbreviations').virtualNetworks))]",
                                      "privateLinkScope": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').privateLinkScopes)]",
                                      "privateLinkScopeNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').privateLinkScopes)]",
                                      "privateLinkScopePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').privateLinkScopes)]",
                                      "recoveryServicesVault": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').recoveryServicesVaults)]",
                                      "recoveryServicesVaultNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').recoveryServicesVaults)]",
                                      "recoveryServicesVaultPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').recoveryServicesVaults)]",
                                      "resourceGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').resourceGroups)]",
                                      "routeTable": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').routeTables)]",
                                      "scalingPlan": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').scalingPlans)]",
                                      "scalingPlanDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').scalingPlans)]",
                                      "storageAccount": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').storageAccounts)]",
                                      "storageAccountBlobDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}blob', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                      "storageAccountBlobNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}blob', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                      "storageAccountBlobPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}blob', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                      "storageAccountDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').storageAccounts)]",
                                      "storageAccountFileDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}file', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                      "storageAccountFileNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}file', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                      "storageAccountFilePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}file', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                      "storageAccountQueueDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}queue', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                      "storageAccountQueueNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}queue', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                      "storageAccountQueuePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}queue', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                      "storageAccountTableDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}table', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                      "storageAccountTableNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}table', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                      "storageAccountTablePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}table', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                      "subnet": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').subnets)]",
                                      "userAssignedIdentity": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').userAssignedIdentities)]",
                                      "virtualMachine": "[replace(replace(replace(replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').virtualMachines), parameters('environmentAbbreviation'), first(parameters('environmentAbbreviation'))), parameters('networkName'), ''), parameters('delimiter'), '')]",
                                      "virtualMachineDisk": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').disks), variables('tokens').service, format('{0}', parameters('resourceAbbreviations').virtualMachines))]",
                                      "virtualMachineNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').virtualMachines)]",
                                      "virtualMachineNetworkInterfaceDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').networkInterfaces, parameters('delimiter'), parameters('resourceAbbreviations').virtualMachines))]",
                                      "virtualNetwork": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').virtualNetworks)]",
                                      "virtualNetworkDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').virtualNetworks)]",
                                      "virtualNetworkGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').virtualNetworkGateways)]",
                                      "virtualNetworkGatewayPublicIpAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').virtualNetworkGateways)]",
                                      "workspace": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').workspaces)]",
                                      "workspaceDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').workspaces)]",
                                      "workspaceNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').workspaces)]",
                                      "workspacePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').workspaces)]"
                                    }
                                  },
                                  "resources": [],
                                  "outputs": {
                                    "delimiter": {
                                      "type": "string",
                                      "value": "[parameters('delimiter')]"
                                    },
                                    "names": {
                                      "type": "object",
                                      "value": "[variables('names')]"
                                    },
                                    "tokens": {
                                      "type": "object",
                                      "value": "[variables('tokens')]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('private-dns-zones-{0}', parameters('deploymentNameSuffix'))]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {},
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "3047584333563107444"
                                    }
                                  },
                                  "variables": {
                                    "cloudSuffix": "[replace(replace(environment().resourceManager, 'https://management.azure.', ''), '/', '')]",
                                    "privateDnsZoneNames": "[union(createArray(format('privatelink.agentsvc.azure-automation.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureAutomation, environment().name), format('opinsights.azure.{0}', variables('cloudSuffix')))), format('privatelink.azure-automation.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureAutomation, environment().name), variables('cloudSuffix'))), format('privatelink.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureWebSites, environment().name), format('appservice.{0}', variables('cloudSuffix')))), format('scm.privatelink.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureWebSites, environment().name), format('appservice.{0}', variables('cloudSuffix')))), format('privatelink.wvd.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureVirtualDesktop, environment().name), variables('cloudSuffix'))), format('privatelink-global.wvd.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureVirtualDesktop, environment().name), variables('cloudSuffix'))), format('privatelink.file.{0}', environment().suffixes.storage), format('privatelink.queue.{0}', environment().suffixes.storage), format('privatelink.table.{0}', environment().suffixes.storage), format('privatelink.blob.{0}', environment().suffixes.storage), format('privatelink{0}', replace(environment().suffixes.keyvaultDns, 'vault', 'vaultcore')), format('privatelink.monitor.azure.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureMonitor, environment().name), variables('cloudSuffix'))), format('privatelink.ods.opinsights.azure.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureMonitor, environment().name), variables('cloudSuffix'))), format('privatelink.oms.opinsights.azure.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureMonitor, environment().name), variables('cloudSuffix'))), format('privatelink{0}', environment().suffixes.sqlServerHostname)), createArray())]",
                                    "privateDnsZoneSuffixes": {
                                      "azureAutomation": {
                                        "AzureCloud": "net",
                                        "AzureUSGovernment": "us"
                                      },
                                      "azureBackup": {
                                        "AzureCloud": "com",
                                        "AzureUSGovernment": "us"
                                      },
                                      "azureMonitor": {
                                        "AzureCloud": "com",
                                        "AzureUSGovernment": "us"
                                      },
                                      "azureVirtualDesktop": {
                                        "AzureCloud": "microsoft.com",
                                        "AzureUSGovernment": "azure.us"
                                      },
                                      "azureWebSites": {
                                        "AzureCloud": "azurewebsites.net",
                                        "AzureUSGovernment": "azurewebsites.us"
                                      }
                                    }
                                  },
                                  "resources": [],
                                  "outputs": {
                                    "names": {
                                      "type": "array",
                                      "value": "[variables('privateDnsZoneNames')]"
                                    }
                                  }
                                }
                              }
                            }
                          ],
                          "outputs": {
                            "delimiter": {
                              "type": "string",
                              "value": "[parameters('delimiter')]"
                            },
                            "locationProperties": {
                              "type": "object",
                              "value": "[variables('locations')[parameters('location')]]"
                            },
                            "mlzTags": {
                              "type": "object",
                              "value": "[variables('mlzTags')]"
                            },
                            "privateDnsZones": {
                              "type": "array",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value]"
                            },
                            "resourceAbbreviations": {
                              "type": "object",
                              "value": "[variables('resourceAbbreviations')]"
                            },
                            "tiers": {
                              "type": "array",
                              "copy": {
                                "count": "[length(parameters('networks'))]",
                                "input": {
                                  "name": "[parameters('networks')[copyIndex()].name]",
                                  "namingConvention": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('naming-convention-{0}-{1}', parameters('networks')[copyIndex()].shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value]",
                                  "nsgDiagLogs": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'nsgDiagLogs'), createArray())]",
                                  "nsgRules": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'nsgRules'), createArray())]",
                                  "shortName": "[parameters('networks')[copyIndex()].shortName]",
                                  "subnetAddressPrefix": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'subnetAddressPrefix'), '')]",
                                  "subscriptionId": "[parameters('networks')[copyIndex()].subscriptionId]",
                                  "vnetAddressPrefix": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'vnetAddressPrefix'), '')]",
                                  "vnetDiagLogs": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'vnetDiagLogs'), createArray())]",
                                  "vnetDiagMetrics": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'vnetDiagMetrics'), createArray())]"
                                }
                              }
                            },
                            "tokens": {
                              "type": "object",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('naming-convention-{0}-{1}', parameters('networks')[0].shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                          },
                          "purpose": {
                            "value": "network"
                          },
                          "tiers": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "tokens": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "1860956754057576062"
                            }
                          },
                          "parameters": {
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "purpose": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            },
                            "tiers": {
                              "type": "array"
                            },
                            "tokens": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "resourceGroups",
                                "count": "[length(parameters('tiers'))]"
                              },
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-rg-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tiers')[copyIndex()].subscriptionId]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "name": {
                                    "value": "[replace(parameters('tiers')[copyIndex()].namingConvention.resourceGroup, parameters('tokens').purpose, parameters('purpose'))]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "tags": {
                                    "value": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Resources/resourceGroups'), createObject()), parameters('mlzTags'))]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "29921048879103880"
                                    }
                                  },
                                  "parameters": {
                                    "name": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object",
                                      "defaultValue": {}
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Resources/resourceGroups",
                                      "apiVersion": "2019-05-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]"
                                    }
                                  ],
                                  "outputs": {
                                    "id": {
                                      "type": "string",
                                      "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
                                    },
                                    "name": {
                                      "type": "string",
                                      "value": "[parameters('name')]"
                                    },
                                    "location": {
                                      "type": "string",
                                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').location]"
                                    },
                                    "tags": {
                                      "type": "object",
                                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').tags]"
                                    }
                                  }
                                }
                              }
                            }
                          ],
                          "outputs": {
                            "names": {
                              "type": "array",
                              "copy": {
                                "count": "[length(parameters('tiers'))]",
                                "input": "[reference(subscriptionResourceId(parameters('tiers')[copyIndex()].subscriptionId, 'Microsoft.Resources/deployments', format('deploy-rg-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                              }
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "azureGatewaySubnetAddressPrefix": {
                            "value": "[parameters('azureGatewaySubnetAddressPrefix')]"
                          },
                          "bastionHostSubnetAddressPrefix": {
                            "value": "[parameters('bastionHostSubnetAddressPrefix')]"
                          },
                          "delimiter": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                          },
                          "deployAzureGatewaySubnet": {
                            "value": "[parameters('deployAzureGatewaySubnet')]"
                          },
                          "deployBastion": {
                            "value": "[parameters('deployBastion')]"
                          },
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "dnsServers": {
                            "value": "[parameters('dnsServers')]"
                          },
                          "enableProxy": {
                            "value": "[parameters('enableProxy')]"
                          },
                          "firewallClientPrivateIpAddress": {
                            "value": "[parameters('firewallSettings').clientPrivateIpAddress]"
                          },
                          "firewallClientPublicIPAddressAvailabilityZones": {
                            "value": "[parameters('firewallSettings').clientPublicIPAddressAvailabilityZones]"
                          },
                          "firewallClientSubnetAddressPrefix": {
                            "value": "[parameters('firewallSettings').clientSubnetAddressPrefix]"
                          },
                          "firewallCustomPipCount": {
                            "value": "[parameters('firewallSettings').customPipCount]"
                          },
                          "firewallIntrusionDetectionMode": {
                            "value": "[parameters('firewallSettings').intrusionDetectionMode]"
                          },
                          "firewallManagementPublicIPAddressAvailabilityZones": {
                            "value": "[parameters('firewallSettings').managementPublicIPAddressAvailabilityZones]"
                          },
                          "firewallManagementSubnetAddressPrefix": {
                            "value": "[parameters('firewallSettings').managementSubnetAddressPrefix]"
                          },
                          "firewallSkuTier": {
                            "value": "[parameters('firewallSettings').skuTier]"
                          },
                          "firewallThreatIntelMode": {
                            "value": "[parameters('firewallSettings').threatIntelMode]"
                          },
                          "firewallRuleCollectionGroups": {
                            "value": "[parameters('firewallRuleCollectionGroups')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                          },
                          "resourceGroupName": {
                            "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value, lambda('name', contains(lambdaVariables('name'), 'hub')))[0]]"
                          },
                          "subscriptionId": {
                            "value": "[variables('hubSubscriptionId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "tier": {
                            "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value, lambda('tier', equals(lambdaVariables('tier').name, 'hub')))[0]]"
                          },
                          "tokens": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                          },
                          "vNetDnsServers": {
                            "value": [
                              "[parameters('firewallSettings').clientPrivateIpAddress]"
                            ]
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "8927604807893245559"
                            }
                          },
                          "parameters": {
                            "azureGatewaySubnetAddressPrefix": {
                              "type": "string"
                            },
                            "bastionHostSubnetAddressPrefix": {
                              "type": "string"
                            },
                            "delimiter": {
                              "type": "string"
                            },
                            "deployAzureGatewaySubnet": {
                              "type": "bool"
                            },
                            "deployBastion": {
                              "type": "bool"
                            },
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "dnsServers": {
                              "type": "array"
                            },
                            "enableProxy": {
                              "type": "bool"
                            },
                            "firewallClientPrivateIpAddress": {
                              "type": "string"
                            },
                            "firewallClientPublicIPAddressAvailabilityZones": {
                              "type": "array"
                            },
                            "firewallClientSubnetAddressPrefix": {
                              "type": "string"
                            },
                            "firewallCustomPipCount": {
                              "type": "int"
                            },
                            "firewallIntrusionDetectionMode": {
                              "type": "string",
                              "allowedValues": [
                                "Alert",
                                "Deny",
                                "Off"
                              ]
                            },
                            "firewallManagementPublicIPAddressAvailabilityZones": {
                              "type": "array"
                            },
                            "firewallManagementSubnetAddressPrefix": {
                              "type": "string"
                            },
                            "firewallRuleCollectionGroups": {
                              "type": "array"
                            },
                            "firewallSkuTier": {
                              "type": "string"
                            },
                            "firewallThreatIntelMode": {
                              "type": "string",
                              "allowedValues": [
                                "Alert",
                                "Deny",
                                "Off"
                              ]
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "resourceGroupName": {
                              "type": "string"
                            },
                            "subscriptionId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "tier": {
                              "type": "object"
                            },
                            "tokens": {
                              "type": "object"
                            },
                            "vNetDnsServers": {
                              "type": "array"
                            }
                          },
                          "variables": {
                            "bastionNetworkSecurityGroupRules": [
                              {
                                "name": "AllowHttpsInBound",
                                "properties": {
                                  "protocol": "Tcp",
                                  "sourcePortRange": "*",
                                  "sourceAddressPrefix": "Internet",
                                  "destinationPortRange": "443",
                                  "destinationAddressPrefix": "*",
                                  "access": "Allow",
                                  "priority": 120,
                                  "direction": "Inbound"
                                }
                              },
                              {
                                "name": "AllowGatewayManagerInBound",
                                "properties": {
                                  "protocol": "Tcp",
                                  "sourcePortRange": "*",
                                  "sourceAddressPrefix": "GatewayManager",
                                  "destinationPortRange": "443",
                                  "destinationAddressPrefix": "*",
                                  "access": "Allow",
                                  "priority": 130,
                                  "direction": "Inbound"
                                }
                              },
                              {
                                "name": "AllowLoadBalancerInBound",
                                "properties": {
                                  "protocol": "Tcp",
                                  "sourcePortRange": "*",
                                  "sourceAddressPrefix": "AzureLoadBalancer",
                                  "destinationPortRange": "443",
                                  "destinationAddressPrefix": "*",
                                  "access": "Allow",
                                  "priority": 140,
                                  "direction": "Inbound"
                                }
                              },
                              {
                                "name": "AllowBastionHostCommunicationInBound",
                                "properties": {
                                  "protocol": "*",
                                  "sourcePortRange": "*",
                                  "sourceAddressPrefix": "VirtualNetwork",
                                  "destinationPortRanges": [
                                    "8080",
                                    "5701"
                                  ],
                                  "destinationAddressPrefix": "VirtualNetwork",
                                  "access": "Allow",
                                  "priority": 150,
                                  "direction": "Inbound"
                                }
                              },
                              {
                                "name": "AllowSshRdpOutBound",
                                "properties": {
                                  "protocol": "Tcp",
                                  "sourcePortRange": "*",
                                  "sourceAddressPrefix": "*",
                                  "destinationPortRanges": [
                                    "22",
                                    "3389"
                                  ],
                                  "destinationAddressPrefix": "VirtualNetwork",
                                  "access": "Allow",
                                  "priority": 120,
                                  "direction": "Outbound"
                                }
                              },
                              {
                                "name": "AllowAzureCloudCommunicationOutBound",
                                "properties": {
                                  "protocol": "Tcp",
                                  "sourcePortRange": "*",
                                  "sourceAddressPrefix": "*",
                                  "destinationPortRange": "443",
                                  "destinationAddressPrefix": "AzureCloud",
                                  "access": "Allow",
                                  "priority": 130,
                                  "direction": "Outbound"
                                }
                              },
                              {
                                "name": "AllowBastionHostCommunicationOutBound",
                                "properties": {
                                  "protocol": "*",
                                  "sourcePortRange": "*",
                                  "sourceAddressPrefix": "VirtualNetwork",
                                  "destinationPortRanges": [
                                    "8080",
                                    "5701"
                                  ],
                                  "destinationAddressPrefix": "VirtualNetwork",
                                  "access": "Allow",
                                  "priority": 140,
                                  "direction": "Outbound"
                                }
                              },
                              {
                                "name": "AllowGetSessionInformationOutBound",
                                "properties": {
                                  "protocol": "*",
                                  "sourcePortRange": "*",
                                  "sourceAddressPrefix": "*",
                                  "destinationAddressPrefix": "Internet",
                                  "destinationPortRanges": [
                                    "80",
                                    "443"
                                  ],
                                  "access": "Allow",
                                  "priority": 150,
                                  "direction": "Outbound"
                                }
                              }
                            ]
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-hub-nsg-{0}', parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[parameters('mlzTags')]"
                                  },
                                  "name": {
                                    "value": "[replace(parameters('tier').namingConvention.networkSecurityGroup, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "securityRules": {
                                    "value": "[parameters('tier').nsgRules]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "13291183460695095968"
                                    }
                                  },
                                  "parameters": {
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "name": {
                                      "type": "string"
                                    },
                                    "securityRules": {
                                      "type": "array"
                                    },
                                    "tags": {
                                      "type": "object"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/networkSecurityGroups",
                                      "apiVersion": "2021-02-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkSecurityGroups'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "securityRules": "[parameters('securityRules')]"
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "id": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                                    },
                                    "name": {
                                      "type": "string",
                                      "value": "[parameters('name')]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "condition": "[parameters('deployBastion')]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-hub-bastion-nsg-{0}', parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[parameters('mlzTags')]"
                                  },
                                  "name": {
                                    "value": "[replace(parameters('tier').namingConvention.bastionHostNetworkSecurityGroup, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "securityRules": {
                                    "value": "[variables('bastionNetworkSecurityGroupRules')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "13291183460695095968"
                                    }
                                  },
                                  "parameters": {
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "name": {
                                      "type": "string"
                                    },
                                    "securityRules": {
                                      "type": "array"
                                    },
                                    "tags": {
                                      "type": "object"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/networkSecurityGroups",
                                      "apiVersion": "2021-02-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkSecurityGroups'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "securityRules": "[parameters('securityRules')]"
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "id": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                                    },
                                    "name": {
                                      "type": "string",
                                      "value": "[parameters('name')]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-hub-rt-{0}', parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "disableBgpRoutePropagation": {
                                    "value": false
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[parameters('mlzTags')]"
                                  },
                                  "name": {
                                    "value": "[replace(parameters('tier').namingConvention.routeTable, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "routeNextHopIpAddress": {
                                    "value": "[parameters('firewallClientPrivateIpAddress')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "2680791520041812197"
                                    }
                                  },
                                  "parameters": {
                                    "disableBgpRoutePropagation": {
                                      "type": "bool"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "name": {
                                      "type": "string"
                                    },
                                    "routeAddressPrefix": {
                                      "type": "string",
                                      "defaultValue": "0.0.0.0/0"
                                    },
                                    "routeName": {
                                      "type": "string",
                                      "defaultValue": "default_route"
                                    },
                                    "routeNextHopIpAddress": {
                                      "type": "string"
                                    },
                                    "routeNextHopType": {
                                      "type": "string",
                                      "defaultValue": "VirtualAppliance"
                                    },
                                    "tags": {
                                      "type": "object"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/routeTables",
                                      "apiVersion": "2021-02-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/routeTables'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "disableBgpRoutePropagation": "[parameters('disableBgpRoutePropagation')]",
                                        "routes": [
                                          {
                                            "name": "[parameters('routeName')]",
                                            "properties": {
                                              "addressPrefix": "[parameters('routeAddressPrefix')]",
                                              "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                                              "nextHopType": "[parameters('routeNextHopType')]"
                                            }
                                          }
                                        ]
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "id": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                                    },
                                    "name": {
                                      "type": "string",
                                      "value": "[parameters('name')]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "addressPrefix": {
                                    "value": "[parameters('tier').vnetAddressPrefix]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[parameters('mlzTags')]"
                                  },
                                  "name": {
                                    "value": "[replace(parameters('tier').namingConvention.virtualNetwork, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "subnets": {
                                    "value": "[union(createArray(createObject('name', 'AzureFirewallSubnet', 'properties', createObject('addressPrefix', parameters('firewallClientSubnetAddressPrefix'), 'defaultOutboundAccess', false())), createObject('name', 'AzureFirewallManagementSubnet', 'properties', createObject('addressPrefix', parameters('firewallManagementSubnetAddressPrefix'), 'defaultOutboundAccess', false())), createObject('name', replace(parameters('tier').namingConvention.subnet, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''), 'properties', createObject('addressPrefix', parameters('tier').subnetAddressPrefix, 'defaultOutboundAccess', false(), 'networkSecurityGroup', createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-nsg-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value), 'privateEndpointNetworkPolicies', 'Disabled', 'privateLinkServiceNetworkPolicies', 'Disabled', 'routeTable', createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-rt-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value)))), if(parameters('deployBastion'), createArray(createObject('name', 'AzureBastionSubnet', 'properties', createObject('addressPrefix', parameters('bastionHostSubnetAddressPrefix'), 'defaultOutboundAccess', false(), 'networkSecurityGroup', createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-bastion-nsg-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value)))), createArray()), if(parameters('deployAzureGatewaySubnet'), createArray(createObject('name', 'GatewaySubnet', 'properties', createObject('addressPrefix', parameters('azureGatewaySubnetAddressPrefix'), 'defaultOutboundAccess', false()))), createArray()))]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  },
                                  "vNetDnsServers": {
                                    "value": "[parameters('vNetDnsServers')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "15576417548653840691"
                                    }
                                  },
                                  "parameters": {
                                    "addressPrefix": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "name": {
                                      "type": "string"
                                    },
                                    "subnets": {
                                      "type": "array"
                                    },
                                    "tags": {
                                      "type": "object"
                                    },
                                    "vNetDnsServers": {
                                      "type": "array"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/virtualNetworks",
                                      "apiVersion": "2023-11-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/virtualNetworks'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "addressSpace": {
                                          "addressPrefixes": [
                                            "[parameters('addressPrefix')]"
                                          ]
                                        },
                                        "subnets": "[parameters('subnets')]",
                                        "dhcpOptions": "[if(empty(parameters('vNetDnsServers')), null(), createObject('dnsServers', parameters('vNetDnsServers')))]"
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "addressPrefix": {
                                      "type": "string",
                                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2023-11-01').addressSpace.addressPrefixes[0]]"
                                    },
                                    "dnsServers": {
                                      "type": "array",
                                      "value": "[parameters('vNetDnsServers')]"
                                    },
                                    "id": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                                    },
                                    "name": {
                                      "type": "string",
                                      "value": "[parameters('name')]"
                                    },
                                    "subnets": {
                                      "type": "array",
                                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2023-11-01').subnets]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-bastion-nsg-{0}', parameters('deploymentNameSuffix')))]",
                                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-nsg-{0}', parameters('deploymentNameSuffix')))]",
                                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-rt-{0}', parameters('deploymentNameSuffix')))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-hub-fw-client-pip-{0}', parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "availabilityZones": {
                                    "value": "[parameters('firewallClientPublicIPAddressAvailabilityZones')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[parameters('mlzTags')]"
                                  },
                                  "name": {
                                    "value": "[replace(parameters('tier').namingConvention.azureFirewallPublicIPAddress, parameters('tokens').purpose, 'client')]"
                                  },
                                  "publicIpAllocationMethod": {
                                    "value": "Static"
                                  },
                                  "skuName": {
                                    "value": "Standard"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "7175785822751985689"
                                    }
                                  },
                                  "parameters": {
                                    "availabilityZones": {
                                      "type": "array"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "name": {
                                      "type": "string"
                                    },
                                    "publicIpAllocationMethod": {
                                      "type": "string"
                                    },
                                    "skuName": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/publicIPAddresses",
                                      "apiVersion": "2021-02-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/publicIPAddresses'), createObject()), parameters('mlzTags'))]",
                                      "sku": {
                                        "name": "[parameters('skuName')]"
                                      },
                                      "properties": {
                                        "publicIPAllocationMethod": "[parameters('publicIpAllocationMethod')]"
                                      },
                                      "zones": "[parameters('availabilityZones')]"
                                    }
                                  ],
                                  "outputs": {
                                    "id": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('name'))]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-hub-fw-mgmt-pip-{0}', parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "availabilityZones": {
                                    "value": "[parameters('firewallManagementPublicIPAddressAvailabilityZones')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[parameters('mlzTags')]"
                                  },
                                  "name": {
                                    "value": "[replace(parameters('tier').namingConvention.azureFirewallPublicIPAddress, parameters('tokens').purpose, 'management')]"
                                  },
                                  "publicIpAllocationMethod": {
                                    "value": "Static"
                                  },
                                  "skuName": {
                                    "value": "Standard"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "7175785822751985689"
                                    }
                                  },
                                  "parameters": {
                                    "availabilityZones": {
                                      "type": "array"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "name": {
                                      "type": "string"
                                    },
                                    "publicIpAllocationMethod": {
                                      "type": "string"
                                    },
                                    "skuName": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/publicIPAddresses",
                                      "apiVersion": "2021-02-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/publicIPAddresses'), createObject()), parameters('mlzTags'))]",
                                      "sku": {
                                        "name": "[parameters('skuName')]"
                                      },
                                      "properties": {
                                        "publicIPAllocationMethod": "[parameters('publicIpAllocationMethod')]"
                                      },
                                      "zones": "[parameters('availabilityZones')]"
                                    }
                                  ],
                                  "outputs": {
                                    "id": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('name'))]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "copy": {
                                "name": "firewallCustomPublicIPAddresses",
                                "count": "[length(range(1, parameters('firewallCustomPipCount')))]"
                              },
                              "condition": "[greater(parameters('firewallCustomPipCount'), 0)]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-hub-fw-custom-pip-{0}-{1}', range(1, parameters('firewallCustomPipCount'))[copyIndex()], parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "availabilityZones": {
                                    "value": "[parameters('firewallClientPublicIPAddressAvailabilityZones')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[parameters('mlzTags')]"
                                  },
                                  "name": {
                                    "value": "[format('{0}{1}{2}', replace(parameters('tier').namingConvention.azureFirewallPublicIPAddress, parameters('tokens').purpose, 'client'), parameters('delimiter'), range(1, parameters('firewallCustomPipCount'))[copyIndex()])]"
                                  },
                                  "publicIpAllocationMethod": {
                                    "value": "Static"
                                  },
                                  "skuName": {
                                    "value": "Standard"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "7175785822751985689"
                                    }
                                  },
                                  "parameters": {
                                    "availabilityZones": {
                                      "type": "array"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "name": {
                                      "type": "string"
                                    },
                                    "publicIpAllocationMethod": {
                                      "type": "string"
                                    },
                                    "skuName": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/publicIPAddresses",
                                      "apiVersion": "2021-02-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/publicIPAddresses'), createObject()), parameters('mlzTags'))]",
                                      "sku": {
                                        "name": "[parameters('skuName')]"
                                      },
                                      "properties": {
                                        "publicIPAllocationMethod": "[parameters('publicIpAllocationMethod')]"
                                      },
                                      "zones": "[parameters('availabilityZones')]"
                                    }
                                  ],
                                  "outputs": {
                                    "id": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('name'))]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-hub-fw-{0}', parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "clientIpConfigurationPublicIPAddressResourceId": {
                                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-client-pip-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value]"
                                  },
                                  "clientIpConfigurationSubnetResourceId": {
                                    "value": "[format('{0}/subnets/AzureFirewallSubnet', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value)]"
                                  },
                                  "customPipCount": {
                                    "value": "[parameters('firewallCustomPipCount')]"
                                  },
                                  "customPublicIPAddressNamePrefix": {
                                    "value": "[format('{0}{1}', replace(parameters('tier').namingConvention.azureFirewallPublicIPAddress, parameters('tokens').purpose, 'client'), parameters('delimiter'))]"
                                  },
                                  "dnsServers": {
                                    "value": "[parameters('dnsServers')]"
                                  },
                                  "enableProxy": {
                                    "value": "[parameters('enableProxy')]"
                                  },
                                  "firewallPolicyName": {
                                    "value": "[replace(parameters('tier').namingConvention.azureFirewallPolicy, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "intrusionDetectionMode": {
                                    "value": "[parameters('firewallIntrusionDetectionMode')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "managementIpConfigurationPublicIPAddressResourceId": {
                                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-mgmt-pip-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value]"
                                  },
                                  "managementIpConfigurationSubnetResourceId": {
                                    "value": "[format('{0}/subnets/AzureFirewallManagementSubnet', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value)]"
                                  },
                                  "mlzTags": {
                                    "value": "[parameters('mlzTags')]"
                                  },
                                  "name": {
                                    "value": "[replace(parameters('tier').namingConvention.azureFirewall, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "resourceGroupName": {
                                    "value": "[parameters('resourceGroupName')]"
                                  },
                                  "skuTier": {
                                    "value": "[parameters('firewallSkuTier')]"
                                  },
                                  "subscriptionId": {
                                    "value": "[parameters('subscriptionId')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  },
                                  "threatIntelMode": {
                                    "value": "[parameters('firewallThreatIntelMode')]"
                                  },
                                  "firewallRuleCollectionGroups": {
                                    "value": "[parameters('firewallRuleCollectionGroups')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "14390286570766267097"
                                    }
                                  },
                                  "parameters": {
                                    "clientIpConfigurationSubnetResourceId": {
                                      "type": "string"
                                    },
                                    "clientIpConfigurationPublicIPAddressResourceId": {
                                      "type": "string"
                                    },
                                    "customPipCount": {
                                      "type": "int",
                                      "defaultValue": 0
                                    },
                                    "customPublicIPAddressNamePrefix": {
                                      "type": "string",
                                      "defaultValue": ""
                                    },
                                    "dnsServers": {
                                      "type": "array"
                                    },
                                    "enableProxy": {
                                      "type": "bool"
                                    },
                                    "firewallPolicyName": {
                                      "type": "string"
                                    },
                                    "intrusionDetectionMode": {
                                      "type": "string",
                                      "allowedValues": [
                                        "Alert",
                                        "Deny",
                                        "Off"
                                      ]
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "managementIpConfigurationSubnetResourceId": {
                                      "type": "string"
                                    },
                                    "managementIpConfigurationPublicIPAddressResourceId": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "name": {
                                      "type": "string"
                                    },
                                    "resourceGroupName": {
                                      "type": "string"
                                    },
                                    "skuTier": {
                                      "type": "string",
                                      "allowedValues": [
                                        "Premium",
                                        "Standard"
                                      ]
                                    },
                                    "subscriptionId": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object",
                                      "defaultValue": {}
                                    },
                                    "threatIntelMode": {
                                      "type": "string",
                                      "allowedValues": [
                                        "Alert",
                                        "Deny",
                                        "Off"
                                      ]
                                    },
                                    "firewallRuleCollectionGroups": {
                                      "type": "array"
                                    }
                                  },
                                  "variables": {
                                    "copy": [
                                      {
                                        "name": "customIpConfigurations",
                                        "count": "[length(range(1, parameters('customPipCount')))]",
                                        "input": {
                                          "name": "[format('ipconfig-client-{0}', range(1, parameters('customPipCount'))[copyIndex('customIpConfigurations')])]",
                                          "properties": {
                                            "publicIPAddress": {
                                              "id": "[resourceId(parameters('subscriptionId'), parameters('resourceGroupName'), 'Microsoft.Network/publicIPAddresses', format('{0}{1}', parameters('customPublicIPAddressNamePrefix'), range(1, parameters('customPipCount'))[copyIndex('customIpConfigurations')]))]"
                                            }
                                          }
                                        }
                                      }
                                    ],
                                    "intrusionDetectionObject": {
                                      "mode": "[parameters('intrusionDetectionMode')]"
                                    },
                                    "dnsSettings": {
                                      "enableProxy": "[parameters('enableProxy')]",
                                      "servers": "[parameters('dnsServers')]"
                                    },
                                    "primaryIpConfiguration": {
                                      "name": "ipconfig-client",
                                      "properties": {
                                        "subnet": {
                                          "id": "[parameters('clientIpConfigurationSubnetResourceId')]"
                                        },
                                        "publicIPAddress": {
                                          "id": "[parameters('clientIpConfigurationPublicIPAddressResourceId')]"
                                        }
                                      }
                                    },
                                    "allIpConfigurations": "[if(greater(parameters('customPipCount'), 0), union(createArray(variables('primaryIpConfiguration')), variables('customIpConfigurations')), createArray(variables('primaryIpConfiguration')))]"
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/firewallPolicies",
                                      "apiVersion": "2021-02-01",
                                      "name": "[parameters('firewallPolicyName')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/firewallPolicies'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "threatIntelMode": "[parameters('threatIntelMode')]",
                                        "intrusionDetection": "[if(equals(parameters('skuTier'), 'Premium'), variables('intrusionDetectionObject'), null())]",
                                        "sku": {
                                          "tier": "[parameters('skuTier')]"
                                        },
                                        "dnsSettings": "[variables('dnsSettings')]"
                                      },
                                      "metadata": {
                                        "description": "Azure Firewall Policy"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Network/azureFirewalls",
                                      "apiVersion": "2021-02-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/azureFirewalls'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "ipConfigurations": "[variables('allIpConfigurations')]",
                                        "managementIpConfiguration": {
                                          "name": "ipconfig-management",
                                          "properties": {
                                            "subnet": {
                                              "id": "[parameters('managementIpConfigurationSubnetResourceId')]"
                                            },
                                            "publicIPAddress": {
                                              "id": "[parameters('managementIpConfigurationPublicIPAddressResourceId')]"
                                            }
                                          }
                                        },
                                        "firewallPolicy": {
                                          "id": "[resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName'))]"
                                        },
                                        "sku": {
                                          "tier": "[parameters('skuTier')]"
                                        }
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "defaultRuleCollectionsConfig",
                                      "subscriptionId": "[split(resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName')), '/')[2]]",
                                      "resourceGroup": "[split(resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName')), '/')[4]]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "firewallPolicyName": {
                                            "value": "[parameters('firewallPolicyName')]"
                                          },
                                          "firewallRuleCollectionGroups": {
                                            "value": "[parameters('firewallRuleCollectionGroups')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "8588468010825274521"
                                            }
                                          },
                                          "parameters": {
                                            "firewallPolicyName": {
                                              "type": "string"
                                            },
                                            "firewallRuleCollectionGroups": {
                                              "type": "array"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "copy": {
                                                "name": "ruleCreate",
                                                "count": "[length(parameters('firewallRuleCollectionGroups'))]",
                                                "mode": "serial",
                                                "batchSize": 1
                                              },
                                              "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
                                              "apiVersion": "2024-03-01",
                                              "name": "[format('{0}/{1}', parameters('firewallPolicyName'), parameters('firewallRuleCollectionGroups')[copyIndex()].name)]",
                                              "properties": "[parameters('firewallRuleCollectionGroups')[copyIndex()].properties]"
                                            }
                                          ]
                                        }
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Network/azureFirewalls', parameters('name'))]",
                                        "[resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName'))]"
                                      ]
                                    }
                                  ],
                                  "outputs": {
                                    "name": {
                                      "type": "string",
                                      "value": "[parameters('name')]"
                                    },
                                    "policyResourceId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName'))]"
                                    },
                                    "privateIPAddress": {
                                      "type": "string",
                                      "value": "[reference(resourceId('Microsoft.Network/azureFirewalls', parameters('name')), '2021-02-01').ipConfigurations[0].properties.privateIPAddress]"
                                    },
                                    "resourceId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/azureFirewalls', parameters('name'))]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-client-pip-{0}', parameters('deploymentNameSuffix')))]",
                                "firewallCustomPublicIPAddresses",
                                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-mgmt-pip-{0}', parameters('deploymentNameSuffix')))]",
                                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix')))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "bastionHostSubnetResourceId": {
                              "type": "string",
                              "value": "[if(parameters('deployBastion'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[3].id, '')]"
                            },
                            "dnsServers": {
                              "type": "array",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.dnsServers.value]"
                            },
                            "firewallName": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                            },
                            "firewallPolicyResourceId": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.policyResourceId.value]"
                            },
                            "firewallPrivateIPAddress": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateIPAddress.value]"
                            },
                            "firewallResourceId": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                            },
                            "networkSecurityGroupName": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-nsg-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                            },
                            "networkSecurityGroupResourceId": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-nsg-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value]"
                            },
                            "subnetAddressPrefix": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[2].properties.addressPrefix]"
                            },
                            "subnetName": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[2].name]"
                            },
                            "subnetResourceId": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[2].id]"
                            },
                            "virtualNetworkName": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                            },
                            "virtualNetworkResourceId": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "spokeNetworks",
                        "count": "[length(variables('spokes'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-vnet-{0}-{1}', variables('spokes')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "delimiter": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                          },
                          "resourceGroupName": {
                            "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value, lambda('name', contains(lambdaVariables('name'), variables('spokes')[copyIndex()].name)))[0]]"
                          },
                          "routeTableRouteNextHopIpAddress": {
                            "value": "[parameters('firewallSettings').clientPrivateIpAddress]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "tier": {
                            "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value, lambda('tier', equals(lambdaVariables('tier').name, variables('spokes')[copyIndex()].name)))[0]]"
                          },
                          "tokens": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                          },
                          "vNetDnsServers": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.dnsServers.value]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "4292077791685791333"
                            }
                          },
                          "parameters": {
                            "additionalSubnets": {
                              "type": "array",
                              "defaultValue": []
                            },
                            "delimiter": {
                              "type": "string"
                            },
                            "customSubnetName": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "resourceGroupName": {
                              "type": "string"
                            },
                            "routeTableRouteNextHopIpAddress": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "tier": {
                              "type": "object"
                            },
                            "tokens": {
                              "type": "object"
                            },
                            "vNetDnsServers": {
                              "type": "array"
                            }
                          },
                          "variables": {
                            "delegations": {
                              "azure-netapp-files": [
                                {
                                  "name": "Microsoft.Netapp.volumes",
                                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/delegations', variables('virtualNetworkName'), 'azure-netapp-files', 'delegation')]",
                                  "properties": {
                                    "serviceName": "Microsoft.Netapp/volumes"
                                  },
                                  "type": "Microsoft.Network/virtualNetworks/subnets/delegations"
                                }
                              ],
                              "function-app-outbound": [
                                {
                                  "name": "Microsoft.Web/sites",
                                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/delegations', variables('virtualNetworkName'), 'function-app-outbound', 'delegation')]",
                                  "properties": {
                                    "serviceName": "Microsoft.Web/serverfarms"
                                  },
                                  "type": "Microsoft.Network/virtualNetworks/subnets/delegations"
                                }
                              ]
                            },
                            "subnets": "[union(createArray(createObject('name', if(empty(parameters('customSubnetName')), replace(parameters('tier').namingConvention.subnet, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''), parameters('customSubnetName')), 'properties', createObject('addressPrefix', parameters('tier').subnetAddressPrefix))), parameters('additionalSubnets'))]",
                            "subscriptionId": "[parameters('tier').subscriptionId]",
                            "virtualNetworkName": "[replace(parameters('tier').namingConvention.virtualNetwork, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "networkSecurityGroup",
                              "subscriptionId": "[variables('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[parameters('mlzTags')]"
                                  },
                                  "name": {
                                    "value": "[replace(parameters('tier').namingConvention.networkSecurityGroup, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "securityRules": {
                                    "value": "[parameters('tier').nsgRules]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "13291183460695095968"
                                    }
                                  },
                                  "parameters": {
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "name": {
                                      "type": "string"
                                    },
                                    "securityRules": {
                                      "type": "array"
                                    },
                                    "tags": {
                                      "type": "object"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/networkSecurityGroups",
                                      "apiVersion": "2021-02-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkSecurityGroups'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "securityRules": "[parameters('securityRules')]"
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "id": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                                    },
                                    "name": {
                                      "type": "string",
                                      "value": "[parameters('name')]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "routeTable",
                              "subscriptionId": "[variables('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "disableBgpRoutePropagation": {
                                    "value": true
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[parameters('mlzTags')]"
                                  },
                                  "name": {
                                    "value": "[replace(parameters('tier').namingConvention.routeTable, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "routeNextHopIpAddress": {
                                    "value": "[parameters('routeTableRouteNextHopIpAddress')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "2680791520041812197"
                                    }
                                  },
                                  "parameters": {
                                    "disableBgpRoutePropagation": {
                                      "type": "bool"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "name": {
                                      "type": "string"
                                    },
                                    "routeAddressPrefix": {
                                      "type": "string",
                                      "defaultValue": "0.0.0.0/0"
                                    },
                                    "routeName": {
                                      "type": "string",
                                      "defaultValue": "default_route"
                                    },
                                    "routeNextHopIpAddress": {
                                      "type": "string"
                                    },
                                    "routeNextHopType": {
                                      "type": "string",
                                      "defaultValue": "VirtualAppliance"
                                    },
                                    "tags": {
                                      "type": "object"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/routeTables",
                                      "apiVersion": "2021-02-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/routeTables'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "disableBgpRoutePropagation": "[parameters('disableBgpRoutePropagation')]",
                                        "routes": [
                                          {
                                            "name": "[parameters('routeName')]",
                                            "properties": {
                                              "addressPrefix": "[parameters('routeAddressPrefix')]",
                                              "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                                              "nextHopType": "[parameters('routeNextHopType')]"
                                            }
                                          }
                                        ]
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "id": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                                    },
                                    "name": {
                                      "type": "string",
                                      "value": "[parameters('name')]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "virtualNetwork",
                              "subscriptionId": "[variables('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "addressPrefix": {
                                    "value": "[parameters('tier').vnetAddressPrefix]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[parameters('mlzTags')]"
                                  },
                                  "name": {
                                    "value": "[variables('virtualNetworkName')]"
                                  },
                                  "subnets": {
                                    "copy": [
                                      {
                                        "name": "value",
                                        "count": "[length(variables('subnets'))]",
                                        "input": "[createObject('name', variables('subnets')[copyIndex('value')].name, 'properties', createObject('addressPrefix', variables('subnets')[copyIndex('value')].properties.addressPrefix, 'defaultOutboundAccess', false(), 'delegations', coalesce(tryGet(variables('delegations'), variables('subnets')[copyIndex('value')].name), createArray()), 'networkSecurityGroup', createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup'), '2025-04-01').outputs.id.value), 'routeTable', createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'routeTable'), '2025-04-01').outputs.id.value), 'privateEndpointNetworkPolicies', 'Disabled', 'privateLinkServiceNetworkPolicies', 'Disabled'))]"
                                      }
                                    ]
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  },
                                  "vNetDnsServers": {
                                    "value": "[parameters('vNetDnsServers')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "15576417548653840691"
                                    }
                                  },
                                  "parameters": {
                                    "addressPrefix": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "name": {
                                      "type": "string"
                                    },
                                    "subnets": {
                                      "type": "array"
                                    },
                                    "tags": {
                                      "type": "object"
                                    },
                                    "vNetDnsServers": {
                                      "type": "array"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/virtualNetworks",
                                      "apiVersion": "2023-11-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/virtualNetworks'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "addressSpace": {
                                          "addressPrefixes": [
                                            "[parameters('addressPrefix')]"
                                          ]
                                        },
                                        "subnets": "[parameters('subnets')]",
                                        "dhcpOptions": "[if(empty(parameters('vNetDnsServers')), null(), createObject('dnsServers', parameters('vNetDnsServers')))]"
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "addressPrefix": {
                                      "type": "string",
                                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2023-11-01').addressSpace.addressPrefixes[0]]"
                                    },
                                    "dnsServers": {
                                      "type": "array",
                                      "value": "[parameters('vNetDnsServers')]"
                                    },
                                    "id": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                                    },
                                    "name": {
                                      "type": "string",
                                      "value": "[parameters('name')]"
                                    },
                                    "subnets": {
                                      "type": "array",
                                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2023-11-01').subnets]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup')]",
                                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'routeTable')]"
                              ]
                            }
                          ],
                          "outputs": {
                            "networkSecurityGroupName": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup'), '2025-04-01').outputs.name.value]"
                            },
                            "networkSecurityGroupResourceId": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup'), '2025-04-01').outputs.id.value]"
                            },
                            "subnets": {
                              "type": "array",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.subnets.value]"
                            },
                            "virtualNetworkAddressPrefix": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.addressPrefix.value]"
                            },
                            "virtualNetworkName": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.name.value]"
                            },
                            "virtualNetworkResourceId": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.id.value]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "hubVirtualNetworkPeerings",
                        "count": "[length(variables('spokes'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-vnet-peerings-hub-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "hubVirtualNetworkName": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkName.value]"
                          },
                          "resourceGroupName": {
                            "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value, lambda('name', contains(lambdaVariables('name'), 'hub')))[0]]"
                          },
                          "spokeShortName": {
                            "value": "[variables('spokes')[copyIndex()].shortName]"
                          },
                          "spokeVirtualNetworkResourceId": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[copyIndex()].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkResourceId.value]"
                          },
                          "subscriptionId": {
                            "value": "[variables('hubSubscriptionId')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "9009517396459708892"
                            }
                          },
                          "parameters": {
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "hubVirtualNetworkName": {
                              "type": "string"
                            },
                            "resourceGroupName": {
                              "type": "string"
                            },
                            "spokeShortName": {
                              "type": "string"
                            },
                            "spokeVirtualNetworkResourceId": {
                              "type": "string"
                            },
                            "subscriptionId": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('peer-hub-to-{0}-{1}', parameters('spokeShortName'), parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "remoteVirtualNetworkResourceId": {
                                    "value": "[parameters('spokeVirtualNetworkResourceId')]"
                                  },
                                  "virtualNetworkName": {
                                    "value": "[parameters('hubVirtualNetworkName')]"
                                  },
                                  "virtualNetworkPeerName": {
                                    "value": "[format('to-{0}', split(parameters('spokeVirtualNetworkResourceId'), '/')[8])]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "5018776708400490249"
                                    }
                                  },
                                  "parameters": {
                                    "remoteVirtualNetworkResourceId": {
                                      "type": "string"
                                    },
                                    "virtualNetworkName": {
                                      "type": "string"
                                    },
                                    "virtualNetworkPeerName": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                                      "apiVersion": "2021-02-01",
                                      "name": "[format('{0}/{1}', parameters('virtualNetworkName'), parameters('virtualNetworkPeerName'))]",
                                      "properties": {
                                        "allowForwardedTraffic": true,
                                        "remoteVirtualNetwork": {
                                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                                        }
                                      }
                                    }
                                  ]
                                }
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[copyIndex()].name, parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "spokeVirtualNetworkPeerings",
                        "count": "[length(variables('spokes'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-vnet-peerings-{0}-{1}', variables('spokes')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "hubVirtualNetworkResourceId": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkResourceId.value]"
                          },
                          "resourceGroupName": {
                            "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value, lambda('name', contains(lambdaVariables('name'), variables('spokes')[copyIndex()].name)))[0]]"
                          },
                          "spokeShortName": {
                            "value": "[variables('spokes')[copyIndex()].shortName]"
                          },
                          "spokeVirtualNetworkName": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[copyIndex()].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkName.value]"
                          },
                          "subscriptionId": {
                            "value": "[variables('spokes')[copyIndex()].subscriptionId]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "9423483428741617452"
                            }
                          },
                          "parameters": {
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "hubVirtualNetworkResourceId": {
                              "type": "string"
                            },
                            "resourceGroupName": {
                              "type": "string"
                            },
                            "spokeShortName": {
                              "type": "string"
                            },
                            "spokeVirtualNetworkName": {
                              "type": "string"
                            },
                            "subscriptionId": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('peer-{0}-to-hub-{1}', parameters('spokeShortName'), parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "remoteVirtualNetworkResourceId": {
                                    "value": "[parameters('hubVirtualNetworkResourceId')]"
                                  },
                                  "virtualNetworkName": {
                                    "value": "[parameters('spokeVirtualNetworkName')]"
                                  },
                                  "virtualNetworkPeerName": {
                                    "value": "[format('to-{0}', split(parameters('hubVirtualNetworkResourceId'), '/')[8])]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "5018776708400490249"
                                    }
                                  },
                                  "parameters": {
                                    "remoteVirtualNetworkResourceId": {
                                      "type": "string"
                                    },
                                    "virtualNetworkName": {
                                      "type": "string"
                                    },
                                    "virtualNetworkPeerName": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                                      "apiVersion": "2021-02-01",
                                      "name": "[format('{0}/{1}', parameters('virtualNetworkName'), parameters('virtualNetworkPeerName'))]",
                                      "properties": {
                                        "allowForwardedTraffic": true,
                                        "remoteVirtualNetwork": {
                                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                                        }
                                      }
                                    }
                                  ]
                                }
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[copyIndex()].name, parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deployIdentity": {
                            "value": "[parameters('deployIdentity')]"
                          },
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "hubVirtualNetworkResourceId": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkResourceId.value]"
                          },
                          "identityVirtualNetworkResourceId": "[if(parameters('deployIdentity'), createObject('value', reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[2].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkResourceId.value), createObject('value', ''))]",
                          "mlzTags": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                          },
                          "privateDnsZoneNames": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZones.value]"
                          },
                          "resourceGroupName": {
                            "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value, lambda('name', contains(lambdaVariables('name'), 'hub')))[0]]"
                          },
                          "subscriptionId": {
                            "value": "[variables('hubSubscriptionId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "13084582092988205409"
                            }
                          },
                          "parameters": {
                            "deployIdentity": {
                              "type": "bool"
                            },
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "hubVirtualNetworkResourceId": {
                              "type": "string"
                            },
                            "identityVirtualNetworkResourceId": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "privateDnsZoneNames": {
                              "type": "array"
                            },
                            "resourceGroupName": {
                              "type": "string"
                            },
                            "subscriptionId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "variables": {
                            "virtualNetworks": "[union(createArray(createObject('name', split(parameters('hubVirtualNetworkResourceId'), '/')[8], 'resourceGroupName', split(parameters('hubVirtualNetworkResourceId'), '/')[4], 'subscriptionId', split(parameters('hubVirtualNetworkResourceId'), '/')[2])), if(parameters('deployIdentity'), createArray(createObject('name', split(parameters('identityVirtualNetworkResourceId'), '/')[8], 'resourceGroupName', split(parameters('identityVirtualNetworkResourceId'), '/')[4], 'subscriptionId', split(parameters('identityVirtualNetworkResourceId'), '/')[2])), createArray()))]"
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "privateDnsZones",
                                "count": "[length(parameters('privateDnsZoneNames'))]"
                              },
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-pvt-dns-zone-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "name": {
                                    "value": "[parameters('privateDnsZoneNames')[copyIndex()]]"
                                  },
                                  "tags": {
                                    "value": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateDnsZones'), createObject()), parameters('mlzTags'))]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "17576944100216926"
                                    }
                                  },
                                  "parameters": {
                                    "name": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/privateDnsZones",
                                      "apiVersion": "2018-09-01",
                                      "name": "[parameters('name')]",
                                      "location": "global",
                                      "tags": "[parameters('tags')]"
                                    }
                                  ],
                                  "outputs": {
                                    "resourceId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('name'))]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "copy": {
                                "name": "virtualNetworkLinks",
                                "count": "[length(variables('virtualNetworks'))]",
                                "mode": "serial",
                                "batchSize": 1
                              },
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-vnet-links-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('subscriptionId')]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "privateDnsZoneNames": {
                                    "value": "[parameters('privateDnsZoneNames')]"
                                  },
                                  "virtualNetworkName": {
                                    "value": "[variables('virtualNetworks')[copyIndex()].name]"
                                  },
                                  "virtualNetworkResourceGroupName": {
                                    "value": "[variables('virtualNetworks')[copyIndex()].resourceGroupName]"
                                  },
                                  "virtualNetworkSubscriptionId": {
                                    "value": "[variables('virtualNetworks')[copyIndex()].subscriptionId]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "18390154743764048033"
                                    }
                                  },
                                  "parameters": {
                                    "privateDnsZoneNames": {
                                      "type": "array"
                                    },
                                    "virtualNetworkName": {
                                      "type": "string"
                                    },
                                    "virtualNetworkResourceGroupName": {
                                      "type": "string"
                                    },
                                    "virtualNetworkSubscriptionId": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "copy": {
                                        "name": "virtualNetworkLinks",
                                        "count": "[length(parameters('privateDnsZoneNames'))]"
                                      },
                                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                                      "apiVersion": "2018-09-01",
                                      "name": "[format('{0}/{1}', parameters('privateDnsZoneNames')[copyIndex()], parameters('virtualNetworkName'))]",
                                      "location": "global",
                                      "properties": {
                                        "registrationEnabled": false,
                                        "virtualNetwork": {
                                          "id": "[resourceId(parameters('virtualNetworkSubscriptionId'), parameters('virtualNetworkResourceGroupName'), 'Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]"
                                        }
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "privateDnsZones"
                              ]
                            }
                          ],
                          "outputs": {
                            "privateDnsZoneResourceIds": {
                              "type": "array",
                              "copy": {
                                "count": "[length(parameters('privateDnsZoneNames'))]",
                                "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-pvt-dns-zone-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                              }
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix')))]",
                        "spokeNetworks"
                      ]
                    }
                  ],
                  "outputs": {
                    "azureFirewallResourceId": {
                      "type": "string",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.firewallResourceId.value]"
                    },
                    "bastionHostSubnetResourceId": {
                      "type": "string",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.bastionHostSubnetResourceId.value]"
                    },
                    "delimiter": {
                      "type": "string",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                    },
                    "firewallPolicyResourceId": {
                      "type": "string",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.firewallPolicyResourceId.value]"
                    },
                    "hubVirtualNetworkResourceId": {
                      "type": "string",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkResourceId.value]"
                    },
                    "locationProperties": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.locationProperties.value]"
                    },
                    "mlzTags": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                    },
                    "privateDnsZoneResourceIds": {
                      "type": "object",
                      "value": {
                        "agentSvc": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'privatelink.agentsvc')))[0]]",
                        "blob": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'blob')))[0]]",
                        "file": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'file')))[0]]",
                        "keyVault": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'vaultcore')))[0]]",
                        "monitor": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'monitor')))[0]]",
                        "ods": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'ods.opinsights')))[0]]",
                        "oms": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'oms.opinsights')))[0]]",
                        "queue": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'queue')))[0]]",
                        "table": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'table')))[0]]"
                      }
                    },
                    "resourceAbbreviations": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
                    },
                    "sharedServicesSubnetResourceId": {
                      "type": "string",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[1].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkSecurityGroupResourceId.value]"
                    },
                    "tiers": {
                      "type": "array",
                      "copy": {
                        "count": "[length(parameters('networks'))]",
                        "input": {
                          "name": "[parameters('networks')[copyIndex()].name]",
                          "namingConvention": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value[copyIndex()].namingConvention]",
                          "networkSecurityGroupResourceId": "[union(createArray(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkSecurityGroupResourceId.value, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[0].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkSecurityGroupResourceId.value, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[1].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkSecurityGroupResourceId.value), if(parameters('deployIdentity'), createArray(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[2].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkSecurityGroupResourceId.value), createArray()))[copyIndex()]]",
                          "nsgDiagLogs": "[parameters('networks')[copyIndex()].nsgDiagLogs]",
                          "resourceGroupName": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value, lambda('name', contains(lambdaVariables('name'), parameters('networks')[copyIndex()].name)))[0]]",
                          "shortName": "[parameters('networks')[copyIndex()].shortName]",
                          "subnetResourceId": "[union(createArray(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnetResourceId.value, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[0].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[0].id, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[1].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[0].id), if(parameters('deployIdentity'), createArray(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[2].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[0].id), createArray()))[copyIndex()]]",
                          "subscriptionId": "[parameters('networks')[copyIndex()].subscriptionId]",
                          "vnetDiagLogs": "[parameters('networks')[copyIndex()].vnetDiagLogs]",
                          "vnetDiagMetrics": "[parameters('networks')[copyIndex()].vnetDiagMetrics]"
                        }
                      }
                    },
                    "tokens": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('operationsSubscriptionId')]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "delimiter": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "deploySentinel": {
                    "value": "[parameters('deploySentinel')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "logAnalyticsWorkspaceCappingDailyQuotaGb": {
                    "value": "[parameters('logAnalyticsWorkspaceCappingDailyQuotaGb')]"
                  },
                  "logAnalyticsWorkspaceRetentionInDays": {
                    "value": "[parameters('logAnalyticsWorkspaceRetentionInDays')]"
                  },
                  "logAnalyticsWorkspaceSkuName": {
                    "value": "[parameters('logAnalyticsWorkspaceSkuName')]"
                  },
                  "privateDnsZoneResourceIds": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value]"
                  },
                  "mlzTags": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tier": {
                    "value": "[filter(reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value, lambda('tier', equals(lambdaVariables('tier').name, 'operations')))[0]]"
                  },
                  "tokens": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "2237093856272213231"
                    }
                  },
                  "parameters": {
                    "delimiter": {
                      "type": "string"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "deploySentinel": {
                      "type": "bool"
                    },
                    "location": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceCappingDailyQuotaGb": {
                      "type": "int"
                    },
                    "logAnalyticsWorkspaceRetentionInDays": {
                      "type": "int"
                    },
                    "logAnalyticsWorkspaceSkuName": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "privateDnsZoneResourceIds": {
                      "type": "object"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "tier": {
                      "type": "object"
                    },
                    "tokens": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-law-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('tier').resourceGroupName]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploySentinel": {
                            "value": "[parameters('deploySentinel')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[replace(parameters('tier').namingConvention.logAnalyticsWorkspace, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "retentionInDays": {
                            "value": "[parameters('logAnalyticsWorkspaceRetentionInDays')]"
                          },
                          "skuName": {
                            "value": "[parameters('logAnalyticsWorkspaceSkuName')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "workspaceCappingDailyQuotaGb": {
                            "value": "[parameters('logAnalyticsWorkspaceCappingDailyQuotaGb')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "12632340435482569543"
                            }
                          },
                          "parameters": {
                            "deploySentinel": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "retentionInDays": {
                              "type": "int",
                              "defaultValue": 30
                            },
                            "skuName": {
                              "type": "string",
                              "defaultValue": "PerGB2018"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "workspaceCappingDailyQuotaGb": {
                              "type": "int",
                              "defaultValue": -1
                            }
                          },
                          "variables": {
                            "solutions": [
                              {
                                "deploy": true,
                                "name": "AzureActivity",
                                "product": "OMSGallery/AzureActivity",
                                "publisher": "Microsoft",
                                "promotionCode": ""
                              },
                              {
                                "deploy": "[parameters('deploySentinel')]",
                                "name": "SecurityInsights",
                                "product": "OMSGallery/SecurityInsights",
                                "publisher": "Microsoft",
                                "promotionCode": ""
                              },
                              {
                                "deploy": true,
                                "name": "VMInsights",
                                "product": "OMSGallery/VMInsights",
                                "publisher": "Microsoft",
                                "promotionCode": ""
                              },
                              {
                                "deploy": true,
                                "name": "Security",
                                "product": "OMSGallery/Security",
                                "publisher": "Microsoft",
                                "promotionCode": ""
                              },
                              {
                                "deploy": true,
                                "name": "ServiceMap",
                                "publisher": "Microsoft",
                                "product": "OMSGallery/ServiceMap",
                                "promotionCode": ""
                              },
                              {
                                "deploy": true,
                                "name": "ContainerInsights",
                                "publisher": "Microsoft",
                                "product": "OMSGallery/ContainerInsights",
                                "promotionCode": ""
                              },
                              {
                                "deploy": true,
                                "name": "KeyVaultAnalytics",
                                "publisher": "Microsoft",
                                "product": "OMSGallery/KeyVaultAnalytics",
                                "promotionCode": ""
                              }
                            ]
                          },
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/workspaces",
                              "apiVersion": "2021-06-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.OperationalInsights/workspaces'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "retentionInDays": "[if(and(parameters('deploySentinel'), less(parameters('retentionInDays'), 90)), 90, parameters('retentionInDays'))]",
                                "sku": {
                                  "name": "[parameters('skuName')]"
                                },
                                "workspaceCapping": {
                                  "dailyQuotaGb": "[parameters('workspaceCappingDailyQuotaGb')]"
                                },
                                "publicNetworkAccessForIngestion": "Enabled",
                                "publicNetworkAccessForQuery": "Enabled"
                              }
                            },
                            {
                              "copy": {
                                "name": "logAnalyticsSolutions",
                                "count": "[length(variables('solutions'))]"
                              },
                              "condition": "[variables('solutions')[copyIndex()].deploy]",
                              "type": "Microsoft.OperationsManagement/solutions",
                              "apiVersion": "2015-11-01-preview",
                              "name": "[format('{0}({1})', variables('solutions')[copyIndex()].name, parameters('name'))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.OperationsManagement/solutions'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
                              },
                              "plan": {
                                "name": "[format('{0}({1})', variables('solutions')[copyIndex()].name, parameters('name'))]",
                                "product": "[variables('solutions')[copyIndex()].product]",
                                "publisher": "[variables('solutions')[copyIndex()].publisher]",
                                "promotionCode": "[variables('solutions')[copyIndex()].promotionCode]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
                              ]
                            },
                            {
                              "condition": "[parameters('deploySentinel')]",
                              "type": "Microsoft.SecurityInsights/onboardingStates",
                              "apiVersion": "2024-03-01",
                              "scope": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]",
                              "name": "default",
                              "properties": {},
                              "dependsOn": [
                                "logAnalyticsSolutions",
                                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-private-link-scope-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('tier').resourceGroupName]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('tier').resourceGroupName), 'Microsoft.Resources/deployments', format('deploy-law-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                          },
                          "name": {
                            "value": "[replace(parameters('tier').namingConvention.privateLinkScope, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "2156095459720872653"
                            }
                          },
                          "parameters": {
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Insights/privateLinkScopes",
                              "apiVersion": "2021-09-01",
                              "name": "[parameters('name')]",
                              "location": "global",
                              "properties": {
                                "accessModeSettings": {
                                  "ingestionAccessMode": "PrivateOnly",
                                  "queryAccessMode": "PrivateOnly"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Insights/privateLinkScopes/scopedResources",
                              "apiVersion": "2021-09-01",
                              "name": "[format('{0}/{1}', parameters('name'), split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])]",
                              "properties": {
                                "linkedResourceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Insights/privateLinkScopes', parameters('name'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Insights/privateLinkScopes', parameters('name'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('tier').resourceGroupName), 'Microsoft.Resources/deployments', format('deploy-law-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-private-endpoint-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('tier').resourceGroupName]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "groupIds": {
                            "value": [
                              "azuremonitor"
                            ]
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[replace(parameters('tier').namingConvention.privateLinkScopePrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "networkInterfaceName": {
                            "value": "[replace(parameters('tier').namingConvention.privateLinkScopeNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "privateDnsZoneConfigs": {
                            "value": [
                              {
                                "name": "monitor",
                                "properties": {
                                  "privateDnsZoneId": "[parameters('privateDnsZoneResourceIds').monitor]"
                                }
                              },
                              {
                                "name": "oms",
                                "properties": {
                                  "privateDnsZoneId": "[parameters('privateDnsZoneResourceIds').oms]"
                                }
                              },
                              {
                                "name": "ods",
                                "properties": {
                                  "privateDnsZoneId": "[parameters('privateDnsZoneResourceIds').ods]"
                                }
                              },
                              {
                                "name": "agentsvc",
                                "properties": {
                                  "privateDnsZoneId": "[parameters('privateDnsZoneResourceIds').agentsvc]"
                                }
                              },
                              {
                                "name": "blob",
                                "properties": {
                                  "privateDnsZoneId": "[parameters('privateDnsZoneResourceIds').blob]"
                                }
                              }
                            ]
                          },
                          "privateLinkServiceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('tier').resourceGroupName), 'Microsoft.Resources/deployments', format('deploy-private-link-scope-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                          },
                          "subnetResourceId": {
                            "value": "[parameters('tier').subnetResourceId]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "99300237379447044"
                            }
                          },
                          "parameters": {
                            "groupIds": {
                              "type": "array"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "networkInterfaceName": {
                              "type": "string"
                            },
                            "privateDnsZoneConfigs": {
                              "type": "array"
                            },
                            "privateLinkServiceId": {
                              "type": "string"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateEndpoints",
                              "apiVersion": "2023-04-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "customNetworkInterfaceName": "[parameters('networkInterfaceName')]",
                                "privateLinkServiceConnections": [
                                  {
                                    "name": "[parameters('name')]",
                                    "properties": {
                                      "privateLinkServiceId": "[parameters('privateLinkServiceId')]",
                                      "groupIds": "[parameters('groupIds')]"
                                    }
                                  }
                                ],
                                "subnet": {
                                  "id": "[parameters('subnetResourceId')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2023-04-01",
                              "name": "[format('{0}/{1}', parameters('name'), parameters('name'))]",
                              "properties": {
                                "privateDnsZoneConfigs": "[parameters('privateDnsZoneConfigs')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "networkInterfaceResourceId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', parameters('name')), '2023-04-01').networkInterfaces[0].id]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('tier').resourceGroupName), 'Microsoft.Resources/deployments', format('deploy-private-link-scope-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('tier').resourceGroupName), 'Microsoft.Resources/deployments', format('deploy-law-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                    },
                    "networkInterfaceResourceIds": {
                      "type": "array",
                      "value": [
                        "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('tier').resourceGroupName), 'Microsoft.Resources/deployments', format('deploy-private-endpoint-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value]"
                      ]
                    },
                    "privateLinkScopeResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('tier').resourceGroupName), 'Microsoft.Resources/deployments', format('deploy-private-link-scope-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "condition": "[and(parameters('deployActiveDirectoryDomainServices'), parameters('deployIdentity'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-adds-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('identitySubscriptionId')]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "adminPassword": {
                    "value": "[parameters('addsAdministratorPassword')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('addsAdministratorUsername')]"
                  },
                  "delimiter": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "domainName": {
                    "value": "[parameters('addsDomainName')]"
                  },
                  "environmentAbbreviation": {
                    "value": "[parameters('environmentAbbreviation')]"
                  },
                  "firewallPolicyResourceId": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.firewallPolicyResourceId.value]"
                  },
                  "hybridUseBenefit": {
                    "value": "[parameters('hybridUseBenefit')]"
                  },
                  "imageOffer": {
                    "value": "WindowsServer"
                  },
                  "imagePublisher": {
                    "value": "MicrosoftWindowsServer"
                  },
                  "imageSku": {
                    "value": "[parameters('addsVmImageSku')]"
                  },
                  "imageVersion": {
                    "value": "[parameters('windowsVmImageVersion')]"
                  },
                  "ipAddresses": {
                    "value": [
                      "[cidrHost(parameters('identitySubnetAddressPrefix'), 5)]",
                      "[cidrHost(parameters('identitySubnetAddressPrefix'), 6)]"
                    ]
                  },
                  "keyVaultPrivateDnsZoneResourceId": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value.keyVault]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                  },
                  "resourceAbbreviations": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
                  },
                  "safeModeAdminPassword": {
                    "value": "[parameters('addsSafeModeAdminPassword')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tiers": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value]"
                  },
                  "tokens": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                  },
                  "vmSize": {
                    "value": "[parameters('addsVmSize')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "5646280027549206717"
                    }
                  },
                  "parameters": {
                    "adminPassword": {
                      "type": "securestring"
                    },
                    "adminUsername": {
                      "type": "string"
                    },
                    "delimiter": {
                      "type": "string"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "dnsForwarder": {
                      "type": "string",
                      "defaultValue": "168.63.129.16"
                    },
                    "domainName": {
                      "type": "string"
                    },
                    "environmentAbbreviation": {
                      "type": "string"
                    },
                    "firewallPolicyResourceId": {
                      "type": "string"
                    },
                    "hybridUseBenefit": {
                      "type": "bool"
                    },
                    "imageOffer": {
                      "type": "string"
                    },
                    "imagePublisher": {
                      "type": "string"
                    },
                    "imageSku": {
                      "type": "string"
                    },
                    "imageVersion": {
                      "type": "string"
                    },
                    "ipAddresses": {
                      "type": "array"
                    },
                    "keyVaultPrivateDnsZoneResourceId": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[deployment().location]"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "resourceAbbreviations": {
                      "type": "object"
                    },
                    "safeModeAdminPassword": {
                      "type": "securestring"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "tiers": {
                      "type": "array"
                    },
                    "tokens": {
                      "type": "object"
                    },
                    "vmCount": {
                      "type": "int",
                      "defaultValue": 2
                    },
                    "vmSize": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "identityTier": "[filter(parameters('tiers'), lambda('tier', equals(lambdaVariables('tier').name, 'identity')))[0]]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/resourceGroups",
                      "apiVersion": "2019-05-01",
                      "name": "[replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Resources/resourceGroups'), createObject()), parameters('mlzTags'))]"
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-adds-cmk-{0}', parameters('deploymentNameSuffix'))]",
                      "resourceGroup": "[replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "environmentAbbreviation": {
                            "value": "[parameters('environmentAbbreviation')]"
                          },
                          "keyName": {
                            "value": "[replace(variables('identityTier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, 'cmk')]"
                          },
                          "keyVaultPrivateDnsZoneResourceId": {
                            "value": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "resourceAbbreviations": {
                            "value": "[parameters('resourceAbbreviations')]"
                          },
                          "subnetResourceId": {
                            "value": "[variables('identityTier').subnetResourceId]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "tier": {
                            "value": "[variables('identityTier')]"
                          },
                          "tokens": {
                            "value": "[parameters('tokens')]"
                          },
                          "type": {
                            "value": "virtualMachine"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "16154764937040063236"
                            }
                          },
                          "parameters": {
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "environmentAbbreviation": {
                              "type": "string"
                            },
                            "keyExpirationInDays": {
                              "type": "int",
                              "defaultValue": 30
                            },
                            "keyName": {
                              "type": "string"
                            },
                            "keyVaultPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "resourceAbbreviations": {
                              "type": "object"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "tier": {
                              "type": "object"
                            },
                            "tokens": {
                              "type": "object"
                            },
                            "type": {
                              "type": "string",
                              "allowedValues": [
                                "storageAccount",
                                "virtualMachine"
                              ]
                            },
                            "virtualMachineAdminPassword": {
                              "type": "securestring",
                              "defaultValue": "[newGuid()]"
                            },
                            "virtualMachineAdminUsername": {
                              "type": "string",
                              "defaultValue": "xadmin"
                            },
                            "virtualMachineSize": {
                              "type": "string",
                              "defaultValue": "Standard_D2ds_v4"
                            }
                          },
                          "variables": {
                            "$fxv#0": "Param(\r\n    [string]$DiskEncryptionSetName,\r\n    [int]$KeyExpirationInDays,\r\n    [string]$KeyName,\r\n    [string]$KeyVaultResourceId,\r\n    [string]$KeyVaultServiceUri,\r\n    [string]$KeyVaultUri,\r\n    [string]$Location,\r\n    [string]$ResourceGroupName,\r\n    [string]$ResourceManagerUri,\r\n    [string]$SubscriptionId,\r\n    [string]$Type,\r\n    [string]$UserAssignedIdentityClientId\r\n)\r\n\r\n$ErrorActionPreference = 'Stop'\r\n$WarningPreference = 'SilentlyContinue'\r\n\r\n# Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n$ResourceManagerUriFixed = if ($ResourceManagerUri[-1] -eq '/') { $ResourceManagerUri.Substring(0, $ResourceManagerUri.Length - 1) } else { $ResourceManagerUri }\r\n\r\n# Get an access token for Azure resources\r\n$KeyVaultAccessToken = (Invoke-RestMethod `\r\n        -Headers @{Metadata = \"true\" } `\r\n        -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $KeyVaultServiceUri + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n# Set header for Azure Management API\r\n$KeyVaultHeaders = @{\r\n    'Content-Type'  = 'application/json'\r\n    'Authorization' = 'Bearer ' + $KeyVaultAccessToken\r\n}\r\n\r\n$Body = [PSCustomObject]@{\r\n    kty            = 'RSA-HSM'\r\n    key_size       = 4096\r\n    attributes     = @{\r\n        enabled = $true\r\n    }\r\n    rotationPolicy = @{\r\n        attributes      = @{\r\n            expiryTime = $('P' + $KeyExpirationInDays + 'D')\r\n        }\r\n        lifetimeActions = @(\r\n            @{\r\n                action  = @{\r\n                    type = 'Notify'\r\n                }\r\n                trigger = @{\r\n                    timeBeforeExpiry = 'P10D'\r\n                }\r\n            },\r\n            @{\r\n                action  = @{\r\n                    type = 'Rotate'\r\n                }\r\n                trigger = @{\r\n                    timeAfterCreate = $('P' + ($KeyExpirationInDays - 7) + 'D')\r\n                }\r\n            }\r\n        )\r\n    }\r\n}\r\n\r\n# Create key vault key\r\n$KeyUriWithVersion = (Invoke-RestMethod `\r\n        -Body ($Body | ConvertTo-Json -Depth 4) `\r\n        -Headers $KeyVaultHeaders `\r\n        -Method 'POST' `\r\n        -Uri $($KeyVaultUri + 'keys/' + $KeyName + '/create?api-version=2025-07-01')).key.kid\r\n\r\nif ($Type -eq 'virtualMachine') {\r\n\r\n    # Get an access token for Azure resources\r\n    $ResourceManagerAccessToken = (Invoke-RestMethod `\r\n            -Headers @{Metadata = \"true\" } `\r\n            -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n    # Set header for Azure Management API\r\n    $ResourceManagerHeaders = @{\r\n        'Content-Type'  = 'application/json'\r\n        'Authorization' = 'Bearer ' + $ResourceManagerAccessToken\r\n    }\r\n\r\n    $DiskEncryptionSetBody = @{\r\n        location   = $Location\r\n        identity   = @{\r\n            type = 'SystemAssigned'\r\n        }\r\n        properties = @{\r\n            activeKey                         = @{\r\n                sourceVault = @{\r\n                    id = $KeyVaultResourceId\r\n                }\r\n                keyUrl = $KeyUriWithVersion\r\n            }\r\n            encryptionType                    = 'EncryptionAtRestWithPlatformAndCustomerKeys'\r\n            rotationToLatestKeyVersionEnabled = $true\r\n        }\r\n    }\r\n\r\n    Invoke-RestMethod `\r\n        -Body ($DiskEncryptionSetBody | ConvertTo-Json -Depth 4) `\r\n        -Headers $ResourceManagerHeaders `\r\n        -Method 'PUT' `\r\n        -Uri $($ResourceManagerUriFixed + '/subscriptions/' + $SubscriptionId + '/resourceGroups/' + $ResourceGroupName + '/providers/Microsoft.Compute/diskEncryptionSets/' + $DiskEncryptionSetName + '?api-version=2025-01-02')\r\n}",
                            "$fxv#1": "param(\r\n    [string]$ResourceGroupName,\r\n    [string]$ResourceManagerUri,\r\n    [string]$UserAssignedIdentityClientId,\r\n    [string]$VirtualMachineResourceId\r\n)\r\n\r\n# Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n$ResourceManagerUriFixed = if($ResourceManagerUri[-1] -eq '/'){$ResourceManagerUri.Substring(0,$ResourceManagerUri.Length - 1)} else {$ResourceManagerUri}\r\n\r\n# Get an access token for Azure resources\r\n$AzureManagementAccessToken = (Invoke-RestMethod `\r\n    -Headers @{Metadata=\"true\"} `\r\n    -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n# Set header for Azure Management API\r\n$AzureManagementHeader = @{\r\n    'Content-Type'='application/json'\r\n    'Authorization'='Bearer ' + $AzureManagementAccessToken\r\n}\r\n\r\nStart-Sleep -Seconds 30\r\n\r\n# Use the access token to delete the virtual machine\r\nInvoke-RestMethod `\r\n    -Headers $AzureManagementHeader `\r\n    -Method 'Delete' `\r\n    -Uri $($ResourceManagerUriFixed + $VirtualMachineResourceId + '?forceDeletion=true&api-version=2024-07-01') | Out-Null",
                            "keyVaultPrivateEndpointName": "[replace(parameters('tier').namingConvention.keyVaultPrivateEndpoint, parameters('tokens').purpose, variables('workload'))]",
                            "resourceGroupName": "[resourceGroup().name]",
                            "userAssignedIdentityName": "[replace(parameters('tier').namingConvention.userAssignedIdentity, parameters('tokens').purpose, variables('workload'))]",
                            "virtualMachineName": "[replace(parameters('tier').namingConvention.virtualMachine, parameters('tokens').purpose, variables('workload'))]",
                            "workload": "cmk"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                              "apiVersion": "2018-11-30",
                              "name": "[variables('userAssignedIdentityName')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]"
                            },
                            {
                              "type": "Microsoft.Network/networkInterfaces",
                              "apiVersion": "2020-05-01",
                              "name": "[replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "ipConfigurations": [
                                  {
                                    "name": "ipconfig",
                                    "properties": {
                                      "privateIPAllocationMethod": "Dynamic",
                                      "subnet": {
                                        "id": "[parameters('subnetResourceId')]"
                                      },
                                      "primary": true,
                                      "privateIPAddressVersion": "IPv4"
                                    }
                                  }
                                ],
                                "enableAcceleratedNetworking": false,
                                "enableIPForwarding": false
                              }
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2021-11-01",
                              "name": "[variables('virtualMachineName')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "hardwareProfile": {
                                  "vmSize": "[parameters('virtualMachineSize')]"
                                },
                                "storageProfile": {
                                  "imageReference": {
                                    "publisher": "MicrosoftWindowsServer",
                                    "offer": "WindowsServer",
                                    "sku": "2022-datacenter-core-g2",
                                    "version": "latest"
                                  },
                                  "osDisk": {
                                    "deleteOption": "Delete",
                                    "osType": "Windows",
                                    "createOption": "FromImage",
                                    "caching": "None",
                                    "managedDisk": {
                                      "storageAccountType": "Premium_LRS"
                                    },
                                    "name": "[replace(parameters('tier').namingConvention.virtualMachineDisk, parameters('tokens').purpose, variables('workload'))]"
                                  },
                                  "dataDisks": []
                                },
                                "osProfile": {
                                  "adminPassword": "[parameters('virtualMachineAdminPassword')]",
                                  "adminUsername": "[parameters('virtualMachineAdminUsername')]",
                                  "computerName": "[variables('virtualMachineName')]",
                                  "windowsConfiguration": {
                                    "provisionVMAgent": true,
                                    "enableAutomaticUpdates": false
                                  },
                                  "secrets": [],
                                  "allowExtensionOperations": true
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk'))]",
                                      "properties": {
                                        "deleteOption": "Delete"
                                      }
                                    }
                                  ]
                                },
                                "securityProfile": {
                                  "uefiSettings": {
                                    "secureBootEnabled": true,
                                    "vTpmEnabled": true
                                  },
                                  "securityType": "TrustedLaunch",
                                  "encryptionAtHost": true
                                },
                                "diagnosticsProfile": {
                                  "bootDiagnostics": {
                                    "enabled": false
                                  }
                                },
                                "licenseType": "Windows_Server"
                              },
                              "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')))]": {}
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk'))]",
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '136d308c-0937-4a49-9bd7-edfb42adbffc', resourceGroup().id)]",
                              "properties": {
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '136d308c-0937-4a49-9bd7-edfb42adbffc')]",
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "scope": "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]",
                              "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '9980e02c-c2be-4d73-94e8-173b1dc7cf3c', resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName')))]",
                              "properties": {
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '9980e02c-c2be-4d73-94e8-173b1dc7cf3c')]",
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.KeyVault/vaults",
                              "apiVersion": "2022-07-01",
                              "name": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "enabledForDeployment": false,
                                "enabledForDiskEncryption": false,
                                "enabledForTemplateDeployment": false,
                                "enablePurgeProtection": true,
                                "enableRbacAuthorization": true,
                                "enableSoftDelete": true,
                                "networkAcls": {
                                  "bypass": "AzureServices",
                                  "defaultAction": "Deny",
                                  "ipRules": [],
                                  "virtualNetworkRules": []
                                },
                                "publicNetworkAccess": "Disabled",
                                "sku": {
                                  "family": "A",
                                  "name": "premium"
                                },
                                "softDeleteRetentionInDays": "[if(or(equals(parameters('environmentAbbreviation'), 'dev'), equals(parameters('environmentAbbreviation'), 'test')), 7, 90)]",
                                "tenantId": "[subscription().tenantId]"
                              }
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "scope": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                              "name": "[guid(variables('userAssignedIdentityName'), '00482a5a-887f-4fb3-b363-3b7fe8e74483', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))))]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "scope": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                              "name": "[guid(variables('userAssignedIdentityName'), 'f25e0fa2-a7c8-4377-a976-54943a77a395', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))))]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'f25e0fa2-a7c8-4377-a976-54943a77a395')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('type'), 'storageAccount')]",
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[guid(variables('userAssignedIdentityName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceGroup().id)]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints",
                              "apiVersion": "2023-04-01",
                              "name": "[variables('keyVaultPrivateEndpointName')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "customNetworkInterfaceName": "[replace(parameters('tier').namingConvention.keyVaultNetworkInterface, parameters('tokens').purpose, variables('workload'))]",
                                "privateLinkServiceConnections": [
                                  {
                                    "name": "[variables('keyVaultPrivateEndpointName')]",
                                    "properties": {
                                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                      "groupIds": [
                                        "vault"
                                      ]
                                    }
                                  }
                                ],
                                "subnet": {
                                  "id": "[parameters('subnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '136d308c-0937-4a49-9bd7-edfb42adbffc', resourceGroup().id))]",
                                "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), 'Microsoft.Authorization/roleAssignments', guid(variables('userAssignedIdentityName'), '00482a5a-887f-4fb3-b363-3b7fe8e74483', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))))]",
                                "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), 'Microsoft.Authorization/roleAssignments', guid(variables('userAssignedIdentityName'), 'f25e0fa2-a7c8-4377-a976-54943a77a395', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))))]",
                                "[extensionResourceId(resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '9980e02c-c2be-4d73-94e8-173b1dc7cf3c', resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2021-08-01",
                              "name": "[format('{0}/{1}', variables('keyVaultPrivateEndpointName'), format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                              "properties": {
                                "privateDnsZoneConfigs": [
                                  {
                                    "name": "ipconfig1",
                                    "properties": {
                                      "privateDnsZoneId": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                                    }
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2025-04-01",
                              "name": "[format('{0}/{1}', variables('virtualMachineName'), parameters('keyName'))]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "asyncExecution": false,
                                "parameters": [
                                  {
                                    "name": "DiskEncryptionSetName",
                                    "value": "[replace(parameters('tier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, variables('workload'))]"
                                  },
                                  {
                                    "name": "KeyExpirationInDays",
                                    "value": "[string(parameters('keyExpirationInDays'))]"
                                  },
                                  {
                                    "name": "KeyName",
                                    "value": "[parameters('keyName')]"
                                  },
                                  {
                                    "name": "KeyVaultResourceId",
                                    "value": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                  },
                                  {
                                    "name": "KeyVaultServiceUri",
                                    "value": "[format('https://{0}', skip(environment().suffixes.keyvaultDns, 1))]"
                                  },
                                  {
                                    "name": "KeyVaultUri",
                                    "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), '2022-07-01').vaultUri]"
                                  },
                                  {
                                    "name": "Location",
                                    "value": "[parameters('location')]"
                                  },
                                  {
                                    "name": "ResourceGroupName",
                                    "value": "[variables('resourceGroupName')]"
                                  },
                                  {
                                    "name": "ResourceManagerUri",
                                    "value": "[environment().resourceManager]"
                                  },
                                  {
                                    "name": "SubscriptionId",
                                    "value": "[parameters('tier').subscriptionId]"
                                  },
                                  {
                                    "name": "Type",
                                    "value": "[parameters('type')]"
                                  },
                                  {
                                    "name": "UserAssignedIdentityClientId",
                                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').clientId]"
                                  }
                                ],
                                "source": {
                                  "script": "[variables('$fxv#0')]"
                                },
                                "treatFailureAsDeploymentFailure": true
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', variables('keyVaultPrivateEndpointName'), format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                "[resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName'))]",
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2023-09-01",
                              "name": "[format('{0}/{1}', variables('virtualMachineName'), format('delete-vm-{0}', parameters('deploymentNameSuffix')))]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "asyncExecution": true,
                                "parameters": [
                                  {
                                    "name": "ResourceGroupName",
                                    "value": "[variables('resourceGroupName')]"
                                  },
                                  {
                                    "name": "ResourceManagerUri",
                                    "value": "[environment().resourceManager]"
                                  },
                                  {
                                    "name": "UserAssignedIdentityClientId",
                                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').clientId]"
                                  },
                                  {
                                    "name": "VirtualMachineResourceId",
                                    "value": "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                                  }
                                ],
                                "source": {
                                  "script": "[variables('$fxv#1')]"
                                },
                                "treatFailureAsDeploymentFailure": true
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Resources/deployments', format('deploy-des-{0}', parameters('deploymentNameSuffix')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', variables('virtualMachineName'), parameters('keyName'))]",
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('type'), 'virtualMachine')]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-des-{0}', parameters('deploymentNameSuffix'))]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "diskEncryptionSetName": {
                                    "value": "[replace(parameters('tier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, variables('workload'))]"
                                  },
                                  "keyVaultName": {
                                    "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "15118251701077090282"
                                    }
                                  },
                                  "parameters": {
                                    "diskEncryptionSetName": {
                                      "type": "string"
                                    },
                                    "keyVaultName": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "scope": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                                      "name": "[guid(parameters('diskEncryptionSetName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')))]",
                                      "properties": {
                                        "principalId": "[reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName')), '2023-04-02', 'full').identity.principalId]",
                                        "principalType": "ServicePrincipal",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "resourceId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName'))]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', variables('virtualMachineName'), parameters('keyName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "diskEncryptionSetResourceId": {
                              "type": "string",
                              "value": "[if(equals(parameters('type'), 'virtualMachine'), reference(resourceId('Microsoft.Resources/deployments', format('deploy-des-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value, '')]"
                            },
                            "keyVaultProperties": {
                              "type": "object",
                              "value": {
                                "diagnosticSettingName": "[replace(parameters('tier').namingConvention.keyVaultDiagnosticSetting, parameters('tokens').purpose, variables('workload'))]",
                                "name": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]",
                                "resourceGroupName": "[variables('resourceGroupName')]",
                                "subscriptionId": "[parameters('tier').subscriptionId]",
                                "tierName": "[parameters('tier').name]"
                              }
                            },
                            "keyName": {
                              "type": "string",
                              "value": "[parameters('keyName')]"
                            },
                            "keyVaultName": {
                              "type": "string",
                              "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]"
                            },
                            "keyVaultUri": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), '2022-07-01').vaultUri]"
                            },
                            "keyVaultResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                            },
                            "keyVaultNetworkInterfaceResourceId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName')), '2023-04-01').networkInterfaces[0].id]"
                            },
                            "userAssignedIdentityResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('update-fw-policy-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[split(parameters('firewallPolicyResourceId'), '/')[2]]",
                      "resourceGroup": "[split(parameters('firewallPolicyResourceId'), '/')[4]]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "dnsServers": {
                            "value": "[parameters('ipAddresses')]"
                          },
                          "enableProxy": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('firewallPolicyResourceId'), '/')[2], split(parameters('firewallPolicyResourceId'), '/')[4]), 'Microsoft.Network/firewallPolicies', split(parameters('firewallPolicyResourceId'), '/')[8]), '2021-02-01').dnsSettings.enableProxy]"
                          },
                          "intrusionDetectionMode": {
                            "value": "[coalesce(tryGet(tryGet(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('firewallPolicyResourceId'), '/')[2], split(parameters('firewallPolicyResourceId'), '/')[4]), 'Microsoft.Network/firewallPolicies', split(parameters('firewallPolicyResourceId'), '/')[8]), '2021-02-01'), 'intrusionDetection'), 'mode'), '')]"
                          },
                          "location": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('firewallPolicyResourceId'), '/')[2], split(parameters('firewallPolicyResourceId'), '/')[4]), 'Microsoft.Network/firewallPolicies', split(parameters('firewallPolicyResourceId'), '/')[8]), '2021-02-01', 'full').location]"
                          },
                          "name": {
                            "value": "[split(parameters('firewallPolicyResourceId'), '/')[8]]"
                          },
                          "skuTier": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('firewallPolicyResourceId'), '/')[2], split(parameters('firewallPolicyResourceId'), '/')[4]), 'Microsoft.Network/firewallPolicies', split(parameters('firewallPolicyResourceId'), '/')[8]), '2021-02-01').sku.tier]"
                          },
                          "tags": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('firewallPolicyResourceId'), '/')[2], split(parameters('firewallPolicyResourceId'), '/')[4]), 'Microsoft.Network/firewallPolicies', split(parameters('firewallPolicyResourceId'), '/')[8]), '2021-02-01', 'full').tags]"
                          },
                          "threatIntelMode": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('firewallPolicyResourceId'), '/')[2], split(parameters('firewallPolicyResourceId'), '/')[4]), 'Microsoft.Network/firewallPolicies', split(parameters('firewallPolicyResourceId'), '/')[8]), '2021-02-01').threatIntelMode]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "6864380443214305992"
                            }
                          },
                          "parameters": {
                            "dnsServers": {
                              "type": "array"
                            },
                            "enableProxy": {
                              "type": "bool"
                            },
                            "intrusionDetectionMode": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            },
                            "skuTier": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "threatIntelMode": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/firewallPolicies",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "threatIntelMode": "[parameters('threatIntelMode')]",
                                "intrusionDetection": "[if(and(equals(parameters('skuTier'), 'Premium'), not(empty(parameters('intrusionDetectionMode')))), createObject('mode', parameters('intrusionDetectionMode')), null())]",
                                "sku": {
                                  "tier": "[parameters('skuTier')]"
                                },
                                "dnsSettings": {
                                  "enableProxy": "[parameters('enableProxy')]",
                                  "servers": "[parameters('dnsServers')]"
                                }
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')), 'Microsoft.Resources/deployments', format('deploy-adds-cmk-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-adds-availability-set-{0}', parameters('deploymentNameSuffix'))]",
                      "resourceGroup": "[replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "availabilitySetName": {
                            "value": "[replace(variables('identityTier').namingConvention.availabilitySet, parameters('tokens').purpose, 'domainControllers')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "12028712112245773357"
                            }
                          },
                          "parameters": {
                            "availabilitySetName": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Compute/availabilitySets",
                              "apiVersion": "2019-07-01",
                              "name": "[parameters('availabilitySetName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/availabilitySets'), createObject()), parameters('mlzTags'))]",
                              "sku": {
                                "name": "Aligned"
                              },
                              "properties": {
                                "platformUpdateDomainCount": 5,
                                "platformFaultDomainCount": 2
                              }
                            }
                          ],
                          "outputs": {
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Compute/availabilitySets', parameters('availabilitySetName'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers'))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "domainControllers",
                        "count": "[length(range(0, parameters('vmCount')))]",
                        "mode": "serial",
                        "batchSize": 1
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-adds-dc-{0}-{1}', range(0, parameters('vmCount'))[copyIndex()], parameters('deploymentNameSuffix'))]",
                      "resourceGroup": "[replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "adminPassword": {
                            "value": "[parameters('adminPassword')]"
                          },
                          "adminUsername": {
                            "value": "[parameters('adminUsername')]"
                          },
                          "availabilitySetResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')), 'Microsoft.Resources/deployments', format('deploy-adds-availability-set-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                          },
                          "delimiter": {
                            "value": "[parameters('delimiter')]"
                          },
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "diskEncryptionSetResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')), 'Microsoft.Resources/deployments', format('deploy-adds-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.diskEncryptionSetResourceId.value]"
                          },
                          "dnsForwarder": {
                            "value": "[parameters('dnsForwarder')]"
                          },
                          "domainName": {
                            "value": "[parameters('domainName')]"
                          },
                          "hybridUseBenefit": {
                            "value": "[parameters('hybridUseBenefit')]"
                          },
                          "imageOffer": {
                            "value": "[parameters('imageOffer')]"
                          },
                          "imagePublisher": {
                            "value": "[parameters('imagePublisher')]"
                          },
                          "imageSku": {
                            "value": "[parameters('imageSku')]"
                          },
                          "imageVersion": {
                            "value": "[parameters('imageVersion')]"
                          },
                          "index": {
                            "value": "[range(0, parameters('vmCount'))[copyIndex()]]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "privateIPAddressOffset": {
                            "value": 5
                          },
                          "safeModeAdminPassword": {
                            "value": "[parameters('safeModeAdminPassword')]"
                          },
                          "subnetResourceId": {
                            "value": "[variables('identityTier').subnetResourceId]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "tier": {
                            "value": "[variables('identityTier')]"
                          },
                          "tokens": {
                            "value": "[parameters('tokens')]"
                          },
                          "vmSize": {
                            "value": "[parameters('vmSize')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "10451668829639022691"
                            }
                          },
                          "parameters": {
                            "adminPassword": {
                              "type": "securestring"
                            },
                            "adminUsername": {
                              "type": "string"
                            },
                            "availabilitySetResourceId": {
                              "type": "string"
                            },
                            "delimiter": {
                              "type": "string"
                            },
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "diskEncryptionSetResourceId": {
                              "type": "string"
                            },
                            "dnsForwarder": {
                              "type": "string",
                              "defaultValue": "168.63.129.16"
                            },
                            "domainName": {
                              "type": "string"
                            },
                            "hybridUseBenefit": {
                              "type": "bool"
                            },
                            "imageOffer": {
                              "type": "string"
                            },
                            "imagePublisher": {
                              "type": "string"
                            },
                            "imageSku": {
                              "type": "string"
                            },
                            "imageVersion": {
                              "type": "string"
                            },
                            "index": {
                              "type": "int"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "privateIPAddressOffset": {
                              "type": "int",
                              "defaultValue": 3
                            },
                            "safeModeAdminPassword": {
                              "type": "securestring"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            },
                            "tier": {
                              "type": "object"
                            },
                            "tokens": {
                              "type": "object"
                            },
                            "vmSize": {
                              "type": "string"
                            }
                          },
                          "variables": {
                            "$fxv#0": "param(\r\n    [string]$AdminPassword,\r\n    [string]$AdminUsername,\r\n    [int]$DomainControllerNumber,\r\n    [string]$DomainName,\r\n    [string]$DNSForwarder,\r\n    [string]$SafeModeAdminPassword\r\n)\r\n\r\n$ErrorActionPreference = 'Stop'\r\n\r\n$SecureAdminPassword = ConvertTo-SecureString -String $AdminPassword -AsPlainText -Force\r\n$DomainCredential = New-Object System.Management.Automation.PSCredential (\"$($DomainName.Split('.')[0])\\$($AdminUsername)\", $SecureAdminPassword)\r\n$SecureSafeModePassword = ConvertTo-SecureString -String $SafeModeAdminPassword -AsPlainText -Force\r\n\r\n# Initialize, partition, and format data disk\r\n$DiskNumber = (Get-Disk | Where-Object { $_.PartitionStyle -eq 'Raw' }).Number\r\nif ($DiskNumber) {\r\n    Initialize-Disk -Number $DiskNumber -PartitionStyle 'GPT' | Out-Null\r\n    New-Partition -DiskNumber $DiskNumber -DriveLetter 'F' -UseMaximumSize | Out-Null\r\n    Format-Volume -DriveLetter 'F' -FileSystem 'NTFS' -NewFileSystemLabel 'ADDS' -Confirm:$false | Out-Null\r\n}\r\n\r\n# Install AD DS role\r\n$FeatureInstalled = (Get-WindowsFeature -Name 'AD-Domain-Services').Installed\r\nif ( -not $FeatureInstalled ) {\r\n    Install-WindowsFeature -Name 'AD-Domain-Services' -IncludeManagementTools | Out-Null\r\n}\r\n\r\n# Import ADDSDeployment module\r\nImport-Module -Name 'ADDSDeployment'\r\n\r\n# Create new forest\r\nif ( $DomainControllerNumber -eq 1 ) {\r\n    try {\r\n        Get-ADForest | Out-Null\r\n    }\r\n    catch [Microsoft.ActiveDirectory.Management.ADIdentityNotFoundException] {\r\n        Install-ADDSForest `\r\n            -DatabasePath 'F:\\NTDS' `\r\n            -DomainMode 'WinThreshold' `\r\n            -DomainName $DomainName `\r\n            -DomainNetbiosName $DomainName.Split('.')[0] `\r\n            -Force `\r\n            -ForestMode 'WinThreshold' `\r\n            -InstallDNS `\r\n            -LogPath 'F:\\Logs' `\r\n            -NoRebootOnCompletion `\r\n            -SafeModeAdministratorPassword $SecureSafeModePassword `\r\n            -SysvolPath 'F:\\SYSVOL' | Out-Null\r\n    }\r\n}\r\n\r\n# Add domain controller to the forest\r\nif ( $DomainControllerNumber -eq 2 ) {\r\n    # Join to the domain, if not already joined\r\n    $ComputerSystem = Get-CimInstance -ClassName Win32_ComputerSystem\r\n    if ( -not $ComputerSystem.PartOfDomain) {\r\n        $joined = $false\r\n        while (-not $joined) {\r\n            try {\r\n                Add-Computer -DomainName $DomainName -Credential $DomainCredential -ErrorAction Stop\r\n\r\n                $joined = $true\r\n            }\r\n            catch {\r\n                Start-Sleep -Seconds 15\r\n            }\r\n        }\r\n    }\r\n\r\n    # Loop until an Active Directory domain controller is returned\r\n    while ( -not (Get-ADDomainController -Discover -ErrorAction 'SilentlyContinue') ) {\r\n        Start-Sleep -Seconds 10\r\n    }\r\n\r\n    [array]$ExistingDomainControllers = (Get-ADDomainController).Name\r\n    if ( $ExistingDomainControllers -notcontains $env:COMPUTERNAME ) {\r\n        # Wait for secure channel using nltest directly in condition\r\n        do {\r\n            nltest /sc_verify:$DomainName 2>$null\r\n            $exitCode = $LASTEXITCODE\r\n            if ($exitCode -ne 0) {\r\n              Start-Sleep -Seconds 5\r\n            }\r\n        } while ($exitCode -ne 0)\r\n\r\n        Install-ADDSDomainController `\r\n            -Credential $DomainCredential `\r\n            -DatabasePath 'F:\\NTDS' `\r\n            -DomainName $DomainName `\r\n            -Force `\r\n            -InstallDNS `\r\n            -LogPath 'F:\\Logs' `\r\n            -NoRebootOnCompletion `\r\n            -SafeModeAdministratorPassword $SecureSafeModePassword `\r\n            -SysvolPath 'F:\\SYSVOL' | Out-Null\r\n    }\r\n}\r\n\r\n# Set DNS server Listening Address to IPv4 address\r\n$DNSServerSettings = Get-DnsServerSetting -All\r\n$IPv4Address = $DNSServerSettings.ListeningIpAddress | Where-Object { $_ -match '^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$' }\r\n$DNSServerSettings.ListeningIpAddress = $IPv4Address\r\n$DNSServerSettings | Set-DnsServerSetting | Out-Null\r\n\r\n# Set DNS forwarder on the DNS server\r\n$ExistingDNSForwarder = (Get-DnsServerForwarder -ErrorAction 'SilentlyContinue').IPAddress\r\nif ( $ExistingDNSForwarder -ne $DNSForwarder ) {\r\n    Set-DnsServerForwarder `\r\n        -IPAddress $DNSForwarder `\r\n        -UseRootHint:$true | Out-Null\r\n}\r\nRestart-Computer -Force\r\n\r\n"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-adds-vm-{0}-{1}', parameters('index'), parameters('deploymentNameSuffix'))]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "adminPasswordOrKey": {
                                    "value": "[parameters('adminPassword')]"
                                  },
                                  "adminUsername": {
                                    "value": "[parameters('adminUsername')]"
                                  },
                                  "authenticationType": {
                                    "value": "password"
                                  },
                                  "availabilitySetResourceId": {
                                    "value": "[parameters('availabilitySetResourceId')]"
                                  },
                                  "dataDisks": {
                                    "value": [
                                      {
                                        "caching": "None",
                                        "createOption": "Empty",
                                        "diskSizeGB": 128,
                                        "lun": 0,
                                        "managedDisk": {
                                          "diskEncryptionSet": {
                                            "id": "[parameters('diskEncryptionSetResourceId')]"
                                          },
                                          "storageAccountType": "Premium_LRS"
                                        },
                                        "name": "[format('{0}{1}{2}{3}1', replace(parameters('tier').namingConvention.virtualMachineDisk, parameters('tokens').purpose, 'dc'), parameters('delimiter'), parameters('index'), parameters('delimiter'))]"
                                      }
                                    ]
                                  },
                                  "diskCaching": {
                                    "value": "None"
                                  },
                                  "diskEncryptionSetResourceId": {
                                    "value": "[parameters('diskEncryptionSetResourceId')]"
                                  },
                                  "diskName": {
                                    "value": "[format('{0}{1}{2}{3}0', replace(parameters('tier').namingConvention.virtualMachineDisk, parameters('tokens').purpose, 'dc'), parameters('delimiter'), parameters('index'), parameters('delimiter'))]"
                                  },
                                  "domainJoin": {
                                    "value": false
                                  },
                                  "domainName": {
                                    "value": "[parameters('domainName')]"
                                  },
                                  "hybridUseBenefit": {
                                    "value": "[parameters('hybridUseBenefit')]"
                                  },
                                  "imageOffer": {
                                    "value": "[parameters('imageOffer')]"
                                  },
                                  "imagePublisher": {
                                    "value": "[parameters('imagePublisher')]"
                                  },
                                  "imageSku": {
                                    "value": "[parameters('imageSku')]"
                                  },
                                  "imageVersion": {
                                    "value": "[parameters('imageVersion')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[parameters('mlzTags')]"
                                  },
                                  "networkInterfaceName": {
                                    "value": "[format('{0}{1}{2}', replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'dc'), parameters('delimiter'), parameters('index'))]"
                                  },
                                  "networkSecurityGroupResourceId": {
                                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('subnetResourceId'), '/')[2], split(parameters('subnetResourceId'), '/')[4]), 'Microsoft.Network/virtualNetworks', split(parameters('subnetResourceId'), '/')[8]), '2024-07-01').subnets[0].properties.networkSecurityGroup.id]"
                                  },
                                  "privateIPAddress": {
                                    "value": "[cidrHost(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('subnetResourceId'), '/')[2], split(parameters('subnetResourceId'), '/')[4]), 'Microsoft.Network/virtualNetworks', split(parameters('subnetResourceId'), '/')[8]), '2024-07-01').subnets[0].properties.addressPrefix, add(parameters('index'), parameters('privateIPAddressOffset')))]"
                                  },
                                  "storageAccountType": {
                                    "value": "Premium_LRS"
                                  },
                                  "subnetResourceId": {
                                    "value": "[parameters('subnetResourceId')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  },
                                  "virtualMachineName": {
                                    "value": "[format('{0}{1}', replace(parameters('tier').namingConvention.virtualMachine, parameters('tokens').purpose, 'dc'), parameters('index'))]"
                                  },
                                  "virtualMachineSize": {
                                    "value": "[parameters('vmSize')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "16794041801135670912"
                                    }
                                  },
                                  "parameters": {
                                    "adminPasswordOrKey": {
                                      "type": "securestring",
                                      "minLength": 12
                                    },
                                    "adminUsername": {
                                      "type": "string"
                                    },
                                    "authenticationType": {
                                      "type": "string",
                                      "allowedValues": [
                                        "sshPublicKey",
                                        "password"
                                      ]
                                    },
                                    "availabilitySetResourceId": {
                                      "type": "string",
                                      "defaultValue": ""
                                    },
                                    "dataDisks": {
                                      "type": "array",
                                      "defaultValue": []
                                    },
                                    "diskCaching": {
                                      "type": "string",
                                      "defaultValue": "ReadWrite"
                                    },
                                    "diskEncryptionSetResourceId": {
                                      "type": "string"
                                    },
                                    "diskName": {
                                      "type": "string"
                                    },
                                    "domainJoin": {
                                      "type": "bool",
                                      "defaultValue": false
                                    },
                                    "domainName": {
                                      "type": "string",
                                      "defaultValue": ""
                                    },
                                    "hybridUseBenefit": {
                                      "type": "bool",
                                      "defaultValue": false
                                    },
                                    "imageOffer": {
                                      "type": "string"
                                    },
                                    "imagePublisher": {
                                      "type": "string"
                                    },
                                    "imageSku": {
                                      "type": "string"
                                    },
                                    "imageVersion": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "networkInterfaceName": {
                                      "type": "string"
                                    },
                                    "networkSecurityGroupResourceId": {
                                      "type": "string"
                                    },
                                    "privateIPAddress": {
                                      "type": "string",
                                      "defaultValue": ""
                                    },
                                    "storageAccountType": {
                                      "type": "string"
                                    },
                                    "subnetResourceId": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object"
                                    },
                                    "timestamp": {
                                      "type": "string",
                                      "defaultValue": "[utcNow('yyyyMMddhhmmss')]"
                                    },
                                    "virtualMachineName": {
                                      "type": "string"
                                    },
                                    "virtualMachineSize": {
                                      "type": "string"
                                    }
                                  },
                                  "variables": {
                                    "osType": "[if(contains(parameters('imagePublisher'), 'Windows'), 'Windows', 'Linux')]",
                                    "linuxConfiguration": {
                                      "disablePasswordAuthentication": true,
                                      "ssh": {
                                        "publicKeys": [
                                          {
                                            "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                                            "keyData": "[parameters('adminPasswordOrKey')]"
                                          }
                                        ]
                                      }
                                    },
                                    "dependencyAgentSupport": [
                                      "74-gen2",
                                      "75-gen2",
                                      "76-gen2",
                                      "77-gen2",
                                      "78-gen2",
                                      "79-gen2",
                                      "8-gen2",
                                      "8-lvm-gen2",
                                      "81-ci-gen2",
                                      "81gen2",
                                      "82-gen2",
                                      "83-gen2",
                                      "84-gen2",
                                      "85-gen2",
                                      "86-gen2",
                                      "16_04-daily-lts-gen2",
                                      "16_04-lts-gen2",
                                      "16_04_0-lts-gen2",
                                      "18_04-daily-lts-gen2",
                                      "18_04-lts-gen2",
                                      "20_04-lts-gen2",
                                      "2016-Datacenter",
                                      "2016-datacenter-gensecond",
                                      "2016-datacenter-gs",
                                      "2016-Datacenter-smalldisk",
                                      "2016-datacenter-smalldisk-g2",
                                      "2016-Datacenter-with-Containers",
                                      "2016-datacenter-with-containers-g2",
                                      "2016-Datacenter-zhcn",
                                      "2016-datacenter-zhcn-g2",
                                      "2019-Datacenter",
                                      "2019-datacenter-gensecond",
                                      "2019-datacenter-gs",
                                      "2019-datacenter-gs-g2",
                                      "2019-Datacenter-smalldisk",
                                      "2019-datacenter-smalldisk-g2",
                                      "2019-Datacenter-with-Containers",
                                      "2019-datacenter-with-containers-g2",
                                      "2019-datacenter-with-containers-gs",
                                      "2019-Datacenter-with-Containers-smalldisk",
                                      "2019-datacenter-with-containers-smalldisk-g2",
                                      "2019-Datacenter-zhcn",
                                      "2019-datacenter-zhcn-g2",
                                      "2022-datacenter",
                                      "2022-datacenter-azure-edition",
                                      "2022-datacenter-azure-edition-core",
                                      "2022-datacenter-azure-edition-core-smalldisk",
                                      "2022-datacenter-azure-edition-hotpatch",
                                      "2022-datacenter-azure-edition-hotpatch-smalldisk",
                                      "2022-datacenter-azure-edition-smalldisk",
                                      "2022-datacenter-core",
                                      "2022-datacenter-core-g2",
                                      "2022-datacenter-core-smalldisk",
                                      "2022-datacenter-core-smalldisk-g2",
                                      "2022-datacenter-g2",
                                      "2022-datacenter-smalldisk",
                                      "2022-datacenter-smalldisk-g2"
                                    ]
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/networkInterfaces",
                                      "apiVersion": "2021-02-01",
                                      "name": "[parameters('networkInterfaceName')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkInterfaces'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "enableAcceleratedNetworking": true,
                                        "ipConfigurations": [
                                          {
                                            "name": "ipconfig",
                                            "properties": {
                                              "privateIPAddress": "[if(empty(parameters('privateIPAddress')), null(), parameters('privateIPAddress'))]",
                                              "privateIPAllocationMethod": "[if(empty(parameters('privateIPAddress')), 'Dynamic', 'Static')]",
                                              "subnet": {
                                                "id": "[parameters('subnetResourceId')]"
                                              }
                                            }
                                          }
                                        ],
                                        "networkSecurityGroup": {
                                          "id": "[parameters('networkSecurityGroupResourceId')]"
                                        }
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Compute/virtualMachines",
                                      "apiVersion": "2024-11-01",
                                      "name": "[parameters('virtualMachineName')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                                      "identity": {
                                        "type": "SystemAssigned"
                                      },
                                      "properties": {
                                        "availabilitySet": "[if(empty(parameters('availabilitySetResourceId')), null(), createObject('id', parameters('availabilitySetResourceId')))]",
                                        "diagnosticsProfile": {
                                          "bootDiagnostics": {
                                            "enabled": false
                                          }
                                        },
                                        "hardwareProfile": {
                                          "vmSize": "[parameters('virtualMachineSize')]"
                                        },
                                        "networkProfile": {
                                          "networkInterfaces": [
                                            {
                                              "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]",
                                              "properties": {
                                                "deleteOption": "Delete"
                                              }
                                            }
                                          ]
                                        },
                                        "osProfile": {
                                          "computerName": "[take(parameters('virtualMachineName'), 15)]",
                                          "adminUsername": "[parameters('adminUsername')]",
                                          "adminPassword": "[parameters('adminPasswordOrKey')]",
                                          "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), null(), variables('linuxConfiguration'))]"
                                        },
                                        "securityProfile": {
                                          "uefiSettings": {
                                            "secureBootEnabled": true,
                                            "vTpmEnabled": true
                                          },
                                          "securityType": "trustedLaunch",
                                          "encryptionAtHost": true
                                        },
                                        "storageProfile": {
                                          "dataDisks": "[parameters('dataDisks')]",
                                          "imageReference": {
                                            "publisher": "[parameters('imagePublisher')]",
                                            "offer": "[parameters('imageOffer')]",
                                            "sku": "[parameters('imageSku')]",
                                            "version": "[parameters('imageVersion')]"
                                          },
                                          "osDisk": {
                                            "caching": "[parameters('diskCaching')]",
                                            "createOption": "FromImage",
                                            "deleteOption": "Delete",
                                            "managedDisk": {
                                              "diskEncryptionSet": {
                                                "id": "[parameters('diskEncryptionSetResourceId')]"
                                              },
                                              "storageAccountType": "[parameters('storageAccountType')]"
                                            },
                                            "name": "[parameters('diskName')]",
                                            "osType": "[variables('osType')]"
                                          }
                                        },
                                        "licenseType": "[if(parameters('hybridUseBenefit'), 'Windows_Server', null())]"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Compute/virtualMachines/extensions",
                                      "apiVersion": "2024-11-01",
                                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'GuestAttestation')]",
                                      "location": "[parameters('location')]",
                                      "properties": {
                                        "autoUpgradeMinorVersion": true,
                                        "enableAutomaticUpgrade": true,
                                        "publisher": "[format('Microsoft.Azure.Security.{0}Attestation', variables('osType'))]",
                                        "settings": {
                                          "AttestationConfig": {
                                            "AscSettings": {
                                              "ascReportingEndpoint": "",
                                              "ascReportingFrequency": ""
                                            },
                                            "disableAlerts": "false",
                                            "MaaSettings": {
                                              "maaEndpoint": "",
                                              "maaTenantName": "GuestAttestation"
                                            },
                                            "useCustomToken": "false"
                                          }
                                        },
                                        "type": "GuestAttestation",
                                        "typeHandlerVersion": "1.0"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Compute/virtualMachines/extensions",
                                      "apiVersion": "2024-11-01",
                                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "autoUpgradeMinorVersion": true,
                                        "enableAutomaticUpgrade": true,
                                        "publisher": "Microsoft.GuestConfiguration",
                                        "type": "[format('Configurationfor{0}', variables('osType'))]",
                                        "typeHandlerVersion": "1.0"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Compute/virtualMachines/extensions",
                                      "apiVersion": "2024-11-01",
                                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "autoUpgradeMinorVersion": true,
                                        "enableAutomaticUpgrade": true,
                                        "publisher": "Microsoft.Azure.NetworkWatcher",
                                        "type": "[format('NetworkWatcherAgent{0}', variables('osType'))]",
                                        "typeHandlerVersion": "1.4"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Compute/virtualMachines/extensions",
                                      "apiVersion": "2024-11-01",
                                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('AzureMonitor{0}Agent', variables('osType')))]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "autoUpgradeMinorVersion": true,
                                        "enableAutomaticUpgrade": true,
                                        "publisher": "Microsoft.Azure.Monitor",
                                        "settings": "[if(equals(variables('osType'), 'Windows'), createObject(), createObject('stopOnMultipleConnections', true()))]",
                                        "type": "[format('AzureMonitor{0}Agent', variables('osType'))]",
                                        "typeHandlerVersion": "1.0"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                                      ]
                                    },
                                    {
                                      "condition": "[contains(variables('dependencyAgentSupport'), parameters('imageSku'))]",
                                      "type": "Microsoft.Compute/virtualMachines/extensions",
                                      "apiVersion": "2024-11-01",
                                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('DependencyAgent{0}', variables('osType')))]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "publisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                                        "type": "[format('DependencyAgent{0}', variables('osType'))]",
                                        "typeHandlerVersion": "9.5",
                                        "autoUpgradeMinorVersion": true
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                                      ]
                                    },
                                    {
                                      "condition": "[parameters('domainJoin')]",
                                      "type": "Microsoft.Compute/virtualMachines/extensions",
                                      "apiVersion": "2021-03-01",
                                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'JsonADDomainExtension')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "forceUpdateTag": "[parameters('timestamp')]",
                                        "publisher": "Microsoft.Compute",
                                        "type": "JsonADDomainExtension",
                                        "typeHandlerVersion": "1.3",
                                        "autoUpgradeMinorVersion": true,
                                        "settings": {
                                          "Name": "[parameters('domainName')]",
                                          "Options": "3",
                                          "Restart": "true",
                                          "User": "[format('{0}@{1}', parameters('adminUsername'), parameters('domainName'))]"
                                        },
                                        "protectedSettings": {
                                          "Password": "[parameters('adminPasswordOrKey')]"
                                        }
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('AzureMonitor{0}Agent', variables('osType')))]",
                                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('DependencyAgent{0}', variables('osType')))]",
                                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), 'GuestAttestation')]",
                                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                                      ]
                                    }
                                  ],
                                  "outputs": {
                                    "networkInterfaceResourceId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                                    },
                                    "virtualMachineResourceId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                                    },
                                    "virtualMachinePrincipalId": {
                                      "type": "string",
                                      "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName')), '2024-11-01', 'full').identity.principalId]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-adds-run-command-{0}-{1}', parameters('index'), parameters('deploymentNameSuffix'))]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "asyncExecution": {
                                    "value": true
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "name": {
                                    "value": "[format('New-ADDSForest-{0}', parameters('index'))]"
                                  },
                                  "parameters": {
                                    "value": [
                                      {
                                        "name": "AdminUsername",
                                        "value": "[parameters('adminUsername')]"
                                      },
                                      {
                                        "name": "DomainControllerNumber",
                                        "value": "[string(add(parameters('index'), 1))]"
                                      },
                                      {
                                        "name": "DomainName",
                                        "value": "[parameters('domainName')]"
                                      },
                                      {
                                        "name": "DNSForwarder",
                                        "value": "[parameters('dnsForwarder')]"
                                      }
                                    ]
                                  },
                                  "protectedParameters": {
                                    "value": "[format('[{{''name'':''AdminPassword'',''value'':''{0}''}},{{''name'':''SafeModeAdminPassword'',''value'':''{1}''}}]', parameters('adminPassword'), parameters('safeModeAdminPassword'))]"
                                  },
                                  "script": {
                                    "value": "[variables('$fxv#0')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  },
                                  "treatFailureAsDeploymentFailure": {
                                    "value": true
                                  },
                                  "virtualMachineName": {
                                    "value": "[split(reference(resourceId('Microsoft.Resources/deployments', format('deploy-adds-vm-{0}-{1}', parameters('index'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualMachineResourceId.value, '/')[8]]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "8333305544299446105"
                                    }
                                  },
                                  "parameters": {
                                    "asyncExecution": {
                                      "type": "bool",
                                      "defaultValue": false
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "name": {
                                      "type": "string"
                                    },
                                    "parameters": {
                                      "type": "array",
                                      "defaultValue": []
                                    },
                                    "protectedParameters": {
                                      "type": "securestring"
                                    },
                                    "script": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object"
                                    },
                                    "treatFailureAsDeploymentFailure": {
                                      "type": "bool",
                                      "defaultValue": true
                                    },
                                    "virtualMachineName": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                                      "apiVersion": "2023-09-01",
                                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), parameters('name'))]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "asyncExecution": "[parameters('asyncExecution')]",
                                        "parameters": "[parameters('parameters')]",
                                        "protectedParameters": "[json(parameters('protectedParameters'))]",
                                        "source": {
                                          "script": "[parameters('script')]"
                                        },
                                        "treatFailureAsDeploymentFailure": "[parameters('treatFailureAsDeploymentFailure')]"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Resources/deployments', format('deploy-adds-vm-{0}-{1}', parameters('index'), parameters('deploymentNameSuffix')))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "networkInterfaceResourceId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-adds-vm-{0}-{1}', parameters('index'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value]"
                            },
                            "virtualMachineResourceId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-adds-vm-{0}-{1}', parameters('index'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualMachineResourceId.value]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')), 'Microsoft.Resources/deployments', format('deploy-adds-availability-set-{0}', parameters('deploymentNameSuffix')))]",
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')), 'Microsoft.Resources/deployments', format('deploy-adds-cmk-{0}', parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers'))]",
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('firewallPolicyResourceId'), '/')[2], split(parameters('firewallPolicyResourceId'), '/')[4]), 'Microsoft.Resources/deployments', format('update-fw-policy-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "keyVaultProperties": {
                      "type": "object",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')), 'Microsoft.Resources/deployments', format('deploy-adds-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultProperties.value]"
                    },
                    "networkInterfaceResourceIds": {
                      "type": "array",
                      "value": [
                        "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')), 'Microsoft.Resources/deployments', format('deploy-adds-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultNetworkInterfaceResourceId.value]",
                        "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')), 'Microsoft.Resources/deployments', format('deploy-adds-dc-{0}-{1}', range(0, parameters('vmCount'))[0], parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value]",
                        "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')), 'Microsoft.Resources/deployments', format('deploy-adds-dc-{0}-{1}', range(0, parameters('vmCount'))[1], parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value]"
                      ]
                    },
                    "virtualMachineResourceIds": {
                      "type": "array",
                      "value": [
                        "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')), 'Microsoft.Resources/deployments', format('deploy-adds-dc-{0}-{1}', range(0, parameters('vmCount'))[0], parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualMachineResourceId.value]",
                        "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(variables('identityTier').namingConvention.resourceGroup, parameters('tokens').purpose, 'domainControllers')), 'Microsoft.Resources/deployments', format('deploy-adds-dc-{0}-{1}', range(0, parameters('vmCount'))[1], parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualMachineResourceId.value]"
                      ]
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "condition": "[or(or(parameters('deployBastion'), parameters('deployLinuxVirtualMachine')), parameters('deployWindowsVirtualMachine'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-remote-access-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('hubSubscriptionId')]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "bastionHostPublicIPAddressAllocationMethod": {
                    "value": "Static"
                  },
                  "bastionHostPublicIPAddressAvailabilityZones": {
                    "value": "[parameters('bastionHostPublicIPAddressAvailabilityZones')]"
                  },
                  "bastionHostPublicIPAddressSkuName": {
                    "value": "Standard"
                  },
                  "bastionHostSubnetResourceId": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.bastionHostSubnetResourceId.value]"
                  },
                  "delimiter": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                  },
                  "deployBastion": {
                    "value": "[parameters('deployBastion')]"
                  },
                  "deployLinuxVirtualMachine": {
                    "value": "[parameters('deployLinuxVirtualMachine')]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "deployWindowsVirtualMachine": {
                    "value": "[parameters('deployWindowsVirtualMachine')]"
                  },
                  "environmentAbbreviation": {
                    "value": "[parameters('environmentAbbreviation')]"
                  },
                  "hybridUseBenefit": {
                    "value": "[parameters('hybridUseBenefit')]"
                  },
                  "keyVaultPrivateDnsZoneResourceId": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value.keyVault]"
                  },
                  "linuxVmAdminPasswordOrKey": {
                    "value": "[parameters('linuxVmAdminPasswordOrKey')]"
                  },
                  "linuxVmAdminUsername": {
                    "value": "[parameters('linuxVmAdminUsername')]"
                  },
                  "linuxVmAuthenticationType": {
                    "value": "[parameters('linuxVmAuthenticationType')]"
                  },
                  "linuxVmImageOffer": {
                    "value": "[parameters('linuxVmImageOffer')]"
                  },
                  "linuxVmImagePublisher": {
                    "value": "[parameters('linuxVmImagePublisher')]"
                  },
                  "linuxVmImageSku": {
                    "value": "[parameters('linuxVmImageSku')]"
                  },
                  "linuxVmImageVersion": {
                    "value": "[parameters('linuxVmImageVersion')]"
                  },
                  "linuxVmOsDiskType": {
                    "value": "[parameters('linuxVmOsDiskType')]"
                  },
                  "linuxVmSize": {
                    "value": "[parameters('linuxVmSize')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                  },
                  "resourceAbbreviations": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tier": {
                    "value": "[filter(reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value, lambda('tier', equals(lambdaVariables('tier').name, 'hub')))[0]]"
                  },
                  "tokens": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                  },
                  "windowsVmAdminPassword": {
                    "value": "[parameters('windowsVmAdminPassword')]"
                  },
                  "windowsVmAdminUsername": {
                    "value": "[parameters('windowsVmAdminUsername')]"
                  },
                  "windowsVmImageOffer": {
                    "value": "[parameters('windowsVmImageOffer')]"
                  },
                  "windowsVmImagePublisher": {
                    "value": "[parameters('windowsVmImagePublisher')]"
                  },
                  "windowsVmImageSku": {
                    "value": "[parameters('windowsVmImageSku')]"
                  },
                  "windowsVmSize": {
                    "value": "[parameters('windowsVmSize')]"
                  },
                  "windowsVmStorageAccountType": {
                    "value": "[parameters('windowsVmStorageAccountType')]"
                  },
                  "windowsVmVersion": {
                    "value": "[parameters('windowsVmImageVersion')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "15822766972467490219"
                    }
                  },
                  "parameters": {
                    "bastionHostPublicIPAddressAllocationMethod": {
                      "type": "string"
                    },
                    "bastionHostPublicIPAddressAvailabilityZones": {
                      "type": "array"
                    },
                    "bastionHostPublicIPAddressSkuName": {
                      "type": "string"
                    },
                    "bastionHostSubnetResourceId": {
                      "type": "string"
                    },
                    "delimiter": {
                      "type": "string"
                    },
                    "deployBastion": {
                      "type": "bool"
                    },
                    "deployLinuxVirtualMachine": {
                      "type": "bool"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "deployWindowsVirtualMachine": {
                      "type": "bool"
                    },
                    "environmentAbbreviation": {
                      "type": "string"
                    },
                    "hybridUseBenefit": {
                      "type": "bool"
                    },
                    "keyVaultPrivateDnsZoneResourceId": {
                      "type": "string"
                    },
                    "linuxVmAdminPasswordOrKey": {
                      "type": "securestring",
                      "minLength": 12
                    },
                    "linuxVmAdminUsername": {
                      "type": "string"
                    },
                    "linuxVmAuthenticationType": {
                      "type": "string",
                      "allowedValues": [
                        "sshPublicKey",
                        "password"
                      ]
                    },
                    "linuxVmImagePublisher": {
                      "type": "string"
                    },
                    "linuxVmImageOffer": {
                      "type": "string"
                    },
                    "linuxVmImageSku": {
                      "type": "string"
                    },
                    "linuxVmImageVersion": {
                      "type": "string"
                    },
                    "linuxVmSize": {
                      "type": "string"
                    },
                    "linuxVmOsDiskType": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "resourceAbbreviations": {
                      "type": "object"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "tier": {
                      "type": "object"
                    },
                    "tokens": {
                      "type": "object"
                    },
                    "windowsVmAdminPassword": {
                      "type": "securestring",
                      "minLength": 12
                    },
                    "windowsVmAdminUsername": {
                      "type": "string"
                    },
                    "windowsVmImageOffer": {
                      "type": "string"
                    },
                    "windowsVmImagePublisher": {
                      "type": "string"
                    },
                    "windowsVmImageSku": {
                      "type": "string"
                    },
                    "windowsVmSize": {
                      "type": "string"
                    },
                    "windowsVmStorageAccountType": {
                      "type": "string"
                    },
                    "windowsVmVersion": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "resourceGroupName": "[replace(parameters('tier').namingConvention.resourceGroup, parameters('tokens').purpose, 'jumpBoxes')]"
                  },
                  "resources": [
                    {
                      "condition": "[or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine'))]",
                      "type": "Microsoft.Resources/resourceGroups",
                      "apiVersion": "2019-05-01",
                      "name": "[variables('resourceGroupName')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Resources/resourceGroups'), createObject()), parameters('mlzTags'))]"
                    },
                    {
                      "condition": "[or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-ra-cmk-{0}', parameters('deploymentNameSuffix'))]",
                      "resourceGroup": "[variables('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "environmentAbbreviation": {
                            "value": "[parameters('environmentAbbreviation')]"
                          },
                          "keyName": {
                            "value": "[replace(parameters('tier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, 'cmk')]"
                          },
                          "keyVaultPrivateDnsZoneResourceId": {
                            "value": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "resourceAbbreviations": {
                            "value": "[parameters('resourceAbbreviations')]"
                          },
                          "subnetResourceId": {
                            "value": "[parameters('tier').subnetResourceId]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "tier": {
                            "value": "[parameters('tier')]"
                          },
                          "tokens": {
                            "value": "[parameters('tokens')]"
                          },
                          "type": {
                            "value": "virtualMachine"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "16154764937040063236"
                            }
                          },
                          "parameters": {
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "environmentAbbreviation": {
                              "type": "string"
                            },
                            "keyExpirationInDays": {
                              "type": "int",
                              "defaultValue": 30
                            },
                            "keyName": {
                              "type": "string"
                            },
                            "keyVaultPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "resourceAbbreviations": {
                              "type": "object"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "tier": {
                              "type": "object"
                            },
                            "tokens": {
                              "type": "object"
                            },
                            "type": {
                              "type": "string",
                              "allowedValues": [
                                "storageAccount",
                                "virtualMachine"
                              ]
                            },
                            "virtualMachineAdminPassword": {
                              "type": "securestring",
                              "defaultValue": "[newGuid()]"
                            },
                            "virtualMachineAdminUsername": {
                              "type": "string",
                              "defaultValue": "xadmin"
                            },
                            "virtualMachineSize": {
                              "type": "string",
                              "defaultValue": "Standard_D2ds_v4"
                            }
                          },
                          "variables": {
                            "$fxv#0": "Param(\r\n    [string]$DiskEncryptionSetName,\r\n    [int]$KeyExpirationInDays,\r\n    [string]$KeyName,\r\n    [string]$KeyVaultResourceId,\r\n    [string]$KeyVaultServiceUri,\r\n    [string]$KeyVaultUri,\r\n    [string]$Location,\r\n    [string]$ResourceGroupName,\r\n    [string]$ResourceManagerUri,\r\n    [string]$SubscriptionId,\r\n    [string]$Type,\r\n    [string]$UserAssignedIdentityClientId\r\n)\r\n\r\n$ErrorActionPreference = 'Stop'\r\n$WarningPreference = 'SilentlyContinue'\r\n\r\n# Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n$ResourceManagerUriFixed = if ($ResourceManagerUri[-1] -eq '/') { $ResourceManagerUri.Substring(0, $ResourceManagerUri.Length - 1) } else { $ResourceManagerUri }\r\n\r\n# Get an access token for Azure resources\r\n$KeyVaultAccessToken = (Invoke-RestMethod `\r\n        -Headers @{Metadata = \"true\" } `\r\n        -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $KeyVaultServiceUri + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n# Set header for Azure Management API\r\n$KeyVaultHeaders = @{\r\n    'Content-Type'  = 'application/json'\r\n    'Authorization' = 'Bearer ' + $KeyVaultAccessToken\r\n}\r\n\r\n$Body = [PSCustomObject]@{\r\n    kty            = 'RSA-HSM'\r\n    key_size       = 4096\r\n    attributes     = @{\r\n        enabled = $true\r\n    }\r\n    rotationPolicy = @{\r\n        attributes      = @{\r\n            expiryTime = $('P' + $KeyExpirationInDays + 'D')\r\n        }\r\n        lifetimeActions = @(\r\n            @{\r\n                action  = @{\r\n                    type = 'Notify'\r\n                }\r\n                trigger = @{\r\n                    timeBeforeExpiry = 'P10D'\r\n                }\r\n            },\r\n            @{\r\n                action  = @{\r\n                    type = 'Rotate'\r\n                }\r\n                trigger = @{\r\n                    timeAfterCreate = $('P' + ($KeyExpirationInDays - 7) + 'D')\r\n                }\r\n            }\r\n        )\r\n    }\r\n}\r\n\r\n# Create key vault key\r\n$KeyUriWithVersion = (Invoke-RestMethod `\r\n        -Body ($Body | ConvertTo-Json -Depth 4) `\r\n        -Headers $KeyVaultHeaders `\r\n        -Method 'POST' `\r\n        -Uri $($KeyVaultUri + 'keys/' + $KeyName + '/create?api-version=2025-07-01')).key.kid\r\n\r\nif ($Type -eq 'virtualMachine') {\r\n\r\n    # Get an access token for Azure resources\r\n    $ResourceManagerAccessToken = (Invoke-RestMethod `\r\n            -Headers @{Metadata = \"true\" } `\r\n            -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n    # Set header for Azure Management API\r\n    $ResourceManagerHeaders = @{\r\n        'Content-Type'  = 'application/json'\r\n        'Authorization' = 'Bearer ' + $ResourceManagerAccessToken\r\n    }\r\n\r\n    $DiskEncryptionSetBody = @{\r\n        location   = $Location\r\n        identity   = @{\r\n            type = 'SystemAssigned'\r\n        }\r\n        properties = @{\r\n            activeKey                         = @{\r\n                sourceVault = @{\r\n                    id = $KeyVaultResourceId\r\n                }\r\n                keyUrl = $KeyUriWithVersion\r\n            }\r\n            encryptionType                    = 'EncryptionAtRestWithPlatformAndCustomerKeys'\r\n            rotationToLatestKeyVersionEnabled = $true\r\n        }\r\n    }\r\n\r\n    Invoke-RestMethod `\r\n        -Body ($DiskEncryptionSetBody | ConvertTo-Json -Depth 4) `\r\n        -Headers $ResourceManagerHeaders `\r\n        -Method 'PUT' `\r\n        -Uri $($ResourceManagerUriFixed + '/subscriptions/' + $SubscriptionId + '/resourceGroups/' + $ResourceGroupName + '/providers/Microsoft.Compute/diskEncryptionSets/' + $DiskEncryptionSetName + '?api-version=2025-01-02')\r\n}",
                            "$fxv#1": "param(\r\n    [string]$ResourceGroupName,\r\n    [string]$ResourceManagerUri,\r\n    [string]$UserAssignedIdentityClientId,\r\n    [string]$VirtualMachineResourceId\r\n)\r\n\r\n# Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n$ResourceManagerUriFixed = if($ResourceManagerUri[-1] -eq '/'){$ResourceManagerUri.Substring(0,$ResourceManagerUri.Length - 1)} else {$ResourceManagerUri}\r\n\r\n# Get an access token for Azure resources\r\n$AzureManagementAccessToken = (Invoke-RestMethod `\r\n    -Headers @{Metadata=\"true\"} `\r\n    -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n# Set header for Azure Management API\r\n$AzureManagementHeader = @{\r\n    'Content-Type'='application/json'\r\n    'Authorization'='Bearer ' + $AzureManagementAccessToken\r\n}\r\n\r\nStart-Sleep -Seconds 30\r\n\r\n# Use the access token to delete the virtual machine\r\nInvoke-RestMethod `\r\n    -Headers $AzureManagementHeader `\r\n    -Method 'Delete' `\r\n    -Uri $($ResourceManagerUriFixed + $VirtualMachineResourceId + '?forceDeletion=true&api-version=2024-07-01') | Out-Null",
                            "keyVaultPrivateEndpointName": "[replace(parameters('tier').namingConvention.keyVaultPrivateEndpoint, parameters('tokens').purpose, variables('workload'))]",
                            "resourceGroupName": "[resourceGroup().name]",
                            "userAssignedIdentityName": "[replace(parameters('tier').namingConvention.userAssignedIdentity, parameters('tokens').purpose, variables('workload'))]",
                            "virtualMachineName": "[replace(parameters('tier').namingConvention.virtualMachine, parameters('tokens').purpose, variables('workload'))]",
                            "workload": "cmk"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                              "apiVersion": "2018-11-30",
                              "name": "[variables('userAssignedIdentityName')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]"
                            },
                            {
                              "type": "Microsoft.Network/networkInterfaces",
                              "apiVersion": "2020-05-01",
                              "name": "[replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "ipConfigurations": [
                                  {
                                    "name": "ipconfig",
                                    "properties": {
                                      "privateIPAllocationMethod": "Dynamic",
                                      "subnet": {
                                        "id": "[parameters('subnetResourceId')]"
                                      },
                                      "primary": true,
                                      "privateIPAddressVersion": "IPv4"
                                    }
                                  }
                                ],
                                "enableAcceleratedNetworking": false,
                                "enableIPForwarding": false
                              }
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2021-11-01",
                              "name": "[variables('virtualMachineName')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "hardwareProfile": {
                                  "vmSize": "[parameters('virtualMachineSize')]"
                                },
                                "storageProfile": {
                                  "imageReference": {
                                    "publisher": "MicrosoftWindowsServer",
                                    "offer": "WindowsServer",
                                    "sku": "2022-datacenter-core-g2",
                                    "version": "latest"
                                  },
                                  "osDisk": {
                                    "deleteOption": "Delete",
                                    "osType": "Windows",
                                    "createOption": "FromImage",
                                    "caching": "None",
                                    "managedDisk": {
                                      "storageAccountType": "Premium_LRS"
                                    },
                                    "name": "[replace(parameters('tier').namingConvention.virtualMachineDisk, parameters('tokens').purpose, variables('workload'))]"
                                  },
                                  "dataDisks": []
                                },
                                "osProfile": {
                                  "adminPassword": "[parameters('virtualMachineAdminPassword')]",
                                  "adminUsername": "[parameters('virtualMachineAdminUsername')]",
                                  "computerName": "[variables('virtualMachineName')]",
                                  "windowsConfiguration": {
                                    "provisionVMAgent": true,
                                    "enableAutomaticUpdates": false
                                  },
                                  "secrets": [],
                                  "allowExtensionOperations": true
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk'))]",
                                      "properties": {
                                        "deleteOption": "Delete"
                                      }
                                    }
                                  ]
                                },
                                "securityProfile": {
                                  "uefiSettings": {
                                    "secureBootEnabled": true,
                                    "vTpmEnabled": true
                                  },
                                  "securityType": "TrustedLaunch",
                                  "encryptionAtHost": true
                                },
                                "diagnosticsProfile": {
                                  "bootDiagnostics": {
                                    "enabled": false
                                  }
                                },
                                "licenseType": "Windows_Server"
                              },
                              "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')))]": {}
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk'))]",
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '136d308c-0937-4a49-9bd7-edfb42adbffc', resourceGroup().id)]",
                              "properties": {
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '136d308c-0937-4a49-9bd7-edfb42adbffc')]",
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "scope": "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]",
                              "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '9980e02c-c2be-4d73-94e8-173b1dc7cf3c', resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName')))]",
                              "properties": {
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '9980e02c-c2be-4d73-94e8-173b1dc7cf3c')]",
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.KeyVault/vaults",
                              "apiVersion": "2022-07-01",
                              "name": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "enabledForDeployment": false,
                                "enabledForDiskEncryption": false,
                                "enabledForTemplateDeployment": false,
                                "enablePurgeProtection": true,
                                "enableRbacAuthorization": true,
                                "enableSoftDelete": true,
                                "networkAcls": {
                                  "bypass": "AzureServices",
                                  "defaultAction": "Deny",
                                  "ipRules": [],
                                  "virtualNetworkRules": []
                                },
                                "publicNetworkAccess": "Disabled",
                                "sku": {
                                  "family": "A",
                                  "name": "premium"
                                },
                                "softDeleteRetentionInDays": "[if(or(equals(parameters('environmentAbbreviation'), 'dev'), equals(parameters('environmentAbbreviation'), 'test')), 7, 90)]",
                                "tenantId": "[subscription().tenantId]"
                              }
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "scope": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                              "name": "[guid(variables('userAssignedIdentityName'), '00482a5a-887f-4fb3-b363-3b7fe8e74483', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))))]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "scope": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                              "name": "[guid(variables('userAssignedIdentityName'), 'f25e0fa2-a7c8-4377-a976-54943a77a395', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))))]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'f25e0fa2-a7c8-4377-a976-54943a77a395')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('type'), 'storageAccount')]",
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[guid(variables('userAssignedIdentityName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceGroup().id)]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints",
                              "apiVersion": "2023-04-01",
                              "name": "[variables('keyVaultPrivateEndpointName')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "customNetworkInterfaceName": "[replace(parameters('tier').namingConvention.keyVaultNetworkInterface, parameters('tokens').purpose, variables('workload'))]",
                                "privateLinkServiceConnections": [
                                  {
                                    "name": "[variables('keyVaultPrivateEndpointName')]",
                                    "properties": {
                                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                      "groupIds": [
                                        "vault"
                                      ]
                                    }
                                  }
                                ],
                                "subnet": {
                                  "id": "[parameters('subnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '136d308c-0937-4a49-9bd7-edfb42adbffc', resourceGroup().id))]",
                                "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), 'Microsoft.Authorization/roleAssignments', guid(variables('userAssignedIdentityName'), '00482a5a-887f-4fb3-b363-3b7fe8e74483', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))))]",
                                "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), 'Microsoft.Authorization/roleAssignments', guid(variables('userAssignedIdentityName'), 'f25e0fa2-a7c8-4377-a976-54943a77a395', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))))]",
                                "[extensionResourceId(resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '9980e02c-c2be-4d73-94e8-173b1dc7cf3c', resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2021-08-01",
                              "name": "[format('{0}/{1}', variables('keyVaultPrivateEndpointName'), format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                              "properties": {
                                "privateDnsZoneConfigs": [
                                  {
                                    "name": "ipconfig1",
                                    "properties": {
                                      "privateDnsZoneId": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                                    }
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2025-04-01",
                              "name": "[format('{0}/{1}', variables('virtualMachineName'), parameters('keyName'))]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "asyncExecution": false,
                                "parameters": [
                                  {
                                    "name": "DiskEncryptionSetName",
                                    "value": "[replace(parameters('tier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, variables('workload'))]"
                                  },
                                  {
                                    "name": "KeyExpirationInDays",
                                    "value": "[string(parameters('keyExpirationInDays'))]"
                                  },
                                  {
                                    "name": "KeyName",
                                    "value": "[parameters('keyName')]"
                                  },
                                  {
                                    "name": "KeyVaultResourceId",
                                    "value": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                  },
                                  {
                                    "name": "KeyVaultServiceUri",
                                    "value": "[format('https://{0}', skip(environment().suffixes.keyvaultDns, 1))]"
                                  },
                                  {
                                    "name": "KeyVaultUri",
                                    "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), '2022-07-01').vaultUri]"
                                  },
                                  {
                                    "name": "Location",
                                    "value": "[parameters('location')]"
                                  },
                                  {
                                    "name": "ResourceGroupName",
                                    "value": "[variables('resourceGroupName')]"
                                  },
                                  {
                                    "name": "ResourceManagerUri",
                                    "value": "[environment().resourceManager]"
                                  },
                                  {
                                    "name": "SubscriptionId",
                                    "value": "[parameters('tier').subscriptionId]"
                                  },
                                  {
                                    "name": "Type",
                                    "value": "[parameters('type')]"
                                  },
                                  {
                                    "name": "UserAssignedIdentityClientId",
                                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').clientId]"
                                  }
                                ],
                                "source": {
                                  "script": "[variables('$fxv#0')]"
                                },
                                "treatFailureAsDeploymentFailure": true
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', variables('keyVaultPrivateEndpointName'), format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                "[resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName'))]",
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2023-09-01",
                              "name": "[format('{0}/{1}', variables('virtualMachineName'), format('delete-vm-{0}', parameters('deploymentNameSuffix')))]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "asyncExecution": true,
                                "parameters": [
                                  {
                                    "name": "ResourceGroupName",
                                    "value": "[variables('resourceGroupName')]"
                                  },
                                  {
                                    "name": "ResourceManagerUri",
                                    "value": "[environment().resourceManager]"
                                  },
                                  {
                                    "name": "UserAssignedIdentityClientId",
                                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').clientId]"
                                  },
                                  {
                                    "name": "VirtualMachineResourceId",
                                    "value": "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                                  }
                                ],
                                "source": {
                                  "script": "[variables('$fxv#1')]"
                                },
                                "treatFailureAsDeploymentFailure": true
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Resources/deployments', format('deploy-des-{0}', parameters('deploymentNameSuffix')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', variables('virtualMachineName'), parameters('keyName'))]",
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('type'), 'virtualMachine')]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-des-{0}', parameters('deploymentNameSuffix'))]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "diskEncryptionSetName": {
                                    "value": "[replace(parameters('tier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, variables('workload'))]"
                                  },
                                  "keyVaultName": {
                                    "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "15118251701077090282"
                                    }
                                  },
                                  "parameters": {
                                    "diskEncryptionSetName": {
                                      "type": "string"
                                    },
                                    "keyVaultName": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "scope": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                                      "name": "[guid(parameters('diskEncryptionSetName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')))]",
                                      "properties": {
                                        "principalId": "[reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName')), '2023-04-02', 'full').identity.principalId]",
                                        "principalType": "ServicePrincipal",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "resourceId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName'))]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', variables('virtualMachineName'), parameters('keyName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "diskEncryptionSetResourceId": {
                              "type": "string",
                              "value": "[if(equals(parameters('type'), 'virtualMachine'), reference(resourceId('Microsoft.Resources/deployments', format('deploy-des-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value, '')]"
                            },
                            "keyVaultProperties": {
                              "type": "object",
                              "value": {
                                "diagnosticSettingName": "[replace(parameters('tier').namingConvention.keyVaultDiagnosticSetting, parameters('tokens').purpose, variables('workload'))]",
                                "name": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]",
                                "resourceGroupName": "[variables('resourceGroupName')]",
                                "subscriptionId": "[parameters('tier').subscriptionId]",
                                "tierName": "[parameters('tier').name]"
                              }
                            },
                            "keyName": {
                              "type": "string",
                              "value": "[parameters('keyName')]"
                            },
                            "keyVaultName": {
                              "type": "string",
                              "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]"
                            },
                            "keyVaultUri": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), '2022-07-01').vaultUri]"
                            },
                            "keyVaultResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                            },
                            "keyVaultNetworkInterfaceResourceId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName')), '2023-04-01').networkInterfaces[0].id]"
                            },
                            "userAssignedIdentityResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
                      ]
                    },
                    {
                      "condition": "[parameters('deployLinuxVirtualMachine')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-ra-linux-vm-{0}', parameters('deploymentNameSuffix'))]",
                      "resourceGroup": "[variables('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "adminPasswordOrKey": {
                            "value": "[parameters('linuxVmAdminPasswordOrKey')]"
                          },
                          "adminUsername": {
                            "value": "[parameters('linuxVmAdminUsername')]"
                          },
                          "authenticationType": {
                            "value": "[parameters('linuxVmAuthenticationType')]"
                          },
                          "diskEncryptionSetResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-ra-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.diskEncryptionSetResourceId.value]"
                          },
                          "diskName": {
                            "value": "[replace(parameters('tier').namingConvention.virtualMachineDisk, parameters('tokens').purpose, 'lra')]"
                          },
                          "imageOffer": {
                            "value": "[parameters('linuxVmImageOffer')]"
                          },
                          "imagePublisher": {
                            "value": "[parameters('linuxVmImagePublisher')]"
                          },
                          "imageSku": {
                            "value": "[parameters('linuxVmImageSku')]"
                          },
                          "imageVersion": {
                            "value": "[parameters('linuxVmImageVersion')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "networkInterfaceName": {
                            "value": "[replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'lra')]"
                          },
                          "networkSecurityGroupResourceId": {
                            "value": "[parameters('tier').networkSecurityGroupResourceId]"
                          },
                          "storageAccountType": {
                            "value": "[parameters('linuxVmOsDiskType')]"
                          },
                          "subnetResourceId": {
                            "value": "[parameters('tier').subnetResourceId]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "virtualMachineName": {
                            "value": "[replace(parameters('tier').namingConvention.virtualMachine, parameters('tokens').purpose, 'lra')]"
                          },
                          "virtualMachineSize": {
                            "value": "[parameters('linuxVmSize')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "16794041801135670912"
                            }
                          },
                          "parameters": {
                            "adminPasswordOrKey": {
                              "type": "securestring",
                              "minLength": 12
                            },
                            "adminUsername": {
                              "type": "string"
                            },
                            "authenticationType": {
                              "type": "string",
                              "allowedValues": [
                                "sshPublicKey",
                                "password"
                              ]
                            },
                            "availabilitySetResourceId": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "dataDisks": {
                              "type": "array",
                              "defaultValue": []
                            },
                            "diskCaching": {
                              "type": "string",
                              "defaultValue": "ReadWrite"
                            },
                            "diskEncryptionSetResourceId": {
                              "type": "string"
                            },
                            "diskName": {
                              "type": "string"
                            },
                            "domainJoin": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "domainName": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "hybridUseBenefit": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "imageOffer": {
                              "type": "string"
                            },
                            "imagePublisher": {
                              "type": "string"
                            },
                            "imageSku": {
                              "type": "string"
                            },
                            "imageVersion": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "networkInterfaceName": {
                              "type": "string"
                            },
                            "networkSecurityGroupResourceId": {
                              "type": "string"
                            },
                            "privateIPAddress": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "storageAccountType": {
                              "type": "string"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "timestamp": {
                              "type": "string",
                              "defaultValue": "[utcNow('yyyyMMddhhmmss')]"
                            },
                            "virtualMachineName": {
                              "type": "string"
                            },
                            "virtualMachineSize": {
                              "type": "string"
                            }
                          },
                          "variables": {
                            "osType": "[if(contains(parameters('imagePublisher'), 'Windows'), 'Windows', 'Linux')]",
                            "linuxConfiguration": {
                              "disablePasswordAuthentication": true,
                              "ssh": {
                                "publicKeys": [
                                  {
                                    "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                                    "keyData": "[parameters('adminPasswordOrKey')]"
                                  }
                                ]
                              }
                            },
                            "dependencyAgentSupport": [
                              "74-gen2",
                              "75-gen2",
                              "76-gen2",
                              "77-gen2",
                              "78-gen2",
                              "79-gen2",
                              "8-gen2",
                              "8-lvm-gen2",
                              "81-ci-gen2",
                              "81gen2",
                              "82-gen2",
                              "83-gen2",
                              "84-gen2",
                              "85-gen2",
                              "86-gen2",
                              "16_04-daily-lts-gen2",
                              "16_04-lts-gen2",
                              "16_04_0-lts-gen2",
                              "18_04-daily-lts-gen2",
                              "18_04-lts-gen2",
                              "20_04-lts-gen2",
                              "2016-Datacenter",
                              "2016-datacenter-gensecond",
                              "2016-datacenter-gs",
                              "2016-Datacenter-smalldisk",
                              "2016-datacenter-smalldisk-g2",
                              "2016-Datacenter-with-Containers",
                              "2016-datacenter-with-containers-g2",
                              "2016-Datacenter-zhcn",
                              "2016-datacenter-zhcn-g2",
                              "2019-Datacenter",
                              "2019-datacenter-gensecond",
                              "2019-datacenter-gs",
                              "2019-datacenter-gs-g2",
                              "2019-Datacenter-smalldisk",
                              "2019-datacenter-smalldisk-g2",
                              "2019-Datacenter-with-Containers",
                              "2019-datacenter-with-containers-g2",
                              "2019-datacenter-with-containers-gs",
                              "2019-Datacenter-with-Containers-smalldisk",
                              "2019-datacenter-with-containers-smalldisk-g2",
                              "2019-Datacenter-zhcn",
                              "2019-datacenter-zhcn-g2",
                              "2022-datacenter",
                              "2022-datacenter-azure-edition",
                              "2022-datacenter-azure-edition-core",
                              "2022-datacenter-azure-edition-core-smalldisk",
                              "2022-datacenter-azure-edition-hotpatch",
                              "2022-datacenter-azure-edition-hotpatch-smalldisk",
                              "2022-datacenter-azure-edition-smalldisk",
                              "2022-datacenter-core",
                              "2022-datacenter-core-g2",
                              "2022-datacenter-core-smalldisk",
                              "2022-datacenter-core-smalldisk-g2",
                              "2022-datacenter-g2",
                              "2022-datacenter-smalldisk",
                              "2022-datacenter-smalldisk-g2"
                            ]
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/networkInterfaces",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('networkInterfaceName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkInterfaces'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "enableAcceleratedNetworking": true,
                                "ipConfigurations": [
                                  {
                                    "name": "ipconfig",
                                    "properties": {
                                      "privateIPAddress": "[if(empty(parameters('privateIPAddress')), null(), parameters('privateIPAddress'))]",
                                      "privateIPAllocationMethod": "[if(empty(parameters('privateIPAddress')), 'Dynamic', 'Static')]",
                                      "subnet": {
                                        "id": "[parameters('subnetResourceId')]"
                                      }
                                    }
                                  }
                                ],
                                "networkSecurityGroup": {
                                  "id": "[parameters('networkSecurityGroupResourceId')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2024-11-01",
                              "name": "[parameters('virtualMachineName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "properties": {
                                "availabilitySet": "[if(empty(parameters('availabilitySetResourceId')), null(), createObject('id', parameters('availabilitySetResourceId')))]",
                                "diagnosticsProfile": {
                                  "bootDiagnostics": {
                                    "enabled": false
                                  }
                                },
                                "hardwareProfile": {
                                  "vmSize": "[parameters('virtualMachineSize')]"
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]",
                                      "properties": {
                                        "deleteOption": "Delete"
                                      }
                                    }
                                  ]
                                },
                                "osProfile": {
                                  "computerName": "[take(parameters('virtualMachineName'), 15)]",
                                  "adminUsername": "[parameters('adminUsername')]",
                                  "adminPassword": "[parameters('adminPasswordOrKey')]",
                                  "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), null(), variables('linuxConfiguration'))]"
                                },
                                "securityProfile": {
                                  "uefiSettings": {
                                    "secureBootEnabled": true,
                                    "vTpmEnabled": true
                                  },
                                  "securityType": "trustedLaunch",
                                  "encryptionAtHost": true
                                },
                                "storageProfile": {
                                  "dataDisks": "[parameters('dataDisks')]",
                                  "imageReference": {
                                    "publisher": "[parameters('imagePublisher')]",
                                    "offer": "[parameters('imageOffer')]",
                                    "sku": "[parameters('imageSku')]",
                                    "version": "[parameters('imageVersion')]"
                                  },
                                  "osDisk": {
                                    "caching": "[parameters('diskCaching')]",
                                    "createOption": "FromImage",
                                    "deleteOption": "Delete",
                                    "managedDisk": {
                                      "diskEncryptionSet": {
                                        "id": "[parameters('diskEncryptionSetResourceId')]"
                                      },
                                      "storageAccountType": "[parameters('storageAccountType')]"
                                    },
                                    "name": "[parameters('diskName')]",
                                    "osType": "[variables('osType')]"
                                  }
                                },
                                "licenseType": "[if(parameters('hybridUseBenefit'), 'Windows_Server', null())]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'GuestAttestation')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "autoUpgradeMinorVersion": true,
                                "enableAutomaticUpgrade": true,
                                "publisher": "[format('Microsoft.Azure.Security.{0}Attestation', variables('osType'))]",
                                "settings": {
                                  "AttestationConfig": {
                                    "AscSettings": {
                                      "ascReportingEndpoint": "",
                                      "ascReportingFrequency": ""
                                    },
                                    "disableAlerts": "false",
                                    "MaaSettings": {
                                      "maaEndpoint": "",
                                      "maaTenantName": "GuestAttestation"
                                    },
                                    "useCustomToken": "false"
                                  }
                                },
                                "type": "GuestAttestation",
                                "typeHandlerVersion": "1.0"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "autoUpgradeMinorVersion": true,
                                "enableAutomaticUpgrade": true,
                                "publisher": "Microsoft.GuestConfiguration",
                                "type": "[format('Configurationfor{0}', variables('osType'))]",
                                "typeHandlerVersion": "1.0"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "autoUpgradeMinorVersion": true,
                                "enableAutomaticUpgrade": true,
                                "publisher": "Microsoft.Azure.NetworkWatcher",
                                "type": "[format('NetworkWatcherAgent{0}', variables('osType'))]",
                                "typeHandlerVersion": "1.4"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('AzureMonitor{0}Agent', variables('osType')))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "autoUpgradeMinorVersion": true,
                                "enableAutomaticUpgrade": true,
                                "publisher": "Microsoft.Azure.Monitor",
                                "settings": "[if(equals(variables('osType'), 'Windows'), createObject(), createObject('stopOnMultipleConnections', true()))]",
                                "type": "[format('AzureMonitor{0}Agent', variables('osType'))]",
                                "typeHandlerVersion": "1.0"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "condition": "[contains(variables('dependencyAgentSupport'), parameters('imageSku'))]",
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('DependencyAgent{0}', variables('osType')))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "publisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                                "type": "[format('DependencyAgent{0}', variables('osType'))]",
                                "typeHandlerVersion": "9.5",
                                "autoUpgradeMinorVersion": true
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "condition": "[parameters('domainJoin')]",
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2021-03-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'JsonADDomainExtension')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "forceUpdateTag": "[parameters('timestamp')]",
                                "publisher": "Microsoft.Compute",
                                "type": "JsonADDomainExtension",
                                "typeHandlerVersion": "1.3",
                                "autoUpgradeMinorVersion": true,
                                "settings": {
                                  "Name": "[parameters('domainName')]",
                                  "Options": "3",
                                  "Restart": "true",
                                  "User": "[format('{0}@{1}', parameters('adminUsername'), parameters('domainName'))]"
                                },
                                "protectedSettings": {
                                  "Password": "[parameters('adminPasswordOrKey')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('AzureMonitor{0}Agent', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('DependencyAgent{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), 'GuestAttestation')]",
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "networkInterfaceResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                            },
                            "virtualMachineResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                            },
                            "virtualMachinePrincipalId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName')), '2024-11-01', 'full').identity.principalId]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-ra-cmk-{0}', parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
                      ]
                    },
                    {
                      "condition": "[parameters('deployWindowsVirtualMachine')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-ra-windows-vm-{0}', parameters('deploymentNameSuffix'))]",
                      "resourceGroup": "[variables('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "adminPasswordOrKey": {
                            "value": "[parameters('windowsVmAdminPassword')]"
                          },
                          "adminUsername": {
                            "value": "[parameters('windowsVmAdminUsername')]"
                          },
                          "authenticationType": {
                            "value": "password"
                          },
                          "diskEncryptionSetResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-ra-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.diskEncryptionSetResourceId.value]"
                          },
                          "diskName": {
                            "value": "[replace(parameters('tier').namingConvention.virtualMachineDisk, parameters('tokens').purpose, 'wra')]"
                          },
                          "hybridUseBenefit": {
                            "value": "[parameters('hybridUseBenefit')]"
                          },
                          "imageOffer": {
                            "value": "[parameters('windowsVmImageOffer')]"
                          },
                          "imagePublisher": {
                            "value": "[parameters('windowsVmImagePublisher')]"
                          },
                          "imageSku": {
                            "value": "[parameters('windowsVmImageSku')]"
                          },
                          "imageVersion": {
                            "value": "[parameters('windowsVmVersion')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "networkInterfaceName": {
                            "value": "[replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'wra')]"
                          },
                          "networkSecurityGroupResourceId": {
                            "value": "[parameters('tier').networkSecurityGroupResourceId]"
                          },
                          "storageAccountType": {
                            "value": "[parameters('windowsVmStorageAccountType')]"
                          },
                          "subnetResourceId": {
                            "value": "[parameters('tier').subnetResourceId]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "virtualMachineName": {
                            "value": "[replace(parameters('tier').namingConvention.virtualMachine, parameters('tokens').purpose, 'wra')]"
                          },
                          "virtualMachineSize": {
                            "value": "[parameters('windowsVmSize')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "16794041801135670912"
                            }
                          },
                          "parameters": {
                            "adminPasswordOrKey": {
                              "type": "securestring",
                              "minLength": 12
                            },
                            "adminUsername": {
                              "type": "string"
                            },
                            "authenticationType": {
                              "type": "string",
                              "allowedValues": [
                                "sshPublicKey",
                                "password"
                              ]
                            },
                            "availabilitySetResourceId": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "dataDisks": {
                              "type": "array",
                              "defaultValue": []
                            },
                            "diskCaching": {
                              "type": "string",
                              "defaultValue": "ReadWrite"
                            },
                            "diskEncryptionSetResourceId": {
                              "type": "string"
                            },
                            "diskName": {
                              "type": "string"
                            },
                            "domainJoin": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "domainName": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "hybridUseBenefit": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "imageOffer": {
                              "type": "string"
                            },
                            "imagePublisher": {
                              "type": "string"
                            },
                            "imageSku": {
                              "type": "string"
                            },
                            "imageVersion": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "networkInterfaceName": {
                              "type": "string"
                            },
                            "networkSecurityGroupResourceId": {
                              "type": "string"
                            },
                            "privateIPAddress": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "storageAccountType": {
                              "type": "string"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "timestamp": {
                              "type": "string",
                              "defaultValue": "[utcNow('yyyyMMddhhmmss')]"
                            },
                            "virtualMachineName": {
                              "type": "string"
                            },
                            "virtualMachineSize": {
                              "type": "string"
                            }
                          },
                          "variables": {
                            "osType": "[if(contains(parameters('imagePublisher'), 'Windows'), 'Windows', 'Linux')]",
                            "linuxConfiguration": {
                              "disablePasswordAuthentication": true,
                              "ssh": {
                                "publicKeys": [
                                  {
                                    "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                                    "keyData": "[parameters('adminPasswordOrKey')]"
                                  }
                                ]
                              }
                            },
                            "dependencyAgentSupport": [
                              "74-gen2",
                              "75-gen2",
                              "76-gen2",
                              "77-gen2",
                              "78-gen2",
                              "79-gen2",
                              "8-gen2",
                              "8-lvm-gen2",
                              "81-ci-gen2",
                              "81gen2",
                              "82-gen2",
                              "83-gen2",
                              "84-gen2",
                              "85-gen2",
                              "86-gen2",
                              "16_04-daily-lts-gen2",
                              "16_04-lts-gen2",
                              "16_04_0-lts-gen2",
                              "18_04-daily-lts-gen2",
                              "18_04-lts-gen2",
                              "20_04-lts-gen2",
                              "2016-Datacenter",
                              "2016-datacenter-gensecond",
                              "2016-datacenter-gs",
                              "2016-Datacenter-smalldisk",
                              "2016-datacenter-smalldisk-g2",
                              "2016-Datacenter-with-Containers",
                              "2016-datacenter-with-containers-g2",
                              "2016-Datacenter-zhcn",
                              "2016-datacenter-zhcn-g2",
                              "2019-Datacenter",
                              "2019-datacenter-gensecond",
                              "2019-datacenter-gs",
                              "2019-datacenter-gs-g2",
                              "2019-Datacenter-smalldisk",
                              "2019-datacenter-smalldisk-g2",
                              "2019-Datacenter-with-Containers",
                              "2019-datacenter-with-containers-g2",
                              "2019-datacenter-with-containers-gs",
                              "2019-Datacenter-with-Containers-smalldisk",
                              "2019-datacenter-with-containers-smalldisk-g2",
                              "2019-Datacenter-zhcn",
                              "2019-datacenter-zhcn-g2",
                              "2022-datacenter",
                              "2022-datacenter-azure-edition",
                              "2022-datacenter-azure-edition-core",
                              "2022-datacenter-azure-edition-core-smalldisk",
                              "2022-datacenter-azure-edition-hotpatch",
                              "2022-datacenter-azure-edition-hotpatch-smalldisk",
                              "2022-datacenter-azure-edition-smalldisk",
                              "2022-datacenter-core",
                              "2022-datacenter-core-g2",
                              "2022-datacenter-core-smalldisk",
                              "2022-datacenter-core-smalldisk-g2",
                              "2022-datacenter-g2",
                              "2022-datacenter-smalldisk",
                              "2022-datacenter-smalldisk-g2"
                            ]
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/networkInterfaces",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('networkInterfaceName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkInterfaces'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "enableAcceleratedNetworking": true,
                                "ipConfigurations": [
                                  {
                                    "name": "ipconfig",
                                    "properties": {
                                      "privateIPAddress": "[if(empty(parameters('privateIPAddress')), null(), parameters('privateIPAddress'))]",
                                      "privateIPAllocationMethod": "[if(empty(parameters('privateIPAddress')), 'Dynamic', 'Static')]",
                                      "subnet": {
                                        "id": "[parameters('subnetResourceId')]"
                                      }
                                    }
                                  }
                                ],
                                "networkSecurityGroup": {
                                  "id": "[parameters('networkSecurityGroupResourceId')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2024-11-01",
                              "name": "[parameters('virtualMachineName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "properties": {
                                "availabilitySet": "[if(empty(parameters('availabilitySetResourceId')), null(), createObject('id', parameters('availabilitySetResourceId')))]",
                                "diagnosticsProfile": {
                                  "bootDiagnostics": {
                                    "enabled": false
                                  }
                                },
                                "hardwareProfile": {
                                  "vmSize": "[parameters('virtualMachineSize')]"
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]",
                                      "properties": {
                                        "deleteOption": "Delete"
                                      }
                                    }
                                  ]
                                },
                                "osProfile": {
                                  "computerName": "[take(parameters('virtualMachineName'), 15)]",
                                  "adminUsername": "[parameters('adminUsername')]",
                                  "adminPassword": "[parameters('adminPasswordOrKey')]",
                                  "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), null(), variables('linuxConfiguration'))]"
                                },
                                "securityProfile": {
                                  "uefiSettings": {
                                    "secureBootEnabled": true,
                                    "vTpmEnabled": true
                                  },
                                  "securityType": "trustedLaunch",
                                  "encryptionAtHost": true
                                },
                                "storageProfile": {
                                  "dataDisks": "[parameters('dataDisks')]",
                                  "imageReference": {
                                    "publisher": "[parameters('imagePublisher')]",
                                    "offer": "[parameters('imageOffer')]",
                                    "sku": "[parameters('imageSku')]",
                                    "version": "[parameters('imageVersion')]"
                                  },
                                  "osDisk": {
                                    "caching": "[parameters('diskCaching')]",
                                    "createOption": "FromImage",
                                    "deleteOption": "Delete",
                                    "managedDisk": {
                                      "diskEncryptionSet": {
                                        "id": "[parameters('diskEncryptionSetResourceId')]"
                                      },
                                      "storageAccountType": "[parameters('storageAccountType')]"
                                    },
                                    "name": "[parameters('diskName')]",
                                    "osType": "[variables('osType')]"
                                  }
                                },
                                "licenseType": "[if(parameters('hybridUseBenefit'), 'Windows_Server', null())]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'GuestAttestation')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "autoUpgradeMinorVersion": true,
                                "enableAutomaticUpgrade": true,
                                "publisher": "[format('Microsoft.Azure.Security.{0}Attestation', variables('osType'))]",
                                "settings": {
                                  "AttestationConfig": {
                                    "AscSettings": {
                                      "ascReportingEndpoint": "",
                                      "ascReportingFrequency": ""
                                    },
                                    "disableAlerts": "false",
                                    "MaaSettings": {
                                      "maaEndpoint": "",
                                      "maaTenantName": "GuestAttestation"
                                    },
                                    "useCustomToken": "false"
                                  }
                                },
                                "type": "GuestAttestation",
                                "typeHandlerVersion": "1.0"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "autoUpgradeMinorVersion": true,
                                "enableAutomaticUpgrade": true,
                                "publisher": "Microsoft.GuestConfiguration",
                                "type": "[format('Configurationfor{0}', variables('osType'))]",
                                "typeHandlerVersion": "1.0"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "autoUpgradeMinorVersion": true,
                                "enableAutomaticUpgrade": true,
                                "publisher": "Microsoft.Azure.NetworkWatcher",
                                "type": "[format('NetworkWatcherAgent{0}', variables('osType'))]",
                                "typeHandlerVersion": "1.4"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('AzureMonitor{0}Agent', variables('osType')))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "autoUpgradeMinorVersion": true,
                                "enableAutomaticUpgrade": true,
                                "publisher": "Microsoft.Azure.Monitor",
                                "settings": "[if(equals(variables('osType'), 'Windows'), createObject(), createObject('stopOnMultipleConnections', true()))]",
                                "type": "[format('AzureMonitor{0}Agent', variables('osType'))]",
                                "typeHandlerVersion": "1.0"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "condition": "[contains(variables('dependencyAgentSupport'), parameters('imageSku'))]",
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('DependencyAgent{0}', variables('osType')))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "publisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                                "type": "[format('DependencyAgent{0}', variables('osType'))]",
                                "typeHandlerVersion": "9.5",
                                "autoUpgradeMinorVersion": true
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "condition": "[parameters('domainJoin')]",
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2021-03-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'JsonADDomainExtension')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "forceUpdateTag": "[parameters('timestamp')]",
                                "publisher": "Microsoft.Compute",
                                "type": "JsonADDomainExtension",
                                "typeHandlerVersion": "1.3",
                                "autoUpgradeMinorVersion": true,
                                "settings": {
                                  "Name": "[parameters('domainName')]",
                                  "Options": "3",
                                  "Restart": "true",
                                  "User": "[format('{0}@{1}', parameters('adminUsername'), parameters('domainName'))]"
                                },
                                "protectedSettings": {
                                  "Password": "[parameters('adminPasswordOrKey')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('AzureMonitor{0}Agent', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('DependencyAgent{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), 'GuestAttestation')]",
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "networkInterfaceResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                            },
                            "virtualMachineResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                            },
                            "virtualMachinePrincipalId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName')), '2024-11-01', 'full').identity.principalId]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-ra-cmk-{0}', parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
                      ]
                    },
                    {
                      "condition": "[parameters('deployBastion')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-ra-bastion-host-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('tier').resourceGroupName]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "bastionHostSubnetResourceId": {
                            "value": "[parameters('bastionHostSubnetResourceId')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[replace(parameters('tier').namingConvention.bastionHost, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "publicIPAddressAllocationMethod": {
                            "value": "[parameters('bastionHostPublicIPAddressAllocationMethod')]"
                          },
                          "publicIPAddressAvailabilityZones": {
                            "value": "[parameters('bastionHostPublicIPAddressAvailabilityZones')]"
                          },
                          "publicIPAddressName": {
                            "value": "[replace(parameters('tier').namingConvention.bastionHostPublicIPAddress, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "publicIPAddressSkuName": {
                            "value": "[parameters('bastionHostPublicIPAddressSkuName')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "10593072565586641177"
                            }
                          },
                          "parameters": {
                            "bastionHostSubnetResourceId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "publicIPAddressAllocationMethod": {
                              "type": "string"
                            },
                            "publicIPAddressAvailabilityZones": {
                              "type": "array"
                            },
                            "publicIPAddressName": {
                              "type": "string"
                            },
                            "publicIPAddressSkuName": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/publicIPAddresses",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('publicIPAddressName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/publicIPAddresses'), createObject()), parameters('mlzTags'))]",
                              "sku": {
                                "name": "[parameters('publicIPAddressSkuName')]"
                              },
                              "properties": {
                                "publicIPAllocationMethod": "[parameters('publicIPAddressAllocationMethod')]"
                              },
                              "zones": "[parameters('publicIPAddressAvailabilityZones')]"
                            },
                            {
                              "type": "Microsoft.Network/bastionHosts",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/bastionHosts'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "ipConfigurations": [
                                  {
                                    "name": "ipconfig",
                                    "properties": {
                                      "subnet": {
                                        "id": "[parameters('bastionHostSubnetResourceId')]"
                                      },
                                      "publicIPAddress": {
                                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddressName'))]"
                                      }
                                    }
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddressName'))]"
                              ]
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "keyVaultProperties": {
                      "type": "object",
                      "value": "[if(or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-ra-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultProperties.value, createObject())]"
                    },
                    "networkInterfaceResourceIds": {
                      "type": "array",
                      "value": "[union(if(or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), createArray(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-ra-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultNetworkInterfaceResourceId.value), createArray()), if(parameters('deployLinuxVirtualMachine'), createArray(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-ra-linux-vm-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value), createArray()), if(parameters('deployWindowsVirtualMachine'), createArray(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-ra-windows-vm-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value), createArray()))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-diag-storage-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('hubSubscriptionId')]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "delimiter": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "environmentAbbreviation": {
                    "value": "[parameters('environmentAbbreviation')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "logStorageSkuName": {
                    "value": "[parameters('logStorageSkuName')]"
                  },
                  "mlzTags": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                  },
                  "privateDnsZoneResourceIds": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value]"
                  },
                  "purpose": {
                    "value": "diag"
                  },
                  "resourceAbbreviations": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tiers": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value]"
                  },
                  "tokens": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "9153816190980352420"
                    }
                  },
                  "parameters": {
                    "delimiter": {
                      "type": "string"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "environmentAbbreviation": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "logStorageSkuName": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "privateDnsZoneResourceIds": {
                      "type": "object"
                    },
                    "purpose": {
                      "type": "string"
                    },
                    "resourceAbbreviations": {
                      "type": "object"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "tiers": {
                      "type": "array"
                    },
                    "tokens": {
                      "type": "object"
                    }
                  },
                  "variables": {
                    "resourceGroupName": "[filter(parameters('tiers'), lambda('tier', equals(lambdaVariables('tier').name, 'hub')))[0].resourceGroupName]",
                    "subscriptionId": "[filter(parameters('tiers'), lambda('tier', equals(lambdaVariables('tier').name, 'hub')))[0].subscriptionId]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-st-cmk-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[variables('subscriptionId')]",
                      "resourceGroup": "[variables('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "environmentAbbreviation": {
                            "value": "[parameters('environmentAbbreviation')]"
                          },
                          "keyName": {
                            "value": "StorageEncryptionKey"
                          },
                          "keyVaultPrivateDnsZoneResourceId": {
                            "value": "[parameters('privateDnsZoneResourceIds').keyVault]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "resourceAbbreviations": {
                            "value": "[parameters('resourceAbbreviations')]"
                          },
                          "subnetResourceId": {
                            "value": "[filter(parameters('tiers'), lambda('tier', equals(lambdaVariables('tier').name, 'hub')))[0].subnetResourceId]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "tier": {
                            "value": "[filter(parameters('tiers'), lambda('tier', equals(lambdaVariables('tier').name, 'hub')))[0]]"
                          },
                          "tokens": {
                            "value": "[parameters('tokens')]"
                          },
                          "type": {
                            "value": "storageAccount"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "16154764937040063236"
                            }
                          },
                          "parameters": {
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "environmentAbbreviation": {
                              "type": "string"
                            },
                            "keyExpirationInDays": {
                              "type": "int",
                              "defaultValue": 30
                            },
                            "keyName": {
                              "type": "string"
                            },
                            "keyVaultPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "resourceAbbreviations": {
                              "type": "object"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "tier": {
                              "type": "object"
                            },
                            "tokens": {
                              "type": "object"
                            },
                            "type": {
                              "type": "string",
                              "allowedValues": [
                                "storageAccount",
                                "virtualMachine"
                              ]
                            },
                            "virtualMachineAdminPassword": {
                              "type": "securestring",
                              "defaultValue": "[newGuid()]"
                            },
                            "virtualMachineAdminUsername": {
                              "type": "string",
                              "defaultValue": "xadmin"
                            },
                            "virtualMachineSize": {
                              "type": "string",
                              "defaultValue": "Standard_D2ds_v4"
                            }
                          },
                          "variables": {
                            "$fxv#0": "Param(\r\n    [string]$DiskEncryptionSetName,\r\n    [int]$KeyExpirationInDays,\r\n    [string]$KeyName,\r\n    [string]$KeyVaultResourceId,\r\n    [string]$KeyVaultServiceUri,\r\n    [string]$KeyVaultUri,\r\n    [string]$Location,\r\n    [string]$ResourceGroupName,\r\n    [string]$ResourceManagerUri,\r\n    [string]$SubscriptionId,\r\n    [string]$Type,\r\n    [string]$UserAssignedIdentityClientId\r\n)\r\n\r\n$ErrorActionPreference = 'Stop'\r\n$WarningPreference = 'SilentlyContinue'\r\n\r\n# Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n$ResourceManagerUriFixed = if ($ResourceManagerUri[-1] -eq '/') { $ResourceManagerUri.Substring(0, $ResourceManagerUri.Length - 1) } else { $ResourceManagerUri }\r\n\r\n# Get an access token for Azure resources\r\n$KeyVaultAccessToken = (Invoke-RestMethod `\r\n        -Headers @{Metadata = \"true\" } `\r\n        -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $KeyVaultServiceUri + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n# Set header for Azure Management API\r\n$KeyVaultHeaders = @{\r\n    'Content-Type'  = 'application/json'\r\n    'Authorization' = 'Bearer ' + $KeyVaultAccessToken\r\n}\r\n\r\n$Body = [PSCustomObject]@{\r\n    kty            = 'RSA-HSM'\r\n    key_size       = 4096\r\n    attributes     = @{\r\n        enabled = $true\r\n    }\r\n    rotationPolicy = @{\r\n        attributes      = @{\r\n            expiryTime = $('P' + $KeyExpirationInDays + 'D')\r\n        }\r\n        lifetimeActions = @(\r\n            @{\r\n                action  = @{\r\n                    type = 'Notify'\r\n                }\r\n                trigger = @{\r\n                    timeBeforeExpiry = 'P10D'\r\n                }\r\n            },\r\n            @{\r\n                action  = @{\r\n                    type = 'Rotate'\r\n                }\r\n                trigger = @{\r\n                    timeAfterCreate = $('P' + ($KeyExpirationInDays - 7) + 'D')\r\n                }\r\n            }\r\n        )\r\n    }\r\n}\r\n\r\n# Create key vault key\r\n$KeyUriWithVersion = (Invoke-RestMethod `\r\n        -Body ($Body | ConvertTo-Json -Depth 4) `\r\n        -Headers $KeyVaultHeaders `\r\n        -Method 'POST' `\r\n        -Uri $($KeyVaultUri + 'keys/' + $KeyName + '/create?api-version=2025-07-01')).key.kid\r\n\r\nif ($Type -eq 'virtualMachine') {\r\n\r\n    # Get an access token for Azure resources\r\n    $ResourceManagerAccessToken = (Invoke-RestMethod `\r\n            -Headers @{Metadata = \"true\" } `\r\n            -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n    # Set header for Azure Management API\r\n    $ResourceManagerHeaders = @{\r\n        'Content-Type'  = 'application/json'\r\n        'Authorization' = 'Bearer ' + $ResourceManagerAccessToken\r\n    }\r\n\r\n    $DiskEncryptionSetBody = @{\r\n        location   = $Location\r\n        identity   = @{\r\n            type = 'SystemAssigned'\r\n        }\r\n        properties = @{\r\n            activeKey                         = @{\r\n                sourceVault = @{\r\n                    id = $KeyVaultResourceId\r\n                }\r\n                keyUrl = $KeyUriWithVersion\r\n            }\r\n            encryptionType                    = 'EncryptionAtRestWithPlatformAndCustomerKeys'\r\n            rotationToLatestKeyVersionEnabled = $true\r\n        }\r\n    }\r\n\r\n    Invoke-RestMethod `\r\n        -Body ($DiskEncryptionSetBody | ConvertTo-Json -Depth 4) `\r\n        -Headers $ResourceManagerHeaders `\r\n        -Method 'PUT' `\r\n        -Uri $($ResourceManagerUriFixed + '/subscriptions/' + $SubscriptionId + '/resourceGroups/' + $ResourceGroupName + '/providers/Microsoft.Compute/diskEncryptionSets/' + $DiskEncryptionSetName + '?api-version=2025-01-02')\r\n}",
                            "$fxv#1": "param(\r\n    [string]$ResourceGroupName,\r\n    [string]$ResourceManagerUri,\r\n    [string]$UserAssignedIdentityClientId,\r\n    [string]$VirtualMachineResourceId\r\n)\r\n\r\n# Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n$ResourceManagerUriFixed = if($ResourceManagerUri[-1] -eq '/'){$ResourceManagerUri.Substring(0,$ResourceManagerUri.Length - 1)} else {$ResourceManagerUri}\r\n\r\n# Get an access token for Azure resources\r\n$AzureManagementAccessToken = (Invoke-RestMethod `\r\n    -Headers @{Metadata=\"true\"} `\r\n    -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n# Set header for Azure Management API\r\n$AzureManagementHeader = @{\r\n    'Content-Type'='application/json'\r\n    'Authorization'='Bearer ' + $AzureManagementAccessToken\r\n}\r\n\r\nStart-Sleep -Seconds 30\r\n\r\n# Use the access token to delete the virtual machine\r\nInvoke-RestMethod `\r\n    -Headers $AzureManagementHeader `\r\n    -Method 'Delete' `\r\n    -Uri $($ResourceManagerUriFixed + $VirtualMachineResourceId + '?forceDeletion=true&api-version=2024-07-01') | Out-Null",
                            "keyVaultPrivateEndpointName": "[replace(parameters('tier').namingConvention.keyVaultPrivateEndpoint, parameters('tokens').purpose, variables('workload'))]",
                            "resourceGroupName": "[resourceGroup().name]",
                            "userAssignedIdentityName": "[replace(parameters('tier').namingConvention.userAssignedIdentity, parameters('tokens').purpose, variables('workload'))]",
                            "virtualMachineName": "[replace(parameters('tier').namingConvention.virtualMachine, parameters('tokens').purpose, variables('workload'))]",
                            "workload": "cmk"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                              "apiVersion": "2018-11-30",
                              "name": "[variables('userAssignedIdentityName')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]"
                            },
                            {
                              "type": "Microsoft.Network/networkInterfaces",
                              "apiVersion": "2020-05-01",
                              "name": "[replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "ipConfigurations": [
                                  {
                                    "name": "ipconfig",
                                    "properties": {
                                      "privateIPAllocationMethod": "Dynamic",
                                      "subnet": {
                                        "id": "[parameters('subnetResourceId')]"
                                      },
                                      "primary": true,
                                      "privateIPAddressVersion": "IPv4"
                                    }
                                  }
                                ],
                                "enableAcceleratedNetworking": false,
                                "enableIPForwarding": false
                              }
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2021-11-01",
                              "name": "[variables('virtualMachineName')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "hardwareProfile": {
                                  "vmSize": "[parameters('virtualMachineSize')]"
                                },
                                "storageProfile": {
                                  "imageReference": {
                                    "publisher": "MicrosoftWindowsServer",
                                    "offer": "WindowsServer",
                                    "sku": "2022-datacenter-core-g2",
                                    "version": "latest"
                                  },
                                  "osDisk": {
                                    "deleteOption": "Delete",
                                    "osType": "Windows",
                                    "createOption": "FromImage",
                                    "caching": "None",
                                    "managedDisk": {
                                      "storageAccountType": "Premium_LRS"
                                    },
                                    "name": "[replace(parameters('tier').namingConvention.virtualMachineDisk, parameters('tokens').purpose, variables('workload'))]"
                                  },
                                  "dataDisks": []
                                },
                                "osProfile": {
                                  "adminPassword": "[parameters('virtualMachineAdminPassword')]",
                                  "adminUsername": "[parameters('virtualMachineAdminUsername')]",
                                  "computerName": "[variables('virtualMachineName')]",
                                  "windowsConfiguration": {
                                    "provisionVMAgent": true,
                                    "enableAutomaticUpdates": false
                                  },
                                  "secrets": [],
                                  "allowExtensionOperations": true
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk'))]",
                                      "properties": {
                                        "deleteOption": "Delete"
                                      }
                                    }
                                  ]
                                },
                                "securityProfile": {
                                  "uefiSettings": {
                                    "secureBootEnabled": true,
                                    "vTpmEnabled": true
                                  },
                                  "securityType": "TrustedLaunch",
                                  "encryptionAtHost": true
                                },
                                "diagnosticsProfile": {
                                  "bootDiagnostics": {
                                    "enabled": false
                                  }
                                },
                                "licenseType": "Windows_Server"
                              },
                              "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')))]": {}
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk'))]",
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '136d308c-0937-4a49-9bd7-edfb42adbffc', resourceGroup().id)]",
                              "properties": {
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '136d308c-0937-4a49-9bd7-edfb42adbffc')]",
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "scope": "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]",
                              "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '9980e02c-c2be-4d73-94e8-173b1dc7cf3c', resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName')))]",
                              "properties": {
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '9980e02c-c2be-4d73-94e8-173b1dc7cf3c')]",
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.KeyVault/vaults",
                              "apiVersion": "2022-07-01",
                              "name": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "enabledForDeployment": false,
                                "enabledForDiskEncryption": false,
                                "enabledForTemplateDeployment": false,
                                "enablePurgeProtection": true,
                                "enableRbacAuthorization": true,
                                "enableSoftDelete": true,
                                "networkAcls": {
                                  "bypass": "AzureServices",
                                  "defaultAction": "Deny",
                                  "ipRules": [],
                                  "virtualNetworkRules": []
                                },
                                "publicNetworkAccess": "Disabled",
                                "sku": {
                                  "family": "A",
                                  "name": "premium"
                                },
                                "softDeleteRetentionInDays": "[if(or(equals(parameters('environmentAbbreviation'), 'dev'), equals(parameters('environmentAbbreviation'), 'test')), 7, 90)]",
                                "tenantId": "[subscription().tenantId]"
                              }
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "scope": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                              "name": "[guid(variables('userAssignedIdentityName'), '00482a5a-887f-4fb3-b363-3b7fe8e74483', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))))]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "scope": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                              "name": "[guid(variables('userAssignedIdentityName'), 'f25e0fa2-a7c8-4377-a976-54943a77a395', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))))]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'f25e0fa2-a7c8-4377-a976-54943a77a395')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('type'), 'storageAccount')]",
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[guid(variables('userAssignedIdentityName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceGroup().id)]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints",
                              "apiVersion": "2023-04-01",
                              "name": "[variables('keyVaultPrivateEndpointName')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "customNetworkInterfaceName": "[replace(parameters('tier').namingConvention.keyVaultNetworkInterface, parameters('tokens').purpose, variables('workload'))]",
                                "privateLinkServiceConnections": [
                                  {
                                    "name": "[variables('keyVaultPrivateEndpointName')]",
                                    "properties": {
                                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                      "groupIds": [
                                        "vault"
                                      ]
                                    }
                                  }
                                ],
                                "subnet": {
                                  "id": "[parameters('subnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '136d308c-0937-4a49-9bd7-edfb42adbffc', resourceGroup().id))]",
                                "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), 'Microsoft.Authorization/roleAssignments', guid(variables('userAssignedIdentityName'), '00482a5a-887f-4fb3-b363-3b7fe8e74483', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))))]",
                                "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), 'Microsoft.Authorization/roleAssignments', guid(variables('userAssignedIdentityName'), 'f25e0fa2-a7c8-4377-a976-54943a77a395', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))))]",
                                "[extensionResourceId(resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '9980e02c-c2be-4d73-94e8-173b1dc7cf3c', resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2021-08-01",
                              "name": "[format('{0}/{1}', variables('keyVaultPrivateEndpointName'), format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                              "properties": {
                                "privateDnsZoneConfigs": [
                                  {
                                    "name": "ipconfig1",
                                    "properties": {
                                      "privateDnsZoneId": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                                    }
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2025-04-01",
                              "name": "[format('{0}/{1}', variables('virtualMachineName'), parameters('keyName'))]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "asyncExecution": false,
                                "parameters": [
                                  {
                                    "name": "DiskEncryptionSetName",
                                    "value": "[replace(parameters('tier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, variables('workload'))]"
                                  },
                                  {
                                    "name": "KeyExpirationInDays",
                                    "value": "[string(parameters('keyExpirationInDays'))]"
                                  },
                                  {
                                    "name": "KeyName",
                                    "value": "[parameters('keyName')]"
                                  },
                                  {
                                    "name": "KeyVaultResourceId",
                                    "value": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                  },
                                  {
                                    "name": "KeyVaultServiceUri",
                                    "value": "[format('https://{0}', skip(environment().suffixes.keyvaultDns, 1))]"
                                  },
                                  {
                                    "name": "KeyVaultUri",
                                    "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), '2022-07-01').vaultUri]"
                                  },
                                  {
                                    "name": "Location",
                                    "value": "[parameters('location')]"
                                  },
                                  {
                                    "name": "ResourceGroupName",
                                    "value": "[variables('resourceGroupName')]"
                                  },
                                  {
                                    "name": "ResourceManagerUri",
                                    "value": "[environment().resourceManager]"
                                  },
                                  {
                                    "name": "SubscriptionId",
                                    "value": "[parameters('tier').subscriptionId]"
                                  },
                                  {
                                    "name": "Type",
                                    "value": "[parameters('type')]"
                                  },
                                  {
                                    "name": "UserAssignedIdentityClientId",
                                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').clientId]"
                                  }
                                ],
                                "source": {
                                  "script": "[variables('$fxv#0')]"
                                },
                                "treatFailureAsDeploymentFailure": true
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', variables('keyVaultPrivateEndpointName'), format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                "[resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName'))]",
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2023-09-01",
                              "name": "[format('{0}/{1}', variables('virtualMachineName'), format('delete-vm-{0}', parameters('deploymentNameSuffix')))]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "asyncExecution": true,
                                "parameters": [
                                  {
                                    "name": "ResourceGroupName",
                                    "value": "[variables('resourceGroupName')]"
                                  },
                                  {
                                    "name": "ResourceManagerUri",
                                    "value": "[environment().resourceManager]"
                                  },
                                  {
                                    "name": "UserAssignedIdentityClientId",
                                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').clientId]"
                                  },
                                  {
                                    "name": "VirtualMachineResourceId",
                                    "value": "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                                  }
                                ],
                                "source": {
                                  "script": "[variables('$fxv#1')]"
                                },
                                "treatFailureAsDeploymentFailure": true
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Resources/deployments', format('deploy-des-{0}', parameters('deploymentNameSuffix')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', variables('virtualMachineName'), parameters('keyName'))]",
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('type'), 'virtualMachine')]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-des-{0}', parameters('deploymentNameSuffix'))]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "diskEncryptionSetName": {
                                    "value": "[replace(parameters('tier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, variables('workload'))]"
                                  },
                                  "keyVaultName": {
                                    "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "15118251701077090282"
                                    }
                                  },
                                  "parameters": {
                                    "diskEncryptionSetName": {
                                      "type": "string"
                                    },
                                    "keyVaultName": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "scope": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                                      "name": "[guid(parameters('diskEncryptionSetName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')))]",
                                      "properties": {
                                        "principalId": "[reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName')), '2023-04-02', 'full').identity.principalId]",
                                        "principalType": "ServicePrincipal",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "resourceId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName'))]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', variables('virtualMachineName'), parameters('keyName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "diskEncryptionSetResourceId": {
                              "type": "string",
                              "value": "[if(equals(parameters('type'), 'virtualMachine'), reference(resourceId('Microsoft.Resources/deployments', format('deploy-des-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value, '')]"
                            },
                            "keyVaultProperties": {
                              "type": "object",
                              "value": {
                                "diagnosticSettingName": "[replace(parameters('tier').namingConvention.keyVaultDiagnosticSetting, parameters('tokens').purpose, variables('workload'))]",
                                "name": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]",
                                "resourceGroupName": "[variables('resourceGroupName')]",
                                "subscriptionId": "[parameters('tier').subscriptionId]",
                                "tierName": "[parameters('tier').name]"
                              }
                            },
                            "keyName": {
                              "type": "string",
                              "value": "[parameters('keyName')]"
                            },
                            "keyVaultName": {
                              "type": "string",
                              "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]"
                            },
                            "keyVaultUri": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), '2022-07-01').vaultUri]"
                            },
                            "keyVaultResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                            },
                            "keyVaultNetworkInterfaceResourceId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName')), '2023-04-01').networkInterfaces[0].id]"
                            },
                            "userAssignedIdentityResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "copy": {
                        "name": "storageAccounts",
                        "count": "[length(parameters('tiers'))]",
                        "mode": "serial",
                        "batchSize": 1
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-storage-account-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tiers')[copyIndex()].subscriptionId]",
                      "resourceGroup": "[parameters('tiers')[copyIndex()].resourceGroupName]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "blobsPrivateDnsZoneResourceId": {
                            "value": "[parameters('privateDnsZoneResourceIds').blob]"
                          },
                          "delimiter": {
                            "value": "[parameters('delimiter')]"
                          },
                          "filesPrivateDnsZoneResourceId": {
                            "value": "[parameters('privateDnsZoneResourceIds').file]"
                          },
                          "keyVaultUri": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-st-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultUri.value]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "purpose": {
                            "value": "[parameters('purpose')]"
                          },
                          "queuesPrivateDnsZoneResourceId": {
                            "value": "[parameters('privateDnsZoneResourceIds').queue]"
                          },
                          "skuName": {
                            "value": "[parameters('logStorageSkuName')]"
                          },
                          "storageEncryptionKeyName": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-st-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyName.value]"
                          },
                          "subnetResourceId": {
                            "value": "[parameters('tiers')[copyIndex()].subnetResourceId]"
                          },
                          "tablesPrivateDnsZoneResourceId": {
                            "value": "[parameters('privateDnsZoneResourceIds').table]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "tier": {
                            "value": "[parameters('tiers')[copyIndex()]]"
                          },
                          "tokens": {
                            "value": "[parameters('tokens')]"
                          },
                          "userAssignedIdentityResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-st-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.userAssignedIdentityResourceId.value]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "3770160123771615483"
                            }
                          },
                          "parameters": {
                            "blobsPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "delimiter": {
                              "type": "string"
                            },
                            "filesPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "keyVaultUri": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "purpose": {
                              "type": "string"
                            },
                            "queuesPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "skuName": {
                              "type": "string"
                            },
                            "storageEncryptionKeyName": {
                              "type": "string"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tablesPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "tier": {
                              "type": "object"
                            },
                            "tokens": {
                              "type": "object"
                            },
                            "userAssignedIdentityResourceId": {
                              "type": "string"
                            }
                          },
                          "variables": {
                            "subResources": [
                              {
                                "id": "[parameters('blobsPrivateDnsZoneResourceId')]",
                                "nic": "[replace(parameters('tier').namingConvention.storageAccountBlobNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                "pe": "[replace(parameters('tier').namingConvention.storageAccountBlobPrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                              },
                              {
                                "id": "[parameters('filesPrivateDnsZoneResourceId')]",
                                "nic": "[replace(parameters('tier').namingConvention.storageAccountFileNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                "pe": "[replace(parameters('tier').namingConvention.storageAccountFilePrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                              },
                              {
                                "id": "[parameters('queuesPrivateDnsZoneResourceId')]",
                                "nic": "[replace(parameters('tier').namingConvention.storageAccountQueueNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                "pe": "[replace(parameters('tier').namingConvention.storageAccountQueuePrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                              },
                              {
                                "id": "[parameters('tablesPrivateDnsZoneResourceId')]",
                                "nic": "[replace(parameters('tier').namingConvention.storageAccountTableNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                "pe": "[replace(parameters('tier').namingConvention.storageAccountTablePrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                              }
                            ]
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Storage/storageAccounts",
                              "apiVersion": "2023-01-01",
                              "name": "[uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id)]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Storage/storageAccounts'), createObject()), parameters('mlzTags'))]",
                              "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                  "[format('{0}', parameters('userAssignedIdentityResourceId'))]": {}
                                }
                              },
                              "kind": "StorageV2",
                              "sku": {
                                "name": "[parameters('skuName')]"
                              },
                              "properties": {
                                "accessTier": "Hot",
                                "allowBlobPublicAccess": false,
                                "allowCrossTenantReplication": false,
                                "allowedCopyScope": "PrivateLink",
                                "allowSharedKeyAccess": false,
                                "defaultToOAuthAuthentication": false,
                                "dnsEndpointType": "Standard",
                                "encryption": {
                                  "identity": {
                                    "userAssignedIdentity": "[parameters('userAssignedIdentityResourceId')]"
                                  },
                                  "keySource": "Microsoft.KeyVault",
                                  "keyvaultproperties": {
                                    "keyvaulturi": "[parameters('keyVaultUri')]",
                                    "keyname": "[parameters('storageEncryptionKeyName')]"
                                  },
                                  "requireInfrastructureEncryption": true,
                                  "services": {
                                    "blob": {
                                      "keyType": "Account",
                                      "enabled": true
                                    },
                                    "file": {
                                      "keyType": "Account",
                                      "enabled": true
                                    },
                                    "queue": {
                                      "keyType": "Account",
                                      "enabled": true
                                    },
                                    "table": {
                                      "keyType": "Account",
                                      "enabled": true
                                    }
                                  }
                                },
                                "minimumTlsVersion": "TLS1_2",
                                "networkAcls": {
                                  "bypass": "AzureServices",
                                  "virtualNetworkRules": [],
                                  "ipRules": [],
                                  "defaultAction": "Deny"
                                },
                                "publicNetworkAccess": "Disabled",
                                "supportsHttpsTrafficOnly": true
                              }
                            },
                            {
                              "copy": {
                                "name": "privateEndpoints",
                                "count": "[length(variables('subResources'))]"
                              },
                              "type": "Microsoft.Network/privateEndpoints",
                              "apiVersion": "2023-04-01",
                              "name": "[variables('subResources')[copyIndex()].pe]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "customNetworkInterfaceName": "[variables('subResources')[copyIndex()].nic]",
                                "privateLinkServiceConnections": [
                                  {
                                    "name": "[variables('subResources')[copyIndex()].pe]",
                                    "properties": {
                                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]",
                                      "groupIds": [
                                        "[split(split(variables('subResources')[copyIndex()].id, '/')[8], '.')[1]]"
                                      ]
                                    }
                                  }
                                ],
                                "subnet": {
                                  "id": "[parameters('subnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]"
                              ]
                            },
                            {
                              "copy": {
                                "name": "privateDnsZoneGroups",
                                "count": "[length(variables('subResources'))]"
                              },
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2021-08-01",
                              "name": "[format('{0}/{1}', variables('subResources')[copyIndex()].pe, uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]",
                              "properties": {
                                "privateDnsZoneConfigs": [
                                  {
                                    "name": "ipconfig1",
                                    "properties": {
                                      "privateDnsZoneId": "[variables('subResources')[copyIndex()].id]"
                                    }
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints', variables('subResources')[copyIndex()].pe)]",
                                "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]"
                            },
                            "networkInterfaceResourceIds": {
                              "type": "array",
                              "copy": {
                                "count": "[length(variables('subResources'))]",
                                "input": "[reference(resourceId('Microsoft.Network/privateEndpoints', variables('subResources')[copyIndex()].pe), '2023-04-01').networkInterfaces[0].id]"
                              }
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-st-cmk-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "keyVaultProperties": {
                      "type": "object",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-st-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultProperties.value]"
                    },
                    "networkInterfaceResourceIds": {
                      "type": "array",
                      "copy": {
                        "count": "[length(parameters('tiers'))]",
                        "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tiers')[copyIndex()].subscriptionId, parameters('tiers')[copyIndex()].resourceGroupName), 'Microsoft.Resources/deployments', format('deploy-storage-account-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceIds.value]"
                      }
                    },
                    "storageAccountResourceIds": {
                      "type": "array",
                      "copy": {
                        "count": "[length(parameters('tiers'))]",
                        "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tiers')[copyIndex()].subscriptionId, parameters('tiers')[copyIndex()].resourceGroupName), 'Microsoft.Resources/deployments', format('deploy-storage-account-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value]"
                      }
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId(parameters('identitySubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-adds-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-remote-access-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-diagnostic-settings-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('hubSubscriptionId')]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "bastionDiagnosticsLogs": {
                    "value": "[parameters('bastionDiagnosticsLogs')]"
                  },
                  "bastionDiagnosticsMetrics": {
                    "value": "[parameters('bastionDiagnosticsMetrics')]"
                  },
                  "blobDiagnosticsLogs": {
                    "value": "[parameters('blobDiagnosticsLogs')]"
                  },
                  "blobDiagnosticsMetrics": {
                    "value": "[parameters('blobDiagnosticsMetrics')]"
                  },
                  "delimiter": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                  },
                  "deployBastion": {
                    "value": "[parameters('deployBastion')]"
                  },
                  "deployNetworkWatcherTrafficAnalytics": {
                    "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "fileDiagnosticsLogs": {
                    "value": "[parameters('fileDiagnosticsLogs')]"
                  },
                  "fileDiagnosticsMetrics": {
                    "value": "[parameters('fileDiagnosticsMetrics')]"
                  },
                  "firewallDiagnosticsLogs": {
                    "value": "[parameters('firewallDiagnosticsLogs')]"
                  },
                  "firewallDiagnosticsMetrics": {
                    "value": "[parameters('firewallDiagnosticsMetrics')]"
                  },
                  "keyVaults": {
                    "value": "[union(createArray(reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-diag-storage-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultProperties.value), if(parameters('deployActiveDirectoryDomainServices'), createArray(reference(subscriptionResourceId(parameters('identitySubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-adds-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultProperties.value), createArray()), if(or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), createArray(reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-remote-access-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultProperties.value), createArray()))]"
                  },
                  "keyVaultDiagnosticLogs": {
                    "value": "[parameters('keyVaultDiagnosticsLogs')]"
                  },
                  "keyVaultDiagnosticMetrics": {
                    "value": "[parameters('keyVaultDiagnosticsMetrics')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[reference(subscriptionResourceId(parameters('operationsSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.logAnalyticsWorkspaceResourceId.value]"
                  },
                  "networkInterfaceDiagnosticsMetrics": {
                    "value": "[parameters('networkInterfaceDiagnosticsMetrics')]"
                  },
                  "networkInterfaceResourceIds": {
                    "value": "[union(if(and(parameters('deployActiveDirectoryDomainServices'), parameters('deployIdentity')), reference(subscriptionResourceId(parameters('identitySubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-adds-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceIds.value, createArray()), reference(subscriptionResourceId(parameters('operationsSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceIds.value, if(or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-remote-access-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceIds.value, createArray()), flatten(reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-diag-storage-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceIds.value))]"
                  },
                  "networkWatcherFlowLogsRetentionDays": {
                    "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                  },
                  "networkWatcherFlowLogsType": {
                    "value": "[parameters('networkWatcherFlowLogsType')]"
                  },
                  "publicIPAddressDiagnosticsLogs": {
                    "value": "[parameters('publicIPAddressDiagnosticsLogs')]"
                  },
                  "publicIPAddressDiagnosticsMetrics": {
                    "value": "[parameters('publicIPAddressDiagnosticsMetrics')]"
                  },
                  "queueDiagnosticsLogs": {
                    "value": "[parameters('queueDiagnosticsLogs')]"
                  },
                  "queueDiagnosticsMetrics": {
                    "value": "[parameters('queueDiagnosticsMetrics')]"
                  },
                  "storageAccountDiagnosticsLogs": {
                    "value": "[parameters('storageAccountDiagnosticsLogs')]"
                  },
                  "storageAccountDiagnosticsMetrics": {
                    "value": "[parameters('storageAccountDiagnosticsMetrics')]"
                  },
                  "storageAccountResourceIds": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-diag-storage-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.storageAccountResourceIds.value]"
                  },
                  "supportedClouds": {
                    "value": "[parameters('supportedClouds')]"
                  },
                  "tableDiagnosticsLogs": {
                    "value": "[parameters('tableDiagnosticsLogs')]"
                  },
                  "tableDiagnosticsMetrics": {
                    "value": "[parameters('tableDiagnosticsMetrics')]"
                  },
                  "tiers": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value]"
                  },
                  "tokens": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "11469789081187284679"
                    }
                  },
                  "parameters": {
                    "bastionDiagnosticsLogs": {
                      "type": "array"
                    },
                    "bastionDiagnosticsMetrics": {
                      "type": "array"
                    },
                    "blobDiagnosticsLogs": {
                      "type": "array"
                    },
                    "blobDiagnosticsMetrics": {
                      "type": "array"
                    },
                    "delimiter": {
                      "type": "string"
                    },
                    "deployBastion": {
                      "type": "bool"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "deployNetworkWatcherTrafficAnalytics": {
                      "type": "bool"
                    },
                    "fileDiagnosticsLogs": {
                      "type": "array"
                    },
                    "fileDiagnosticsMetrics": {
                      "type": "array"
                    },
                    "firewallDiagnosticsLogs": {
                      "type": "array"
                    },
                    "firewallDiagnosticsMetrics": {
                      "type": "array"
                    },
                    "keyVaultDiagnosticLogs": {
                      "type": "array"
                    },
                    "keyVaultDiagnosticMetrics": {
                      "type": "array"
                    },
                    "keyVaults": {
                      "type": "array"
                    },
                    "location": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "networkInterfaceDiagnosticsMetrics": {
                      "type": "array"
                    },
                    "networkInterfaceResourceIds": {
                      "type": "array"
                    },
                    "networkWatcherFlowLogsRetentionDays": {
                      "type": "int"
                    },
                    "networkWatcherFlowLogsType": {
                      "type": "string"
                    },
                    "publicIPAddressDiagnosticsLogs": {
                      "type": "array"
                    },
                    "publicIPAddressDiagnosticsMetrics": {
                      "type": "array"
                    },
                    "queueDiagnosticsLogs": {
                      "type": "array"
                    },
                    "queueDiagnosticsMetrics": {
                      "type": "array"
                    },
                    "storageAccountDiagnosticsLogs": {
                      "type": "array"
                    },
                    "storageAccountDiagnosticsMetrics": {
                      "type": "array"
                    },
                    "storageAccountResourceIds": {
                      "type": "array"
                    },
                    "supportedClouds": {
                      "type": "array"
                    },
                    "tableDiagnosticsLogs": {
                      "type": "array"
                    },
                    "tableDiagnosticsMetrics": {
                      "type": "array"
                    },
                    "tiers": {
                      "type": "array"
                    },
                    "tokens": {
                      "type": "object"
                    }
                  },
                  "variables": {
                    "copy": [
                      {
                        "name": "networkSecurityGroups_Tiers",
                        "count": "[length(parameters('tiers'))]",
                        "input": {
                          "diagnosticLogs": "[parameters('tiers')[copyIndex('networkSecurityGroups_Tiers')].nsgDiagLogs]",
                          "diagnosticSettingName": "[replace(parameters('tiers')[copyIndex('networkSecurityGroups_Tiers')].namingConvention.networkSecurityGroupDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                          "flowLogsName": "[replace(parameters('tiers')[copyIndex('networkSecurityGroups_Tiers')].namingConvention.networkWatcherFlowLogsNetworkSecurityGroup, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                          "name": "[replace(parameters('tiers')[copyIndex('networkSecurityGroups_Tiers')].namingConvention.networkSecurityGroup, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                          "resourceGroupName": "[parameters('tiers')[copyIndex('networkSecurityGroups_Tiers')].resourceGroupName]",
                          "storageAccountResourceId": "[parameters('storageAccountResourceIds')[copyIndex('networkSecurityGroups_Tiers')]]",
                          "subscriptionId": "[parameters('tiers')[copyIndex('networkSecurityGroups_Tiers')].subscriptionId]",
                          "tierName": "[parameters('tiers')[copyIndex('networkSecurityGroups_Tiers')].name]"
                        }
                      },
                      {
                        "name": "subscriptionIds",
                        "count": "[length(parameters('tiers'))]",
                        "input": "[parameters('tiers')[copyIndex('subscriptionIds')].subscriptionId]"
                      }
                    ],
                    "dedupedSubscriptionIds": "[union(variables('subscriptionIds'), createArray())]",
                    "hub": "[filter(parameters('tiers'), lambda('tier', equals(lambdaVariables('tier').name, 'hub')))[0]]",
                    "networkSecurityGroups": "[union(variables('networkSecurityGroups_Tiers'), variables('networkSecurityGroup_Bastion'))]",
                    "networkSecurityGroup_Bastion": "[if(parameters('deployBastion'), createArray(createObject('diagnosticLogs', variables('hub').nsgDiagLogs, 'diagnosticSettingName', replace(variables('hub').namingConvention.bastionHostNetworkSecurityGroupDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''), 'flowLogsName', replace(variables('hub').namingConvention.networkWatcherFlowLogsNetworkSecurityGroup, parameters('tokens').purpose, 'bastion'), 'name', replace(variables('hub').namingConvention.bastionHostNetworkSecurityGroup, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''), 'resourceGroupName', variables('hub').resourceGroupName, 'storageAccountResourceId', parameters('storageAccountResourceIds')[0], 'subscriptionId', variables('hub').subscriptionId, 'tierName', format('hub{0}bas', parameters('delimiter')))), createArray())]",
                    "operations": "[filter(parameters('tiers'), lambda('tier', equals(lambdaVariables('tier').name, 'operations')))[0]]",
                    "publicIPAddresses": "[union(createArray(createObject('name', replace(variables('hub').namingConvention.azureFirewallPublicIPAddress, parameters('tokens').purpose, 'client'), 'diagName', replace(variables('hub').namingConvention.azureFirewallPublicIPAddressDiagnosticSetting, parameters('tokens').purpose, 'client')), createObject('name', replace(variables('hub').namingConvention.azureFirewallPublicIPAddress, parameters('tokens').purpose, 'management'), 'diagName', replace(variables('hub').namingConvention.azureFirewallPublicIPAddressDiagnosticSetting, parameters('tokens').purpose, 'management'))), if(parameters('deployBastion'), createArray(createObject('name', replace(variables('hub').namingConvention.bastionHostPublicIPAddress, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''), 'diagName', replace(variables('hub').namingConvention.bastionHostPublicIPAddressDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''))), createArray()))]"
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "activityLogDiagnosticSettings",
                        "count": "[length(variables('dedupedSubscriptionIds'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-activity-diag-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[variables('dedupedSubscriptionIds')[copyIndex()]]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "logAnalyticsWorkspaceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "10072718411163230780"
                            }
                          },
                          "parameters": {
                            "logAnalyticsWorkspaceId": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "microsoft.insights/diagnosticSettings",
                              "apiVersion": "2017-05-01-preview",
                              "name": "[format('diag-activity-log-{0}', subscription().subscriptionId)]",
                              "properties": {
                                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                                "logs": [
                                  {
                                    "category": "Administrative",
                                    "enabled": true
                                  },
                                  {
                                    "category": "Security",
                                    "enabled": true
                                  },
                                  {
                                    "category": "ServiceHealth",
                                    "enabled": true
                                  },
                                  {
                                    "category": "Alert",
                                    "enabled": true
                                  },
                                  {
                                    "category": "Recommendation",
                                    "enabled": true
                                  },
                                  {
                                    "category": "Policy",
                                    "enabled": true
                                  },
                                  {
                                    "category": "Autoscale",
                                    "enabled": true
                                  },
                                  {
                                    "category": "ResourceHealth",
                                    "enabled": true
                                  }
                                ]
                              }
                            }
                          ]
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-law-diag-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[variables('operations').subscriptionId]",
                      "resourceGroup": "[variables('operations').resourceGroupName]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "diagnosticStorageAccountName": {
                            "value": "[split(parameters('storageAccountResourceIds')[1], '/')[8]]"
                          },
                          "logAnalyticsWorkspaceDiagnosticSettingName": {
                            "value": "[replace(variables('operations').namingConvention.logAnalyticsWorkspaceDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "logAnalyticsWorkspaceName": {
                            "value": "[split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]]"
                          },
                          "supportedClouds": {
                            "value": "[parameters('supportedClouds')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "11884099485114379937"
                            }
                          },
                          "parameters": {
                            "diagnosticStorageAccountName": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceDiagnosticSettingName": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceName": {
                              "type": "string"
                            },
                            "supportedClouds": {
                              "type": "array"
                            }
                          },
                          "resources": [
                            {
                              "condition": "[contains(parameters('supportedClouds'), environment().name)]",
                              "type": "microsoft.insights/diagnosticSettings",
                              "apiVersion": "2017-05-01-preview",
                              "scope": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]",
                              "name": "[parameters('logAnalyticsWorkspaceDiagnosticSettingName')]",
                              "properties": {
                                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]",
                                "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('diagnosticStorageAccountName'))]",
                                "logs": [
                                  {
                                    "category": "Audit",
                                    "enabled": true
                                  }
                                ],
                                "metrics": [
                                  {
                                    "category": "AllMetrics",
                                    "enabled": true
                                  }
                                ]
                              }
                            }
                          ]
                        }
                      }
                    },
                    {
                      "copy": {
                        "name": "storageAccountDiagnosticSettings",
                        "count": "[length(parameters('tiers'))]",
                        "mode": "serial",
                        "batchSize": 1
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-sa-diag-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tiers')[copyIndex()].subscriptionId]",
                      "resourceGroup": "[parameters('tiers')[copyIndex()].resourceGroupName]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "blobDiagnosticSettingName": {
                            "value": "[replace(parameters('tiers')[copyIndex()].namingConvention.storageAccountBlobDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "blobDiagnosticsLogs": {
                            "value": "[parameters('blobDiagnosticsLogs')]"
                          },
                          "blobDiagnosticsMetrics": {
                            "value": "[parameters('blobDiagnosticsMetrics')]"
                          },
                          "fileDiagnosticSettingName": {
                            "value": "[replace(parameters('tiers')[copyIndex()].namingConvention.storageAccountFileDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "fileDiagnosticsLogs": {
                            "value": "[parameters('fileDiagnosticsLogs')]"
                          },
                          "fileDiagnosticsMetrics": {
                            "value": "[parameters('fileDiagnosticsMetrics')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "logStorageAccountResourceId": "[if(equals(parameters('tiers')[copyIndex()].name, 'hub'), createObject('value', parameters('storageAccountResourceIds')[1]), createObject('value', parameters('storageAccountResourceIds')[0]))]",
                          "queueDiagnosticSettingName": {
                            "value": "[replace(parameters('tiers')[copyIndex()].namingConvention.storageAccountQueueDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "queueDiagnosticsLogs": {
                            "value": "[parameters('queueDiagnosticsLogs')]"
                          },
                          "queueDiagnosticsMetrics": {
                            "value": "[parameters('queueDiagnosticsMetrics')]"
                          },
                          "storageAccountDiagnosticSettingName": {
                            "value": "[replace(parameters('tiers')[copyIndex()].namingConvention.storageAccountDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "storageAccountDiagnosticsLogs": {
                            "value": "[parameters('storageAccountDiagnosticsLogs')]"
                          },
                          "storageAccountDiagnosticsMetrics": {
                            "value": "[parameters('storageAccountDiagnosticsMetrics')]"
                          },
                          "storageAccountName": {
                            "value": "[split(parameters('storageAccountResourceIds')[copyIndex()], '/')[8]]"
                          },
                          "tableDiagnosticSettingName": {
                            "value": "[replace(parameters('tiers')[copyIndex()].namingConvention.storageAccountTableDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "tableDiagnosticsLogs": {
                            "value": "[parameters('tableDiagnosticsLogs')]"
                          },
                          "tableDiagnosticsMetrics": {
                            "value": "[parameters('tableDiagnosticsMetrics')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "16854631658526137140"
                            }
                          },
                          "parameters": {
                            "blobDiagnosticSettingName": {
                              "type": "string"
                            },
                            "blobDiagnosticsLogs": {
                              "type": "array"
                            },
                            "blobDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "fileDiagnosticSettingName": {
                              "type": "string"
                            },
                            "fileDiagnosticsLogs": {
                              "type": "array"
                            },
                            "fileDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "logStorageAccountResourceId": {
                              "type": "string"
                            },
                            "queueDiagnosticSettingName": {
                              "type": "string"
                            },
                            "queueDiagnosticsLogs": {
                              "type": "array"
                            },
                            "queueDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "storageAccountDiagnosticSettingName": {
                              "type": "string"
                            },
                            "storageAccountDiagnosticsLogs": {
                              "type": "array"
                            },
                            "storageAccountDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "storageAccountName": {
                              "type": "string"
                            },
                            "tableDiagnosticSettingName": {
                              "type": "string"
                            },
                            "tableDiagnosticsLogs": {
                              "type": "array"
                            },
                            "tableDiagnosticsMetrics": {
                              "type": "array"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
                              "name": "[parameters('storageAccountDiagnosticSettingName')]",
                              "properties": {
                                "logs": "[parameters('storageAccountDiagnosticsLogs')]",
                                "metrics": "[parameters('storageAccountDiagnosticsMetrics')]",
                                "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              }
                            },
                            {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]",
                              "name": "[parameters('blobDiagnosticSettingName')]",
                              "properties": {
                                "logs": "[parameters('blobDiagnosticsLogs')]",
                                "metrics": "[parameters('blobDiagnosticsMetrics')]",
                                "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              }
                            },
                            {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[resourceId('Microsoft.Storage/storageAccounts/fileServices', parameters('storageAccountName'), 'default')]",
                              "name": "[parameters('fileDiagnosticSettingName')]",
                              "properties": {
                                "logs": "[parameters('fileDiagnosticsLogs')]",
                                "metrics": "[parameters('fileDiagnosticsMetrics')]",
                                "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              }
                            },
                            {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[resourceId('Microsoft.Storage/storageAccounts/queueServices', parameters('storageAccountName'), 'default')]",
                              "name": "[parameters('queueDiagnosticSettingName')]",
                              "properties": {
                                "logs": "[parameters('queueDiagnosticsLogs')]",
                                "metrics": "[parameters('queueDiagnosticsMetrics')]",
                                "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              }
                            },
                            {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]",
                              "name": "[parameters('tableDiagnosticSettingName')]",
                              "properties": {
                                "logs": "[parameters('tableDiagnosticsLogs')]",
                                "metrics": "[parameters('tableDiagnosticsMetrics')]",
                                "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              }
                            }
                          ]
                        }
                      }
                    },
                    {
                      "copy": {
                        "name": "networkSecurityGroupDiagnostics",
                        "count": "[length(variables('networkSecurityGroups'))]",
                        "mode": "serial",
                        "batchSize": 1
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-nsg-diag-{0}-{1}', variables('networkSecurityGroups')[copyIndex()].tierName, parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[variables('networkSecurityGroups')[copyIndex()].subscriptionId]",
                      "resourceGroup": "[variables('networkSecurityGroups')[copyIndex()].resourceGroupName]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "deployNetworkWatcherTrafficAnalytics": {
                            "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                          },
                          "flowLogsName": {
                            "value": "[variables('networkSecurityGroups')[copyIndex()].flowLogsName]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "logs": {
                            "value": "[variables('networkSecurityGroups')[copyIndex()].diagnosticLogs]"
                          },
                          "networkSecurityGroupDiagnosticSettingName": {
                            "value": "[variables('networkSecurityGroups')[copyIndex()].diagnosticSettingName]"
                          },
                          "networkSecurityGroupName": {
                            "value": "[variables('networkSecurityGroups')[copyIndex()].name]"
                          },
                          "networkWatcherFlowLogsRetentionDays": {
                            "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                          },
                          "networkWatcherFlowLogsType": {
                            "value": "[parameters('networkWatcherFlowLogsType')]"
                          },
                          "storageAccountResourceId": {
                            "value": "[variables('networkSecurityGroups')[copyIndex()].storageAccountResourceId]"
                          },
                          "tiername": {
                            "value": "[variables('networkSecurityGroups')[copyIndex()].tierName]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "5431688095715861024"
                            }
                          },
                          "parameters": {
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "deployNetworkWatcherTrafficAnalytics": {
                              "type": "bool"
                            },
                            "flowLogsName": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "logs": {
                              "type": "array"
                            },
                            "networkSecurityGroupDiagnosticSettingName": {
                              "type": "string"
                            },
                            "networkSecurityGroupName": {
                              "type": "string"
                            },
                            "networkWatcherFlowLogsRetentionDays": {
                              "type": "int"
                            },
                            "networkWatcherFlowLogsType": {
                              "type": "string"
                            },
                            "storageAccountResourceId": {
                              "type": "string"
                            },
                            "tiername": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]",
                              "name": "[parameters('networkSecurityGroupDiagnosticSettingName')]",
                              "properties": {
                                "logs": "[parameters('logs')]",
                                "metrics": [],
                                "storageAccountId": "[parameters('storageAccountResourceId')]",
                                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              }
                            },
                            {
                              "condition": "[equals(parameters('networkWatcherFlowLogsType'), 'NetworkSecurityGroup')]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-{0}-flowLogs-{1}', parameters('tiername'), parameters('deploymentNameSuffix'))]",
                              "resourceGroup": "NetworkWatcherRG",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "deployNetworkWatcherTrafficAnalytics": {
                                    "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                                  },
                                  "flowLogsName": {
                                    "value": "[parameters('flowLogsName')]"
                                  },
                                  "flowLogsRetentionDays": {
                                    "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  },
                                  "networkWatcherName": {
                                    "value": "[format('NetworkWatcher_{0}', parameters('location'))]"
                                  },
                                  "storageAccountResourceId": {
                                    "value": "[parameters('storageAccountResourceId')]"
                                  },
                                  "targetResourceId": {
                                    "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "18376200335373925565"
                                    }
                                  },
                                  "parameters": {
                                    "deployNetworkWatcherTrafficAnalytics": {
                                      "type": "bool"
                                    },
                                    "flowLogsName": {
                                      "type": "string"
                                    },
                                    "flowLogsRetentionDays": {
                                      "type": "int"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string"
                                    },
                                    "networkWatcherName": {
                                      "type": "string"
                                    },
                                    "storageAccountResourceId": {
                                      "type": "string"
                                    },
                                    "targetResourceId": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/networkWatchers/flowLogs",
                                      "apiVersion": "2023-05-01",
                                      "name": "[format('{0}/{1}', parameters('networkWatcherName'), parameters('flowLogsName'))]",
                                      "location": "[parameters('location')]",
                                      "properties": {
                                        "targetResourceId": "[parameters('targetResourceId')]",
                                        "enabled": true,
                                        "storageId": "[parameters('storageAccountResourceId')]",
                                        "flowAnalyticsConfiguration": {
                                          "networkWatcherFlowAnalyticsConfiguration": {
                                            "enabled": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('deployNetworkWatcherTrafficAnalytics'), null())]",
                                            "workspaceResourceId": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('logAnalyticsWorkspaceResourceId'), null())]"
                                          }
                                        },
                                        "format": {
                                          "type": "JSON",
                                          "version": 2
                                        },
                                        "retentionPolicy": {
                                          "days": "[parameters('flowLogsRetentionDays')]",
                                          "enabled": true
                                        }
                                      }
                                    }
                                  ]
                                }
                              }
                            }
                          ]
                        }
                      }
                    },
                    {
                      "copy": {
                        "name": "publicIpAddressDiagnosticSettings",
                        "count": "[length(variables('publicIPAddresses'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-pip-diag-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[variables('hub').subscriptionId]",
                      "resourceGroup": "[variables('hub').resourceGroupName]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "hubStorageAccountResourceId": {
                            "value": "[parameters('storageAccountResourceIds')[0]]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "publicIPAddressDiagnosticSettingName": {
                            "value": "[variables('publicIPAddresses')[copyIndex()].diagName]"
                          },
                          "publicIPAddressDiagnosticsLogs": {
                            "value": "[parameters('publicIPAddressDiagnosticsLogs')]"
                          },
                          "publicIPAddressDiagnosticsMetrics": {
                            "value": "[parameters('publicIPAddressDiagnosticsMetrics')]"
                          },
                          "publicIPAddressName": {
                            "value": "[variables('publicIPAddresses')[copyIndex()].name]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "13772724176988545488"
                            }
                          },
                          "parameters": {
                            "hubStorageAccountResourceId": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "publicIPAddressDiagnosticSettingName": {
                              "type": "string"
                            },
                            "publicIPAddressDiagnosticsLogs": {
                              "type": "array"
                            },
                            "publicIPAddressDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "publicIPAddressName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddressName'))]",
                              "name": "[parameters('publicIPAddressDiagnosticSettingName')]",
                              "properties": {
                                "logs": "[parameters('publicIPAddressDiagnosticsLogs')]",
                                "metrics": "[parameters('publicIPAddressDiagnosticsMetrics')]",
                                "storageAccountId": "[parameters('hubStorageAccountResourceId')]",
                                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              }
                            }
                          ]
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-afw-diag-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[variables('hub').subscriptionId]",
                      "resourceGroup": "[variables('hub').resourceGroupName]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "firewallDiagnosticSettingsName": {
                            "value": "[replace(variables('hub').namingConvention.azureFirewallDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "firewallName": {
                            "value": "[replace(variables('hub').namingConvention.azureFirewall, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "logs": {
                            "value": "[parameters('firewallDiagnosticsLogs')]"
                          },
                          "logStorageAccountResourceId": {
                            "value": "[parameters('storageAccountResourceIds')[0]]"
                          },
                          "metrics": {
                            "value": "[parameters('firewallDiagnosticsMetrics')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "246100873508727568"
                            }
                          },
                          "parameters": {
                            "firewallDiagnosticSettingsName": {
                              "type": "string"
                            },
                            "firewallName": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "logs": {
                              "type": "array"
                            },
                            "logStorageAccountResourceId": {
                              "type": "string"
                            },
                            "metrics": {
                              "type": "array"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[resourceId('Microsoft.Network/azureFirewalls', parameters('firewallName'))]",
                              "name": "[parameters('firewallDiagnosticSettingsName')]",
                              "properties": {
                                "logs": "[parameters('logs')]",
                                "metrics": "[parameters('metrics')]",
                                "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              }
                            }
                          ],
                          "outputs": {
                            "privateIPAddress": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Network/azureFirewalls', parameters('firewallName')), '2021-02-01').ipConfigurations[0].properties.privateIPAddress]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "copy": {
                        "name": "keyVaultDiagnosticSettings",
                        "count": "[length(parameters('keyVaults'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-kv-diag-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('keyVaults')[copyIndex()].subscriptionId]",
                      "resourceGroup": "[parameters('keyVaults')[copyIndex()].resourceGroupName]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "keyVaultDiagnosticSettingName": {
                            "value": "[parameters('keyVaults')[copyIndex()].diagnosticSettingName]"
                          },
                          "keyVaultName": {
                            "value": "[parameters('keyVaults')[copyIndex()].name]"
                          },
                          "keyVaultStorageAccountId": {
                            "value": "[filter(parameters('storageAccountResourceIds'), lambda('id', contains(lambdaVariables('id'), parameters('keyVaults')[copyIndex()].tierName)))[0]]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "logs": {
                            "value": "[parameters('keyVaultDiagnosticLogs')]"
                          },
                          "metrics": {
                            "value": "[parameters('keyVaultDiagnosticMetrics')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "1272317275534002717"
                            }
                          },
                          "parameters": {
                            "keyVaultDiagnosticSettingName": {
                              "type": "string"
                            },
                            "keyVaultName": {
                              "type": "string"
                            },
                            "keyVaultStorageAccountId": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "logs": {
                              "type": "array"
                            },
                            "metrics": {
                              "type": "array"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                              "name": "[parameters('keyVaultDiagnosticSettingName')]",
                              "properties": {
                                "logs": "[parameters('logs')]",
                                "metrics": "[parameters('metrics')]",
                                "storageAccountId": "[parameters('keyVaultStorageAccountId')]",
                                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              }
                            }
                          ]
                        }
                      }
                    },
                    {
                      "condition": "[parameters('deployBastion')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-bastion-diag-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[variables('hub').subscriptionId]",
                      "resourceGroup": "[variables('hub').resourceGroupName]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "diagnosticSettingName": {
                            "value": "[replace(variables('hub').namingConvention.bastionHostDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "logs": {
                            "value": "[parameters('bastionDiagnosticsLogs')]"
                          },
                          "metrics": {
                            "value": "[parameters('bastionDiagnosticsMetrics')]"
                          },
                          "name": {
                            "value": "[replace(variables('hub').namingConvention.bastionHost, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "storageAccountResourceId": {
                            "value": "[parameters('storageAccountResourceIds')[0]]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "652573045877134517"
                            }
                          },
                          "parameters": {
                            "diagnosticSettingName": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "logs": {
                              "type": "array"
                            },
                            "metrics": {
                              "type": "array"
                            },
                            "name": {
                              "type": "string"
                            },
                            "storageAccountResourceId": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[resourceId('Microsoft.Network/bastionHosts', parameters('name'))]",
                              "name": "[parameters('diagnosticSettingName')]",
                              "properties": {
                                "logs": "[parameters('logs')]",
                                "metrics": "[parameters('metrics')]",
                                "storageAccountId": "[parameters('storageAccountResourceId')]",
                                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              }
                            }
                          ]
                        }
                      }
                    },
                    {
                      "copy": {
                        "name": "networkInterfaceDiagnostics",
                        "count": "[length(parameters('networkInterfaceResourceIds'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-nic-diag-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[split(parameters('networkInterfaceResourceIds')[copyIndex()], '/')[2]]",
                      "resourceGroup": "[split(parameters('networkInterfaceResourceIds')[copyIndex()], '/')[4]]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "delimiter": {
                            "value": "[parameters('delimiter')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "logs": {
                            "value": []
                          },
                          "metrics": {
                            "value": "[parameters('networkInterfaceDiagnosticsMetrics')]"
                          },
                          "networkInterfaceResourceId": {
                            "value": "[parameters('networkInterfaceResourceIds')[copyIndex()]]"
                          },
                          "storageAccountResourceIds": {
                            "value": "[parameters('storageAccountResourceIds')]"
                          },
                          "tiers": {
                            "value": "[parameters('tiers')]"
                          },
                          "tokens": {
                            "value": "[parameters('tokens')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "9983310224341078636"
                            }
                          },
                          "parameters": {
                            "delimiter": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "logs": {
                              "type": "array"
                            },
                            "metrics": {
                              "type": "array"
                            },
                            "networkInterfaceResourceId": {
                              "type": "string"
                            },
                            "storageAccountResourceIds": {
                              "type": "array"
                            },
                            "tiers": {
                              "type": "array"
                            },
                            "tokens": {
                              "type": "object"
                            }
                          },
                          "variables": {
                            "networkInterfaceDiagnosticSettingName": "[replace(parameters('tiers')[variables('tierIndex')].namingConvention.virtualMachineNetworkInterfaceDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                            "storageAccountResourceId": "[parameters('storageAccountResourceIds')[variables('tierIndex')]]",
                            "tierIndex": "[if(contains(parameters('networkInterfaceResourceId'), '-ops-'), 1, if(contains(parameters('networkInterfaceResourceId'), '-svcs-'), 2, if(contains(parameters('networkInterfaceResourceId'), '-id-'), 3, 0)))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[resourceId('Microsoft.Network/networkInterfaces', split(parameters('networkInterfaceResourceId'), '/')[8])]",
                              "name": "[variables('networkInterfaceDiagnosticSettingName')]",
                              "properties": {
                                "logs": "[parameters('logs')]",
                                "metrics": "[parameters('metrics')]",
                                "storageAccountId": "[variables('storageAccountResourceId')]",
                                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              }
                            }
                          ]
                        }
                      }
                    },
                    {
                      "copy": {
                        "name": "virtualNetworkDiagnostics",
                        "count": "[length(parameters('tiers'))]",
                        "mode": "serial",
                        "batchSize": 1
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-vnet-diag-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tiers')[copyIndex()].subscriptionId]",
                      "resourceGroup": "[parameters('tiers')[copyIndex()].resourceGroupName]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "deployNetworkWatcherTrafficAnalytics": {
                            "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                          },
                          "flowLogsName": {
                            "value": "[replace(parameters('tiers')[copyIndex()].namingConvention.networkWatcherFlowLogsVirtualNetwork, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "logs": {
                            "value": "[parameters('tiers')[copyIndex()].vnetDiagLogs]"
                          },
                          "logStorageAccountResourceId": {
                            "value": "[parameters('storageAccountResourceIds')[copyIndex()]]"
                          },
                          "metrics": {
                            "value": "[parameters('tiers')[copyIndex()].vnetDiagMetrics]"
                          },
                          "networkWatcherFlowLogsRetentionDays": {
                            "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                          },
                          "networkWatcherFlowLogsType": {
                            "value": "[parameters('networkWatcherFlowLogsType')]"
                          },
                          "tiername": {
                            "value": "[parameters('tiers')[copyIndex()].name]"
                          },
                          "virtualNetworkDiagnosticSettingName": {
                            "value": "[replace(parameters('tiers')[copyIndex()].namingConvention.virtualNetworkDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "virtualNetworkName": {
                            "value": "[replace(parameters('tiers')[copyIndex()].namingConvention.virtualNetwork, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "7697548079699580923"
                            }
                          },
                          "parameters": {
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "deployNetworkWatcherTrafficAnalytics": {
                              "type": "bool"
                            },
                            "flowLogsName": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "logs": {
                              "type": "array"
                            },
                            "logStorageAccountResourceId": {
                              "type": "string"
                            },
                            "metrics": {
                              "type": "array"
                            },
                            "networkWatcherFlowLogsRetentionDays": {
                              "type": "int"
                            },
                            "networkWatcherFlowLogsType": {
                              "type": "string"
                            },
                            "supportedClouds": {
                              "type": "array",
                              "defaultValue": [
                                "AzureCloud"
                              ]
                            },
                            "tiername": {
                              "type": "string"
                            },
                            "virtualNetworkDiagnosticSettingName": {
                              "type": "string"
                            },
                            "virtualNetworkName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
                              "name": "[parameters('virtualNetworkDiagnosticSettingName')]",
                              "properties": {
                                "logs": "[if(contains(parameters('supportedClouds'), environment().name), parameters('logs'), createArray())]",
                                "metrics": "[parameters('metrics')]",
                                "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              }
                            },
                            {
                              "condition": "[equals(parameters('networkWatcherFlowLogsType'), 'VirtualNetwork')]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-{0}-flowLogs-{1}', parameters('tiername'), parameters('deploymentNameSuffix'))]",
                              "resourceGroup": "NetworkWatcherRG",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "deployNetworkWatcherTrafficAnalytics": {
                                    "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                                  },
                                  "flowLogsName": {
                                    "value": "[parameters('flowLogsName')]"
                                  },
                                  "flowLogsRetentionDays": {
                                    "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  },
                                  "networkWatcherName": {
                                    "value": "[format('NetworkWatcher_{0}', parameters('location'))]"
                                  },
                                  "storageAccountResourceId": {
                                    "value": "[parameters('logStorageAccountResourceId')]"
                                  },
                                  "targetResourceId": {
                                    "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "18376200335373925565"
                                    }
                                  },
                                  "parameters": {
                                    "deployNetworkWatcherTrafficAnalytics": {
                                      "type": "bool"
                                    },
                                    "flowLogsName": {
                                      "type": "string"
                                    },
                                    "flowLogsRetentionDays": {
                                      "type": "int"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string"
                                    },
                                    "networkWatcherName": {
                                      "type": "string"
                                    },
                                    "storageAccountResourceId": {
                                      "type": "string"
                                    },
                                    "targetResourceId": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/networkWatchers/flowLogs",
                                      "apiVersion": "2023-05-01",
                                      "name": "[format('{0}/{1}', parameters('networkWatcherName'), parameters('flowLogsName'))]",
                                      "location": "[parameters('location')]",
                                      "properties": {
                                        "targetResourceId": "[parameters('targetResourceId')]",
                                        "enabled": true,
                                        "storageId": "[parameters('storageAccountResourceId')]",
                                        "flowAnalyticsConfiguration": {
                                          "networkWatcherFlowAnalyticsConfiguration": {
                                            "enabled": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('deployNetworkWatcherTrafficAnalytics'), null())]",
                                            "workspaceResourceId": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('logAnalyticsWorkspaceResourceId'), null())]"
                                          }
                                        },
                                        "format": {
                                          "type": "JSON",
                                          "version": 2
                                        },
                                        "retentionPolicy": {
                                          "days": "[parameters('flowLogsRetentionDays')]",
                                          "enabled": true
                                        }
                                      }
                                    }
                                  ]
                                }
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('hub').subscriptionId, variables('hub').resourceGroupName), 'Microsoft.Resources/deployments', format('deploy-bastion-diag-{0}', parameters('deploymentNameSuffix')))]",
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('hub').subscriptionId, variables('hub').resourceGroupName), 'Microsoft.Resources/deployments', format('deploy-afw-diag-{0}', parameters('deploymentNameSuffix')))]",
                        "keyVaultDiagnosticSettings",
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('operations').subscriptionId, variables('operations').resourceGroupName), 'Microsoft.Resources/deployments', format('deploy-law-diag-{0}', parameters('deploymentNameSuffix')))]",
                        "networkInterfaceDiagnostics",
                        "networkSecurityGroupDiagnostics",
                        "publicIpAddressDiagnosticSettings",
                        "storageAccountDiagnosticSettings"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId(parameters('identitySubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-adds-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId(parameters('operationsSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-remote-access-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-diag-storage-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-security-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('hubSubscriptionId')]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "defenderPlans": {
                    "value": "[parameters('deployDefenderPlans')]"
                  },
                  "defenderSkuTier": {
                    "value": "[parameters('defenderSkuTier')]"
                  },
                  "deployDefender": {
                    "value": "[parameters('deployDefender')]"
                  },
                  "deployPolicy": {
                    "value": "[parameters('deployPolicy')]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "emailSecurityContact": {
                    "value": "[parameters('emailSecurityContact')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[reference(subscriptionResourceId(parameters('operationsSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.logAnalyticsWorkspaceResourceId.value]"
                  },
                  "policy": {
                    "value": "[parameters('policy')]"
                  },
                  "tiers": {
                    "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value]"
                  },
                  "windowsAdministratorsGroupMembership": {
                    "value": "[parameters('windowsVmAdminUsername')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "9246781724257794131"
                    }
                  },
                  "parameters": {
                    "defenderPlans": {
                      "type": "array",
                      "defaultValue": [
                        "VirtualMachines"
                      ]
                    },
                    "defenderSkuTier": {
                      "type": "string"
                    },
                    "deployDefender": {
                      "type": "bool"
                    },
                    "deployPolicy": {
                      "type": "bool"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "emailSecurityContact": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "policy": {
                      "type": "string"
                    },
                    "tiers": {
                      "type": "array"
                    },
                    "windowsAdministratorsGroupMembership": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "policyAssignment",
                        "count": "[length(parameters('tiers'))]"
                      },
                      "condition": "[parameters('deployPolicy')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('assign-policy-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tiers')[copyIndex()].subscriptionId]",
                      "resourceGroup": "[parameters('tiers')[copyIndex()].resourceGroupName]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "builtInAssignment": {
                            "value": "[parameters('policy')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "deployRemediation": {
                            "value": false
                          },
                          "windowsAdministratorsGroupMembership": {
                            "value": "[parameters('windowsAdministratorsGroupMembership')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "15366687354223606610"
                            }
                          },
                          "parameters": {
                            "builtInAssignment": {
                              "type": "string"
                            },
                            "deployRemediation": {
                              "type": "bool"
                            },
                            "location": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "windowsAdministratorsGroupMembership": {
                              "type": "string"
                            }
                          },
                          "variables": {
                            "$fxv#0": "{\r\n  \"listOfMembersToExcludeFromWindowsVMAdministratorsGroup\": {\r\n    \"value\": \"admin\"\r\n  },\r\n  \"IncludeArcMachines\": {\r\n    \"value\": \"true\"\r\n  },\r\n  \"MinimumTLSVersion-5752e6d6-1206-46d8-8ab1-ecc2f71a8112\": {\r\n    \"value\": \"1.2\"\r\n  },\r\n  \"NotAvailableMachineState-bed48b13-6647-468e-aa2f-1af1d3f4dd40\": {\r\n    \"value\": \"Compliant\"\r\n  },\r\n  \"requiredRetentionDays\": {\r\n    \"value\": \"365\"\r\n  },\r\n  \"resourceGroupName-b6e2945c-0b7b-40f5-9233-7a5323b5cdc6\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                            "$fxv#1": "{\r\n  \"IncludeArcMachines\": {\r\n    \"value\": \"true\"\r\n  },\r\n  \"MinimumTLSVersion-5752e6d6-1206-46d8-8ab1-ecc2f71a8112\": {\r\n    \"value\": \"1.2\"\r\n  },\r\n  \"NotAvailableMachineState-bed48b13-6647-468e-aa2f-1af1d3f4dd40\": {\r\n    \"value\": \"Compliant\"\r\n  },\r\n  \"requiredRetentionDays\": {\r\n    \"value\": \"365\"\r\n  },\r\n  \"resourceGroupName-b6e2945c-0b7b-40f5-9233-7a5323b5cdc6\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                            "$fxv#2": "{\r\n  \"IncludeArcMachines\": {\r\n    \"value\": \"false\"\r\n  },\r\n  \"NotAvailableMachineState-bed48b13-6647-468e-aa2f-1af1d3f4dd40\": {\r\n    \"value\": \"Compliant\"\r\n  },\r\n  \"MinimumTLSVersionForWindowsServers\": {\r\n    \"value\": \"1.2\"\r\n  },\r\n  \"requiredRetentionDays\": {\r\n    \"value\": \"365\"\r\n  },\r\n  \"effect-febd0533-8e55-448f-b837-bd0e06f16469\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"allowedContainerImagesRegex-febd0533-8e55-448f-b837-bd0e06f16469\": {\r\n    \"value\": \"^(.+){0}$\"\r\n  },\r\n  \"effect-95edb821-ddaf-4404-9732-666045e056b4\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-440b515e-a580-421e-abeb-b159a61ddcbc\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-233a2a17-77ca-4fb1-9b6b-69223d272a44\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-e345eecc-fa47-480f-9e88-67dcc122b164\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"cpuLimit-e345eecc-fa47-480f-9e88-67dcc122b164\": {\r\n    \"value\": \"0\"\r\n  },\r\n  \"memoryLimit-e345eecc-fa47-480f-9e88-67dcc122b164\": {\r\n    \"value\": \"0\"\r\n  },\r\n  \"effect-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"runAsUserRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"MustRunAsNonRoot\"\r\n  },\r\n  \"runAsGroupRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"RunAsAny\"\r\n  },\r\n  \"supplementalGroupsRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"RunAsAny\"\r\n  },\r\n  \"fsGroupRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"RunAsAny\"\r\n  },\r\n  \"effect-1c6e92c9-99f0-4e55-9cf2-0c234dc48f99\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-47a1ee2f-2a2a-4576-bf2a-e0e36709c2b8\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-df49d893-a74c-421d-bc95-c663042e5b80\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-1a5b4dca-0b6f-4cf5-907c-56316bc1bf3d\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-c26596ff-4d70-4e6a-9a30-c2506bd2f80c\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-511f5417-5d12-434d-ab2e-816901e72a5e\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-82985f06-dc18-4a48-bc1c-b9f4f0098cfe\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-098fc59e-46c7-4d99-9b16-64990e543d75\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"setting-a6fb4358-5bf4-4ad7-ba82-2cd2f41ce5e9\": {\r\n    \"value\": \"enabled\"\r\n  },\r\n  \"aadAuthenticationInServiceFabricMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-71ef260a-8f18-47b7-abcb-62d0673d94dc\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-055aa869-bc98-4af8-bafc-23f1ab6ffe2c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-564feb30-bf6a-4854-b4bb-0d2d2d1e6c66\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-862e97cf-49fc-4a5c-9de4-40d4e2e7c8eb\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d9da03a1-f3c3-412a-9709-947156872263\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-617c02be-7f02-4efd-8836-3180d47b6c68\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0b60c0b2-2dc2-4e1c-b5c9-abbed971de53\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1e66c121-a66a-4b1f-9b83-0fd99bf0fc2d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ec068d99-e9c7-401f-8cef-5bdde4e6ccf1\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c349d81b-9985-44ae-a8da-ff98d108ede8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-3657f5a0-770e-44a3-b44e-9431ba1e9735\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-b4ac1030-89c5-4697-8e00-28b5ba6a8811\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-ea0dfaed-95fb-448c-934e-d6e713ce393d\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-4733ea7b-a883-42fe-8cac-97454c2a9e4a\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-f4b53539-8df9-40e4-86c6-6b607703bd4e\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-41425d9f-d1a5-499a-9932-f8ed8453932c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-fc4d8e41-e223-45ea-9bf5-eada37891d87\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-86efb160-8de7-451d-bc08-5d475b0aadae\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-4ec52d6d-beb7-40c4-9a9e-fe753254690e\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-64d314f6-6062-4780-a861-c23e8951bee5\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1fd32ebd-e4c3-4e13-a54a-d7422d4d95f6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-fa298e57-9444-42ba-bf04-86e8470e32c7\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-67121cc7-ff39-4ab8-b7e3-95b84dab487d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1f905d99-2ab7-462c-a6b0-f709acca6c8f\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-5b9159ae-1701-4a6f-9a7a-aa9c8ddd0580\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ba769a63-b8cc-4b2d-abf6-ac33c7204be8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-81e74cea-30fd-40d5-802f-d72103c2aaaa\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0aa61e00-0a01-4a3c-9945-e93cffedf0e6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-47031206-ce96-41f8-861b-6a915f3de284\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-87ba29ef-1ab3-4d82-b763-87fcd4f531f7\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-51522a96-0869-4791-82f3-981000c2c67f\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-b5ec538c-daa0-4006-8596-35468b9148e8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-56a5ee18-2ae6-4810-86f7-18e39ce5629b\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-2e94d99a-8a36-4563-bc77-810d8893b671\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1fafeaf6-7927-4059-a50a-8eb2a7a6f2b5\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-99e9ccd8-3db9-4592-b0d1-14b1715a4d8a\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1f68a601-6e6d-4e42-babf-3f643a047ea2\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-f7d52b2d-e161-4dfa-a82b-55e564167385\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7d7be79c-23ba-4033-84dd-45e2a5ccdd67\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ca91455f-eace-4f96-be59-e6e2c35b4816\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-702dd420-7fcc-42c5-afe8-4026edd20fe0\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"diagnosticsLogsInRedisCacheMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"secureTransferToStorageAccountMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d0793b48-0edc-4296-a390-4c75d1bdfd71\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7d092e0a-7acd-40d2-a975-dca21cae48c4\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-2a1a9cdf-e04d-429a-8416-3bfb72a1b26f\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"disableUnrestrictedNetworkToStorageAccountMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-55615ac9-af46-4a59-874e-391cc3dfb490\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1b8ca024-1d5c-4dec-8995-b1a932b41780\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-037eea7a-bd0a-46c5-9a66-03aea78705d3\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-53503636-bcc9-4748-9663-5348217f160f\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-40cec1dd-a100-4920-b15b-3024fe8901ab\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0725b4dd-7e76-479c-a735-68e7ee23d5ca\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-a049bf77-880b-470f-ba6d-9f21c530cf83\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ee980b6d-0eca-4501-8d54-f6290fd512c3\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1d84d5fb-01f6-4d12-ba4f-4a26081d403d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-37e0d2fe-28a5-43d6-a273-67d37d1f5606\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"identityDesignateMoreThanOneOwnerMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"diskEncryptionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"emailNotificationToSubscriptionOwnerHighSeverityAlertsEnabledEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"functionAppDisableRemoteDebuggingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"sqlDbEncryptionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vulnerabilityAssessmentOnManagedInstanceMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePHPVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"aadAuthenticationInSqlServerMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vmssEndpointProtectionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vmssOsVulnerabilitiesMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"adaptiveApplicationControlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"geoRedundantBackupShouldBeEnabledForAzureDatabaseForPostgreSQLEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"ensureJavaVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityDesignateLessThanOwnersMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"securityContactEmailAddressForSubscriptionEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"webAppRestrictCORSAccessMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveExternalAccountWithWritePermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveExternalAccountWithReadPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveDeprecatedAccountMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"functionAppEnforceHttpsMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"ensurePythonVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePythonVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePHPVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePythonVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"geoRedundantBackupShouldBeEnabledForAzureDatabaseForMySQLEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"systemUpdatesMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureJavaVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureHTTPVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"apiAppRequireLatestTlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityEnableMFAForWritePermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureHTTPVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureJavaVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"nextGenerationFirewallMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"useRbacRulesMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"webAppEnforceHttpsMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"sqlServerAuditingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vnetEnableDDoSProtectionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityEnableMFAForOwnerPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"sqlServerAdvancedDataSecurityMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"sqlManagedInstanceAdvancedDataSecurityMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"endpointProtectionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"jitNetworkAccessMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"apiAppEnforceHttpsMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"geoRedundantStorageShouldBeEnabledForStorageAccountsEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"vmssSystemUpdatesMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"webAppDisableRemoteDebuggingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"longtermGeoRedundantBackupEnabledAzureSQLDatabasesEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"systemConfigurationsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureHTTPVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityEnableMFAForReadPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"containerBenchmarkMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"apiAppDisableRemoteDebuggingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveDeprecatedAccountWithOwnerPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vulnerabilityAssessmentOnServerMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"webAppRequireLatestTlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveExternalAccountWithOwnerPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"functionAppRequireLatestTlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"kubernetesServiceVersionUpToDateMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"sqlDbVulnerabilityAssesmentMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"membersToExcludeInLocalAdministratorsGroup\": {\r\n    \"value\": \"admin\"\r\n  },\r\n  \"PHPLatestVersionForAppServices\": {\r\n    \"value\": \"7.4\"\r\n  },\r\n  \"JavaLatestVersionForAppServices\": {\r\n    \"value\": \"11\"\r\n  },\r\n  \"WindowsPythonLatestVersionForAppServices\": {\r\n    \"value\": \"3.6\"\r\n  },\r\n  \"LinuxPythonLatestVersionForAppServices\": {\r\n    \"value\": \"3.9\"\r\n  },\r\n  \"ensureDotNetFrameworkLatestForFunctionAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlManagedInstanceAdvancedDataSecurityEmailsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"vulnerabilityAssessmentMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"ensureDotNetFrameworkLatestForWebAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlServerAdvancedDataSecurityEmailsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"microsoftIaaSAntimalwareExtensionShouldBeDeployedOnWindowsServersEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"securityCenterStandardPricingTierShouldBeSelectedEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"theLogAnalyticsAgentShouldBeInstalledOnVirtualMachinesEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"ensurePHPVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlManagedInstanceAdvancedDataSecurityEmailAdminsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"securityContactPhoneNumberShouldBeProvidedForSubscriptionEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"threatDetectionTypesOnManagedInstanceMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"ensureDotNetFrameworkLatestForAPIAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlServerAdvancedDataSecurityEmailAdminsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"threatDetectionTypesOnServerMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"theLogAnalyticsAgentShouldBeInstalledOnVirtualMachineScaleSetsEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"NetworkWatcherResourceGroupName\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                            "$fxv#3": "{\r\n  \"effect-09024ccc-0c5f-475e-9457-b7c0d9ed487b\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0961003e-5a0a-4549-abde-af6a37f2724d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0b15565f-aa9e-48ba-8619-45960f2c314d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0e60b895-3786-45da-8377-9c6b4b6ac5f9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-17k78e20-9358-41c9-923c-fb736d382a12\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-1bc1795e-d44a-4d48-9b3b-6fff0fd5f9ba\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"PHPLatestVersion\": {\r\n    \"value\": \"7.3\"\r\n  },\r\n  \"effect-22bee202-a82f-4305-9a2a-6d7f44d4dedb\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-26a828e1-e88f-464e-bbb3-c134a282b9de\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-34c877ad-507e-4c82-993e-3452a6e0ad3c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-3c735d8a-a4ba-4a3a-b7cf-db7754cf57f4\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-404c3081-a854-4457-ae30-26a93ef643f9\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-47a6b606-51aa-4496-8bb7-64b11cf66adc\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-496223c3-ad65-4ecd-878a-bae78737e9ed\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"JavaLatestVersion\": {\r\n    \"value\": \"11\"\r\n  },\r\n  \"effect-4f11b553-d42e-4e3a-89be-32ca364cad4c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-4f4f78b8-e367-4b10-a341-d9a4ad5cf1c7\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-5c607a2e-c700-4744-8254-d77e7c9eb5e4\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-5f76cf89-fbf2-47fd-a3f4-b891fa780b60\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-6b1cbf55-e8b6-442f-ba4c-7246b6381474\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-6d555dd1-86f2-4f1c-8ed7-5abae7c6cbab\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7008174a-fd10-4ef0-817e-fc820a951d73\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"LinuxPythonLatestVersion\": {\r\n    \"value\": \"3.8\"\r\n  },\r\n  \"effect-7238174a-fd10-4ef0-817e-fc820a951d73\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-7261b898-8a84-4db8-9e04-18527132abb3\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-74c3584d-afae-46f7-a20a-6f8adba71a16\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-86b3d65f-7626-441e-b690-81a8b71cff60\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-88999f4c-376a-45c8-bcb3-4058f713cf39\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-8c122334-9d20-4eb8-89ea-ac9a705b74ae\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-8cb6aa8b-9e41-4f4e-aa25-089a7ac2581e\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9297c21d-2ed6-4474-b48f-163f75654ce3\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-991310cd-e9f3-47bc-b7b6-f57b557d07db\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9b597639-28e4-48eb-b506-56b05d366257\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9d0b6ea4-93e2-4578-bf2f-6bb17d22b4bc\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9daedab3-fb2d-461e-b861-71790eead4f6\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-a4af4a39-4135-47fb-b175-47fbdf85311d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-a6fb4358-5bf4-4ad7-ba82-2cd2f41ce5e9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"setting-a6fb4358-5bf4-4ad7-ba82-2cd2f41ce5e9\": {\r\n    \"value\": \"enabled\"\r\n  },\r\n  \"effect-a70ca396-0a34-413a-88e1-b956c1e683be\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-aa633080-8b72-40c4-a2d7-d00c03e80bed\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-abfb4388-5bf4-4ad7-ba82-2cd2f41ceae9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-abfb7388-5bf4-4ad7-ba99-2cd2f41cebb9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-af6cd1bd-1635-48cb-bde7-5b15693900b9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b7ddfbdc-1260-477d-91fd-98bd9be789a6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c3f317a7-a95c-4547-b7e7-11017ebdf2fe\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-cb510bfd-1cba-4d9f-a230-cb0976f4bb71\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e1e5fd5d-3e4c-4ce1-8661-7d1873ae6b15\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e2c1c086-2d84-4019-bff3-c44ccd95113c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e3576e28-8b17-4677-84c3-db2990658d64\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e8cbc669-f12d-49eb-93e7-9273119e9933\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e9c8d085-d9cc-4b17-9cdc-059f1f01f19e\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ebb62a0c-3560-49e1-89ed-27e074e9f8ad\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-efbde977-ba53-4479-b8e9-10b957924fbf\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f0e6e85b-9b9f-4a4b-b67b-f730d42f1b0b\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f6de0be7-9a8a-4b8a-b349-43cf02d22f7c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f8456c1c-aa66-4dfb-861a-25d127b775c9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f9d614c5-c173-4d56-95a7-b4437057d193\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-fb893a29-21bb-418c-a157-e99480ec364c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-feedbf84-6b99-488c-acc2-71c829aa5ffc\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-3b980d31-7904-4bb7-8575-5665739a8052\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-6e2593d9-add6-4083-9c9b-4b7d2188c899\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b607c5de-e7d9-4eee-9e5c-83f1bcee4fa0\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-12430be1-6cc8-4527-a9a8-e3d38f250096\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"modeRequirement-12430be1-6cc8-4527-a9a8-e3d38f250096\": {\r\n    \"value\": \"Detection\"\r\n  },\r\n  \"effect-425bea59-a659-4cbb-8d31-34499bd030b8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"modeRequirement-425bea59-a659-4cbb-8d31-34499bd030b8\": {\r\n    \"value\": \"Detection\"\r\n  },\r\n  \"effect-564feb30-bf6a-4854-b4bb-0d2d2d1e6c66\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-055aa869-bc98-4af8-bafc-23f1ab6ffe2c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-013e242c-8828-4970-87b3-ab247555486d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-d38fc420-0735-4ef3-ac11-c806f651a570\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-a1181c5f-672a-477a-979a-7d58aa086233\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-308fbb08-4ab8-4e67-9b29-592e93fb94fa\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-4da35fc9-c9e7-4960-aec9-797fe7d9051d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-523b5cd1-3e23-492f-a539-13118b6d1e3a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-7fe3b40f-802b-4cdd-8bd4-fd799c948cc2\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-c25d9a16-bc35-4e15-a7e5-9db606bf9ed4\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b0f33259-77d7-4c9e-aac6-3aabcfae693c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-037eea7a-bd0a-46c5-9a66-03aea78705d3\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0725b4dd-7e76-479c-a735-68e7ee23d5ca\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0820b7b9-23aa-4725-a1ce-ae4558f718e5\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-2c89a2e5-7285-40fe-afe0-ae8654b92fab\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-358c20a6-3f9e-4f0e-97ff-c6ce485e2aac\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-5744710e-cc2f-4ee8-8809-3b11e89f4bc9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ac4a19c2-fa67-49b4-8ae5-0b2e78c49457\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c9d007d0-c057-4772-b18c-01e546713bcd\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d0793b48-0edc-4296-a390-4c75d1bdfd71\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-e372f825-a257-4fb8-9175-797a8a8627d6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d158790f-bfb0-486c-8631-2dc6b4e8e6af\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-e802a67a-daf5-4436-9ea6-f6d821dd0c5d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-a451c1ef-c6ca-483d-87ed-f49761e3ffb5\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftSql-servers-firewallRules-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftNetwork-networkSecurityGroups-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftClassicNetwork-networkSecurityGroups-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftNetwork-networkSecurityGroups-securityRules-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftClassicNetwork-networkSecurityGroups-securityRules-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ae89ebca-1c92-4898-ac2c-9f63decb045c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-d26f7642-7545-4e18-9b75-8c9bbdee3a9a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-1a4e592a-6a6e-44a5-9814-e36264ca96e7\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-7796937f-307b-4598-941c-67d3a05ebfe7\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-c5447c04-a4d7-4ba8-a263-c9ee321a6858\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-41388f1c-2db0-4c25-95b2-35d7f5ccbfa9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b02aacc0-b073-424e-8298-42b22829ee0a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-057d6cfe-9c4f-4a6d-bc60-14420ea1f1a9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0ec47710-77ff-4a3d-9181-6aa50af424d0\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-48af4db5-9b8b-401c-8e74-076be876a430\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-82339799-d096-41ae-8538-b108becf0970\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1b7aa243-30e4-4c9e-bca8-d0d3022b634a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ef2a8f2a-b3d9-49cd-a8a8-9a3aaaf647d9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-bb91dfba-c30d-4263-9add-9c2384e659a6\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e71308d3-144b-4262-b144-efdc3cc90517\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-2bdd0062-9d75-436e-89df-487dd8e4b3c7\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"effect-4733ea7b-a883-42fe-8cac-97454c2a9e4a\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-67121cc7-ff39-4ab8-b7e3-95b84dab487d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-6fac406b-40ca-413b-bf8e-0bf964659c25\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-81e74cea-30fd-40d5-802f-d72103c2aaaa\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c349d81b-9985-44ae-a8da-ff98d108ede8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-f4b53539-8df9-40e4-86c6-6b607703bd4e\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ec068d99-e9c7-401f-8cef-5bdde4e6ccf1\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-048248b0-55cd-46da-b1ff-39efd52db260\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0d134df8-db83-46fb-ad72-fe0c9428c8dd\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-2c89a2e5-7285-40fe-afe0-ae8654b92fb2\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-3657f5a0-770e-44a3-b44e-9431ba1e9735\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-5b9159ae-1701-4a6f-9a7a-aa9c8ddd0580\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-617c02be-7f02-4efd-8836-3180d47b6c68\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7d7be79c-23ba-4033-84dd-45e2a5ccdd67\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-87ba29ef-1ab3-4d82-b763-87fcd4f531f7\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-f7d52b2d-e161-4dfa-a82b-55e564167385\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c43e4a30-77cb-48ab-a4dd-93f175c63b57\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0b60c0b2-2dc2-4e1c-b5c9-abbed971de53\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1e66c121-a66a-4b1f-9b83-0fd99bf0fc2d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1f314764-cb73-4fc9-b863-8eca98ac36e9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-123a3936-f020-408a-ba0c-47873faf1534\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"resourceGroupName-b6e2945c-0b7b-40f5-9233-7a5323b5cdc6\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                            "modifiedAssignment": "[if(and(equals(toLower(environment().name), toLower('AzureCloud')), equals(toLower(parameters('builtInAssignment')), toLower('IL5'))), 'NISTRev4', parameters('builtInAssignment'))]",
                            "assignmentName": "[format('{0} {1}', variables('modifiedAssignment'), resourceGroup().name)]",
                            "agentVmssAssignmentName": "[format('Deploy VMSS Agents {0}', resourceGroup().name)]",
                            "agentVmAssignmentName": "[format('Deploy VM Agents {0}', resourceGroup().name)]",
                            "contributorRoleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                            "lawsReaderRoleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '92aaf0da-9dab-42b6-94a3-d43ce8d16293')]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/policyAssignments",
                              "apiVersion": "2020-09-01",
                              "name": "[variables('assignmentName')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "policyDefinitionId": "[createObject('NISTRev4', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/cf25b9c1-bd23-4eb6-bd2c-f4f3ac644a5f', 'parameters', union(json(variables('$fxv#0')), createObject('listOfMembersToIncludeInWindowsVMAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership')), 'logAnalyticsWorkspaceIdforVMReporting', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]))))), 'NISTRev5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/179d1daa-458f-4e47-8086-2a68d0d6c38f', 'parameters', json(variables('$fxv#1'))), 'IL5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/f9a961fa-3241-4b20-adc4-bbf8ad9d7197', 'parameters', union(json(variables('$fxv#2')), createObject('logAnalyticsWorkspaceIDForVMAgents', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])), 'membersToIncludeInLocalAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership'))))), 'CMMC', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/b5629c75-5c77-4422-87b9-2509e680f8de', 'parameters', union(json(variables('$fxv#3')), createObject('logAnalyticsWorkspaceId-f47b5582-33ec-4c5c-87c0-b010a6b2e917', createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]), '2021-06-01').customerId)), if(equals('AzureCloud', environment().name), createObject('MembersToExclude-69bf4abd-ca1e-4cf6-8b5a-762d42e61d4f', createObject('value', 'admin'), 'MembersToInclude-30f71ea1-ac77-4f26-9fc5-2d926bbd4ba7', createObject('value', parameters('windowsAdministratorsGroupMembership'))), createObject()))))[variables('modifiedAssignment')].id]",
                                "parameters": "[createObject('NISTRev4', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/cf25b9c1-bd23-4eb6-bd2c-f4f3ac644a5f', 'parameters', union(json(variables('$fxv#0')), createObject('listOfMembersToIncludeInWindowsVMAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership')), 'logAnalyticsWorkspaceIdforVMReporting', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]))))), 'NISTRev5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/179d1daa-458f-4e47-8086-2a68d0d6c38f', 'parameters', json(variables('$fxv#1'))), 'IL5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/f9a961fa-3241-4b20-adc4-bbf8ad9d7197', 'parameters', union(json(variables('$fxv#2')), createObject('logAnalyticsWorkspaceIDForVMAgents', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])), 'membersToIncludeInLocalAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership'))))), 'CMMC', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/b5629c75-5c77-4422-87b9-2509e680f8de', 'parameters', union(json(variables('$fxv#3')), createObject('logAnalyticsWorkspaceId-f47b5582-33ec-4c5c-87c0-b010a6b2e917', createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]), '2021-06-01').customerId)), if(equals('AzureCloud', environment().name), createObject('MembersToExclude-69bf4abd-ca1e-4cf6-8b5a-762d42e61d4f', createObject('value', 'admin'), 'MembersToInclude-30f71ea1-ac77-4f26-9fc5-2d926bbd4ba7', createObject('value', parameters('windowsAdministratorsGroupMembership'))), createObject()))))[variables('modifiedAssignment')].parameters]"
                              },
                              "identity": {
                                "type": "SystemAssigned"
                              }
                            },
                            {
                              "type": "Microsoft.Authorization/policyAssignments",
                              "apiVersion": "2020-09-01",
                              "name": "[variables('agentVmssAssignmentName')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "policyDefinitionId": "[tenantResourceId('Microsoft.Authorization/policySetDefinitions', '75714362-cae7-409e-9b99-a8e5075b7fad')]",
                                "parameters": {
                                  "logAnalytics_1": {
                                    "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])]"
                                  }
                                }
                              },
                              "identity": {
                                "type": "SystemAssigned"
                              }
                            },
                            {
                              "type": "Microsoft.Authorization/policyAssignments",
                              "apiVersion": "2020-09-01",
                              "name": "[variables('agentVmAssignmentName')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "policyDefinitionId": "[tenantResourceId('Microsoft.Authorization/policySetDefinitions', '55f3eceb-5573-4f18-9695-226972c6d74a')]",
                                "parameters": {
                                  "logAnalytics_1": {
                                    "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])]"
                                  }
                                }
                              },
                              "identity": {
                                "type": "SystemAssigned"
                              }
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[guid(variables('contributorRoleDefinitionId'), variables('assignmentName'))]",
                              "properties": {
                                "roleDefinitionId": "[variables('contributorRoleDefinitionId')]",
                                "principalId": "[if(empty(variables('modifiedAssignment')), '', reference(resourceId('Microsoft.Authorization/policyAssignments', variables('assignmentName')), '2020-09-01', 'full').identity.principalId)]",
                                "principalType": "ServicePrincipal"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Authorization/policyAssignments', variables('assignmentName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[guid(variables('contributorRoleDefinitionId'), variables('agentVmssAssignmentName'))]",
                              "properties": {
                                "roleDefinitionId": "[variables('contributorRoleDefinitionId')]",
                                "principalId": "[reference(resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmssAssignmentName')), '2020-09-01', 'full').identity.principalId]",
                                "principalType": "ServicePrincipal"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmssAssignmentName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[guid(variables('contributorRoleDefinitionId'), variables('agentVmAssignmentName'))]",
                              "properties": {
                                "roleDefinitionId": "[variables('contributorRoleDefinitionId')]",
                                "principalId": "[reference(resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName')), '2020-09-01', 'full').identity.principalId]",
                                "principalType": "ServicePrincipal"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]"
                              ]
                            },
                            {
                              "condition": "[parameters('deployRemediation')]",
                              "type": "Microsoft.PolicyInsights/remediations",
                              "apiVersion": "2019-07-01",
                              "name": "VM-Agent-Policy-Remediation",
                              "properties": {
                                "policyAssignmentId": "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]",
                                "resourceDiscoveryMode": "ReEvaluateCompliance"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('Assign-Laws-Role-Policy-{0}', resourceGroup().name)]",
                              "subscriptionId": "[split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2]]",
                              "resourceGroup": "[split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "targetResourceId": {
                                    "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])]"
                                  },
                                  "roleDefinitionId": {
                                    "value": "[variables('lawsReaderRoleDefinitionId')]"
                                  },
                                  "principalId": {
                                    "value": "[reference(resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName')), '2020-09-01', 'full').identity.principalId]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "14523277430573151351"
                                    }
                                  },
                                  "parameters": {
                                    "targetResourceId": {
                                      "type": "string"
                                    },
                                    "roleDefinitionId": {
                                      "type": "string"
                                    },
                                    "principalId": {
                                      "type": "string"
                                    },
                                    "principalType": {
                                      "type": "string",
                                      "defaultValue": "ServicePrincipal",
                                      "allowedValues": [
                                        "ForeignGroup",
                                        "Group",
                                        "ServicePrincipal",
                                        "User"
                                      ]
                                    },
                                    "description": {
                                      "type": "string",
                                      "defaultValue": ""
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "name": "[guid(parameters('targetResourceId'), parameters('roleDefinitionId'), parameters('principalId'))]",
                                      "properties": {
                                        "principalId": "[parameters('principalId')]",
                                        "principalType": "[parameters('principalType')]",
                                        "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                        "description": "[parameters('description')]"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]"
                              ]
                            }
                          ]
                        }
                      }
                    },
                    {
                      "copy": {
                        "name": "defenderForCloud",
                        "count": "[length(parameters('tiers'))]",
                        "mode": "serial",
                        "batchSize": 1
                      },
                      "condition": "[parameters('deployDefender')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('set-defender-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tiers')[copyIndex()].subscriptionId]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "defenderPlans": {
                            "value": "[parameters('defenderPlans')]"
                          },
                          "defenderSkuTier": {
                            "value": "[parameters('defenderSkuTier')]"
                          },
                          "emailSecurityContact": {
                            "value": "[parameters('emailSecurityContact')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "1552299118443631720"
                            }
                          },
                          "parameters": {
                            "defenderPlans": {
                              "type": "array",
                              "defaultValue": [
                                "VirtualMachines"
                              ],
                              "metadata": {
                                "description": "Defender Paid protection Plans. Even if a customer selects the free sku, at least 1 paid protection plan must be specified."
                              }
                            },
                            "emailSecurityContact": {
                              "type": "string",
                              "metadata": {
                                "description": "Email address of the contact, in the form of john@doe.com"
                              }
                            },
                            "policySetDescription": {
                              "type": "string",
                              "defaultValue": "The Microsoft Cloud Security Benchmark initiative represents the policies and controls implementing security recommendations defined in Microsoft Cloud Security Benchmark v2, see https://aka.ms/azsecbm. This also serves as the Microsoft Defender for Cloud default policy initiative. You can directly assign this initiative, or manage its policies and compliance results within Microsoft Defender.",
                              "metadata": {
                                "description": "Policy Initiative description field"
                              }
                            },
                            "defenderSkuTier": {
                              "type": "string",
                              "defaultValue": "Free",
                              "metadata": {
                                "description": "[Standard/Free] The SKU for Defender. It defaults to \"Free\"."
                              }
                            }
                          },
                          "variables": {
                            "defenderPaidPlanConfig": {
                              "AzureCloud": {
                                "Api": {
                                  "subPlan": "P1"
                                },
                                "appServices": {},
                                "KeyVaults": {
                                  "subPlan": "PerKeyVault"
                                },
                                "Arm": {
                                  "subPlan": "PerSubscription"
                                },
                                "CloudPosture": {
                                  "extensions": [
                                    {
                                      "name": "SensitiveDataDiscovery",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "ContainerRegistriesVulnerabilityAssessments",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "AgentlessDiscoveryForKubernetes",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "AgentlessVmScanning",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "EntraPermissionsManagement",
                                      "isEnabled": "True"
                                    }
                                  ]
                                },
                                "Containers": {
                                  "extensions": [
                                    {
                                      "name": "ContainerRegistriesVulnerabilityAssessments",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "AgentlessDiscoveryForKubernetes",
                                      "isEnabled": "True"
                                    }
                                  ]
                                },
                                "CosmosDbs": {},
                                "StorageAccounts": {
                                  "subPlan": "DefenderForStorageV2",
                                  "extensions": [
                                    {
                                      "name": "OnUploadMalwareScanning",
                                      "isEnabled": "True",
                                      "additionalExtensionProperties": {
                                        "CapGBPerMonthPerStorageAccount": "5000"
                                      }
                                    },
                                    {
                                      "name": "SensitiveDataDiscovery",
                                      "isEnabled": "True"
                                    }
                                  ]
                                },
                                "VirtualMachines": {
                                  "subPlan": "P1"
                                },
                                "SqlServerVirtualMachines": {},
                                "SqlServers": {},
                                "OpenSourceRelationalDatabases": {}
                              }
                            }
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "defenderFreeAllClouds",
                                "count": "[length(parameters('defenderPlans'))]",
                                "mode": "serial",
                                "batchSize": 1
                              },
                              "condition": "[equals(parameters('defenderSkuTier'), 'Free')]",
                              "type": "Microsoft.Security/pricings",
                              "apiVersion": "2023-01-01",
                              "name": "[parameters('defenderPlans')[copyIndex()]]",
                              "properties": {
                                "pricingTier": "[parameters('defenderSkuTier')]"
                              }
                            },
                            {
                              "copy": {
                                "name": "defenderStandardNoSubplanNoExtensions",
                                "count": "[length(parameters('defenderPlans'))]",
                                "mode": "serial",
                                "batchSize": 1
                              },
                              "condition": "[and(equals(parameters('defenderSkuTier'), 'Standard'), not(equals(environment().name, 'AzureCloud')))]",
                              "type": "Microsoft.Security/pricings",
                              "apiVersion": "2023-01-01",
                              "name": "[parameters('defenderPlans')[copyIndex()]]",
                              "properties": {
                                "pricingTier": "[parameters('defenderSkuTier')]"
                              }
                            },
                            {
                              "copy": {
                                "name": "defenderStandardSubplanExtensionsAzureCloud",
                                "count": "[length(parameters('defenderPlans'))]",
                                "mode": "serial",
                                "batchSize": 1
                              },
                              "condition": "[and(equals(parameters('defenderSkuTier'), 'Standard'), equals(environment().name, 'AzureCloud'))]",
                              "type": "Microsoft.Security/pricings",
                              "apiVersion": "2023-01-01",
                              "name": "[parameters('defenderPlans')[copyIndex()]]",
                              "properties": {
                                "pricingTier": "[parameters('defenderSkuTier')]",
                                "subPlan": "[coalesce(tryGet(variables('defenderPaidPlanConfig')[environment().name][parameters('defenderPlans')[copyIndex()]], 'subPlan'), null())]",
                                "extensions": "[coalesce(tryGet(variables('defenderPaidPlanConfig')[environment().name][parameters('defenderPlans')[copyIndex()]], 'extensions'), null())]"
                              }
                            },
                            {
                              "condition": "[not(empty(parameters('emailSecurityContact')))]",
                              "type": "Microsoft.Security/securityContacts",
                              "apiVersion": "2020-01-01-preview",
                              "name": "default",
                              "properties": {
                                "notificationsByRole": {
                                  "roles": [
                                    "AccountAdmin",
                                    "Contributor",
                                    "Owner",
                                    "ServiceAdmin"
                                  ],
                                  "state": "On"
                                },
                                "alertNotifications": {
                                  "state": "On"
                                },
                                "emails": "[parameters('emailSecurityContact')]"
                              }
                            },
                            {
                              "type": "Microsoft.Authorization/policyAssignments",
                              "apiVersion": "2022-06-01",
                              "name": "Microsoft Cloud Security Benchmark",
                              "properties": {
                                "displayName": "Defender Default",
                                "description": "[parameters('policySetDescription')]",
                                "enforcementMode": "DoNotEnforce",
                                "parameters": {},
                                "policyDefinitionId": "[tenantResourceId('Microsoft.Authorization/policySetDefinitions', '1f3afdf9-d0c9-4c3d-847f-89da613e70a8')]"
                              }
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId(parameters('operationsSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix')))]"
              ]
            }
          ],
          "outputs": {
            "azureFirewallResourceId": {
              "type": "string",
              "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.azureFirewallResourceId.value]"
            },
            "domainControllerResourceIds": {
              "type": "array",
              "value": "[if(and(parameters('deployActiveDirectoryDomainServices'), parameters('deployIdentity')), reference(subscriptionResourceId(parameters('identitySubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-adds-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualMachineResourceIds.value, createArray())]"
            },
            "hubStorageAccountResourceId": {
              "type": "string",
              "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-diag-storage-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.storageAccountResourceIds.value[0]]"
            },
            "hubVirtualNetworkResourceId": {
              "type": "string",
              "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.hubVirtualNetworkResourceId.value]"
            },
            "logAnalyticsWorkspaceResourceId": {
              "type": "string",
              "value": "[reference(subscriptionResourceId(parameters('operationsSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.logAnalyticsWorkspaceResourceId.value]"
            },
            "privateLinkScopeResourceId": {
              "type": "string",
              "value": "[reference(subscriptionResourceId(parameters('operationsSubscriptionId'), 'Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateLinkScopeResourceId.value]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-domain-user-account-{0}', parameters('deploymentNameSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploymentNameSuffix": {
            "value": "[parameters('deploymentNameSuffix')]"
          },
          "domainUserPassword": {
            "value": "[parameters('domainUserPassword')]"
          },
          "domainUserUsername": {
            "value": "[parameters('domainUserUsername')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "virtualMachineResourceIds": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-mission-landing-zone-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.domainControllerResourceIds.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "3799117593269943758"
            }
          },
          "parameters": {
            "deploymentNameSuffix": {
              "type": "string"
            },
            "domainUserPassword": {
              "type": "securestring"
            },
            "domainUserUsername": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "virtualMachineResourceIds": {
              "type": "array"
            }
          },
          "variables": {
            "$fxv#0": "param (\r\n    [string]$DomainUserPassword,\r\n    [string]$DomainUserUsername\r\n)\r\nImport-Module ActiveDirectory -ErrorAction Stop\r\n$SecureDomainUserPassword = ConvertTo-SecureString -String $DomainUserPassword -AsPlainText -Force\r\nNew-ADUser `\r\n    -Name $DomainUserUsername `\r\n    -AccountPassword $SecureDomainUserPassword `\r\n    -Enabled $true `\r\n    -ChangePasswordAtLogon $false `\r\n    -PasswordNeverExpires $true",
            "resourceGroupName": "[split(parameters('virtualMachineResourceIds')[0], '/')[4]]",
            "subscriptionId": "[split(parameters('virtualMachineResourceIds')[0], '/')[2]]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('new-domain-user-account-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[variables('subscriptionId')]",
              "resourceGroup": "[variables('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "name": {
                    "value": "New-DomainUserAccount"
                  },
                  "parameters": {
                    "value": [
                      {
                        "name": "DomainUserUsername",
                        "value": "[parameters('domainUserUsername')]"
                      }
                    ]
                  },
                  "protectedParameters": {
                    "value": "[format('[{{''name'':''DomainUserPassword'',''value'':''{0}''}}]', parameters('domainUserPassword'))]"
                  },
                  "script": {
                    "value": "[variables('$fxv#0')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "virtualMachineName": {
                    "value": "[split(parameters('virtualMachineResourceIds')[0], '/')[8]]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "8333305544299446105"
                    }
                  },
                  "parameters": {
                    "asyncExecution": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "location": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "parameters": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "protectedParameters": {
                      "type": "securestring"
                    },
                    "script": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "treatFailureAsDeploymentFailure": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "virtualMachineName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2023-09-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), parameters('name'))]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "asyncExecution": "[parameters('asyncExecution')]",
                        "parameters": "[parameters('parameters')]",
                        "protectedParameters": "[json(parameters('protectedParameters'))]",
                        "source": {
                          "script": "[parameters('script')]"
                        },
                        "treatFailureAsDeploymentFailure": "[parameters('treatFailureAsDeploymentFailure')]"
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-mission-landing-zone-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-azure-netapp-files-{0}', parameters('deploymentNameSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "azureFirewallResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-mission-landing-zone-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.azureFirewallResourceId.value]"
          },
          "deployActivityLogDiagnosticSetting": {
            "value": true
          },
          "deployDefender": {
            "value": true
          },
          "deploymentNameSuffix": {
            "value": "[parameters('deploymentNameSuffix')]"
          },
          "deployPolicy": {
            "value": "[parameters('deployPolicy')]"
          },
          "domainJoinPassword": {
            "value": "[parameters('domainAdministratorPassword')]"
          },
          "domainJoinUserPrincipalName": {
            "value": "[format('{0}@{1}', parameters('domainAdministratorUsername'), parameters('addsDomainName'))]"
          },
          "domainName": {
            "value": "[parameters('addsDomainName')]"
          },
          "environmentAbbreviation": {
            "value": "[parameters('environmentAbbreviation')]"
          },
          "fileShareName": {
            "value": "arcgispro"
          },
          "hubStorageAccountResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-mission-landing-zone-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.hubStorageAccountResourceId.value]"
          },
          "hubVirtualNetworkResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-mission-landing-zone-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.hubVirtualNetworkResourceId.value]"
          },
          "identifier": {
            "value": "[parameters('identifier')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-mission-landing-zone-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.logAnalyticsWorkspaceResourceId.value]"
          },
          "policy": {
            "value": "[parameters('policy')]"
          },
          "sku": {
            "value": "Standard"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "3021924587065305043"
            }
          },
          "parameters": {
            "azureFirewallResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Azure Firewall in the HUB."
              }
            },
            "azureNetAppFilesSubnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.161.0/24",
              "metadata": {
                "description": "The address prefix for the workload subnet."
              }
            },
            "deployActivityLogDiagnosticSetting": {
              "type": "bool",
              "metadata": {
                "description": "Choose whether to deploy a diagnostic setting for the Activity Log."
              }
            },
            "deployDefender": {
              "type": "bool",
              "metadata": {
                "description": "Choose whether to deploy Defender for Cloud."
              }
            },
            "deploymentNameSuffix": {
              "type": "string",
              "defaultValue": "[utcNow()]",
              "metadata": {
                "description": "The suffix to append to the deployment name. It defaults to the current UTC date and time."
              }
            },
            "deployNetworkWatcherTrafficAnalytics": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When set to true, deploys Network Watcher Traffic Analytics. It defaults to \"false\"."
              }
            },
            "deployPolicy": {
              "type": "bool",
              "metadata": {
                "description": "Choose whether to deploy a policy assignment."
              }
            },
            "domainJoinPassword": {
              "type": "securestring",
              "metadata": {
                "description": "The password for the account to domain join the AVD session hosts."
              }
            },
            "domainJoinUserPrincipalName": {
              "type": "string",
              "metadata": {
                "description": "The user principal name for the account to domain join the AVD session hosts."
              }
            },
            "domainName": {
              "type": "string",
              "metadata": {
                "description": "The name of the domain that provides ADDS to the AVD session hosts."
              }
            },
            "emailSecurityContact": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The email address to use for Defender for Cloud notifications."
              }
            },
            "environmentAbbreviation": {
              "type": "string",
              "defaultValue": "dev",
              "allowedValues": [
                "dev",
                "prod",
                "test"
              ],
              "metadata": {
                "description": "The abbreviation for the environment."
              }
            },
            "fileShareName": {
              "type": "string",
              "metadata": {
                "description": "The name of the file share"
              }
            },
            "hubStorageAccountResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the HUB Storage Account."
              }
            },
            "hubVirtualNetworkResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the HUB Virtual Network."
              }
            },
            "identifier": {
              "type": "string",
              "maxLength": 3,
              "metadata": {
                "description": "The identifier for the resource names. This value should represent the workload, project, or business unit."
              }
            },
            "keyVaultDiagnosticLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AuditEvent",
                  "enabled": true
                },
                {
                  "category": "AzurePolicyEvaluationDetails",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Key Vault Diagnostic Logs categories to collect. See \"https://learn.microsoft.com/en-us/azure/key-vault/general/logging?tabs=Vault\" for valid values."
              }
            },
            "keyVaultDiagnosticMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AllMetrics",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "The Key Vault Diagnostic Metrics to collect. See the following URL for valid settings: \"https://learn.microsoft.com/azure/key-vault/general/logging?tabs=Vault\"."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[deployment().location]",
              "metadata": {
                "description": "The location for the deployment. It defaults to the location of the deployment."
              }
            },
            "logAnalyticsWorkspaceResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Log Analytics Workspace to use for log storage."
              }
            },
            "logStorageSkuName": {
              "type": "string",
              "defaultValue": "Standard_GRS",
              "metadata": {
                "description": "The Storage Account SKU to use for log storage. It defaults to \"Standard_GRS\". See https://docs.microsoft.com/en-us/rest/api/storagerp/srp_sku_types for valid settings."
              }
            },
            "networkInterfaceDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AllMetrics",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of metrics to enable on the diagnostic setting for network interfaces."
              }
            },
            "networkSecurityGroupDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "NetworkSecurityGroupEvent",
                  "enabled": true
                },
                {
                  "category": "NetworkSecurityGroupRuleCounter",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "An array of Network Security Group diagnostic logs to apply to the workload Virtual Network. See https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-nsg-manage-log#log-categories for valid settings."
              }
            },
            "networkSecurityGroupRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The rules to apply to the Network Security Group."
              }
            },
            "networkWatcherFlowLogsRetentionDays": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "The number of days to retain Network Watcher Flow Logs. It defaults to \"30\"."
              }
            },
            "networkWatcherFlowLogsType": {
              "type": "string",
              "defaultValue": "VirtualNetwork",
              "allowedValues": [
                "NetworkSecurityGroup",
                "VirtualNetwork"
              ],
              "metadata": {
                "description": "When set to \"true\", enables Virtual Network Flow Logs. It defaults to \"true\" as its required by MCSB."
              }
            },
            "organizationalUnitPath": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The distinguished name for the target Organization Unit in Active Directory Domain Services."
              }
            },
            "policy": {
              "type": "string",
              "defaultValue": "NISTRev4",
              "metadata": {
                "description": "The policy to assign to the workload."
              }
            },
            "sku": {
              "type": "string",
              "allowedValues": [
                "Premium",
                "Standard"
              ],
              "metadata": {
                "description": "The performance SKU for Azure NetApp Files."
              }
            },
            "subnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.160.0/24",
              "metadata": {
                "description": "The address prefix for the subnet containing the private endpoints."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags to apply to the resources."
              }
            },
            "virtualNetworkAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.160.0/23",
              "metadata": {
                "description": "The address prefix for the workload Virtual Network."
              }
            },
            "virtualNetworkDiagnosticsLogs": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "VMProtectionAlerts",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "The diagnostic logs to apply to the workload Virtual Network."
              }
            },
            "virtualNetworkDiagnosticsMetrics": {
              "type": "array",
              "defaultValue": [
                {
                  "category": "AllMetrics",
                  "enabled": true
                }
              ],
              "metadata": {
                "description": "The metrics to monitor for the workload Virtual Network."
              }
            },
            "workloadName": {
              "type": "string",
              "defaultValue": "netAppFile",
              "minLength": 1,
              "maxLength": 10,
              "metadata": {
                "description": "The name for the workload."
              }
            },
            "workloadShortName": {
              "type": "string",
              "defaultValue": "anf",
              "minLength": 1,
              "maxLength": 3,
              "metadata": {
                "description": "The short name for the workload."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "additionalSubnets": {
                    "value": [
                      {
                        "name": "azure-netapp-files",
                        "properties": {
                          "addressPrefix": "[parameters('azureNetAppFilesSubnetAddressPrefix')]"
                        }
                      }
                    ]
                  },
                  "deployActivityLogDiagnosticSetting": {
                    "value": "[parameters('deployActivityLogDiagnosticSetting')]"
                  },
                  "deployDefender": {
                    "value": "[parameters('deployDefender')]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "deployNetworkWatcherTrafficAnalytics": {
                    "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                  },
                  "deployPolicy": {
                    "value": "[parameters('deployPolicy')]"
                  },
                  "emailSecurityContact": {
                    "value": "[parameters('emailSecurityContact')]"
                  },
                  "environmentAbbreviation": {
                    "value": "[parameters('environmentAbbreviation')]"
                  },
                  "firewallResourceId": {
                    "value": "[parameters('azureFirewallResourceId')]"
                  },
                  "hubStorageAccountResourceId": {
                    "value": "[parameters('hubStorageAccountResourceId')]"
                  },
                  "hubVirtualNetworkResourceId": {
                    "value": "[parameters('hubVirtualNetworkResourceId')]"
                  },
                  "identifier": {
                    "value": "[parameters('identifier')]"
                  },
                  "keyVaultDiagnosticLogs": {
                    "value": "[parameters('keyVaultDiagnosticLogs')]"
                  },
                  "keyVaultDiagnosticMetrics": {
                    "value": "[parameters('keyVaultDiagnosticMetrics')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "logStorageSkuName": {
                    "value": "[parameters('logStorageSkuName')]"
                  },
                  "networkInterfaceDiagnosticsMetrics": {
                    "value": "[parameters('networkInterfaceDiagnosticsMetrics')]"
                  },
                  "networkSecurityGroupDiagnosticsLogs": {
                    "value": "[parameters('networkSecurityGroupDiagnosticsLogs')]"
                  },
                  "networkSecurityGroupRules": {
                    "value": "[parameters('networkSecurityGroupRules')]"
                  },
                  "networkWatcherFlowLogsRetentionDays": {
                    "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                  },
                  "networkWatcherFlowLogsType": {
                    "value": "[parameters('networkWatcherFlowLogsType')]"
                  },
                  "policy": {
                    "value": "[parameters('policy')]"
                  },
                  "subnetAddressPrefix": {
                    "value": "[parameters('subnetAddressPrefix')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "virtualNetworkAddressPrefix": {
                    "value": "[parameters('virtualNetworkAddressPrefix')]"
                  },
                  "virtualNetworkDiagnosticsLogs": {
                    "value": "[parameters('virtualNetworkDiagnosticsLogs')]"
                  },
                  "virtualNetworkDiagnosticsMetrics": {
                    "value": "[parameters('virtualNetworkDiagnosticsMetrics')]"
                  },
                  "workloadName": {
                    "value": "[parameters('workloadName')]"
                  },
                  "workloadShortName": {
                    "value": "[parameters('workloadShortName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "9289611236508112440"
                    }
                  },
                  "parameters": {
                    "additionalSubnets": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "An array of additional subnets to support the tier3 workload."
                      }
                    },
                    "blobDiagnosticsLogs": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "categoryGroup": "allLogs",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Blob Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/blobs/monitor-blob-storage?tabs=azure-portal#enable-diagnostic-logging."
                      }
                    },
                    "blobDiagnosticsMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "Transaction",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Blob Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/blobs/monitor-blob-storage?tabs=azure-portal#enable-metrics."
                      }
                    },
                    "customFirewallRuleCollectionGroups": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "The custom firewall rule collection groups that override the default firewall rule collection groups."
                      }
                    },
                    "deployActivityLogDiagnosticSetting": {
                      "type": "bool",
                      "metadata": {
                        "description": "Choose whether to deploy a diagnostic setting for the Activity Log."
                      }
                    },
                    "deployDefender": {
                      "type": "bool",
                      "metadata": {
                        "description": "Choose whether to deploy Defender for Cloud."
                      }
                    },
                    "deploymentNameSuffix": {
                      "type": "string",
                      "defaultValue": "[utcNow()]",
                      "metadata": {
                        "description": "The suffix to append to the deployment name. It defaults to the current UTC date and time."
                      }
                    },
                    "deployNetworkWatcherTrafficAnalytics": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "When set to true, deploys Network Watcher Traffic Analytics. It defaults to \"false\"."
                      }
                    },
                    "deployPolicy": {
                      "type": "bool",
                      "metadata": {
                        "description": "Choose whether to deploy a policy assignment."
                      }
                    },
                    "emailSecurityContact": {
                      "type": "string",
                      "metadata": {
                        "description": "The email address to use for Defender for Cloud notifications."
                      }
                    },
                    "environmentAbbreviation": {
                      "type": "string",
                      "defaultValue": "dev",
                      "allowedValues": [
                        "dev",
                        "prod",
                        "test"
                      ],
                      "metadata": {
                        "description": "The abbreviation for the environment."
                      }
                    },
                    "fileDiagnosticsLogs": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "categoryGroup": "allLogs",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of File Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/files/monitor-file-storage?tabs=azure-portal#enable-diagnostic-logging."
                      }
                    },
                    "fileDiagnosticsMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "Transaction",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of File Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/files/monitor-file-storage?tabs=azure-portal#enable-metrics."
                      }
                    },
                    "firewallResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the Azure Firewall in the HUB."
                      }
                    },
                    "hubStorageAccountResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the HUB Storage Account."
                      }
                    },
                    "hubVirtualNetworkResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the HUB Virtual Network."
                      }
                    },
                    "identifier": {
                      "type": "string",
                      "maxLength": 3,
                      "metadata": {
                        "description": "The identifier for the resource names. This value should represent the workload, project, or business unit."
                      }
                    },
                    "keyVaultDiagnosticLogs": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "AuditEvent",
                          "enabled": true
                        },
                        {
                          "category": "AzurePolicyEvaluationDetails",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Key Vault Diagnostic Logs categories to collect. See \"https://learn.microsoft.com/en-us/azure/key-vault/general/logging?tabs=Vault\" for valid values."
                      }
                    },
                    "keyVaultDiagnosticMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "AllMetrics",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "The Key Vault Diagnostic Metrics to collect. See the following URL for valid settings: \"https://learn.microsoft.com/azure/key-vault/general/logging?tabs=Vault\"."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[deployment().location]",
                      "metadata": {
                        "description": "The location for the deployment. It defaults to the location of the deployment."
                      }
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the Log Analytics Workspace to use for log storage."
                      }
                    },
                    "logStorageSkuName": {
                      "type": "string",
                      "defaultValue": "Standard_GRS",
                      "metadata": {
                        "description": "The Storage Account SKU to use for log storage. It defaults to \"Standard_GRS\". See https://docs.microsoft.com/en-us/rest/api/storagerp/srp_sku_types for valid settings."
                      }
                    },
                    "networkInterfaceDiagnosticsMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "AllMetrics",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of metrics to enable on the diagnostic setting for network interfaces."
                      }
                    },
                    "networkSecurityGroupDiagnosticsLogs": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "NetworkSecurityGroupEvent",
                          "enabled": true
                        },
                        {
                          "category": "NetworkSecurityGroupRuleCounter",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Network Security Group diagnostic logs to apply to the workload Virtual Network. See https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-nsg-manage-log#log-categories for valid settings."
                      }
                    },
                    "networkSecurityGroupRules": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "The rules to apply to the Network Security Group."
                      }
                    },
                    "networkWatcherFlowLogsRetentionDays": {
                      "type": "int",
                      "defaultValue": 30,
                      "metadata": {
                        "description": "The number of days to retain Network Watcher Flow Logs. It defaults to \"30\"."
                      }
                    },
                    "networkWatcherFlowLogsType": {
                      "type": "string",
                      "defaultValue": "VirtualNetwork",
                      "allowedValues": [
                        "NetworkSecurityGroup",
                        "VirtualNetwork"
                      ],
                      "metadata": {
                        "description": "When set to \"true\", enables Virtual Network Flow Logs. It defaults to \"true\" as its required by MCSB."
                      }
                    },
                    "queueDiagnosticsLogs": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "categoryGroup": "allLogs",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Queue Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/queues/monitor-queue-storage?tabs=azure-portal#enable-diagnostic-logging."
                      }
                    },
                    "queueDiagnosticsMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "Transaction",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Queue Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/queues/monitor-queue-storage?tabs=azure-portal#enable-metrics."
                      }
                    },
                    "policy": {
                      "type": "string",
                      "defaultValue": "NISTRev4",
                      "metadata": {
                        "description": "The policy to assign to the workload."
                      }
                    },
                    "stampIndex": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The stamp index allows for multiple deployments of a similar workload without naming conflicts."
                      }
                    },
                    "storageAccountDiagnosticsLogs": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "An array of Storage Account Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/common/monitor-storage?tabs=azure-portal#enable-diagnostic-logging."
                      }
                    },
                    "storageAccountDiagnosticsMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "Transaction",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Storage Account Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/common/monitor-storage?tabs=azure-portal#enable-metrics."
                      }
                    },
                    "subnetAddressPrefix": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The address prefix for the workload subnet."
                      }
                    },
                    "subnetName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The custom name for the workload subnet if the naming convention is not desired. Subnets are child resources and do not require a unique name between virtual networks, only within the same virtual network."
                      }
                    },
                    "tableDiagnosticsLogs": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "categoryGroup": "allLogs",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Table Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/tables/monitor-table-storage?tabs=azure-portal#enable-diagnostic-logging."
                      }
                    },
                    "tableDiagnosticsMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "Transaction",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Table Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/tables/monitor-table-storage?tabs=azure-portal#enable-metrics."
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "The tags to apply to the resources."
                      }
                    },
                    "virtualNetworkAddressPrefix": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The address prefix for the workload Virtual Network."
                      }
                    },
                    "virtualNetworkDiagnosticsLogs": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "VMProtectionAlerts",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "The diagnostic logs to apply to the workload Virtual Network."
                      }
                    },
                    "virtualNetworkDiagnosticsMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "AllMetrics",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "The metrics to monitor for the workload Virtual Network."
                      }
                    },
                    "windowsAdministratorsGroupMembership": {
                      "type": "string",
                      "defaultValue": "xadmin",
                      "metadata": {
                        "description": "The local administrator username for Windows virtual machines. This value is needed if you plan to deploy the following Azure Policy initiatives: CMMC Level 3, DoD Impact Level 5, or NIST SP 800-53 Rev. 4 It defaults to \"xadmin\"."
                      }
                    },
                    "workloadName": {
                      "type": "string",
                      "defaultValue": "tier3",
                      "minLength": 1,
                      "maxLength": 10,
                      "metadata": {
                        "description": "The name for the workload."
                      }
                    },
                    "workloadShortName": {
                      "type": "string",
                      "defaultValue": "t3",
                      "minLength": 1,
                      "maxLength": 3,
                      "metadata": {
                        "description": "The short name for the workload."
                      }
                    }
                  },
                  "variables": {
                    "hubResourceGroupName": "[split(parameters('hubVirtualNetworkResourceId'), '/')[4]]",
                    "hubSubscriptionId": "[split(parameters('hubVirtualNetworkResourceId'), '/')[2]]",
                    "deploymentIndex": "[if(empty(parameters('stampIndex')), '', format('{0}-', parameters('stampIndex')))]",
                    "subscriptionId": "[subscription().subscriptionId]"
                  },
                  "resources": [
                    {
                      "condition": "[not(empty(parameters('customFirewallRuleCollectionGroups')))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-firewall-rules-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[variables('hubSubscriptionId')]",
                      "resourceGroup": "[variables('hubResourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "firewallPolicyName": {
                            "value": "[split(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('firewallResourceId'), '/')[2], split(parameters('firewallResourceId'), '/')[4]), 'Microsoft.Network/azureFirewalls', split(parameters('firewallResourceId'), '/')[8]), '2020-11-01').firewallPolicy.id, '/')[8]]"
                          },
                          "firewallRuleCollectionGroups": {
                            "value": "[parameters('customFirewallRuleCollectionGroups')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "8588468010825274521"
                            }
                          },
                          "parameters": {
                            "firewallPolicyName": {
                              "type": "string"
                            },
                            "firewallRuleCollectionGroups": {
                              "type": "array"
                            }
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "ruleCreate",
                                "count": "[length(parameters('firewallRuleCollectionGroups'))]",
                                "mode": "serial",
                                "batchSize": 1
                              },
                              "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
                              "apiVersion": "2024-03-01",
                              "name": "[format('{0}/{1}', parameters('firewallPolicyName'), parameters('firewallRuleCollectionGroups')[copyIndex()].name)]",
                              "properties": "[parameters('firewallRuleCollectionGroups')[copyIndex()].properties]"
                            }
                          ]
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('get-vnet-peerings-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "virtualNetworkPeerings": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hubVirtualNetworkResourceId'), '/')[2], split(parameters('hubVirtualNetworkResourceId'), '/')[4]), 'Microsoft.Network/virtualNetworks', split(parameters('hubVirtualNetworkResourceId'), '/')[8]), '2023-11-01').virtualNetworkPeerings]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "518768753620066763"
                            }
                          },
                          "parameters": {
                            "virtualNetworkPeerings": {
                              "type": "array"
                            }
                          },
                          "variables": {
                            "copy": [
                              {
                                "name": "resourceIds",
                                "count": "[length(parameters('virtualNetworkPeerings'))]",
                                "input": "[parameters('virtualNetworkPeerings')[copyIndex('resourceIds')].properties.remoteVirtualNetwork.id]"
                              },
                              {
                                "name": "subscriptionIds",
                                "count": "[length(variables('resourceIds'))]",
                                "input": "[split(variables('resourceIds')[copyIndex('subscriptionIds')], '/')[2]]"
                              }
                            ]
                          },
                          "resources": [],
                          "outputs": {
                            "subscriptionIds": {
                              "type": "array",
                              "value": "[variables('subscriptionIds')]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "additionalSubnets": {
                            "value": "[parameters('additionalSubnets')]"
                          },
                          "deploymentIndex": {
                            "value": "[variables('deploymentIndex')]"
                          },
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "environmentAbbreviation": {
                            "value": "[parameters('environmentAbbreviation')]"
                          },
                          "hubVirtualNetworkResourceId": {
                            "value": "[parameters('hubVirtualNetworkResourceId')]"
                          },
                          "identifier": {
                            "value": "[parameters('identifier')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "network": {
                            "value": {
                              "name": "[parameters('workloadName')]",
                              "nsgDiagLogs": "[parameters('networkSecurityGroupDiagnosticsLogs')]",
                              "nsgRules": "[parameters('networkSecurityGroupRules')]",
                              "shortName": "[parameters('workloadShortName')]",
                              "subnetAddressPrefix": "[parameters('subnetAddressPrefix')]",
                              "subscriptionId": "[variables('subscriptionId')]",
                              "vnetAddressPrefix": "[parameters('virtualNetworkAddressPrefix')]",
                              "vnetDiagLogs": "[parameters('virtualNetworkDiagnosticsLogs')]",
                              "vnetDiagMetrics": "[parameters('virtualNetworkDiagnosticsMetrics')]"
                            }
                          },
                          "routeTableRouteNextHopIpAddress": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('firewallResourceId'), '/')[2], split(parameters('firewallResourceId'), '/')[4]), 'Microsoft.Network/azureFirewalls', split(parameters('firewallResourceId'), '/')[8]), '2020-11-01').ipConfigurations[0].properties.privateIPAddress]"
                          },
                          "stampIndex": {
                            "value": "[parameters('stampIndex')]"
                          },
                          "subnetName": {
                            "value": "[parameters('subnetName')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "vNetDnsServers": {
                            "value": "[coalesce(tryGet(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hubVirtualNetworkResourceId'), '/')[2], split(parameters('hubVirtualNetworkResourceId'), '/')[4]), 'Microsoft.Network/virtualNetworks', split(parameters('hubVirtualNetworkResourceId'), '/')[8]), '2023-11-01'), 'dhcpOptions', 'dnsServers'), createArray())]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "659833522225265916"
                            }
                          },
                          "parameters": {
                            "additionalSubnets": {
                              "type": "array"
                            },
                            "deploymentIndex": {
                              "type": "string"
                            },
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "environmentAbbreviation": {
                              "type": "string"
                            },
                            "hubVirtualNetworkResourceId": {
                              "type": "string"
                            },
                            "identifier": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "network": {
                              "type": "object"
                            },
                            "routeTableRouteNextHopIpAddress": {
                              "type": "string"
                            },
                            "stampIndex": {
                              "type": "string"
                            },
                            "subnetName": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "vNetDnsServers": {
                              "type": "array"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "delimiter": {
                                    "value": "-"
                                  },
                                  "deploymentNameSuffix": {
                                    "value": "[parameters('deploymentNameSuffix')]"
                                  },
                                  "environmentAbbreviation": {
                                    "value": "[parameters('environmentAbbreviation')]"
                                  },
                                  "identifier": {
                                    "value": "[parameters('identifier')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "networks": {
                                    "value": [
                                      "[parameters('network')]"
                                    ]
                                  },
                                  "stampIndex": {
                                    "value": "[parameters('stampIndex')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "14956586253638960991"
                                    }
                                  },
                                  "parameters": {
                                    "delimiter": {
                                      "type": "string"
                                    },
                                    "deploymentNameSuffix": {
                                      "type": "string"
                                    },
                                    "environmentAbbreviation": {
                                      "type": "string"
                                    },
                                    "identifier": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "networks": {
                                      "type": "array"
                                    },
                                    "stampIndex": {
                                      "type": "string",
                                      "defaultValue": ""
                                    }
                                  },
                                  "variables": {
                                    "$fxv#0": {
                                      "AzureChina": {
                                        "chinaeast": {
                                          "abbreviation": "cne",
                                          "recoveryServicesGeo": "sha",
                                          "timeDifference": "+8:00",
                                          "timeZone": "China Standard Time"
                                        },
                                        "chinaeast2": {
                                          "abbreviation": "cne2",
                                          "recoveryServicesGeo": "sha2",
                                          "timeDifference": "+8:00",
                                          "timeZone": "China Standard Time"
                                        },
                                        "chinanorth": {
                                          "abbreviation": "cnn",
                                          "recoveryServicesGeo": "bjb",
                                          "timeDifference": "+8:00",
                                          "timeZone": "China Standard Time"
                                        },
                                        "chinanorth2": {
                                          "abbreviation": "cnn2",
                                          "recoveryServicesGeo": "bjb2",
                                          "timeDifference": "+8:00",
                                          "timeZone": "China Standard Time"
                                        }
                                      },
                                      "AzureCloud": {
                                        "australiacentral": {
                                          "abbreviation": "auc",
                                          "recoveryServicesGeo": "acl",
                                          "timeDifference": "+10:00",
                                          "timeZone": "AUS Eastern Standard Time"
                                        },
                                        "australiacentral2": {
                                          "abbreviation": "auc2",
                                          "recoveryServicesGeo": "acl2",
                                          "timeDifference": "+10:00",
                                          "timeZone": "AUS Eastern Standard Time"
                                        },
                                        "australiaeast": {
                                          "abbreviation": "aue",
                                          "recoveryServicesGeo": "ae",
                                          "timeDifference": "+10:00",
                                          "timeZone": "AUS Eastern Standard Time"
                                        },
                                        "australiasoutheast": {
                                          "abbreviation": "ause",
                                          "recoveryServicesGeo": "ase",
                                          "timeDifference": "+10:00",
                                          "timeZone": "AUS Eastern Standard Time"
                                        },
                                        "brazilsouth": {
                                          "abbreviation": "brs",
                                          "recoveryServicesGeo": "brs",
                                          "timeDifference": "-3:00",
                                          "timeZone": "E. South America Standard Time"
                                        },
                                        "brazilsoutheast": {
                                          "abbreviation": "brse",
                                          "recoveryServicesGeo": "bse",
                                          "timeDifference": "-3:00",
                                          "timeZone": "E. South America Standard Time"
                                        },
                                        "canadacentral": {
                                          "abbreviation": "cac",
                                          "recoveryServicesGeo": "cnc",
                                          "timeDifference": "-5:00",
                                          "timeZone": "Eastern Standard Time"
                                        },
                                        "canadaeast": {
                                          "abbreviation": "cae",
                                          "recoveryServicesGeo": "cne",
                                          "timeDifference": "-5:00",
                                          "timeZone": "Eastern Standard Time"
                                        },
                                        "centralindia": {
                                          "abbreviation": "inc",
                                          "recoveryServicesGeo": "inc",
                                          "timeDifference": "+5:30",
                                          "timeZone": "India Standard Time"
                                        },
                                        "centralus": {
                                          "abbreviation": "usc",
                                          "recoveryServicesGeo": "cus",
                                          "timeDifference": "-6:00",
                                          "timeZone": "Central Standard Time"
                                        },
                                        "eastasia": {
                                          "abbreviation": "ase",
                                          "recoveryServicesGeo": "ea",
                                          "timeDifference": "+8:00",
                                          "timeZone": "China Standard Time"
                                        },
                                        "eastus": {
                                          "abbreviation": "use",
                                          "recoveryServicesGeo": "eus",
                                          "timeDifference": "-5:00",
                                          "timeZone": "Eastern Standard Time"
                                        },
                                        "eastus2": {
                                          "abbreviation": "use2",
                                          "recoveryServicesGeo": "eus2",
                                          "timeDifference": "-5:00",
                                          "timeZone": "Eastern Standard Time"
                                        },
                                        "francecentral": {
                                          "abbreviation": "frc",
                                          "recoveryServicesGeo": "frc",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "francesouth": {
                                          "abbreviation": "frs",
                                          "recoveryServicesGeo": "frs",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "germanynorth": {
                                          "abbreviation": "den",
                                          "recoveryServicesGeo": "gn",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "germanywestcentral": {
                                          "abbreviation": "dewc",
                                          "recoveryServicesGeo": "gwc",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "israelcentral": {
                                          "abbreviation": "ilc",
                                          "recoveryServicesGeo": "ilc",
                                          "timeDifference": "+2:00",
                                          "timeZone": "Israel Standard Time"
                                        },
                                        "italynorth": {
                                          "abbreviation": "itn",
                                          "recoveryServicesGeo": "itn",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "japaneast": {
                                          "abbreviation": "jpe",
                                          "recoveryServicesGeo": "jpe",
                                          "timeDifference": "+9:00",
                                          "timeZone": "Tokyo Standard Time"
                                        },
                                        "japanwest": {
                                          "abbreviation": "jpw",
                                          "recoveryServicesGeo": "jpw",
                                          "timeDifference": "+9:00",
                                          "timeZone": "Tokyo Standard Time"
                                        },
                                        "jioindiacentral": {
                                          "abbreviation": "injc",
                                          "recoveryServicesGeo": "jic",
                                          "timeDifference": "+5:30",
                                          "timeZone": "India Standard Time"
                                        },
                                        "jioindiawest": {
                                          "abbreviation": "injw",
                                          "recoveryServicesGeo": "jiw",
                                          "timeDifference": "+5:30",
                                          "timeZone": "India Standard Time"
                                        },
                                        "koreacentral": {
                                          "abbreviation": "krc",
                                          "recoveryServicesGeo": "krc",
                                          "timeDifference": "+9:00",
                                          "timeZone": "Korea Standard Time"
                                        },
                                        "koreasouth": {
                                          "abbreviation": "krs",
                                          "recoveryServicesGeo": "krs",
                                          "timeDifference": "+9:00",
                                          "timeZone": "Korea Standard Time"
                                        },
                                        "northcentralus": {
                                          "abbreviation": "usnc",
                                          "recoveryServicesGeo": "ncus",
                                          "timeDifference": "-6:00",
                                          "timeZone": "Central Standard Time"
                                        },
                                        "northeurope": {
                                          "abbreviation": "eun",
                                          "recoveryServicesGeo": "ne",
                                          "timeDifference": "0:00",
                                          "timeZone": "GMT Standard Time"
                                        },
                                        "norwayeast": {
                                          "abbreviation": "noe",
                                          "recoveryServicesGeo": "nwe",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "norwaywest": {
                                          "abbreviation": "now",
                                          "recoveryServicesGeo": "nww",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "polandcentral": {
                                          "abbreviation": "plc",
                                          "recoveryServicesGeo": "plc",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "qatarcentral": {
                                          "abbreviation": "qac",
                                          "recoveryServicesGeo": "qac",
                                          "timeDifference": "+3:00",
                                          "timeZone": "Arabian Standard Time"
                                        },
                                        "southafricanorth": {
                                          "abbreviation": "zan",
                                          "recoveryServicesGeo": "san",
                                          "timeDifference": "+2:00",
                                          "timeZone": "South Africa Standard Time"
                                        },
                                        "southafricawest": {
                                          "abbreviation": "zaw",
                                          "recoveryServicesGeo": "saw",
                                          "timeDifference": "+2:00",
                                          "timeZone": "South Africa Standard Time"
                                        },
                                        "southcentralus": {
                                          "abbreviation": "ussc",
                                          "recoveryServicesGeo": "scus",
                                          "timeDifference": "-6:00",
                                          "timeZone": "Central Standard Time"
                                        },
                                        "southeastasia": {
                                          "abbreviation": "asse",
                                          "recoveryServicesGeo": "sea",
                                          "timeDifference": "+8:00",
                                          "timeZone": "Singapore Standard Time"
                                        },
                                        "southindia": {
                                          "abbreviation": "ins",
                                          "recoveryServicesGeo": "ins",
                                          "timeDifference": "+5:30",
                                          "timeZone": "India Standard Time"
                                        },
                                        "swedencentral": {
                                          "abbreviation": "sec",
                                          "recoveryServicesGeo": "sdc",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "switzerlandnorth": {
                                          "abbreviation": "chn",
                                          "recoveryServicesGeo": "szn",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "switzerlandwest": {
                                          "abbreviation": "chw",
                                          "recoveryServicesGeo": "szw",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "uaecentral": {
                                          "abbreviation": "aec",
                                          "recoveryServicesGeo": "uac",
                                          "timeDifference": "+3:00",
                                          "timeZone": "Arabian Standard Time"
                                        },
                                        "uaenorth": {
                                          "abbreviation": "aen",
                                          "recoveryServicesGeo": "uan",
                                          "timeDifference": "+3:00",
                                          "timeZone": "Arabian Standard Time"
                                        },
                                        "uksouth": {
                                          "abbreviation": "uks",
                                          "recoveryServicesGeo": "uks",
                                          "timeDifference": "0:00",
                                          "timeZone": "GMT Standard Time"
                                        },
                                        "ukwest": {
                                          "abbreviation": "ukw",
                                          "recoveryServicesGeo": "ukw",
                                          "timeDifference": "0:00",
                                          "timeZone": "GMT Standard Time"
                                        },
                                        "westcentralus": {
                                          "abbreviation": "uswc",
                                          "recoveryServicesGeo": "wcus",
                                          "timeDifference": "-7:00",
                                          "timeZone": "Mountain Standard Time"
                                        },
                                        "westeurope": {
                                          "abbreviation": "euw",
                                          "recoveryServicesGeo": "we",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "westindia": {
                                          "abbreviation": "inw",
                                          "recoveryServicesGeo": "inw",
                                          "timeDifference": "+5:30",
                                          "timeZone": "India Standard Time"
                                        },
                                        "westus": {
                                          "abbreviation": "usw",
                                          "recoveryServicesGeo": "wus",
                                          "timeDifference": "-8:00",
                                          "timeZone": "Pacific Standard Time"
                                        },
                                        "westus2": {
                                          "abbreviation": "usw2",
                                          "recoveryServicesGeo": "wus2",
                                          "timeDifference": "-8:00",
                                          "timeZone": "Pacific Standard Time"
                                        },
                                        "westus3": {
                                          "abbreviation": "usw3",
                                          "recoveryServicesGeo": "wus3",
                                          "timeDifference": "-7:00",
                                          "timeZone": "Mountain Standard Time"
                                        }
                                      },
                                      "AzureUSGovernment": {
                                        "usdodcentral": {
                                          "abbreviation": "dodc",
                                          "recoveryServicesGeo": "udc",
                                          "timeDifference": "-6:00",
                                          "timeZone": "Central Standard Time"
                                        },
                                        "usdodeast": {
                                          "abbreviation": "dode",
                                          "recoveryServicesGeo": "ude",
                                          "timeDifference": "-5:00",
                                          "timeZone": "Eastern Standard Time"
                                        },
                                        "usgovarizona": {
                                          "abbreviation": "az",
                                          "recoveryServicesGeo": "uga",
                                          "timeDifference": "-7:00",
                                          "timeZone": "Mountain Standard Time"
                                        },
                                        "usgovtexas": {
                                          "abbreviation": "tx",
                                          "recoveryServicesGeo": "ugt",
                                          "timeDifference": "-6:00",
                                          "timeZone": "Central Standard Time"
                                        },
                                        "usgovvirginia": {
                                          "abbreviation": "va",
                                          "recoveryServicesGeo": "ugv",
                                          "timeDifference": "-5:00",
                                          "timeZone": "Eastern Standard Time"
                                        }
                                      }
                                    },
                                    "$fxv#1": "1.0.0",
                                    "$fxv#2": {
                                      "actionGroups": "ag",
                                      "applicationGroups": "vdag",
                                      "applicationInsights": "appi",
                                      "appServicePlans": "asp",
                                      "automationAccounts": "aa",
                                      "availabilitySets": "avail",
                                      "azureFirewalls": "afw",
                                      "bastionHosts": "bas",
                                      "computeGallieries": "cg",
                                      "dataCollectionEndpoints": "dce",
                                      "dataCollectionRuleAssociations": "dcra",
                                      "dataCollectionRules": "dcr",
                                      "diagnosticSettings": "diag",
                                      "diskAccesses": "da",
                                      "diskEncryptionSets": "des",
                                      "disks": "disk",
                                      "firewallPolicies": "afwp",
                                      "applicationGateways": "agw",
                                      "applicationGatewayWafPolicies": "agwwafp",
                                      "functionApps": "func",
                                      "hostPools": "vdpool",
                                      "ipConfigurations": "ipconf",
                                      "keyVaults": "kv",
                                      "localNetworkGateways": "lgw",
                                      "logAnalyticsWorkspaces": "log",
                                      "natGateways": "ng",
                                      "netAppAccounts": "naa",
                                      "netAppAccountsCapacityPools": "cp",
                                      "networkInterfaces": "nic",
                                      "networkSecurityGroups": "nsg",
                                      "networkWatchers": "nw",
                                      "networkWatchersFlowLogs": "fl",
                                      "privateEndpoints": "pe",
                                      "privateLinkScopes": "pls",
                                      "publicIPAddresses": "pip",
                                      "publicIPPrefixes": "ippre",
                                      "recoveryServicesVaults": "rsv",
                                      "remoteApplicationGroups": "vdag",
                                      "resourceGroups": "rg",
                                      "routeTables": "rt",
                                      "scalingPlans": "vdscaling",
                                      "storageAccounts": "st",
                                      "subnets": "snet",
                                      "userAssignedIdentities": "id",
                                      "virtualMachines": "vm",
                                      "virtualNetworkGateways": "vgw",
                                      "virtualNetworks": "vnet",
                                      "workspaces": "vdws"
                                    },
                                    "directionShortNames": {
                                      "east": "e",
                                      "eastcentral": "ec",
                                      "north": "n",
                                      "northcentral": "nc",
                                      "south": "s",
                                      "southcentral": "sc",
                                      "west": "w",
                                      "westcentral": "wc"
                                    },
                                    "environmentName": {
                                      "dev": "Development",
                                      "prod": "Production",
                                      "test": "Test"
                                    },
                                    "locations": "[coalesce(tryGet(variables('$fxv#0'), environment().name), createObject(format('{0}', parameters('location')), createObject('abbreviation', variables('directionShortNames')[skip(parameters('location'), sub(length(parameters('location')), 4))], 'timeDifference', if(contains(parameters('location'), 'east'), '-5:00', if(contains(parameters('location'), 'west'), '-8:00', '0:00')), 'timeZone', if(contains(parameters('location'), 'east'), 'Eastern Standard Time', if(contains(parameters('location'), 'west'), 'Pacific Standard Time', 'GMT Standard Time')))))]",
                                    "mlzTags": {
                                      "environment": "[variables('environmentName')[parameters('environmentAbbreviation')]]",
                                      "identifier": "[parameters('identifier')]",
                                      "landingZoneName": "MissionLandingZone",
                                      "landingZoneVersion": "[variables('$fxv#1')]"
                                    },
                                    "resourceAbbreviations": "[variables('$fxv#2')]"
                                  },
                                  "resources": [
                                    {
                                      "copy": {
                                        "name": "namingConventions",
                                        "count": "[length(parameters('networks'))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('naming-convention-{0}-{1}', parameters('networks')[copyIndex()].shortName, parameters('deploymentNameSuffix'))]",
                                      "location": "[deployment().location]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "delimiter": {
                                            "value": "[parameters('delimiter')]"
                                          },
                                          "environmentAbbreviation": {
                                            "value": "[parameters('environmentAbbreviation')]"
                                          },
                                          "identifier": {
                                            "value": "[parameters('identifier')]"
                                          },
                                          "locationAbbreviation": {
                                            "value": "[variables('locations')[parameters('location')].abbreviation]"
                                          },
                                          "networkName": {
                                            "value": "[parameters('networks')[copyIndex()].name]"
                                          },
                                          "resourceAbbreviations": {
                                            "value": "[variables('resourceAbbreviations')]"
                                          },
                                          "stampIndex": {
                                            "value": "[parameters('stampIndex')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "6403027296801861578"
                                            }
                                          },
                                          "parameters": {
                                            "delimiter": {
                                              "type": "string",
                                              "allowedValues": [
                                                "",
                                                "-"
                                              ]
                                            },
                                            "environmentAbbreviation": {
                                              "type": "string"
                                            },
                                            "identifier": {
                                              "type": "string"
                                            },
                                            "locationAbbreviation": {
                                              "type": "string"
                                            },
                                            "networkName": {
                                              "type": "string"
                                            },
                                            "resourceAbbreviations": {
                                              "type": "object"
                                            },
                                            "stampIndex": {
                                              "type": "string",
                                              "defaultValue": ""
                                            }
                                          },
                                          "variables": {
                                            "tokens": {
                                              "purpose": "purpose_token",
                                              "resource": "resource_token",
                                              "service": "service_token"
                                            },
                                            "namingConvention": "[format('{0}{1}{2}{3}{4}{5}{6}{7}{8}{9}{10}{11}', toLower(parameters('identifier')), parameters('delimiter'), parameters('environmentAbbreviation'), parameters('delimiter'), parameters('locationAbbreviation'), parameters('delimiter'), parameters('networkName'), parameters('delimiter'), variables('tokens').resource, parameters('delimiter'), variables('tokens').purpose, if(empty(parameters('stampIndex')), '', format('{0}{1}', parameters('delimiter'), parameters('stampIndex'))))]",
                                            "namingConvention_Service": "[format('{0}{1}{2}{3}{4}{5}{6}{7}{8}{9}{10}{11}{12}{13}', toLower(parameters('identifier')), parameters('delimiter'), parameters('environmentAbbreviation'), parameters('delimiter'), parameters('locationAbbreviation'), parameters('delimiter'), parameters('networkName'), parameters('delimiter'), variables('tokens').service, parameters('delimiter'), variables('tokens').resource, parameters('delimiter'), variables('tokens').purpose, if(empty(parameters('stampIndex')), '', format('{0}{1}', parameters('delimiter'), parameters('stampIndex'))))]",
                                            "names": {
                                              "actionGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').actionGroups)]",
                                              "applicationGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationGroups)]",
                                              "applicationInsights": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationInsights)]",
                                              "appServicePlan": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').appServicePlans)]",
                                              "automationAccount": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').automationAccounts)]",
                                              "automationAccountDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').automationAccounts)]",
                                              "automationAccountNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').automationAccounts)]",
                                              "automationAccountPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').automationAccounts)]",
                                              "availabilitySet": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').availabilitySets)]",
                                              "azureFirewall": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').azureFirewalls)]",
                                              "azureFirewallPublicIPAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').azureFirewalls)]",
                                              "azureFirewallPublicIPAddressDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').publicIPAddresses, parameters('delimiter'), parameters('resourceAbbreviations').azureFirewalls))]",
                                              "azureFirewallDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').azureFirewalls)]",
                                              "azureFirewallPolicy": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').firewallPolicies)]",
                                              "applicationGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationGateways)]",
                                              "applicationGatewayPublicIPAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                                              "applicationGatewayDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                                              "applicationGatewayWafPolicy": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationGatewayWafPolicies)]",
                                              "applicationGatewayWafPolicyDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').applicationGatewayWafPolicies)]",
                                              "applicationGatewayRouteTable": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').routeTables), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                                              "applicationGatewayNetworkSecurityGroup": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkSecurityGroups), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                                              "bastionHost": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').bastionHosts)]",
                                              "bastionHostDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').bastionHosts)]",
                                              "bastionHostNetworkSecurityGroup": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkSecurityGroups), variables('tokens').service, parameters('resourceAbbreviations').bastionHosts)]",
                                              "bastionHostNetworkSecurityGroupDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').networkSecurityGroups, parameters('delimiter'), parameters('resourceAbbreviations').bastionHosts))]",
                                              "bastionHostPublicIPAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').bastionHosts)]",
                                              "bastionHostPublicIPAddressDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').publicIPAddresses, parameters('delimiter'), parameters('resourceAbbreviations').bastionHosts))]",
                                              "computeGallery": "[replace(replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').computeGallieries), parameters('delimiter'), if(empty(parameters('delimiter')), '', '_'))]",
                                              "dataCollectionEndpoint": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').dataCollectionEndpoints)]",
                                              "dataCollectionRuleAssociation": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').dataCollectionRuleAssociations)]",
                                              "dataCollectionRule": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').dataCollectionRules)]",
                                              "diskAccess": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').diskAccesses)]",
                                              "diskAccessNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').diskAccesses)]",
                                              "diskAccessPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').diskAccesses)]",
                                              "diskEncryptionSet": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').diskEncryptionSets)]",
                                              "functionApp": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').functionApps)]",
                                              "functionAppNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').functionApps)]",
                                              "functionAppPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').functionApps)]",
                                              "hostPool": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').hostPools)]",
                                              "hostPoolDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').hostPools)]",
                                              "hostPoolNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').hostPools)]",
                                              "hostPoolPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').hostPools)]",
                                              "keyVault": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').keyVaults)]",
                                              "keyVaultDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').keyVaults)]",
                                              "keyVaultNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').keyVaults)]",
                                              "keyVaultPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').keyVaults)]",
                                              "localNetworkGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').localNetworkGateways)]",
                                              "logAnalyticsWorkspace": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').logAnalyticsWorkspaces)]",
                                              "logAnalyticsWorkspaceDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').logAnalyticsWorkspaces)]",
                                              "natGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').natGateways)]",
                                              "natGatewayPublicIPPrefix": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPPrefixes), variables('tokens').service, parameters('resourceAbbreviations').natGateways)]",
                                              "netAppAccount": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').netAppAccounts)]",
                                              "netAppAccountCapacityPool": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').netAppAccountsCapacityPools), variables('tokens').service, parameters('resourceAbbreviations').netAppAccounts)]",
                                              "netAppAccountSmbServer": "[replace(replace(replace(replace(variables('namingConvention'), variables('tokens').resource, ''), parameters('environmentAbbreviation'), first(parameters('environmentAbbreviation'))), parameters('networkName'), ''), parameters('delimiter'), '')]",
                                              "networkSecurityGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').networkSecurityGroups)]",
                                              "networkSecurityGroupDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').networkSecurityGroups)]",
                                              "networkWatcherFlowLogsNetworkSecurityGroup": "[replace(variables('namingConvention'), variables('tokens').resource, format('{0}{1}{2}{3}{4}', parameters('resourceAbbreviations').networkWatchers, parameters('delimiter'), parameters('resourceAbbreviations').networkWatchersFlowLogs, parameters('delimiter'), parameters('resourceAbbreviations').networkSecurityGroups))]",
                                              "networkWatcherFlowLogsVirtualNetwork": "[replace(variables('namingConvention'), variables('tokens').resource, format('{0}{1}{2}{3}{4}', parameters('resourceAbbreviations').networkWatchers, parameters('delimiter'), parameters('resourceAbbreviations').networkWatchersFlowLogs, parameters('delimiter'), parameters('resourceAbbreviations').virtualNetworks))]",
                                              "privateLinkScope": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').privateLinkScopes)]",
                                              "privateLinkScopeNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').privateLinkScopes)]",
                                              "privateLinkScopePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').privateLinkScopes)]",
                                              "recoveryServicesVault": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').recoveryServicesVaults)]",
                                              "recoveryServicesVaultNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').recoveryServicesVaults)]",
                                              "recoveryServicesVaultPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').recoveryServicesVaults)]",
                                              "resourceGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').resourceGroups)]",
                                              "routeTable": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').routeTables)]",
                                              "scalingPlan": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').scalingPlans)]",
                                              "scalingPlanDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').scalingPlans)]",
                                              "storageAccount": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').storageAccounts)]",
                                              "storageAccountBlobDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}blob', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountBlobNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}blob', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountBlobPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}blob', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').storageAccounts)]",
                                              "storageAccountFileDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}file', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountFileNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}file', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountFilePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}file', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountQueueDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}queue', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountQueueNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}queue', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountQueuePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}queue', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountTableDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}table', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountTableNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}table', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountTablePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}table', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "subnet": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').subnets)]",
                                              "userAssignedIdentity": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').userAssignedIdentities)]",
                                              "virtualMachine": "[replace(replace(replace(replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').virtualMachines), parameters('environmentAbbreviation'), first(parameters('environmentAbbreviation'))), parameters('networkName'), ''), parameters('delimiter'), '')]",
                                              "virtualMachineDisk": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').disks), variables('tokens').service, format('{0}', parameters('resourceAbbreviations').virtualMachines))]",
                                              "virtualMachineNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').virtualMachines)]",
                                              "virtualMachineNetworkInterfaceDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').networkInterfaces, parameters('delimiter'), parameters('resourceAbbreviations').virtualMachines))]",
                                              "virtualNetwork": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').virtualNetworks)]",
                                              "virtualNetworkDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').virtualNetworks)]",
                                              "virtualNetworkGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').virtualNetworkGateways)]",
                                              "virtualNetworkGatewayPublicIpAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').virtualNetworkGateways)]",
                                              "workspace": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').workspaces)]",
                                              "workspaceDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').workspaces)]",
                                              "workspaceNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').workspaces)]",
                                              "workspacePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').workspaces)]"
                                            }
                                          },
                                          "resources": [],
                                          "outputs": {
                                            "delimiter": {
                                              "type": "string",
                                              "value": "[parameters('delimiter')]"
                                            },
                                            "names": {
                                              "type": "object",
                                              "value": "[variables('names')]"
                                            },
                                            "tokens": {
                                              "type": "object",
                                              "value": "[variables('tokens')]"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('private-dns-zones-{0}', parameters('deploymentNameSuffix'))]",
                                      "location": "[deployment().location]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {},
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "3047584333563107444"
                                            }
                                          },
                                          "variables": {
                                            "cloudSuffix": "[replace(replace(environment().resourceManager, 'https://management.azure.', ''), '/', '')]",
                                            "privateDnsZoneNames": "[union(createArray(format('privatelink.agentsvc.azure-automation.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureAutomation, environment().name), format('opinsights.azure.{0}', variables('cloudSuffix')))), format('privatelink.azure-automation.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureAutomation, environment().name), variables('cloudSuffix'))), format('privatelink.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureWebSites, environment().name), format('appservice.{0}', variables('cloudSuffix')))), format('scm.privatelink.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureWebSites, environment().name), format('appservice.{0}', variables('cloudSuffix')))), format('privatelink.wvd.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureVirtualDesktop, environment().name), variables('cloudSuffix'))), format('privatelink-global.wvd.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureVirtualDesktop, environment().name), variables('cloudSuffix'))), format('privatelink.file.{0}', environment().suffixes.storage), format('privatelink.queue.{0}', environment().suffixes.storage), format('privatelink.table.{0}', environment().suffixes.storage), format('privatelink.blob.{0}', environment().suffixes.storage), format('privatelink{0}', replace(environment().suffixes.keyvaultDns, 'vault', 'vaultcore')), format('privatelink.monitor.azure.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureMonitor, environment().name), variables('cloudSuffix'))), format('privatelink.ods.opinsights.azure.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureMonitor, environment().name), variables('cloudSuffix'))), format('privatelink.oms.opinsights.azure.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureMonitor, environment().name), variables('cloudSuffix'))), format('privatelink{0}', environment().suffixes.sqlServerHostname)), createArray())]",
                                            "privateDnsZoneSuffixes": {
                                              "azureAutomation": {
                                                "AzureCloud": "net",
                                                "AzureUSGovernment": "us"
                                              },
                                              "azureBackup": {
                                                "AzureCloud": "com",
                                                "AzureUSGovernment": "us"
                                              },
                                              "azureMonitor": {
                                                "AzureCloud": "com",
                                                "AzureUSGovernment": "us"
                                              },
                                              "azureVirtualDesktop": {
                                                "AzureCloud": "microsoft.com",
                                                "AzureUSGovernment": "azure.us"
                                              },
                                              "azureWebSites": {
                                                "AzureCloud": "azurewebsites.net",
                                                "AzureUSGovernment": "azurewebsites.us"
                                              }
                                            }
                                          },
                                          "resources": [],
                                          "outputs": {
                                            "names": {
                                              "type": "array",
                                              "value": "[variables('privateDnsZoneNames')]"
                                            }
                                          }
                                        }
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "delimiter": {
                                      "type": "string",
                                      "value": "[parameters('delimiter')]"
                                    },
                                    "locationProperties": {
                                      "type": "object",
                                      "value": "[variables('locations')[parameters('location')]]"
                                    },
                                    "mlzTags": {
                                      "type": "object",
                                      "value": "[variables('mlzTags')]"
                                    },
                                    "privateDnsZones": {
                                      "type": "array",
                                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value]"
                                    },
                                    "resourceAbbreviations": {
                                      "type": "object",
                                      "value": "[variables('resourceAbbreviations')]"
                                    },
                                    "tiers": {
                                      "type": "array",
                                      "copy": {
                                        "count": "[length(parameters('networks'))]",
                                        "input": {
                                          "name": "[parameters('networks')[copyIndex()].name]",
                                          "namingConvention": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('naming-convention-{0}-{1}', parameters('networks')[copyIndex()].shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value]",
                                          "nsgDiagLogs": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'nsgDiagLogs'), createArray())]",
                                          "nsgRules": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'nsgRules'), createArray())]",
                                          "shortName": "[parameters('networks')[copyIndex()].shortName]",
                                          "subnetAddressPrefix": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'subnetAddressPrefix'), '')]",
                                          "subscriptionId": "[parameters('networks')[copyIndex()].subscriptionId]",
                                          "vnetAddressPrefix": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'vnetAddressPrefix'), '')]",
                                          "vnetDiagLogs": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'vnetDiagLogs'), createArray())]",
                                          "vnetDiagMetrics": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'vnetDiagMetrics'), createArray())]"
                                        }
                                      }
                                    },
                                    "tokens": {
                                      "type": "object",
                                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('naming-convention-{0}-{1}', parameters('networks')[0].shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-rg-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "name": {
                                    "value": "[replace(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value[0].namingConvention.resourceGroup, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value.purpose, 'network')]"
                                  },
                                  "tags": {
                                    "value": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Resources/resourceGroups'), createObject()), reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value)]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "29921048879103880"
                                    }
                                  },
                                  "parameters": {
                                    "name": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object",
                                      "defaultValue": {}
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Resources/resourceGroups",
                                      "apiVersion": "2019-05-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]"
                                    }
                                  ],
                                  "outputs": {
                                    "id": {
                                      "type": "string",
                                      "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
                                    },
                                    "name": {
                                      "type": "string",
                                      "value": "[parameters('name')]"
                                    },
                                    "location": {
                                      "type": "string",
                                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').location]"
                                    },
                                    "tags": {
                                      "type": "object",
                                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').tags]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix')))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "additionalSubnets": {
                                    "value": "[parameters('additionalSubnets')]"
                                  },
                                  "customSubnetName": {
                                    "value": "[parameters('subnetName')]"
                                  },
                                  "delimiter": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                                  },
                                  "resourceGroupName": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                                  },
                                  "routeTableRouteNextHopIpAddress": {
                                    "value": "[parameters('routeTableRouteNextHopIpAddress')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  },
                                  "tier": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value[0]]"
                                  },
                                  "tokens": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                                  },
                                  "vNetDnsServers": {
                                    "value": "[parameters('vNetDnsServers')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "4292077791685791333"
                                    }
                                  },
                                  "parameters": {
                                    "additionalSubnets": {
                                      "type": "array",
                                      "defaultValue": []
                                    },
                                    "delimiter": {
                                      "type": "string"
                                    },
                                    "customSubnetName": {
                                      "type": "string",
                                      "defaultValue": ""
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "resourceGroupName": {
                                      "type": "string"
                                    },
                                    "routeTableRouteNextHopIpAddress": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object"
                                    },
                                    "tier": {
                                      "type": "object"
                                    },
                                    "tokens": {
                                      "type": "object"
                                    },
                                    "vNetDnsServers": {
                                      "type": "array"
                                    }
                                  },
                                  "variables": {
                                    "delegations": {
                                      "azure-netapp-files": [
                                        {
                                          "name": "Microsoft.Netapp.volumes",
                                          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/delegations', variables('virtualNetworkName'), 'azure-netapp-files', 'delegation')]",
                                          "properties": {
                                            "serviceName": "Microsoft.Netapp/volumes"
                                          },
                                          "type": "Microsoft.Network/virtualNetworks/subnets/delegations"
                                        }
                                      ],
                                      "function-app-outbound": [
                                        {
                                          "name": "Microsoft.Web/sites",
                                          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/delegations', variables('virtualNetworkName'), 'function-app-outbound', 'delegation')]",
                                          "properties": {
                                            "serviceName": "Microsoft.Web/serverfarms"
                                          },
                                          "type": "Microsoft.Network/virtualNetworks/subnets/delegations"
                                        }
                                      ]
                                    },
                                    "subnets": "[union(createArray(createObject('name', if(empty(parameters('customSubnetName')), replace(parameters('tier').namingConvention.subnet, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''), parameters('customSubnetName')), 'properties', createObject('addressPrefix', parameters('tier').subnetAddressPrefix))), parameters('additionalSubnets'))]",
                                    "subscriptionId": "[parameters('tier').subscriptionId]",
                                    "virtualNetworkName": "[replace(parameters('tier').namingConvention.virtualNetwork, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "networkSecurityGroup",
                                      "subscriptionId": "[variables('subscriptionId')]",
                                      "resourceGroup": "[parameters('resourceGroupName')]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "location": {
                                            "value": "[parameters('location')]"
                                          },
                                          "mlzTags": {
                                            "value": "[parameters('mlzTags')]"
                                          },
                                          "name": {
                                            "value": "[replace(parameters('tier').namingConvention.networkSecurityGroup, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                          },
                                          "securityRules": {
                                            "value": "[parameters('tier').nsgRules]"
                                          },
                                          "tags": {
                                            "value": "[parameters('tags')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "13291183460695095968"
                                            }
                                          },
                                          "parameters": {
                                            "location": {
                                              "type": "string"
                                            },
                                            "mlzTags": {
                                              "type": "object"
                                            },
                                            "name": {
                                              "type": "string"
                                            },
                                            "securityRules": {
                                              "type": "array"
                                            },
                                            "tags": {
                                              "type": "object"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/networkSecurityGroups",
                                              "apiVersion": "2021-02-01",
                                              "name": "[parameters('name')]",
                                              "location": "[parameters('location')]",
                                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkSecurityGroups'), createObject()), parameters('mlzTags'))]",
                                              "properties": {
                                                "securityRules": "[parameters('securityRules')]"
                                              }
                                            }
                                          ],
                                          "outputs": {
                                            "id": {
                                              "type": "string",
                                              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                                            },
                                            "name": {
                                              "type": "string",
                                              "value": "[parameters('name')]"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "routeTable",
                                      "subscriptionId": "[variables('subscriptionId')]",
                                      "resourceGroup": "[parameters('resourceGroupName')]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "disableBgpRoutePropagation": {
                                            "value": true
                                          },
                                          "location": {
                                            "value": "[parameters('location')]"
                                          },
                                          "mlzTags": {
                                            "value": "[parameters('mlzTags')]"
                                          },
                                          "name": {
                                            "value": "[replace(parameters('tier').namingConvention.routeTable, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                          },
                                          "routeNextHopIpAddress": {
                                            "value": "[parameters('routeTableRouteNextHopIpAddress')]"
                                          },
                                          "tags": {
                                            "value": "[parameters('tags')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "2680791520041812197"
                                            }
                                          },
                                          "parameters": {
                                            "disableBgpRoutePropagation": {
                                              "type": "bool"
                                            },
                                            "location": {
                                              "type": "string"
                                            },
                                            "mlzTags": {
                                              "type": "object"
                                            },
                                            "name": {
                                              "type": "string"
                                            },
                                            "routeAddressPrefix": {
                                              "type": "string",
                                              "defaultValue": "0.0.0.0/0"
                                            },
                                            "routeName": {
                                              "type": "string",
                                              "defaultValue": "default_route"
                                            },
                                            "routeNextHopIpAddress": {
                                              "type": "string"
                                            },
                                            "routeNextHopType": {
                                              "type": "string",
                                              "defaultValue": "VirtualAppliance"
                                            },
                                            "tags": {
                                              "type": "object"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/routeTables",
                                              "apiVersion": "2021-02-01",
                                              "name": "[parameters('name')]",
                                              "location": "[parameters('location')]",
                                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/routeTables'), createObject()), parameters('mlzTags'))]",
                                              "properties": {
                                                "disableBgpRoutePropagation": "[parameters('disableBgpRoutePropagation')]",
                                                "routes": [
                                                  {
                                                    "name": "[parameters('routeName')]",
                                                    "properties": {
                                                      "addressPrefix": "[parameters('routeAddressPrefix')]",
                                                      "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                                                      "nextHopType": "[parameters('routeNextHopType')]"
                                                    }
                                                  }
                                                ]
                                              }
                                            }
                                          ],
                                          "outputs": {
                                            "id": {
                                              "type": "string",
                                              "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                                            },
                                            "name": {
                                              "type": "string",
                                              "value": "[parameters('name')]"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "virtualNetwork",
                                      "subscriptionId": "[variables('subscriptionId')]",
                                      "resourceGroup": "[parameters('resourceGroupName')]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "addressPrefix": {
                                            "value": "[parameters('tier').vnetAddressPrefix]"
                                          },
                                          "location": {
                                            "value": "[parameters('location')]"
                                          },
                                          "mlzTags": {
                                            "value": "[parameters('mlzTags')]"
                                          },
                                          "name": {
                                            "value": "[variables('virtualNetworkName')]"
                                          },
                                          "subnets": {
                                            "copy": [
                                              {
                                                "name": "value",
                                                "count": "[length(variables('subnets'))]",
                                                "input": "[createObject('name', variables('subnets')[copyIndex('value')].name, 'properties', createObject('addressPrefix', variables('subnets')[copyIndex('value')].properties.addressPrefix, 'defaultOutboundAccess', false(), 'delegations', coalesce(tryGet(variables('delegations'), variables('subnets')[copyIndex('value')].name), createArray()), 'networkSecurityGroup', createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup'), '2025-04-01').outputs.id.value), 'routeTable', createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'routeTable'), '2025-04-01').outputs.id.value), 'privateEndpointNetworkPolicies', 'Disabled', 'privateLinkServiceNetworkPolicies', 'Disabled'))]"
                                              }
                                            ]
                                          },
                                          "tags": {
                                            "value": "[parameters('tags')]"
                                          },
                                          "vNetDnsServers": {
                                            "value": "[parameters('vNetDnsServers')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "15576417548653840691"
                                            }
                                          },
                                          "parameters": {
                                            "addressPrefix": {
                                              "type": "string"
                                            },
                                            "location": {
                                              "type": "string"
                                            },
                                            "mlzTags": {
                                              "type": "object"
                                            },
                                            "name": {
                                              "type": "string"
                                            },
                                            "subnets": {
                                              "type": "array"
                                            },
                                            "tags": {
                                              "type": "object"
                                            },
                                            "vNetDnsServers": {
                                              "type": "array"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/virtualNetworks",
                                              "apiVersion": "2023-11-01",
                                              "name": "[parameters('name')]",
                                              "location": "[parameters('location')]",
                                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/virtualNetworks'), createObject()), parameters('mlzTags'))]",
                                              "properties": {
                                                "addressSpace": {
                                                  "addressPrefixes": [
                                                    "[parameters('addressPrefix')]"
                                                  ]
                                                },
                                                "subnets": "[parameters('subnets')]",
                                                "dhcpOptions": "[if(empty(parameters('vNetDnsServers')), null(), createObject('dnsServers', parameters('vNetDnsServers')))]"
                                              }
                                            }
                                          ],
                                          "outputs": {
                                            "addressPrefix": {
                                              "type": "string",
                                              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2023-11-01').addressSpace.addressPrefixes[0]]"
                                            },
                                            "dnsServers": {
                                              "type": "array",
                                              "value": "[parameters('vNetDnsServers')]"
                                            },
                                            "id": {
                                              "type": "string",
                                              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                                            },
                                            "name": {
                                              "type": "string",
                                              "value": "[parameters('name')]"
                                            },
                                            "subnets": {
                                              "type": "array",
                                              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2023-11-01').subnets]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup')]",
                                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'routeTable')]"
                                      ]
                                    }
                                  ],
                                  "outputs": {
                                    "networkSecurityGroupName": {
                                      "type": "string",
                                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup'), '2025-04-01').outputs.name.value]"
                                    },
                                    "networkSecurityGroupResourceId": {
                                      "type": "string",
                                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup'), '2025-04-01').outputs.id.value]"
                                    },
                                    "subnets": {
                                      "type": "array",
                                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.subnets.value]"
                                    },
                                    "virtualNetworkAddressPrefix": {
                                      "type": "string",
                                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.addressPrefix.value]"
                                    },
                                    "virtualNetworkName": {
                                      "type": "string",
                                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.name.value]"
                                    },
                                    "virtualNetworkResourceId": {
                                      "type": "string",
                                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.id.value]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix')))]",
                                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix')))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-spoke-peering-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "deploymentNameSuffix": {
                                    "value": "[parameters('deploymentNameSuffix')]"
                                  },
                                  "hubVirtualNetworkResourceId": {
                                    "value": "[parameters('hubVirtualNetworkResourceId')]"
                                  },
                                  "resourceGroupName": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                                  },
                                  "spokeShortName": {
                                    "value": "[parameters('network').shortName]"
                                  },
                                  "spokeVirtualNetworkName": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkName.value]"
                                  },
                                  "subscriptionId": {
                                    "value": "[parameters('network').subscriptionId]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "9423483428741617452"
                                    }
                                  },
                                  "parameters": {
                                    "deploymentNameSuffix": {
                                      "type": "string"
                                    },
                                    "hubVirtualNetworkResourceId": {
                                      "type": "string"
                                    },
                                    "resourceGroupName": {
                                      "type": "string"
                                    },
                                    "spokeShortName": {
                                      "type": "string"
                                    },
                                    "spokeVirtualNetworkName": {
                                      "type": "string"
                                    },
                                    "subscriptionId": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('peer-{0}-to-hub-{1}', parameters('spokeShortName'), parameters('deploymentNameSuffix'))]",
                                      "subscriptionId": "[parameters('subscriptionId')]",
                                      "resourceGroup": "[parameters('resourceGroupName')]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "remoteVirtualNetworkResourceId": {
                                            "value": "[parameters('hubVirtualNetworkResourceId')]"
                                          },
                                          "virtualNetworkName": {
                                            "value": "[parameters('spokeVirtualNetworkName')]"
                                          },
                                          "virtualNetworkPeerName": {
                                            "value": "[format('to-{0}', split(parameters('hubVirtualNetworkResourceId'), '/')[8])]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "5018776708400490249"
                                            }
                                          },
                                          "parameters": {
                                            "remoteVirtualNetworkResourceId": {
                                              "type": "string"
                                            },
                                            "virtualNetworkName": {
                                              "type": "string"
                                            },
                                            "virtualNetworkPeerName": {
                                              "type": "string"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                                              "apiVersion": "2021-02-01",
                                              "name": "[format('{0}/{1}', parameters('virtualNetworkName'), parameters('virtualNetworkPeerName'))]",
                                              "properties": {
                                                "allowForwardedTraffic": true,
                                                "remoteVirtualNetwork": {
                                                  "id": "[parameters('remoteVirtualNetworkResourceId')]"
                                                }
                                              }
                                            }
                                          ]
                                        }
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix')))]",
                                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix')))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-hub-peering-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "deploymentNameSuffix": {
                                    "value": "[parameters('deploymentNameSuffix')]"
                                  },
                                  "hubVirtualNetworkName": {
                                    "value": "[split(parameters('hubVirtualNetworkResourceId'), '/')[8]]"
                                  },
                                  "resourceGroupName": {
                                    "value": "[split(parameters('hubVirtualNetworkResourceId'), '/')[4]]"
                                  },
                                  "spokeShortName": {
                                    "value": "[parameters('network').shortName]"
                                  },
                                  "spokeVirtualNetworkResourceId": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkResourceId.value]"
                                  },
                                  "subscriptionId": {
                                    "value": "[split(parameters('hubVirtualNetworkResourceId'), '/')[2]]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "9009517396459708892"
                                    }
                                  },
                                  "parameters": {
                                    "deploymentNameSuffix": {
                                      "type": "string"
                                    },
                                    "hubVirtualNetworkName": {
                                      "type": "string"
                                    },
                                    "resourceGroupName": {
                                      "type": "string"
                                    },
                                    "spokeShortName": {
                                      "type": "string"
                                    },
                                    "spokeVirtualNetworkResourceId": {
                                      "type": "string"
                                    },
                                    "subscriptionId": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('peer-hub-to-{0}-{1}', parameters('spokeShortName'), parameters('deploymentNameSuffix'))]",
                                      "subscriptionId": "[parameters('subscriptionId')]",
                                      "resourceGroup": "[parameters('resourceGroupName')]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "remoteVirtualNetworkResourceId": {
                                            "value": "[parameters('spokeVirtualNetworkResourceId')]"
                                          },
                                          "virtualNetworkName": {
                                            "value": "[parameters('hubVirtualNetworkName')]"
                                          },
                                          "virtualNetworkPeerName": {
                                            "value": "[format('to-{0}', split(parameters('spokeVirtualNetworkResourceId'), '/')[8])]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "5018776708400490249"
                                            }
                                          },
                                          "parameters": {
                                            "remoteVirtualNetworkResourceId": {
                                              "type": "string"
                                            },
                                            "virtualNetworkName": {
                                              "type": "string"
                                            },
                                            "virtualNetworkPeerName": {
                                              "type": "string"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                                              "apiVersion": "2021-02-01",
                                              "name": "[format('{0}/{1}', parameters('virtualNetworkName'), parameters('virtualNetworkPeerName'))]",
                                              "properties": {
                                                "allowForwardedTraffic": true,
                                                "remoteVirtualNetwork": {
                                                  "id": "[parameters('remoteVirtualNetworkResourceId')]"
                                                }
                                              }
                                            }
                                          ]
                                        }
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix')))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "delimiter": {
                              "type": "string",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                            },
                            "locationProperties": {
                              "type": "object",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.locationProperties.value]"
                            },
                            "mlzTags": {
                              "type": "object",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                            },
                            "privateDnsZones": {
                              "type": "array",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZones.value]"
                            },
                            "resourceAbbreviations": {
                              "type": "object",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
                            },
                            "tier": {
                              "type": "object",
                              "value": {
                                "name": "[parameters('network').name]",
                                "namingConvention": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value[0].namingConvention]",
                                "networkSecurityGroupResourceId": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkSecurityGroupResourceId.value]",
                                "resourceGroupName": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]",
                                "shortName": "[parameters('network').shortName]",
                                "subnetResourceId": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[0].id]",
                                "subnets": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value]",
                                "subscriptionId": "[parameters('network').subscriptionId]"
                              }
                            },
                            "tokens": {
                              "type": "object",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                            },
                            "virtualNetworkName": {
                              "type": "string",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkName.value]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-storage-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "blobsPrivateDnsZoneResourceId": {
                            "value": "[resourceId(variables('hubSubscriptionId'), variables('hubResourceGroupName'), 'Microsoft.Network/privateDnsZones', format('privatelink.blob.{0}', environment().suffixes.storage))]"
                          },
                          "delimiter": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                          },
                          "deploymentIndex": {
                            "value": "[variables('deploymentIndex')]"
                          },
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "environmentAbbreviation": {
                            "value": "[parameters('environmentAbbreviation')]"
                          },
                          "filesPrivateDnsZoneResourceId": {
                            "value": "[resourceId(variables('hubSubscriptionId'), variables('hubResourceGroupName'), 'Microsoft.Network/privateDnsZones', format('privatelink.file.{0}', environment().suffixes.storage))]"
                          },
                          "hubResourceGroupName": {
                            "value": "[variables('hubResourceGroupName')]"
                          },
                          "hubSubscriptionId": {
                            "value": "[variables('hubSubscriptionId')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "logStorageSkuName": {
                            "value": "[parameters('logStorageSkuName')]"
                          },
                          "mlzTags": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                          },
                          "queuesPrivateDnsZoneResourceId": {
                            "value": "[resourceId(variables('hubSubscriptionId'), variables('hubResourceGroupName'), 'Microsoft.Network/privateDnsZones', format('privatelink.queue.{0}', environment().suffixes.storage))]"
                          },
                          "resourceAbbreviations": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
                          },
                          "resourceGroupName": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.resourceGroupName]"
                          },
                          "subnetResourceId": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.subnetResourceId]"
                          },
                          "tablesPrivateDnsZoneResourceId": {
                            "value": "[resourceId(variables('hubSubscriptionId'), variables('hubResourceGroupName'), 'Microsoft.Network/privateDnsZones', format('privatelink.table.{0}', environment().suffixes.storage))]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "tier": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value]"
                          },
                          "tokens": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                          },
                          "workloadShortName": {
                            "value": "[parameters('workloadShortName')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "12262094167167387996"
                            }
                          },
                          "parameters": {
                            "blobsPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "delimiter": {
                              "type": "string"
                            },
                            "deploymentIndex": {
                              "type": "string"
                            },
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "environmentAbbreviation": {
                              "type": "string"
                            },
                            "filesPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "hubSubscriptionId": {
                              "type": "string"
                            },
                            "hubResourceGroupName": {
                              "type": "string"
                            },
                            "logStorageSkuName": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "queuesPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "resourceAbbreviations": {
                              "type": "object"
                            },
                            "resourceGroupName": {
                              "type": "string"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tablesPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "tier": {
                              "type": "object"
                            },
                            "tokens": {
                              "type": "object"
                            },
                            "workloadShortName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tier').subscriptionId]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "deploymentNameSuffix": {
                                    "value": "[parameters('deploymentNameSuffix')]"
                                  },
                                  "environmentAbbreviation": {
                                    "value": "[parameters('environmentAbbreviation')]"
                                  },
                                  "keyName": {
                                    "value": "StorageEncryptionKey"
                                  },
                                  "keyVaultPrivateDnsZoneResourceId": {
                                    "value": "[resourceId(parameters('hubSubscriptionId'), parameters('hubResourceGroupName'), 'Microsoft.Network/privateDnsZones', replace(format('privatelink{0}', environment().suffixes.keyvaultDns), 'vault', 'vaultcore'))]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "resourceAbbreviations": {
                                    "value": "[parameters('resourceAbbreviations')]"
                                  },
                                  "subnetResourceId": {
                                    "value": "[parameters('subnetResourceId')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  },
                                  "tier": {
                                    "value": "[parameters('tier')]"
                                  },
                                  "tokens": {
                                    "value": "[parameters('tokens')]"
                                  },
                                  "type": {
                                    "value": "storageAccount"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "16154764937040063236"
                                    }
                                  },
                                  "parameters": {
                                    "deploymentNameSuffix": {
                                      "type": "string"
                                    },
                                    "environmentAbbreviation": {
                                      "type": "string"
                                    },
                                    "keyExpirationInDays": {
                                      "type": "int",
                                      "defaultValue": 30
                                    },
                                    "keyName": {
                                      "type": "string"
                                    },
                                    "keyVaultPrivateDnsZoneResourceId": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "resourceAbbreviations": {
                                      "type": "object"
                                    },
                                    "subnetResourceId": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object"
                                    },
                                    "tier": {
                                      "type": "object"
                                    },
                                    "tokens": {
                                      "type": "object"
                                    },
                                    "type": {
                                      "type": "string",
                                      "allowedValues": [
                                        "storageAccount",
                                        "virtualMachine"
                                      ]
                                    },
                                    "virtualMachineAdminPassword": {
                                      "type": "securestring",
                                      "defaultValue": "[newGuid()]"
                                    },
                                    "virtualMachineAdminUsername": {
                                      "type": "string",
                                      "defaultValue": "xadmin"
                                    },
                                    "virtualMachineSize": {
                                      "type": "string",
                                      "defaultValue": "Standard_D2ds_v4"
                                    }
                                  },
                                  "variables": {
                                    "$fxv#0": "Param(\r\n    [string]$DiskEncryptionSetName,\r\n    [int]$KeyExpirationInDays,\r\n    [string]$KeyName,\r\n    [string]$KeyVaultResourceId,\r\n    [string]$KeyVaultServiceUri,\r\n    [string]$KeyVaultUri,\r\n    [string]$Location,\r\n    [string]$ResourceGroupName,\r\n    [string]$ResourceManagerUri,\r\n    [string]$SubscriptionId,\r\n    [string]$Type,\r\n    [string]$UserAssignedIdentityClientId\r\n)\r\n\r\n$ErrorActionPreference = 'Stop'\r\n$WarningPreference = 'SilentlyContinue'\r\n\r\n# Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n$ResourceManagerUriFixed = if ($ResourceManagerUri[-1] -eq '/') { $ResourceManagerUri.Substring(0, $ResourceManagerUri.Length - 1) } else { $ResourceManagerUri }\r\n\r\n# Get an access token for Azure resources\r\n$KeyVaultAccessToken = (Invoke-RestMethod `\r\n        -Headers @{Metadata = \"true\" } `\r\n        -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $KeyVaultServiceUri + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n# Set header for Azure Management API\r\n$KeyVaultHeaders = @{\r\n    'Content-Type'  = 'application/json'\r\n    'Authorization' = 'Bearer ' + $KeyVaultAccessToken\r\n}\r\n\r\n$Body = [PSCustomObject]@{\r\n    kty            = 'RSA-HSM'\r\n    key_size       = 4096\r\n    attributes     = @{\r\n        enabled = $true\r\n    }\r\n    rotationPolicy = @{\r\n        attributes      = @{\r\n            expiryTime = $('P' + $KeyExpirationInDays + 'D')\r\n        }\r\n        lifetimeActions = @(\r\n            @{\r\n                action  = @{\r\n                    type = 'Notify'\r\n                }\r\n                trigger = @{\r\n                    timeBeforeExpiry = 'P10D'\r\n                }\r\n            },\r\n            @{\r\n                action  = @{\r\n                    type = 'Rotate'\r\n                }\r\n                trigger = @{\r\n                    timeAfterCreate = $('P' + ($KeyExpirationInDays - 7) + 'D')\r\n                }\r\n            }\r\n        )\r\n    }\r\n}\r\n\r\n# Create key vault key\r\n$KeyUriWithVersion = (Invoke-RestMethod `\r\n        -Body ($Body | ConvertTo-Json -Depth 4) `\r\n        -Headers $KeyVaultHeaders `\r\n        -Method 'POST' `\r\n        -Uri $($KeyVaultUri + 'keys/' + $KeyName + '/create?api-version=2025-07-01')).key.kid\r\n\r\nif ($Type -eq 'virtualMachine') {\r\n\r\n    # Get an access token for Azure resources\r\n    $ResourceManagerAccessToken = (Invoke-RestMethod `\r\n            -Headers @{Metadata = \"true\" } `\r\n            -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n    # Set header for Azure Management API\r\n    $ResourceManagerHeaders = @{\r\n        'Content-Type'  = 'application/json'\r\n        'Authorization' = 'Bearer ' + $ResourceManagerAccessToken\r\n    }\r\n\r\n    $DiskEncryptionSetBody = @{\r\n        location   = $Location\r\n        identity   = @{\r\n            type = 'SystemAssigned'\r\n        }\r\n        properties = @{\r\n            activeKey                         = @{\r\n                sourceVault = @{\r\n                    id = $KeyVaultResourceId\r\n                }\r\n                keyUrl = $KeyUriWithVersion\r\n            }\r\n            encryptionType                    = 'EncryptionAtRestWithPlatformAndCustomerKeys'\r\n            rotationToLatestKeyVersionEnabled = $true\r\n        }\r\n    }\r\n\r\n    Invoke-RestMethod `\r\n        -Body ($DiskEncryptionSetBody | ConvertTo-Json -Depth 4) `\r\n        -Headers $ResourceManagerHeaders `\r\n        -Method 'PUT' `\r\n        -Uri $($ResourceManagerUriFixed + '/subscriptions/' + $SubscriptionId + '/resourceGroups/' + $ResourceGroupName + '/providers/Microsoft.Compute/diskEncryptionSets/' + $DiskEncryptionSetName + '?api-version=2025-01-02')\r\n}",
                                    "$fxv#1": "param(\r\n    [string]$ResourceGroupName,\r\n    [string]$ResourceManagerUri,\r\n    [string]$UserAssignedIdentityClientId,\r\n    [string]$VirtualMachineResourceId\r\n)\r\n\r\n# Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n$ResourceManagerUriFixed = if($ResourceManagerUri[-1] -eq '/'){$ResourceManagerUri.Substring(0,$ResourceManagerUri.Length - 1)} else {$ResourceManagerUri}\r\n\r\n# Get an access token for Azure resources\r\n$AzureManagementAccessToken = (Invoke-RestMethod `\r\n    -Headers @{Metadata=\"true\"} `\r\n    -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n# Set header for Azure Management API\r\n$AzureManagementHeader = @{\r\n    'Content-Type'='application/json'\r\n    'Authorization'='Bearer ' + $AzureManagementAccessToken\r\n}\r\n\r\nStart-Sleep -Seconds 30\r\n\r\n# Use the access token to delete the virtual machine\r\nInvoke-RestMethod `\r\n    -Headers $AzureManagementHeader `\r\n    -Method 'Delete' `\r\n    -Uri $($ResourceManagerUriFixed + $VirtualMachineResourceId + '?forceDeletion=true&api-version=2024-07-01') | Out-Null",
                                    "keyVaultPrivateEndpointName": "[replace(parameters('tier').namingConvention.keyVaultPrivateEndpoint, parameters('tokens').purpose, variables('workload'))]",
                                    "resourceGroupName": "[resourceGroup().name]",
                                    "userAssignedIdentityName": "[replace(parameters('tier').namingConvention.userAssignedIdentity, parameters('tokens').purpose, variables('workload'))]",
                                    "virtualMachineName": "[replace(parameters('tier').namingConvention.virtualMachine, parameters('tokens').purpose, variables('workload'))]",
                                    "workload": "cmk"
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                                      "apiVersion": "2018-11-30",
                                      "name": "[variables('userAssignedIdentityName')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]"
                                    },
                                    {
                                      "type": "Microsoft.Network/networkInterfaces",
                                      "apiVersion": "2020-05-01",
                                      "name": "[replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "ipConfigurations": [
                                          {
                                            "name": "ipconfig",
                                            "properties": {
                                              "privateIPAllocationMethod": "Dynamic",
                                              "subnet": {
                                                "id": "[parameters('subnetResourceId')]"
                                              },
                                              "primary": true,
                                              "privateIPAddressVersion": "IPv4"
                                            }
                                          }
                                        ],
                                        "enableAcceleratedNetworking": false,
                                        "enableIPForwarding": false
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Compute/virtualMachines",
                                      "apiVersion": "2021-11-01",
                                      "name": "[variables('virtualMachineName')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "hardwareProfile": {
                                          "vmSize": "[parameters('virtualMachineSize')]"
                                        },
                                        "storageProfile": {
                                          "imageReference": {
                                            "publisher": "MicrosoftWindowsServer",
                                            "offer": "WindowsServer",
                                            "sku": "2022-datacenter-core-g2",
                                            "version": "latest"
                                          },
                                          "osDisk": {
                                            "deleteOption": "Delete",
                                            "osType": "Windows",
                                            "createOption": "FromImage",
                                            "caching": "None",
                                            "managedDisk": {
                                              "storageAccountType": "Premium_LRS"
                                            },
                                            "name": "[replace(parameters('tier').namingConvention.virtualMachineDisk, parameters('tokens').purpose, variables('workload'))]"
                                          },
                                          "dataDisks": []
                                        },
                                        "osProfile": {
                                          "adminPassword": "[parameters('virtualMachineAdminPassword')]",
                                          "adminUsername": "[parameters('virtualMachineAdminUsername')]",
                                          "computerName": "[variables('virtualMachineName')]",
                                          "windowsConfiguration": {
                                            "provisionVMAgent": true,
                                            "enableAutomaticUpdates": false
                                          },
                                          "secrets": [],
                                          "allowExtensionOperations": true
                                        },
                                        "networkProfile": {
                                          "networkInterfaces": [
                                            {
                                              "id": "[resourceId('Microsoft.Network/networkInterfaces', replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk'))]",
                                              "properties": {
                                                "deleteOption": "Delete"
                                              }
                                            }
                                          ]
                                        },
                                        "securityProfile": {
                                          "uefiSettings": {
                                            "secureBootEnabled": true,
                                            "vTpmEnabled": true
                                          },
                                          "securityType": "TrustedLaunch",
                                          "encryptionAtHost": true
                                        },
                                        "diagnosticsProfile": {
                                          "bootDiagnostics": {
                                            "enabled": false
                                          }
                                        },
                                        "licenseType": "Windows_Server"
                                      },
                                      "identity": {
                                        "type": "UserAssigned",
                                        "userAssignedIdentities": {
                                          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')))]": {}
                                        }
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Network/networkInterfaces', replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk'))]",
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '136d308c-0937-4a49-9bd7-edfb42adbffc', resourceGroup().id)]",
                                      "properties": {
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '136d308c-0937-4a49-9bd7-edfb42adbffc')]",
                                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                        "principalType": "ServicePrincipal"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "scope": "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]",
                                      "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '9980e02c-c2be-4d73-94e8-173b1dc7cf3c', resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName')))]",
                                      "properties": {
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '9980e02c-c2be-4d73-94e8-173b1dc7cf3c')]",
                                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                        "principalType": "ServicePrincipal"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                        "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.KeyVault/vaults",
                                      "apiVersion": "2022-07-01",
                                      "name": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "enabledForDeployment": false,
                                        "enabledForDiskEncryption": false,
                                        "enabledForTemplateDeployment": false,
                                        "enablePurgeProtection": true,
                                        "enableRbacAuthorization": true,
                                        "enableSoftDelete": true,
                                        "networkAcls": {
                                          "bypass": "AzureServices",
                                          "defaultAction": "Deny",
                                          "ipRules": [],
                                          "virtualNetworkRules": []
                                        },
                                        "publicNetworkAccess": "Disabled",
                                        "sku": {
                                          "family": "A",
                                          "name": "premium"
                                        },
                                        "softDeleteRetentionInDays": "[if(or(equals(parameters('environmentAbbreviation'), 'dev'), equals(parameters('environmentAbbreviation'), 'test')), 7, 90)]",
                                        "tenantId": "[subscription().tenantId]"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "scope": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                      "name": "[guid(variables('userAssignedIdentityName'), '00482a5a-887f-4fb3-b363-3b7fe8e74483', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))))]",
                                      "properties": {
                                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                        "principalType": "ServicePrincipal",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                        "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "scope": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                      "name": "[guid(variables('userAssignedIdentityName'), 'f25e0fa2-a7c8-4377-a976-54943a77a395', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))))]",
                                      "properties": {
                                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                        "principalType": "ServicePrincipal",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'f25e0fa2-a7c8-4377-a976-54943a77a395')]"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                        "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                      ]
                                    },
                                    {
                                      "condition": "[equals(parameters('type'), 'storageAccount')]",
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "name": "[guid(variables('userAssignedIdentityName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceGroup().id)]",
                                      "properties": {
                                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                        "principalType": "ServicePrincipal",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Network/privateEndpoints",
                                      "apiVersion": "2023-04-01",
                                      "name": "[variables('keyVaultPrivateEndpointName')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "customNetworkInterfaceName": "[replace(parameters('tier').namingConvention.keyVaultNetworkInterface, parameters('tokens').purpose, variables('workload'))]",
                                        "privateLinkServiceConnections": [
                                          {
                                            "name": "[variables('keyVaultPrivateEndpointName')]",
                                            "properties": {
                                              "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                              "groupIds": [
                                                "vault"
                                              ]
                                            }
                                          }
                                        ],
                                        "subnet": {
                                          "id": "[parameters('subnetResourceId')]"
                                        }
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '136d308c-0937-4a49-9bd7-edfb42adbffc', resourceGroup().id))]",
                                        "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), 'Microsoft.Authorization/roleAssignments', guid(variables('userAssignedIdentityName'), '00482a5a-887f-4fb3-b363-3b7fe8e74483', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))))]",
                                        "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), 'Microsoft.Authorization/roleAssignments', guid(variables('userAssignedIdentityName'), 'f25e0fa2-a7c8-4377-a976-54943a77a395', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))))]",
                                        "[extensionResourceId(resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '9980e02c-c2be-4d73-94e8-173b1dc7cf3c', resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))))]",
                                        "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                                      "apiVersion": "2021-08-01",
                                      "name": "[format('{0}/{1}', variables('keyVaultPrivateEndpointName'), format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                      "properties": {
                                        "privateDnsZoneConfigs": [
                                          {
                                            "name": "ipconfig1",
                                            "properties": {
                                              "privateDnsZoneId": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                                            }
                                          }
                                        ]
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName'))]",
                                        "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}/{1}', variables('virtualMachineName'), parameters('keyName'))]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "asyncExecution": false,
                                        "parameters": [
                                          {
                                            "name": "DiskEncryptionSetName",
                                            "value": "[replace(parameters('tier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, variables('workload'))]"
                                          },
                                          {
                                            "name": "KeyExpirationInDays",
                                            "value": "[string(parameters('keyExpirationInDays'))]"
                                          },
                                          {
                                            "name": "KeyName",
                                            "value": "[parameters('keyName')]"
                                          },
                                          {
                                            "name": "KeyVaultResourceId",
                                            "value": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                          },
                                          {
                                            "name": "KeyVaultServiceUri",
                                            "value": "[format('https://{0}', skip(environment().suffixes.keyvaultDns, 1))]"
                                          },
                                          {
                                            "name": "KeyVaultUri",
                                            "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), '2022-07-01').vaultUri]"
                                          },
                                          {
                                            "name": "Location",
                                            "value": "[parameters('location')]"
                                          },
                                          {
                                            "name": "ResourceGroupName",
                                            "value": "[variables('resourceGroupName')]"
                                          },
                                          {
                                            "name": "ResourceManagerUri",
                                            "value": "[environment().resourceManager]"
                                          },
                                          {
                                            "name": "SubscriptionId",
                                            "value": "[parameters('tier').subscriptionId]"
                                          },
                                          {
                                            "name": "Type",
                                            "value": "[parameters('type')]"
                                          },
                                          {
                                            "name": "UserAssignedIdentityClientId",
                                            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').clientId]"
                                          }
                                        ],
                                        "source": {
                                          "script": "[variables('$fxv#0')]"
                                        },
                                        "treatFailureAsDeploymentFailure": true
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', variables('keyVaultPrivateEndpointName'), format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                        "[resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName'))]",
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                        "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                        "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                                      "apiVersion": "2023-09-01",
                                      "name": "[format('{0}/{1}', variables('virtualMachineName'), format('delete-vm-{0}', parameters('deploymentNameSuffix')))]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "asyncExecution": true,
                                        "parameters": [
                                          {
                                            "name": "ResourceGroupName",
                                            "value": "[variables('resourceGroupName')]"
                                          },
                                          {
                                            "name": "ResourceManagerUri",
                                            "value": "[environment().resourceManager]"
                                          },
                                          {
                                            "name": "UserAssignedIdentityClientId",
                                            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').clientId]"
                                          },
                                          {
                                            "name": "VirtualMachineResourceId",
                                            "value": "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                                          }
                                        ],
                                        "source": {
                                          "script": "[variables('$fxv#1')]"
                                        },
                                        "treatFailureAsDeploymentFailure": true
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Resources/deployments', format('deploy-des-{0}', parameters('deploymentNameSuffix')))]",
                                        "[resourceId('Microsoft.Compute/virtualMachines/runCommands', variables('virtualMachineName'), parameters('keyName'))]",
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                        "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                                      ]
                                    },
                                    {
                                      "condition": "[equals(parameters('type'), 'virtualMachine')]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('deploy-des-{0}', parameters('deploymentNameSuffix'))]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "diskEncryptionSetName": {
                                            "value": "[replace(parameters('tier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, variables('workload'))]"
                                          },
                                          "keyVaultName": {
                                            "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "15118251701077090282"
                                            }
                                          },
                                          "parameters": {
                                            "diskEncryptionSetName": {
                                              "type": "string"
                                            },
                                            "keyVaultName": {
                                              "type": "string"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Authorization/roleAssignments",
                                              "apiVersion": "2020-04-01-preview",
                                              "scope": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                                              "name": "[guid(parameters('diskEncryptionSetName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')))]",
                                              "properties": {
                                                "principalId": "[reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName')), '2023-04-02', 'full').identity.principalId]",
                                                "principalType": "ServicePrincipal",
                                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                                              }
                                            }
                                          ],
                                          "outputs": {
                                            "resourceId": {
                                              "type": "string",
                                              "value": "[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName'))]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Compute/virtualMachines/runCommands', variables('virtualMachineName'), parameters('keyName'))]",
                                        "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                      ]
                                    }
                                  ],
                                  "outputs": {
                                    "diskEncryptionSetResourceId": {
                                      "type": "string",
                                      "value": "[if(equals(parameters('type'), 'virtualMachine'), reference(resourceId('Microsoft.Resources/deployments', format('deploy-des-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value, '')]"
                                    },
                                    "keyVaultProperties": {
                                      "type": "object",
                                      "value": {
                                        "diagnosticSettingName": "[replace(parameters('tier').namingConvention.keyVaultDiagnosticSetting, parameters('tokens').purpose, variables('workload'))]",
                                        "name": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]",
                                        "resourceGroupName": "[variables('resourceGroupName')]",
                                        "subscriptionId": "[parameters('tier').subscriptionId]",
                                        "tierName": "[parameters('tier').name]"
                                      }
                                    },
                                    "keyName": {
                                      "type": "string",
                                      "value": "[parameters('keyName')]"
                                    },
                                    "keyVaultName": {
                                      "type": "string",
                                      "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]"
                                    },
                                    "keyVaultUri": {
                                      "type": "string",
                                      "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), '2022-07-01').vaultUri]"
                                    },
                                    "keyVaultResourceId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                    },
                                    "keyVaultNetworkInterfaceResourceId": {
                                      "type": "string",
                                      "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName')), '2023-04-01').networkInterfaces[0].id]"
                                    },
                                    "userAssignedIdentityResourceId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-sa-log-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tier').subscriptionId]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "blobsPrivateDnsZoneResourceId": {
                                    "value": "[parameters('blobsPrivateDnsZoneResourceId')]"
                                  },
                                  "delimiter": {
                                    "value": "[parameters('delimiter')]"
                                  },
                                  "filesPrivateDnsZoneResourceId": {
                                    "value": "[parameters('filesPrivateDnsZoneResourceId')]"
                                  },
                                  "keyVaultUri": {
                                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultUri.value]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[parameters('mlzTags')]"
                                  },
                                  "purpose": {
                                    "value": "diag"
                                  },
                                  "queuesPrivateDnsZoneResourceId": {
                                    "value": "[parameters('queuesPrivateDnsZoneResourceId')]"
                                  },
                                  "skuName": {
                                    "value": "[parameters('logStorageSkuName')]"
                                  },
                                  "storageEncryptionKeyName": {
                                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyName.value]"
                                  },
                                  "subnetResourceId": {
                                    "value": "[parameters('subnetResourceId')]"
                                  },
                                  "tablesPrivateDnsZoneResourceId": {
                                    "value": "[parameters('tablesPrivateDnsZoneResourceId')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  },
                                  "tier": {
                                    "value": "[parameters('tier')]"
                                  },
                                  "tokens": {
                                    "value": "[parameters('tokens')]"
                                  },
                                  "userAssignedIdentityResourceId": {
                                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.userAssignedIdentityResourceId.value]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "3770160123771615483"
                                    }
                                  },
                                  "parameters": {
                                    "blobsPrivateDnsZoneResourceId": {
                                      "type": "string"
                                    },
                                    "delimiter": {
                                      "type": "string"
                                    },
                                    "filesPrivateDnsZoneResourceId": {
                                      "type": "string"
                                    },
                                    "keyVaultUri": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "purpose": {
                                      "type": "string"
                                    },
                                    "queuesPrivateDnsZoneResourceId": {
                                      "type": "string"
                                    },
                                    "skuName": {
                                      "type": "string"
                                    },
                                    "storageEncryptionKeyName": {
                                      "type": "string"
                                    },
                                    "subnetResourceId": {
                                      "type": "string"
                                    },
                                    "tablesPrivateDnsZoneResourceId": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object"
                                    },
                                    "tier": {
                                      "type": "object"
                                    },
                                    "tokens": {
                                      "type": "object"
                                    },
                                    "userAssignedIdentityResourceId": {
                                      "type": "string"
                                    }
                                  },
                                  "variables": {
                                    "subResources": [
                                      {
                                        "id": "[parameters('blobsPrivateDnsZoneResourceId')]",
                                        "nic": "[replace(parameters('tier').namingConvention.storageAccountBlobNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                        "pe": "[replace(parameters('tier').namingConvention.storageAccountBlobPrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                      },
                                      {
                                        "id": "[parameters('filesPrivateDnsZoneResourceId')]",
                                        "nic": "[replace(parameters('tier').namingConvention.storageAccountFileNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                        "pe": "[replace(parameters('tier').namingConvention.storageAccountFilePrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                      },
                                      {
                                        "id": "[parameters('queuesPrivateDnsZoneResourceId')]",
                                        "nic": "[replace(parameters('tier').namingConvention.storageAccountQueueNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                        "pe": "[replace(parameters('tier').namingConvention.storageAccountQueuePrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                      },
                                      {
                                        "id": "[parameters('tablesPrivateDnsZoneResourceId')]",
                                        "nic": "[replace(parameters('tier').namingConvention.storageAccountTableNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                        "pe": "[replace(parameters('tier').namingConvention.storageAccountTablePrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                      }
                                    ]
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Storage/storageAccounts",
                                      "apiVersion": "2023-01-01",
                                      "name": "[uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id)]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Storage/storageAccounts'), createObject()), parameters('mlzTags'))]",
                                      "identity": {
                                        "type": "UserAssigned",
                                        "userAssignedIdentities": {
                                          "[format('{0}', parameters('userAssignedIdentityResourceId'))]": {}
                                        }
                                      },
                                      "kind": "StorageV2",
                                      "sku": {
                                        "name": "[parameters('skuName')]"
                                      },
                                      "properties": {
                                        "accessTier": "Hot",
                                        "allowBlobPublicAccess": false,
                                        "allowCrossTenantReplication": false,
                                        "allowedCopyScope": "PrivateLink",
                                        "allowSharedKeyAccess": false,
                                        "defaultToOAuthAuthentication": false,
                                        "dnsEndpointType": "Standard",
                                        "encryption": {
                                          "identity": {
                                            "userAssignedIdentity": "[parameters('userAssignedIdentityResourceId')]"
                                          },
                                          "keySource": "Microsoft.KeyVault",
                                          "keyvaultproperties": {
                                            "keyvaulturi": "[parameters('keyVaultUri')]",
                                            "keyname": "[parameters('storageEncryptionKeyName')]"
                                          },
                                          "requireInfrastructureEncryption": true,
                                          "services": {
                                            "blob": {
                                              "keyType": "Account",
                                              "enabled": true
                                            },
                                            "file": {
                                              "keyType": "Account",
                                              "enabled": true
                                            },
                                            "queue": {
                                              "keyType": "Account",
                                              "enabled": true
                                            },
                                            "table": {
                                              "keyType": "Account",
                                              "enabled": true
                                            }
                                          }
                                        },
                                        "minimumTlsVersion": "TLS1_2",
                                        "networkAcls": {
                                          "bypass": "AzureServices",
                                          "virtualNetworkRules": [],
                                          "ipRules": [],
                                          "defaultAction": "Deny"
                                        },
                                        "publicNetworkAccess": "Disabled",
                                        "supportsHttpsTrafficOnly": true
                                      }
                                    },
                                    {
                                      "copy": {
                                        "name": "privateEndpoints",
                                        "count": "[length(variables('subResources'))]"
                                      },
                                      "type": "Microsoft.Network/privateEndpoints",
                                      "apiVersion": "2023-04-01",
                                      "name": "[variables('subResources')[copyIndex()].pe]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "customNetworkInterfaceName": "[variables('subResources')[copyIndex()].nic]",
                                        "privateLinkServiceConnections": [
                                          {
                                            "name": "[variables('subResources')[copyIndex()].pe]",
                                            "properties": {
                                              "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]",
                                              "groupIds": [
                                                "[split(split(variables('subResources')[copyIndex()].id, '/')[8], '.')[1]]"
                                              ]
                                            }
                                          }
                                        ],
                                        "subnet": {
                                          "id": "[parameters('subnetResourceId')]"
                                        }
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]"
                                      ]
                                    },
                                    {
                                      "copy": {
                                        "name": "privateDnsZoneGroups",
                                        "count": "[length(variables('subResources'))]"
                                      },
                                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                                      "apiVersion": "2021-08-01",
                                      "name": "[format('{0}/{1}', variables('subResources')[copyIndex()].pe, uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]",
                                      "properties": {
                                        "privateDnsZoneConfigs": [
                                          {
                                            "name": "ipconfig1",
                                            "properties": {
                                              "privateDnsZoneId": "[variables('subResources')[copyIndex()].id]"
                                            }
                                          }
                                        ]
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Network/privateEndpoints', variables('subResources')[copyIndex()].pe)]",
                                        "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]"
                                      ]
                                    }
                                  ],
                                  "outputs": {
                                    "id": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]"
                                    },
                                    "networkInterfaceResourceIds": {
                                      "type": "array",
                                      "copy": {
                                        "count": "[length(variables('subResources'))]",
                                        "input": "[reference(resourceId('Microsoft.Network/privateEndpoints', variables('subResources')[copyIndex()].pe), '2023-04-01').networkInterfaces[0].id]"
                                      }
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix')))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "keyVaultName": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultName.value]"
                            },
                            "keyVaultUri": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultUri.value]"
                            },
                            "networkInterfaceResourceIds": {
                              "type": "array",
                              "value": "[union(createArray(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultNetworkInterfaceResourceId.value), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sa-log-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceIds.value)]"
                            },
                            "storageAccountResourceId": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sa-log-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value]"
                            },
                            "userAssignedIdentityResourceId": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.userAssignedIdentityResourceId.value]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-diag-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "blobDiagnosticsLogs": {
                            "value": "[parameters('blobDiagnosticsLogs')]"
                          },
                          "blobDiagnosticsMetrics": {
                            "value": "[parameters('blobDiagnosticsMetrics')]"
                          },
                          "delimiter": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                          },
                          "deployActivityLogDiagnosticSetting": {
                            "value": "[parameters('deployActivityLogDiagnosticSetting')]"
                          },
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "deployNetworkWatcherTrafficAnalytics": {
                            "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                          },
                          "fileDiagnosticsLogs": {
                            "value": "[parameters('fileDiagnosticsLogs')]"
                          },
                          "fileDiagnosticsMetrics": {
                            "value": "[parameters('fileDiagnosticsMetrics')]"
                          },
                          "hubStorageAccountResourceId": {
                            "value": "[parameters('hubStorageAccountResourceId')]"
                          },
                          "keyVaultDiagnosticLogs": {
                            "value": "[parameters('keyVaultDiagnosticLogs')]"
                          },
                          "keyVaultDiagnosticMetrics": {
                            "value": "[parameters('keyVaultDiagnosticMetrics')]"
                          },
                          "keyVaultName": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-storage-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultName.value]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "networkInterfaceDiagnosticsMetrics": {
                            "value": "[parameters('networkInterfaceDiagnosticsMetrics')]"
                          },
                          "networkInterfaceResourceIds": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-storage-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceIds.value]"
                          },
                          "networkSecurityGroupDiagnosticsLogs": {
                            "value": "[parameters('networkSecurityGroupDiagnosticsLogs')]"
                          },
                          "networkWatcherFlowLogsRetentionDays": {
                            "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                          },
                          "networkWatcherFlowLogsType": {
                            "value": "[parameters('networkWatcherFlowLogsType')]"
                          },
                          "queueDiagnosticsLogs": {
                            "value": "[parameters('queueDiagnosticsLogs')]"
                          },
                          "queueDiagnosticsMetrics": {
                            "value": "[parameters('queueDiagnosticsMetrics')]"
                          },
                          "storageAccountDiagnosticsLogs": {
                            "value": "[parameters('storageAccountDiagnosticsLogs')]"
                          },
                          "storageAccountDiagnosticsMetrics": {
                            "value": "[parameters('storageAccountDiagnosticsMetrics')]"
                          },
                          "storageAccountResourceId": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-storage-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.storageAccountResourceId.value]"
                          },
                          "tableDiagnosticsLogs": {
                            "value": "[parameters('tableDiagnosticsLogs')]"
                          },
                          "tableDiagnosticsMetrics": {
                            "value": "[parameters('tableDiagnosticsMetrics')]"
                          },
                          "tier": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value]"
                          },
                          "tokens": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                          },
                          "virtualNetworkDiagnosticsLogs": {
                            "value": "[parameters('virtualNetworkDiagnosticsLogs')]"
                          },
                          "virtualNetworkDiagnosticsMetrics": {
                            "value": "[parameters('virtualNetworkDiagnosticsMetrics')]"
                          },
                          "virtualNetworkName": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkName.value]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "2297357647816897874"
                            }
                          },
                          "parameters": {
                            "blobDiagnosticsLogs": {
                              "type": "array"
                            },
                            "blobDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "delimiter": {
                              "type": "string"
                            },
                            "deployActivityLogDiagnosticSetting": {
                              "type": "bool"
                            },
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "deployNetworkWatcherTrafficAnalytics": {
                              "type": "bool"
                            },
                            "fileDiagnosticsLogs": {
                              "type": "array"
                            },
                            "fileDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "hubStorageAccountResourceId": {
                              "type": "string"
                            },
                            "keyVaultDiagnosticLogs": {
                              "type": "array"
                            },
                            "keyVaultDiagnosticMetrics": {
                              "type": "array"
                            },
                            "keyVaultName": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "networkInterfaceDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "networkInterfaceResourceIds": {
                              "type": "array"
                            },
                            "networkSecurityGroupDiagnosticsLogs": {
                              "type": "array"
                            },
                            "networkWatcherFlowLogsRetentionDays": {
                              "type": "int"
                            },
                            "networkWatcherFlowLogsType": {
                              "type": "string"
                            },
                            "queueDiagnosticsLogs": {
                              "type": "array"
                            },
                            "queueDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "storageAccountDiagnosticsLogs": {
                              "type": "array"
                            },
                            "storageAccountDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "storageAccountResourceId": {
                              "type": "string"
                            },
                            "tableDiagnosticsLogs": {
                              "type": "array"
                            },
                            "tableDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "tier": {
                              "type": "object"
                            },
                            "tokens": {
                              "type": "object"
                            },
                            "virtualNetworkDiagnosticsLogs": {
                              "type": "array"
                            },
                            "virtualNetworkDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "virtualNetworkName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "condition": "[parameters('deployActivityLogDiagnosticSetting')]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-activity-diags-{0}-{1}', parameters('tier').shortName, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tier').subscriptionId]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "logAnalyticsWorkspaceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "10072718411163230780"
                                    }
                                  },
                                  "parameters": {
                                    "logAnalyticsWorkspaceId": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "microsoft.insights/diagnosticSettings",
                                      "apiVersion": "2017-05-01-preview",
                                      "name": "[format('diag-activity-log-{0}', subscription().subscriptionId)]",
                                      "properties": {
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                                        "logs": [
                                          {
                                            "category": "Administrative",
                                            "enabled": true
                                          },
                                          {
                                            "category": "Security",
                                            "enabled": true
                                          },
                                          {
                                            "category": "ServiceHealth",
                                            "enabled": true
                                          },
                                          {
                                            "category": "Alert",
                                            "enabled": true
                                          },
                                          {
                                            "category": "Recommendation",
                                            "enabled": true
                                          },
                                          {
                                            "category": "Policy",
                                            "enabled": true
                                          },
                                          {
                                            "category": "Autoscale",
                                            "enabled": true
                                          },
                                          {
                                            "category": "ResourceHealth",
                                            "enabled": true
                                          }
                                        ]
                                      }
                                    }
                                  ]
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-sa-diag-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tier').subscriptionId]",
                              "resourceGroup": "[parameters('tier').resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "blobDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.storageAccountBlobDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "blobDiagnosticsLogs": {
                                    "value": "[parameters('blobDiagnosticsLogs')]"
                                  },
                                  "blobDiagnosticsMetrics": {
                                    "value": "[parameters('blobDiagnosticsMetrics')]"
                                  },
                                  "fileDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.storageAccountFileDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "fileDiagnosticsLogs": {
                                    "value": "[parameters('fileDiagnosticsLogs')]"
                                  },
                                  "fileDiagnosticsMetrics": {
                                    "value": "[parameters('fileDiagnosticsMetrics')]"
                                  },
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  },
                                  "logStorageAccountResourceId": {
                                    "value": "[parameters('hubStorageAccountResourceId')]"
                                  },
                                  "queueDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.storageAccountQueueDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "queueDiagnosticsLogs": {
                                    "value": "[parameters('queueDiagnosticsLogs')]"
                                  },
                                  "queueDiagnosticsMetrics": {
                                    "value": "[parameters('queueDiagnosticsMetrics')]"
                                  },
                                  "storageAccountDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.storageAccountDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "storageAccountDiagnosticsLogs": {
                                    "value": "[parameters('storageAccountDiagnosticsLogs')]"
                                  },
                                  "storageAccountDiagnosticsMetrics": {
                                    "value": "[parameters('storageAccountDiagnosticsMetrics')]"
                                  },
                                  "storageAccountName": {
                                    "value": "[split(parameters('storageAccountResourceId'), '/')[8]]"
                                  },
                                  "tableDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.storageAccountTableDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "tableDiagnosticsLogs": {
                                    "value": "[parameters('tableDiagnosticsLogs')]"
                                  },
                                  "tableDiagnosticsMetrics": {
                                    "value": "[parameters('tableDiagnosticsMetrics')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "16854631658526137140"
                                    }
                                  },
                                  "parameters": {
                                    "blobDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "blobDiagnosticsLogs": {
                                      "type": "array"
                                    },
                                    "blobDiagnosticsMetrics": {
                                      "type": "array"
                                    },
                                    "fileDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "fileDiagnosticsLogs": {
                                      "type": "array"
                                    },
                                    "fileDiagnosticsMetrics": {
                                      "type": "array"
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string"
                                    },
                                    "logStorageAccountResourceId": {
                                      "type": "string"
                                    },
                                    "queueDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "queueDiagnosticsLogs": {
                                      "type": "array"
                                    },
                                    "queueDiagnosticsMetrics": {
                                      "type": "array"
                                    },
                                    "storageAccountDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "storageAccountDiagnosticsLogs": {
                                      "type": "array"
                                    },
                                    "storageAccountDiagnosticsMetrics": {
                                      "type": "array"
                                    },
                                    "storageAccountName": {
                                      "type": "string"
                                    },
                                    "tableDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "tableDiagnosticsLogs": {
                                      "type": "array"
                                    },
                                    "tableDiagnosticsMetrics": {
                                      "type": "array"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
                                      "name": "[parameters('storageAccountDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('storageAccountDiagnosticsLogs')]",
                                        "metrics": "[parameters('storageAccountDiagnosticsMetrics')]",
                                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]",
                                      "name": "[parameters('blobDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('blobDiagnosticsLogs')]",
                                        "metrics": "[parameters('blobDiagnosticsMetrics')]",
                                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Storage/storageAccounts/fileServices', parameters('storageAccountName'), 'default')]",
                                      "name": "[parameters('fileDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('fileDiagnosticsLogs')]",
                                        "metrics": "[parameters('fileDiagnosticsMetrics')]",
                                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Storage/storageAccounts/queueServices', parameters('storageAccountName'), 'default')]",
                                      "name": "[parameters('queueDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('queueDiagnosticsLogs')]",
                                        "metrics": "[parameters('queueDiagnosticsMetrics')]",
                                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]",
                                      "name": "[parameters('tableDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('tableDiagnosticsLogs')]",
                                        "metrics": "[parameters('tableDiagnosticsMetrics')]",
                                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    }
                                  ]
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-kv-diags-{0}-{1}', parameters('tier').shortName, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tier').subscriptionId]",
                              "resourceGroup": "[parameters('tier').resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "keyVaultDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.keyVaultDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "keyVaultName": {
                                    "value": "[parameters('keyVaultName')]"
                                  },
                                  "keyVaultStorageAccountId": {
                                    "value": "[parameters('storageAccountResourceId')]"
                                  },
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  },
                                  "logs": {
                                    "value": "[parameters('keyVaultDiagnosticLogs')]"
                                  },
                                  "metrics": {
                                    "value": "[parameters('keyVaultDiagnosticMetrics')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "1272317275534002717"
                                    }
                                  },
                                  "parameters": {
                                    "keyVaultDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "keyVaultName": {
                                      "type": "string"
                                    },
                                    "keyVaultStorageAccountId": {
                                      "type": "string"
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string"
                                    },
                                    "logs": {
                                      "type": "array"
                                    },
                                    "metrics": {
                                      "type": "array"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                                      "name": "[parameters('keyVaultDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('logs')]",
                                        "metrics": "[parameters('metrics')]",
                                        "storageAccountId": "[parameters('keyVaultStorageAccountId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    }
                                  ]
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-nsg-diags-{0}-{1}', parameters('tier').shortName, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tier').subscriptionId]",
                              "resourceGroup": "[parameters('tier').resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "deploymentNameSuffix": {
                                    "value": "[parameters('deploymentNameSuffix')]"
                                  },
                                  "deployNetworkWatcherTrafficAnalytics": {
                                    "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                                  },
                                  "flowLogsName": {
                                    "value": "[replace(parameters('tier').namingConvention.networkWatcherFlowLogsNetworkSecurityGroup, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  },
                                  "logs": {
                                    "value": "[parameters('networkSecurityGroupDiagnosticsLogs')]"
                                  },
                                  "networkSecurityGroupDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.networkSecurityGroupDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "networkSecurityGroupName": {
                                    "value": "[split(parameters('tier').networkSecurityGroupResourceId, '/')[8]]"
                                  },
                                  "networkWatcherFlowLogsRetentionDays": {
                                    "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                                  },
                                  "networkWatcherFlowLogsType": {
                                    "value": "[parameters('networkWatcherFlowLogsType')]"
                                  },
                                  "storageAccountResourceId": {
                                    "value": "[parameters('storageAccountResourceId')]"
                                  },
                                  "tiername": {
                                    "value": "[parameters('tier').name]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "5431688095715861024"
                                    }
                                  },
                                  "parameters": {
                                    "deploymentNameSuffix": {
                                      "type": "string"
                                    },
                                    "deployNetworkWatcherTrafficAnalytics": {
                                      "type": "bool"
                                    },
                                    "flowLogsName": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string"
                                    },
                                    "logs": {
                                      "type": "array"
                                    },
                                    "networkSecurityGroupDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "networkSecurityGroupName": {
                                      "type": "string"
                                    },
                                    "networkWatcherFlowLogsRetentionDays": {
                                      "type": "int"
                                    },
                                    "networkWatcherFlowLogsType": {
                                      "type": "string"
                                    },
                                    "storageAccountResourceId": {
                                      "type": "string"
                                    },
                                    "tiername": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]",
                                      "name": "[parameters('networkSecurityGroupDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('logs')]",
                                        "metrics": [],
                                        "storageAccountId": "[parameters('storageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    },
                                    {
                                      "condition": "[equals(parameters('networkWatcherFlowLogsType'), 'NetworkSecurityGroup')]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('deploy-{0}-flowLogs-{1}', parameters('tiername'), parameters('deploymentNameSuffix'))]",
                                      "resourceGroup": "NetworkWatcherRG",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "deployNetworkWatcherTrafficAnalytics": {
                                            "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                                          },
                                          "flowLogsName": {
                                            "value": "[parameters('flowLogsName')]"
                                          },
                                          "flowLogsRetentionDays": {
                                            "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                                          },
                                          "location": {
                                            "value": "[parameters('location')]"
                                          },
                                          "logAnalyticsWorkspaceResourceId": {
                                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                          },
                                          "networkWatcherName": {
                                            "value": "[format('NetworkWatcher_{0}', parameters('location'))]"
                                          },
                                          "storageAccountResourceId": {
                                            "value": "[parameters('storageAccountResourceId')]"
                                          },
                                          "targetResourceId": {
                                            "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "18376200335373925565"
                                            }
                                          },
                                          "parameters": {
                                            "deployNetworkWatcherTrafficAnalytics": {
                                              "type": "bool"
                                            },
                                            "flowLogsName": {
                                              "type": "string"
                                            },
                                            "flowLogsRetentionDays": {
                                              "type": "int"
                                            },
                                            "location": {
                                              "type": "string"
                                            },
                                            "logAnalyticsWorkspaceResourceId": {
                                              "type": "string"
                                            },
                                            "networkWatcherName": {
                                              "type": "string"
                                            },
                                            "storageAccountResourceId": {
                                              "type": "string"
                                            },
                                            "targetResourceId": {
                                              "type": "string"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/networkWatchers/flowLogs",
                                              "apiVersion": "2023-05-01",
                                              "name": "[format('{0}/{1}', parameters('networkWatcherName'), parameters('flowLogsName'))]",
                                              "location": "[parameters('location')]",
                                              "properties": {
                                                "targetResourceId": "[parameters('targetResourceId')]",
                                                "enabled": true,
                                                "storageId": "[parameters('storageAccountResourceId')]",
                                                "flowAnalyticsConfiguration": {
                                                  "networkWatcherFlowAnalyticsConfiguration": {
                                                    "enabled": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('deployNetworkWatcherTrafficAnalytics'), null())]",
                                                    "workspaceResourceId": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('logAnalyticsWorkspaceResourceId'), null())]"
                                                  }
                                                },
                                                "format": {
                                                  "type": "JSON",
                                                  "version": 2
                                                },
                                                "retentionPolicy": {
                                                  "days": "[parameters('flowLogsRetentionDays')]",
                                                  "enabled": true
                                                }
                                              }
                                            }
                                          ]
                                        }
                                      }
                                    }
                                  ]
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-vnet-diags-{0}-{1}', parameters('tier').shortName, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tier').subscriptionId]",
                              "resourceGroup": "[parameters('tier').resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "deploymentNameSuffix": {
                                    "value": "[parameters('deploymentNameSuffix')]"
                                  },
                                  "deployNetworkWatcherTrafficAnalytics": {
                                    "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                                  },
                                  "flowLogsName": {
                                    "value": "[replace(parameters('tier').namingConvention.networkWatcherFlowLogsVirtualNetwork, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  },
                                  "logs": {
                                    "value": "[parameters('virtualNetworkDiagnosticsLogs')]"
                                  },
                                  "logStorageAccountResourceId": {
                                    "value": "[parameters('storageAccountResourceId')]"
                                  },
                                  "metrics": {
                                    "value": "[parameters('virtualNetworkDiagnosticsMetrics')]"
                                  },
                                  "networkWatcherFlowLogsRetentionDays": {
                                    "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                                  },
                                  "networkWatcherFlowLogsType": {
                                    "value": "[parameters('networkWatcherFlowLogsType')]"
                                  },
                                  "tiername": {
                                    "value": "[parameters('tier').name]"
                                  },
                                  "virtualNetworkDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.virtualNetworkDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "virtualNetworkName": {
                                    "value": "[parameters('virtualNetworkName')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "7697548079699580923"
                                    }
                                  },
                                  "parameters": {
                                    "deploymentNameSuffix": {
                                      "type": "string"
                                    },
                                    "deployNetworkWatcherTrafficAnalytics": {
                                      "type": "bool"
                                    },
                                    "flowLogsName": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string"
                                    },
                                    "logs": {
                                      "type": "array"
                                    },
                                    "logStorageAccountResourceId": {
                                      "type": "string"
                                    },
                                    "metrics": {
                                      "type": "array"
                                    },
                                    "networkWatcherFlowLogsRetentionDays": {
                                      "type": "int"
                                    },
                                    "networkWatcherFlowLogsType": {
                                      "type": "string"
                                    },
                                    "supportedClouds": {
                                      "type": "array",
                                      "defaultValue": [
                                        "AzureCloud"
                                      ]
                                    },
                                    "tiername": {
                                      "type": "string"
                                    },
                                    "virtualNetworkDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "virtualNetworkName": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
                                      "name": "[parameters('virtualNetworkDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[if(contains(parameters('supportedClouds'), environment().name), parameters('logs'), createArray())]",
                                        "metrics": "[parameters('metrics')]",
                                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    },
                                    {
                                      "condition": "[equals(parameters('networkWatcherFlowLogsType'), 'VirtualNetwork')]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('deploy-{0}-flowLogs-{1}', parameters('tiername'), parameters('deploymentNameSuffix'))]",
                                      "resourceGroup": "NetworkWatcherRG",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "deployNetworkWatcherTrafficAnalytics": {
                                            "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                                          },
                                          "flowLogsName": {
                                            "value": "[parameters('flowLogsName')]"
                                          },
                                          "flowLogsRetentionDays": {
                                            "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                                          },
                                          "location": {
                                            "value": "[parameters('location')]"
                                          },
                                          "logAnalyticsWorkspaceResourceId": {
                                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                          },
                                          "networkWatcherName": {
                                            "value": "[format('NetworkWatcher_{0}', parameters('location'))]"
                                          },
                                          "storageAccountResourceId": {
                                            "value": "[parameters('logStorageAccountResourceId')]"
                                          },
                                          "targetResourceId": {
                                            "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "18376200335373925565"
                                            }
                                          },
                                          "parameters": {
                                            "deployNetworkWatcherTrafficAnalytics": {
                                              "type": "bool"
                                            },
                                            "flowLogsName": {
                                              "type": "string"
                                            },
                                            "flowLogsRetentionDays": {
                                              "type": "int"
                                            },
                                            "location": {
                                              "type": "string"
                                            },
                                            "logAnalyticsWorkspaceResourceId": {
                                              "type": "string"
                                            },
                                            "networkWatcherName": {
                                              "type": "string"
                                            },
                                            "storageAccountResourceId": {
                                              "type": "string"
                                            },
                                            "targetResourceId": {
                                              "type": "string"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/networkWatchers/flowLogs",
                                              "apiVersion": "2023-05-01",
                                              "name": "[format('{0}/{1}', parameters('networkWatcherName'), parameters('flowLogsName'))]",
                                              "location": "[parameters('location')]",
                                              "properties": {
                                                "targetResourceId": "[parameters('targetResourceId')]",
                                                "enabled": true,
                                                "storageId": "[parameters('storageAccountResourceId')]",
                                                "flowAnalyticsConfiguration": {
                                                  "networkWatcherFlowAnalyticsConfiguration": {
                                                    "enabled": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('deployNetworkWatcherTrafficAnalytics'), null())]",
                                                    "workspaceResourceId": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('logAnalyticsWorkspaceResourceId'), null())]"
                                                  }
                                                },
                                                "format": {
                                                  "type": "JSON",
                                                  "version": 2
                                                },
                                                "retentionPolicy": {
                                                  "days": "[parameters('flowLogsRetentionDays')]",
                                                  "enabled": true
                                                }
                                              }
                                            }
                                          ]
                                        }
                                      }
                                    }
                                  ]
                                }
                              }
                            },
                            {
                              "copy": {
                                "name": "networkInterfaceDiagnostics",
                                "count": "[length(parameters('networkInterfaceResourceIds'))]"
                              },
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-nic-diags-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[split(parameters('networkInterfaceResourceIds')[copyIndex()], '/')[2]]",
                              "resourceGroup": "[split(parameters('networkInterfaceResourceIds')[copyIndex()], '/')[4]]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "delimiter": {
                                    "value": "[parameters('delimiter')]"
                                  },
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  },
                                  "logs": {
                                    "value": []
                                  },
                                  "metrics": {
                                    "value": "[parameters('networkInterfaceDiagnosticsMetrics')]"
                                  },
                                  "networkInterfaceResourceId": {
                                    "value": "[parameters('networkInterfaceResourceIds')[copyIndex()]]"
                                  },
                                  "storageAccountResourceIds": {
                                    "value": [
                                      "[parameters('storageAccountResourceId')]"
                                    ]
                                  },
                                  "tiers": {
                                    "value": [
                                      "[parameters('tier')]"
                                    ]
                                  },
                                  "tokens": {
                                    "value": "[parameters('tokens')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "9983310224341078636"
                                    }
                                  },
                                  "parameters": {
                                    "delimiter": {
                                      "type": "string"
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string"
                                    },
                                    "logs": {
                                      "type": "array"
                                    },
                                    "metrics": {
                                      "type": "array"
                                    },
                                    "networkInterfaceResourceId": {
                                      "type": "string"
                                    },
                                    "storageAccountResourceIds": {
                                      "type": "array"
                                    },
                                    "tiers": {
                                      "type": "array"
                                    },
                                    "tokens": {
                                      "type": "object"
                                    }
                                  },
                                  "variables": {
                                    "networkInterfaceDiagnosticSettingName": "[replace(parameters('tiers')[variables('tierIndex')].namingConvention.virtualMachineNetworkInterfaceDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                    "storageAccountResourceId": "[parameters('storageAccountResourceIds')[variables('tierIndex')]]",
                                    "tierIndex": "[if(contains(parameters('networkInterfaceResourceId'), '-ops-'), 1, if(contains(parameters('networkInterfaceResourceId'), '-svcs-'), 2, if(contains(parameters('networkInterfaceResourceId'), '-id-'), 3, 0)))]"
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Network/networkInterfaces', split(parameters('networkInterfaceResourceId'), '/')[8])]",
                                      "name": "[variables('networkInterfaceDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('logs')]",
                                        "metrics": "[parameters('metrics')]",
                                        "storageAccountId": "[variables('storageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    }
                                  ]
                                }
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-storage-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "condition": "[parameters('deployPolicy')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('assign-policy-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "policy": {
                            "value": "[parameters('policy')]"
                          },
                          "tiers": {
                            "value": [
                              "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value]"
                            ]
                          },
                          "windowsAdministratorsGroupMembership": {
                            "value": "[parameters('windowsAdministratorsGroupMembership')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "4151260437398627510"
                            }
                          },
                          "parameters": {
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "policy": {
                              "type": "string"
                            },
                            "tiers": {
                              "type": "array"
                            },
                            "windowsAdministratorsGroupMembership": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "policyAssignment",
                                "count": "[length(parameters('tiers'))]"
                              },
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('assign-policy-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tiers')[copyIndex()].subscriptionId]",
                              "resourceGroup": "[parameters('tiers')[copyIndex()].resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "builtInAssignment": {
                                    "value": "[parameters('policy')]"
                                  },
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "deployRemediation": {
                                    "value": false
                                  },
                                  "windowsAdministratorsGroupMembership": {
                                    "value": "[parameters('windowsAdministratorsGroupMembership')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "15366687354223606610"
                                    }
                                  },
                                  "parameters": {
                                    "builtInAssignment": {
                                      "type": "string"
                                    },
                                    "deployRemediation": {
                                      "type": "bool"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string"
                                    },
                                    "windowsAdministratorsGroupMembership": {
                                      "type": "string"
                                    }
                                  },
                                  "variables": {
                                    "$fxv#0": "{\r\n  \"listOfMembersToExcludeFromWindowsVMAdministratorsGroup\": {\r\n    \"value\": \"admin\"\r\n  },\r\n  \"IncludeArcMachines\": {\r\n    \"value\": \"true\"\r\n  },\r\n  \"MinimumTLSVersion-5752e6d6-1206-46d8-8ab1-ecc2f71a8112\": {\r\n    \"value\": \"1.2\"\r\n  },\r\n  \"NotAvailableMachineState-bed48b13-6647-468e-aa2f-1af1d3f4dd40\": {\r\n    \"value\": \"Compliant\"\r\n  },\r\n  \"requiredRetentionDays\": {\r\n    \"value\": \"365\"\r\n  },\r\n  \"resourceGroupName-b6e2945c-0b7b-40f5-9233-7a5323b5cdc6\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                                    "$fxv#1": "{\r\n  \"IncludeArcMachines\": {\r\n    \"value\": \"true\"\r\n  },\r\n  \"MinimumTLSVersion-5752e6d6-1206-46d8-8ab1-ecc2f71a8112\": {\r\n    \"value\": \"1.2\"\r\n  },\r\n  \"NotAvailableMachineState-bed48b13-6647-468e-aa2f-1af1d3f4dd40\": {\r\n    \"value\": \"Compliant\"\r\n  },\r\n  \"requiredRetentionDays\": {\r\n    \"value\": \"365\"\r\n  },\r\n  \"resourceGroupName-b6e2945c-0b7b-40f5-9233-7a5323b5cdc6\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                                    "$fxv#2": "{\r\n  \"IncludeArcMachines\": {\r\n    \"value\": \"false\"\r\n  },\r\n  \"NotAvailableMachineState-bed48b13-6647-468e-aa2f-1af1d3f4dd40\": {\r\n    \"value\": \"Compliant\"\r\n  },\r\n  \"MinimumTLSVersionForWindowsServers\": {\r\n    \"value\": \"1.2\"\r\n  },\r\n  \"requiredRetentionDays\": {\r\n    \"value\": \"365\"\r\n  },\r\n  \"effect-febd0533-8e55-448f-b837-bd0e06f16469\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"allowedContainerImagesRegex-febd0533-8e55-448f-b837-bd0e06f16469\": {\r\n    \"value\": \"^(.+){0}$\"\r\n  },\r\n  \"effect-95edb821-ddaf-4404-9732-666045e056b4\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-440b515e-a580-421e-abeb-b159a61ddcbc\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-233a2a17-77ca-4fb1-9b6b-69223d272a44\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-e345eecc-fa47-480f-9e88-67dcc122b164\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"cpuLimit-e345eecc-fa47-480f-9e88-67dcc122b164\": {\r\n    \"value\": \"0\"\r\n  },\r\n  \"memoryLimit-e345eecc-fa47-480f-9e88-67dcc122b164\": {\r\n    \"value\": \"0\"\r\n  },\r\n  \"effect-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"runAsUserRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"MustRunAsNonRoot\"\r\n  },\r\n  \"runAsGroupRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"RunAsAny\"\r\n  },\r\n  \"supplementalGroupsRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"RunAsAny\"\r\n  },\r\n  \"fsGroupRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"RunAsAny\"\r\n  },\r\n  \"effect-1c6e92c9-99f0-4e55-9cf2-0c234dc48f99\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-47a1ee2f-2a2a-4576-bf2a-e0e36709c2b8\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-df49d893-a74c-421d-bc95-c663042e5b80\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-1a5b4dca-0b6f-4cf5-907c-56316bc1bf3d\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-c26596ff-4d70-4e6a-9a30-c2506bd2f80c\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-511f5417-5d12-434d-ab2e-816901e72a5e\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-82985f06-dc18-4a48-bc1c-b9f4f0098cfe\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-098fc59e-46c7-4d99-9b16-64990e543d75\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"setting-a6fb4358-5bf4-4ad7-ba82-2cd2f41ce5e9\": {\r\n    \"value\": \"enabled\"\r\n  },\r\n  \"aadAuthenticationInServiceFabricMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-71ef260a-8f18-47b7-abcb-62d0673d94dc\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-055aa869-bc98-4af8-bafc-23f1ab6ffe2c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-564feb30-bf6a-4854-b4bb-0d2d2d1e6c66\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-862e97cf-49fc-4a5c-9de4-40d4e2e7c8eb\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d9da03a1-f3c3-412a-9709-947156872263\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-617c02be-7f02-4efd-8836-3180d47b6c68\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0b60c0b2-2dc2-4e1c-b5c9-abbed971de53\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1e66c121-a66a-4b1f-9b83-0fd99bf0fc2d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ec068d99-e9c7-401f-8cef-5bdde4e6ccf1\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c349d81b-9985-44ae-a8da-ff98d108ede8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-3657f5a0-770e-44a3-b44e-9431ba1e9735\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-b4ac1030-89c5-4697-8e00-28b5ba6a8811\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-ea0dfaed-95fb-448c-934e-d6e713ce393d\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-4733ea7b-a883-42fe-8cac-97454c2a9e4a\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-f4b53539-8df9-40e4-86c6-6b607703bd4e\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-41425d9f-d1a5-499a-9932-f8ed8453932c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-fc4d8e41-e223-45ea-9bf5-eada37891d87\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-86efb160-8de7-451d-bc08-5d475b0aadae\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-4ec52d6d-beb7-40c4-9a9e-fe753254690e\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-64d314f6-6062-4780-a861-c23e8951bee5\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1fd32ebd-e4c3-4e13-a54a-d7422d4d95f6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-fa298e57-9444-42ba-bf04-86e8470e32c7\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-67121cc7-ff39-4ab8-b7e3-95b84dab487d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1f905d99-2ab7-462c-a6b0-f709acca6c8f\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-5b9159ae-1701-4a6f-9a7a-aa9c8ddd0580\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ba769a63-b8cc-4b2d-abf6-ac33c7204be8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-81e74cea-30fd-40d5-802f-d72103c2aaaa\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0aa61e00-0a01-4a3c-9945-e93cffedf0e6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-47031206-ce96-41f8-861b-6a915f3de284\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-87ba29ef-1ab3-4d82-b763-87fcd4f531f7\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-51522a96-0869-4791-82f3-981000c2c67f\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-b5ec538c-daa0-4006-8596-35468b9148e8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-56a5ee18-2ae6-4810-86f7-18e39ce5629b\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-2e94d99a-8a36-4563-bc77-810d8893b671\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1fafeaf6-7927-4059-a50a-8eb2a7a6f2b5\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-99e9ccd8-3db9-4592-b0d1-14b1715a4d8a\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1f68a601-6e6d-4e42-babf-3f643a047ea2\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-f7d52b2d-e161-4dfa-a82b-55e564167385\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7d7be79c-23ba-4033-84dd-45e2a5ccdd67\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ca91455f-eace-4f96-be59-e6e2c35b4816\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-702dd420-7fcc-42c5-afe8-4026edd20fe0\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"diagnosticsLogsInRedisCacheMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"secureTransferToStorageAccountMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d0793b48-0edc-4296-a390-4c75d1bdfd71\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7d092e0a-7acd-40d2-a975-dca21cae48c4\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-2a1a9cdf-e04d-429a-8416-3bfb72a1b26f\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"disableUnrestrictedNetworkToStorageAccountMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-55615ac9-af46-4a59-874e-391cc3dfb490\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1b8ca024-1d5c-4dec-8995-b1a932b41780\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-037eea7a-bd0a-46c5-9a66-03aea78705d3\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-53503636-bcc9-4748-9663-5348217f160f\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-40cec1dd-a100-4920-b15b-3024fe8901ab\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0725b4dd-7e76-479c-a735-68e7ee23d5ca\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-a049bf77-880b-470f-ba6d-9f21c530cf83\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ee980b6d-0eca-4501-8d54-f6290fd512c3\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1d84d5fb-01f6-4d12-ba4f-4a26081d403d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-37e0d2fe-28a5-43d6-a273-67d37d1f5606\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"identityDesignateMoreThanOneOwnerMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"diskEncryptionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"emailNotificationToSubscriptionOwnerHighSeverityAlertsEnabledEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"functionAppDisableRemoteDebuggingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"sqlDbEncryptionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vulnerabilityAssessmentOnManagedInstanceMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePHPVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"aadAuthenticationInSqlServerMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vmssEndpointProtectionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vmssOsVulnerabilitiesMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"adaptiveApplicationControlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"geoRedundantBackupShouldBeEnabledForAzureDatabaseForPostgreSQLEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"ensureJavaVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityDesignateLessThanOwnersMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"securityContactEmailAddressForSubscriptionEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"webAppRestrictCORSAccessMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveExternalAccountWithWritePermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveExternalAccountWithReadPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveDeprecatedAccountMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"functionAppEnforceHttpsMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"ensurePythonVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePythonVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePHPVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePythonVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"geoRedundantBackupShouldBeEnabledForAzureDatabaseForMySQLEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"systemUpdatesMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureJavaVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureHTTPVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"apiAppRequireLatestTlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityEnableMFAForWritePermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureHTTPVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureJavaVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"nextGenerationFirewallMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"useRbacRulesMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"webAppEnforceHttpsMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"sqlServerAuditingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vnetEnableDDoSProtectionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityEnableMFAForOwnerPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"sqlServerAdvancedDataSecurityMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"sqlManagedInstanceAdvancedDataSecurityMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"endpointProtectionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"jitNetworkAccessMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"apiAppEnforceHttpsMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"geoRedundantStorageShouldBeEnabledForStorageAccountsEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"vmssSystemUpdatesMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"webAppDisableRemoteDebuggingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"longtermGeoRedundantBackupEnabledAzureSQLDatabasesEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"systemConfigurationsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureHTTPVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityEnableMFAForReadPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"containerBenchmarkMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"apiAppDisableRemoteDebuggingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveDeprecatedAccountWithOwnerPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vulnerabilityAssessmentOnServerMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"webAppRequireLatestTlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveExternalAccountWithOwnerPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"functionAppRequireLatestTlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"kubernetesServiceVersionUpToDateMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"sqlDbVulnerabilityAssesmentMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"membersToExcludeInLocalAdministratorsGroup\": {\r\n    \"value\": \"admin\"\r\n  },\r\n  \"PHPLatestVersionForAppServices\": {\r\n    \"value\": \"7.4\"\r\n  },\r\n  \"JavaLatestVersionForAppServices\": {\r\n    \"value\": \"11\"\r\n  },\r\n  \"WindowsPythonLatestVersionForAppServices\": {\r\n    \"value\": \"3.6\"\r\n  },\r\n  \"LinuxPythonLatestVersionForAppServices\": {\r\n    \"value\": \"3.9\"\r\n  },\r\n  \"ensureDotNetFrameworkLatestForFunctionAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlManagedInstanceAdvancedDataSecurityEmailsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"vulnerabilityAssessmentMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"ensureDotNetFrameworkLatestForWebAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlServerAdvancedDataSecurityEmailsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"microsoftIaaSAntimalwareExtensionShouldBeDeployedOnWindowsServersEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"securityCenterStandardPricingTierShouldBeSelectedEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"theLogAnalyticsAgentShouldBeInstalledOnVirtualMachinesEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"ensurePHPVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlManagedInstanceAdvancedDataSecurityEmailAdminsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"securityContactPhoneNumberShouldBeProvidedForSubscriptionEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"threatDetectionTypesOnManagedInstanceMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"ensureDotNetFrameworkLatestForAPIAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlServerAdvancedDataSecurityEmailAdminsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"threatDetectionTypesOnServerMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"theLogAnalyticsAgentShouldBeInstalledOnVirtualMachineScaleSetsEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"NetworkWatcherResourceGroupName\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                                    "$fxv#3": "{\r\n  \"effect-09024ccc-0c5f-475e-9457-b7c0d9ed487b\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0961003e-5a0a-4549-abde-af6a37f2724d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0b15565f-aa9e-48ba-8619-45960f2c314d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0e60b895-3786-45da-8377-9c6b4b6ac5f9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-17k78e20-9358-41c9-923c-fb736d382a12\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-1bc1795e-d44a-4d48-9b3b-6fff0fd5f9ba\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"PHPLatestVersion\": {\r\n    \"value\": \"7.3\"\r\n  },\r\n  \"effect-22bee202-a82f-4305-9a2a-6d7f44d4dedb\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-26a828e1-e88f-464e-bbb3-c134a282b9de\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-34c877ad-507e-4c82-993e-3452a6e0ad3c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-3c735d8a-a4ba-4a3a-b7cf-db7754cf57f4\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-404c3081-a854-4457-ae30-26a93ef643f9\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-47a6b606-51aa-4496-8bb7-64b11cf66adc\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-496223c3-ad65-4ecd-878a-bae78737e9ed\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"JavaLatestVersion\": {\r\n    \"value\": \"11\"\r\n  },\r\n  \"effect-4f11b553-d42e-4e3a-89be-32ca364cad4c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-4f4f78b8-e367-4b10-a341-d9a4ad5cf1c7\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-5c607a2e-c700-4744-8254-d77e7c9eb5e4\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-5f76cf89-fbf2-47fd-a3f4-b891fa780b60\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-6b1cbf55-e8b6-442f-ba4c-7246b6381474\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-6d555dd1-86f2-4f1c-8ed7-5abae7c6cbab\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7008174a-fd10-4ef0-817e-fc820a951d73\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"LinuxPythonLatestVersion\": {\r\n    \"value\": \"3.8\"\r\n  },\r\n  \"effect-7238174a-fd10-4ef0-817e-fc820a951d73\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-7261b898-8a84-4db8-9e04-18527132abb3\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-74c3584d-afae-46f7-a20a-6f8adba71a16\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-86b3d65f-7626-441e-b690-81a8b71cff60\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-88999f4c-376a-45c8-bcb3-4058f713cf39\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-8c122334-9d20-4eb8-89ea-ac9a705b74ae\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-8cb6aa8b-9e41-4f4e-aa25-089a7ac2581e\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9297c21d-2ed6-4474-b48f-163f75654ce3\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-991310cd-e9f3-47bc-b7b6-f57b557d07db\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9b597639-28e4-48eb-b506-56b05d366257\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9d0b6ea4-93e2-4578-bf2f-6bb17d22b4bc\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9daedab3-fb2d-461e-b861-71790eead4f6\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-a4af4a39-4135-47fb-b175-47fbdf85311d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-a6fb4358-5bf4-4ad7-ba82-2cd2f41ce5e9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"setting-a6fb4358-5bf4-4ad7-ba82-2cd2f41ce5e9\": {\r\n    \"value\": \"enabled\"\r\n  },\r\n  \"effect-a70ca396-0a34-413a-88e1-b956c1e683be\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-aa633080-8b72-40c4-a2d7-d00c03e80bed\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-abfb4388-5bf4-4ad7-ba82-2cd2f41ceae9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-abfb7388-5bf4-4ad7-ba99-2cd2f41cebb9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-af6cd1bd-1635-48cb-bde7-5b15693900b9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b7ddfbdc-1260-477d-91fd-98bd9be789a6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c3f317a7-a95c-4547-b7e7-11017ebdf2fe\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-cb510bfd-1cba-4d9f-a230-cb0976f4bb71\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e1e5fd5d-3e4c-4ce1-8661-7d1873ae6b15\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e2c1c086-2d84-4019-bff3-c44ccd95113c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e3576e28-8b17-4677-84c3-db2990658d64\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e8cbc669-f12d-49eb-93e7-9273119e9933\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e9c8d085-d9cc-4b17-9cdc-059f1f01f19e\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ebb62a0c-3560-49e1-89ed-27e074e9f8ad\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-efbde977-ba53-4479-b8e9-10b957924fbf\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f0e6e85b-9b9f-4a4b-b67b-f730d42f1b0b\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f6de0be7-9a8a-4b8a-b349-43cf02d22f7c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f8456c1c-aa66-4dfb-861a-25d127b775c9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f9d614c5-c173-4d56-95a7-b4437057d193\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-fb893a29-21bb-418c-a157-e99480ec364c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-feedbf84-6b99-488c-acc2-71c829aa5ffc\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-3b980d31-7904-4bb7-8575-5665739a8052\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-6e2593d9-add6-4083-9c9b-4b7d2188c899\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b607c5de-e7d9-4eee-9e5c-83f1bcee4fa0\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-12430be1-6cc8-4527-a9a8-e3d38f250096\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"modeRequirement-12430be1-6cc8-4527-a9a8-e3d38f250096\": {\r\n    \"value\": \"Detection\"\r\n  },\r\n  \"effect-425bea59-a659-4cbb-8d31-34499bd030b8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"modeRequirement-425bea59-a659-4cbb-8d31-34499bd030b8\": {\r\n    \"value\": \"Detection\"\r\n  },\r\n  \"effect-564feb30-bf6a-4854-b4bb-0d2d2d1e6c66\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-055aa869-bc98-4af8-bafc-23f1ab6ffe2c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-013e242c-8828-4970-87b3-ab247555486d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-d38fc420-0735-4ef3-ac11-c806f651a570\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-a1181c5f-672a-477a-979a-7d58aa086233\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-308fbb08-4ab8-4e67-9b29-592e93fb94fa\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-4da35fc9-c9e7-4960-aec9-797fe7d9051d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-523b5cd1-3e23-492f-a539-13118b6d1e3a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-7fe3b40f-802b-4cdd-8bd4-fd799c948cc2\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-c25d9a16-bc35-4e15-a7e5-9db606bf9ed4\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b0f33259-77d7-4c9e-aac6-3aabcfae693c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-037eea7a-bd0a-46c5-9a66-03aea78705d3\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0725b4dd-7e76-479c-a735-68e7ee23d5ca\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0820b7b9-23aa-4725-a1ce-ae4558f718e5\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-2c89a2e5-7285-40fe-afe0-ae8654b92fab\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-358c20a6-3f9e-4f0e-97ff-c6ce485e2aac\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-5744710e-cc2f-4ee8-8809-3b11e89f4bc9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ac4a19c2-fa67-49b4-8ae5-0b2e78c49457\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c9d007d0-c057-4772-b18c-01e546713bcd\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d0793b48-0edc-4296-a390-4c75d1bdfd71\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-e372f825-a257-4fb8-9175-797a8a8627d6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d158790f-bfb0-486c-8631-2dc6b4e8e6af\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-e802a67a-daf5-4436-9ea6-f6d821dd0c5d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-a451c1ef-c6ca-483d-87ed-f49761e3ffb5\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftSql-servers-firewallRules-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftNetwork-networkSecurityGroups-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftClassicNetwork-networkSecurityGroups-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftNetwork-networkSecurityGroups-securityRules-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftClassicNetwork-networkSecurityGroups-securityRules-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ae89ebca-1c92-4898-ac2c-9f63decb045c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-d26f7642-7545-4e18-9b75-8c9bbdee3a9a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-1a4e592a-6a6e-44a5-9814-e36264ca96e7\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-7796937f-307b-4598-941c-67d3a05ebfe7\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-c5447c04-a4d7-4ba8-a263-c9ee321a6858\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-41388f1c-2db0-4c25-95b2-35d7f5ccbfa9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b02aacc0-b073-424e-8298-42b22829ee0a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-057d6cfe-9c4f-4a6d-bc60-14420ea1f1a9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0ec47710-77ff-4a3d-9181-6aa50af424d0\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-48af4db5-9b8b-401c-8e74-076be876a430\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-82339799-d096-41ae-8538-b108becf0970\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1b7aa243-30e4-4c9e-bca8-d0d3022b634a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ef2a8f2a-b3d9-49cd-a8a8-9a3aaaf647d9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-bb91dfba-c30d-4263-9add-9c2384e659a6\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e71308d3-144b-4262-b144-efdc3cc90517\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-2bdd0062-9d75-436e-89df-487dd8e4b3c7\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"effect-4733ea7b-a883-42fe-8cac-97454c2a9e4a\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-67121cc7-ff39-4ab8-b7e3-95b84dab487d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-6fac406b-40ca-413b-bf8e-0bf964659c25\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-81e74cea-30fd-40d5-802f-d72103c2aaaa\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c349d81b-9985-44ae-a8da-ff98d108ede8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-f4b53539-8df9-40e4-86c6-6b607703bd4e\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ec068d99-e9c7-401f-8cef-5bdde4e6ccf1\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-048248b0-55cd-46da-b1ff-39efd52db260\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0d134df8-db83-46fb-ad72-fe0c9428c8dd\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-2c89a2e5-7285-40fe-afe0-ae8654b92fb2\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-3657f5a0-770e-44a3-b44e-9431ba1e9735\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-5b9159ae-1701-4a6f-9a7a-aa9c8ddd0580\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-617c02be-7f02-4efd-8836-3180d47b6c68\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7d7be79c-23ba-4033-84dd-45e2a5ccdd67\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-87ba29ef-1ab3-4d82-b763-87fcd4f531f7\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-f7d52b2d-e161-4dfa-a82b-55e564167385\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c43e4a30-77cb-48ab-a4dd-93f175c63b57\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0b60c0b2-2dc2-4e1c-b5c9-abbed971de53\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1e66c121-a66a-4b1f-9b83-0fd99bf0fc2d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1f314764-cb73-4fc9-b863-8eca98ac36e9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-123a3936-f020-408a-ba0c-47873faf1534\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"resourceGroupName-b6e2945c-0b7b-40f5-9233-7a5323b5cdc6\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                                    "modifiedAssignment": "[if(and(equals(toLower(environment().name), toLower('AzureCloud')), equals(toLower(parameters('builtInAssignment')), toLower('IL5'))), 'NISTRev4', parameters('builtInAssignment'))]",
                                    "assignmentName": "[format('{0} {1}', variables('modifiedAssignment'), resourceGroup().name)]",
                                    "agentVmssAssignmentName": "[format('Deploy VMSS Agents {0}', resourceGroup().name)]",
                                    "agentVmAssignmentName": "[format('Deploy VM Agents {0}', resourceGroup().name)]",
                                    "contributorRoleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                    "lawsReaderRoleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '92aaf0da-9dab-42b6-94a3-d43ce8d16293')]"
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Authorization/policyAssignments",
                                      "apiVersion": "2020-09-01",
                                      "name": "[variables('assignmentName')]",
                                      "location": "[parameters('location')]",
                                      "properties": {
                                        "policyDefinitionId": "[createObject('NISTRev4', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/cf25b9c1-bd23-4eb6-bd2c-f4f3ac644a5f', 'parameters', union(json(variables('$fxv#0')), createObject('listOfMembersToIncludeInWindowsVMAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership')), 'logAnalyticsWorkspaceIdforVMReporting', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]))))), 'NISTRev5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/179d1daa-458f-4e47-8086-2a68d0d6c38f', 'parameters', json(variables('$fxv#1'))), 'IL5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/f9a961fa-3241-4b20-adc4-bbf8ad9d7197', 'parameters', union(json(variables('$fxv#2')), createObject('logAnalyticsWorkspaceIDForVMAgents', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])), 'membersToIncludeInLocalAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership'))))), 'CMMC', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/b5629c75-5c77-4422-87b9-2509e680f8de', 'parameters', union(json(variables('$fxv#3')), createObject('logAnalyticsWorkspaceId-f47b5582-33ec-4c5c-87c0-b010a6b2e917', createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]), '2021-06-01').customerId)), if(equals('AzureCloud', environment().name), createObject('MembersToExclude-69bf4abd-ca1e-4cf6-8b5a-762d42e61d4f', createObject('value', 'admin'), 'MembersToInclude-30f71ea1-ac77-4f26-9fc5-2d926bbd4ba7', createObject('value', parameters('windowsAdministratorsGroupMembership'))), createObject()))))[variables('modifiedAssignment')].id]",
                                        "parameters": "[createObject('NISTRev4', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/cf25b9c1-bd23-4eb6-bd2c-f4f3ac644a5f', 'parameters', union(json(variables('$fxv#0')), createObject('listOfMembersToIncludeInWindowsVMAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership')), 'logAnalyticsWorkspaceIdforVMReporting', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]))))), 'NISTRev5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/179d1daa-458f-4e47-8086-2a68d0d6c38f', 'parameters', json(variables('$fxv#1'))), 'IL5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/f9a961fa-3241-4b20-adc4-bbf8ad9d7197', 'parameters', union(json(variables('$fxv#2')), createObject('logAnalyticsWorkspaceIDForVMAgents', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])), 'membersToIncludeInLocalAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership'))))), 'CMMC', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/b5629c75-5c77-4422-87b9-2509e680f8de', 'parameters', union(json(variables('$fxv#3')), createObject('logAnalyticsWorkspaceId-f47b5582-33ec-4c5c-87c0-b010a6b2e917', createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]), '2021-06-01').customerId)), if(equals('AzureCloud', environment().name), createObject('MembersToExclude-69bf4abd-ca1e-4cf6-8b5a-762d42e61d4f', createObject('value', 'admin'), 'MembersToInclude-30f71ea1-ac77-4f26-9fc5-2d926bbd4ba7', createObject('value', parameters('windowsAdministratorsGroupMembership'))), createObject()))))[variables('modifiedAssignment')].parameters]"
                                      },
                                      "identity": {
                                        "type": "SystemAssigned"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Authorization/policyAssignments",
                                      "apiVersion": "2020-09-01",
                                      "name": "[variables('agentVmssAssignmentName')]",
                                      "location": "[parameters('location')]",
                                      "properties": {
                                        "policyDefinitionId": "[tenantResourceId('Microsoft.Authorization/policySetDefinitions', '75714362-cae7-409e-9b99-a8e5075b7fad')]",
                                        "parameters": {
                                          "logAnalytics_1": {
                                            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])]"
                                          }
                                        }
                                      },
                                      "identity": {
                                        "type": "SystemAssigned"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Authorization/policyAssignments",
                                      "apiVersion": "2020-09-01",
                                      "name": "[variables('agentVmAssignmentName')]",
                                      "location": "[parameters('location')]",
                                      "properties": {
                                        "policyDefinitionId": "[tenantResourceId('Microsoft.Authorization/policySetDefinitions', '55f3eceb-5573-4f18-9695-226972c6d74a')]",
                                        "parameters": {
                                          "logAnalytics_1": {
                                            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])]"
                                          }
                                        }
                                      },
                                      "identity": {
                                        "type": "SystemAssigned"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "name": "[guid(variables('contributorRoleDefinitionId'), variables('assignmentName'))]",
                                      "properties": {
                                        "roleDefinitionId": "[variables('contributorRoleDefinitionId')]",
                                        "principalId": "[if(empty(variables('modifiedAssignment')), '', reference(resourceId('Microsoft.Authorization/policyAssignments', variables('assignmentName')), '2020-09-01', 'full').identity.principalId)]",
                                        "principalType": "ServicePrincipal"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('assignmentName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "name": "[guid(variables('contributorRoleDefinitionId'), variables('agentVmssAssignmentName'))]",
                                      "properties": {
                                        "roleDefinitionId": "[variables('contributorRoleDefinitionId')]",
                                        "principalId": "[reference(resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmssAssignmentName')), '2020-09-01', 'full').identity.principalId]",
                                        "principalType": "ServicePrincipal"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmssAssignmentName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "name": "[guid(variables('contributorRoleDefinitionId'), variables('agentVmAssignmentName'))]",
                                      "properties": {
                                        "roleDefinitionId": "[variables('contributorRoleDefinitionId')]",
                                        "principalId": "[reference(resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName')), '2020-09-01', 'full').identity.principalId]",
                                        "principalType": "ServicePrincipal"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]"
                                      ]
                                    },
                                    {
                                      "condition": "[parameters('deployRemediation')]",
                                      "type": "Microsoft.PolicyInsights/remediations",
                                      "apiVersion": "2019-07-01",
                                      "name": "VM-Agent-Policy-Remediation",
                                      "properties": {
                                        "policyAssignmentId": "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]",
                                        "resourceDiscoveryMode": "ReEvaluateCompliance"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('Assign-Laws-Role-Policy-{0}', resourceGroup().name)]",
                                      "subscriptionId": "[split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2]]",
                                      "resourceGroup": "[split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "targetResourceId": {
                                            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])]"
                                          },
                                          "roleDefinitionId": {
                                            "value": "[variables('lawsReaderRoleDefinitionId')]"
                                          },
                                          "principalId": {
                                            "value": "[reference(resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName')), '2020-09-01', 'full').identity.principalId]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "14523277430573151351"
                                            }
                                          },
                                          "parameters": {
                                            "targetResourceId": {
                                              "type": "string"
                                            },
                                            "roleDefinitionId": {
                                              "type": "string"
                                            },
                                            "principalId": {
                                              "type": "string"
                                            },
                                            "principalType": {
                                              "type": "string",
                                              "defaultValue": "ServicePrincipal",
                                              "allowedValues": [
                                                "ForeignGroup",
                                                "Group",
                                                "ServicePrincipal",
                                                "User"
                                              ]
                                            },
                                            "description": {
                                              "type": "string",
                                              "defaultValue": ""
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Authorization/roleAssignments",
                                              "apiVersion": "2020-04-01-preview",
                                              "name": "[guid(parameters('targetResourceId'), parameters('roleDefinitionId'), parameters('principalId'))]",
                                              "properties": {
                                                "principalId": "[parameters('principalId')]",
                                                "principalType": "[parameters('principalType')]",
                                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                                "description": "[parameters('description')]"
                                              }
                                            }
                                          ]
                                        }
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]"
                                      ]
                                    }
                                  ]
                                }
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "condition": "[parameters('deployDefender')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('set-defender-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "emailSecurityContact": {
                            "value": "[parameters('emailSecurityContact')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "1552299118443631720"
                            }
                          },
                          "parameters": {
                            "defenderPlans": {
                              "type": "array",
                              "defaultValue": [
                                "VirtualMachines"
                              ],
                              "metadata": {
                                "description": "Defender Paid protection Plans. Even if a customer selects the free sku, at least 1 paid protection plan must be specified."
                              }
                            },
                            "emailSecurityContact": {
                              "type": "string",
                              "metadata": {
                                "description": "Email address of the contact, in the form of john@doe.com"
                              }
                            },
                            "policySetDescription": {
                              "type": "string",
                              "defaultValue": "The Microsoft Cloud Security Benchmark initiative represents the policies and controls implementing security recommendations defined in Microsoft Cloud Security Benchmark v2, see https://aka.ms/azsecbm. This also serves as the Microsoft Defender for Cloud default policy initiative. You can directly assign this initiative, or manage its policies and compliance results within Microsoft Defender.",
                              "metadata": {
                                "description": "Policy Initiative description field"
                              }
                            },
                            "defenderSkuTier": {
                              "type": "string",
                              "defaultValue": "Free",
                              "metadata": {
                                "description": "[Standard/Free] The SKU for Defender. It defaults to \"Free\"."
                              }
                            }
                          },
                          "variables": {
                            "defenderPaidPlanConfig": {
                              "AzureCloud": {
                                "Api": {
                                  "subPlan": "P1"
                                },
                                "appServices": {},
                                "KeyVaults": {
                                  "subPlan": "PerKeyVault"
                                },
                                "Arm": {
                                  "subPlan": "PerSubscription"
                                },
                                "CloudPosture": {
                                  "extensions": [
                                    {
                                      "name": "SensitiveDataDiscovery",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "ContainerRegistriesVulnerabilityAssessments",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "AgentlessDiscoveryForKubernetes",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "AgentlessVmScanning",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "EntraPermissionsManagement",
                                      "isEnabled": "True"
                                    }
                                  ]
                                },
                                "Containers": {
                                  "extensions": [
                                    {
                                      "name": "ContainerRegistriesVulnerabilityAssessments",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "AgentlessDiscoveryForKubernetes",
                                      "isEnabled": "True"
                                    }
                                  ]
                                },
                                "CosmosDbs": {},
                                "StorageAccounts": {
                                  "subPlan": "DefenderForStorageV2",
                                  "extensions": [
                                    {
                                      "name": "OnUploadMalwareScanning",
                                      "isEnabled": "True",
                                      "additionalExtensionProperties": {
                                        "CapGBPerMonthPerStorageAccount": "5000"
                                      }
                                    },
                                    {
                                      "name": "SensitiveDataDiscovery",
                                      "isEnabled": "True"
                                    }
                                  ]
                                },
                                "VirtualMachines": {
                                  "subPlan": "P1"
                                },
                                "SqlServerVirtualMachines": {},
                                "SqlServers": {},
                                "OpenSourceRelationalDatabases": {}
                              }
                            }
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "defenderFreeAllClouds",
                                "count": "[length(parameters('defenderPlans'))]",
                                "mode": "serial",
                                "batchSize": 1
                              },
                              "condition": "[equals(parameters('defenderSkuTier'), 'Free')]",
                              "type": "Microsoft.Security/pricings",
                              "apiVersion": "2023-01-01",
                              "name": "[parameters('defenderPlans')[copyIndex()]]",
                              "properties": {
                                "pricingTier": "[parameters('defenderSkuTier')]"
                              }
                            },
                            {
                              "copy": {
                                "name": "defenderStandardNoSubplanNoExtensions",
                                "count": "[length(parameters('defenderPlans'))]",
                                "mode": "serial",
                                "batchSize": 1
                              },
                              "condition": "[and(equals(parameters('defenderSkuTier'), 'Standard'), not(equals(environment().name, 'AzureCloud')))]",
                              "type": "Microsoft.Security/pricings",
                              "apiVersion": "2023-01-01",
                              "name": "[parameters('defenderPlans')[copyIndex()]]",
                              "properties": {
                                "pricingTier": "[parameters('defenderSkuTier')]"
                              }
                            },
                            {
                              "copy": {
                                "name": "defenderStandardSubplanExtensionsAzureCloud",
                                "count": "[length(parameters('defenderPlans'))]",
                                "mode": "serial",
                                "batchSize": 1
                              },
                              "condition": "[and(equals(parameters('defenderSkuTier'), 'Standard'), equals(environment().name, 'AzureCloud'))]",
                              "type": "Microsoft.Security/pricings",
                              "apiVersion": "2023-01-01",
                              "name": "[parameters('defenderPlans')[copyIndex()]]",
                              "properties": {
                                "pricingTier": "[parameters('defenderSkuTier')]",
                                "subPlan": "[coalesce(tryGet(variables('defenderPaidPlanConfig')[environment().name][parameters('defenderPlans')[copyIndex()]], 'subPlan'), null())]",
                                "extensions": "[coalesce(tryGet(variables('defenderPaidPlanConfig')[environment().name][parameters('defenderPlans')[copyIndex()]], 'extensions'), null())]"
                              }
                            },
                            {
                              "condition": "[not(empty(parameters('emailSecurityContact')))]",
                              "type": "Microsoft.Security/securityContacts",
                              "apiVersion": "2020-01-01-preview",
                              "name": "default",
                              "properties": {
                                "notificationsByRole": {
                                  "roles": [
                                    "AccountAdmin",
                                    "Contributor",
                                    "Owner",
                                    "ServiceAdmin"
                                  ],
                                  "state": "On"
                                },
                                "alertNotifications": {
                                  "state": "On"
                                },
                                "emails": "[parameters('emailSecurityContact')]"
                              }
                            },
                            {
                              "type": "Microsoft.Authorization/policyAssignments",
                              "apiVersion": "2022-06-01",
                              "name": "Microsoft Cloud Security Benchmark",
                              "properties": {
                                "displayName": "Defender Default",
                                "description": "[parameters('policySetDescription')]",
                                "enforcementMode": "DoNotEnforce",
                                "parameters": {},
                                "policyDefinitionId": "[tenantResourceId('Microsoft.Authorization/policySetDefinitions', '1f3afdf9-d0c9-4c3d-847f-89da613e70a8')]"
                              }
                            }
                          ]
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "delimiter": {
                      "type": "string",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                    },
                    "locationProperties": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.locationProperties.value]"
                    },
                    "mlzTags": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                    },
                    "privateDnsZones": {
                      "type": "array",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZones.value]"
                    },
                    "resourceAbbreviations": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
                    },
                    "tier": {
                      "type": "object",
                      "value": "[union(createObject('dnsServers', coalesce(tryGet(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hubVirtualNetworkResourceId'), '/')[2], split(parameters('hubVirtualNetworkResourceId'), '/')[4]), 'Microsoft.Network/virtualNetworks', split(parameters('hubVirtualNetworkResourceId'), '/')[8]), '2023-11-01'), 'dhcpOptions', 'dnsServers'), createArray()), 'logAnalyticsWorkspaceResourceId', parameters('logAnalyticsWorkspaceResourceId')), reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value)]"
                    },
                    "tokens": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-rg-{0}', parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "name": {
                    "value": "[replace(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.namingConvention.resourceGroup, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value.purpose, 'netAppFiles')]"
                  },
                  "tags": {
                    "value": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Resources/resourceGroups'), createObject()), reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value)]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "29921048879103880"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/resourceGroups",
                      "apiVersion": "2019-05-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "location": {
                      "type": "string",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').location]"
                    },
                    "tags": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').tags]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-netapp-files-{0}', parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "delegatedSubnetResourceId": {
                    "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.subnets, lambda('subnet', contains(lambdaVariables('subnet').name, 'azure-netapp-files')))[0].id]"
                  },
                  "delimiter": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "dnsServers": {
                    "value": "[join(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.dnsServers, ',')]"
                  },
                  "domainJoinPassword": {
                    "value": "[parameters('domainJoinPassword')]"
                  },
                  "domainJoinUserPrincipalName": {
                    "value": "[parameters('domainJoinUserPrincipalName')]"
                  },
                  "domainName": {
                    "value": "[parameters('domainName')]"
                  },
                  "fileShareName": {
                    "value": "[parameters('fileShareName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                  },
                  "netAppAccountName": {
                    "value": "[replace(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.namingConvention.netAppAccount, format('{0}{1}', reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value.purpose), '')]"
                  },
                  "netAppCapacityPoolName": {
                    "value": "[replace(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.namingConvention.netAppAccountCapacityPool, format('{0}{1}', reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value.purpose), '')]"
                  },
                  "organizationalUnitPath": {
                    "value": "[parameters('organizationalUnitPath')]"
                  },
                  "resourceGroupName": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                  },
                  "smbServerName": {
                    "value": "[replace(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.namingConvention.netAppAccountSmbServer, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value.purpose, '')]"
                  },
                  "sku": {
                    "value": "[parameters('sku')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "15345292701637298948"
                    }
                  },
                  "parameters": {
                    "delegatedSubnetResourceId": {
                      "type": "string"
                    },
                    "delimiter": {
                      "type": "string"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "dnsServers": {
                      "type": "string"
                    },
                    "domainJoinPassword": {
                      "type": "securestring"
                    },
                    "domainJoinUserPrincipalName": {
                      "type": "securestring"
                    },
                    "domainName": {
                      "type": "string"
                    },
                    "fileShareName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "netAppAccountName": {
                      "type": "string"
                    },
                    "netAppCapacityPoolName": {
                      "type": "string"
                    },
                    "organizationalUnitPath": {
                      "type": "string"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "smbServerName": {
                      "type": "string"
                    },
                    "sku": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-netapp-files-{0}', parameters('deploymentNameSuffix'))]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "delegatedSubnetResourceId": {
                            "value": "[parameters('delegatedSubnetResourceId')]"
                          },
                          "delimiter": {
                            "value": "[parameters('delimiter')]"
                          },
                          "dnsServers": {
                            "value": "[parameters('dnsServers')]"
                          },
                          "domainJoinPassword": {
                            "value": "[parameters('domainJoinPassword')]"
                          },
                          "domainJoinUserPrincipalName": {
                            "value": "[parameters('domainJoinUserPrincipalName')]"
                          },
                          "domainName": {
                            "value": "[parameters('domainName')]"
                          },
                          "fileShares": {
                            "value": [
                              "[parameters('fileShareName')]"
                            ]
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "netAppAccountNamePrefix": {
                            "value": "[parameters('netAppAccountName')]"
                          },
                          "netAppCapacityPoolNamePrefix": {
                            "value": "[parameters('netAppCapacityPoolName')]"
                          },
                          "organizationalUnitPath": {
                            "value": "[parameters('organizationalUnitPath')]"
                          },
                          "smbServerName": {
                            "value": "[parameters('smbServerName')]"
                          },
                          "storageSku": {
                            "value": "[parameters('sku')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "9015486817651228890"
                            }
                          },
                          "parameters": {
                            "delegatedSubnetResourceId": {
                              "type": "string"
                            },
                            "delimiter": {
                              "type": "string"
                            },
                            "dnsServers": {
                              "type": "string"
                            },
                            "domainJoinPassword": {
                              "type": "securestring"
                            },
                            "domainJoinUserPrincipalName": {
                              "type": "securestring"
                            },
                            "domainName": {
                              "type": "string"
                            },
                            "hostPoolResourceId": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "fileShares": {
                              "type": "array"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "netAppAccountNamePrefix": {
                              "type": "string"
                            },
                            "netAppCapacityPoolNamePrefix": {
                              "type": "string"
                            },
                            "organizationalUnitPath": {
                              "type": "string"
                            },
                            "smbServerName": {
                              "type": "string"
                            },
                            "storageSku": {
                              "type": "string"
                            },
                            "suffix": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "variables": {
                            "nameSuffix": "[if(empty(parameters('suffix')), '', format('{0}{1}', parameters('delimiter'), parameters('suffix')))]",
                            "tagsNetAppAccount": "[union(if(empty(parameters('hostPoolResourceId')), createObject(), createObject('cm-resource-parent', parameters('hostPoolResourceId'))), coalesce(tryGet(parameters('tags'), 'Microsoft.NetApp/netAppAccounts'), createObject()), parameters('mlzTags'))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.NetApp/netAppAccounts",
                              "apiVersion": "2025-01-01",
                              "name": "[format('{0}{1}', parameters('netAppAccountNamePrefix'), variables('nameSuffix'))]",
                              "location": "[parameters('location')]",
                              "tags": "[variables('tagsNetAppAccount')]",
                              "properties": {
                                "activeDirectories": [
                                  {
                                    "aesEncryption": true,
                                    "domain": "[parameters('domainName')]",
                                    "dns": "[parameters('dnsServers')]",
                                    "organizationalUnit": "[if(empty(parameters('organizationalUnitPath')), 'CN=Computers', parameters('organizationalUnitPath'))]",
                                    "password": "[parameters('domainJoinPassword')]",
                                    "smbServerName": "[parameters('smbServerName')]",
                                    "username": "[split(parameters('domainJoinUserPrincipalName'), '@')[0]]"
                                  }
                                ],
                                "encryption": {
                                  "keySource": "Microsoft.NetApp"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.NetApp/netAppAccounts/capacityPools",
                              "apiVersion": "2025-01-01",
                              "name": "[format('{0}/{1}', format('{0}{1}', parameters('netAppAccountNamePrefix'), variables('nameSuffix')), format('{0}{1}', parameters('netAppCapacityPoolNamePrefix'), variables('nameSuffix')))]",
                              "location": "[parameters('location')]",
                              "tags": "[variables('tagsNetAppAccount')]",
                              "properties": {
                                "coolAccess": false,
                                "encryptionType": "Single",
                                "qosType": "Auto",
                                "serviceLevel": "[parameters('storageSku')]",
                                "size": 4398046511104
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.NetApp/netAppAccounts', format('{0}{1}', parameters('netAppAccountNamePrefix'), variables('nameSuffix')))]"
                              ]
                            },
                            {
                              "copy": {
                                "name": "volumes",
                                "count": "[length(range(0, length(parameters('fileShares'))))]"
                              },
                              "type": "Microsoft.NetApp/netAppAccounts/capacityPools/volumes",
                              "apiVersion": "2025-01-01",
                              "name": "[format('{0}/{1}/{2}', format('{0}{1}', parameters('netAppAccountNamePrefix'), variables('nameSuffix')), format('{0}{1}', parameters('netAppCapacityPoolNamePrefix'), variables('nameSuffix')), parameters('fileShares')[range(0, length(parameters('fileShares')))[copyIndex()]])]",
                              "location": "[parameters('location')]",
                              "tags": "[variables('tagsNetAppAccount')]",
                              "properties": {
                                "avsDataStore": "Disabled",
                                "coolAccess": false,
                                "creationToken": "[parameters('fileShares')[range(0, length(parameters('fileShares')))[copyIndex()]]]",
                                "defaultGroupQuotaInKiBs": 0,
                                "defaultUserQuotaInKiBs": 0,
                                "encryptionKeySource": "Microsoft.NetApp",
                                "isDefaultQuotaEnabled": false,
                                "isLargeVolume": false,
                                "kerberosEnabled": false,
                                "ldapEnabled": false,
                                "networkFeatures": "Standard",
                                "protocolTypes": [
                                  "CIFS"
                                ],
                                "securityStyle": "ntfs",
                                "serviceLevel": "[parameters('storageSku')]",
                                "smbAccessBasedEnumeration": "Enabled",
                                "smbContinuouslyAvailable": true,
                                "smbEncryption": true,
                                "smbNonBrowsable": "Disabled",
                                "snapshotDirectoryVisible": true,
                                "subnetId": "[parameters('delegatedSubnetResourceId')]",
                                "usageThreshold": 107374182400
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.NetApp/netAppAccounts/capacityPools', format('{0}{1}', parameters('netAppAccountNamePrefix'), variables('nameSuffix')), format('{0}{1}', parameters('netAppCapacityPoolNamePrefix'), variables('nameSuffix')))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "fileShares": {
                              "type": "array",
                              "copy": {
                                "count": "[length(parameters('fileShares'))]",
                                "input": "[reference(resourceId('Microsoft.NetApp/netAppAccounts/capacityPools/volumes', format('{0}{1}', parameters('netAppAccountNamePrefix'), variables('nameSuffix')), format('{0}{1}', parameters('netAppCapacityPoolNamePrefix'), variables('nameSuffix')), parameters('fileShares')[range(0, length(parameters('fileShares')))[copyIndex()]]), '2025-01-01').mountTargets[0].smbServerFqdn]"
                              }
                            },
                            "smbServerNamePrefix": {
                              "type": "string",
                              "value": "[parameters('smbServerName')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "fileShare": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-netapp-files-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.fileShares.value[0]]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-{0}', parameters('deploymentNameSuffix')))]"
              ]
            }
          ],
          "outputs": {
            "fileShare": {
              "type": "string",
              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-netapp-files-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.fileShare.value]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-mission-landing-zone-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-azure-virtual-desktop-{0}', parameters('deploymentNameSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "activeDirectorySolution": {
            "value": "MicrosoftEntraId"
          },
          "avdObjectId": {
            "value": "[parameters('avdObjectId')]"
          },
          "deployActivityLogDiagnosticSetting": {
            "value": true
          },
          "deployDefender": {
            "value": true
          },
          "deployPolicy": {
            "value": "[parameters('deployPolicy')]"
          },
          "environmentAbbreviation": {
            "value": "[parameters('environmentAbbreviation')]"
          },
          "fileShare": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-azure-netapp-files-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.fileShare.value]"
          },
          "hubAzureFirewallResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-mission-landing-zone-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.azureFirewallResourceId.value]"
          },
          "hubStorageAccountResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-mission-landing-zone-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.hubStorageAccountResourceId.value]"
          },
          "hubVirtualNetworkResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-mission-landing-zone-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.hubVirtualNetworkResourceId.value]"
          },
          "identifier": {
            "value": "[parameters('identifier')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "operationsLogAnalyticsWorkspaceResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-mission-landing-zone-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.logAnalyticsWorkspaceResourceId.value]"
          },
          "policy": {
            "value": "[parameters('policy')]"
          },
          "privateLinkScopeResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-mission-landing-zone-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateLinkScopeResourceId.value]"
          },
          "securityPrincipals": {
            "value": "[parameters('securityPrincipals')]"
          },
          "virtualMachineAdminPassword": {
            "value": "[parameters('domainAdministratorPassword')]"
          },
          "virtualMachineAdminUsername": {
            "value": "[parameters('domainAdministratorUsername')]"
          },
          "virtualMachineSize": {
            "value": "[parameters('virtualMachineSize')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "8234301269783085749"
            }
          },
          "parameters": {
            "activeDirectorySolution": {
              "type": "string",
              "allowedValues": [
                "ActiveDirectoryDomainServices",
                "MicrosoftEntraDomainServices",
                "MicrosoftEntraId",
                "MicrosoftEntraIdIntuneEnrollment"
              ],
              "metadata": {
                "description": "The service providing domain services for Azure Virtual Desktop.  This is needed to properly configure the session hosts and if applicable, the Azure Storage Account."
              }
            },
            "avdObjectId": {
              "type": "string",
              "metadata": {
                "description": "The object ID for the Azure Virtual Desktop enterprise application in Microsoft Entra ID.  The object ID can found by selecting Microsoft Applications using the Application type filter in the Enterprise Applications blade of Microsoft Entra ID."
              }
            },
            "deployActivityLogDiagnosticSetting": {
              "type": "bool",
              "metadata": {
                "description": "Choose whether to deploy a diagnostic setting for the Activity Log."
              }
            },
            "deployDefender": {
              "type": "bool",
              "metadata": {
                "description": "Choose whether to deploy Defender for Cloud."
              }
            },
            "deployNetworkWatcherTrafficAnalytics": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When set to true, deploys Network Watcher Traffic Analytics. It defaults to \"false\"."
              }
            },
            "deployPolicy": {
              "type": "bool",
              "metadata": {
                "description": "Choose whether to deploy a policy assignment."
              }
            },
            "deploymentNameSuffix": {
              "type": "string",
              "defaultValue": "[utcNow()]",
              "metadata": {
                "description": "A suffix to use for naming deployments uniquely. It defaults to the Bicep resolution of the \"utcNow()\" function."
              }
            },
            "domainName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The name of the domain that provides ADDS to the AVD session hosts."
              }
            },
            "emailSecurityContact": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The email address to use for Defender for Cloud notifications."
              }
            },
            "environmentAbbreviation": {
              "type": "string",
              "defaultValue": "dev",
              "allowedValues": [
                "dev",
                "prod",
                "test"
              ],
              "metadata": {
                "description": "The abbreviation for the target environment."
              }
            },
            "fileShare": {
              "type": "string",
              "metadata": {
                "description": "The file share on Azure NetApp Files to store unstructured geospatial data."
              }
            },
            "hostPoolPublicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Disabled",
                "Enabled",
                "EnabledForClientsOnly",
                "EnabledForSessionHostsOnly"
              ],
              "metadata": {
                "description": "The type of public network access for the host pool."
              }
            },
            "hubAzureFirewallResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID for the Azure Firewall in the HUB subscription"
              }
            },
            "hubStorageAccountResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID for the Storage Account in the HUB subscription."
              }
            },
            "hubVirtualNetworkResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID for the Azure Virtual Network in the HUB subscription."
              }
            },
            "identifier": {
              "type": "string",
              "defaultValue": "avd",
              "maxLength": 3,
              "metadata": {
                "description": "The unique identifier between each business unit or project supporting AVD in your tenant. This is the unique naming component between each AVD stamp."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[deployment().location]",
              "metadata": {
                "description": "The deployment location for the AVD sessions hosts. This is necessary when the users are closer to a different location than the control plane location."
              }
            },
            "logAnalyticsWorkspaceRetention": {
              "type": "int",
              "defaultValue": 30,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "The retention for the Log Analytics Workspace to setup the AVD monitoring solution"
              }
            },
            "logAnalyticsWorkspaceSku": {
              "type": "string",
              "defaultValue": "PerGB2018",
              "allowedValues": [
                "Free",
                "Standard",
                "Premium",
                "PerNode",
                "PerGB2018",
                "Standalone",
                "CapacityReservation"
              ],
              "metadata": {
                "description": "The SKU for the Log Analytics Workspace to setup the AVD monitoring solution"
              }
            },
            "logStorageSkuName": {
              "type": "string",
              "defaultValue": "Standard_GRS",
              "metadata": {
                "description": "The Storage Account SKU to use for log storage. It defaults to \"Standard_GRS\". See https://docs.microsoft.com/en-us/rest/api/storagerp/srp_sku_types for valid settings."
              }
            },
            "managementSubnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.141.0/26",
              "metadata": {
                "description": "The address prefix(es) for the new subnet(s) that will be created in the spoke virtual network(s). Specify only one address prefix in the array if the session hosts location and the control plan location are the same. If different locations are specified, add a second address prefix for the hosts virtual network."
              }
            },
            "networkSecurityGroupRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The rules to apply to the Network Security Group."
              }
            },
            "networkWatcherFlowLogsRetentionDays": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "The number of days to retain Network Watcher Flow Logs. It defaults to \"30\"."
              }
            },
            "networkWatcherFlowLogsType": {
              "type": "string",
              "defaultValue": "VirtualNetwork",
              "allowedValues": [
                "NetworkSecurityGroup",
                "VirtualNetwork"
              ],
              "metadata": {
                "description": "When set to \"true\", enables Virtual Network Flow Logs. It defaults to \"true\" as its required by MCSB."
              }
            },
            "operationsLogAnalyticsWorkspaceResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Log Analytics Workspace to use for log storage."
              }
            },
            "policy": {
              "type": "string",
              "defaultValue": "NISTRev4",
              "metadata": {
                "description": "The policy to assign to the workload."
              }
            },
            "privateLinkScopeResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID for the Azure Monitor Private Link Scope in the Operations subscription / resource group."
              }
            },
            "securityPrincipals": {
              "type": "array",
              "metadata": {
                "description": "The array of Security Principals with their object IDs and display names to assign to the AVD Application Group and FSLogix Storage."
              }
            },
            "sessionHostsSubnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.140.0/24",
              "metadata": {
                "description": "The address prefix(es) for the new subnet(s) that will be created in the spoke virtual network(s). Specify only one address prefix in the array if the session hosts location and the control plan location are the same. If different locations are specified, add a second address prefix for the hosts virtual network."
              }
            },
            "stampVirtualNetworkAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.140.0/23",
              "metadata": {
                "description": "The address prefix for the new spoke virtual network(s). Specify only one address prefix in the array if the session hosts location and the control plan location are the same. If different locations are specified, add a second address prefix for the hosts virtual network."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The Key / value pairs of metadata for the Azure resource groups and resources."
              }
            },
            "virtualMachineAdminPassword": {
              "type": "securestring",
              "metadata": {
                "description": "The local administrator password for the AVD session hosts"
              }
            },
            "virtualMachineAdminUsername": {
              "type": "string",
              "metadata": {
                "description": "The local administrator username for the AVD session hosts"
              }
            },
            "virtualMachineSize": {
              "type": "string",
              "defaultValue": "Standard_D4ads_v5",
              "metadata": {
                "description": "The virtual machine SKU for the AVD session hosts."
              }
            },
            "workspacePublicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Disabled",
                "Enabled"
              ],
              "metadata": {
                "description": "The public network access setting on the AVD workspace either disables public network access or allows both public and private network access."
              }
            }
          },
          "variables": {
            "avdStorageAccountEndpoint": "[format('{0}.blob.{1}', variables('avdStorageAccountName'), environment().suffixes.storage)]",
            "avdStorageAccountName": "[if(startsWith(parameters('location'), 'usn'), 'wvdexportalcontainer', 'wvdportalstorageblob')]",
            "privateDnsZoneResourceIdPrefix": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/', split(parameters('hubVirtualNetworkResourceId'), '/')[2], split(parameters('hubVirtualNetworkResourceId'), '/')[4])]",
            "subscriptionId": "[subscription().subscriptionId]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2021-04-01",
              "name": "pid-4e82be1d-7fcb-4913-a90c-aa84d7ea3a1c",
              "location": "[parameters('location')]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": []
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "additionalSubnets": {
                    "value": [
                      {
                        "name": "avd-management",
                        "properties": {
                          "addressPrefix": "[parameters('managementSubnetAddressPrefix')]"
                        }
                      }
                    ]
                  },
                  "customFirewallRuleCollectionGroups": {
                    "value": []
                  },
                  "deployActivityLogDiagnosticSetting": {
                    "value": "[parameters('deployActivityLogDiagnosticSetting')]"
                  },
                  "deployDefender": {
                    "value": "[parameters('deployDefender')]"
                  },
                  "deployNetworkWatcherTrafficAnalytics": {
                    "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                  },
                  "deployPolicy": {
                    "value": "[parameters('deployPolicy')]"
                  },
                  "emailSecurityContact": {
                    "value": "[parameters('emailSecurityContact')]"
                  },
                  "environmentAbbreviation": {
                    "value": "[parameters('environmentAbbreviation')]"
                  },
                  "firewallResourceId": {
                    "value": "[parameters('hubAzureFirewallResourceId')]"
                  },
                  "hubStorageAccountResourceId": {
                    "value": "[parameters('hubStorageAccountResourceId')]"
                  },
                  "hubVirtualNetworkResourceId": {
                    "value": "[parameters('hubVirtualNetworkResourceId')]"
                  },
                  "identifier": {
                    "value": "[parameters('identifier')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('operationsLogAnalyticsWorkspaceResourceId')]"
                  },
                  "logStorageSkuName": {
                    "value": "[parameters('logStorageSkuName')]"
                  },
                  "networkSecurityGroupRules": {
                    "value": "[parameters('networkSecurityGroupRules')]"
                  },
                  "networkWatcherFlowLogsRetentionDays": {
                    "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                  },
                  "networkWatcherFlowLogsType": {
                    "value": "[parameters('networkWatcherFlowLogsType')]"
                  },
                  "policy": {
                    "value": "[parameters('policy')]"
                  },
                  "subnetAddressPrefix": {
                    "value": "[parameters('sessionHostsSubnetAddressPrefix')]"
                  },
                  "subnetName": {
                    "value": "avd-session-hosts"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "virtualNetworkAddressPrefix": {
                    "value": "[parameters('stampVirtualNetworkAddressPrefix')]"
                  },
                  "windowsAdministratorsGroupMembership": {
                    "value": "[parameters('virtualMachineAdminUsername')]"
                  },
                  "workloadName": {
                    "value": "avd"
                  },
                  "workloadShortName": {
                    "value": "avd"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "9289611236508112440"
                    }
                  },
                  "parameters": {
                    "additionalSubnets": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "An array of additional subnets to support the tier3 workload."
                      }
                    },
                    "blobDiagnosticsLogs": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "categoryGroup": "allLogs",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Blob Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/blobs/monitor-blob-storage?tabs=azure-portal#enable-diagnostic-logging."
                      }
                    },
                    "blobDiagnosticsMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "Transaction",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Blob Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/blobs/monitor-blob-storage?tabs=azure-portal#enable-metrics."
                      }
                    },
                    "customFirewallRuleCollectionGroups": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "The custom firewall rule collection groups that override the default firewall rule collection groups."
                      }
                    },
                    "deployActivityLogDiagnosticSetting": {
                      "type": "bool",
                      "metadata": {
                        "description": "Choose whether to deploy a diagnostic setting for the Activity Log."
                      }
                    },
                    "deployDefender": {
                      "type": "bool",
                      "metadata": {
                        "description": "Choose whether to deploy Defender for Cloud."
                      }
                    },
                    "deploymentNameSuffix": {
                      "type": "string",
                      "defaultValue": "[utcNow()]",
                      "metadata": {
                        "description": "The suffix to append to the deployment name. It defaults to the current UTC date and time."
                      }
                    },
                    "deployNetworkWatcherTrafficAnalytics": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "When set to true, deploys Network Watcher Traffic Analytics. It defaults to \"false\"."
                      }
                    },
                    "deployPolicy": {
                      "type": "bool",
                      "metadata": {
                        "description": "Choose whether to deploy a policy assignment."
                      }
                    },
                    "emailSecurityContact": {
                      "type": "string",
                      "metadata": {
                        "description": "The email address to use for Defender for Cloud notifications."
                      }
                    },
                    "environmentAbbreviation": {
                      "type": "string",
                      "defaultValue": "dev",
                      "allowedValues": [
                        "dev",
                        "prod",
                        "test"
                      ],
                      "metadata": {
                        "description": "The abbreviation for the environment."
                      }
                    },
                    "fileDiagnosticsLogs": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "categoryGroup": "allLogs",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of File Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/files/monitor-file-storage?tabs=azure-portal#enable-diagnostic-logging."
                      }
                    },
                    "fileDiagnosticsMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "Transaction",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of File Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/files/monitor-file-storage?tabs=azure-portal#enable-metrics."
                      }
                    },
                    "firewallResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the Azure Firewall in the HUB."
                      }
                    },
                    "hubStorageAccountResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the HUB Storage Account."
                      }
                    },
                    "hubVirtualNetworkResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the HUB Virtual Network."
                      }
                    },
                    "identifier": {
                      "type": "string",
                      "maxLength": 3,
                      "metadata": {
                        "description": "The identifier for the resource names. This value should represent the workload, project, or business unit."
                      }
                    },
                    "keyVaultDiagnosticLogs": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "AuditEvent",
                          "enabled": true
                        },
                        {
                          "category": "AzurePolicyEvaluationDetails",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Key Vault Diagnostic Logs categories to collect. See \"https://learn.microsoft.com/en-us/azure/key-vault/general/logging?tabs=Vault\" for valid values."
                      }
                    },
                    "keyVaultDiagnosticMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "AllMetrics",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "The Key Vault Diagnostic Metrics to collect. See the following URL for valid settings: \"https://learn.microsoft.com/azure/key-vault/general/logging?tabs=Vault\"."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[deployment().location]",
                      "metadata": {
                        "description": "The location for the deployment. It defaults to the location of the deployment."
                      }
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the Log Analytics Workspace to use for log storage."
                      }
                    },
                    "logStorageSkuName": {
                      "type": "string",
                      "defaultValue": "Standard_GRS",
                      "metadata": {
                        "description": "The Storage Account SKU to use for log storage. It defaults to \"Standard_GRS\". See https://docs.microsoft.com/en-us/rest/api/storagerp/srp_sku_types for valid settings."
                      }
                    },
                    "networkInterfaceDiagnosticsMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "AllMetrics",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of metrics to enable on the diagnostic setting for network interfaces."
                      }
                    },
                    "networkSecurityGroupDiagnosticsLogs": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "NetworkSecurityGroupEvent",
                          "enabled": true
                        },
                        {
                          "category": "NetworkSecurityGroupRuleCounter",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Network Security Group diagnostic logs to apply to the workload Virtual Network. See https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-nsg-manage-log#log-categories for valid settings."
                      }
                    },
                    "networkSecurityGroupRules": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "The rules to apply to the Network Security Group."
                      }
                    },
                    "networkWatcherFlowLogsRetentionDays": {
                      "type": "int",
                      "defaultValue": 30,
                      "metadata": {
                        "description": "The number of days to retain Network Watcher Flow Logs. It defaults to \"30\"."
                      }
                    },
                    "networkWatcherFlowLogsType": {
                      "type": "string",
                      "defaultValue": "VirtualNetwork",
                      "allowedValues": [
                        "NetworkSecurityGroup",
                        "VirtualNetwork"
                      ],
                      "metadata": {
                        "description": "When set to \"true\", enables Virtual Network Flow Logs. It defaults to \"true\" as its required by MCSB."
                      }
                    },
                    "queueDiagnosticsLogs": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "categoryGroup": "allLogs",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Queue Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/queues/monitor-queue-storage?tabs=azure-portal#enable-diagnostic-logging."
                      }
                    },
                    "queueDiagnosticsMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "Transaction",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Queue Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/queues/monitor-queue-storage?tabs=azure-portal#enable-metrics."
                      }
                    },
                    "policy": {
                      "type": "string",
                      "defaultValue": "NISTRev4",
                      "metadata": {
                        "description": "The policy to assign to the workload."
                      }
                    },
                    "stampIndex": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The stamp index allows for multiple deployments of a similar workload without naming conflicts."
                      }
                    },
                    "storageAccountDiagnosticsLogs": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "An array of Storage Account Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/common/monitor-storage?tabs=azure-portal#enable-diagnostic-logging."
                      }
                    },
                    "storageAccountDiagnosticsMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "Transaction",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Storage Account Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/common/monitor-storage?tabs=azure-portal#enable-metrics."
                      }
                    },
                    "subnetAddressPrefix": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The address prefix for the workload subnet."
                      }
                    },
                    "subnetName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The custom name for the workload subnet if the naming convention is not desired. Subnets are child resources and do not require a unique name between virtual networks, only within the same virtual network."
                      }
                    },
                    "tableDiagnosticsLogs": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "categoryGroup": "allLogs",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Table Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/tables/monitor-table-storage?tabs=azure-portal#enable-diagnostic-logging."
                      }
                    },
                    "tableDiagnosticsMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "Transaction",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "An array of Table Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/storage/tables/monitor-table-storage?tabs=azure-portal#enable-metrics."
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "The tags to apply to the resources."
                      }
                    },
                    "virtualNetworkAddressPrefix": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The address prefix for the workload Virtual Network."
                      }
                    },
                    "virtualNetworkDiagnosticsLogs": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "VMProtectionAlerts",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "The diagnostic logs to apply to the workload Virtual Network."
                      }
                    },
                    "virtualNetworkDiagnosticsMetrics": {
                      "type": "array",
                      "defaultValue": [
                        {
                          "category": "AllMetrics",
                          "enabled": true
                        }
                      ],
                      "metadata": {
                        "description": "The metrics to monitor for the workload Virtual Network."
                      }
                    },
                    "windowsAdministratorsGroupMembership": {
                      "type": "string",
                      "defaultValue": "xadmin",
                      "metadata": {
                        "description": "The local administrator username for Windows virtual machines. This value is needed if you plan to deploy the following Azure Policy initiatives: CMMC Level 3, DoD Impact Level 5, or NIST SP 800-53 Rev. 4 It defaults to \"xadmin\"."
                      }
                    },
                    "workloadName": {
                      "type": "string",
                      "defaultValue": "tier3",
                      "minLength": 1,
                      "maxLength": 10,
                      "metadata": {
                        "description": "The name for the workload."
                      }
                    },
                    "workloadShortName": {
                      "type": "string",
                      "defaultValue": "t3",
                      "minLength": 1,
                      "maxLength": 3,
                      "metadata": {
                        "description": "The short name for the workload."
                      }
                    }
                  },
                  "variables": {
                    "hubResourceGroupName": "[split(parameters('hubVirtualNetworkResourceId'), '/')[4]]",
                    "hubSubscriptionId": "[split(parameters('hubVirtualNetworkResourceId'), '/')[2]]",
                    "deploymentIndex": "[if(empty(parameters('stampIndex')), '', format('{0}-', parameters('stampIndex')))]",
                    "subscriptionId": "[subscription().subscriptionId]"
                  },
                  "resources": [
                    {
                      "condition": "[not(empty(parameters('customFirewallRuleCollectionGroups')))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-firewall-rules-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[variables('hubSubscriptionId')]",
                      "resourceGroup": "[variables('hubResourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "firewallPolicyName": {
                            "value": "[split(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('firewallResourceId'), '/')[2], split(parameters('firewallResourceId'), '/')[4]), 'Microsoft.Network/azureFirewalls', split(parameters('firewallResourceId'), '/')[8]), '2020-11-01').firewallPolicy.id, '/')[8]]"
                          },
                          "firewallRuleCollectionGroups": {
                            "value": "[parameters('customFirewallRuleCollectionGroups')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "8588468010825274521"
                            }
                          },
                          "parameters": {
                            "firewallPolicyName": {
                              "type": "string"
                            },
                            "firewallRuleCollectionGroups": {
                              "type": "array"
                            }
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "ruleCreate",
                                "count": "[length(parameters('firewallRuleCollectionGroups'))]",
                                "mode": "serial",
                                "batchSize": 1
                              },
                              "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
                              "apiVersion": "2024-03-01",
                              "name": "[format('{0}/{1}', parameters('firewallPolicyName'), parameters('firewallRuleCollectionGroups')[copyIndex()].name)]",
                              "properties": "[parameters('firewallRuleCollectionGroups')[copyIndex()].properties]"
                            }
                          ]
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('get-vnet-peerings-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "virtualNetworkPeerings": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hubVirtualNetworkResourceId'), '/')[2], split(parameters('hubVirtualNetworkResourceId'), '/')[4]), 'Microsoft.Network/virtualNetworks', split(parameters('hubVirtualNetworkResourceId'), '/')[8]), '2023-11-01').virtualNetworkPeerings]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "518768753620066763"
                            }
                          },
                          "parameters": {
                            "virtualNetworkPeerings": {
                              "type": "array"
                            }
                          },
                          "variables": {
                            "copy": [
                              {
                                "name": "resourceIds",
                                "count": "[length(parameters('virtualNetworkPeerings'))]",
                                "input": "[parameters('virtualNetworkPeerings')[copyIndex('resourceIds')].properties.remoteVirtualNetwork.id]"
                              },
                              {
                                "name": "subscriptionIds",
                                "count": "[length(variables('resourceIds'))]",
                                "input": "[split(variables('resourceIds')[copyIndex('subscriptionIds')], '/')[2]]"
                              }
                            ]
                          },
                          "resources": [],
                          "outputs": {
                            "subscriptionIds": {
                              "type": "array",
                              "value": "[variables('subscriptionIds')]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "additionalSubnets": {
                            "value": "[parameters('additionalSubnets')]"
                          },
                          "deploymentIndex": {
                            "value": "[variables('deploymentIndex')]"
                          },
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "environmentAbbreviation": {
                            "value": "[parameters('environmentAbbreviation')]"
                          },
                          "hubVirtualNetworkResourceId": {
                            "value": "[parameters('hubVirtualNetworkResourceId')]"
                          },
                          "identifier": {
                            "value": "[parameters('identifier')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "network": {
                            "value": {
                              "name": "[parameters('workloadName')]",
                              "nsgDiagLogs": "[parameters('networkSecurityGroupDiagnosticsLogs')]",
                              "nsgRules": "[parameters('networkSecurityGroupRules')]",
                              "shortName": "[parameters('workloadShortName')]",
                              "subnetAddressPrefix": "[parameters('subnetAddressPrefix')]",
                              "subscriptionId": "[variables('subscriptionId')]",
                              "vnetAddressPrefix": "[parameters('virtualNetworkAddressPrefix')]",
                              "vnetDiagLogs": "[parameters('virtualNetworkDiagnosticsLogs')]",
                              "vnetDiagMetrics": "[parameters('virtualNetworkDiagnosticsMetrics')]"
                            }
                          },
                          "routeTableRouteNextHopIpAddress": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('firewallResourceId'), '/')[2], split(parameters('firewallResourceId'), '/')[4]), 'Microsoft.Network/azureFirewalls', split(parameters('firewallResourceId'), '/')[8]), '2020-11-01').ipConfigurations[0].properties.privateIPAddress]"
                          },
                          "stampIndex": {
                            "value": "[parameters('stampIndex')]"
                          },
                          "subnetName": {
                            "value": "[parameters('subnetName')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "vNetDnsServers": {
                            "value": "[coalesce(tryGet(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hubVirtualNetworkResourceId'), '/')[2], split(parameters('hubVirtualNetworkResourceId'), '/')[4]), 'Microsoft.Network/virtualNetworks', split(parameters('hubVirtualNetworkResourceId'), '/')[8]), '2023-11-01'), 'dhcpOptions', 'dnsServers'), createArray())]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "659833522225265916"
                            }
                          },
                          "parameters": {
                            "additionalSubnets": {
                              "type": "array"
                            },
                            "deploymentIndex": {
                              "type": "string"
                            },
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "environmentAbbreviation": {
                              "type": "string"
                            },
                            "hubVirtualNetworkResourceId": {
                              "type": "string"
                            },
                            "identifier": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "network": {
                              "type": "object"
                            },
                            "routeTableRouteNextHopIpAddress": {
                              "type": "string"
                            },
                            "stampIndex": {
                              "type": "string"
                            },
                            "subnetName": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "vNetDnsServers": {
                              "type": "array"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "delimiter": {
                                    "value": "-"
                                  },
                                  "deploymentNameSuffix": {
                                    "value": "[parameters('deploymentNameSuffix')]"
                                  },
                                  "environmentAbbreviation": {
                                    "value": "[parameters('environmentAbbreviation')]"
                                  },
                                  "identifier": {
                                    "value": "[parameters('identifier')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "networks": {
                                    "value": [
                                      "[parameters('network')]"
                                    ]
                                  },
                                  "stampIndex": {
                                    "value": "[parameters('stampIndex')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "14956586253638960991"
                                    }
                                  },
                                  "parameters": {
                                    "delimiter": {
                                      "type": "string"
                                    },
                                    "deploymentNameSuffix": {
                                      "type": "string"
                                    },
                                    "environmentAbbreviation": {
                                      "type": "string"
                                    },
                                    "identifier": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "networks": {
                                      "type": "array"
                                    },
                                    "stampIndex": {
                                      "type": "string",
                                      "defaultValue": ""
                                    }
                                  },
                                  "variables": {
                                    "$fxv#0": {
                                      "AzureChina": {
                                        "chinaeast": {
                                          "abbreviation": "cne",
                                          "recoveryServicesGeo": "sha",
                                          "timeDifference": "+8:00",
                                          "timeZone": "China Standard Time"
                                        },
                                        "chinaeast2": {
                                          "abbreviation": "cne2",
                                          "recoveryServicesGeo": "sha2",
                                          "timeDifference": "+8:00",
                                          "timeZone": "China Standard Time"
                                        },
                                        "chinanorth": {
                                          "abbreviation": "cnn",
                                          "recoveryServicesGeo": "bjb",
                                          "timeDifference": "+8:00",
                                          "timeZone": "China Standard Time"
                                        },
                                        "chinanorth2": {
                                          "abbreviation": "cnn2",
                                          "recoveryServicesGeo": "bjb2",
                                          "timeDifference": "+8:00",
                                          "timeZone": "China Standard Time"
                                        }
                                      },
                                      "AzureCloud": {
                                        "australiacentral": {
                                          "abbreviation": "auc",
                                          "recoveryServicesGeo": "acl",
                                          "timeDifference": "+10:00",
                                          "timeZone": "AUS Eastern Standard Time"
                                        },
                                        "australiacentral2": {
                                          "abbreviation": "auc2",
                                          "recoveryServicesGeo": "acl2",
                                          "timeDifference": "+10:00",
                                          "timeZone": "AUS Eastern Standard Time"
                                        },
                                        "australiaeast": {
                                          "abbreviation": "aue",
                                          "recoveryServicesGeo": "ae",
                                          "timeDifference": "+10:00",
                                          "timeZone": "AUS Eastern Standard Time"
                                        },
                                        "australiasoutheast": {
                                          "abbreviation": "ause",
                                          "recoveryServicesGeo": "ase",
                                          "timeDifference": "+10:00",
                                          "timeZone": "AUS Eastern Standard Time"
                                        },
                                        "brazilsouth": {
                                          "abbreviation": "brs",
                                          "recoveryServicesGeo": "brs",
                                          "timeDifference": "-3:00",
                                          "timeZone": "E. South America Standard Time"
                                        },
                                        "brazilsoutheast": {
                                          "abbreviation": "brse",
                                          "recoveryServicesGeo": "bse",
                                          "timeDifference": "-3:00",
                                          "timeZone": "E. South America Standard Time"
                                        },
                                        "canadacentral": {
                                          "abbreviation": "cac",
                                          "recoveryServicesGeo": "cnc",
                                          "timeDifference": "-5:00",
                                          "timeZone": "Eastern Standard Time"
                                        },
                                        "canadaeast": {
                                          "abbreviation": "cae",
                                          "recoveryServicesGeo": "cne",
                                          "timeDifference": "-5:00",
                                          "timeZone": "Eastern Standard Time"
                                        },
                                        "centralindia": {
                                          "abbreviation": "inc",
                                          "recoveryServicesGeo": "inc",
                                          "timeDifference": "+5:30",
                                          "timeZone": "India Standard Time"
                                        },
                                        "centralus": {
                                          "abbreviation": "usc",
                                          "recoveryServicesGeo": "cus",
                                          "timeDifference": "-6:00",
                                          "timeZone": "Central Standard Time"
                                        },
                                        "eastasia": {
                                          "abbreviation": "ase",
                                          "recoveryServicesGeo": "ea",
                                          "timeDifference": "+8:00",
                                          "timeZone": "China Standard Time"
                                        },
                                        "eastus": {
                                          "abbreviation": "use",
                                          "recoveryServicesGeo": "eus",
                                          "timeDifference": "-5:00",
                                          "timeZone": "Eastern Standard Time"
                                        },
                                        "eastus2": {
                                          "abbreviation": "use2",
                                          "recoveryServicesGeo": "eus2",
                                          "timeDifference": "-5:00",
                                          "timeZone": "Eastern Standard Time"
                                        },
                                        "francecentral": {
                                          "abbreviation": "frc",
                                          "recoveryServicesGeo": "frc",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "francesouth": {
                                          "abbreviation": "frs",
                                          "recoveryServicesGeo": "frs",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "germanynorth": {
                                          "abbreviation": "den",
                                          "recoveryServicesGeo": "gn",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "germanywestcentral": {
                                          "abbreviation": "dewc",
                                          "recoveryServicesGeo": "gwc",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "israelcentral": {
                                          "abbreviation": "ilc",
                                          "recoveryServicesGeo": "ilc",
                                          "timeDifference": "+2:00",
                                          "timeZone": "Israel Standard Time"
                                        },
                                        "italynorth": {
                                          "abbreviation": "itn",
                                          "recoveryServicesGeo": "itn",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "japaneast": {
                                          "abbreviation": "jpe",
                                          "recoveryServicesGeo": "jpe",
                                          "timeDifference": "+9:00",
                                          "timeZone": "Tokyo Standard Time"
                                        },
                                        "japanwest": {
                                          "abbreviation": "jpw",
                                          "recoveryServicesGeo": "jpw",
                                          "timeDifference": "+9:00",
                                          "timeZone": "Tokyo Standard Time"
                                        },
                                        "jioindiacentral": {
                                          "abbreviation": "injc",
                                          "recoveryServicesGeo": "jic",
                                          "timeDifference": "+5:30",
                                          "timeZone": "India Standard Time"
                                        },
                                        "jioindiawest": {
                                          "abbreviation": "injw",
                                          "recoveryServicesGeo": "jiw",
                                          "timeDifference": "+5:30",
                                          "timeZone": "India Standard Time"
                                        },
                                        "koreacentral": {
                                          "abbreviation": "krc",
                                          "recoveryServicesGeo": "krc",
                                          "timeDifference": "+9:00",
                                          "timeZone": "Korea Standard Time"
                                        },
                                        "koreasouth": {
                                          "abbreviation": "krs",
                                          "recoveryServicesGeo": "krs",
                                          "timeDifference": "+9:00",
                                          "timeZone": "Korea Standard Time"
                                        },
                                        "northcentralus": {
                                          "abbreviation": "usnc",
                                          "recoveryServicesGeo": "ncus",
                                          "timeDifference": "-6:00",
                                          "timeZone": "Central Standard Time"
                                        },
                                        "northeurope": {
                                          "abbreviation": "eun",
                                          "recoveryServicesGeo": "ne",
                                          "timeDifference": "0:00",
                                          "timeZone": "GMT Standard Time"
                                        },
                                        "norwayeast": {
                                          "abbreviation": "noe",
                                          "recoveryServicesGeo": "nwe",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "norwaywest": {
                                          "abbreviation": "now",
                                          "recoveryServicesGeo": "nww",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "polandcentral": {
                                          "abbreviation": "plc",
                                          "recoveryServicesGeo": "plc",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "qatarcentral": {
                                          "abbreviation": "qac",
                                          "recoveryServicesGeo": "qac",
                                          "timeDifference": "+3:00",
                                          "timeZone": "Arabian Standard Time"
                                        },
                                        "southafricanorth": {
                                          "abbreviation": "zan",
                                          "recoveryServicesGeo": "san",
                                          "timeDifference": "+2:00",
                                          "timeZone": "South Africa Standard Time"
                                        },
                                        "southafricawest": {
                                          "abbreviation": "zaw",
                                          "recoveryServicesGeo": "saw",
                                          "timeDifference": "+2:00",
                                          "timeZone": "South Africa Standard Time"
                                        },
                                        "southcentralus": {
                                          "abbreviation": "ussc",
                                          "recoveryServicesGeo": "scus",
                                          "timeDifference": "-6:00",
                                          "timeZone": "Central Standard Time"
                                        },
                                        "southeastasia": {
                                          "abbreviation": "asse",
                                          "recoveryServicesGeo": "sea",
                                          "timeDifference": "+8:00",
                                          "timeZone": "Singapore Standard Time"
                                        },
                                        "southindia": {
                                          "abbreviation": "ins",
                                          "recoveryServicesGeo": "ins",
                                          "timeDifference": "+5:30",
                                          "timeZone": "India Standard Time"
                                        },
                                        "swedencentral": {
                                          "abbreviation": "sec",
                                          "recoveryServicesGeo": "sdc",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "switzerlandnorth": {
                                          "abbreviation": "chn",
                                          "recoveryServicesGeo": "szn",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "switzerlandwest": {
                                          "abbreviation": "chw",
                                          "recoveryServicesGeo": "szw",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "uaecentral": {
                                          "abbreviation": "aec",
                                          "recoveryServicesGeo": "uac",
                                          "timeDifference": "+3:00",
                                          "timeZone": "Arabian Standard Time"
                                        },
                                        "uaenorth": {
                                          "abbreviation": "aen",
                                          "recoveryServicesGeo": "uan",
                                          "timeDifference": "+3:00",
                                          "timeZone": "Arabian Standard Time"
                                        },
                                        "uksouth": {
                                          "abbreviation": "uks",
                                          "recoveryServicesGeo": "uks",
                                          "timeDifference": "0:00",
                                          "timeZone": "GMT Standard Time"
                                        },
                                        "ukwest": {
                                          "abbreviation": "ukw",
                                          "recoveryServicesGeo": "ukw",
                                          "timeDifference": "0:00",
                                          "timeZone": "GMT Standard Time"
                                        },
                                        "westcentralus": {
                                          "abbreviation": "uswc",
                                          "recoveryServicesGeo": "wcus",
                                          "timeDifference": "-7:00",
                                          "timeZone": "Mountain Standard Time"
                                        },
                                        "westeurope": {
                                          "abbreviation": "euw",
                                          "recoveryServicesGeo": "we",
                                          "timeDifference": "+1:00",
                                          "timeZone": "Central Europe Standard Time"
                                        },
                                        "westindia": {
                                          "abbreviation": "inw",
                                          "recoveryServicesGeo": "inw",
                                          "timeDifference": "+5:30",
                                          "timeZone": "India Standard Time"
                                        },
                                        "westus": {
                                          "abbreviation": "usw",
                                          "recoveryServicesGeo": "wus",
                                          "timeDifference": "-8:00",
                                          "timeZone": "Pacific Standard Time"
                                        },
                                        "westus2": {
                                          "abbreviation": "usw2",
                                          "recoveryServicesGeo": "wus2",
                                          "timeDifference": "-8:00",
                                          "timeZone": "Pacific Standard Time"
                                        },
                                        "westus3": {
                                          "abbreviation": "usw3",
                                          "recoveryServicesGeo": "wus3",
                                          "timeDifference": "-7:00",
                                          "timeZone": "Mountain Standard Time"
                                        }
                                      },
                                      "AzureUSGovernment": {
                                        "usdodcentral": {
                                          "abbreviation": "dodc",
                                          "recoveryServicesGeo": "udc",
                                          "timeDifference": "-6:00",
                                          "timeZone": "Central Standard Time"
                                        },
                                        "usdodeast": {
                                          "abbreviation": "dode",
                                          "recoveryServicesGeo": "ude",
                                          "timeDifference": "-5:00",
                                          "timeZone": "Eastern Standard Time"
                                        },
                                        "usgovarizona": {
                                          "abbreviation": "az",
                                          "recoveryServicesGeo": "uga",
                                          "timeDifference": "-7:00",
                                          "timeZone": "Mountain Standard Time"
                                        },
                                        "usgovtexas": {
                                          "abbreviation": "tx",
                                          "recoveryServicesGeo": "ugt",
                                          "timeDifference": "-6:00",
                                          "timeZone": "Central Standard Time"
                                        },
                                        "usgovvirginia": {
                                          "abbreviation": "va",
                                          "recoveryServicesGeo": "ugv",
                                          "timeDifference": "-5:00",
                                          "timeZone": "Eastern Standard Time"
                                        }
                                      }
                                    },
                                    "$fxv#1": "1.0.0",
                                    "$fxv#2": {
                                      "actionGroups": "ag",
                                      "applicationGroups": "vdag",
                                      "applicationInsights": "appi",
                                      "appServicePlans": "asp",
                                      "automationAccounts": "aa",
                                      "availabilitySets": "avail",
                                      "azureFirewalls": "afw",
                                      "bastionHosts": "bas",
                                      "computeGallieries": "cg",
                                      "dataCollectionEndpoints": "dce",
                                      "dataCollectionRuleAssociations": "dcra",
                                      "dataCollectionRules": "dcr",
                                      "diagnosticSettings": "diag",
                                      "diskAccesses": "da",
                                      "diskEncryptionSets": "des",
                                      "disks": "disk",
                                      "firewallPolicies": "afwp",
                                      "applicationGateways": "agw",
                                      "applicationGatewayWafPolicies": "agwwafp",
                                      "functionApps": "func",
                                      "hostPools": "vdpool",
                                      "ipConfigurations": "ipconf",
                                      "keyVaults": "kv",
                                      "localNetworkGateways": "lgw",
                                      "logAnalyticsWorkspaces": "log",
                                      "natGateways": "ng",
                                      "netAppAccounts": "naa",
                                      "netAppAccountsCapacityPools": "cp",
                                      "networkInterfaces": "nic",
                                      "networkSecurityGroups": "nsg",
                                      "networkWatchers": "nw",
                                      "networkWatchersFlowLogs": "fl",
                                      "privateEndpoints": "pe",
                                      "privateLinkScopes": "pls",
                                      "publicIPAddresses": "pip",
                                      "publicIPPrefixes": "ippre",
                                      "recoveryServicesVaults": "rsv",
                                      "remoteApplicationGroups": "vdag",
                                      "resourceGroups": "rg",
                                      "routeTables": "rt",
                                      "scalingPlans": "vdscaling",
                                      "storageAccounts": "st",
                                      "subnets": "snet",
                                      "userAssignedIdentities": "id",
                                      "virtualMachines": "vm",
                                      "virtualNetworkGateways": "vgw",
                                      "virtualNetworks": "vnet",
                                      "workspaces": "vdws"
                                    },
                                    "directionShortNames": {
                                      "east": "e",
                                      "eastcentral": "ec",
                                      "north": "n",
                                      "northcentral": "nc",
                                      "south": "s",
                                      "southcentral": "sc",
                                      "west": "w",
                                      "westcentral": "wc"
                                    },
                                    "environmentName": {
                                      "dev": "Development",
                                      "prod": "Production",
                                      "test": "Test"
                                    },
                                    "locations": "[coalesce(tryGet(variables('$fxv#0'), environment().name), createObject(format('{0}', parameters('location')), createObject('abbreviation', variables('directionShortNames')[skip(parameters('location'), sub(length(parameters('location')), 4))], 'timeDifference', if(contains(parameters('location'), 'east'), '-5:00', if(contains(parameters('location'), 'west'), '-8:00', '0:00')), 'timeZone', if(contains(parameters('location'), 'east'), 'Eastern Standard Time', if(contains(parameters('location'), 'west'), 'Pacific Standard Time', 'GMT Standard Time')))))]",
                                    "mlzTags": {
                                      "environment": "[variables('environmentName')[parameters('environmentAbbreviation')]]",
                                      "identifier": "[parameters('identifier')]",
                                      "landingZoneName": "MissionLandingZone",
                                      "landingZoneVersion": "[variables('$fxv#1')]"
                                    },
                                    "resourceAbbreviations": "[variables('$fxv#2')]"
                                  },
                                  "resources": [
                                    {
                                      "copy": {
                                        "name": "namingConventions",
                                        "count": "[length(parameters('networks'))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('naming-convention-{0}-{1}', parameters('networks')[copyIndex()].shortName, parameters('deploymentNameSuffix'))]",
                                      "location": "[deployment().location]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "delimiter": {
                                            "value": "[parameters('delimiter')]"
                                          },
                                          "environmentAbbreviation": {
                                            "value": "[parameters('environmentAbbreviation')]"
                                          },
                                          "identifier": {
                                            "value": "[parameters('identifier')]"
                                          },
                                          "locationAbbreviation": {
                                            "value": "[variables('locations')[parameters('location')].abbreviation]"
                                          },
                                          "networkName": {
                                            "value": "[parameters('networks')[copyIndex()].name]"
                                          },
                                          "resourceAbbreviations": {
                                            "value": "[variables('resourceAbbreviations')]"
                                          },
                                          "stampIndex": {
                                            "value": "[parameters('stampIndex')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "6403027296801861578"
                                            }
                                          },
                                          "parameters": {
                                            "delimiter": {
                                              "type": "string",
                                              "allowedValues": [
                                                "",
                                                "-"
                                              ]
                                            },
                                            "environmentAbbreviation": {
                                              "type": "string"
                                            },
                                            "identifier": {
                                              "type": "string"
                                            },
                                            "locationAbbreviation": {
                                              "type": "string"
                                            },
                                            "networkName": {
                                              "type": "string"
                                            },
                                            "resourceAbbreviations": {
                                              "type": "object"
                                            },
                                            "stampIndex": {
                                              "type": "string",
                                              "defaultValue": ""
                                            }
                                          },
                                          "variables": {
                                            "tokens": {
                                              "purpose": "purpose_token",
                                              "resource": "resource_token",
                                              "service": "service_token"
                                            },
                                            "namingConvention": "[format('{0}{1}{2}{3}{4}{5}{6}{7}{8}{9}{10}{11}', toLower(parameters('identifier')), parameters('delimiter'), parameters('environmentAbbreviation'), parameters('delimiter'), parameters('locationAbbreviation'), parameters('delimiter'), parameters('networkName'), parameters('delimiter'), variables('tokens').resource, parameters('delimiter'), variables('tokens').purpose, if(empty(parameters('stampIndex')), '', format('{0}{1}', parameters('delimiter'), parameters('stampIndex'))))]",
                                            "namingConvention_Service": "[format('{0}{1}{2}{3}{4}{5}{6}{7}{8}{9}{10}{11}{12}{13}', toLower(parameters('identifier')), parameters('delimiter'), parameters('environmentAbbreviation'), parameters('delimiter'), parameters('locationAbbreviation'), parameters('delimiter'), parameters('networkName'), parameters('delimiter'), variables('tokens').service, parameters('delimiter'), variables('tokens').resource, parameters('delimiter'), variables('tokens').purpose, if(empty(parameters('stampIndex')), '', format('{0}{1}', parameters('delimiter'), parameters('stampIndex'))))]",
                                            "names": {
                                              "actionGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').actionGroups)]",
                                              "applicationGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationGroups)]",
                                              "applicationInsights": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationInsights)]",
                                              "appServicePlan": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').appServicePlans)]",
                                              "automationAccount": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').automationAccounts)]",
                                              "automationAccountDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').automationAccounts)]",
                                              "automationAccountNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').automationAccounts)]",
                                              "automationAccountPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').automationAccounts)]",
                                              "availabilitySet": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').availabilitySets)]",
                                              "azureFirewall": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').azureFirewalls)]",
                                              "azureFirewallPublicIPAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').azureFirewalls)]",
                                              "azureFirewallPublicIPAddressDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').publicIPAddresses, parameters('delimiter'), parameters('resourceAbbreviations').azureFirewalls))]",
                                              "azureFirewallDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').azureFirewalls)]",
                                              "azureFirewallPolicy": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').firewallPolicies)]",
                                              "applicationGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationGateways)]",
                                              "applicationGatewayPublicIPAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                                              "applicationGatewayDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                                              "applicationGatewayWafPolicy": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationGatewayWafPolicies)]",
                                              "applicationGatewayWafPolicyDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').applicationGatewayWafPolicies)]",
                                              "applicationGatewayRouteTable": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').routeTables), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                                              "applicationGatewayNetworkSecurityGroup": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkSecurityGroups), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                                              "bastionHost": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').bastionHosts)]",
                                              "bastionHostDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').bastionHosts)]",
                                              "bastionHostNetworkSecurityGroup": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkSecurityGroups), variables('tokens').service, parameters('resourceAbbreviations').bastionHosts)]",
                                              "bastionHostNetworkSecurityGroupDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').networkSecurityGroups, parameters('delimiter'), parameters('resourceAbbreviations').bastionHosts))]",
                                              "bastionHostPublicIPAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').bastionHosts)]",
                                              "bastionHostPublicIPAddressDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').publicIPAddresses, parameters('delimiter'), parameters('resourceAbbreviations').bastionHosts))]",
                                              "computeGallery": "[replace(replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').computeGallieries), parameters('delimiter'), if(empty(parameters('delimiter')), '', '_'))]",
                                              "dataCollectionEndpoint": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').dataCollectionEndpoints)]",
                                              "dataCollectionRuleAssociation": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').dataCollectionRuleAssociations)]",
                                              "dataCollectionRule": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').dataCollectionRules)]",
                                              "diskAccess": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').diskAccesses)]",
                                              "diskAccessNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').diskAccesses)]",
                                              "diskAccessPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').diskAccesses)]",
                                              "diskEncryptionSet": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').diskEncryptionSets)]",
                                              "functionApp": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').functionApps)]",
                                              "functionAppNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').functionApps)]",
                                              "functionAppPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').functionApps)]",
                                              "hostPool": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').hostPools)]",
                                              "hostPoolDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').hostPools)]",
                                              "hostPoolNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').hostPools)]",
                                              "hostPoolPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').hostPools)]",
                                              "keyVault": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').keyVaults)]",
                                              "keyVaultDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').keyVaults)]",
                                              "keyVaultNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').keyVaults)]",
                                              "keyVaultPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').keyVaults)]",
                                              "localNetworkGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').localNetworkGateways)]",
                                              "logAnalyticsWorkspace": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').logAnalyticsWorkspaces)]",
                                              "logAnalyticsWorkspaceDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').logAnalyticsWorkspaces)]",
                                              "natGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').natGateways)]",
                                              "natGatewayPublicIPPrefix": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPPrefixes), variables('tokens').service, parameters('resourceAbbreviations').natGateways)]",
                                              "netAppAccount": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').netAppAccounts)]",
                                              "netAppAccountCapacityPool": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').netAppAccountsCapacityPools), variables('tokens').service, parameters('resourceAbbreviations').netAppAccounts)]",
                                              "netAppAccountSmbServer": "[replace(replace(replace(replace(variables('namingConvention'), variables('tokens').resource, ''), parameters('environmentAbbreviation'), first(parameters('environmentAbbreviation'))), parameters('networkName'), ''), parameters('delimiter'), '')]",
                                              "networkSecurityGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').networkSecurityGroups)]",
                                              "networkSecurityGroupDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').networkSecurityGroups)]",
                                              "networkWatcherFlowLogsNetworkSecurityGroup": "[replace(variables('namingConvention'), variables('tokens').resource, format('{0}{1}{2}{3}{4}', parameters('resourceAbbreviations').networkWatchers, parameters('delimiter'), parameters('resourceAbbreviations').networkWatchersFlowLogs, parameters('delimiter'), parameters('resourceAbbreviations').networkSecurityGroups))]",
                                              "networkWatcherFlowLogsVirtualNetwork": "[replace(variables('namingConvention'), variables('tokens').resource, format('{0}{1}{2}{3}{4}', parameters('resourceAbbreviations').networkWatchers, parameters('delimiter'), parameters('resourceAbbreviations').networkWatchersFlowLogs, parameters('delimiter'), parameters('resourceAbbreviations').virtualNetworks))]",
                                              "privateLinkScope": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').privateLinkScopes)]",
                                              "privateLinkScopeNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').privateLinkScopes)]",
                                              "privateLinkScopePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').privateLinkScopes)]",
                                              "recoveryServicesVault": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').recoveryServicesVaults)]",
                                              "recoveryServicesVaultNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').recoveryServicesVaults)]",
                                              "recoveryServicesVaultPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').recoveryServicesVaults)]",
                                              "resourceGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').resourceGroups)]",
                                              "routeTable": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').routeTables)]",
                                              "scalingPlan": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').scalingPlans)]",
                                              "scalingPlanDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').scalingPlans)]",
                                              "storageAccount": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').storageAccounts)]",
                                              "storageAccountBlobDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}blob', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountBlobNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}blob', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountBlobPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}blob', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').storageAccounts)]",
                                              "storageAccountFileDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}file', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountFileNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}file', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountFilePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}file', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountQueueDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}queue', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountQueueNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}queue', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountQueuePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}queue', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountTableDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}table', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountTableNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}table', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "storageAccountTablePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}table', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                                              "subnet": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').subnets)]",
                                              "userAssignedIdentity": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').userAssignedIdentities)]",
                                              "virtualMachine": "[replace(replace(replace(replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').virtualMachines), parameters('environmentAbbreviation'), first(parameters('environmentAbbreviation'))), parameters('networkName'), ''), parameters('delimiter'), '')]",
                                              "virtualMachineDisk": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').disks), variables('tokens').service, format('{0}', parameters('resourceAbbreviations').virtualMachines))]",
                                              "virtualMachineNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').virtualMachines)]",
                                              "virtualMachineNetworkInterfaceDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').networkInterfaces, parameters('delimiter'), parameters('resourceAbbreviations').virtualMachines))]",
                                              "virtualNetwork": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').virtualNetworks)]",
                                              "virtualNetworkDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').virtualNetworks)]",
                                              "virtualNetworkGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').virtualNetworkGateways)]",
                                              "virtualNetworkGatewayPublicIpAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').virtualNetworkGateways)]",
                                              "workspace": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').workspaces)]",
                                              "workspaceDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').workspaces)]",
                                              "workspaceNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').workspaces)]",
                                              "workspacePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').workspaces)]"
                                            }
                                          },
                                          "resources": [],
                                          "outputs": {
                                            "delimiter": {
                                              "type": "string",
                                              "value": "[parameters('delimiter')]"
                                            },
                                            "names": {
                                              "type": "object",
                                              "value": "[variables('names')]"
                                            },
                                            "tokens": {
                                              "type": "object",
                                              "value": "[variables('tokens')]"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('private-dns-zones-{0}', parameters('deploymentNameSuffix'))]",
                                      "location": "[deployment().location]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {},
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "3047584333563107444"
                                            }
                                          },
                                          "variables": {
                                            "cloudSuffix": "[replace(replace(environment().resourceManager, 'https://management.azure.', ''), '/', '')]",
                                            "privateDnsZoneNames": "[union(createArray(format('privatelink.agentsvc.azure-automation.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureAutomation, environment().name), format('opinsights.azure.{0}', variables('cloudSuffix')))), format('privatelink.azure-automation.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureAutomation, environment().name), variables('cloudSuffix'))), format('privatelink.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureWebSites, environment().name), format('appservice.{0}', variables('cloudSuffix')))), format('scm.privatelink.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureWebSites, environment().name), format('appservice.{0}', variables('cloudSuffix')))), format('privatelink.wvd.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureVirtualDesktop, environment().name), variables('cloudSuffix'))), format('privatelink-global.wvd.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureVirtualDesktop, environment().name), variables('cloudSuffix'))), format('privatelink.file.{0}', environment().suffixes.storage), format('privatelink.queue.{0}', environment().suffixes.storage), format('privatelink.table.{0}', environment().suffixes.storage), format('privatelink.blob.{0}', environment().suffixes.storage), format('privatelink{0}', replace(environment().suffixes.keyvaultDns, 'vault', 'vaultcore')), format('privatelink.monitor.azure.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureMonitor, environment().name), variables('cloudSuffix'))), format('privatelink.ods.opinsights.azure.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureMonitor, environment().name), variables('cloudSuffix'))), format('privatelink.oms.opinsights.azure.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureMonitor, environment().name), variables('cloudSuffix'))), format('privatelink{0}', environment().suffixes.sqlServerHostname)), createArray())]",
                                            "privateDnsZoneSuffixes": {
                                              "azureAutomation": {
                                                "AzureCloud": "net",
                                                "AzureUSGovernment": "us"
                                              },
                                              "azureBackup": {
                                                "AzureCloud": "com",
                                                "AzureUSGovernment": "us"
                                              },
                                              "azureMonitor": {
                                                "AzureCloud": "com",
                                                "AzureUSGovernment": "us"
                                              },
                                              "azureVirtualDesktop": {
                                                "AzureCloud": "microsoft.com",
                                                "AzureUSGovernment": "azure.us"
                                              },
                                              "azureWebSites": {
                                                "AzureCloud": "azurewebsites.net",
                                                "AzureUSGovernment": "azurewebsites.us"
                                              }
                                            }
                                          },
                                          "resources": [],
                                          "outputs": {
                                            "names": {
                                              "type": "array",
                                              "value": "[variables('privateDnsZoneNames')]"
                                            }
                                          }
                                        }
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "delimiter": {
                                      "type": "string",
                                      "value": "[parameters('delimiter')]"
                                    },
                                    "locationProperties": {
                                      "type": "object",
                                      "value": "[variables('locations')[parameters('location')]]"
                                    },
                                    "mlzTags": {
                                      "type": "object",
                                      "value": "[variables('mlzTags')]"
                                    },
                                    "privateDnsZones": {
                                      "type": "array",
                                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value]"
                                    },
                                    "resourceAbbreviations": {
                                      "type": "object",
                                      "value": "[variables('resourceAbbreviations')]"
                                    },
                                    "tiers": {
                                      "type": "array",
                                      "copy": {
                                        "count": "[length(parameters('networks'))]",
                                        "input": {
                                          "name": "[parameters('networks')[copyIndex()].name]",
                                          "namingConvention": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('naming-convention-{0}-{1}', parameters('networks')[copyIndex()].shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value]",
                                          "nsgDiagLogs": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'nsgDiagLogs'), createArray())]",
                                          "nsgRules": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'nsgRules'), createArray())]",
                                          "shortName": "[parameters('networks')[copyIndex()].shortName]",
                                          "subnetAddressPrefix": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'subnetAddressPrefix'), '')]",
                                          "subscriptionId": "[parameters('networks')[copyIndex()].subscriptionId]",
                                          "vnetAddressPrefix": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'vnetAddressPrefix'), '')]",
                                          "vnetDiagLogs": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'vnetDiagLogs'), createArray())]",
                                          "vnetDiagMetrics": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'vnetDiagMetrics'), createArray())]"
                                        }
                                      }
                                    },
                                    "tokens": {
                                      "type": "object",
                                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('naming-convention-{0}-{1}', parameters('networks')[0].shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-rg-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "name": {
                                    "value": "[replace(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value[0].namingConvention.resourceGroup, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value.purpose, 'network')]"
                                  },
                                  "tags": {
                                    "value": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Resources/resourceGroups'), createObject()), reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value)]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "29921048879103880"
                                    }
                                  },
                                  "parameters": {
                                    "name": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object",
                                      "defaultValue": {}
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Resources/resourceGroups",
                                      "apiVersion": "2019-05-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]"
                                    }
                                  ],
                                  "outputs": {
                                    "id": {
                                      "type": "string",
                                      "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
                                    },
                                    "name": {
                                      "type": "string",
                                      "value": "[parameters('name')]"
                                    },
                                    "location": {
                                      "type": "string",
                                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').location]"
                                    },
                                    "tags": {
                                      "type": "object",
                                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').tags]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix')))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "additionalSubnets": {
                                    "value": "[parameters('additionalSubnets')]"
                                  },
                                  "customSubnetName": {
                                    "value": "[parameters('subnetName')]"
                                  },
                                  "delimiter": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                                  },
                                  "resourceGroupName": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                                  },
                                  "routeTableRouteNextHopIpAddress": {
                                    "value": "[parameters('routeTableRouteNextHopIpAddress')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  },
                                  "tier": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value[0]]"
                                  },
                                  "tokens": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                                  },
                                  "vNetDnsServers": {
                                    "value": "[parameters('vNetDnsServers')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "4292077791685791333"
                                    }
                                  },
                                  "parameters": {
                                    "additionalSubnets": {
                                      "type": "array",
                                      "defaultValue": []
                                    },
                                    "delimiter": {
                                      "type": "string"
                                    },
                                    "customSubnetName": {
                                      "type": "string",
                                      "defaultValue": ""
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "resourceGroupName": {
                                      "type": "string"
                                    },
                                    "routeTableRouteNextHopIpAddress": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object"
                                    },
                                    "tier": {
                                      "type": "object"
                                    },
                                    "tokens": {
                                      "type": "object"
                                    },
                                    "vNetDnsServers": {
                                      "type": "array"
                                    }
                                  },
                                  "variables": {
                                    "delegations": {
                                      "azure-netapp-files": [
                                        {
                                          "name": "Microsoft.Netapp.volumes",
                                          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/delegations', variables('virtualNetworkName'), 'azure-netapp-files', 'delegation')]",
                                          "properties": {
                                            "serviceName": "Microsoft.Netapp/volumes"
                                          },
                                          "type": "Microsoft.Network/virtualNetworks/subnets/delegations"
                                        }
                                      ],
                                      "function-app-outbound": [
                                        {
                                          "name": "Microsoft.Web/sites",
                                          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/delegations', variables('virtualNetworkName'), 'function-app-outbound', 'delegation')]",
                                          "properties": {
                                            "serviceName": "Microsoft.Web/serverfarms"
                                          },
                                          "type": "Microsoft.Network/virtualNetworks/subnets/delegations"
                                        }
                                      ]
                                    },
                                    "subnets": "[union(createArray(createObject('name', if(empty(parameters('customSubnetName')), replace(parameters('tier').namingConvention.subnet, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''), parameters('customSubnetName')), 'properties', createObject('addressPrefix', parameters('tier').subnetAddressPrefix))), parameters('additionalSubnets'))]",
                                    "subscriptionId": "[parameters('tier').subscriptionId]",
                                    "virtualNetworkName": "[replace(parameters('tier').namingConvention.virtualNetwork, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "networkSecurityGroup",
                                      "subscriptionId": "[variables('subscriptionId')]",
                                      "resourceGroup": "[parameters('resourceGroupName')]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "location": {
                                            "value": "[parameters('location')]"
                                          },
                                          "mlzTags": {
                                            "value": "[parameters('mlzTags')]"
                                          },
                                          "name": {
                                            "value": "[replace(parameters('tier').namingConvention.networkSecurityGroup, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                          },
                                          "securityRules": {
                                            "value": "[parameters('tier').nsgRules]"
                                          },
                                          "tags": {
                                            "value": "[parameters('tags')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "13291183460695095968"
                                            }
                                          },
                                          "parameters": {
                                            "location": {
                                              "type": "string"
                                            },
                                            "mlzTags": {
                                              "type": "object"
                                            },
                                            "name": {
                                              "type": "string"
                                            },
                                            "securityRules": {
                                              "type": "array"
                                            },
                                            "tags": {
                                              "type": "object"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/networkSecurityGroups",
                                              "apiVersion": "2021-02-01",
                                              "name": "[parameters('name')]",
                                              "location": "[parameters('location')]",
                                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkSecurityGroups'), createObject()), parameters('mlzTags'))]",
                                              "properties": {
                                                "securityRules": "[parameters('securityRules')]"
                                              }
                                            }
                                          ],
                                          "outputs": {
                                            "id": {
                                              "type": "string",
                                              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                                            },
                                            "name": {
                                              "type": "string",
                                              "value": "[parameters('name')]"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "routeTable",
                                      "subscriptionId": "[variables('subscriptionId')]",
                                      "resourceGroup": "[parameters('resourceGroupName')]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "disableBgpRoutePropagation": {
                                            "value": true
                                          },
                                          "location": {
                                            "value": "[parameters('location')]"
                                          },
                                          "mlzTags": {
                                            "value": "[parameters('mlzTags')]"
                                          },
                                          "name": {
                                            "value": "[replace(parameters('tier').namingConvention.routeTable, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                          },
                                          "routeNextHopIpAddress": {
                                            "value": "[parameters('routeTableRouteNextHopIpAddress')]"
                                          },
                                          "tags": {
                                            "value": "[parameters('tags')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "2680791520041812197"
                                            }
                                          },
                                          "parameters": {
                                            "disableBgpRoutePropagation": {
                                              "type": "bool"
                                            },
                                            "location": {
                                              "type": "string"
                                            },
                                            "mlzTags": {
                                              "type": "object"
                                            },
                                            "name": {
                                              "type": "string"
                                            },
                                            "routeAddressPrefix": {
                                              "type": "string",
                                              "defaultValue": "0.0.0.0/0"
                                            },
                                            "routeName": {
                                              "type": "string",
                                              "defaultValue": "default_route"
                                            },
                                            "routeNextHopIpAddress": {
                                              "type": "string"
                                            },
                                            "routeNextHopType": {
                                              "type": "string",
                                              "defaultValue": "VirtualAppliance"
                                            },
                                            "tags": {
                                              "type": "object"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/routeTables",
                                              "apiVersion": "2021-02-01",
                                              "name": "[parameters('name')]",
                                              "location": "[parameters('location')]",
                                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/routeTables'), createObject()), parameters('mlzTags'))]",
                                              "properties": {
                                                "disableBgpRoutePropagation": "[parameters('disableBgpRoutePropagation')]",
                                                "routes": [
                                                  {
                                                    "name": "[parameters('routeName')]",
                                                    "properties": {
                                                      "addressPrefix": "[parameters('routeAddressPrefix')]",
                                                      "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                                                      "nextHopType": "[parameters('routeNextHopType')]"
                                                    }
                                                  }
                                                ]
                                              }
                                            }
                                          ],
                                          "outputs": {
                                            "id": {
                                              "type": "string",
                                              "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                                            },
                                            "name": {
                                              "type": "string",
                                              "value": "[parameters('name')]"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "virtualNetwork",
                                      "subscriptionId": "[variables('subscriptionId')]",
                                      "resourceGroup": "[parameters('resourceGroupName')]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "addressPrefix": {
                                            "value": "[parameters('tier').vnetAddressPrefix]"
                                          },
                                          "location": {
                                            "value": "[parameters('location')]"
                                          },
                                          "mlzTags": {
                                            "value": "[parameters('mlzTags')]"
                                          },
                                          "name": {
                                            "value": "[variables('virtualNetworkName')]"
                                          },
                                          "subnets": {
                                            "copy": [
                                              {
                                                "name": "value",
                                                "count": "[length(variables('subnets'))]",
                                                "input": "[createObject('name', variables('subnets')[copyIndex('value')].name, 'properties', createObject('addressPrefix', variables('subnets')[copyIndex('value')].properties.addressPrefix, 'defaultOutboundAccess', false(), 'delegations', coalesce(tryGet(variables('delegations'), variables('subnets')[copyIndex('value')].name), createArray()), 'networkSecurityGroup', createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup'), '2025-04-01').outputs.id.value), 'routeTable', createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'routeTable'), '2025-04-01').outputs.id.value), 'privateEndpointNetworkPolicies', 'Disabled', 'privateLinkServiceNetworkPolicies', 'Disabled'))]"
                                              }
                                            ]
                                          },
                                          "tags": {
                                            "value": "[parameters('tags')]"
                                          },
                                          "vNetDnsServers": {
                                            "value": "[parameters('vNetDnsServers')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "15576417548653840691"
                                            }
                                          },
                                          "parameters": {
                                            "addressPrefix": {
                                              "type": "string"
                                            },
                                            "location": {
                                              "type": "string"
                                            },
                                            "mlzTags": {
                                              "type": "object"
                                            },
                                            "name": {
                                              "type": "string"
                                            },
                                            "subnets": {
                                              "type": "array"
                                            },
                                            "tags": {
                                              "type": "object"
                                            },
                                            "vNetDnsServers": {
                                              "type": "array"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/virtualNetworks",
                                              "apiVersion": "2023-11-01",
                                              "name": "[parameters('name')]",
                                              "location": "[parameters('location')]",
                                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/virtualNetworks'), createObject()), parameters('mlzTags'))]",
                                              "properties": {
                                                "addressSpace": {
                                                  "addressPrefixes": [
                                                    "[parameters('addressPrefix')]"
                                                  ]
                                                },
                                                "subnets": "[parameters('subnets')]",
                                                "dhcpOptions": "[if(empty(parameters('vNetDnsServers')), null(), createObject('dnsServers', parameters('vNetDnsServers')))]"
                                              }
                                            }
                                          ],
                                          "outputs": {
                                            "addressPrefix": {
                                              "type": "string",
                                              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2023-11-01').addressSpace.addressPrefixes[0]]"
                                            },
                                            "dnsServers": {
                                              "type": "array",
                                              "value": "[parameters('vNetDnsServers')]"
                                            },
                                            "id": {
                                              "type": "string",
                                              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                                            },
                                            "name": {
                                              "type": "string",
                                              "value": "[parameters('name')]"
                                            },
                                            "subnets": {
                                              "type": "array",
                                              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2023-11-01').subnets]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup')]",
                                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'routeTable')]"
                                      ]
                                    }
                                  ],
                                  "outputs": {
                                    "networkSecurityGroupName": {
                                      "type": "string",
                                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup'), '2025-04-01').outputs.name.value]"
                                    },
                                    "networkSecurityGroupResourceId": {
                                      "type": "string",
                                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup'), '2025-04-01').outputs.id.value]"
                                    },
                                    "subnets": {
                                      "type": "array",
                                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.subnets.value]"
                                    },
                                    "virtualNetworkAddressPrefix": {
                                      "type": "string",
                                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.addressPrefix.value]"
                                    },
                                    "virtualNetworkName": {
                                      "type": "string",
                                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.name.value]"
                                    },
                                    "virtualNetworkResourceId": {
                                      "type": "string",
                                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.id.value]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix')))]",
                                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix')))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-spoke-peering-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "deploymentNameSuffix": {
                                    "value": "[parameters('deploymentNameSuffix')]"
                                  },
                                  "hubVirtualNetworkResourceId": {
                                    "value": "[parameters('hubVirtualNetworkResourceId')]"
                                  },
                                  "resourceGroupName": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                                  },
                                  "spokeShortName": {
                                    "value": "[parameters('network').shortName]"
                                  },
                                  "spokeVirtualNetworkName": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkName.value]"
                                  },
                                  "subscriptionId": {
                                    "value": "[parameters('network').subscriptionId]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "9423483428741617452"
                                    }
                                  },
                                  "parameters": {
                                    "deploymentNameSuffix": {
                                      "type": "string"
                                    },
                                    "hubVirtualNetworkResourceId": {
                                      "type": "string"
                                    },
                                    "resourceGroupName": {
                                      "type": "string"
                                    },
                                    "spokeShortName": {
                                      "type": "string"
                                    },
                                    "spokeVirtualNetworkName": {
                                      "type": "string"
                                    },
                                    "subscriptionId": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('peer-{0}-to-hub-{1}', parameters('spokeShortName'), parameters('deploymentNameSuffix'))]",
                                      "subscriptionId": "[parameters('subscriptionId')]",
                                      "resourceGroup": "[parameters('resourceGroupName')]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "remoteVirtualNetworkResourceId": {
                                            "value": "[parameters('hubVirtualNetworkResourceId')]"
                                          },
                                          "virtualNetworkName": {
                                            "value": "[parameters('spokeVirtualNetworkName')]"
                                          },
                                          "virtualNetworkPeerName": {
                                            "value": "[format('to-{0}', split(parameters('hubVirtualNetworkResourceId'), '/')[8])]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "5018776708400490249"
                                            }
                                          },
                                          "parameters": {
                                            "remoteVirtualNetworkResourceId": {
                                              "type": "string"
                                            },
                                            "virtualNetworkName": {
                                              "type": "string"
                                            },
                                            "virtualNetworkPeerName": {
                                              "type": "string"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                                              "apiVersion": "2021-02-01",
                                              "name": "[format('{0}/{1}', parameters('virtualNetworkName'), parameters('virtualNetworkPeerName'))]",
                                              "properties": {
                                                "allowForwardedTraffic": true,
                                                "remoteVirtualNetwork": {
                                                  "id": "[parameters('remoteVirtualNetworkResourceId')]"
                                                }
                                              }
                                            }
                                          ]
                                        }
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix')))]",
                                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix')))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-hub-peering-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "deploymentNameSuffix": {
                                    "value": "[parameters('deploymentNameSuffix')]"
                                  },
                                  "hubVirtualNetworkName": {
                                    "value": "[split(parameters('hubVirtualNetworkResourceId'), '/')[8]]"
                                  },
                                  "resourceGroupName": {
                                    "value": "[split(parameters('hubVirtualNetworkResourceId'), '/')[4]]"
                                  },
                                  "spokeShortName": {
                                    "value": "[parameters('network').shortName]"
                                  },
                                  "spokeVirtualNetworkResourceId": {
                                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkResourceId.value]"
                                  },
                                  "subscriptionId": {
                                    "value": "[split(parameters('hubVirtualNetworkResourceId'), '/')[2]]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "9009517396459708892"
                                    }
                                  },
                                  "parameters": {
                                    "deploymentNameSuffix": {
                                      "type": "string"
                                    },
                                    "hubVirtualNetworkName": {
                                      "type": "string"
                                    },
                                    "resourceGroupName": {
                                      "type": "string"
                                    },
                                    "spokeShortName": {
                                      "type": "string"
                                    },
                                    "spokeVirtualNetworkResourceId": {
                                      "type": "string"
                                    },
                                    "subscriptionId": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('peer-hub-to-{0}-{1}', parameters('spokeShortName'), parameters('deploymentNameSuffix'))]",
                                      "subscriptionId": "[parameters('subscriptionId')]",
                                      "resourceGroup": "[parameters('resourceGroupName')]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "remoteVirtualNetworkResourceId": {
                                            "value": "[parameters('spokeVirtualNetworkResourceId')]"
                                          },
                                          "virtualNetworkName": {
                                            "value": "[parameters('hubVirtualNetworkName')]"
                                          },
                                          "virtualNetworkPeerName": {
                                            "value": "[format('to-{0}', split(parameters('spokeVirtualNetworkResourceId'), '/')[8])]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "5018776708400490249"
                                            }
                                          },
                                          "parameters": {
                                            "remoteVirtualNetworkResourceId": {
                                              "type": "string"
                                            },
                                            "virtualNetworkName": {
                                              "type": "string"
                                            },
                                            "virtualNetworkPeerName": {
                                              "type": "string"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                                              "apiVersion": "2021-02-01",
                                              "name": "[format('{0}/{1}', parameters('virtualNetworkName'), parameters('virtualNetworkPeerName'))]",
                                              "properties": {
                                                "allowForwardedTraffic": true,
                                                "remoteVirtualNetwork": {
                                                  "id": "[parameters('remoteVirtualNetworkResourceId')]"
                                                }
                                              }
                                            }
                                          ]
                                        }
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix')))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "delimiter": {
                              "type": "string",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                            },
                            "locationProperties": {
                              "type": "object",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.locationProperties.value]"
                            },
                            "mlzTags": {
                              "type": "object",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                            },
                            "privateDnsZones": {
                              "type": "array",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZones.value]"
                            },
                            "resourceAbbreviations": {
                              "type": "object",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
                            },
                            "tier": {
                              "type": "object",
                              "value": {
                                "name": "[parameters('network').name]",
                                "namingConvention": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value[0].namingConvention]",
                                "networkSecurityGroupResourceId": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkSecurityGroupResourceId.value]",
                                "resourceGroupName": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]",
                                "shortName": "[parameters('network').shortName]",
                                "subnetResourceId": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[0].id]",
                                "subnets": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value]",
                                "subscriptionId": "[parameters('network').subscriptionId]"
                              }
                            },
                            "tokens": {
                              "type": "object",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}-{1}{2}', parameters('network').shortName, parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                            },
                            "virtualNetworkName": {
                              "type": "string",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-spoke-{0}-{1}', parameters('network').shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkName.value]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-storage-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "blobsPrivateDnsZoneResourceId": {
                            "value": "[resourceId(variables('hubSubscriptionId'), variables('hubResourceGroupName'), 'Microsoft.Network/privateDnsZones', format('privatelink.blob.{0}', environment().suffixes.storage))]"
                          },
                          "delimiter": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                          },
                          "deploymentIndex": {
                            "value": "[variables('deploymentIndex')]"
                          },
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "environmentAbbreviation": {
                            "value": "[parameters('environmentAbbreviation')]"
                          },
                          "filesPrivateDnsZoneResourceId": {
                            "value": "[resourceId(variables('hubSubscriptionId'), variables('hubResourceGroupName'), 'Microsoft.Network/privateDnsZones', format('privatelink.file.{0}', environment().suffixes.storage))]"
                          },
                          "hubResourceGroupName": {
                            "value": "[variables('hubResourceGroupName')]"
                          },
                          "hubSubscriptionId": {
                            "value": "[variables('hubSubscriptionId')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "logStorageSkuName": {
                            "value": "[parameters('logStorageSkuName')]"
                          },
                          "mlzTags": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                          },
                          "queuesPrivateDnsZoneResourceId": {
                            "value": "[resourceId(variables('hubSubscriptionId'), variables('hubResourceGroupName'), 'Microsoft.Network/privateDnsZones', format('privatelink.queue.{0}', environment().suffixes.storage))]"
                          },
                          "resourceAbbreviations": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
                          },
                          "resourceGroupName": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.resourceGroupName]"
                          },
                          "subnetResourceId": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.subnetResourceId]"
                          },
                          "tablesPrivateDnsZoneResourceId": {
                            "value": "[resourceId(variables('hubSubscriptionId'), variables('hubResourceGroupName'), 'Microsoft.Network/privateDnsZones', format('privatelink.table.{0}', environment().suffixes.storage))]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "tier": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value]"
                          },
                          "tokens": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                          },
                          "workloadShortName": {
                            "value": "[parameters('workloadShortName')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "12262094167167387996"
                            }
                          },
                          "parameters": {
                            "blobsPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "delimiter": {
                              "type": "string"
                            },
                            "deploymentIndex": {
                              "type": "string"
                            },
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "environmentAbbreviation": {
                              "type": "string"
                            },
                            "filesPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "hubSubscriptionId": {
                              "type": "string"
                            },
                            "hubResourceGroupName": {
                              "type": "string"
                            },
                            "logStorageSkuName": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "queuesPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "resourceAbbreviations": {
                              "type": "object"
                            },
                            "resourceGroupName": {
                              "type": "string"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tablesPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "tier": {
                              "type": "object"
                            },
                            "tokens": {
                              "type": "object"
                            },
                            "workloadShortName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tier').subscriptionId]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "deploymentNameSuffix": {
                                    "value": "[parameters('deploymentNameSuffix')]"
                                  },
                                  "environmentAbbreviation": {
                                    "value": "[parameters('environmentAbbreviation')]"
                                  },
                                  "keyName": {
                                    "value": "StorageEncryptionKey"
                                  },
                                  "keyVaultPrivateDnsZoneResourceId": {
                                    "value": "[resourceId(parameters('hubSubscriptionId'), parameters('hubResourceGroupName'), 'Microsoft.Network/privateDnsZones', replace(format('privatelink{0}', environment().suffixes.keyvaultDns), 'vault', 'vaultcore'))]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "resourceAbbreviations": {
                                    "value": "[parameters('resourceAbbreviations')]"
                                  },
                                  "subnetResourceId": {
                                    "value": "[parameters('subnetResourceId')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  },
                                  "tier": {
                                    "value": "[parameters('tier')]"
                                  },
                                  "tokens": {
                                    "value": "[parameters('tokens')]"
                                  },
                                  "type": {
                                    "value": "storageAccount"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "16154764937040063236"
                                    }
                                  },
                                  "parameters": {
                                    "deploymentNameSuffix": {
                                      "type": "string"
                                    },
                                    "environmentAbbreviation": {
                                      "type": "string"
                                    },
                                    "keyExpirationInDays": {
                                      "type": "int",
                                      "defaultValue": 30
                                    },
                                    "keyName": {
                                      "type": "string"
                                    },
                                    "keyVaultPrivateDnsZoneResourceId": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "resourceAbbreviations": {
                                      "type": "object"
                                    },
                                    "subnetResourceId": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object"
                                    },
                                    "tier": {
                                      "type": "object"
                                    },
                                    "tokens": {
                                      "type": "object"
                                    },
                                    "type": {
                                      "type": "string",
                                      "allowedValues": [
                                        "storageAccount",
                                        "virtualMachine"
                                      ]
                                    },
                                    "virtualMachineAdminPassword": {
                                      "type": "securestring",
                                      "defaultValue": "[newGuid()]"
                                    },
                                    "virtualMachineAdminUsername": {
                                      "type": "string",
                                      "defaultValue": "xadmin"
                                    },
                                    "virtualMachineSize": {
                                      "type": "string",
                                      "defaultValue": "Standard_D2ds_v4"
                                    }
                                  },
                                  "variables": {
                                    "$fxv#0": "Param(\r\n    [string]$DiskEncryptionSetName,\r\n    [int]$KeyExpirationInDays,\r\n    [string]$KeyName,\r\n    [string]$KeyVaultResourceId,\r\n    [string]$KeyVaultServiceUri,\r\n    [string]$KeyVaultUri,\r\n    [string]$Location,\r\n    [string]$ResourceGroupName,\r\n    [string]$ResourceManagerUri,\r\n    [string]$SubscriptionId,\r\n    [string]$Type,\r\n    [string]$UserAssignedIdentityClientId\r\n)\r\n\r\n$ErrorActionPreference = 'Stop'\r\n$WarningPreference = 'SilentlyContinue'\r\n\r\n# Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n$ResourceManagerUriFixed = if ($ResourceManagerUri[-1] -eq '/') { $ResourceManagerUri.Substring(0, $ResourceManagerUri.Length - 1) } else { $ResourceManagerUri }\r\n\r\n# Get an access token for Azure resources\r\n$KeyVaultAccessToken = (Invoke-RestMethod `\r\n        -Headers @{Metadata = \"true\" } `\r\n        -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $KeyVaultServiceUri + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n# Set header for Azure Management API\r\n$KeyVaultHeaders = @{\r\n    'Content-Type'  = 'application/json'\r\n    'Authorization' = 'Bearer ' + $KeyVaultAccessToken\r\n}\r\n\r\n$Body = [PSCustomObject]@{\r\n    kty            = 'RSA-HSM'\r\n    key_size       = 4096\r\n    attributes     = @{\r\n        enabled = $true\r\n    }\r\n    rotationPolicy = @{\r\n        attributes      = @{\r\n            expiryTime = $('P' + $KeyExpirationInDays + 'D')\r\n        }\r\n        lifetimeActions = @(\r\n            @{\r\n                action  = @{\r\n                    type = 'Notify'\r\n                }\r\n                trigger = @{\r\n                    timeBeforeExpiry = 'P10D'\r\n                }\r\n            },\r\n            @{\r\n                action  = @{\r\n                    type = 'Rotate'\r\n                }\r\n                trigger = @{\r\n                    timeAfterCreate = $('P' + ($KeyExpirationInDays - 7) + 'D')\r\n                }\r\n            }\r\n        )\r\n    }\r\n}\r\n\r\n# Create key vault key\r\n$KeyUriWithVersion = (Invoke-RestMethod `\r\n        -Body ($Body | ConvertTo-Json -Depth 4) `\r\n        -Headers $KeyVaultHeaders `\r\n        -Method 'POST' `\r\n        -Uri $($KeyVaultUri + 'keys/' + $KeyName + '/create?api-version=2025-07-01')).key.kid\r\n\r\nif ($Type -eq 'virtualMachine') {\r\n\r\n    # Get an access token for Azure resources\r\n    $ResourceManagerAccessToken = (Invoke-RestMethod `\r\n            -Headers @{Metadata = \"true\" } `\r\n            -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n    # Set header for Azure Management API\r\n    $ResourceManagerHeaders = @{\r\n        'Content-Type'  = 'application/json'\r\n        'Authorization' = 'Bearer ' + $ResourceManagerAccessToken\r\n    }\r\n\r\n    $DiskEncryptionSetBody = @{\r\n        location   = $Location\r\n        identity   = @{\r\n            type = 'SystemAssigned'\r\n        }\r\n        properties = @{\r\n            activeKey                         = @{\r\n                sourceVault = @{\r\n                    id = $KeyVaultResourceId\r\n                }\r\n                keyUrl = $KeyUriWithVersion\r\n            }\r\n            encryptionType                    = 'EncryptionAtRestWithPlatformAndCustomerKeys'\r\n            rotationToLatestKeyVersionEnabled = $true\r\n        }\r\n    }\r\n\r\n    Invoke-RestMethod `\r\n        -Body ($DiskEncryptionSetBody | ConvertTo-Json -Depth 4) `\r\n        -Headers $ResourceManagerHeaders `\r\n        -Method 'PUT' `\r\n        -Uri $($ResourceManagerUriFixed + '/subscriptions/' + $SubscriptionId + '/resourceGroups/' + $ResourceGroupName + '/providers/Microsoft.Compute/diskEncryptionSets/' + $DiskEncryptionSetName + '?api-version=2025-01-02')\r\n}",
                                    "$fxv#1": "param(\r\n    [string]$ResourceGroupName,\r\n    [string]$ResourceManagerUri,\r\n    [string]$UserAssignedIdentityClientId,\r\n    [string]$VirtualMachineResourceId\r\n)\r\n\r\n# Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n$ResourceManagerUriFixed = if($ResourceManagerUri[-1] -eq '/'){$ResourceManagerUri.Substring(0,$ResourceManagerUri.Length - 1)} else {$ResourceManagerUri}\r\n\r\n# Get an access token for Azure resources\r\n$AzureManagementAccessToken = (Invoke-RestMethod `\r\n    -Headers @{Metadata=\"true\"} `\r\n    -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n# Set header for Azure Management API\r\n$AzureManagementHeader = @{\r\n    'Content-Type'='application/json'\r\n    'Authorization'='Bearer ' + $AzureManagementAccessToken\r\n}\r\n\r\nStart-Sleep -Seconds 30\r\n\r\n# Use the access token to delete the virtual machine\r\nInvoke-RestMethod `\r\n    -Headers $AzureManagementHeader `\r\n    -Method 'Delete' `\r\n    -Uri $($ResourceManagerUriFixed + $VirtualMachineResourceId + '?forceDeletion=true&api-version=2024-07-01') | Out-Null",
                                    "keyVaultPrivateEndpointName": "[replace(parameters('tier').namingConvention.keyVaultPrivateEndpoint, parameters('tokens').purpose, variables('workload'))]",
                                    "resourceGroupName": "[resourceGroup().name]",
                                    "userAssignedIdentityName": "[replace(parameters('tier').namingConvention.userAssignedIdentity, parameters('tokens').purpose, variables('workload'))]",
                                    "virtualMachineName": "[replace(parameters('tier').namingConvention.virtualMachine, parameters('tokens').purpose, variables('workload'))]",
                                    "workload": "cmk"
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                                      "apiVersion": "2018-11-30",
                                      "name": "[variables('userAssignedIdentityName')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]"
                                    },
                                    {
                                      "type": "Microsoft.Network/networkInterfaces",
                                      "apiVersion": "2020-05-01",
                                      "name": "[replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "ipConfigurations": [
                                          {
                                            "name": "ipconfig",
                                            "properties": {
                                              "privateIPAllocationMethod": "Dynamic",
                                              "subnet": {
                                                "id": "[parameters('subnetResourceId')]"
                                              },
                                              "primary": true,
                                              "privateIPAddressVersion": "IPv4"
                                            }
                                          }
                                        ],
                                        "enableAcceleratedNetworking": false,
                                        "enableIPForwarding": false
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Compute/virtualMachines",
                                      "apiVersion": "2021-11-01",
                                      "name": "[variables('virtualMachineName')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "hardwareProfile": {
                                          "vmSize": "[parameters('virtualMachineSize')]"
                                        },
                                        "storageProfile": {
                                          "imageReference": {
                                            "publisher": "MicrosoftWindowsServer",
                                            "offer": "WindowsServer",
                                            "sku": "2022-datacenter-core-g2",
                                            "version": "latest"
                                          },
                                          "osDisk": {
                                            "deleteOption": "Delete",
                                            "osType": "Windows",
                                            "createOption": "FromImage",
                                            "caching": "None",
                                            "managedDisk": {
                                              "storageAccountType": "Premium_LRS"
                                            },
                                            "name": "[replace(parameters('tier').namingConvention.virtualMachineDisk, parameters('tokens').purpose, variables('workload'))]"
                                          },
                                          "dataDisks": []
                                        },
                                        "osProfile": {
                                          "adminPassword": "[parameters('virtualMachineAdminPassword')]",
                                          "adminUsername": "[parameters('virtualMachineAdminUsername')]",
                                          "computerName": "[variables('virtualMachineName')]",
                                          "windowsConfiguration": {
                                            "provisionVMAgent": true,
                                            "enableAutomaticUpdates": false
                                          },
                                          "secrets": [],
                                          "allowExtensionOperations": true
                                        },
                                        "networkProfile": {
                                          "networkInterfaces": [
                                            {
                                              "id": "[resourceId('Microsoft.Network/networkInterfaces', replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk'))]",
                                              "properties": {
                                                "deleteOption": "Delete"
                                              }
                                            }
                                          ]
                                        },
                                        "securityProfile": {
                                          "uefiSettings": {
                                            "secureBootEnabled": true,
                                            "vTpmEnabled": true
                                          },
                                          "securityType": "TrustedLaunch",
                                          "encryptionAtHost": true
                                        },
                                        "diagnosticsProfile": {
                                          "bootDiagnostics": {
                                            "enabled": false
                                          }
                                        },
                                        "licenseType": "Windows_Server"
                                      },
                                      "identity": {
                                        "type": "UserAssigned",
                                        "userAssignedIdentities": {
                                          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')))]": {}
                                        }
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Network/networkInterfaces', replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk'))]",
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '136d308c-0937-4a49-9bd7-edfb42adbffc', resourceGroup().id)]",
                                      "properties": {
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '136d308c-0937-4a49-9bd7-edfb42adbffc')]",
                                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                        "principalType": "ServicePrincipal"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "scope": "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]",
                                      "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '9980e02c-c2be-4d73-94e8-173b1dc7cf3c', resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName')))]",
                                      "properties": {
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '9980e02c-c2be-4d73-94e8-173b1dc7cf3c')]",
                                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                        "principalType": "ServicePrincipal"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                        "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.KeyVault/vaults",
                                      "apiVersion": "2022-07-01",
                                      "name": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "enabledForDeployment": false,
                                        "enabledForDiskEncryption": false,
                                        "enabledForTemplateDeployment": false,
                                        "enablePurgeProtection": true,
                                        "enableRbacAuthorization": true,
                                        "enableSoftDelete": true,
                                        "networkAcls": {
                                          "bypass": "AzureServices",
                                          "defaultAction": "Deny",
                                          "ipRules": [],
                                          "virtualNetworkRules": []
                                        },
                                        "publicNetworkAccess": "Disabled",
                                        "sku": {
                                          "family": "A",
                                          "name": "premium"
                                        },
                                        "softDeleteRetentionInDays": "[if(or(equals(parameters('environmentAbbreviation'), 'dev'), equals(parameters('environmentAbbreviation'), 'test')), 7, 90)]",
                                        "tenantId": "[subscription().tenantId]"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "scope": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                      "name": "[guid(variables('userAssignedIdentityName'), '00482a5a-887f-4fb3-b363-3b7fe8e74483', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))))]",
                                      "properties": {
                                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                        "principalType": "ServicePrincipal",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                        "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "scope": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                      "name": "[guid(variables('userAssignedIdentityName'), 'f25e0fa2-a7c8-4377-a976-54943a77a395', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))))]",
                                      "properties": {
                                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                        "principalType": "ServicePrincipal",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'f25e0fa2-a7c8-4377-a976-54943a77a395')]"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                        "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                      ]
                                    },
                                    {
                                      "condition": "[equals(parameters('type'), 'storageAccount')]",
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "name": "[guid(variables('userAssignedIdentityName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceGroup().id)]",
                                      "properties": {
                                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                        "principalType": "ServicePrincipal",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Network/privateEndpoints",
                                      "apiVersion": "2023-04-01",
                                      "name": "[variables('keyVaultPrivateEndpointName')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "customNetworkInterfaceName": "[replace(parameters('tier').namingConvention.keyVaultNetworkInterface, parameters('tokens').purpose, variables('workload'))]",
                                        "privateLinkServiceConnections": [
                                          {
                                            "name": "[variables('keyVaultPrivateEndpointName')]",
                                            "properties": {
                                              "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                              "groupIds": [
                                                "vault"
                                              ]
                                            }
                                          }
                                        ],
                                        "subnet": {
                                          "id": "[parameters('subnetResourceId')]"
                                        }
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '136d308c-0937-4a49-9bd7-edfb42adbffc', resourceGroup().id))]",
                                        "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), 'Microsoft.Authorization/roleAssignments', guid(variables('userAssignedIdentityName'), '00482a5a-887f-4fb3-b363-3b7fe8e74483', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))))]",
                                        "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), 'Microsoft.Authorization/roleAssignments', guid(variables('userAssignedIdentityName'), 'f25e0fa2-a7c8-4377-a976-54943a77a395', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))))]",
                                        "[extensionResourceId(resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '9980e02c-c2be-4d73-94e8-173b1dc7cf3c', resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))))]",
                                        "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                                      "apiVersion": "2021-08-01",
                                      "name": "[format('{0}/{1}', variables('keyVaultPrivateEndpointName'), format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                      "properties": {
                                        "privateDnsZoneConfigs": [
                                          {
                                            "name": "ipconfig1",
                                            "properties": {
                                              "privateDnsZoneId": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                                            }
                                          }
                                        ]
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName'))]",
                                        "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}/{1}', variables('virtualMachineName'), parameters('keyName'))]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "asyncExecution": false,
                                        "parameters": [
                                          {
                                            "name": "DiskEncryptionSetName",
                                            "value": "[replace(parameters('tier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, variables('workload'))]"
                                          },
                                          {
                                            "name": "KeyExpirationInDays",
                                            "value": "[string(parameters('keyExpirationInDays'))]"
                                          },
                                          {
                                            "name": "KeyName",
                                            "value": "[parameters('keyName')]"
                                          },
                                          {
                                            "name": "KeyVaultResourceId",
                                            "value": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                          },
                                          {
                                            "name": "KeyVaultServiceUri",
                                            "value": "[format('https://{0}', skip(environment().suffixes.keyvaultDns, 1))]"
                                          },
                                          {
                                            "name": "KeyVaultUri",
                                            "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), '2022-07-01').vaultUri]"
                                          },
                                          {
                                            "name": "Location",
                                            "value": "[parameters('location')]"
                                          },
                                          {
                                            "name": "ResourceGroupName",
                                            "value": "[variables('resourceGroupName')]"
                                          },
                                          {
                                            "name": "ResourceManagerUri",
                                            "value": "[environment().resourceManager]"
                                          },
                                          {
                                            "name": "SubscriptionId",
                                            "value": "[parameters('tier').subscriptionId]"
                                          },
                                          {
                                            "name": "Type",
                                            "value": "[parameters('type')]"
                                          },
                                          {
                                            "name": "UserAssignedIdentityClientId",
                                            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').clientId]"
                                          }
                                        ],
                                        "source": {
                                          "script": "[variables('$fxv#0')]"
                                        },
                                        "treatFailureAsDeploymentFailure": true
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', variables('keyVaultPrivateEndpointName'), format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                        "[resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName'))]",
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                        "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                        "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                                      "apiVersion": "2023-09-01",
                                      "name": "[format('{0}/{1}', variables('virtualMachineName'), format('delete-vm-{0}', parameters('deploymentNameSuffix')))]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "asyncExecution": true,
                                        "parameters": [
                                          {
                                            "name": "ResourceGroupName",
                                            "value": "[variables('resourceGroupName')]"
                                          },
                                          {
                                            "name": "ResourceManagerUri",
                                            "value": "[environment().resourceManager]"
                                          },
                                          {
                                            "name": "UserAssignedIdentityClientId",
                                            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').clientId]"
                                          },
                                          {
                                            "name": "VirtualMachineResourceId",
                                            "value": "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                                          }
                                        ],
                                        "source": {
                                          "script": "[variables('$fxv#1')]"
                                        },
                                        "treatFailureAsDeploymentFailure": true
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Resources/deployments', format('deploy-des-{0}', parameters('deploymentNameSuffix')))]",
                                        "[resourceId('Microsoft.Compute/virtualMachines/runCommands', variables('virtualMachineName'), parameters('keyName'))]",
                                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                        "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                                      ]
                                    },
                                    {
                                      "condition": "[equals(parameters('type'), 'virtualMachine')]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('deploy-des-{0}', parameters('deploymentNameSuffix'))]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "diskEncryptionSetName": {
                                            "value": "[replace(parameters('tier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, variables('workload'))]"
                                          },
                                          "keyVaultName": {
                                            "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "15118251701077090282"
                                            }
                                          },
                                          "parameters": {
                                            "diskEncryptionSetName": {
                                              "type": "string"
                                            },
                                            "keyVaultName": {
                                              "type": "string"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Authorization/roleAssignments",
                                              "apiVersion": "2020-04-01-preview",
                                              "scope": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                                              "name": "[guid(parameters('diskEncryptionSetName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')))]",
                                              "properties": {
                                                "principalId": "[reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName')), '2023-04-02', 'full').identity.principalId]",
                                                "principalType": "ServicePrincipal",
                                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                                              }
                                            }
                                          ],
                                          "outputs": {
                                            "resourceId": {
                                              "type": "string",
                                              "value": "[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName'))]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Compute/virtualMachines/runCommands', variables('virtualMachineName'), parameters('keyName'))]",
                                        "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                      ]
                                    }
                                  ],
                                  "outputs": {
                                    "diskEncryptionSetResourceId": {
                                      "type": "string",
                                      "value": "[if(equals(parameters('type'), 'virtualMachine'), reference(resourceId('Microsoft.Resources/deployments', format('deploy-des-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value, '')]"
                                    },
                                    "keyVaultProperties": {
                                      "type": "object",
                                      "value": {
                                        "diagnosticSettingName": "[replace(parameters('tier').namingConvention.keyVaultDiagnosticSetting, parameters('tokens').purpose, variables('workload'))]",
                                        "name": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]",
                                        "resourceGroupName": "[variables('resourceGroupName')]",
                                        "subscriptionId": "[parameters('tier').subscriptionId]",
                                        "tierName": "[parameters('tier').name]"
                                      }
                                    },
                                    "keyName": {
                                      "type": "string",
                                      "value": "[parameters('keyName')]"
                                    },
                                    "keyVaultName": {
                                      "type": "string",
                                      "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]"
                                    },
                                    "keyVaultUri": {
                                      "type": "string",
                                      "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), '2022-07-01').vaultUri]"
                                    },
                                    "keyVaultResourceId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                    },
                                    "keyVaultNetworkInterfaceResourceId": {
                                      "type": "string",
                                      "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName')), '2023-04-01').networkInterfaces[0].id]"
                                    },
                                    "userAssignedIdentityResourceId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-sa-log-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tier').subscriptionId]",
                              "resourceGroup": "[parameters('resourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "blobsPrivateDnsZoneResourceId": {
                                    "value": "[parameters('blobsPrivateDnsZoneResourceId')]"
                                  },
                                  "delimiter": {
                                    "value": "[parameters('delimiter')]"
                                  },
                                  "filesPrivateDnsZoneResourceId": {
                                    "value": "[parameters('filesPrivateDnsZoneResourceId')]"
                                  },
                                  "keyVaultUri": {
                                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultUri.value]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "mlzTags": {
                                    "value": "[parameters('mlzTags')]"
                                  },
                                  "purpose": {
                                    "value": "diag"
                                  },
                                  "queuesPrivateDnsZoneResourceId": {
                                    "value": "[parameters('queuesPrivateDnsZoneResourceId')]"
                                  },
                                  "skuName": {
                                    "value": "[parameters('logStorageSkuName')]"
                                  },
                                  "storageEncryptionKeyName": {
                                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyName.value]"
                                  },
                                  "subnetResourceId": {
                                    "value": "[parameters('subnetResourceId')]"
                                  },
                                  "tablesPrivateDnsZoneResourceId": {
                                    "value": "[parameters('tablesPrivateDnsZoneResourceId')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  },
                                  "tier": {
                                    "value": "[parameters('tier')]"
                                  },
                                  "tokens": {
                                    "value": "[parameters('tokens')]"
                                  },
                                  "userAssignedIdentityResourceId": {
                                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.userAssignedIdentityResourceId.value]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "3770160123771615483"
                                    }
                                  },
                                  "parameters": {
                                    "blobsPrivateDnsZoneResourceId": {
                                      "type": "string"
                                    },
                                    "delimiter": {
                                      "type": "string"
                                    },
                                    "filesPrivateDnsZoneResourceId": {
                                      "type": "string"
                                    },
                                    "keyVaultUri": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "mlzTags": {
                                      "type": "object"
                                    },
                                    "purpose": {
                                      "type": "string"
                                    },
                                    "queuesPrivateDnsZoneResourceId": {
                                      "type": "string"
                                    },
                                    "skuName": {
                                      "type": "string"
                                    },
                                    "storageEncryptionKeyName": {
                                      "type": "string"
                                    },
                                    "subnetResourceId": {
                                      "type": "string"
                                    },
                                    "tablesPrivateDnsZoneResourceId": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object"
                                    },
                                    "tier": {
                                      "type": "object"
                                    },
                                    "tokens": {
                                      "type": "object"
                                    },
                                    "userAssignedIdentityResourceId": {
                                      "type": "string"
                                    }
                                  },
                                  "variables": {
                                    "subResources": [
                                      {
                                        "id": "[parameters('blobsPrivateDnsZoneResourceId')]",
                                        "nic": "[replace(parameters('tier').namingConvention.storageAccountBlobNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                        "pe": "[replace(parameters('tier').namingConvention.storageAccountBlobPrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                      },
                                      {
                                        "id": "[parameters('filesPrivateDnsZoneResourceId')]",
                                        "nic": "[replace(parameters('tier').namingConvention.storageAccountFileNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                        "pe": "[replace(parameters('tier').namingConvention.storageAccountFilePrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                      },
                                      {
                                        "id": "[parameters('queuesPrivateDnsZoneResourceId')]",
                                        "nic": "[replace(parameters('tier').namingConvention.storageAccountQueueNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                        "pe": "[replace(parameters('tier').namingConvention.storageAccountQueuePrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                      },
                                      {
                                        "id": "[parameters('tablesPrivateDnsZoneResourceId')]",
                                        "nic": "[replace(parameters('tier').namingConvention.storageAccountTableNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                        "pe": "[replace(parameters('tier').namingConvention.storageAccountTablePrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                      }
                                    ]
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Storage/storageAccounts",
                                      "apiVersion": "2023-01-01",
                                      "name": "[uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id)]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Storage/storageAccounts'), createObject()), parameters('mlzTags'))]",
                                      "identity": {
                                        "type": "UserAssigned",
                                        "userAssignedIdentities": {
                                          "[format('{0}', parameters('userAssignedIdentityResourceId'))]": {}
                                        }
                                      },
                                      "kind": "StorageV2",
                                      "sku": {
                                        "name": "[parameters('skuName')]"
                                      },
                                      "properties": {
                                        "accessTier": "Hot",
                                        "allowBlobPublicAccess": false,
                                        "allowCrossTenantReplication": false,
                                        "allowedCopyScope": "PrivateLink",
                                        "allowSharedKeyAccess": false,
                                        "defaultToOAuthAuthentication": false,
                                        "dnsEndpointType": "Standard",
                                        "encryption": {
                                          "identity": {
                                            "userAssignedIdentity": "[parameters('userAssignedIdentityResourceId')]"
                                          },
                                          "keySource": "Microsoft.KeyVault",
                                          "keyvaultproperties": {
                                            "keyvaulturi": "[parameters('keyVaultUri')]",
                                            "keyname": "[parameters('storageEncryptionKeyName')]"
                                          },
                                          "requireInfrastructureEncryption": true,
                                          "services": {
                                            "blob": {
                                              "keyType": "Account",
                                              "enabled": true
                                            },
                                            "file": {
                                              "keyType": "Account",
                                              "enabled": true
                                            },
                                            "queue": {
                                              "keyType": "Account",
                                              "enabled": true
                                            },
                                            "table": {
                                              "keyType": "Account",
                                              "enabled": true
                                            }
                                          }
                                        },
                                        "minimumTlsVersion": "TLS1_2",
                                        "networkAcls": {
                                          "bypass": "AzureServices",
                                          "virtualNetworkRules": [],
                                          "ipRules": [],
                                          "defaultAction": "Deny"
                                        },
                                        "publicNetworkAccess": "Disabled",
                                        "supportsHttpsTrafficOnly": true
                                      }
                                    },
                                    {
                                      "copy": {
                                        "name": "privateEndpoints",
                                        "count": "[length(variables('subResources'))]"
                                      },
                                      "type": "Microsoft.Network/privateEndpoints",
                                      "apiVersion": "2023-04-01",
                                      "name": "[variables('subResources')[copyIndex()].pe]",
                                      "location": "[parameters('location')]",
                                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()), parameters('mlzTags'))]",
                                      "properties": {
                                        "customNetworkInterfaceName": "[variables('subResources')[copyIndex()].nic]",
                                        "privateLinkServiceConnections": [
                                          {
                                            "name": "[variables('subResources')[copyIndex()].pe]",
                                            "properties": {
                                              "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]",
                                              "groupIds": [
                                                "[split(split(variables('subResources')[copyIndex()].id, '/')[8], '.')[1]]"
                                              ]
                                            }
                                          }
                                        ],
                                        "subnet": {
                                          "id": "[parameters('subnetResourceId')]"
                                        }
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]"
                                      ]
                                    },
                                    {
                                      "copy": {
                                        "name": "privateDnsZoneGroups",
                                        "count": "[length(variables('subResources'))]"
                                      },
                                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                                      "apiVersion": "2021-08-01",
                                      "name": "[format('{0}/{1}', variables('subResources')[copyIndex()].pe, uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]",
                                      "properties": {
                                        "privateDnsZoneConfigs": [
                                          {
                                            "name": "ipconfig1",
                                            "properties": {
                                              "privateDnsZoneId": "[variables('subResources')[copyIndex()].id]"
                                            }
                                          }
                                        ]
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Network/privateEndpoints', variables('subResources')[copyIndex()].pe)]",
                                        "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]"
                                      ]
                                    }
                                  ],
                                  "outputs": {
                                    "id": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(replace(parameters('tier').namingConvention.storageAccount, parameters('tokens').purpose, parameters('purpose')), resourceGroup().id))]"
                                    },
                                    "networkInterfaceResourceIds": {
                                      "type": "array",
                                      "copy": {
                                        "count": "[length(variables('subResources'))]",
                                        "input": "[reference(resourceId('Microsoft.Network/privateEndpoints', variables('subResources')[copyIndex()].pe), '2023-04-01').networkInterfaces[0].id]"
                                      }
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix')))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "keyVaultName": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultName.value]"
                            },
                            "keyVaultUri": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultUri.value]"
                            },
                            "networkInterfaceResourceIds": {
                              "type": "array",
                              "value": "[union(createArray(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultNetworkInterfaceResourceId.value), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sa-log-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceIds.value)]"
                            },
                            "storageAccountResourceId": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sa-log-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value]"
                            },
                            "userAssignedIdentityResourceId": {
                              "type": "string",
                              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}-{1}{2}', parameters('workloadShortName'), parameters('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.userAssignedIdentityResourceId.value]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-diag-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "blobDiagnosticsLogs": {
                            "value": "[parameters('blobDiagnosticsLogs')]"
                          },
                          "blobDiagnosticsMetrics": {
                            "value": "[parameters('blobDiagnosticsMetrics')]"
                          },
                          "delimiter": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                          },
                          "deployActivityLogDiagnosticSetting": {
                            "value": "[parameters('deployActivityLogDiagnosticSetting')]"
                          },
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "deployNetworkWatcherTrafficAnalytics": {
                            "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                          },
                          "fileDiagnosticsLogs": {
                            "value": "[parameters('fileDiagnosticsLogs')]"
                          },
                          "fileDiagnosticsMetrics": {
                            "value": "[parameters('fileDiagnosticsMetrics')]"
                          },
                          "hubStorageAccountResourceId": {
                            "value": "[parameters('hubStorageAccountResourceId')]"
                          },
                          "keyVaultDiagnosticLogs": {
                            "value": "[parameters('keyVaultDiagnosticLogs')]"
                          },
                          "keyVaultDiagnosticMetrics": {
                            "value": "[parameters('keyVaultDiagnosticMetrics')]"
                          },
                          "keyVaultName": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-storage-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultName.value]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "networkInterfaceDiagnosticsMetrics": {
                            "value": "[parameters('networkInterfaceDiagnosticsMetrics')]"
                          },
                          "networkInterfaceResourceIds": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-storage-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceIds.value]"
                          },
                          "networkSecurityGroupDiagnosticsLogs": {
                            "value": "[parameters('networkSecurityGroupDiagnosticsLogs')]"
                          },
                          "networkWatcherFlowLogsRetentionDays": {
                            "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                          },
                          "networkWatcherFlowLogsType": {
                            "value": "[parameters('networkWatcherFlowLogsType')]"
                          },
                          "queueDiagnosticsLogs": {
                            "value": "[parameters('queueDiagnosticsLogs')]"
                          },
                          "queueDiagnosticsMetrics": {
                            "value": "[parameters('queueDiagnosticsMetrics')]"
                          },
                          "storageAccountDiagnosticsLogs": {
                            "value": "[parameters('storageAccountDiagnosticsLogs')]"
                          },
                          "storageAccountDiagnosticsMetrics": {
                            "value": "[parameters('storageAccountDiagnosticsMetrics')]"
                          },
                          "storageAccountResourceId": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-storage-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.storageAccountResourceId.value]"
                          },
                          "tableDiagnosticsLogs": {
                            "value": "[parameters('tableDiagnosticsLogs')]"
                          },
                          "tableDiagnosticsMetrics": {
                            "value": "[parameters('tableDiagnosticsMetrics')]"
                          },
                          "tier": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value]"
                          },
                          "tokens": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                          },
                          "virtualNetworkDiagnosticsLogs": {
                            "value": "[parameters('virtualNetworkDiagnosticsLogs')]"
                          },
                          "virtualNetworkDiagnosticsMetrics": {
                            "value": "[parameters('virtualNetworkDiagnosticsMetrics')]"
                          },
                          "virtualNetworkName": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkName.value]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "2297357647816897874"
                            }
                          },
                          "parameters": {
                            "blobDiagnosticsLogs": {
                              "type": "array"
                            },
                            "blobDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "delimiter": {
                              "type": "string"
                            },
                            "deployActivityLogDiagnosticSetting": {
                              "type": "bool"
                            },
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "deployNetworkWatcherTrafficAnalytics": {
                              "type": "bool"
                            },
                            "fileDiagnosticsLogs": {
                              "type": "array"
                            },
                            "fileDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "hubStorageAccountResourceId": {
                              "type": "string"
                            },
                            "keyVaultDiagnosticLogs": {
                              "type": "array"
                            },
                            "keyVaultDiagnosticMetrics": {
                              "type": "array"
                            },
                            "keyVaultName": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "networkInterfaceDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "networkInterfaceResourceIds": {
                              "type": "array"
                            },
                            "networkSecurityGroupDiagnosticsLogs": {
                              "type": "array"
                            },
                            "networkWatcherFlowLogsRetentionDays": {
                              "type": "int"
                            },
                            "networkWatcherFlowLogsType": {
                              "type": "string"
                            },
                            "queueDiagnosticsLogs": {
                              "type": "array"
                            },
                            "queueDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "storageAccountDiagnosticsLogs": {
                              "type": "array"
                            },
                            "storageAccountDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "storageAccountResourceId": {
                              "type": "string"
                            },
                            "tableDiagnosticsLogs": {
                              "type": "array"
                            },
                            "tableDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "tier": {
                              "type": "object"
                            },
                            "tokens": {
                              "type": "object"
                            },
                            "virtualNetworkDiagnosticsLogs": {
                              "type": "array"
                            },
                            "virtualNetworkDiagnosticsMetrics": {
                              "type": "array"
                            },
                            "virtualNetworkName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "condition": "[parameters('deployActivityLogDiagnosticSetting')]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-activity-diags-{0}-{1}', parameters('tier').shortName, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tier').subscriptionId]",
                              "location": "[deployment().location]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "logAnalyticsWorkspaceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "10072718411163230780"
                                    }
                                  },
                                  "parameters": {
                                    "logAnalyticsWorkspaceId": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "microsoft.insights/diagnosticSettings",
                                      "apiVersion": "2017-05-01-preview",
                                      "name": "[format('diag-activity-log-{0}', subscription().subscriptionId)]",
                                      "properties": {
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                                        "logs": [
                                          {
                                            "category": "Administrative",
                                            "enabled": true
                                          },
                                          {
                                            "category": "Security",
                                            "enabled": true
                                          },
                                          {
                                            "category": "ServiceHealth",
                                            "enabled": true
                                          },
                                          {
                                            "category": "Alert",
                                            "enabled": true
                                          },
                                          {
                                            "category": "Recommendation",
                                            "enabled": true
                                          },
                                          {
                                            "category": "Policy",
                                            "enabled": true
                                          },
                                          {
                                            "category": "Autoscale",
                                            "enabled": true
                                          },
                                          {
                                            "category": "ResourceHealth",
                                            "enabled": true
                                          }
                                        ]
                                      }
                                    }
                                  ]
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-sa-diag-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tier').subscriptionId]",
                              "resourceGroup": "[parameters('tier').resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "blobDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.storageAccountBlobDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "blobDiagnosticsLogs": {
                                    "value": "[parameters('blobDiagnosticsLogs')]"
                                  },
                                  "blobDiagnosticsMetrics": {
                                    "value": "[parameters('blobDiagnosticsMetrics')]"
                                  },
                                  "fileDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.storageAccountFileDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "fileDiagnosticsLogs": {
                                    "value": "[parameters('fileDiagnosticsLogs')]"
                                  },
                                  "fileDiagnosticsMetrics": {
                                    "value": "[parameters('fileDiagnosticsMetrics')]"
                                  },
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  },
                                  "logStorageAccountResourceId": {
                                    "value": "[parameters('hubStorageAccountResourceId')]"
                                  },
                                  "queueDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.storageAccountQueueDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "queueDiagnosticsLogs": {
                                    "value": "[parameters('queueDiagnosticsLogs')]"
                                  },
                                  "queueDiagnosticsMetrics": {
                                    "value": "[parameters('queueDiagnosticsMetrics')]"
                                  },
                                  "storageAccountDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.storageAccountDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "storageAccountDiagnosticsLogs": {
                                    "value": "[parameters('storageAccountDiagnosticsLogs')]"
                                  },
                                  "storageAccountDiagnosticsMetrics": {
                                    "value": "[parameters('storageAccountDiagnosticsMetrics')]"
                                  },
                                  "storageAccountName": {
                                    "value": "[split(parameters('storageAccountResourceId'), '/')[8]]"
                                  },
                                  "tableDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.storageAccountTableDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "tableDiagnosticsLogs": {
                                    "value": "[parameters('tableDiagnosticsLogs')]"
                                  },
                                  "tableDiagnosticsMetrics": {
                                    "value": "[parameters('tableDiagnosticsMetrics')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "16854631658526137140"
                                    }
                                  },
                                  "parameters": {
                                    "blobDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "blobDiagnosticsLogs": {
                                      "type": "array"
                                    },
                                    "blobDiagnosticsMetrics": {
                                      "type": "array"
                                    },
                                    "fileDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "fileDiagnosticsLogs": {
                                      "type": "array"
                                    },
                                    "fileDiagnosticsMetrics": {
                                      "type": "array"
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string"
                                    },
                                    "logStorageAccountResourceId": {
                                      "type": "string"
                                    },
                                    "queueDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "queueDiagnosticsLogs": {
                                      "type": "array"
                                    },
                                    "queueDiagnosticsMetrics": {
                                      "type": "array"
                                    },
                                    "storageAccountDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "storageAccountDiagnosticsLogs": {
                                      "type": "array"
                                    },
                                    "storageAccountDiagnosticsMetrics": {
                                      "type": "array"
                                    },
                                    "storageAccountName": {
                                      "type": "string"
                                    },
                                    "tableDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "tableDiagnosticsLogs": {
                                      "type": "array"
                                    },
                                    "tableDiagnosticsMetrics": {
                                      "type": "array"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
                                      "name": "[parameters('storageAccountDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('storageAccountDiagnosticsLogs')]",
                                        "metrics": "[parameters('storageAccountDiagnosticsMetrics')]",
                                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]",
                                      "name": "[parameters('blobDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('blobDiagnosticsLogs')]",
                                        "metrics": "[parameters('blobDiagnosticsMetrics')]",
                                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Storage/storageAccounts/fileServices', parameters('storageAccountName'), 'default')]",
                                      "name": "[parameters('fileDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('fileDiagnosticsLogs')]",
                                        "metrics": "[parameters('fileDiagnosticsMetrics')]",
                                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Storage/storageAccounts/queueServices', parameters('storageAccountName'), 'default')]",
                                      "name": "[parameters('queueDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('queueDiagnosticsLogs')]",
                                        "metrics": "[parameters('queueDiagnosticsMetrics')]",
                                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), 'default')]",
                                      "name": "[parameters('tableDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('tableDiagnosticsLogs')]",
                                        "metrics": "[parameters('tableDiagnosticsMetrics')]",
                                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    }
                                  ]
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-kv-diags-{0}-{1}', parameters('tier').shortName, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tier').subscriptionId]",
                              "resourceGroup": "[parameters('tier').resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "keyVaultDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.keyVaultDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "keyVaultName": {
                                    "value": "[parameters('keyVaultName')]"
                                  },
                                  "keyVaultStorageAccountId": {
                                    "value": "[parameters('storageAccountResourceId')]"
                                  },
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  },
                                  "logs": {
                                    "value": "[parameters('keyVaultDiagnosticLogs')]"
                                  },
                                  "metrics": {
                                    "value": "[parameters('keyVaultDiagnosticMetrics')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "1272317275534002717"
                                    }
                                  },
                                  "parameters": {
                                    "keyVaultDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "keyVaultName": {
                                      "type": "string"
                                    },
                                    "keyVaultStorageAccountId": {
                                      "type": "string"
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string"
                                    },
                                    "logs": {
                                      "type": "array"
                                    },
                                    "metrics": {
                                      "type": "array"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                                      "name": "[parameters('keyVaultDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('logs')]",
                                        "metrics": "[parameters('metrics')]",
                                        "storageAccountId": "[parameters('keyVaultStorageAccountId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    }
                                  ]
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-nsg-diags-{0}-{1}', parameters('tier').shortName, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tier').subscriptionId]",
                              "resourceGroup": "[parameters('tier').resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "deploymentNameSuffix": {
                                    "value": "[parameters('deploymentNameSuffix')]"
                                  },
                                  "deployNetworkWatcherTrafficAnalytics": {
                                    "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                                  },
                                  "flowLogsName": {
                                    "value": "[replace(parameters('tier').namingConvention.networkWatcherFlowLogsNetworkSecurityGroup, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  },
                                  "logs": {
                                    "value": "[parameters('networkSecurityGroupDiagnosticsLogs')]"
                                  },
                                  "networkSecurityGroupDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.networkSecurityGroupDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "networkSecurityGroupName": {
                                    "value": "[split(parameters('tier').networkSecurityGroupResourceId, '/')[8]]"
                                  },
                                  "networkWatcherFlowLogsRetentionDays": {
                                    "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                                  },
                                  "networkWatcherFlowLogsType": {
                                    "value": "[parameters('networkWatcherFlowLogsType')]"
                                  },
                                  "storageAccountResourceId": {
                                    "value": "[parameters('storageAccountResourceId')]"
                                  },
                                  "tiername": {
                                    "value": "[parameters('tier').name]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "5431688095715861024"
                                    }
                                  },
                                  "parameters": {
                                    "deploymentNameSuffix": {
                                      "type": "string"
                                    },
                                    "deployNetworkWatcherTrafficAnalytics": {
                                      "type": "bool"
                                    },
                                    "flowLogsName": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string"
                                    },
                                    "logs": {
                                      "type": "array"
                                    },
                                    "networkSecurityGroupDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "networkSecurityGroupName": {
                                      "type": "string"
                                    },
                                    "networkWatcherFlowLogsRetentionDays": {
                                      "type": "int"
                                    },
                                    "networkWatcherFlowLogsType": {
                                      "type": "string"
                                    },
                                    "storageAccountResourceId": {
                                      "type": "string"
                                    },
                                    "tiername": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]",
                                      "name": "[parameters('networkSecurityGroupDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('logs')]",
                                        "metrics": [],
                                        "storageAccountId": "[parameters('storageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    },
                                    {
                                      "condition": "[equals(parameters('networkWatcherFlowLogsType'), 'NetworkSecurityGroup')]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('deploy-{0}-flowLogs-{1}', parameters('tiername'), parameters('deploymentNameSuffix'))]",
                                      "resourceGroup": "NetworkWatcherRG",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "deployNetworkWatcherTrafficAnalytics": {
                                            "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                                          },
                                          "flowLogsName": {
                                            "value": "[parameters('flowLogsName')]"
                                          },
                                          "flowLogsRetentionDays": {
                                            "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                                          },
                                          "location": {
                                            "value": "[parameters('location')]"
                                          },
                                          "logAnalyticsWorkspaceResourceId": {
                                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                          },
                                          "networkWatcherName": {
                                            "value": "[format('NetworkWatcher_{0}', parameters('location'))]"
                                          },
                                          "storageAccountResourceId": {
                                            "value": "[parameters('storageAccountResourceId')]"
                                          },
                                          "targetResourceId": {
                                            "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "18376200335373925565"
                                            }
                                          },
                                          "parameters": {
                                            "deployNetworkWatcherTrafficAnalytics": {
                                              "type": "bool"
                                            },
                                            "flowLogsName": {
                                              "type": "string"
                                            },
                                            "flowLogsRetentionDays": {
                                              "type": "int"
                                            },
                                            "location": {
                                              "type": "string"
                                            },
                                            "logAnalyticsWorkspaceResourceId": {
                                              "type": "string"
                                            },
                                            "networkWatcherName": {
                                              "type": "string"
                                            },
                                            "storageAccountResourceId": {
                                              "type": "string"
                                            },
                                            "targetResourceId": {
                                              "type": "string"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/networkWatchers/flowLogs",
                                              "apiVersion": "2023-05-01",
                                              "name": "[format('{0}/{1}', parameters('networkWatcherName'), parameters('flowLogsName'))]",
                                              "location": "[parameters('location')]",
                                              "properties": {
                                                "targetResourceId": "[parameters('targetResourceId')]",
                                                "enabled": true,
                                                "storageId": "[parameters('storageAccountResourceId')]",
                                                "flowAnalyticsConfiguration": {
                                                  "networkWatcherFlowAnalyticsConfiguration": {
                                                    "enabled": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('deployNetworkWatcherTrafficAnalytics'), null())]",
                                                    "workspaceResourceId": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('logAnalyticsWorkspaceResourceId'), null())]"
                                                  }
                                                },
                                                "format": {
                                                  "type": "JSON",
                                                  "version": 2
                                                },
                                                "retentionPolicy": {
                                                  "days": "[parameters('flowLogsRetentionDays')]",
                                                  "enabled": true
                                                }
                                              }
                                            }
                                          ]
                                        }
                                      }
                                    }
                                  ]
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-vnet-diags-{0}-{1}', parameters('tier').shortName, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tier').subscriptionId]",
                              "resourceGroup": "[parameters('tier').resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "deploymentNameSuffix": {
                                    "value": "[parameters('deploymentNameSuffix')]"
                                  },
                                  "deployNetworkWatcherTrafficAnalytics": {
                                    "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                                  },
                                  "flowLogsName": {
                                    "value": "[replace(parameters('tier').namingConvention.networkWatcherFlowLogsVirtualNetwork, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  },
                                  "logs": {
                                    "value": "[parameters('virtualNetworkDiagnosticsLogs')]"
                                  },
                                  "logStorageAccountResourceId": {
                                    "value": "[parameters('storageAccountResourceId')]"
                                  },
                                  "metrics": {
                                    "value": "[parameters('virtualNetworkDiagnosticsMetrics')]"
                                  },
                                  "networkWatcherFlowLogsRetentionDays": {
                                    "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                                  },
                                  "networkWatcherFlowLogsType": {
                                    "value": "[parameters('networkWatcherFlowLogsType')]"
                                  },
                                  "tiername": {
                                    "value": "[parameters('tier').name]"
                                  },
                                  "virtualNetworkDiagnosticSettingName": {
                                    "value": "[replace(parameters('tier').namingConvention.virtualNetworkDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                                  },
                                  "virtualNetworkName": {
                                    "value": "[parameters('virtualNetworkName')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "7697548079699580923"
                                    }
                                  },
                                  "parameters": {
                                    "deploymentNameSuffix": {
                                      "type": "string"
                                    },
                                    "deployNetworkWatcherTrafficAnalytics": {
                                      "type": "bool"
                                    },
                                    "flowLogsName": {
                                      "type": "string"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string"
                                    },
                                    "logs": {
                                      "type": "array"
                                    },
                                    "logStorageAccountResourceId": {
                                      "type": "string"
                                    },
                                    "metrics": {
                                      "type": "array"
                                    },
                                    "networkWatcherFlowLogsRetentionDays": {
                                      "type": "int"
                                    },
                                    "networkWatcherFlowLogsType": {
                                      "type": "string"
                                    },
                                    "supportedClouds": {
                                      "type": "array",
                                      "defaultValue": [
                                        "AzureCloud"
                                      ]
                                    },
                                    "tiername": {
                                      "type": "string"
                                    },
                                    "virtualNetworkDiagnosticSettingName": {
                                      "type": "string"
                                    },
                                    "virtualNetworkName": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
                                      "name": "[parameters('virtualNetworkDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[if(contains(parameters('supportedClouds'), environment().name), parameters('logs'), createArray())]",
                                        "metrics": "[parameters('metrics')]",
                                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    },
                                    {
                                      "condition": "[equals(parameters('networkWatcherFlowLogsType'), 'VirtualNetwork')]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('deploy-{0}-flowLogs-{1}', parameters('tiername'), parameters('deploymentNameSuffix'))]",
                                      "resourceGroup": "NetworkWatcherRG",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "deployNetworkWatcherTrafficAnalytics": {
                                            "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                                          },
                                          "flowLogsName": {
                                            "value": "[parameters('flowLogsName')]"
                                          },
                                          "flowLogsRetentionDays": {
                                            "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                                          },
                                          "location": {
                                            "value": "[parameters('location')]"
                                          },
                                          "logAnalyticsWorkspaceResourceId": {
                                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                          },
                                          "networkWatcherName": {
                                            "value": "[format('NetworkWatcher_{0}', parameters('location'))]"
                                          },
                                          "storageAccountResourceId": {
                                            "value": "[parameters('logStorageAccountResourceId')]"
                                          },
                                          "targetResourceId": {
                                            "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "18376200335373925565"
                                            }
                                          },
                                          "parameters": {
                                            "deployNetworkWatcherTrafficAnalytics": {
                                              "type": "bool"
                                            },
                                            "flowLogsName": {
                                              "type": "string"
                                            },
                                            "flowLogsRetentionDays": {
                                              "type": "int"
                                            },
                                            "location": {
                                              "type": "string"
                                            },
                                            "logAnalyticsWorkspaceResourceId": {
                                              "type": "string"
                                            },
                                            "networkWatcherName": {
                                              "type": "string"
                                            },
                                            "storageAccountResourceId": {
                                              "type": "string"
                                            },
                                            "targetResourceId": {
                                              "type": "string"
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Network/networkWatchers/flowLogs",
                                              "apiVersion": "2023-05-01",
                                              "name": "[format('{0}/{1}', parameters('networkWatcherName'), parameters('flowLogsName'))]",
                                              "location": "[parameters('location')]",
                                              "properties": {
                                                "targetResourceId": "[parameters('targetResourceId')]",
                                                "enabled": true,
                                                "storageId": "[parameters('storageAccountResourceId')]",
                                                "flowAnalyticsConfiguration": {
                                                  "networkWatcherFlowAnalyticsConfiguration": {
                                                    "enabled": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('deployNetworkWatcherTrafficAnalytics'), null())]",
                                                    "workspaceResourceId": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('logAnalyticsWorkspaceResourceId'), null())]"
                                                  }
                                                },
                                                "format": {
                                                  "type": "JSON",
                                                  "version": 2
                                                },
                                                "retentionPolicy": {
                                                  "days": "[parameters('flowLogsRetentionDays')]",
                                                  "enabled": true
                                                }
                                              }
                                            }
                                          ]
                                        }
                                      }
                                    }
                                  ]
                                }
                              }
                            },
                            {
                              "copy": {
                                "name": "networkInterfaceDiagnostics",
                                "count": "[length(parameters('networkInterfaceResourceIds'))]"
                              },
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-nic-diags-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[split(parameters('networkInterfaceResourceIds')[copyIndex()], '/')[2]]",
                              "resourceGroup": "[split(parameters('networkInterfaceResourceIds')[copyIndex()], '/')[4]]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "delimiter": {
                                    "value": "[parameters('delimiter')]"
                                  },
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  },
                                  "logs": {
                                    "value": []
                                  },
                                  "metrics": {
                                    "value": "[parameters('networkInterfaceDiagnosticsMetrics')]"
                                  },
                                  "networkInterfaceResourceId": {
                                    "value": "[parameters('networkInterfaceResourceIds')[copyIndex()]]"
                                  },
                                  "storageAccountResourceIds": {
                                    "value": [
                                      "[parameters('storageAccountResourceId')]"
                                    ]
                                  },
                                  "tiers": {
                                    "value": [
                                      "[parameters('tier')]"
                                    ]
                                  },
                                  "tokens": {
                                    "value": "[parameters('tokens')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "9983310224341078636"
                                    }
                                  },
                                  "parameters": {
                                    "delimiter": {
                                      "type": "string"
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string"
                                    },
                                    "logs": {
                                      "type": "array"
                                    },
                                    "metrics": {
                                      "type": "array"
                                    },
                                    "networkInterfaceResourceId": {
                                      "type": "string"
                                    },
                                    "storageAccountResourceIds": {
                                      "type": "array"
                                    },
                                    "tiers": {
                                      "type": "array"
                                    },
                                    "tokens": {
                                      "type": "object"
                                    }
                                  },
                                  "variables": {
                                    "networkInterfaceDiagnosticSettingName": "[replace(parameters('tiers')[variables('tierIndex')].namingConvention.virtualMachineNetworkInterfaceDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                    "storageAccountResourceId": "[parameters('storageAccountResourceIds')[variables('tierIndex')]]",
                                    "tierIndex": "[if(contains(parameters('networkInterfaceResourceId'), '-ops-'), 1, if(contains(parameters('networkInterfaceResourceId'), '-svcs-'), 2, if(contains(parameters('networkInterfaceResourceId'), '-id-'), 3, 0)))]"
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[resourceId('Microsoft.Network/networkInterfaces', split(parameters('networkInterfaceResourceId'), '/')[8])]",
                                      "name": "[variables('networkInterfaceDiagnosticSettingName')]",
                                      "properties": {
                                        "logs": "[parameters('logs')]",
                                        "metrics": "[parameters('metrics')]",
                                        "storageAccountId": "[variables('storageAccountResourceId')]",
                                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    }
                                  ]
                                }
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-storage-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "condition": "[parameters('deployPolicy')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('assign-policy-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "policy": {
                            "value": "[parameters('policy')]"
                          },
                          "tiers": {
                            "value": [
                              "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value]"
                            ]
                          },
                          "windowsAdministratorsGroupMembership": {
                            "value": "[parameters('windowsAdministratorsGroupMembership')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "4151260437398627510"
                            }
                          },
                          "parameters": {
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "policy": {
                              "type": "string"
                            },
                            "tiers": {
                              "type": "array"
                            },
                            "windowsAdministratorsGroupMembership": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "policyAssignment",
                                "count": "[length(parameters('tiers'))]"
                              },
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('assign-policy-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[parameters('tiers')[copyIndex()].subscriptionId]",
                              "resourceGroup": "[parameters('tiers')[copyIndex()].resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "builtInAssignment": {
                                    "value": "[parameters('policy')]"
                                  },
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "deployRemediation": {
                                    "value": false
                                  },
                                  "windowsAdministratorsGroupMembership": {
                                    "value": "[parameters('windowsAdministratorsGroupMembership')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "15366687354223606610"
                                    }
                                  },
                                  "parameters": {
                                    "builtInAssignment": {
                                      "type": "string"
                                    },
                                    "deployRemediation": {
                                      "type": "bool"
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string"
                                    },
                                    "windowsAdministratorsGroupMembership": {
                                      "type": "string"
                                    }
                                  },
                                  "variables": {
                                    "$fxv#0": "{\r\n  \"listOfMembersToExcludeFromWindowsVMAdministratorsGroup\": {\r\n    \"value\": \"admin\"\r\n  },\r\n  \"IncludeArcMachines\": {\r\n    \"value\": \"true\"\r\n  },\r\n  \"MinimumTLSVersion-5752e6d6-1206-46d8-8ab1-ecc2f71a8112\": {\r\n    \"value\": \"1.2\"\r\n  },\r\n  \"NotAvailableMachineState-bed48b13-6647-468e-aa2f-1af1d3f4dd40\": {\r\n    \"value\": \"Compliant\"\r\n  },\r\n  \"requiredRetentionDays\": {\r\n    \"value\": \"365\"\r\n  },\r\n  \"resourceGroupName-b6e2945c-0b7b-40f5-9233-7a5323b5cdc6\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                                    "$fxv#1": "{\r\n  \"IncludeArcMachines\": {\r\n    \"value\": \"true\"\r\n  },\r\n  \"MinimumTLSVersion-5752e6d6-1206-46d8-8ab1-ecc2f71a8112\": {\r\n    \"value\": \"1.2\"\r\n  },\r\n  \"NotAvailableMachineState-bed48b13-6647-468e-aa2f-1af1d3f4dd40\": {\r\n    \"value\": \"Compliant\"\r\n  },\r\n  \"requiredRetentionDays\": {\r\n    \"value\": \"365\"\r\n  },\r\n  \"resourceGroupName-b6e2945c-0b7b-40f5-9233-7a5323b5cdc6\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                                    "$fxv#2": "{\r\n  \"IncludeArcMachines\": {\r\n    \"value\": \"false\"\r\n  },\r\n  \"NotAvailableMachineState-bed48b13-6647-468e-aa2f-1af1d3f4dd40\": {\r\n    \"value\": \"Compliant\"\r\n  },\r\n  \"MinimumTLSVersionForWindowsServers\": {\r\n    \"value\": \"1.2\"\r\n  },\r\n  \"requiredRetentionDays\": {\r\n    \"value\": \"365\"\r\n  },\r\n  \"effect-febd0533-8e55-448f-b837-bd0e06f16469\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"allowedContainerImagesRegex-febd0533-8e55-448f-b837-bd0e06f16469\": {\r\n    \"value\": \"^(.+){0}$\"\r\n  },\r\n  \"effect-95edb821-ddaf-4404-9732-666045e056b4\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-440b515e-a580-421e-abeb-b159a61ddcbc\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-233a2a17-77ca-4fb1-9b6b-69223d272a44\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-e345eecc-fa47-480f-9e88-67dcc122b164\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"cpuLimit-e345eecc-fa47-480f-9e88-67dcc122b164\": {\r\n    \"value\": \"0\"\r\n  },\r\n  \"memoryLimit-e345eecc-fa47-480f-9e88-67dcc122b164\": {\r\n    \"value\": \"0\"\r\n  },\r\n  \"effect-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"runAsUserRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"MustRunAsNonRoot\"\r\n  },\r\n  \"runAsGroupRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"RunAsAny\"\r\n  },\r\n  \"supplementalGroupsRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"RunAsAny\"\r\n  },\r\n  \"fsGroupRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"RunAsAny\"\r\n  },\r\n  \"effect-1c6e92c9-99f0-4e55-9cf2-0c234dc48f99\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-47a1ee2f-2a2a-4576-bf2a-e0e36709c2b8\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-df49d893-a74c-421d-bc95-c663042e5b80\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-1a5b4dca-0b6f-4cf5-907c-56316bc1bf3d\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-c26596ff-4d70-4e6a-9a30-c2506bd2f80c\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-511f5417-5d12-434d-ab2e-816901e72a5e\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-82985f06-dc18-4a48-bc1c-b9f4f0098cfe\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-098fc59e-46c7-4d99-9b16-64990e543d75\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"setting-a6fb4358-5bf4-4ad7-ba82-2cd2f41ce5e9\": {\r\n    \"value\": \"enabled\"\r\n  },\r\n  \"aadAuthenticationInServiceFabricMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-71ef260a-8f18-47b7-abcb-62d0673d94dc\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-055aa869-bc98-4af8-bafc-23f1ab6ffe2c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-564feb30-bf6a-4854-b4bb-0d2d2d1e6c66\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-862e97cf-49fc-4a5c-9de4-40d4e2e7c8eb\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d9da03a1-f3c3-412a-9709-947156872263\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-617c02be-7f02-4efd-8836-3180d47b6c68\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0b60c0b2-2dc2-4e1c-b5c9-abbed971de53\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1e66c121-a66a-4b1f-9b83-0fd99bf0fc2d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ec068d99-e9c7-401f-8cef-5bdde4e6ccf1\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c349d81b-9985-44ae-a8da-ff98d108ede8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-3657f5a0-770e-44a3-b44e-9431ba1e9735\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-b4ac1030-89c5-4697-8e00-28b5ba6a8811\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-ea0dfaed-95fb-448c-934e-d6e713ce393d\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-4733ea7b-a883-42fe-8cac-97454c2a9e4a\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-f4b53539-8df9-40e4-86c6-6b607703bd4e\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-41425d9f-d1a5-499a-9932-f8ed8453932c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-fc4d8e41-e223-45ea-9bf5-eada37891d87\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-86efb160-8de7-451d-bc08-5d475b0aadae\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-4ec52d6d-beb7-40c4-9a9e-fe753254690e\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-64d314f6-6062-4780-a861-c23e8951bee5\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1fd32ebd-e4c3-4e13-a54a-d7422d4d95f6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-fa298e57-9444-42ba-bf04-86e8470e32c7\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-67121cc7-ff39-4ab8-b7e3-95b84dab487d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1f905d99-2ab7-462c-a6b0-f709acca6c8f\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-5b9159ae-1701-4a6f-9a7a-aa9c8ddd0580\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ba769a63-b8cc-4b2d-abf6-ac33c7204be8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-81e74cea-30fd-40d5-802f-d72103c2aaaa\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0aa61e00-0a01-4a3c-9945-e93cffedf0e6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-47031206-ce96-41f8-861b-6a915f3de284\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-87ba29ef-1ab3-4d82-b763-87fcd4f531f7\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-51522a96-0869-4791-82f3-981000c2c67f\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-b5ec538c-daa0-4006-8596-35468b9148e8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-56a5ee18-2ae6-4810-86f7-18e39ce5629b\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-2e94d99a-8a36-4563-bc77-810d8893b671\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1fafeaf6-7927-4059-a50a-8eb2a7a6f2b5\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-99e9ccd8-3db9-4592-b0d1-14b1715a4d8a\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1f68a601-6e6d-4e42-babf-3f643a047ea2\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-f7d52b2d-e161-4dfa-a82b-55e564167385\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7d7be79c-23ba-4033-84dd-45e2a5ccdd67\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ca91455f-eace-4f96-be59-e6e2c35b4816\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-702dd420-7fcc-42c5-afe8-4026edd20fe0\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"diagnosticsLogsInRedisCacheMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"secureTransferToStorageAccountMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d0793b48-0edc-4296-a390-4c75d1bdfd71\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7d092e0a-7acd-40d2-a975-dca21cae48c4\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-2a1a9cdf-e04d-429a-8416-3bfb72a1b26f\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"disableUnrestrictedNetworkToStorageAccountMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-55615ac9-af46-4a59-874e-391cc3dfb490\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1b8ca024-1d5c-4dec-8995-b1a932b41780\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-037eea7a-bd0a-46c5-9a66-03aea78705d3\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-53503636-bcc9-4748-9663-5348217f160f\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-40cec1dd-a100-4920-b15b-3024fe8901ab\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0725b4dd-7e76-479c-a735-68e7ee23d5ca\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-a049bf77-880b-470f-ba6d-9f21c530cf83\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ee980b6d-0eca-4501-8d54-f6290fd512c3\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1d84d5fb-01f6-4d12-ba4f-4a26081d403d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-37e0d2fe-28a5-43d6-a273-67d37d1f5606\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"identityDesignateMoreThanOneOwnerMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"diskEncryptionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"emailNotificationToSubscriptionOwnerHighSeverityAlertsEnabledEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"functionAppDisableRemoteDebuggingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"sqlDbEncryptionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vulnerabilityAssessmentOnManagedInstanceMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePHPVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"aadAuthenticationInSqlServerMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vmssEndpointProtectionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vmssOsVulnerabilitiesMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"adaptiveApplicationControlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"geoRedundantBackupShouldBeEnabledForAzureDatabaseForPostgreSQLEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"ensureJavaVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityDesignateLessThanOwnersMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"securityContactEmailAddressForSubscriptionEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"webAppRestrictCORSAccessMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveExternalAccountWithWritePermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveExternalAccountWithReadPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveDeprecatedAccountMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"functionAppEnforceHttpsMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"ensurePythonVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePythonVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePHPVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePythonVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"geoRedundantBackupShouldBeEnabledForAzureDatabaseForMySQLEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"systemUpdatesMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureJavaVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureHTTPVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"apiAppRequireLatestTlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityEnableMFAForWritePermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureHTTPVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureJavaVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"nextGenerationFirewallMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"useRbacRulesMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"webAppEnforceHttpsMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"sqlServerAuditingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vnetEnableDDoSProtectionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityEnableMFAForOwnerPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"sqlServerAdvancedDataSecurityMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"sqlManagedInstanceAdvancedDataSecurityMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"endpointProtectionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"jitNetworkAccessMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"apiAppEnforceHttpsMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"geoRedundantStorageShouldBeEnabledForStorageAccountsEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"vmssSystemUpdatesMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"webAppDisableRemoteDebuggingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"longtermGeoRedundantBackupEnabledAzureSQLDatabasesEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"systemConfigurationsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureHTTPVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityEnableMFAForReadPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"containerBenchmarkMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"apiAppDisableRemoteDebuggingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveDeprecatedAccountWithOwnerPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vulnerabilityAssessmentOnServerMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"webAppRequireLatestTlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveExternalAccountWithOwnerPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"functionAppRequireLatestTlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"kubernetesServiceVersionUpToDateMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"sqlDbVulnerabilityAssesmentMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"membersToExcludeInLocalAdministratorsGroup\": {\r\n    \"value\": \"admin\"\r\n  },\r\n  \"PHPLatestVersionForAppServices\": {\r\n    \"value\": \"7.4\"\r\n  },\r\n  \"JavaLatestVersionForAppServices\": {\r\n    \"value\": \"11\"\r\n  },\r\n  \"WindowsPythonLatestVersionForAppServices\": {\r\n    \"value\": \"3.6\"\r\n  },\r\n  \"LinuxPythonLatestVersionForAppServices\": {\r\n    \"value\": \"3.9\"\r\n  },\r\n  \"ensureDotNetFrameworkLatestForFunctionAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlManagedInstanceAdvancedDataSecurityEmailsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"vulnerabilityAssessmentMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"ensureDotNetFrameworkLatestForWebAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlServerAdvancedDataSecurityEmailsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"microsoftIaaSAntimalwareExtensionShouldBeDeployedOnWindowsServersEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"securityCenterStandardPricingTierShouldBeSelectedEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"theLogAnalyticsAgentShouldBeInstalledOnVirtualMachinesEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"ensurePHPVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlManagedInstanceAdvancedDataSecurityEmailAdminsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"securityContactPhoneNumberShouldBeProvidedForSubscriptionEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"threatDetectionTypesOnManagedInstanceMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"ensureDotNetFrameworkLatestForAPIAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlServerAdvancedDataSecurityEmailAdminsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"threatDetectionTypesOnServerMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"theLogAnalyticsAgentShouldBeInstalledOnVirtualMachineScaleSetsEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"NetworkWatcherResourceGroupName\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                                    "$fxv#3": "{\r\n  \"effect-09024ccc-0c5f-475e-9457-b7c0d9ed487b\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0961003e-5a0a-4549-abde-af6a37f2724d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0b15565f-aa9e-48ba-8619-45960f2c314d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0e60b895-3786-45da-8377-9c6b4b6ac5f9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-17k78e20-9358-41c9-923c-fb736d382a12\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-1bc1795e-d44a-4d48-9b3b-6fff0fd5f9ba\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"PHPLatestVersion\": {\r\n    \"value\": \"7.3\"\r\n  },\r\n  \"effect-22bee202-a82f-4305-9a2a-6d7f44d4dedb\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-26a828e1-e88f-464e-bbb3-c134a282b9de\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-34c877ad-507e-4c82-993e-3452a6e0ad3c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-3c735d8a-a4ba-4a3a-b7cf-db7754cf57f4\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-404c3081-a854-4457-ae30-26a93ef643f9\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-47a6b606-51aa-4496-8bb7-64b11cf66adc\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-496223c3-ad65-4ecd-878a-bae78737e9ed\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"JavaLatestVersion\": {\r\n    \"value\": \"11\"\r\n  },\r\n  \"effect-4f11b553-d42e-4e3a-89be-32ca364cad4c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-4f4f78b8-e367-4b10-a341-d9a4ad5cf1c7\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-5c607a2e-c700-4744-8254-d77e7c9eb5e4\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-5f76cf89-fbf2-47fd-a3f4-b891fa780b60\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-6b1cbf55-e8b6-442f-ba4c-7246b6381474\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-6d555dd1-86f2-4f1c-8ed7-5abae7c6cbab\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7008174a-fd10-4ef0-817e-fc820a951d73\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"LinuxPythonLatestVersion\": {\r\n    \"value\": \"3.8\"\r\n  },\r\n  \"effect-7238174a-fd10-4ef0-817e-fc820a951d73\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-7261b898-8a84-4db8-9e04-18527132abb3\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-74c3584d-afae-46f7-a20a-6f8adba71a16\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-86b3d65f-7626-441e-b690-81a8b71cff60\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-88999f4c-376a-45c8-bcb3-4058f713cf39\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-8c122334-9d20-4eb8-89ea-ac9a705b74ae\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-8cb6aa8b-9e41-4f4e-aa25-089a7ac2581e\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9297c21d-2ed6-4474-b48f-163f75654ce3\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-991310cd-e9f3-47bc-b7b6-f57b557d07db\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9b597639-28e4-48eb-b506-56b05d366257\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9d0b6ea4-93e2-4578-bf2f-6bb17d22b4bc\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9daedab3-fb2d-461e-b861-71790eead4f6\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-a4af4a39-4135-47fb-b175-47fbdf85311d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-a6fb4358-5bf4-4ad7-ba82-2cd2f41ce5e9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"setting-a6fb4358-5bf4-4ad7-ba82-2cd2f41ce5e9\": {\r\n    \"value\": \"enabled\"\r\n  },\r\n  \"effect-a70ca396-0a34-413a-88e1-b956c1e683be\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-aa633080-8b72-40c4-a2d7-d00c03e80bed\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-abfb4388-5bf4-4ad7-ba82-2cd2f41ceae9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-abfb7388-5bf4-4ad7-ba99-2cd2f41cebb9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-af6cd1bd-1635-48cb-bde7-5b15693900b9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b7ddfbdc-1260-477d-91fd-98bd9be789a6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c3f317a7-a95c-4547-b7e7-11017ebdf2fe\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-cb510bfd-1cba-4d9f-a230-cb0976f4bb71\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e1e5fd5d-3e4c-4ce1-8661-7d1873ae6b15\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e2c1c086-2d84-4019-bff3-c44ccd95113c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e3576e28-8b17-4677-84c3-db2990658d64\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e8cbc669-f12d-49eb-93e7-9273119e9933\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e9c8d085-d9cc-4b17-9cdc-059f1f01f19e\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ebb62a0c-3560-49e1-89ed-27e074e9f8ad\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-efbde977-ba53-4479-b8e9-10b957924fbf\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f0e6e85b-9b9f-4a4b-b67b-f730d42f1b0b\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f6de0be7-9a8a-4b8a-b349-43cf02d22f7c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f8456c1c-aa66-4dfb-861a-25d127b775c9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f9d614c5-c173-4d56-95a7-b4437057d193\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-fb893a29-21bb-418c-a157-e99480ec364c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-feedbf84-6b99-488c-acc2-71c829aa5ffc\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-3b980d31-7904-4bb7-8575-5665739a8052\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-6e2593d9-add6-4083-9c9b-4b7d2188c899\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b607c5de-e7d9-4eee-9e5c-83f1bcee4fa0\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-12430be1-6cc8-4527-a9a8-e3d38f250096\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"modeRequirement-12430be1-6cc8-4527-a9a8-e3d38f250096\": {\r\n    \"value\": \"Detection\"\r\n  },\r\n  \"effect-425bea59-a659-4cbb-8d31-34499bd030b8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"modeRequirement-425bea59-a659-4cbb-8d31-34499bd030b8\": {\r\n    \"value\": \"Detection\"\r\n  },\r\n  \"effect-564feb30-bf6a-4854-b4bb-0d2d2d1e6c66\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-055aa869-bc98-4af8-bafc-23f1ab6ffe2c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-013e242c-8828-4970-87b3-ab247555486d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-d38fc420-0735-4ef3-ac11-c806f651a570\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-a1181c5f-672a-477a-979a-7d58aa086233\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-308fbb08-4ab8-4e67-9b29-592e93fb94fa\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-4da35fc9-c9e7-4960-aec9-797fe7d9051d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-523b5cd1-3e23-492f-a539-13118b6d1e3a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-7fe3b40f-802b-4cdd-8bd4-fd799c948cc2\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-c25d9a16-bc35-4e15-a7e5-9db606bf9ed4\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b0f33259-77d7-4c9e-aac6-3aabcfae693c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-037eea7a-bd0a-46c5-9a66-03aea78705d3\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0725b4dd-7e76-479c-a735-68e7ee23d5ca\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0820b7b9-23aa-4725-a1ce-ae4558f718e5\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-2c89a2e5-7285-40fe-afe0-ae8654b92fab\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-358c20a6-3f9e-4f0e-97ff-c6ce485e2aac\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-5744710e-cc2f-4ee8-8809-3b11e89f4bc9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ac4a19c2-fa67-49b4-8ae5-0b2e78c49457\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c9d007d0-c057-4772-b18c-01e546713bcd\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d0793b48-0edc-4296-a390-4c75d1bdfd71\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-e372f825-a257-4fb8-9175-797a8a8627d6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d158790f-bfb0-486c-8631-2dc6b4e8e6af\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-e802a67a-daf5-4436-9ea6-f6d821dd0c5d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-a451c1ef-c6ca-483d-87ed-f49761e3ffb5\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftSql-servers-firewallRules-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftNetwork-networkSecurityGroups-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftClassicNetwork-networkSecurityGroups-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftNetwork-networkSecurityGroups-securityRules-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftClassicNetwork-networkSecurityGroups-securityRules-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ae89ebca-1c92-4898-ac2c-9f63decb045c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-d26f7642-7545-4e18-9b75-8c9bbdee3a9a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-1a4e592a-6a6e-44a5-9814-e36264ca96e7\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-7796937f-307b-4598-941c-67d3a05ebfe7\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-c5447c04-a4d7-4ba8-a263-c9ee321a6858\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-41388f1c-2db0-4c25-95b2-35d7f5ccbfa9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b02aacc0-b073-424e-8298-42b22829ee0a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-057d6cfe-9c4f-4a6d-bc60-14420ea1f1a9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0ec47710-77ff-4a3d-9181-6aa50af424d0\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-48af4db5-9b8b-401c-8e74-076be876a430\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-82339799-d096-41ae-8538-b108becf0970\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1b7aa243-30e4-4c9e-bca8-d0d3022b634a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ef2a8f2a-b3d9-49cd-a8a8-9a3aaaf647d9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-bb91dfba-c30d-4263-9add-9c2384e659a6\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e71308d3-144b-4262-b144-efdc3cc90517\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-2bdd0062-9d75-436e-89df-487dd8e4b3c7\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"effect-4733ea7b-a883-42fe-8cac-97454c2a9e4a\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-67121cc7-ff39-4ab8-b7e3-95b84dab487d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-6fac406b-40ca-413b-bf8e-0bf964659c25\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-81e74cea-30fd-40d5-802f-d72103c2aaaa\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c349d81b-9985-44ae-a8da-ff98d108ede8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-f4b53539-8df9-40e4-86c6-6b607703bd4e\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ec068d99-e9c7-401f-8cef-5bdde4e6ccf1\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-048248b0-55cd-46da-b1ff-39efd52db260\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0d134df8-db83-46fb-ad72-fe0c9428c8dd\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-2c89a2e5-7285-40fe-afe0-ae8654b92fb2\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-3657f5a0-770e-44a3-b44e-9431ba1e9735\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-5b9159ae-1701-4a6f-9a7a-aa9c8ddd0580\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-617c02be-7f02-4efd-8836-3180d47b6c68\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7d7be79c-23ba-4033-84dd-45e2a5ccdd67\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-87ba29ef-1ab3-4d82-b763-87fcd4f531f7\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-f7d52b2d-e161-4dfa-a82b-55e564167385\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c43e4a30-77cb-48ab-a4dd-93f175c63b57\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0b60c0b2-2dc2-4e1c-b5c9-abbed971de53\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1e66c121-a66a-4b1f-9b83-0fd99bf0fc2d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1f314764-cb73-4fc9-b863-8eca98ac36e9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-123a3936-f020-408a-ba0c-47873faf1534\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"resourceGroupName-b6e2945c-0b7b-40f5-9233-7a5323b5cdc6\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                                    "modifiedAssignment": "[if(and(equals(toLower(environment().name), toLower('AzureCloud')), equals(toLower(parameters('builtInAssignment')), toLower('IL5'))), 'NISTRev4', parameters('builtInAssignment'))]",
                                    "assignmentName": "[format('{0} {1}', variables('modifiedAssignment'), resourceGroup().name)]",
                                    "agentVmssAssignmentName": "[format('Deploy VMSS Agents {0}', resourceGroup().name)]",
                                    "agentVmAssignmentName": "[format('Deploy VM Agents {0}', resourceGroup().name)]",
                                    "contributorRoleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                    "lawsReaderRoleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '92aaf0da-9dab-42b6-94a3-d43ce8d16293')]"
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Authorization/policyAssignments",
                                      "apiVersion": "2020-09-01",
                                      "name": "[variables('assignmentName')]",
                                      "location": "[parameters('location')]",
                                      "properties": {
                                        "policyDefinitionId": "[createObject('NISTRev4', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/cf25b9c1-bd23-4eb6-bd2c-f4f3ac644a5f', 'parameters', union(json(variables('$fxv#0')), createObject('listOfMembersToIncludeInWindowsVMAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership')), 'logAnalyticsWorkspaceIdforVMReporting', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]))))), 'NISTRev5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/179d1daa-458f-4e47-8086-2a68d0d6c38f', 'parameters', json(variables('$fxv#1'))), 'IL5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/f9a961fa-3241-4b20-adc4-bbf8ad9d7197', 'parameters', union(json(variables('$fxv#2')), createObject('logAnalyticsWorkspaceIDForVMAgents', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])), 'membersToIncludeInLocalAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership'))))), 'CMMC', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/b5629c75-5c77-4422-87b9-2509e680f8de', 'parameters', union(json(variables('$fxv#3')), createObject('logAnalyticsWorkspaceId-f47b5582-33ec-4c5c-87c0-b010a6b2e917', createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]), '2021-06-01').customerId)), if(equals('AzureCloud', environment().name), createObject('MembersToExclude-69bf4abd-ca1e-4cf6-8b5a-762d42e61d4f', createObject('value', 'admin'), 'MembersToInclude-30f71ea1-ac77-4f26-9fc5-2d926bbd4ba7', createObject('value', parameters('windowsAdministratorsGroupMembership'))), createObject()))))[variables('modifiedAssignment')].id]",
                                        "parameters": "[createObject('NISTRev4', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/cf25b9c1-bd23-4eb6-bd2c-f4f3ac644a5f', 'parameters', union(json(variables('$fxv#0')), createObject('listOfMembersToIncludeInWindowsVMAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership')), 'logAnalyticsWorkspaceIdforVMReporting', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]))))), 'NISTRev5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/179d1daa-458f-4e47-8086-2a68d0d6c38f', 'parameters', json(variables('$fxv#1'))), 'IL5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/f9a961fa-3241-4b20-adc4-bbf8ad9d7197', 'parameters', union(json(variables('$fxv#2')), createObject('logAnalyticsWorkspaceIDForVMAgents', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])), 'membersToIncludeInLocalAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership'))))), 'CMMC', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/b5629c75-5c77-4422-87b9-2509e680f8de', 'parameters', union(json(variables('$fxv#3')), createObject('logAnalyticsWorkspaceId-f47b5582-33ec-4c5c-87c0-b010a6b2e917', createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]), '2021-06-01').customerId)), if(equals('AzureCloud', environment().name), createObject('MembersToExclude-69bf4abd-ca1e-4cf6-8b5a-762d42e61d4f', createObject('value', 'admin'), 'MembersToInclude-30f71ea1-ac77-4f26-9fc5-2d926bbd4ba7', createObject('value', parameters('windowsAdministratorsGroupMembership'))), createObject()))))[variables('modifiedAssignment')].parameters]"
                                      },
                                      "identity": {
                                        "type": "SystemAssigned"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Authorization/policyAssignments",
                                      "apiVersion": "2020-09-01",
                                      "name": "[variables('agentVmssAssignmentName')]",
                                      "location": "[parameters('location')]",
                                      "properties": {
                                        "policyDefinitionId": "[tenantResourceId('Microsoft.Authorization/policySetDefinitions', '75714362-cae7-409e-9b99-a8e5075b7fad')]",
                                        "parameters": {
                                          "logAnalytics_1": {
                                            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])]"
                                          }
                                        }
                                      },
                                      "identity": {
                                        "type": "SystemAssigned"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Authorization/policyAssignments",
                                      "apiVersion": "2020-09-01",
                                      "name": "[variables('agentVmAssignmentName')]",
                                      "location": "[parameters('location')]",
                                      "properties": {
                                        "policyDefinitionId": "[tenantResourceId('Microsoft.Authorization/policySetDefinitions', '55f3eceb-5573-4f18-9695-226972c6d74a')]",
                                        "parameters": {
                                          "logAnalytics_1": {
                                            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])]"
                                          }
                                        }
                                      },
                                      "identity": {
                                        "type": "SystemAssigned"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "name": "[guid(variables('contributorRoleDefinitionId'), variables('assignmentName'))]",
                                      "properties": {
                                        "roleDefinitionId": "[variables('contributorRoleDefinitionId')]",
                                        "principalId": "[if(empty(variables('modifiedAssignment')), '', reference(resourceId('Microsoft.Authorization/policyAssignments', variables('assignmentName')), '2020-09-01', 'full').identity.principalId)]",
                                        "principalType": "ServicePrincipal"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('assignmentName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "name": "[guid(variables('contributorRoleDefinitionId'), variables('agentVmssAssignmentName'))]",
                                      "properties": {
                                        "roleDefinitionId": "[variables('contributorRoleDefinitionId')]",
                                        "principalId": "[reference(resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmssAssignmentName')), '2020-09-01', 'full').identity.principalId]",
                                        "principalType": "ServicePrincipal"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmssAssignmentName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "name": "[guid(variables('contributorRoleDefinitionId'), variables('agentVmAssignmentName'))]",
                                      "properties": {
                                        "roleDefinitionId": "[variables('contributorRoleDefinitionId')]",
                                        "principalId": "[reference(resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName')), '2020-09-01', 'full').identity.principalId]",
                                        "principalType": "ServicePrincipal"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]"
                                      ]
                                    },
                                    {
                                      "condition": "[parameters('deployRemediation')]",
                                      "type": "Microsoft.PolicyInsights/remediations",
                                      "apiVersion": "2019-07-01",
                                      "name": "VM-Agent-Policy-Remediation",
                                      "properties": {
                                        "policyAssignmentId": "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]",
                                        "resourceDiscoveryMode": "ReEvaluateCompliance"
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]"
                                      ]
                                    },
                                    {
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('Assign-Laws-Role-Policy-{0}', resourceGroup().name)]",
                                      "subscriptionId": "[split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2]]",
                                      "resourceGroup": "[split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "targetResourceId": {
                                            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])]"
                                          },
                                          "roleDefinitionId": {
                                            "value": "[variables('lawsReaderRoleDefinitionId')]"
                                          },
                                          "principalId": {
                                            "value": "[reference(resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName')), '2020-09-01', 'full').identity.principalId]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.40.2.10011",
                                              "templateHash": "14523277430573151351"
                                            }
                                          },
                                          "parameters": {
                                            "targetResourceId": {
                                              "type": "string"
                                            },
                                            "roleDefinitionId": {
                                              "type": "string"
                                            },
                                            "principalId": {
                                              "type": "string"
                                            },
                                            "principalType": {
                                              "type": "string",
                                              "defaultValue": "ServicePrincipal",
                                              "allowedValues": [
                                                "ForeignGroup",
                                                "Group",
                                                "ServicePrincipal",
                                                "User"
                                              ]
                                            },
                                            "description": {
                                              "type": "string",
                                              "defaultValue": ""
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Authorization/roleAssignments",
                                              "apiVersion": "2020-04-01-preview",
                                              "name": "[guid(parameters('targetResourceId'), parameters('roleDefinitionId'), parameters('principalId'))]",
                                              "properties": {
                                                "principalId": "[parameters('principalId')]",
                                                "principalType": "[parameters('principalType')]",
                                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                                "description": "[parameters('description')]"
                                              }
                                            }
                                          ]
                                        }
                                      },
                                      "dependsOn": [
                                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]"
                                      ]
                                    }
                                  ]
                                }
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "condition": "[parameters('deployDefender')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('set-defender-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "emailSecurityContact": {
                            "value": "[parameters('emailSecurityContact')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "1552299118443631720"
                            }
                          },
                          "parameters": {
                            "defenderPlans": {
                              "type": "array",
                              "defaultValue": [
                                "VirtualMachines"
                              ],
                              "metadata": {
                                "description": "Defender Paid protection Plans. Even if a customer selects the free sku, at least 1 paid protection plan must be specified."
                              }
                            },
                            "emailSecurityContact": {
                              "type": "string",
                              "metadata": {
                                "description": "Email address of the contact, in the form of john@doe.com"
                              }
                            },
                            "policySetDescription": {
                              "type": "string",
                              "defaultValue": "The Microsoft Cloud Security Benchmark initiative represents the policies and controls implementing security recommendations defined in Microsoft Cloud Security Benchmark v2, see https://aka.ms/azsecbm. This also serves as the Microsoft Defender for Cloud default policy initiative. You can directly assign this initiative, or manage its policies and compliance results within Microsoft Defender.",
                              "metadata": {
                                "description": "Policy Initiative description field"
                              }
                            },
                            "defenderSkuTier": {
                              "type": "string",
                              "defaultValue": "Free",
                              "metadata": {
                                "description": "[Standard/Free] The SKU for Defender. It defaults to \"Free\"."
                              }
                            }
                          },
                          "variables": {
                            "defenderPaidPlanConfig": {
                              "AzureCloud": {
                                "Api": {
                                  "subPlan": "P1"
                                },
                                "appServices": {},
                                "KeyVaults": {
                                  "subPlan": "PerKeyVault"
                                },
                                "Arm": {
                                  "subPlan": "PerSubscription"
                                },
                                "CloudPosture": {
                                  "extensions": [
                                    {
                                      "name": "SensitiveDataDiscovery",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "ContainerRegistriesVulnerabilityAssessments",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "AgentlessDiscoveryForKubernetes",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "AgentlessVmScanning",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "EntraPermissionsManagement",
                                      "isEnabled": "True"
                                    }
                                  ]
                                },
                                "Containers": {
                                  "extensions": [
                                    {
                                      "name": "ContainerRegistriesVulnerabilityAssessments",
                                      "isEnabled": "True"
                                    },
                                    {
                                      "name": "AgentlessDiscoveryForKubernetes",
                                      "isEnabled": "True"
                                    }
                                  ]
                                },
                                "CosmosDbs": {},
                                "StorageAccounts": {
                                  "subPlan": "DefenderForStorageV2",
                                  "extensions": [
                                    {
                                      "name": "OnUploadMalwareScanning",
                                      "isEnabled": "True",
                                      "additionalExtensionProperties": {
                                        "CapGBPerMonthPerStorageAccount": "5000"
                                      }
                                    },
                                    {
                                      "name": "SensitiveDataDiscovery",
                                      "isEnabled": "True"
                                    }
                                  ]
                                },
                                "VirtualMachines": {
                                  "subPlan": "P1"
                                },
                                "SqlServerVirtualMachines": {},
                                "SqlServers": {},
                                "OpenSourceRelationalDatabases": {}
                              }
                            }
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "defenderFreeAllClouds",
                                "count": "[length(parameters('defenderPlans'))]",
                                "mode": "serial",
                                "batchSize": 1
                              },
                              "condition": "[equals(parameters('defenderSkuTier'), 'Free')]",
                              "type": "Microsoft.Security/pricings",
                              "apiVersion": "2023-01-01",
                              "name": "[parameters('defenderPlans')[copyIndex()]]",
                              "properties": {
                                "pricingTier": "[parameters('defenderSkuTier')]"
                              }
                            },
                            {
                              "copy": {
                                "name": "defenderStandardNoSubplanNoExtensions",
                                "count": "[length(parameters('defenderPlans'))]",
                                "mode": "serial",
                                "batchSize": 1
                              },
                              "condition": "[and(equals(parameters('defenderSkuTier'), 'Standard'), not(equals(environment().name, 'AzureCloud')))]",
                              "type": "Microsoft.Security/pricings",
                              "apiVersion": "2023-01-01",
                              "name": "[parameters('defenderPlans')[copyIndex()]]",
                              "properties": {
                                "pricingTier": "[parameters('defenderSkuTier')]"
                              }
                            },
                            {
                              "copy": {
                                "name": "defenderStandardSubplanExtensionsAzureCloud",
                                "count": "[length(parameters('defenderPlans'))]",
                                "mode": "serial",
                                "batchSize": 1
                              },
                              "condition": "[and(equals(parameters('defenderSkuTier'), 'Standard'), equals(environment().name, 'AzureCloud'))]",
                              "type": "Microsoft.Security/pricings",
                              "apiVersion": "2023-01-01",
                              "name": "[parameters('defenderPlans')[copyIndex()]]",
                              "properties": {
                                "pricingTier": "[parameters('defenderSkuTier')]",
                                "subPlan": "[coalesce(tryGet(variables('defenderPaidPlanConfig')[environment().name][parameters('defenderPlans')[copyIndex()]], 'subPlan'), null())]",
                                "extensions": "[coalesce(tryGet(variables('defenderPaidPlanConfig')[environment().name][parameters('defenderPlans')[copyIndex()]], 'extensions'), null())]"
                              }
                            },
                            {
                              "condition": "[not(empty(parameters('emailSecurityContact')))]",
                              "type": "Microsoft.Security/securityContacts",
                              "apiVersion": "2020-01-01-preview",
                              "name": "default",
                              "properties": {
                                "notificationsByRole": {
                                  "roles": [
                                    "AccountAdmin",
                                    "Contributor",
                                    "Owner",
                                    "ServiceAdmin"
                                  ],
                                  "state": "On"
                                },
                                "alertNotifications": {
                                  "state": "On"
                                },
                                "emails": "[parameters('emailSecurityContact')]"
                              }
                            },
                            {
                              "type": "Microsoft.Authorization/policyAssignments",
                              "apiVersion": "2022-06-01",
                              "name": "Microsoft Cloud Security Benchmark",
                              "properties": {
                                "displayName": "Defender Default",
                                "description": "[parameters('policySetDescription')]",
                                "enforcementMode": "DoNotEnforce",
                                "parameters": {},
                                "policyDefinitionId": "[tenantResourceId('Microsoft.Authorization/policySetDefinitions', '1f3afdf9-d0c9-4c3d-847f-89da613e70a8')]"
                              }
                            }
                          ]
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "delimiter": {
                      "type": "string",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                    },
                    "locationProperties": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.locationProperties.value]"
                    },
                    "mlzTags": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                    },
                    "privateDnsZones": {
                      "type": "array",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZones.value]"
                    },
                    "resourceAbbreviations": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
                    },
                    "tier": {
                      "type": "object",
                      "value": "[union(createObject('dnsServers', coalesce(tryGet(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hubVirtualNetworkResourceId'), '/')[2], split(parameters('hubVirtualNetworkResourceId'), '/')[4]), 'Microsoft.Network/virtualNetworks', split(parameters('hubVirtualNetworkResourceId'), '/')[8]), '2023-11-01'), 'dhcpOptions', 'dnsServers'), createArray()), 'logAnalyticsWorkspaceResourceId', parameters('logAnalyticsWorkspaceResourceId')), reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value)]"
                    },
                    "tokens": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-network-{0}-{1}{2}', parameters('workloadShortName'), variables('deploymentIndex'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-rg-{0}', parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "name": {
                    "value": "[replace(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.namingConvention.resourceGroup, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value.purpose, 'stamp')]"
                  },
                  "tags": {
                    "value": "[union(createObject('cm-resource-parent', resourceId(subscription().subscriptionId, replace(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.namingConvention.resourceGroup, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value.purpose, 'stamp'), 'Microsoft.DesktopVirtualization/hostpools', replace(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.namingConvention.hostPool, format('{0}{1}', reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value.purpose), ''))), coalesce(tryGet(parameters('tags'), 'Microsoft.Resources/resourceGroups'), createObject()), reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value)]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "29921048879103880"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/resourceGroups",
                      "apiVersion": "2019-05-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "location": {
                      "type": "string",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').location]"
                    },
                    "tags": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').tags]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-management-{0}', parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "avdObjectId": {
                    "value": "[parameters('avdObjectId')]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "environmentAbbreviation": {
                    "value": "[parameters('environmentAbbreviation')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "logAnalyticsWorkspaceRetention": {
                    "value": "[parameters('logAnalyticsWorkspaceRetention')]"
                  },
                  "logAnalyticsWorkspaceSku": {
                    "value": "[parameters('logAnalyticsWorkspaceSku')]"
                  },
                  "privateDnsZoneResourceIdPrefix": {
                    "value": "[variables('privateDnsZoneResourceIdPrefix')]"
                  },
                  "privateLinkScopeResourceId": {
                    "value": "[parameters('privateLinkScopeResourceId')]"
                  },
                  "resourceGroupName": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                  },
                  "subscriptionId": {
                    "value": "[variables('subscriptionId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tier": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value]"
                  },
                  "delimiter": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                  },
                  "tokens": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                  },
                  "mlzTags": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                  },
                  "namingConvention": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.namingConvention]"
                  },
                  "privateDnsZones": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZones.value]"
                  },
                  "resourceAbbreviations": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "11832918720549642619"
                    }
                  },
                  "parameters": {
                    "avdObjectId": {
                      "type": "string"
                    },
                    "delimiter": {
                      "type": "string"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "environmentAbbreviation": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceRetention": {
                      "type": "int"
                    },
                    "logAnalyticsWorkspaceSku": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "namingConvention": {
                      "type": "object"
                    },
                    "privateDnsZoneResourceIdPrefix": {
                      "type": "string"
                    },
                    "privateDnsZones": {
                      "type": "array"
                    },
                    "privateLinkScopeResourceId": {
                      "type": "string"
                    },
                    "resourceAbbreviations": {
                      "type": "object"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "subscriptionId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "tier": {
                      "type": "object"
                    },
                    "tokens": {
                      "type": "object"
                    }
                  },
                  "variables": {
                    "hostPoolResourceId": "[resourceId(parameters('subscriptionId'), parameters('resourceGroupName'), 'Microsoft.DesktopVirtualization/hostPools', replace(parameters('namingConvention').hostPool, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "name": "[guid(parameters('avdObjectId'), '40c5ff49-9181-41f8-ae61-143b0e78555e', subscription().id)]",
                      "properties": {
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '40c5ff49-9181-41f8-ae61-143b0e78555e')]",
                        "principalId": "[parameters('avdObjectId')]"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/policyDefinitions",
                      "apiVersion": "2021-06-01",
                      "name": "DiskNetworkAccess",
                      "properties": {
                        "description": "Disable network access to managed disks.",
                        "displayName": "Disable Disk Access",
                        "mode": "All",
                        "parameters": "[if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-disk-access-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value)), createObject('diskAccessId', createObject('type', 'String', 'metadata', createObject('displayName', 'Disk Access Resource Id', 'description', 'The resource Id of the Disk Access to associate to the managed disks.'))), createObject())]",
                        "policyRule": {
                          "if": {
                            "field": "type",
                            "equals": "Microsoft.Compute/disks"
                          },
                          "then": {
                            "effect": "modify",
                            "details": {
                              "roleDefinitionIds": [
                                "/providers/Microsoft.Authorization/roleDefinitions/60fc6e62-5479-42d4-8bf4-67625fcc2840"
                              ],
                              "operations": "[if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-disk-access-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value)), createArray(createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/networkAccessPolicy', 'value', 'AllowPrivate'), createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/publicNetworkAccess', 'value', 'Disabled'), createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/diskAccessId', 'value', '[parameters(''diskAccessId'')]')), createArray(createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/networkAccessPolicy', 'value', 'DenyAll'), createObject('operation', 'addOrReplace', 'field', 'Microsoft.Compute/disks/publicNetworkAccess', 'value', 'Disabled')))]"
                            }
                          }
                        },
                        "policyType": "Custom"
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-disk-access-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-id-deployment-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "name": {
                            "value": "[replace(parameters('namingConvention').userAssignedIdentity, parameters('tokens').purpose, 'deployment')]"
                          },
                          "tags": {
                            "value": "[union(createObject('cm-resource-parent', variables('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.ManagedIdentity/userAssignedIdentities'), createObject()), parameters('mlzTags'))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "9810615193058257189"
                            }
                          },
                          "parameters": {
                            "location": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                              "apiVersion": "2018-11-30",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]"
                            }
                          ],
                          "outputs": {
                            "clientId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2018-11-30').clientId]"
                            },
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name'))]"
                            },
                            "principalId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2018-11-30').principalId]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-disk-access-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "azureBlobsPrivateDnsZoneResourceId": {
                            "value": "[format('{0}{1}', parameters('privateDnsZoneResourceIdPrefix'), filter(parameters('privateDnsZones'), lambda('name', contains(lambdaVariables('name'), 'blob')))[0])]"
                          },
                          "delimiter": {
                            "value": "[parameters('delimiter')]"
                          },
                          "hostPoolResourceId": {
                            "value": "[variables('hostPoolResourceId')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "names": {
                            "value": "[parameters('tier').namingConvention]"
                          },
                          "subnetResourceId": {
                            "value": "[parameters('tier').subnets[0].id]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "tokens": {
                            "value": "[parameters('tokens')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "17691446981305393727"
                            }
                          },
                          "parameters": {
                            "azureBlobsPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "delimiter": {
                              "type": "string"
                            },
                            "hostPoolResourceId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "names": {
                              "type": "object"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "tokens": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Compute/diskAccesses",
                              "apiVersion": "2021-04-01",
                              "name": "[replace(parameters('names').diskAccess, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/diskAccesses'), createObject()), parameters('mlzTags'))]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints",
                              "apiVersion": "2023-04-01",
                              "name": "[replace(parameters('names').diskAccessPrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "customNetworkInterfaceName": "[replace(parameters('names').diskAccessNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                "privateLinkServiceConnections": [
                                  {
                                    "name": "[replace(parameters('names').diskAccessPrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]",
                                    "properties": {
                                      "privateLinkServiceId": "[resourceId('Microsoft.Compute/diskAccesses', replace(parameters('names').diskAccess, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''))]",
                                      "groupIds": [
                                        "disks"
                                      ]
                                    }
                                  }
                                ],
                                "subnet": {
                                  "id": "[parameters('subnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/diskAccesses', replace(parameters('names').diskAccess, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2021-08-01",
                              "name": "[format('{0}/{1}', replace(parameters('names').diskAccessPrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''), replace(parameters('names').diskAccess, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''))]",
                              "properties": {
                                "privateDnsZoneConfigs": [
                                  {
                                    "name": "ipconfig1",
                                    "properties": {
                                      "privateDnsZoneId": "[parameters('azureBlobsPrivateDnsZoneResourceId')]"
                                    }
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/diskAccesses', replace(parameters('names').diskAccess, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''))]",
                                "[resourceId('Microsoft.Network/privateEndpoints', replace(parameters('names').diskAccessPrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Compute/diskAccesses', replace(parameters('names').diskAccess, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''))]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('assign-policy-diskAccess-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "diskAccessResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-disk-access-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "policyDefinitionId": {
                            "value": "[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', 'DiskNetworkAccess')]"
                          },
                          "policyDisplayName": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Authorization/policyDefinitions', 'DiskNetworkAccess'), '2021-06-01').displayName]"
                          },
                          "policyName": {
                            "value": "[reference(subscriptionResourceId('Microsoft.Authorization/policyDefinitions', 'DiskNetworkAccess'), '2021-06-01').displayName]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "3894470118876690045"
                            }
                          },
                          "parameters": {
                            "diskAccessResourceId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "policyDefinitionId": {
                              "type": "string"
                            },
                            "policyDisplayName": {
                              "type": "string"
                            },
                            "policyName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/policyAssignments",
                              "apiVersion": "2022-06-01",
                              "name": "[parameters('policyName')]",
                              "location": "[parameters('location')]",
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "properties": {
                                "displayName": "[parameters('policyDisplayName')]",
                                "policyDefinitionId": "[parameters('policyDefinitionId')]",
                                "parameters": "[if(not(empty(parameters('diskAccessResourceId'))), createObject('diskAccessId', createObject('value', parameters('diskAccessResourceId'))), createObject())]"
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-disk-access-{0}', parameters('deploymentNameSuffix')))]",
                        "[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', 'DiskNetworkAccess')]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-cmk-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "environmentAbbreviation": {
                            "value": "[parameters('environmentAbbreviation')]"
                          },
                          "keyName": {
                            "value": "[replace(parameters('tier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, 'cmk')]"
                          },
                          "keyVaultPrivateDnsZoneResourceId": {
                            "value": "[format('{0}{1}', parameters('privateDnsZoneResourceIdPrefix'), filter(parameters('privateDnsZones'), lambda('name', contains(lambdaVariables('name'), 'vaultcore')))[0])]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "resourceAbbreviations": {
                            "value": "[parameters('resourceAbbreviations')]"
                          },
                          "subnetResourceId": {
                            "value": "[parameters('tier').subnets[0].id]"
                          },
                          "tags": {
                            "value": "[union(createObject('cm-resource-parent', variables('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]"
                          },
                          "tier": {
                            "value": "[parameters('tier')]"
                          },
                          "tokens": {
                            "value": "[parameters('tokens')]"
                          },
                          "type": {
                            "value": "virtualMachine"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "16154764937040063236"
                            }
                          },
                          "parameters": {
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "environmentAbbreviation": {
                              "type": "string"
                            },
                            "keyExpirationInDays": {
                              "type": "int",
                              "defaultValue": 30
                            },
                            "keyName": {
                              "type": "string"
                            },
                            "keyVaultPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "resourceAbbreviations": {
                              "type": "object"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "tier": {
                              "type": "object"
                            },
                            "tokens": {
                              "type": "object"
                            },
                            "type": {
                              "type": "string",
                              "allowedValues": [
                                "storageAccount",
                                "virtualMachine"
                              ]
                            },
                            "virtualMachineAdminPassword": {
                              "type": "securestring",
                              "defaultValue": "[newGuid()]"
                            },
                            "virtualMachineAdminUsername": {
                              "type": "string",
                              "defaultValue": "xadmin"
                            },
                            "virtualMachineSize": {
                              "type": "string",
                              "defaultValue": "Standard_D2ds_v4"
                            }
                          },
                          "variables": {
                            "$fxv#0": "Param(\r\n    [string]$DiskEncryptionSetName,\r\n    [int]$KeyExpirationInDays,\r\n    [string]$KeyName,\r\n    [string]$KeyVaultResourceId,\r\n    [string]$KeyVaultServiceUri,\r\n    [string]$KeyVaultUri,\r\n    [string]$Location,\r\n    [string]$ResourceGroupName,\r\n    [string]$ResourceManagerUri,\r\n    [string]$SubscriptionId,\r\n    [string]$Type,\r\n    [string]$UserAssignedIdentityClientId\r\n)\r\n\r\n$ErrorActionPreference = 'Stop'\r\n$WarningPreference = 'SilentlyContinue'\r\n\r\n# Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n$ResourceManagerUriFixed = if ($ResourceManagerUri[-1] -eq '/') { $ResourceManagerUri.Substring(0, $ResourceManagerUri.Length - 1) } else { $ResourceManagerUri }\r\n\r\n# Get an access token for Azure resources\r\n$KeyVaultAccessToken = (Invoke-RestMethod `\r\n        -Headers @{Metadata = \"true\" } `\r\n        -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $KeyVaultServiceUri + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n# Set header for Azure Management API\r\n$KeyVaultHeaders = @{\r\n    'Content-Type'  = 'application/json'\r\n    'Authorization' = 'Bearer ' + $KeyVaultAccessToken\r\n}\r\n\r\n$Body = [PSCustomObject]@{\r\n    kty            = 'RSA-HSM'\r\n    key_size       = 4096\r\n    attributes     = @{\r\n        enabled = $true\r\n    }\r\n    rotationPolicy = @{\r\n        attributes      = @{\r\n            expiryTime = $('P' + $KeyExpirationInDays + 'D')\r\n        }\r\n        lifetimeActions = @(\r\n            @{\r\n                action  = @{\r\n                    type = 'Notify'\r\n                }\r\n                trigger = @{\r\n                    timeBeforeExpiry = 'P10D'\r\n                }\r\n            },\r\n            @{\r\n                action  = @{\r\n                    type = 'Rotate'\r\n                }\r\n                trigger = @{\r\n                    timeAfterCreate = $('P' + ($KeyExpirationInDays - 7) + 'D')\r\n                }\r\n            }\r\n        )\r\n    }\r\n}\r\n\r\n# Create key vault key\r\n$KeyUriWithVersion = (Invoke-RestMethod `\r\n        -Body ($Body | ConvertTo-Json -Depth 4) `\r\n        -Headers $KeyVaultHeaders `\r\n        -Method 'POST' `\r\n        -Uri $($KeyVaultUri + 'keys/' + $KeyName + '/create?api-version=2025-07-01')).key.kid\r\n\r\nif ($Type -eq 'virtualMachine') {\r\n\r\n    # Get an access token for Azure resources\r\n    $ResourceManagerAccessToken = (Invoke-RestMethod `\r\n            -Headers @{Metadata = \"true\" } `\r\n            -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n    # Set header for Azure Management API\r\n    $ResourceManagerHeaders = @{\r\n        'Content-Type'  = 'application/json'\r\n        'Authorization' = 'Bearer ' + $ResourceManagerAccessToken\r\n    }\r\n\r\n    $DiskEncryptionSetBody = @{\r\n        location   = $Location\r\n        identity   = @{\r\n            type = 'SystemAssigned'\r\n        }\r\n        properties = @{\r\n            activeKey                         = @{\r\n                sourceVault = @{\r\n                    id = $KeyVaultResourceId\r\n                }\r\n                keyUrl = $KeyUriWithVersion\r\n            }\r\n            encryptionType                    = 'EncryptionAtRestWithPlatformAndCustomerKeys'\r\n            rotationToLatestKeyVersionEnabled = $true\r\n        }\r\n    }\r\n\r\n    Invoke-RestMethod `\r\n        -Body ($DiskEncryptionSetBody | ConvertTo-Json -Depth 4) `\r\n        -Headers $ResourceManagerHeaders `\r\n        -Method 'PUT' `\r\n        -Uri $($ResourceManagerUriFixed + '/subscriptions/' + $SubscriptionId + '/resourceGroups/' + $ResourceGroupName + '/providers/Microsoft.Compute/diskEncryptionSets/' + $DiskEncryptionSetName + '?api-version=2025-01-02')\r\n}",
                            "$fxv#1": "param(\r\n    [string]$ResourceGroupName,\r\n    [string]$ResourceManagerUri,\r\n    [string]$UserAssignedIdentityClientId,\r\n    [string]$VirtualMachineResourceId\r\n)\r\n\r\n# Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n$ResourceManagerUriFixed = if($ResourceManagerUri[-1] -eq '/'){$ResourceManagerUri.Substring(0,$ResourceManagerUri.Length - 1)} else {$ResourceManagerUri}\r\n\r\n# Get an access token for Azure resources\r\n$AzureManagementAccessToken = (Invoke-RestMethod `\r\n    -Headers @{Metadata=\"true\"} `\r\n    -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n# Set header for Azure Management API\r\n$AzureManagementHeader = @{\r\n    'Content-Type'='application/json'\r\n    'Authorization'='Bearer ' + $AzureManagementAccessToken\r\n}\r\n\r\nStart-Sleep -Seconds 30\r\n\r\n# Use the access token to delete the virtual machine\r\nInvoke-RestMethod `\r\n    -Headers $AzureManagementHeader `\r\n    -Method 'Delete' `\r\n    -Uri $($ResourceManagerUriFixed + $VirtualMachineResourceId + '?forceDeletion=true&api-version=2024-07-01') | Out-Null",
                            "keyVaultPrivateEndpointName": "[replace(parameters('tier').namingConvention.keyVaultPrivateEndpoint, parameters('tokens').purpose, variables('workload'))]",
                            "resourceGroupName": "[resourceGroup().name]",
                            "userAssignedIdentityName": "[replace(parameters('tier').namingConvention.userAssignedIdentity, parameters('tokens').purpose, variables('workload'))]",
                            "virtualMachineName": "[replace(parameters('tier').namingConvention.virtualMachine, parameters('tokens').purpose, variables('workload'))]",
                            "workload": "cmk"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                              "apiVersion": "2018-11-30",
                              "name": "[variables('userAssignedIdentityName')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]"
                            },
                            {
                              "type": "Microsoft.Network/networkInterfaces",
                              "apiVersion": "2020-05-01",
                              "name": "[replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "ipConfigurations": [
                                  {
                                    "name": "ipconfig",
                                    "properties": {
                                      "privateIPAllocationMethod": "Dynamic",
                                      "subnet": {
                                        "id": "[parameters('subnetResourceId')]"
                                      },
                                      "primary": true,
                                      "privateIPAddressVersion": "IPv4"
                                    }
                                  }
                                ],
                                "enableAcceleratedNetworking": false,
                                "enableIPForwarding": false
                              }
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2021-11-01",
                              "name": "[variables('virtualMachineName')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "hardwareProfile": {
                                  "vmSize": "[parameters('virtualMachineSize')]"
                                },
                                "storageProfile": {
                                  "imageReference": {
                                    "publisher": "MicrosoftWindowsServer",
                                    "offer": "WindowsServer",
                                    "sku": "2022-datacenter-core-g2",
                                    "version": "latest"
                                  },
                                  "osDisk": {
                                    "deleteOption": "Delete",
                                    "osType": "Windows",
                                    "createOption": "FromImage",
                                    "caching": "None",
                                    "managedDisk": {
                                      "storageAccountType": "Premium_LRS"
                                    },
                                    "name": "[replace(parameters('tier').namingConvention.virtualMachineDisk, parameters('tokens').purpose, variables('workload'))]"
                                  },
                                  "dataDisks": []
                                },
                                "osProfile": {
                                  "adminPassword": "[parameters('virtualMachineAdminPassword')]",
                                  "adminUsername": "[parameters('virtualMachineAdminUsername')]",
                                  "computerName": "[variables('virtualMachineName')]",
                                  "windowsConfiguration": {
                                    "provisionVMAgent": true,
                                    "enableAutomaticUpdates": false
                                  },
                                  "secrets": [],
                                  "allowExtensionOperations": true
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk'))]",
                                      "properties": {
                                        "deleteOption": "Delete"
                                      }
                                    }
                                  ]
                                },
                                "securityProfile": {
                                  "uefiSettings": {
                                    "secureBootEnabled": true,
                                    "vTpmEnabled": true
                                  },
                                  "securityType": "TrustedLaunch",
                                  "encryptionAtHost": true
                                },
                                "diagnosticsProfile": {
                                  "bootDiagnostics": {
                                    "enabled": false
                                  }
                                },
                                "licenseType": "Windows_Server"
                              },
                              "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')))]": {}
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('tokens').purpose, 'cmk'))]",
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '136d308c-0937-4a49-9bd7-edfb42adbffc', resourceGroup().id)]",
                              "properties": {
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '136d308c-0937-4a49-9bd7-edfb42adbffc')]",
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "scope": "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]",
                              "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '9980e02c-c2be-4d73-94e8-173b1dc7cf3c', resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName')))]",
                              "properties": {
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '9980e02c-c2be-4d73-94e8-173b1dc7cf3c')]",
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.KeyVault/vaults",
                              "apiVersion": "2022-07-01",
                              "name": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "enabledForDeployment": false,
                                "enabledForDiskEncryption": false,
                                "enabledForTemplateDeployment": false,
                                "enablePurgeProtection": true,
                                "enableRbacAuthorization": true,
                                "enableSoftDelete": true,
                                "networkAcls": {
                                  "bypass": "AzureServices",
                                  "defaultAction": "Deny",
                                  "ipRules": [],
                                  "virtualNetworkRules": []
                                },
                                "publicNetworkAccess": "Disabled",
                                "sku": {
                                  "family": "A",
                                  "name": "premium"
                                },
                                "softDeleteRetentionInDays": "[if(or(equals(parameters('environmentAbbreviation'), 'dev'), equals(parameters('environmentAbbreviation'), 'test')), 7, 90)]",
                                "tenantId": "[subscription().tenantId]"
                              }
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "scope": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                              "name": "[guid(variables('userAssignedIdentityName'), '00482a5a-887f-4fb3-b363-3b7fe8e74483', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))))]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "scope": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                              "name": "[guid(variables('userAssignedIdentityName'), 'f25e0fa2-a7c8-4377-a976-54943a77a395', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))))]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'f25e0fa2-a7c8-4377-a976-54943a77a395')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('type'), 'storageAccount')]",
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[guid(variables('userAssignedIdentityName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceGroup().id)]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints",
                              "apiVersion": "2023-04-01",
                              "name": "[variables('keyVaultPrivateEndpointName')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "customNetworkInterfaceName": "[replace(parameters('tier').namingConvention.keyVaultNetworkInterface, parameters('tokens').purpose, variables('workload'))]",
                                "privateLinkServiceConnections": [
                                  {
                                    "name": "[variables('keyVaultPrivateEndpointName')]",
                                    "properties": {
                                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                      "groupIds": [
                                        "vault"
                                      ]
                                    }
                                  }
                                ],
                                "subnet": {
                                  "id": "[parameters('subnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '136d308c-0937-4a49-9bd7-edfb42adbffc', resourceGroup().id))]",
                                "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), 'Microsoft.Authorization/roleAssignments', guid(variables('userAssignedIdentityName'), '00482a5a-887f-4fb3-b363-3b7fe8e74483', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))))]",
                                "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), 'Microsoft.Authorization/roleAssignments', guid(variables('userAssignedIdentityName'), 'f25e0fa2-a7c8-4377-a976-54943a77a395', resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))))]",
                                "[extensionResourceId(resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '9980e02c-c2be-4d73-94e8-173b1dc7cf3c', resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2021-08-01",
                              "name": "[format('{0}/{1}', variables('keyVaultPrivateEndpointName'), format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                              "properties": {
                                "privateDnsZoneConfigs": [
                                  {
                                    "name": "ipconfig1",
                                    "properties": {
                                      "privateDnsZoneId": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                                    }
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2025-04-01",
                              "name": "[format('{0}/{1}', variables('virtualMachineName'), parameters('keyName'))]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "asyncExecution": false,
                                "parameters": [
                                  {
                                    "name": "DiskEncryptionSetName",
                                    "value": "[replace(parameters('tier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, variables('workload'))]"
                                  },
                                  {
                                    "name": "KeyExpirationInDays",
                                    "value": "[string(parameters('keyExpirationInDays'))]"
                                  },
                                  {
                                    "name": "KeyName",
                                    "value": "[parameters('keyName')]"
                                  },
                                  {
                                    "name": "KeyVaultResourceId",
                                    "value": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                                  },
                                  {
                                    "name": "KeyVaultServiceUri",
                                    "value": "[format('https://{0}', skip(environment().suffixes.keyvaultDns, 1))]"
                                  },
                                  {
                                    "name": "KeyVaultUri",
                                    "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), '2022-07-01').vaultUri]"
                                  },
                                  {
                                    "name": "Location",
                                    "value": "[parameters('location')]"
                                  },
                                  {
                                    "name": "ResourceGroupName",
                                    "value": "[variables('resourceGroupName')]"
                                  },
                                  {
                                    "name": "ResourceManagerUri",
                                    "value": "[environment().resourceManager]"
                                  },
                                  {
                                    "name": "SubscriptionId",
                                    "value": "[parameters('tier').subscriptionId]"
                                  },
                                  {
                                    "name": "Type",
                                    "value": "[parameters('type')]"
                                  },
                                  {
                                    "name": "UserAssignedIdentityClientId",
                                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').clientId]"
                                  }
                                ],
                                "source": {
                                  "script": "[variables('$fxv#0')]"
                                },
                                "treatFailureAsDeploymentFailure": true
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', variables('keyVaultPrivateEndpointName'), format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                "[resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName'))]",
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2023-09-01",
                              "name": "[format('{0}/{1}', variables('virtualMachineName'), format('delete-vm-{0}', parameters('deploymentNameSuffix')))]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "asyncExecution": true,
                                "parameters": [
                                  {
                                    "name": "ResourceGroupName",
                                    "value": "[variables('resourceGroupName')]"
                                  },
                                  {
                                    "name": "ResourceManagerUri",
                                    "value": "[environment().resourceManager]"
                                  },
                                  {
                                    "name": "UserAssignedIdentityClientId",
                                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').clientId]"
                                  },
                                  {
                                    "name": "VirtualMachineResourceId",
                                    "value": "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                                  }
                                ],
                                "source": {
                                  "script": "[variables('$fxv#1')]"
                                },
                                "treatFailureAsDeploymentFailure": true
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Resources/deployments', format('deploy-des-{0}', parameters('deploymentNameSuffix')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', variables('virtualMachineName'), parameters('keyName'))]",
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachineName'))]"
                              ]
                            },
                            {
                              "condition": "[equals(parameters('type'), 'virtualMachine')]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-des-{0}', parameters('deploymentNameSuffix'))]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "diskEncryptionSetName": {
                                    "value": "[replace(parameters('tier').namingConvention.diskEncryptionSet, parameters('tokens').purpose, variables('workload'))]"
                                  },
                                  "keyVaultName": {
                                    "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "15118251701077090282"
                                    }
                                  },
                                  "parameters": {
                                    "diskEncryptionSetName": {
                                      "type": "string"
                                    },
                                    "keyVaultName": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "scope": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                                      "name": "[guid(parameters('diskEncryptionSetName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')))]",
                                      "properties": {
                                        "principalId": "[reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName')), '2023-04-02', 'full').identity.principalId]",
                                        "principalType": "ServicePrincipal",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "resourceId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName'))]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', variables('virtualMachineName'), parameters('keyName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "diskEncryptionSetResourceId": {
                              "type": "string",
                              "value": "[if(equals(parameters('type'), 'virtualMachine'), reference(resourceId('Microsoft.Resources/deployments', format('deploy-des-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value, '')]"
                            },
                            "keyVaultProperties": {
                              "type": "object",
                              "value": {
                                "diagnosticSettingName": "[replace(parameters('tier').namingConvention.keyVaultDiagnosticSetting, parameters('tokens').purpose, variables('workload'))]",
                                "name": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]",
                                "resourceGroupName": "[variables('resourceGroupName')]",
                                "subscriptionId": "[parameters('tier').subscriptionId]",
                                "tierName": "[parameters('tier').name]"
                              }
                            },
                            "keyName": {
                              "type": "string",
                              "value": "[parameters('keyName')]"
                            },
                            "keyVaultName": {
                              "type": "string",
                              "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))]"
                            },
                            "keyVaultUri": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload'))))), '2022-07-01').vaultUri]"
                            },
                            "keyVaultResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.KeyVault/vaults', format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, variables('resourceGroupName'), replace(parameters('tier').namingConvention.keyVault, parameters('tokens').purpose, variables('workload')))))]"
                            },
                            "keyVaultNetworkInterfaceResourceId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', variables('keyVaultPrivateEndpointName')), '2023-04-01').networkInterfaces[0].id]"
                            },
                            "userAssignedIdentityResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "delimiter": {
                            "value": "[parameters('delimiter')]"
                          },
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "hostPoolResourceId": {
                            "value": "[variables('hostPoolResourceId')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "logAnalyticsWorkspaceRetention": {
                            "value": "[parameters('logAnalyticsWorkspaceRetention')]"
                          },
                          "logAnalyticsWorkspaceSku": {
                            "value": "[parameters('logAnalyticsWorkspaceSku')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "names": {
                            "value": "[parameters('tier').namingConvention]"
                          },
                          "privateLinkScopeResourceId": {
                            "value": "[parameters('privateLinkScopeResourceId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "tokens": {
                            "value": "[parameters('tokens')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "8398628192560052931"
                            }
                          },
                          "parameters": {
                            "delimiter": {
                              "type": "string"
                            },
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "hostPoolResourceId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceRetention": {
                              "type": "int"
                            },
                            "logAnalyticsWorkspaceSku": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "names": {
                              "type": "object"
                            },
                            "privateLinkScopeResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "tokens": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/workspaces",
                              "apiVersion": "2021-06-01",
                              "name": "[replace(parameters('names').logAnalyticsWorkspace, parameters('tokens').purpose, 'avdi')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.OperationalInsights/workspaces'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "sku": {
                                  "name": "[parameters('logAnalyticsWorkspaceSku')]"
                                },
                                "retentionInDays": "[parameters('logAnalyticsWorkspaceRetention')]",
                                "workspaceCapping": {
                                  "dailyQuotaGb": -1
                                },
                                "publicNetworkAccessForIngestion": "Disabled",
                                "publicNetworkAccessForQuery": "Enabled"
                              }
                            },
                            {
                              "type": "Microsoft.Insights/dataCollectionRules",
                              "apiVersion": "2022-06-01",
                              "name": "[format('microsoft-avdi-{0}', replace(parameters('names').dataCollectionRule, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), ''))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Insights/dataCollectionRules'), createObject()), parameters('mlzTags'))]",
                              "kind": "Windows",
                              "properties": {
                                "dataSources": {
                                  "performanceCounters": [
                                    {
                                      "streams": [
                                        "Microsoft-Perf"
                                      ],
                                      "samplingFrequencyInSeconds": 30,
                                      "counterSpecifiers": [
                                        "\\LogicalDisk(C:)\\Avg. Disk Queue Length",
                                        "\\LogicalDisk(C:)\\Current Disk Queue Length",
                                        "\\Memory\\Available Mbytes",
                                        "\\Memory\\Page Faults/sec",
                                        "\\Memory\\Pages/sec",
                                        "\\Memory\\% Committed Bytes In Use",
                                        "\\PhysicalDisk(*)\\Avg. Disk Queue Length",
                                        "\\PhysicalDisk(*)\\Avg. Disk sec/Read",
                                        "\\PhysicalDisk(*)\\Avg. Disk sec/Transfer",
                                        "\\PhysicalDisk(*)\\Avg. Disk sec/Write",
                                        "\\Processor Information(_Total)\\% Processor Time",
                                        "\\User Input Delay per Process(*)\\Max Input Delay",
                                        "\\User Input Delay per Session(*)\\Max Input Delay"
                                      ],
                                      "name": "perfCounterDataSource30"
                                    },
                                    {
                                      "streams": [
                                        "Microsoft-Perf"
                                      ],
                                      "samplingFrequencyInSeconds": 60,
                                      "counterSpecifiers": [
                                        "\\LogicalDisk(C:)\\% Free Space",
                                        "\\LogicalDisk(C:)\\Avg. Disk sec/Transfer"
                                      ],
                                      "name": "perfCounterDataSource60"
                                    }
                                  ],
                                  "windowsEventLogs": [
                                    {
                                      "streams": [
                                        "Microsoft-Event"
                                      ],
                                      "xPathQueries": [
                                        "Microsoft-Windows-TerminalServices-RemoteConnectionManager/Admin!*[System[(Level=2 or Level=3 or Level=4 or Level=0)]]",
                                        "Microsoft-Windows-TerminalServices-LocalSessionManager/Operational!*[System[(Level=2 or Level=3 or Level=4 or Level=0)]]",
                                        "System!*",
                                        "Microsoft-FSLogix-Apps/Operational!*[System[(Level=2 or Level=3 or Level=4 or Level=0)]]",
                                        "Application!*[System[(Level=2 or Level=3)]]",
                                        "Microsoft-FSLogix-Apps/Admin!*[System[(Level=2 or Level=3 or Level=4 or Level=0)]]"
                                      ],
                                      "name": "eventLogsDataSource"
                                    }
                                  ]
                                },
                                "destinations": {
                                  "logAnalytics": [
                                    {
                                      "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', replace(parameters('names').logAnalyticsWorkspace, parameters('tokens').purpose, 'avdi'))]",
                                      "name": "la-workspace"
                                    }
                                  ]
                                },
                                "dataFlows": [
                                  {
                                    "streams": [
                                      "Microsoft-Perf",
                                      "Microsoft-Event"
                                    ],
                                    "destinations": [
                                      "la-workspace"
                                    ]
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.OperationalInsights/workspaces', replace(parameters('names').logAnalyticsWorkspace, parameters('tokens').purpose, 'avdi'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Insights/dataCollectionEndpoints",
                              "apiVersion": "2021-04-01",
                              "name": "[replace(parameters('names').dataCollectionEndpoint, parameters('tokens').purpose, 'avdi')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Insights/dataCollectionEndpoints'), createObject()), parameters('mlzTags'))]",
                              "kind": "Windows",
                              "properties": {
                                "networkAcls": {
                                  "publicNetworkAccess": "Disabled"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-private-link-scope-law-{0}', parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[split(parameters('privateLinkScopeResourceId'), '/')[2]]",
                              "resourceGroup": "[split(parameters('privateLinkScopeResourceId'), '/')[4]]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "logAnalyticsWorkspaceResourceId": {
                                    "value": "[resourceId('Microsoft.OperationalInsights/workspaces', replace(parameters('names').logAnalyticsWorkspace, parameters('tokens').purpose, 'avdi'))]"
                                  },
                                  "privateLinkScopeResourceId": {
                                    "value": "[parameters('privateLinkScopeResourceId')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "5531269282389661247"
                                    }
                                  },
                                  "parameters": {
                                    "applicationInsightsResourceId": {
                                      "type": "string",
                                      "defaultValue": ""
                                    },
                                    "dataCollectionEndpointResourceId": {
                                      "type": "string",
                                      "defaultValue": ""
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string",
                                      "defaultValue": ""
                                    },
                                    "privateLinkScopeResourceId": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "condition": "[not(empty(parameters('applicationInsightsResourceId')))]",
                                      "type": "Microsoft.Insights/privateLinkScopes/scopedResources",
                                      "apiVersion": "2021-09-01",
                                      "name": "[format('{0}/{1}', split(parameters('privateLinkScopeResourceId'), '/')[8], if(empty(parameters('applicationInsightsResourceId')), 'applicationInsights', split(parameters('applicationInsightsResourceId'), '/')[8]))]",
                                      "properties": {
                                        "linkedResourceId": "[parameters('applicationInsightsResourceId')]"
                                      }
                                    },
                                    {
                                      "condition": "[not(empty(parameters('dataCollectionEndpointResourceId')))]",
                                      "type": "Microsoft.Insights/privateLinkScopes/scopedResources",
                                      "apiVersion": "2021-09-01",
                                      "name": "[format('{0}/{1}', split(parameters('privateLinkScopeResourceId'), '/')[8], if(empty(parameters('dataCollectionEndpointResourceId')), 'dataCollectionEndpoint', split(parameters('dataCollectionEndpointResourceId'), '/')[8]))]",
                                      "properties": {
                                        "linkedResourceId": "[parameters('dataCollectionEndpointResourceId')]"
                                      }
                                    },
                                    {
                                      "condition": "[not(empty(parameters('logAnalyticsWorkspaceResourceId')))]",
                                      "type": "Microsoft.Insights/privateLinkScopes/scopedResources",
                                      "apiVersion": "2021-09-01",
                                      "name": "[format('{0}/{1}', split(parameters('privateLinkScopeResourceId'), '/')[8], if(empty(parameters('logAnalyticsWorkspaceResourceId')), 'logAnalyticsWorkspace', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]))]",
                                      "properties": {
                                        "linkedResourceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.OperationalInsights/workspaces', replace(parameters('names').logAnalyticsWorkspace, parameters('tokens').purpose, 'avdi'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('deploy-private-link-scope-dce-{0}', parameters('deploymentNameSuffix'))]",
                              "subscriptionId": "[split(parameters('privateLinkScopeResourceId'), '/')[2]]",
                              "resourceGroup": "[split(parameters('privateLinkScopeResourceId'), '/')[4]]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "dataCollectionEndpointResourceId": {
                                    "value": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', replace(parameters('names').dataCollectionEndpoint, parameters('tokens').purpose, 'avdi'))]"
                                  },
                                  "privateLinkScopeResourceId": {
                                    "value": "[parameters('privateLinkScopeResourceId')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "5531269282389661247"
                                    }
                                  },
                                  "parameters": {
                                    "applicationInsightsResourceId": {
                                      "type": "string",
                                      "defaultValue": ""
                                    },
                                    "dataCollectionEndpointResourceId": {
                                      "type": "string",
                                      "defaultValue": ""
                                    },
                                    "logAnalyticsWorkspaceResourceId": {
                                      "type": "string",
                                      "defaultValue": ""
                                    },
                                    "privateLinkScopeResourceId": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "condition": "[not(empty(parameters('applicationInsightsResourceId')))]",
                                      "type": "Microsoft.Insights/privateLinkScopes/scopedResources",
                                      "apiVersion": "2021-09-01",
                                      "name": "[format('{0}/{1}', split(parameters('privateLinkScopeResourceId'), '/')[8], if(empty(parameters('applicationInsightsResourceId')), 'applicationInsights', split(parameters('applicationInsightsResourceId'), '/')[8]))]",
                                      "properties": {
                                        "linkedResourceId": "[parameters('applicationInsightsResourceId')]"
                                      }
                                    },
                                    {
                                      "condition": "[not(empty(parameters('dataCollectionEndpointResourceId')))]",
                                      "type": "Microsoft.Insights/privateLinkScopes/scopedResources",
                                      "apiVersion": "2021-09-01",
                                      "name": "[format('{0}/{1}', split(parameters('privateLinkScopeResourceId'), '/')[8], if(empty(parameters('dataCollectionEndpointResourceId')), 'dataCollectionEndpoint', split(parameters('dataCollectionEndpointResourceId'), '/')[8]))]",
                                      "properties": {
                                        "linkedResourceId": "[parameters('dataCollectionEndpointResourceId')]"
                                      }
                                    },
                                    {
                                      "condition": "[not(empty(parameters('logAnalyticsWorkspaceResourceId')))]",
                                      "type": "Microsoft.Insights/privateLinkScopes/scopedResources",
                                      "apiVersion": "2021-09-01",
                                      "name": "[format('{0}/{1}', split(parameters('privateLinkScopeResourceId'), '/')[8], if(empty(parameters('logAnalyticsWorkspaceResourceId')), 'logAnalyticsWorkspace', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]))]",
                                      "properties": {
                                        "linkedResourceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Insights/dataCollectionEndpoints', replace(parameters('names').dataCollectionEndpoint, parameters('tokens').purpose, 'avdi'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "logAnalyticsWorkspaceName": {
                              "type": "string",
                              "value": "[replace(parameters('names').logAnalyticsWorkspace, parameters('tokens').purpose, 'avdi')]"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', replace(parameters('names').logAnalyticsWorkspace, parameters('tokens').purpose, 'avdi'))]"
                            },
                            "dataCollectionRuleResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Insights/dataCollectionRules', format('microsoft-avdi-{0}', replace(parameters('names').dataCollectionRule, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')))]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "dataCollectionRuleResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.dataCollectionRuleResourceId.value]"
                    },
                    "diskAccessPolicyDefinitionId": {
                      "type": "string",
                      "value": "[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', 'DiskNetworkAccess')]"
                    },
                    "diskAccessPolicyDisplayName": {
                      "type": "string",
                      "value": "[reference(subscriptionResourceId('Microsoft.Authorization/policyDefinitions', 'DiskNetworkAccess'), '2021-06-01').displayName]"
                    },
                    "diskAccessResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-disk-access-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                    },
                    "diskEncryptionSetResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.diskEncryptionSetResourceId.value]"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.logAnalyticsWorkspaceResourceId.value]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-control-plane-{0}', parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "avdPrivateDnsZoneResourceId": {
                    "value": "[format('{0}{1}', variables('privateDnsZoneResourceIdPrefix'), filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZones.value, lambda('name', startsWith(lambdaVariables('name'), 'privatelink.wvd')))[0])]"
                  },
                  "delimiter": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "hostPoolPublicNetworkAccess": {
                    "value": "[parameters('hostPoolPublicNetworkAccess')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-management-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.logAnalyticsWorkspaceResourceId.value]"
                  },
                  "mlzTags": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                  },
                  "resourceGroupName": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                  },
                  "securityPrincipalObjectId": {
                    "value": "[map(parameters('securityPrincipals'), lambda('item', lambdaVariables('item').objectId))[0]]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tier": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value]"
                  },
                  "tokens": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                  },
                  "vmTemplate": {
                    "value": "[format('{{\"domain\":\"{0}\",\"galleryImageOffer\":\"pro-byol\",\"galleryImagePublisher\":\"esri\",\"galleryImageSKU\":\"pro-byol-36\",\"imageType\":\"Gallery\",\"customImageId\":null,\"namePrefix\":\"{1}\",\"osDiskType\":\"Premium_LRS\",\"vmSize\":{{\"id\":\"{2}\",\"cores\":null,\"ram\":null,\"rdmaEnabled\": false,\"supportsMemoryPreservingMaintenance\": true}},\"galleryItemId\":\"esri.pro-byol.pro-byol-36\",\"hibernate\":false,\"diskSizeGB\":0,\"securityType\":\"TrustedLaunch\",\"secureBoot\":true,\"vTPM\":true,\"vmInfrastructureType\":\"Cloud\",\"virtualProcessorCount\":null,\"memoryGB\":null,\"maximumMemoryGB\":null,\"minimumMemoryGB\":null,\"dynamicMemoryConfig\":false}}', parameters('domainName'), replace(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.namingConvention.virtualMachine, format('{0}{1}', reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value.purpose), ''), parameters('virtualMachineSize'))]"
                  },
                  "workspaceGlobalPrivateDnsZoneResourceId": {
                    "value": "[format('{0}{1}', variables('privateDnsZoneResourceIdPrefix'), filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZones.value, lambda('name', startsWith(lambdaVariables('name'), 'privatelink-global.wvd')))[0])]"
                  },
                  "workspacePublicNetworkAccess": {
                    "value": "[parameters('workspacePublicNetworkAccess')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "14594967896318086879"
                    }
                  },
                  "parameters": {
                    "avdPrivateDnsZoneResourceId": {
                      "type": "string"
                    },
                    "delimiter": {
                      "type": "string"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "hostPoolPublicNetworkAccess": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "securityPrincipalObjectId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "tier": {
                      "type": "object"
                    },
                    "tokens": {
                      "type": "object"
                    },
                    "vmTemplate": {
                      "type": "string"
                    },
                    "workspaceGlobalPrivateDnsZoneResourceId": {
                      "type": "string"
                    },
                    "workspacePublicNetworkAccess": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "namingConvention": "[parameters('tier').namingConvention]",
                    "subnetResourceId": "[parameters('tier').subnetResourceId]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-vdpool-{0}', parameters('deploymentNameSuffix'))]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "avdPrivateDnsZoneResourceId": {
                            "value": "[parameters('avdPrivateDnsZoneResourceId')]"
                          },
                          "hostPoolDiagnosticSettingName": {
                            "value": "[replace(variables('namingConvention').hostPoolDiagnosticSetting, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "hostPoolName": {
                            "value": "[replace(variables('namingConvention').hostPool, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "hostPoolNetworkInterfaceName": {
                            "value": "[replace(variables('namingConvention').hostPoolNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "hostPoolPrivateEndpointName": {
                            "value": "[replace(variables('namingConvention').hostPoolPrivateEndpoint, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "hostPoolPublicNetworkAccess": {
                            "value": "[parameters('hostPoolPublicNetworkAccess')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "subnetResourceId": {
                            "value": "[variables('subnetResourceId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "vmTemplate": {
                            "value": "[parameters('vmTemplate')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "4709703464520225453"
                            }
                          },
                          "parameters": {
                            "avdPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "hostPoolDiagnosticSettingName": {
                              "type": "string"
                            },
                            "hostPoolName": {
                              "type": "string"
                            },
                            "hostPoolNetworkInterfaceName": {
                              "type": "string"
                            },
                            "hostPoolPrivateEndpointName": {
                              "type": "string"
                            },
                            "hostPoolPublicNetworkAccess": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "time": {
                              "type": "string",
                              "defaultValue": "[utcNow('u')]"
                            },
                            "vmTemplate": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.DesktopVirtualization/hostPools",
                              "apiVersion": "2023-09-05",
                              "name": "[parameters('hostPoolName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(createObject('cm-resource-parent', format('{0}}}/resourceGroups/{1}/providers/Microsoft.DesktopVirtualization/hostpools/{2}', subscription().id, resourceGroup().name, parameters('hostPoolName'))), coalesce(tryGet(parameters('tags'), 'Microsoft.DesktopVirtualization/hostPools'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "customRdpProperty": "audiocapturemode:i:1;camerastoredirect:s:*;use multimon:i:0;drivestoredirect:s:;encode redirected video capture:i:1;redirected video capture encoding quality:i:1;audiomode:i:0;devicestoredirect:s:;redirectclipboard:i:0;redirectcomports:i:0;redirectlocation:i:1;redirectprinters:i:0;redirectsmartcards:i:1;redirectwebauthn:i:1;usbdevicestoredirect:s:;keyboardhook:i:2;enablerdsaadauth:i:1;",
                                "hostPoolType": "Personal",
                                "loadBalancerType": "Persistent",
                                "maxSessionLimit": 1,
                                "personalDesktopAssignmentType": "Automatic",
                                "preferredAppGroupType": "Desktop",
                                "publicNetworkAccess": "[parameters('hostPoolPublicNetworkAccess')]",
                                "registrationInfo": {
                                  "expirationTime": "[dateTimeAdd(parameters('time'), 'PT2H')]",
                                  "registrationTokenOperation": "Update"
                                },
                                "startVMOnConnect": true,
                                "validationEnvironment": false,
                                "vmTemplate": "[parameters('vmTemplate')]"
                              }
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints",
                              "apiVersion": "2023-04-01",
                              "name": "[parameters('hostPoolPrivateEndpointName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(createObject('cm-resource-parent', resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('hostPoolName'))), coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "customNetworkInterfaceName": "[parameters('hostPoolNetworkInterfaceName')]",
                                "privateLinkServiceConnections": [
                                  {
                                    "name": "[parameters('hostPoolPrivateEndpointName')]",
                                    "properties": {
                                      "privateLinkServiceId": "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('hostPoolName'))]",
                                      "groupIds": [
                                        "connection"
                                      ]
                                    }
                                  }
                                ],
                                "subnet": {
                                  "id": "[parameters('subnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('hostPoolName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2023-05-01",
                              "name": "[format('{0}/{1}', parameters('hostPoolPrivateEndpointName'), 'default')]",
                              "properties": {
                                "privateDnsZoneConfigs": [
                                  {
                                    "name": "[replace(split(parameters('avdPrivateDnsZoneResourceId'), '/')[8], '.', '-')]",
                                    "properties": {
                                      "privateDnsZoneId": "[parameters('avdPrivateDnsZoneResourceId')]"
                                    }
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints', parameters('hostPoolPrivateEndpointName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('hostPoolName'))]",
                              "name": "[parameters('hostPoolDiagnosticSettingName')]",
                              "properties": {
                                "logs": [
                                  {
                                    "categoryGroup": "allLogs",
                                    "enabled": true
                                  }
                                ],
                                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('hostPoolName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('hostPoolName')]"
                            },
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('hostPoolName'))]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-vdag-{0}', parameters('deploymentNameSuffix'))]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "desktopApplicationGroupName": {
                            "value": "[replace(variables('namingConvention').applicationGroup, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "hostPoolResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-vdpool-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                          },
                          "locationControlPlane": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "securityPrincipalObjectId": {
                            "value": "[parameters('securityPrincipalObjectId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "11444894114383031185"
                            }
                          },
                          "parameters": {
                            "desktopApplicationGroupName": {
                              "type": "string"
                            },
                            "hostPoolResourceId": {
                              "type": "string"
                            },
                            "locationControlPlane": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "securityPrincipalObjectId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.DesktopVirtualization/applicationGroups",
                              "apiVersion": "2023-09-05",
                              "name": "[parameters('desktopApplicationGroupName')]",
                              "location": "[parameters('locationControlPlane')]",
                              "tags": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.DesktopVirtualization/applicationGroups'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "hostPoolArmPath": "[parameters('hostPoolResourceId')]",
                                "applicationGroupType": "Desktop"
                              }
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "scope": "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('desktopApplicationGroupName'))]",
                              "name": "[guid(parameters('securityPrincipalObjectId'), '1d18fff3-a72a-46b5-b4a9-0b38a3cd7e63', resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('desktopApplicationGroupName')))]",
                              "properties": {
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '1d18fff3-a72a-46b5-b4a9-0b38a3cd7e63')]",
                                "principalId": "[parameters('securityPrincipalObjectId')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('desktopApplicationGroupName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('desktopApplicationGroupName'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-vdpool-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-vdws-feed-{0}', parameters('deploymentNameSuffix'))]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "applicationGroupResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-vdag-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                          },
                          "avdPrivateDnsZoneResourceId": {
                            "value": "[parameters('avdPrivateDnsZoneResourceId')]"
                          },
                          "locationControlPlane": {
                            "value": "[parameters('location')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "subnetResourceId": {
                            "value": "[variables('subnetResourceId')]"
                          },
                          "workspaceFeedDiagnoticSettingName": {
                            "value": "[replace(variables('namingConvention').workspaceDiagnosticSetting, parameters('tokens').purpose, 'feed')]"
                          },
                          "workspaceFeedName": {
                            "value": "[replace(variables('namingConvention').workspace, parameters('tokens').purpose, 'feed')]"
                          },
                          "workspaceFeedNetworkInterfaceName": {
                            "value": "[replace(variables('namingConvention').workspaceNetworkInterface, parameters('tokens').purpose, 'feed')]"
                          },
                          "workspaceFeedPrivateEndpointName": {
                            "value": "[replace(variables('namingConvention').workspacePrivateEndpoint, parameters('tokens').purpose, 'feed')]"
                          },
                          "workspaceFriendlyName": {
                            "value": "[replace(variables('namingConvention').workspace, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "workspacePublicNetworkAccess": {
                            "value": "[parameters('workspacePublicNetworkAccess')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "17533512539153248740"
                            }
                          },
                          "parameters": {
                            "applicationGroupResourceId": {
                              "type": "string"
                            },
                            "avdPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "locationControlPlane": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "workspaceFeedDiagnoticSettingName": {
                              "type": "string"
                            },
                            "workspaceFeedName": {
                              "type": "string"
                            },
                            "workspaceFeedNetworkInterfaceName": {
                              "type": "string"
                            },
                            "workspaceFeedPrivateEndpointName": {
                              "type": "string"
                            },
                            "workspaceFriendlyName": {
                              "type": "string"
                            },
                            "workspacePublicNetworkAccess": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.DesktopVirtualization/workspaces",
                              "apiVersion": "2023-09-05",
                              "name": "[parameters('workspaceFeedName')]",
                              "location": "[parameters('locationControlPlane')]",
                              "tags": "[parameters('mlzTags')]",
                              "properties": {
                                "applicationGroupReferences": [
                                  "[parameters('applicationGroupResourceId')]"
                                ],
                                "friendlyName": "[parameters('workspaceFriendlyName')]",
                                "publicNetworkAccess": "[parameters('workspacePublicNetworkAccess')]"
                              }
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints",
                              "apiVersion": "2023-04-01",
                              "name": "[parameters('workspaceFeedPrivateEndpointName')]",
                              "location": "[parameters('locationControlPlane')]",
                              "tags": "[parameters('mlzTags')]",
                              "properties": {
                                "customNetworkInterfaceName": "[parameters('workspaceFeedNetworkInterfaceName')]",
                                "privateLinkServiceConnections": [
                                  {
                                    "name": "[parameters('workspaceFeedPrivateEndpointName')]",
                                    "properties": {
                                      "privateLinkServiceId": "[resourceId('Microsoft.DesktopVirtualization/workspaces', parameters('workspaceFeedName'))]",
                                      "groupIds": [
                                        "feed"
                                      ]
                                    }
                                  }
                                ],
                                "subnet": {
                                  "id": "[parameters('subnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.DesktopVirtualization/workspaces', parameters('workspaceFeedName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2023-05-01",
                              "name": "[format('{0}/{1}', parameters('workspaceFeedPrivateEndpointName'), 'default')]",
                              "properties": {
                                "privateDnsZoneConfigs": [
                                  {
                                    "name": "[replace(split(parameters('avdPrivateDnsZoneResourceId'), '/')[8], '.', '-')]",
                                    "properties": {
                                      "privateDnsZoneId": "[parameters('avdPrivateDnsZoneResourceId')]"
                                    }
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints', parameters('workspaceFeedPrivateEndpointName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[resourceId('Microsoft.DesktopVirtualization/workspaces', parameters('workspaceFeedName'))]",
                              "name": "[parameters('workspaceFeedDiagnoticSettingName')]",
                              "properties": {
                                "logs": [
                                  {
                                    "categoryGroup": "allLogs",
                                    "enabled": true
                                  }
                                ],
                                "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.DesktopVirtualization/workspaces', parameters('workspaceFeedName'))]"
                              ]
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-vdag-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-vdws-global-{0}', parameters('deploymentNameSuffix'))]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "globalWorkspacePrivateDnsZoneResourceId": {
                            "value": "[parameters('workspaceGlobalPrivateDnsZoneResourceId')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "subnetResourceId": {
                            "value": "[variables('subnetResourceId')]"
                          },
                          "tags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "workspaceGlobalName": {
                            "value": "[replace(variables('namingConvention').workspace, parameters('tokens').purpose, 'global')]"
                          },
                          "workspaceGlobalNetworkInterfaceName": {
                            "value": "[replace(variables('namingConvention').workspaceNetworkInterface, parameters('tokens').purpose, 'global')]"
                          },
                          "workspaceGlobalPrivateEndpointName": {
                            "value": "[replace(variables('namingConvention').workspacePrivateEndpoint, parameters('tokens').purpose, 'global')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "3340199758297878399"
                            }
                          },
                          "parameters": {
                            "globalWorkspacePrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "workspaceGlobalName": {
                              "type": "string"
                            },
                            "workspaceGlobalNetworkInterfaceName": {
                              "type": "string"
                            },
                            "workspaceGlobalPrivateEndpointName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.DesktopVirtualization/workspaces",
                              "apiVersion": "2023-09-05",
                              "name": "[parameters('workspaceGlobalName')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints",
                              "apiVersion": "2023-04-01",
                              "name": "[parameters('workspaceGlobalPrivateEndpointName')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "customNetworkInterfaceName": "[parameters('workspaceGlobalNetworkInterfaceName')]",
                                "privateLinkServiceConnections": [
                                  {
                                    "name": "[parameters('workspaceGlobalPrivateEndpointName')]",
                                    "properties": {
                                      "privateLinkServiceId": "[resourceId('Microsoft.DesktopVirtualization/workspaces', parameters('workspaceGlobalName'))]",
                                      "groupIds": [
                                        "global"
                                      ]
                                    }
                                  }
                                ],
                                "subnet": {
                                  "id": "[parameters('subnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.DesktopVirtualization/workspaces', parameters('workspaceGlobalName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2023-05-01",
                              "name": "[format('{0}/{1}', parameters('workspaceGlobalPrivateEndpointName'), 'default')]",
                              "properties": {
                                "privateDnsZoneConfigs": [
                                  {
                                    "name": "[replace(split(parameters('globalWorkspacePrivateDnsZoneResourceId'), '/')[8], '.', '-')]",
                                    "properties": {
                                      "privateDnsZoneId": "[parameters('globalWorkspacePrivateDnsZoneResourceId')]"
                                    }
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints', parameters('workspaceGlobalPrivateEndpointName'))]"
                              ]
                            }
                          ]
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "hostPoolResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-vdpool-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-management-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-session-hosts-{0}', parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "activeDirectorySolution": {
                    "value": "[parameters('activeDirectorySolution')]"
                  },
                  "avdConfigurationZipFileUri": {
                    "value": "[format('https://{0}/galleryartifacts/Configuration_1.0.03211.1002.zip', variables('avdStorageAccountEndpoint'))]"
                  },
                  "dataCollectionRuleResourceId": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-management-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.dataCollectionRuleResourceId.value]"
                  },
                  "delimiter": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "diskAccessPolicyDefinitionId": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-management-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.diskAccessPolicyDefinitionId.value]"
                  },
                  "diskAccessPolicyDisplayName": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-management-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.diskAccessPolicyDisplayName.value]"
                  },
                  "diskAccessResourceId": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-management-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.diskAccessResourceId.value]"
                  },
                  "diskEncryptionSetResourceId": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-management-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.diskEncryptionSetResourceId.value]"
                  },
                  "fileShare": {
                    "value": "[parameters('fileShare')]"
                  },
                  "hostPoolResourceId": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-control-plane-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.hostPoolResourceId.value]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                  },
                  "resourceGroupName": {
                    "value": "[replace(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value.namingConvention.resourceGroup, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value.purpose, 'stamp')]"
                  },
                  "securityPrincipalObjectId": {
                    "value": "[map(parameters('securityPrincipals'), lambda('item', lambdaVariables('item').objectId))[0]]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tier": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tier.value]"
                  },
                  "tokens": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tokens.value]"
                  },
                  "virtualMachineAdminPassword": {
                    "value": "[parameters('virtualMachineAdminPassword')]"
                  },
                  "virtualMachineAdminUsername": {
                    "value": "[parameters('virtualMachineAdminUsername')]"
                  },
                  "virtualMachineSize": {
                    "value": "[parameters('virtualMachineSize')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "3081236154186319022"
                    }
                  },
                  "parameters": {
                    "activeDirectorySolution": {
                      "type": "string"
                    },
                    "avdConfigurationZipFileUri": {
                      "type": "string"
                    },
                    "dataCollectionRuleResourceId": {
                      "type": "string"
                    },
                    "delimiter": {
                      "type": "string"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "diskAccessPolicyDefinitionId": {
                      "type": "string"
                    },
                    "diskAccessPolicyDisplayName": {
                      "type": "string"
                    },
                    "diskAccessResourceId": {
                      "type": "string"
                    },
                    "diskEncryptionSetResourceId": {
                      "type": "string"
                    },
                    "fileShare": {
                      "type": "string"
                    },
                    "hostPoolResourceId": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "securityPrincipalObjectId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "tier": {
                      "type": "object"
                    },
                    "tokens": {
                      "type": "object"
                    },
                    "virtualMachineAdminPassword": {
                      "type": "securestring"
                    },
                    "virtualMachineAdminUsername": {
                      "type": "string"
                    },
                    "virtualMachineSize": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "tagsVirtualMachines": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('assign-policy-diskAccess-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "diskAccessResourceId": {
                            "value": "[parameters('diskAccessResourceId')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "policyDefinitionId": {
                            "value": "[parameters('diskAccessPolicyDefinitionId')]"
                          },
                          "policyDisplayName": {
                            "value": "[parameters('diskAccessPolicyDisplayName')]"
                          },
                          "policyName": {
                            "value": "[parameters('diskAccessPolicyDisplayName')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "3894470118876690045"
                            }
                          },
                          "parameters": {
                            "diskAccessResourceId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "policyDefinitionId": {
                              "type": "string"
                            },
                            "policyDisplayName": {
                              "type": "string"
                            },
                            "policyName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/policyAssignments",
                              "apiVersion": "2022-06-01",
                              "name": "[parameters('policyName')]",
                              "location": "[parameters('location')]",
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "properties": {
                                "displayName": "[parameters('policyDisplayName')]",
                                "policyDefinitionId": "[parameters('policyDefinitionId')]",
                                "parameters": "[if(not(empty(parameters('diskAccessResourceId'))), createObject('diskAccessId', createObject('value', parameters('diskAccessResourceId'))), createObject())]"
                              }
                            }
                          ]
                        }
                      }
                    },
                    {
                      "condition": "[contains(parameters('activeDirectorySolution'), 'EntraId')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('assign-role-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "principalId": {
                            "value": "[parameters('securityPrincipalObjectId')]"
                          },
                          "principalType": {
                            "value": "Group"
                          },
                          "roleDefinitionId": {
                            "value": "fb879df8-f326-4884-b1cf-06f3ad86be52"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "6983208768638118808"
                            }
                          },
                          "parameters": {
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string"
                            },
                            "roleDefinitionId": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "name": "[guid(parameters('principalId'), parameters('roleDefinitionId'), resourceGroup().id)]",
                              "properties": {
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]"
                              }
                            }
                          ]
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-vm-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "activeDirectorySolution": {
                            "value": "[parameters('activeDirectorySolution')]"
                          },
                          "avdConfigurationZipFileUri": {
                            "value": "[parameters('avdConfigurationZipFileUri')]"
                          },
                          "dataCollectionRuleAssociationName": {
                            "value": "[replace(parameters('tier').namingConvention.dataCollectionRuleAssociation, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "dataCollectionRuleResourceId": {
                            "value": "[parameters('dataCollectionRuleResourceId')]"
                          },
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "diskEncryptionSetResourceId": {
                            "value": "[parameters('diskEncryptionSetResourceId')]"
                          },
                          "diskNamePrefix": {
                            "value": "[replace(parameters('tier').namingConvention.virtualMachineDisk, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "fileShare": {
                            "value": "[parameters('fileShare')]"
                          },
                          "hostPoolResourceId": {
                            "value": "[parameters('hostPoolResourceId')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "networkInterfaceNamePrefix": {
                            "value": "[replace(parameters('tier').namingConvention.virtualMachineNetworkInterface, format('{0}{1}', parameters('delimiter'), parameters('tokens').purpose), '')]"
                          },
                          "networkSecurityGroupResourceId": {
                            "value": "[parameters('tier').networkSecurityGroupResourceId]"
                          },
                          "subnetResourceId": {
                            "value": "[parameters('tier').subnets[0].id]"
                          },
                          "tagsNetworkInterfaces": {
                            "value": "[union(createObject('cm-resource-parent', parameters('hostPoolResourceId')), coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkInterfaces'), createObject()), parameters('mlzTags'))]"
                          },
                          "tagsVirtualMachines": {
                            "value": "[variables('tagsVirtualMachines')]"
                          },
                          "virtualMachineNamePrefix": {
                            "value": "[replace(parameters('tier').namingConvention.virtualMachine, parameters('tokens').purpose, '')]"
                          },
                          "virtualMachineAdminPassword": {
                            "value": "[parameters('virtualMachineAdminPassword')]"
                          },
                          "virtualMachineAdminUsername": {
                            "value": "[parameters('virtualMachineAdminUsername')]"
                          },
                          "virtualMachineSize": {
                            "value": "[parameters('virtualMachineSize')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.40.2.10011",
                              "templateHash": "11694157803835734758"
                            }
                          },
                          "parameters": {
                            "activeDirectorySolution": {
                              "type": "string"
                            },
                            "avdConfigurationZipFileUri": {
                              "type": "string"
                            },
                            "dataCollectionRuleAssociationName": {
                              "type": "string"
                            },
                            "dataCollectionRuleResourceId": {
                              "type": "string"
                            },
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "diskEncryptionSetResourceId": {
                              "type": "string"
                            },
                            "diskNamePrefix": {
                              "type": "string"
                            },
                            "fileShare": {
                              "type": "string"
                            },
                            "hostPoolResourceId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "networkInterfaceNamePrefix": {
                              "type": "string"
                            },
                            "networkSecurityGroupResourceId": {
                              "type": "string"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tagsNetworkInterfaces": {
                              "type": "object"
                            },
                            "tagsVirtualMachines": {
                              "type": "object"
                            },
                            "virtualMachineNamePrefix": {
                              "type": "string"
                            },
                            "virtualMachineAdminPassword": {
                              "type": "securestring"
                            },
                            "virtualMachineAdminUsername": {
                              "type": "string"
                            },
                            "virtualMachineSize": {
                              "type": "string"
                            }
                          },
                          "variables": {
                            "$fxv#0": "$ErrorActionPreference = 'Stop'\r\n$Settings = @(\r\n\r\n    # Disable Automatic Updates: https://learn.microsoft.com/azure/virtual-desktop/set-up-customize-master-image#disable-automatic-updates\r\n    [PSCustomObject]@{\r\n        Name = 'NoAutoUpdate'\r\n        Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU'\r\n        PropertyType = 'DWord'\r\n        Value = 1\r\n    },\r\n\r\n    # Enable Time Zone Redirection: https://learn.microsoft.com/azure/virtual-desktop/set-up-customize-master-image#set-up-time-zone-redirection\r\n    [PSCustomObject]@{\r\n        Name = 'fEnableTimeZoneRedirection'\r\n        Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'\r\n        PropertyType = 'DWord'\r\n        Value = 1\r\n    },\r\n\r\n    # Configure GPU-accelerated app rendering: https://learn.microsoft.com/azure/virtual-desktop/configure-vm-gpu#configure-gpu-accelerated-app-rendering\r\n    [PSCustomObject]@{\r\n        Name = 'bEnumerateHWBeforeSW'\r\n        Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'\r\n        PropertyType = 'DWord'\r\n        Value = 1\r\n    },\r\n\r\n    # Configure fullscreen video encoding: https://learn.microsoft.com/azure/virtual-desktop/configure-vm-gpu#configure-fullscreen-video-encoding\r\n    [PSCustomObject]@{\r\n        Name = 'AVC444ModePreferred'\r\n        Path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services'\r\n        PropertyType = 'DWord'\r\n        Value = 1\r\n    }\r\n)\r\n\r\nforeach($Setting in $Settings)\r\n{\r\n    if(!(Test-Path -Path $Setting.Path))\r\n    {\r\n        New-Item -Path $Setting.Path -Force | Out-Null\r\n    }\r\n    $Value = Get-ItemProperty -Path $Setting.Path -Name $Setting.Name -ErrorAction 'SilentlyContinue'\r\n    if(!$Value)\r\n    {\r\n        New-ItemProperty -Path $Setting.Path -Name $Setting.Name -PropertyType $Setting.PropertyType -Value $Setting.Value -Force | Out-Null\r\n    }\r\n    elseif($Value.$($Setting.Name) -ne $Setting.Value)\r\n    {\r\n        Set-ItemProperty -Path $Setting.Path -Name $Setting.Name -Value $Setting.Value -Force | Out-Null\r\n    }\r\n    Start-Sleep -Seconds 1 | Out-Null\r\n}",
                            "amdVmSizes": [
                              "Standard_NV4as_v4",
                              "Standard_NV8as_v4",
                              "Standard_NV16as_v4",
                              "Standard_NV32as_v4",
                              "Standard_NV4ads_V710_v5",
                              "Standard_NV8ads_V710_v5",
                              "Standard_NV12ads_V710_v5",
                              "Standard_NV24ads_V710_v5",
                              "Standard_NV28adms_V710_v5"
                            ],
                            "intune": "[contains(parameters('activeDirectorySolution'), 'IntuneEnrollment')]",
                            "nvidiaVmSizes": [
                              "Standard_NV6",
                              "Standard_NV12",
                              "Standard_NV24",
                              "Standard_NV12s_v3",
                              "Standard_NV24s_v3",
                              "Standard_NV48s_v3",
                              "Standard_NC4as_T4_v3",
                              "Standard_NC8as_T4_v3",
                              "Standard_NC16as_T4_v3",
                              "Standard_NC64as_T4_v3",
                              "Standard_NV6ads_A10_v5",
                              "Standard_NV12ads_A10_v5",
                              "Standard_NV18ads_A10_v5",
                              "Standard_NV36ads_A10_v5",
                              "Standard_NV36adms_A10_v5",
                              "Standard_NV72ads_A10_v5"
                            ]
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/networkInterfaces",
                              "apiVersion": "2020-05-01",
                              "name": "[format('{0}-0', parameters('networkInterfaceNamePrefix'))]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tagsNetworkInterfaces')]",
                              "properties": {
                                "ipConfigurations": [
                                  {
                                    "name": "ipconfig",
                                    "properties": {
                                      "privateIPAllocationMethod": "Dynamic",
                                      "subnet": {
                                        "id": "[parameters('subnetResourceId')]"
                                      },
                                      "primary": true,
                                      "privateIPAddressVersion": "IPv4"
                                    }
                                  }
                                ],
                                "networkSecurityGroup": {
                                  "id": "[parameters('networkSecurityGroupResourceId')]"
                                },
                                "enableAcceleratedNetworking": true,
                                "enableIPForwarding": false
                              }
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2021-03-01",
                              "name": "[format('{0}-0', parameters('virtualMachineNamePrefix'))]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tagsVirtualMachines')]",
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "plan": {
                                "name": "pro-byol-36",
                                "publisher": "esri",
                                "product": "pro-byol"
                              },
                              "properties": {
                                "hardwareProfile": {
                                  "vmSize": "[parameters('virtualMachineSize')]"
                                },
                                "storageProfile": {
                                  "imageReference": {
                                    "publisher": "esri",
                                    "offer": "pro-byol",
                                    "sku": "pro-byol-36",
                                    "version": "latest"
                                  },
                                  "osDisk": {
                                    "name": "[format('{0}-0', parameters('diskNamePrefix'))]",
                                    "osType": "Windows",
                                    "createOption": "FromImage",
                                    "caching": "ReadWrite",
                                    "deleteOption": "Delete",
                                    "managedDisk": {
                                      "diskEncryptionSet": {
                                        "id": "[parameters('diskEncryptionSetResourceId')]"
                                      },
                                      "storageAccountType": "Premium_LRS"
                                    }
                                  },
                                  "dataDisks": []
                                },
                                "osProfile": {
                                  "adminPassword": "[parameters('virtualMachineAdminPassword')]",
                                  "adminUsername": "[parameters('virtualMachineAdminUsername')]",
                                  "computerName": "[format('{0}-0', parameters('virtualMachineNamePrefix'))]",
                                  "windowsConfiguration": {
                                    "provisionVMAgent": true,
                                    "enableAutomaticUpdates": true
                                  },
                                  "secrets": [],
                                  "allowExtensionOperations": true
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-0', parameters('networkInterfaceNamePrefix')))]",
                                      "properties": {
                                        "deleteOption": "Delete"
                                      }
                                    }
                                  ]
                                },
                                "securityProfile": {
                                  "uefiSettings": {
                                    "secureBootEnabled": true,
                                    "vTpmEnabled": true
                                  },
                                  "securityType": "trustedLaunch",
                                  "encryptionAtHost": true
                                },
                                "diagnosticsProfile": {
                                  "bootDiagnostics": {
                                    "enabled": false
                                  }
                                },
                                "licenseType": "Windows_Client"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-0', parameters('networkInterfaceNamePrefix')))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2021-03-01",
                              "name": "[format('{0}/{1}', format('{0}-0', parameters('virtualMachineNamePrefix')), 'GuestAttestation')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "publisher": "Microsoft.Azure.Security.WindowsAttestation",
                                "type": "GuestAttestation",
                                "typeHandlerVersion": "1.0",
                                "autoUpgradeMinorVersion": true,
                                "settings": {
                                  "AttestationConfig": {
                                    "MaaSettings": {
                                      "maaEndpoint": "",
                                      "maaTenantName": "GuestAttestation"
                                    },
                                    "AscSettings": {
                                      "ascReportingEndpoint": "",
                                      "ascReportingFrequency": ""
                                    },
                                    "useCustomToken": "false",
                                    "disableAlerts": "false"
                                  }
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', format('{0}-0', parameters('virtualMachineNamePrefix')))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2023-03-01",
                              "name": "[format('{0}/{1}', format('{0}-0', parameters('virtualMachineNamePrefix')), 'AzureMonitorWindowsAgent')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tagsVirtualMachines')]",
                              "properties": {
                                "publisher": "Microsoft.Azure.Monitor",
                                "type": "AzureMonitorWindowsAgent",
                                "typeHandlerVersion": "1.0",
                                "autoUpgradeMinorVersion": true,
                                "enableAutomaticUpgrade": true
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', format('{0}-0', parameters('virtualMachineNamePrefix')))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                              "apiVersion": "2022-06-01",
                              "scope": "[resourceId('Microsoft.Compute/virtualMachines', format('{0}-0', parameters('virtualMachineNamePrefix')))]",
                              "name": "[parameters('dataCollectionRuleAssociationName')]",
                              "properties": {
                                "dataCollectionRuleId": "[parameters('dataCollectionRuleResourceId')]",
                                "description": "AVD Insights data collection rule association"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', format('{0}-0', parameters('virtualMachineNamePrefix')), 'AzureMonitorWindowsAgent')]",
                                "[resourceId('Microsoft.Compute/virtualMachines', format('{0}-0', parameters('virtualMachineNamePrefix')))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2021-03-01",
                              "name": "[format('{0}/{1}', format('{0}-0', parameters('virtualMachineNamePrefix')), 'DesiredStateConfiguration')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "publisher": "Microsoft.Powershell",
                                "type": "DSC",
                                "typeHandlerVersion": "2.73",
                                "autoUpgradeMinorVersion": true,
                                "settings": {
                                  "modulesUrl": "[parameters('avdConfigurationZipFileUri')]",
                                  "configurationFunction": "Configuration.ps1\\AddSessionHost",
                                  "properties": {
                                    "hostPoolName": "[split(parameters('hostPoolResourceId'), '/')[8]]",
                                    "registrationInfoTokenCredential": {
                                      "UserName": "PLACEHOLDER_DO_NOT_USE",
                                      "Password": "PrivateSettingsRef:RegistrationInfoToken"
                                    },
                                    "aadJoin": "[contains(parameters('activeDirectorySolution'), 'EntraId')]",
                                    "UseAgentDownloadEndpoint": false,
                                    "mdmId": "[if(variables('intune'), '0000000a-0000-0000-c000-000000000000', '')]"
                                  }
                                },
                                "protectedSettings": {
                                  "Items": {
                                    "RegistrationInfoToken": "[listRegistrationTokens(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostPoolResourceId'), '/')[2], split(parameters('hostPoolResourceId'), '/')[4]), 'Microsoft.DesktopVirtualization/hostPools', split(parameters('hostPoolResourceId'), '/')[8]), '2023-09-05').value[0].token]"
                                  }
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Resources/deployments', format('set-config-{0}', parameters('deploymentNameSuffix')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', format('{0}-0', parameters('virtualMachineNamePrefix')))]"
                              ]
                            },
                            {
                              "condition": "[contains(parameters('activeDirectorySolution'), 'EntraId')]",
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2021-03-01",
                              "name": "[format('{0}/{1}', format('{0}-0', parameters('virtualMachineNamePrefix')), 'AADLoginForWindows')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tagsVirtualMachines')]",
                              "properties": {
                                "publisher": "Microsoft.Azure.ActiveDirectory",
                                "type": "AADLoginForWindows",
                                "typeHandlerVersion": "2.0",
                                "autoUpgradeMinorVersion": true,
                                "settings": "[if(variables('intune'), createObject('mdmId', '0000000a-0000-0000-c000-000000000000'), null())]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Resources/deployments', format('set-config-{0}', parameters('deploymentNameSuffix')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', format('{0}-0', parameters('virtualMachineNamePrefix')))]"
                              ]
                            },
                            {
                              "condition": "[contains(variables('amdVmSizes'), parameters('virtualMachineSize'))]",
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2021-03-01",
                              "name": "[format('{0}/{1}', format('{0}-0', parameters('virtualMachineNamePrefix')), 'AmdGpuDriverWindows')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tagsVirtualMachines')]",
                              "properties": {
                                "publisher": "Microsoft.HpcCompute",
                                "type": "AmdGpuDriverWindows",
                                "typeHandlerVersion": "1.0",
                                "autoUpgradeMinorVersion": true,
                                "settings": {}
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', format('{0}-0', parameters('virtualMachineNamePrefix')), 'AADLoginForWindows')]",
                                "[resourceId('Microsoft.Compute/virtualMachines', format('{0}-0', parameters('virtualMachineNamePrefix')))]"
                              ]
                            },
                            {
                              "condition": "[contains(variables('nvidiaVmSizes'), parameters('virtualMachineSize'))]",
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2021-03-01",
                              "name": "[format('{0}/{1}', format('{0}-0', parameters('virtualMachineNamePrefix')), 'NvidiaGpuDriverWindows')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tagsVirtualMachines')]",
                              "properties": {
                                "publisher": "Microsoft.HpcCompute",
                                "type": "NvidiaGpuDriverWindows",
                                "typeHandlerVersion": "1.9",
                                "autoUpgradeMinorVersion": true,
                                "settings": "[if(and(startsWith(parameters('virtualMachineSize'), 'Standard_NV'), or(endsWith(parameters('virtualMachineSize'), 's_v3'), endsWith(parameters('virtualMachineSize'), 's_A10_v5'))), createObject('driverVersion', '538.46'), createObject())]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', format('{0}-0', parameters('virtualMachineNamePrefix')), 'AADLoginForWindows')]",
                                "[resourceId('Microsoft.Compute/virtualMachines', format('{0}-0', parameters('virtualMachineNamePrefix')))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('set-config-{0}', parameters('deploymentNameSuffix'))]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "name": {
                                    "value": "Set-SessionHostConfiguration"
                                  },
                                  "parameters": {
                                    "value": [
                                      {
                                        "name": "FileShare",
                                        "value": "[parameters('fileShare')]"
                                      }
                                    ]
                                  },
                                  "script": {
                                    "value": "[variables('$fxv#0')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tagsVirtualMachines')]"
                                  },
                                  "virtualMachineName": {
                                    "value": "[format('{0}-0', parameters('virtualMachineNamePrefix'))]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.40.2.10011",
                                      "templateHash": "8938302959982937499"
                                    }
                                  },
                                  "parameters": {
                                    "asyncExecution": {
                                      "type": "bool",
                                      "defaultValue": false
                                    },
                                    "location": {
                                      "type": "string"
                                    },
                                    "name": {
                                      "type": "string"
                                    },
                                    "parameters": {
                                      "type": "array",
                                      "defaultValue": []
                                    },
                                    "script": {
                                      "type": "string"
                                    },
                                    "tags": {
                                      "type": "object"
                                    },
                                    "treatFailureAsDeploymentFailure": {
                                      "type": "bool",
                                      "defaultValue": true
                                    },
                                    "virtualMachineName": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                                      "apiVersion": "2023-09-01",
                                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), parameters('name'))]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "asyncExecution": "[parameters('asyncExecution')]",
                                        "parameters": "[parameters('parameters')]",
                                        "source": {
                                          "script": "[parameters('script')]"
                                        },
                                        "treatFailureAsDeploymentFailure": "[parameters('treatFailureAsDeploymentFailure')]"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[extensionResourceId(resourceId('Microsoft.Compute/virtualMachines', format('{0}-0', parameters('virtualMachineNamePrefix'))), 'Microsoft.Insights/dataCollectionRuleAssociations', parameters('dataCollectionRuleAssociationName'))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', format('{0}-0', parameters('virtualMachineNamePrefix')))]"
                              ]
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-control-plane-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-management-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-tier3-avd-stamp-{0}', parameters('deploymentNameSuffix')))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-azure-netapp-files-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-mission-landing-zone-{0}', parameters('deploymentNameSuffix')))]"
      ]
    }
  ]
}