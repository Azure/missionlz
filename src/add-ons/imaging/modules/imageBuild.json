{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.33.93.31351",
      "templateHash": "7443211343054596224"
    }
  },
  "parameters": {
    "arcGisProInstaller": {
      "type": "string",
      "defaultValue": ""
    },
    "computeGalleryImageResourceId": {
      "type": "string",
      "defaultValue": ""
    },
    "computeGalleryName": {
      "type": "string"
    },
    "containerName": {
      "type": "string"
    },
    "customizations": {
      "type": "array",
      "defaultValue": []
    },
    "deploymentNameSuffix": {
      "type": "string",
      "defaultValue": "[utcNow('yyMMddHHs')]"
    },
    "diskEncryptionSetResourceId": {
      "type": "string"
    },
    "enableBuildAutomation": {
      "type": "bool",
      "defaultValue": false
    },
    "excludeFromLatest": {
      "type": "bool",
      "defaultValue": true
    },
    "hybridUseBenefit": {
      "type": "bool",
      "defaultValue": false
    },
    "imageDefinitionName": {
      "type": "string"
    },
    "imageMajorVersion": {
      "type": "int"
    },
    "imageMinorVersion": {
      "type": "int"
    },
    "imagePatchVersion": {
      "type": "int"
    },
    "imageVirtualMachineName": {
      "type": "string"
    },
    "installAccess": {
      "type": "bool",
      "defaultValue": false
    },
    "installArcGisPro": {
      "type": "bool",
      "defaultValue": false
    },
    "installExcel": {
      "type": "bool",
      "defaultValue": false
    },
    "installOneDrive": {
      "type": "bool",
      "defaultValue": false
    },
    "installOneNote": {
      "type": "bool",
      "defaultValue": false
    },
    "installOutlook": {
      "type": "bool",
      "defaultValue": false
    },
    "installPowerPoint": {
      "type": "bool",
      "defaultValue": false
    },
    "installProject": {
      "type": "bool",
      "defaultValue": false
    },
    "installPublisher": {
      "type": "bool",
      "defaultValue": false
    },
    "installSkypeForBusiness": {
      "type": "bool",
      "defaultValue": false
    },
    "installTeams": {
      "type": "bool",
      "defaultValue": false
    },
    "installUpdates": {
      "type": "bool",
      "defaultValue": false
    },
    "installVirtualDesktopOptimizationTool": {
      "type": "bool",
      "defaultValue": false
    },
    "installVisio": {
      "type": "bool",
      "defaultValue": false
    },
    "installWord": {
      "type": "bool",
      "defaultValue": false
    },
    "keyVaultName": {
      "type": "string"
    },
    "location": {
      "type": "string",
      "defaultValue": "[deployment().location]"
    },
    "managementVirtualMachineName": {
      "type": "string"
    },
    "marketplaceImageOffer": {
      "type": "string"
    },
    "marketplaceImagePublisher": {
      "type": "string"
    },
    "marketplaceImageSKU": {
      "type": "string"
    },
    "mlzTags": {
      "type": "object",
      "defaultValue": {}
    },
    "msrdcwebrtcsvcInstaller": {
      "type": "string",
      "defaultValue": ""
    },
    "officeInstaller": {
      "type": "string",
      "defaultValue": ""
    },
    "replicaCount": {
      "type": "int",
      "defaultValue": 1
    },
    "resourceGroupName": {
      "type": "string"
    },
    "runbookExecution": {
      "type": "bool",
      "defaultValue": false
    },
    "sourceImageType": {
      "type": "string",
      "defaultValue": "AzureMarketplace"
    },
    "storageAccountResourceId": {
      "type": "string"
    },
    "subnetResourceId": {
      "type": "string"
    },
    "tags": {
      "type": "object",
      "defaultValue": {}
    },
    "teamsInstaller": {
      "type": "string",
      "defaultValue": ""
    },
    "updateService": {
      "type": "string",
      "defaultValue": "MU"
    },
    "userAssignedIdentityClientId": {
      "type": "string"
    },
    "userAssignedIdentityPrincipalId": {
      "type": "string"
    },
    "userAssignedIdentityResourceId": {
      "type": "string"
    },
    "vcRedistInstaller": {
      "type": "string",
      "defaultValue": ""
    },
    "vDOTInstaller": {
      "type": "string",
      "defaultValue": ""
    },
    "virtualMachineAdminPassword": {
      "type": "securestring",
      "defaultValue": ""
    },
    "virtualMachineAdminUsername": {
      "type": "securestring",
      "defaultValue": ""
    },
    "virtualMachineSize": {
      "type": "string"
    },
    "wsusServer": {
      "type": "string",
      "defaultValue": ""
    }
  },
  "variables": {
    "autoImageVersion": "[format('{0}.{1}.{2}', parameters('imageMajorVersion'), parameters('imageMinorVersion'), parameters('imagePatchVersion'))]",
    "storageAccountName": "[split(parameters('storageAccountResourceId'), '/')[8]]",
    "storageEndpoint": "[environment().suffixes.storage]",
    "subscriptionId": "[subscription().subscriptionId]"
  },
  "resources": [
    {
      "condition": "[not(parameters('enableBuildAutomation'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('management-vm-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[variables('subscriptionId')]",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "diskEncryptionSetResourceId": {
            "value": "[parameters('diskEncryptionSetResourceId')]"
          },
          "hybridUseBenefit": {
            "value": "[parameters('hybridUseBenefit')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "mlzTags": {
            "value": "[parameters('mlzTags')]"
          },
          "subnetResourceId": {
            "value": "[parameters('subnetResourceId')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "userAssignedIdentityResourceId": {
            "value": "[parameters('userAssignedIdentityResourceId')]"
          },
          "virtualMachineAdminPassword": {
            "value": "[parameters('virtualMachineAdminPassword')]"
          },
          "virtualMachineAdminUsername": {
            "value": "[parameters('virtualMachineAdminUsername')]"
          },
          "virtualMachineName": {
            "value": "[parameters('managementVirtualMachineName')]"
          },
          "virtualMachineSize": {
            "value": "[parameters('virtualMachineSize')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "15594129744731548865"
            }
          },
          "parameters": {
            "diskEncryptionSetResourceId": {
              "type": "string"
            },
            "hybridUseBenefit": {
              "type": "bool"
            },
            "location": {
              "type": "string"
            },
            "mlzTags": {
              "type": "object"
            },
            "subnetResourceId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "userAssignedIdentityResourceId": {
              "type": "string"
            },
            "virtualMachineAdminPassword": {
              "type": "securestring"
            },
            "virtualMachineAdminUsername": {
              "type": "string"
            },
            "virtualMachineName": {
              "type": "string"
            },
            "virtualMachineSize": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2023-04-01",
              "name": "[format('nic-{0}', parameters('virtualMachineName'))]",
              "location": "[parameters('location')]",
              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkInterfaces'), createObject()), parameters('mlzTags'))]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[parameters('subnetResourceId')]"
                      },
                      "primary": true,
                      "privateIPAddressVersion": "IPv4"
                    }
                  }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false
              }
            },
            {
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2022-03-01",
              "name": "[parameters('virtualMachineName')]",
              "location": "[parameters('location')]",
              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
              "identity": {
                "type": "SystemAssigned, UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('userAssignedIdentityResourceId'))]": {}
                }
              },
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('virtualMachineSize')]"
                },
                "osProfile": {
                  "adminPassword": "[parameters('virtualMachineAdminPassword')]",
                  "adminUsername": "[parameters('virtualMachineAdminUsername')]",
                  "computerName": "[parameters('virtualMachineName')]",
                  "windowsConfiguration": {
                    "provisionVMAgent": true,
                    "enableAutomaticUpdates": true,
                    "patchSettings": {
                      "patchMode": "AutomaticByOS",
                      "assessmentMode": "ImageDefault"
                    }
                  }
                },
                "storageProfile": {
                  "imageReference": {
                    "publisher": "MicrosoftWindowsServer",
                    "offer": "WindowsServer",
                    "sku": "2019-datacenter-core-g2",
                    "version": "latest"
                  },
                  "osDisk": {
                    "caching": "ReadWrite",
                    "createOption": "FromImage",
                    "deleteOption": "Delete",
                    "managedDisk": {
                      "diskEncryptionSet": {
                        "id": "[parameters('diskEncryptionSetResourceId')]"
                      },
                      "storageAccountType": "Premium_LRS"
                    },
                    "name": "[format('disk-{0}', parameters('virtualMachineName'))]",
                    "osType": "Windows"
                  }
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}', parameters('virtualMachineName')))]",
                      "properties": {
                        "deleteOption": "Delete"
                      }
                    }
                  ]
                },
                "diagnosticsProfile": {
                  "bootDiagnostics": {
                    "enabled": false
                  }
                },
                "securityProfile": {
                  "encryptionAtHost": true,
                  "uefiSettings": {
                    "secureBootEnabled": true,
                    "vTpmEnabled": true
                  },
                  "securityType": "TrustedLaunch"
                },
                "licenseType": "[if(parameters('hybridUseBenefit'), 'Windows_Server', null())]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}', parameters('virtualMachineName')))]"
              ]
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('virtualMachineName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('image-vm-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[variables('subscriptionId')]",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "marketplaceImageOffer": {
            "value": "[parameters('marketplaceImageOffer')]"
          },
          "marketplaceImagePublisher": {
            "value": "[parameters('marketplaceImagePublisher')]"
          },
          "marketplaceImageSKU": {
            "value": "[parameters('marketplaceImageSKU')]"
          },
          "mlzTags": {
            "value": "[parameters('mlzTags')]"
          },
          "computeGalleryImageResourceId": {
            "value": "[parameters('computeGalleryImageResourceId')]"
          },
          "sourceImageType": {
            "value": "[parameters('sourceImageType')]"
          },
          "subnetResourceId": {
            "value": "[parameters('subnetResourceId')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "userAssignedIdentityResourceId": {
            "value": "[parameters('userAssignedIdentityResourceId')]"
          },
          "virtualMachineAdminPassword": "[if(parameters('runbookExecution'), createObject('reference', createObject('keyVault', createObject('id', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))), 'secretName', 'VirtualMachineAdminPassword')), createObject('value', parameters('virtualMachineAdminPassword')))]",
          "virtualMachineAdminUsername": "[if(parameters('runbookExecution'), createObject('reference', createObject('keyVault', createObject('id', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))), 'secretName', 'VirtualMachineAdminUsername')), createObject('value', parameters('virtualMachineAdminUsername')))]",
          "virtualMachineName": {
            "value": "[parameters('imageVirtualMachineName')]"
          },
          "virtualMachineSize": {
            "value": "[parameters('virtualMachineSize')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "11393432732482196290"
            }
          },
          "parameters": {
            "computeGalleryImageResourceId": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "marketplaceImageOffer": {
              "type": "string"
            },
            "marketplaceImagePublisher": {
              "type": "string"
            },
            "marketplaceImageSKU": {
              "type": "string"
            },
            "mlzTags": {
              "type": "object"
            },
            "sourceImageType": {
              "type": "string"
            },
            "subnetResourceId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "userAssignedIdentityResourceId": {
              "type": "string"
            },
            "virtualMachineAdminPassword": {
              "type": "securestring"
            },
            "virtualMachineAdminUsername": {
              "type": "securestring"
            },
            "virtualMachineName": {
              "type": "string"
            },
            "virtualMachineSize": {
              "type": "string"
            }
          },
          "variables": {
            "imageReference": "[if(equals(parameters('sourceImageType'), 'AzureComputeGallery'), createObject('id', parameters('computeGalleryImageResourceId')), createObject('publisher', parameters('marketplaceImagePublisher'), 'offer', parameters('marketplaceImageOffer'), 'sku', parameters('marketplaceImageSKU'), 'version', 'latest'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2022-05-01",
              "name": "[format('nic-{0}', parameters('virtualMachineName'))]",
              "location": "[parameters('location')]",
              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkInterfaces'), createObject()), parameters('mlzTags'))]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[parameters('subnetResourceId')]"
                      }
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2022-03-01",
              "name": "[parameters('virtualMachineName')]",
              "location": "[parameters('location')]",
              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('userAssignedIdentityResourceId'))]": {}
                }
              },
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('virtualMachineSize')]"
                },
                "osProfile": {
                  "adminPassword": "[parameters('virtualMachineAdminPassword')]",
                  "adminUsername": "[parameters('virtualMachineAdminUsername')]",
                  "computerName": "[parameters('virtualMachineName')]"
                },
                "storageProfile": {
                  "imageReference": "[variables('imageReference')]",
                  "osDisk": {
                    "createOption": "FromImage",
                    "deleteOption": "Delete",
                    "managedDisk": {
                      "storageAccountType": "StandardSSD_LRS"
                    },
                    "name": "[format('disk-{0}', parameters('virtualMachineName'))]"
                  }
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}', parameters('virtualMachineName')))]",
                      "properties": {
                        "deleteOption": "Delete"
                      }
                    }
                  ]
                },
                "diagnosticsProfile": {
                  "bootDiagnostics": {
                    "enabled": false
                  }
                },
                "securityProfile": {
                  "uefiSettings": {
                    "secureBootEnabled": true,
                    "vTpmEnabled": true
                  },
                  "securityType": "TrustedLaunch"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}', parameters('virtualMachineName')))]"
              ]
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('virtualMachineName')]"
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('customizations-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[variables('subscriptionId')]",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "arcGisProInstaller": {
            "value": "[parameters('arcGisProInstaller')]"
          },
          "containerName": {
            "value": "[parameters('containerName')]"
          },
          "customizations": {
            "value": "[parameters('customizations')]"
          },
          "installAccess": {
            "value": "[parameters('installAccess')]"
          },
          "installArcGisPro": {
            "value": "[parameters('installArcGisPro')]"
          },
          "installExcel": {
            "value": "[parameters('installExcel')]"
          },
          "installOneDrive": {
            "value": "[parameters('installOneDrive')]"
          },
          "installOneNote": {
            "value": "[parameters('installOneNote')]"
          },
          "installOutlook": {
            "value": "[parameters('installOutlook')]"
          },
          "installPowerPoint": {
            "value": "[parameters('installPowerPoint')]"
          },
          "installProject": {
            "value": "[parameters('installProject')]"
          },
          "installPublisher": {
            "value": "[parameters('installPublisher')]"
          },
          "installSkypeForBusiness": {
            "value": "[parameters('installSkypeForBusiness')]"
          },
          "installTeams": {
            "value": "[parameters('installTeams')]"
          },
          "installVirtualDesktopOptimizationTool": {
            "value": "[parameters('installVirtualDesktopOptimizationTool')]"
          },
          "installVisio": {
            "value": "[parameters('installVisio')]"
          },
          "installWord": {
            "value": "[parameters('installWord')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "mlzTags": {
            "value": "[parameters('mlzTags')]"
          },
          "msrdcwebrtcsvcInstaller": {
            "value": "[parameters('msrdcwebrtcsvcInstaller')]"
          },
          "officeInstaller": {
            "value": "[parameters('officeInstaller')]"
          },
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "storageEndpoint": {
            "value": "[variables('storageEndpoint')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "teamsInstaller": {
            "value": "[parameters('teamsInstaller')]"
          },
          "userAssignedIdentityObjectId": {
            "value": "[parameters('userAssignedIdentityPrincipalId')]"
          },
          "vcRedistInstaller": {
            "value": "[parameters('vcRedistInstaller')]"
          },
          "vDotInstaller": {
            "value": "[parameters('vDOTInstaller')]"
          },
          "virtualMachineName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix'))), '2022-09-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "16455535134300982050"
            }
          },
          "parameters": {
            "arcGisProInstaller": {
              "type": "string"
            },
            "containerName": {
              "type": "string"
            },
            "customizations": {
              "type": "array"
            },
            "installAccess": {
              "type": "bool"
            },
            "installArcGisPro": {
              "type": "bool"
            },
            "installExcel": {
              "type": "bool"
            },
            "installOneDrive": {
              "type": "bool"
            },
            "installOneNote": {
              "type": "bool"
            },
            "installOutlook": {
              "type": "bool"
            },
            "installPowerPoint": {
              "type": "bool"
            },
            "installProject": {
              "type": "bool"
            },
            "installPublisher": {
              "type": "bool"
            },
            "installSkypeForBusiness": {
              "type": "bool"
            },
            "installTeams": {
              "type": "bool"
            },
            "installVirtualDesktopOptimizationTool": {
              "type": "bool"
            },
            "installVisio": {
              "type": "bool"
            },
            "installWord": {
              "type": "bool"
            },
            "location": {
              "type": "string"
            },
            "mlzTags": {
              "type": "object"
            },
            "msrdcwebrtcsvcInstaller": {
              "type": "string"
            },
            "officeInstaller": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "storageEndpoint": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "teamsInstaller": {
              "type": "string"
            },
            "userAssignedIdentityObjectId": {
              "type": "string"
            },
            "vcRedistInstaller": {
              "type": "string"
            },
            "vDotInstaller": {
              "type": "string"
            },
            "virtualMachineName": {
              "type": "string"
            }
          },
          "variables": {
            "installAccessVar": "[format('{0}installAccess', parameters('installAccess'))]",
            "installers": "[parameters('customizations')]",
            "installExcelVar": "[format('{0}installExcel', parameters('installExcel'))]",
            "installOneDriveVar": "[format('{0}installOneDrive', parameters('installOneDrive'))]",
            "installOneNoteVar": "[format('{0}installOneNote', parameters('installOneNote'))]",
            "installOutlookVar": "[format('{0}installOutlook', parameters('installOutlook'))]",
            "installPowerPointVar": "[format('{0}installPowerPoint', parameters('installPowerPoint'))]",
            "installProjectVar": "[format('{0}installProject', parameters('installProject'))]",
            "installPublisherVar": "[format('{0}installPublisher', parameters('installPublisher'))]",
            "installSkypeForBusinessVar": "[format('{0}installSkypeForBusiness', parameters('installSkypeForBusiness'))]",
            "installVisioVar": "[format('{0}installVisio', parameters('installVisio'))]",
            "installWordVar": "[format('{0}installWord', parameters('installWord'))]"
          },
          "resources": [
            {
              "copy": {
                "name": "applications",
                "count": "[length(variables('installers'))]",
                "mode": "serial",
                "batchSize": 1
              },
              "condition": "[variables('installers')[copyIndex()].enabled]",
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('app-{0}', variables('installers')[copyIndex()].name))]",
              "location": "[parameters('location')]",
              "tags": "[union(if(contains(parameters('tags'), 'Microsoft.Compute/virtualMachines'), parameters('tags')['Microsoft.Compute/virtualMachines'], createObject()), parameters('mlzTags'))]",
              "properties": {
                "treatFailureAsDeploymentFailure": true,
                "asyncExecution": false,
                "parameters": [
                  {
                    "name": "UserAssignedIdentityObjectId",
                    "value": "[parameters('userAssignedIdentityObjectId')]"
                  },
                  {
                    "name": "StorageAccountName",
                    "value": "[parameters('storageAccountName')]"
                  },
                  {
                    "name": "ContainerName",
                    "value": "[parameters('containerName')]"
                  },
                  {
                    "name": "StorageEndpoint",
                    "value": "[parameters('storageEndpoint')]"
                  },
                  {
                    "name": "Blobname",
                    "value": "[variables('installers')[copyIndex()].blobName]"
                  },
                  {
                    "name": "Installer",
                    "value": "[variables('installers')[copyIndex()].name]"
                  },
                  {
                    "name": "Arguments",
                    "value": "[variables('installers')[copyIndex()].arguments]"
                  }
                ],
                "source": {
                  "script": "        param(\r\n          [string]$UserAssignedIdentityObjectId,\r\n          [string]$StorageAccountName,\r\n          [string]$ContainerName,\r\n          [string]$StorageEndpoint,\r\n          [string]$BlobName,\r\n          [string]$Installer,\r\n          [string]$Arguments\r\n        )\r\n        $ErrorActionPreference = 'Stop'\r\n        $WarningPreference = 'SilentlyContinue'\r\n        $StorageAccountUrl = \"https://\" + $StorageAccountName + \".blob.\" + $StorageEndpoint + \"/\"\r\n        $TokenUri = \"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=$StorageAccountUrl&object_id=$UserAssignedIdentityObjectId\"\r\n        $AccessToken = ((Invoke-WebRequest -Headers @{Metadata=$true} -Uri $TokenUri -UseBasicParsing).Content | ConvertFrom-Json).access_token\r\n        $BlobFileName = $BlobName.Split(\"/\")[-1]\r\n        New-Item -Path $env:windir\\temp -Name $Installer -ItemType \"directory\" -Force\r\n        $InstallerDirectory = \"$env:windir\\temp\\$Installer\"\r\n        Write-Host \"Setting file copy to install directory: $InstallerDirectory\"\r\n        Set-Location -Path $InstallerDirectory\r\n        Write-Host \"Invoking WebClient download for file : $BlobFileName\"\r\n        #Invoking WebClient to download blobs because it is more efficient than Invoke-WebRequest for large files.\r\n        $WebClient = New-Object System.Net.WebClient\r\n        $WebClient.Headers.Add('x-ms-version', '2017-11-09')\r\n        $webClient.Headers.Add(\"Authorization\", \"Bearer $AccessToken\")\r\n        $webClient.DownloadFile(\"$StorageAccountUrl$ContainerName/$BlobName\", \"$InstallerDirectory\\$BlobName\")\r\n        Start-Sleep -Seconds 30\r\n        $Path = (Get-ChildItem -Path \"$InstallerDirectory\\$BlobName\" -Recurse | Where-Object {$_.Name -eq \"$BlobName\"}).FullName\r\n        if($BlobName -like (\"*.exe\"))\r\n        {\r\n          Start-Process -FilePath $InstallerDirectory\\$BlobName -ArgumentList $Arguments -NoNewWindow -Wait -PassThru\r\n          $wmistatus = Get-WmiObject -Class Win32_Product | Where-Object Name -like \"*$($Installer)*\"\r\n          if($wmistatus)\r\n          {\r\n            Write-Host $wmistatus.Name \"is installed\"\r\n          }\r\n          $regstatus = Get-ItemProperty 'HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*' | Where-Object { $_.DisplayName -like \"*$($Installer)*\" }\r\n          if($regstatus)\r\n          {\r\n            Write-Host $regstatus.DisplayName \"is installed\"\r\n          }\r\n          $regstatusWow6432 = Get-ItemProperty 'HKLM:\\Software\\WOW6432Node\\*' | Where-Object { $_.PSChildName -like \"*$($Installer)*\" }\r\n          if($regstatusWow6432)\r\n          {\r\n            Write-Host $regstatusWow6432.PSChildName \"is installed\"\r\n          }\r\n          else\r\n          {\r\n            Write-host $Installer \"did not install properly, please check arguments\"\r\n          }\r\n        }\r\n        if($BlobName -like (\"*.msi\"))\r\n        {\r\n          Write-Host \"Invoking msiexec.exe for install path : $Path\"\r\n          Start-Process -FilePath msiexec.exe -ArgumentList \"/i $Path $Arguments\" -Wait\r\n          $status = Get-WmiObject -Class Win32_Product | Where-Object Name -like \"*$($installer)*\"\r\n          if($status)\r\n          {\r\n            Write-Host $status.Name \"is installed\"\r\n          }\r\n          else\r\n          {\r\n            Write-host $Installer \"did not install properly, please check arguments\"\r\n          }\r\n        }\r\n        if($BlobName -like (\"*.bat\"))\r\n        {\r\n          Start-Process -FilePath cmd.exe -ArgumentList $InstallerDirectory\\$Arguments -Wait\r\n        }\r\n        if($BlobName -like (\"*.ps1\"))\r\n        {\r\n          if($BlobName -like (\"Install-BundleSoftware.ps1\"))\r\n          {\r\n            Start-Process -FilePath PowerShell.exe -ArgumentList \"-File $Path -UserAssignedIdentityObjectId $UserAssignedIdentityObjectId -StorageAccountName $StorageAccountName -ContainerName $ContainerName -StorageEndpoint $StorageEndpoint $Arguments\" -Wait\r\n          }\r\n          else\r\n          {\r\n            Start-Process -FilePath PowerShell.exe -ArgumentList \"-File $Path $Arguments\" -Wait\r\n          }\r\n        }\r\n        if($BlobName -like (\"*.zip\"))\r\n        {\r\n          Expand-Archive -Path $InstallerDirectory\\$BlobName -DestinationPath $InstallerDirectory -Force\r\n          Remove-Item -Path .\\$BlobName -Force -Recurse\r\n        }\r\n        Write-Host \"Removing $Installer Files\"\r\n        #Start-Sleep -Seconds 5\r\n        Remove-item $env:windir\\temp\\$Installer -Force -Recurse -Confirm:$false -ErrorAction SilentlyContinue\r\n       "
                }
              }
            },
            {
              "condition": "[or(or(or(or(or(or(or(or(or(or(parameters('installAccess'), parameters('installExcel')), parameters('installOneDrive')), parameters('installOneNote')), parameters('installOutlook')), parameters('installPowerPoint')), parameters('installPublisher')), parameters('installSkypeForBusiness')), parameters('installWord')), parameters('installVisio')), parameters('installProject'))]",
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'office')]",
              "location": "[parameters('location')]",
              "tags": "[union(if(contains(parameters('tags'), 'Microsoft.Compute/virtualMachines'), parameters('tags')['Microsoft.Compute/virtualMachines'], createObject()), parameters('mlzTags'))]",
              "properties": {
                "treatFailureAsDeploymentFailure": true,
                "asyncExecution": false,
                "parameters": [
                  {
                    "name": "InstallAccess",
                    "value": "[variables('installAccessVar')]"
                  },
                  {
                    "name": "InstallWord",
                    "value": "[variables('installWordVar')]"
                  },
                  {
                    "name": "InstallExcel",
                    "value": "[variables('installExcelVar')]"
                  },
                  {
                    "name": "InstallOneDrive",
                    "value": "[variables('installOneDriveVar')]"
                  },
                  {
                    "name": "InstallOneNote",
                    "value": "[variables('installOneNoteVar')]"
                  },
                  {
                    "name": "InstallOutlook",
                    "value": "[variables('installOutlookVar')]"
                  },
                  {
                    "name": "InstallPowerPoint",
                    "value": "[variables('installPowerPointVar')]"
                  },
                  {
                    "name": "InstallProject",
                    "value": "[variables('installProjectVar')]"
                  },
                  {
                    "name": "InstallPublisher",
                    "value": "[variables('installPublisherVar')]"
                  },
                  {
                    "name": "InstallSkypeForBusiness",
                    "value": "[variables('installSkypeForBusinessVar')]"
                  },
                  {
                    "name": "InstallVisio",
                    "value": "[variables('installVisioVar')]"
                  },
                  {
                    "name": "UserAssignedIdentityObjectId",
                    "value": "[parameters('userAssignedIdentityObjectId')]"
                  },
                  {
                    "name": "StorageAccountName",
                    "value": "[parameters('storageAccountName')]"
                  },
                  {
                    "name": "ContainerName",
                    "value": "[parameters('containerName')]"
                  },
                  {
                    "name": "StorageEndpoint",
                    "value": "[parameters('storageEndpoint')]"
                  },
                  {
                    "name": "BlobName",
                    "value": "[parameters('officeInstaller')]"
                  }
                ],
                "source": {
                  "script": "      param(\r\n        [string]$InstallAccess,\r\n        [string]$InstallExcel,\r\n        [string]$InstallOneDrive,\r\n        [string]$InstallOutlook,\r\n        [string]$InstallProject,\r\n        [string]$InstallPublisher,\r\n        [string]$InstallSkypeForBusiness,\r\n        [string]$InstallVisio,\r\n        [string]$InstallWord,\r\n        [string]$InstallOneNote,\r\n        [string]$InstallPowerPoint,\r\n        [string]$UserAssignedIdentityObjectId,\r\n        [string]$StorageAccountName,\r\n        [string]$ContainerName,\r\n        [string]$StorageEndpoint,\r\n        [string]$BlobName\r\n      )\r\n      $ErrorActionPreference = 'Stop'\r\n      $WarningPreference = 'SilentlyContinue'\r\n      $StorageAccountUrl = \"https://\" + $StorageAccountName + \".blob.\" + $StorageEndpoint + \"/\"\r\n      $TokenUri = \"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=$StorageAccountUrl&object_id=$UserAssignedIdentityObjectId\"\r\n      $AccessToken = ((Invoke-WebRequest -Headers @{Metadata=$true} -Uri $TokenUri -UseBasicParsing).Content | ConvertFrom-Json).access_token\r\n      New-Item -Path \"$env:windir\\temp\\office\" -ItemType \"directory\" -Force\r\n      $sku = (Get-ComputerInfo).OsName\r\n      $o365ConfigHeader = Set-Content \"$env:windir\\temp\\office\\office365x64.xml\" '<Configuration><Add OfficeClientEdition=\"64\" Channel=\"Current\">'\r\n      $o365OfficeHeader = Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '<Product ID=\"O365ProPlusRetail\"><Language ID=\"en-us\" /><ExcludeApp ID=\"Teams\"/>'\r\n      if($InstallAccess -notlike '*true*'){\r\n          Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '<ExcludeApp ID=\"Access\" />'\r\n      }\r\n      if($InstallExcel -notlike '*true*'){\r\n          Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '<ExcludeApp ID=\"Excel\" />'\r\n      }\r\n      if($InstallOneDrive -notlike '*true*'){\r\n          Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '<ExcludeApp ID=\"OneDrive\" />'\r\n      }\r\n      if($InstallOneNote -notlike '*true*'){\r\n          Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '<ExcludeApp ID=\"OneNote\" />'\r\n      }\r\n      if($InstallOutlook -notlike '*true*'){\r\n          Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '<ExcludeApp ID=\"Outlook\" />'\r\n      }\r\n      if($InstallPowerPoint -notlike '*true*'){\r\n          Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '<ExcludeApp ID=\"PowerPoint\" />'\r\n      }\r\n      if($InstallPublisher -notlike '*true*'){\r\n          Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '<ExcludeApp ID=\"Publisher\" />'\r\n      }\r\n      if($InstallSkypeForBusiness -notlike '*true*'){\r\n          Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '<ExcludeApp ID=\"Lync\" />'\r\n      }\r\n      if($InstallWord -notlike '*true*'){\r\n          Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '<ExcludeApp ID=\"Word\" />'\r\n      }\r\n      $addOfficefooter = Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '</Product>'\r\n      if($InstallProject -like '*true*'){\r\n        Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '<Product ID=\"ProjectProRetail\"><Language ID=\"en-us\" /></Product>'\r\n      }\r\n      if($InstallVisio -like '*true*'){\r\n        Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '<Product ID=\"VisioProRetail\"><Language ID=\"en-us\" /></Product>'\r\n      }\r\n      Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '</Add><Updates Enabled=\"FALSE\" /><Display Level=\"None\" AcceptEULA=\"TRUE\" /><Property Name=\"FORCEAPPSHUTDOWN\" Value=\"TRUE\"/>'\r\n      $PerMachineConfiguration = if(($Sku).Contains(\"multi\") -eq \"true\"){\r\n          Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '<Property Name=\"SharedComputerLicensing\" Value=\"1\"/>'\r\n      }\r\n      Add-Content \"$env:windir\\temp\\office\\office365x64.xml\" '</Configuration>'\r\n      $Installer = \"$env:windir\\temp\\office\\office.exe\"\r\n      #$DownloadLinks = Invoke-WebRequest -Uri \"https://www.microsoft.com/en-us/download/confirmation.aspx?id=49117\" -UseBasicParsing\r\n      #$URL = $DownloadLinks.Links.href | Where-Object {$_ -like \"https://download.microsoft.com/download/*officedeploymenttool*\"} | Select-Object -First 1\r\n      #Invoke-WebRequest -Uri $URL -OutFile $Installer -UseBasicParsing\r\n      Invoke-WebRequest -Headers @{\"x-ms-version\"=\"2017-11-09\"; Authorization =\"Bearer $AccessToken\"} -Uri \"$StorageAccountUrl$ContainerName/$BlobName\" -OutFile $Installer\r\n      Start-Process -FilePath $Installer -ArgumentList \"/extract:$env:windir\\temp\\office /quiet /passive /norestart\" -Wait -PassThru | Out-Null\r\n      Write-Host \"Downloaded & extracted the Office 365 Deployment Toolkit\"\r\n      Start-Process -FilePath \"$env:windir\\temp\\office\\setup.exe\" -ArgumentList \"/configure $env:windir\\temp\\office\\office365x64.xml\" -Wait -PassThru -ErrorAction \"Stop\" | Out-Null\r\n      Write-Host \"Installed the selected Office365 applications\"\r\n      Write-Host \"Removing Office FIles\"\r\n      Remove-item -Path  \"$env:windir\\temp\\office\" -Force -Confirm:$false -Recurse\r\n      "
                }
              },
              "dependsOn": [
                "applications"
              ]
            },
            {
              "condition": "[parameters('installVirtualDesktopOptimizationTool')]",
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'vdot')]",
              "location": "[parameters('location')]",
              "tags": "[union(if(contains(parameters('tags'), 'Microsoft.Compute/virtualMachines'), parameters('tags')['Microsoft.Compute/virtualMachines'], createObject()), parameters('mlzTags'))]",
              "properties": {
                "treatFailureAsDeploymentFailure": true,
                "asyncExecution": false,
                "parameters": [
                  {
                    "name": "UserAssignedIdentityObjectId",
                    "value": "[parameters('userAssignedIdentityObjectId')]"
                  },
                  {
                    "name": "StorageAccountName",
                    "value": "[parameters('storageAccountName')]"
                  },
                  {
                    "name": "ContainerName",
                    "value": "[parameters('containerName')]"
                  },
                  {
                    "name": "StorageEndpoint",
                    "value": "[parameters('storageEndpoint')]"
                  },
                  {
                    "name": "BlobName",
                    "value": "[parameters('vDotInstaller')]"
                  }
                ],
                "source": {
                  "script": "        param(\r\n          [string]$UserAssignedIdentityObjectId,\r\n          [string]$StorageAccountName,\r\n          [string]$ContainerName,\r\n          [string]$StorageEndpoint,\r\n          [string]$BlobName\r\n        )\r\n        $ErrorActionPreference = 'Stop'\r\n        $WarningPreference = 'SilentlyContinue'\r\n        $StorageAccountUrl = \"https://\" + $StorageAccountName + \".blob.\" + $StorageEndpoint + \"/\"\r\n        $TokenUri = \"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=$StorageAccountUrl&object_id=$UserAssignedIdentityObjectId\"\r\n        $AccessToken = ((Invoke-WebRequest -Headers @{Metadata=$true} -Uri $TokenUri -UseBasicParsing).Content | ConvertFrom-Json).access_token\r\n        $ZIP = \"$env:windir\\temp\\VDOT.zip\"\r\n        Invoke-WebRequest -Headers @{\"x-ms-version\"=\"2017-11-09\"; Authorization =\"Bearer $AccessToken\"} -Uri \"$StorageAccountUrl$ContainerName/$BlobName\" -OutFile $ZIP\r\n        Start-Sleep -Seconds 30\r\n        Set-Location -Path $env:windir\\temp\r\n        Unblock-File -Path $ZIP\r\n        Expand-Archive -LiteralPath $ZIP -DestinationPath \"$env:windir\\temp\" -Force\r\n        $Path = (Get-ChildItem -Path \"$env:windir\\temp\" -Recurse | Where-Object {$_.Name -eq \"Windows_VDOT.ps1\"}).FullName\r\n        $Script = Get-Content -Path $Path\r\n        $ScriptUpdate = $Script.Replace(\"Set-NetAdapterAdvancedProperty\",\"#Set-NetAdapterAdvancedProperty\")\r\n        $ScriptUpdate | Set-Content -Path $Path\r\n        & $Path -Optimizations @(\"AppxPackages\",\"Autologgers\",\"DefaultUserSettings\",\"LGPO\";\"NetworkOptimizations\",\"ScheduledTasks\",\"Services\",\"WindowsMediaPlayer\") -AdvancedOptimizations \"All\" -AcceptEULA\r\n        Write-Host \"Removing VDOT Files\"\r\n        # Expecting this format for vDot ZIP, update if using a different ZIP format for folder structure\r\n        Remove-Item -Path $env:windir\\temp\\Virtual-Desktop-Optimization-Tool-main -Force -Recurse -Confirm:$false\r\n        "
                },
                "timeoutInSeconds": 640
              },
              "dependsOn": [
                "applications",
                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('virtualMachineName'), 'office')]",
                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('virtualMachineName'), 'teams')]"
              ]
            },
            {
              "condition": "[parameters('installTeams')]",
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'teams')]",
              "location": "[parameters('location')]",
              "tags": "[union(if(contains(parameters('tags'), 'Microsoft.Compute/virtualMachines'), parameters('tags')['Microsoft.Compute/virtualMachines'], createObject()), parameters('mlzTags'))]",
              "properties": {
                "treatFailureAsDeploymentFailure": true,
                "asyncExecution": false,
                "parameters": [
                  {
                    "name": "UserAssignedIdentityObjectId",
                    "value": "[parameters('userAssignedIdentityObjectId')]"
                  },
                  {
                    "name": "StorageAccountName",
                    "value": "[parameters('storageAccountName')]"
                  },
                  {
                    "name": "ContainerName",
                    "value": "[parameters('containerName')]"
                  },
                  {
                    "name": "StorageEndpoint",
                    "value": "[parameters('storageEndpoint')]"
                  },
                  {
                    "name": "BlobName",
                    "value": "[parameters('teamsInstaller')]"
                  },
                  {
                    "name": "BlobName2",
                    "value": "[parameters('vcRedistInstaller')]"
                  },
                  {
                    "name": "BlobName3",
                    "value": "[parameters('msrdcwebrtcsvcInstaller')]"
                  }
                ],
                "source": {
                  "script": "      param(\r\n        [string]$UserAssignedIdentityObjectId,\r\n        [string]$StorageAccountName,\r\n        [string]$ContainerName,\r\n        [string]$StorageEndpoint,\r\n        [string]$BlobName,\r\n        [string]$BlobName2,\r\n        [string]$BlobName3\r\n      )\r\n      $ErrorActionPreference = 'Stop'\r\n      $WarningPreference = 'SilentlyContinue'\r\n      $StorageAccountUrl = \"https://\" + $StorageAccountName + \".blob.\" + $StorageEndpoint + \"/\"\r\n      $TokenUri = \"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=$StorageAccountUrl&object_id=$UserAssignedIdentityObjectId\"\r\n      $AccessToken = ((Invoke-WebRequest -Headers @{Metadata=$true} -Uri $TokenUri -UseBasicParsing).Content | ConvertFrom-Json).access_token\r\n      $vcRedistFile = \"$env:windir\\temp\\vc_redist.x64.exe\"\r\n      $webSocketFile = \"$env:windir\\temp\\webSocketSvc.msi\"\r\n      $teamsFile = \"$env:windir\\temp\\teams.msi\"\r\n      Invoke-WebRequest -Headers @{\"x-ms-version\"=\"2017-11-09\"; Authorization =\"Bearer $AccessToken\"} -Uri \"$StorageAccountUrl$ContainerName/$BlobName\" -OutFile $teamsFile\r\n      Invoke-WebRequest -Headers @{\"x-ms-version\"=\"2017-11-09\"; Authorization =\"Bearer $AccessToken\"} -Uri \"$StorageAccountUrl$ContainerName/$BlobName2\" -OutFile $vcRedistFile\r\n      Invoke-WebRequest -Headers @{\"x-ms-version\"=\"2017-11-09\"; Authorization =\"Bearer $AccessToken\"} -Uri \"$StorageAccountUrl$ContainerName/$BlobName3\" -OutFile  $webSocketFile\r\n\r\n      # Enable media optimizations for Team\r\n      Start-Process \"reg\" -ArgumentList \"add HKLM\\SOFTWARE\\Microsoft\\Teams /v IsWVDEnvironment /t REG_DWORD /d 1 /f\" -Wait -PassThru -ErrorAction \"Stop\"\r\n      Write-Host \"Enabled media optimizations for Teams\"\r\n      # Download & install the latest version of Microsoft Visual C++ Redistributable\r\n      #$File = \"$env:windir\\temp\\vc_redist.x64.exe\"\r\n      #Invoke-WebRequest -Uri \"https://aka.ms/vs/16/release/vc_redist.x64.exe\" -OutFile $File\r\n      Start-Process -FilePath  $vcRedistFile -Args \"/install /quiet /norestart /log vcdist.log\" -Wait -PassThru | Out-Null\r\n      Write-Host \"Installed the latest version of Microsoft Visual C++ Redistributable\"\r\n      # Download & install the Remote Desktop WebRTC Redirector Service\r\n      #$File = \"$env:windir\\temp\\webSocketSvc.msi\"\r\n      #Invoke-WebRequest -Uri \"https://aka.ms/msrdcwebrtcsvc/msi\" -OutFile $File\r\n      Start-Process -FilePath msiexec.exe -Args \"/i  $webSocketFile /quiet /qn /norestart /passive /log webSocket.log\" -Wait -PassThru | Out-Null\r\n      Write-Host \"Installed the Remote Desktop WebRTC Redirector Service\"\r\n      # Install Teams\r\n      #$File = \"$env:windir\\temp\\teams.msi\"\r\n      #Write-host $($TeamsUrl)\r\n      #Invoke-WebRequest -Uri \"$TeamsUrl\" -OutFile $File\r\n      $sku = (Get-ComputerInfo).OsName\r\n      $PerMachineConfiguration = if(($Sku).Contains(\"multi\") -eq \"true\"){\"ALLUSER=1\"}else{\"\"}\r\n      Start-Process -FilePath msiexec.exe -Args \"/i $teamsFile /quiet /qn /norestart /passive /log teams.log $PerMachineConfiguration ALLUSERS=1\" -Wait -PassThru | Out-Null\r\n      Write-Host \"Installed Teams\"\r\n      Write-Host \"Removing Teams Files\"\r\n      Remove-Item \"$teamsFile\" -Force -Confirm:$false\r\n      Remove-Item \"$vcRedistFile\" -Force -Confirm:$false\r\n      Remove-Item \"$webSocketFile\" -Force -Confirm:$false\r\n      "
                }
              },
              "dependsOn": [
                "applications",
                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('virtualMachineName'), 'office')]"
              ]
            },
            {
              "condition": "[parameters('installArcGisPro')]",
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'arcGisPro')]",
              "location": "[parameters('location')]",
              "tags": "[union(if(contains(parameters('tags'), 'Microsoft.Compute/virtualMachines'), parameters('tags')['Microsoft.Compute/virtualMachines'], createObject()), parameters('mlzTags'))]",
              "properties": {
                "treatFailureAsDeploymentFailure": true,
                "asyncExecution": false,
                "parameters": [
                  {
                    "name": "UserAssignedIdentityObjectId",
                    "value": "[parameters('userAssignedIdentityObjectId')]"
                  },
                  {
                    "name": "StorageAccountName",
                    "value": "[parameters('storageAccountName')]"
                  },
                  {
                    "name": "ContainerName",
                    "value": "[parameters('containerName')]"
                  },
                  {
                    "name": "StorageEndpoint",
                    "value": "[parameters('storageEndpoint')]"
                  },
                  {
                    "name": "BlobName",
                    "value": "[parameters('arcGisProInstaller')]"
                  }
                ],
                "source": {
                  "script": "      param(\r\n        [string]$UserAssignedIdentityObjectId,\r\n        [string]$StorageAccountName,\r\n        [string]$ContainerName,\r\n        [string]$StorageEndpoint,\r\n        [string]$BlobName\r\n      )\r\n      $ErrorActionPreference = 'Stop'\r\n      $WarningPreference = 'SilentlyContinue'\r\n      $StorageAccountUrl = \"https://\" + $StorageAccountName + \".blob.\" + $StorageEndpoint + \"/\"\r\n      $TokenUri = \"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=$StorageAccountUrl&object_id=$UserAssignedIdentityObjectId\"\r\n      $AccessToken = ((Invoke-WebRequest -Headers @{Metadata=$true} -Uri $TokenUri -UseBasicParsing).Content | ConvertFrom-Json).access_token\r\n      # Retrieve Files\r\n      New-Item -Path $env:windir\\temp -Name arcgis -ItemType \"directory\" -Force\r\n      $ZIP = \"$env:windir\\temp\\arcgispro.zip\"\r\n      Invoke-WebRequest -Headers @{\"x-ms-version\"=\"2017-11-09\"; Authorization =\"Bearer $AccessToken\"} -Uri \"$StorageAccountUrl$ContainerName/$BlobName\" -OutFile $ZIP\r\n      Start-Sleep -Seconds 30\r\n      Set-Location -Path $env:windir\\temp\r\n      Unblock-File -Path $ZIP\r\n      Expand-Archive -LiteralPath $ZIP -DestinationPath \"$env:windir\\temp\\arcgis\" -Force\r\n\r\n      # Install Arcgis\r\n      $arcGisProMsi = (Get-ChildItem \"$env:windir\\temp\\arcgis\\\" -Recurse | where {$_.Name -eq \"ArcGisPro.msi\"})\r\n      $arcGisProMsp = (Get-ChildItem \"$env:windir\\temp\\arcgis\" -Recurse | where {$_.Extension -eq \".msp\"})\r\n      $winDesktopRuntime = (Get-ChildItem \"$env:windir\\temp\\arcgis\\\" -Recurse | where {$_.Name -like \"windowsdesktop-runtime-*\"})\r\n\r\n      # If found Install Windows Desktop Runtime Pre-Req\r\n      try {\r\n        if ($winDesktopRuntime ){\r\n            Start-Process -FilePath \"$($winDesktopRuntime.Directory.FullName)\\$winDesktopRuntime\" -ArgumentList \"/install /quiet /norestart\" -Wait -NoNewWindow -PassThru\r\n        }\r\n      }\r\n      catch {\r\n        Write-Output \"Please validate all software requirements are included with the ArcGIS Pro Zip\"\r\n      }\r\n\r\n      try {\r\n        # Install ArcGis Pro\r\n        $arcGisProArguments = \"/i $($arcGisProMsi.Directory.FullName)\\$arcGisProMsi ALLUSERS=1 ACCEPTEULA=yes ENABLEEUEI=0 SOFTWARE_CLASS=Professional AUTHORIZATION_TYPE=NAMED_USER LOCK_AUTH_SETTINGS=False ArcGIS_Connection=TRUE /qn /norestart\"\r\n        Start-Process \"msiexec.exe\" -ArgumentList $arcGisProArguments  -Wait -NoNewWindow -PassThru\r\n      }\r\n      catch {\r\n        Write-Output \"Please validate all software requirements are included with the ArcGIS Pro Zip\"\r\n      }\r\n\r\n      try {\r\n      # If MSP is found, patch ArcGisPro with MSP file\r\n      if($arcGisProMsp){\r\n          Start-Process \"msiexec.exe\" -ArgumentList \"/p $($arcGisProMsp.Directory.FullName)\\$arcGisProMsp /qn\" -Wait -NoNewWindow -PassThru\r\n      }\r\n    }\r\n    catch {\r\n      Write-Output \"Please validate all software requirements are included with the ArcGIS Pro Zip\"\r\n    }\r\n    Write-Host \"Removing ArcGis Files\"\r\n    Remove-Item $ZIP -Force -Confirm:$false -Recurse\r\n    Remove-item -Path  \"$env:windir\\temp\\arcgis\" -Force -Confirm:$false -Recurse\r\n    "
                }
              },
              "dependsOn": [
                "applications",
                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('virtualMachineName'), 'office')]",
                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('virtualMachineName'), 'teams')]",
                "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('virtualMachineName'), 'vdot')]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('restart-vm-1-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[variables('subscriptionId')]",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "imageVirtualMachineName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "resourceGroupName": {
            "value": "[parameters('resourceGroupName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "mlzTags": {
            "value": "[parameters('mlzTags')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "userAssignedIdentityClientId": {
            "value": "[parameters('userAssignedIdentityClientId')]"
          },
          "virtualMachineName": "[if(parameters('enableBuildAutomation'), createObject('value', parameters('managementVirtualMachineName')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('management-vm-{0}', parameters('deploymentNameSuffix'))), '2022-09-01').outputs.name.value))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "7400813670576825580"
            }
          },
          "parameters": {
            "imageVirtualMachineName": {
              "type": "string"
            },
            "resourceGroupName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "mlzTags": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            },
            "userAssignedIdentityClientId": {
              "type": "string"
            },
            "virtualMachineName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'restartVirtualMachine')]",
              "location": "[parameters('location')]",
              "tags": "[union(if(contains(parameters('tags'), 'Microsoft.Compute/virtualMachines'), parameters('tags')['Microsoft.Compute/virtualMachines'], createObject()), parameters('mlzTags'))]",
              "properties": {
                "treatFailureAsDeploymentFailure": true,
                "asyncExecution": false,
                "parameters": [
                  {
                    "name": "ResourceManagerUri",
                    "value": "[environment().resourceManager]"
                  },
                  {
                    "name": "UserAssignedIdentityClientId",
                    "value": "[parameters('userAssignedIdentityClientId')]"
                  },
                  {
                    "name": "VmResourceId",
                    "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Compute/virtualMachines', parameters('imageVirtualMachineName'))]"
                  }
                ],
                "source": {
                  "script": "        param(\r\n            [Parameter(Mandatory=$true)]\r\n            [string]$ResourceManagerUri,\r\n\r\n            [Parameter(Mandatory=$true)]\r\n            [string]$UserAssignedIdentityClientId,\r\n\r\n            [Parameter(Mandatory=$true)]\r\n            [string]$VmResourceId\r\n        )\r\n\r\n        $ErrorActionPreference = 'Stop'\r\n        $WarningPreference = 'SilentlyContinue'\r\n\r\n        Try {\r\n            # Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n            $ResourceManagerUriFixed = if($ResourceManagerUri[-1] -eq '/'){$ResourceManagerUri.Substring(0,$ResourceManagerUri.Length - 1)} else {$ResourceManagerUri}\r\n\r\n            # Get an access token for Azure resources\r\n            $AzureManagementAccessToken = (Invoke-RestMethod `\r\n                -Headers @{Metadata=\"true\"} `\r\n                -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n            # Set header for Azure Management API\r\n            $AzureManagementHeader = @{\r\n                'Content-Type'='application/json'\r\n                'Authorization'='Bearer ' + $AzureManagementAccessToken\r\n            }\r\n            \r\n            # Restart the VM\r\n            $null = Invoke-RestMethod -Headers $AzureManagementHeader -Method 'Post' -Uri $($ResourceManagerUriFixed + $VmResourceId + '/restart?api-version=2024-03-01')\r\n            $lastProvisioningState = \"\"\r\n            $VmStatus = Invoke-RestMethod -Headers $AzureManagementHeader -Method 'Get' -Uri $($ResourceManagerUriFixed + $VmResourceId + '/instanceView?api-version=2024-03-01')\r\n            $provisioningState = ($VMStatus.statuses | Where-Object {$_.code -like 'PowerState*'}).code\r\n            While ($provisioningState -ne \"PowerState/running\") {\r\n                $lastProvisioningState = $provisioningState\r\n                Start-Sleep -Seconds 5\r\n                $VmStatus = Invoke-RestMethod -Headers $AzureManagementHeader -Method 'Get' -Uri $($ResourceManagerUriFixed + $VmResourceId + '/instanceView?api-version=2024-03-01')\r\n                $provisioningState = ($VMStatus.statuses | Where-Object {$_.code -like 'PowerState*'}).code\r\n            }   \r\n        }\r\n        catch {\r\n            throw\r\n        }\r\n      "
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('customizations-{0}', parameters('deploymentNameSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('management-vm-{0}', parameters('deploymentNameSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('installUpdates')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('microsoft-updates-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[variables('subscriptionId')]",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "imageVirtualMachineName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "mlzTags": {
            "value": "[parameters('mlzTags')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "updateService": {
            "value": "[parameters('updateService')]"
          },
          "wsusServer": {
            "value": "[parameters('wsusServer')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "9407380787926779583"
            }
          },
          "parameters": {
            "imageVirtualMachineName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "mlzTags": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            },
            "updateService": {
              "type": "string"
            },
            "wsusServer": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/{1}', parameters('imageVirtualMachineName'), 'install-microsoft-updates')]",
              "location": "[parameters('location')]",
              "tags": "[union(if(contains(parameters('tags'), 'Microsoft.Compute/virtualMachines'), parameters('tags')['Microsoft.Compute/virtualMachines'], createObject()), parameters('mlzTags'))]",
              "properties": {
                "asyncExecution": false,
                "parameters": "[if(equals(parameters('updateService'), 'WSUS'), createArray(createObject('name', 'Service', 'value', parameters('updateService')), createObject('name', 'WSUSServer', 'value', parameters('wsusServer'))), createArray(createObject('name', 'Service', 'value', parameters('updateService'))))]",
                "source": {
                  "script": "        param (\r\n          # The App Name to pass to the WUA API as the calling application.\r\n          [Parameter()]\r\n          [String]$AppName = \"Windows Update API Script\",\r\n          # The search criteria to be used.\r\n          [Parameter()]\r\n          [String]$Criteria = \"IsInstalled=0 and Type='Software' and IsHidden=0\",\r\n          [Parameter()]\r\n          [bool]$ExcludePreviewUpdates = $true,\r\n          # Default service (WSUS if machine is configured to use it, or MU if opted in, or WU otherwise.)\r\n          [Parameter()]\r\n          [ValidateSet(\"WU\",\"MU\",\"WSUS\",\"DCAT\",\"STORE\",\"OTHER\")]\r\n          [string]$Service = 'MU',\r\n          # The http/https fqdn for the Windows Server Update Server\r\n          [Parameter()]\r\n          [string]$WSUSServer\r\n        )\r\n        \r\n        Function ConvertFrom-InstallationResult {\r\n        [CmdletBinding()]\r\n            param (\r\n                [Parameter()]\r\n                [int]$Result\r\n            )        \r\n            switch ($Result) {\r\n                2 { $Text = 'Succeeded' }\r\n                3 { $Text = 'Succeeded with errors' }\r\n                4 { $Text = 'Failed' }\r\n                5 { $Text = 'Cancelled' }\r\n                Default { $Text = \"Unexpected ($Result)\"}\r\n            }        \r\n            Return $Text\r\n        }\r\n        Start-Transcript -Path \"$env:SystemRoot\\Logs\\ImageBuild\\Install-Updates.log\"\r\n        Switch ($Service.ToUpper()) {\r\n            'WU' { $ServerSelection = 2 }\r\n            'MU' { $ServerSelection = 3; $ServiceId = \"7971f918-a847-4430-9279-4a52d1efe18d\" }\r\n            'WSUS' { $ServerSelection = 1 }\r\n            'DCAT' { $ServerSelection = 3; $ServiceId = \"855E8A7C-ECB4-4CA3-B045-1DFA50104289\" }\r\n            'STORE' { $serverSelection = 3; $ServiceId = \"117cab2d-82b1-4b5a-a08c-4d62dbee7782\" }\r\n            'OTHER' { $ServerSelection = 3; $ServiceId = $Service }\r\n        }        \r\n        If ($Service -eq 'MU') {\r\n            $UpdateServiceManager = New-Object -ComObject Microsoft.Update.ServiceManager\r\n            $UpdateServiceManager.ClientApplicationID = $AppName\r\n            $UpdateServiceManager.AddService2(\"7971f918-a847-4430-9279-4a52d1efe18d\", 7, \"\")\r\n            $null = cmd /c reg.exe ADD \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU\" /v AllowMUUpdateService /t REG_DWORD /d 1 /f '2>&1'\r\n            Write-Output \"Added Registry entry to configure Microsoft Update. Exit Code: [$LastExitCode]\"\r\n        } Elseif ($Service -eq 'WSUS' -and $WSUSServer) {\r\n            $null = cmd /c reg.exe ADD \"HKLM\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\" /v WUServer /t REG_SZ /d $WSUSServer /f '2>&1'\r\n            $null = cmd /c reg.exe ADD \"HKLM\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\" /v WUStatusServer /t REG_SZ /d $WSUSServer /f '2>&1'\r\n            Write-Output \"Added Registry entry to configure WSUS Server. Exit Code: [$LastExitCode]\"\r\n        }        \r\n        $UpdateSession = New-Object -ComObject Microsoft.Update.Session\r\n        $updateSession.ClientApplicationID = $AppName   \r\n        $UpdateSearcher = $UpdateSession.CreateUpdateSearcher()\r\n        $UpdateSearcher.ServerSelection = $ServerSelection\r\n        If ($ServerSelection -eq 3) {\r\n            $UpdateSearcher.ServiceId = $ServiceId\r\n        }\r\n        Write-Output \"Searching for Updates...\"\r\n        $SearchResult = $UpdateSearcher.Search($Criteria)\r\n        If ($SearchResult.Updates.Count -gt 0) {\r\n            Write-Output \"List of applicable items found for this computer:\"\r\n            For ($i = 0; $i -lt $SearchResult.Updates.Count; $i++) {\r\n                $Update = $SearchResult.Updates[$i]\r\n                Write-Output \"$($i + 1) > $($update.Title)\"\r\n            }\r\n            $AtLeastOneAdded = $false\r\n            $ExclusiveAdded = $false   \r\n            $UpdatesToDownload = New-Object -ComObject Microsoft.Update.UpdateColl\r\n            Write-Output \"Checking search results:\"\r\n            For ($i = 0; $i -lt $SearchResult.Updates.Count; $i++) {\r\n                $Update = $SearchResult.Updates[$i]\r\n                $AddThisUpdate = $false        \r\n                If ($ExclusiveAdded) {\r\n                    Write-Output \"$($i + 1) > skipping: '$($update.Title)' because an exclusive update has already been selected.\"\r\n                } Else {\r\n                    $AddThisUpdate = $true\r\n                }        \r\n                if ($ExcludePreviewUpdates -and $update.Title -like '*Preview*') {\r\n                    Write-Output \"$($i + 1) > Skipping: '$($update.Title)' because it is a preview update.\"\r\n                    $AddThisUpdate = $false\r\n                }        \r\n                If ($AddThisUpdate) {\r\n                    $PropertyTest = 0\r\n                    $ErrorActionPreference = 'SilentlyContinue'\r\n                    $PropertyTest = $Update.InstallationBehavior.Impact\r\n                    $ErrorActionPreference = 'Stop'\r\n                    If ($PropertyTest -eq 2) {\r\n                        If ($AtLeastOneAdded) {\r\n                            Write-Output \"$($i + 1) > skipping: '$($update.Title)' because it is exclusive and other updates are being installed first.\"\r\n                            $AddThisUpdate = $false\r\n                        }\r\n                    }\r\n                }\r\n                If ($AddThisUpdate) {\r\n                    Write-Output \"$($i + 1) > adding: '$($update.Title)'\"\r\n                    $UpdatesToDownload.Add($Update) | out-null\r\n                    $AtLeastOneAdded = $true\r\n                    $ErrorActionPreference = 'SilentlyContinue'\r\n                    $PropertyTest = $Update.InstallationBehavior.Impact\r\n                    $ErrorActionPreference = 'Stop'\r\n                    If ($PropertyTest -eq 2) {\r\n                        Write-Output \"This update is exclusive; skipping remaining updates\"\r\n                        $ExclusiveAdded = $true\r\n                    }\r\n                }\r\n            }        \r\n            $UpdatesToInstall = New-Object -ComObject Microsoft.Update.UpdateColl\r\n            Write-Output \"Downloading updates...\"\r\n            $Downloader = $UpdateSession.CreateUpdateDownloader()\r\n            $Downloader.Updates = $UpdatesToDownload\r\n            $Downloader.Download()\r\n            Write-Output \"Successfully downloaded updates:\"        \r\n            For ($i = 0; $i -lt $UpdatesToDownload.Count; $i++) {\r\n                $Update = $UpdatesToDownload[$i]\r\n                If ($Update.IsDownloaded -eq $true) {\r\n                    Write-Output \"$($i + 1) > $($update.title)\"\r\n                    $UpdatesToInstall.Add($Update) | out-null\r\n                }\r\n            }        \r\n            If ($UpdatesToInstall.Count -gt 0) {\r\n                Write-Output \"Now installing updates...\"\r\n                $Installer = $UpdateSession.CreateUpdateInstaller()\r\n                $Installer.Updates = $UpdatesToInstall\r\n                $InstallationResult = $Installer.Install()\r\n                $Text = ConvertFrom-InstallationResult -Result $InstallationResult.ResultCode\r\n                Write-Output \"Installation Result: $($Text)\"        \r\n                If ($InstallationResult.RebootRequired) {\r\n                    Write-Output \"Atleast one update requires a reboot to complete the installation.\"\r\n                }\r\n            }\r\n        }\r\n        Else {\r\n            Write-Output \"There are no applicable updates.\"\r\n        }\r\n       \r\n        If ($service -eq 'MU') {\r\n            Reg.exe DELETE \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU\" /v AllowMUUpdateService /f\r\n        } Elseif ($Service -eq 'WSUS' -and $WSUSServer) {\r\n            reg.exe DELETE \"HKLM\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\" /v WUServer /f\r\n            reg.exe DELETE \"HKLM\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\" /v WUStatusServer /f\r\n        }\r\n        Stop-Transcript\r\n      "
                },
                "treatFailureAsDeploymentFailure": true
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('restart-vm-1-{0}', parameters('deploymentNameSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('installUpdates')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('restart-vm-2-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[variables('subscriptionId')]",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "imageVirtualMachineName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "resourceGroupName": {
            "value": "[parameters('resourceGroupName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "mlzTags": {
            "value": "[parameters('mlzTags')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "userAssignedIdentityClientId": {
            "value": "[parameters('userAssignedIdentityClientId')]"
          },
          "virtualMachineName": "[if(parameters('enableBuildAutomation'), createObject('value', parameters('managementVirtualMachineName')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('management-vm-{0}', parameters('deploymentNameSuffix'))), '2022-09-01').outputs.name.value))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "7400813670576825580"
            }
          },
          "parameters": {
            "imageVirtualMachineName": {
              "type": "string"
            },
            "resourceGroupName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "mlzTags": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            },
            "userAssignedIdentityClientId": {
              "type": "string"
            },
            "virtualMachineName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'restartVirtualMachine')]",
              "location": "[parameters('location')]",
              "tags": "[union(if(contains(parameters('tags'), 'Microsoft.Compute/virtualMachines'), parameters('tags')['Microsoft.Compute/virtualMachines'], createObject()), parameters('mlzTags'))]",
              "properties": {
                "treatFailureAsDeploymentFailure": true,
                "asyncExecution": false,
                "parameters": [
                  {
                    "name": "ResourceManagerUri",
                    "value": "[environment().resourceManager]"
                  },
                  {
                    "name": "UserAssignedIdentityClientId",
                    "value": "[parameters('userAssignedIdentityClientId')]"
                  },
                  {
                    "name": "VmResourceId",
                    "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Compute/virtualMachines', parameters('imageVirtualMachineName'))]"
                  }
                ],
                "source": {
                  "script": "        param(\r\n            [Parameter(Mandatory=$true)]\r\n            [string]$ResourceManagerUri,\r\n\r\n            [Parameter(Mandatory=$true)]\r\n            [string]$UserAssignedIdentityClientId,\r\n\r\n            [Parameter(Mandatory=$true)]\r\n            [string]$VmResourceId\r\n        )\r\n\r\n        $ErrorActionPreference = 'Stop'\r\n        $WarningPreference = 'SilentlyContinue'\r\n\r\n        Try {\r\n            # Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n            $ResourceManagerUriFixed = if($ResourceManagerUri[-1] -eq '/'){$ResourceManagerUri.Substring(0,$ResourceManagerUri.Length - 1)} else {$ResourceManagerUri}\r\n\r\n            # Get an access token for Azure resources\r\n            $AzureManagementAccessToken = (Invoke-RestMethod `\r\n                -Headers @{Metadata=\"true\"} `\r\n                -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n            # Set header for Azure Management API\r\n            $AzureManagementHeader = @{\r\n                'Content-Type'='application/json'\r\n                'Authorization'='Bearer ' + $AzureManagementAccessToken\r\n            }\r\n            \r\n            # Restart the VM\r\n            $null = Invoke-RestMethod -Headers $AzureManagementHeader -Method 'Post' -Uri $($ResourceManagerUriFixed + $VmResourceId + '/restart?api-version=2024-03-01')\r\n            $lastProvisioningState = \"\"\r\n            $VmStatus = Invoke-RestMethod -Headers $AzureManagementHeader -Method 'Get' -Uri $($ResourceManagerUriFixed + $VmResourceId + '/instanceView?api-version=2024-03-01')\r\n            $provisioningState = ($VMStatus.statuses | Where-Object {$_.code -like 'PowerState*'}).code\r\n            While ($provisioningState -ne \"PowerState/running\") {\r\n                $lastProvisioningState = $provisioningState\r\n                Start-Sleep -Seconds 5\r\n                $VmStatus = Invoke-RestMethod -Headers $AzureManagementHeader -Method 'Get' -Uri $($ResourceManagerUriFixed + $VmResourceId + '/instanceView?api-version=2024-03-01')\r\n                $provisioningState = ($VMStatus.statuses | Where-Object {$_.code -like 'PowerState*'}).code\r\n            }   \r\n        }\r\n        catch {\r\n            throw\r\n        }\r\n      "
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('management-vm-{0}', parameters('deploymentNameSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('microsoft-updates-{0}', parameters('deploymentNameSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('sysprep-vm-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[variables('subscriptionId')]",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "mlzTags": {
            "value": "[parameters('mlzTags')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "virtualMachineName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix'))), '2022-09-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "18367526052756419166"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "mlzTags": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            },
            "virtualMachineName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'sysprepVirtualMachine')]",
              "location": "[parameters('location')]",
              "tags": "[union(if(contains(parameters('tags'), 'Microsoft.Compute/virtualMachines'), parameters('tags')['Microsoft.Compute/virtualMachines'], createObject()), parameters('mlzTags'))]",
              "properties": {
                "treatFailureAsDeploymentFailure": false,
                "asyncExecution": true,
                "parameters": [],
                "source": {
                  "script": "        Start-Sleep -Seconds 30\r\n        Remove-Item -LiteralPath 'C:\\Windows\\Panther' -Force -Recurse -ErrorAction SilentlyContinue\r\n        Set-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Services\\cdrom' -Name 'Start' -Value 1\r\n        Start-Process -File 'C:\\Windows\\System32\\Sysprep\\Sysprep.exe' -ArgumentList '/generalize /oobe /shutdown /mode:vm'\r\n      "
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('restart-vm-1-{0}', parameters('deploymentNameSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('restart-vm-2-{0}', parameters('deploymentNameSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('generalize-vm-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[variables('subscriptionId')]",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "imageVirtualMachineName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "resourceGroupName": {
            "value": "[parameters('resourceGroupName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "mlzTags": {
            "value": "[parameters('mlzTags')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "userAssignedIdentityClientId": {
            "value": "[parameters('userAssignedIdentityClientId')]"
          },
          "virtualMachineName": "[if(parameters('enableBuildAutomation'), createObject('value', parameters('managementVirtualMachineName')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('management-vm-{0}', parameters('deploymentNameSuffix'))), '2022-09-01').outputs.name.value))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "12290487570291502704"
            }
          },
          "parameters": {
            "imageVirtualMachineName": {
              "type": "string"
            },
            "resourceGroupName": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "mlzTags": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            },
            "userAssignedIdentityClientId": {
              "type": "string"
            },
            "virtualMachineName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'generalizeVirtualMachine')]",
              "location": "[parameters('location')]",
              "tags": "[union(if(contains(parameters('tags'), 'Microsoft.Compute/virtualMachines'), parameters('tags')['Microsoft.Compute/virtualMachines'], createObject()), parameters('mlzTags'))]",
              "properties": {
                "treatFailureAsDeploymentFailure": true,
                "asyncExecution": false,
                "parameters": [
                  {
                    "name": "ResourceManagerUri",
                    "value": "[environment().resourceManager]"
                  },
                  {
                    "name": "UserAssignedIdentityClientId",
                    "value": "[parameters('userAssignedIdentityClientId')]"
                  },
                  {
                    "name": "VmResourceId",
                    "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Compute/virtualMachines', parameters('imageVirtualMachineName'))]"
                  }
                ],
                "source": {
                  "script": "        param(\r\n            [Parameter(Mandatory=$true)]\r\n            [string]$ResourceManagerUri,\r\n\r\n            [Parameter(Mandatory=$true)]\r\n            [string]$UserAssignedIdentityClientId,\r\n\r\n            [Parameter(Mandatory=$true)]\r\n            [string]$VmResourceId\r\n        )\r\n\r\n        $ErrorActionPreference = 'Stop'\r\n        $WarningPreference = 'SilentlyContinue'\r\n\r\n        Try {\r\n            # Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n            $ResourceManagerUriFixed = if($ResourceManagerUri[-1] -eq '/'){$ResourceManagerUri.Substring(0,$ResourceManagerUri.Length - 1)} else {$ResourceManagerUri}\r\n\r\n            # Get an access token for Azure resources\r\n            $AzureManagementAccessToken = (Invoke-RestMethod `\r\n                -Headers @{Metadata=\"true\"} `\r\n                -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n            # Set header for Azure Management API\r\n            $AzureManagementHeader = @{\r\n                'Content-Type'='application/json'\r\n                'Authorization'='Bearer ' + $AzureManagementAccessToken\r\n            }\r\n\r\n            # Stop the VM\r\n            #$null = Invoke-RestMethod -Headers $AzureManagementHeader -Method 'Post' -Uri $($ResourceManagerUriFixed + $VmResourceId + '/powerOff?api-version=2024-03-01')\r\n            # Wait for it to show as stopped in Azure\r\n            Do {\r\n                Start-Sleep -Seconds 5\r\n                $VmStatus = Invoke-RestMethod -Headers $AzureManagementHeader -Method 'Get' -Uri $($ResourceManagerUriFixed + $VmResourceId + '/instanceView?api-version=2024-03-01')\r\n                $VMPowerState = ($VMStatus.statuses | Where-Object {$_.code -like 'PowerState*'}).displayStatus\r\n\r\n            } Until ($VMPowerState -eq 'VM stopped')\r\n            # Generatlize the VM\r\n            $null = Invoke-RestMethod -Headers $AzureManagementHeader -Method 'Post' -Uri $($ResourceManagerUriFixed + $VmResourceId + '/generalize?api-version=2024-03-01')\r\n        }\r\n        catch {\r\n            throw\r\n        }\r\n      "
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('management-vm-{0}', parameters('deploymentNameSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('sysprep-vm-{0}', parameters('deploymentNameSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('image-version-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[variables('subscriptionId')]",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "computeGalleryImageResourceId": {
            "value": "[parameters('computeGalleryImageResourceId')]"
          },
          "computeGalleryName": {
            "value": "[parameters('computeGalleryName')]"
          },
          "excludeFromLatest": {
            "value": "[parameters('excludeFromLatest')]"
          },
          "imageDefinitionName": {
            "value": "[parameters('imageDefinitionName')]"
          },
          "imageVersionNumber": {
            "value": "[variables('autoImageVersion')]"
          },
          "imageVirtualMachineResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix'))), '2022-09-01').outputs.resourceId.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "marketplaceImageOffer": {
            "value": "[parameters('marketplaceImageOffer')]"
          },
          "marketplaceImagePublisher": {
            "value": "[parameters('marketplaceImagePublisher')]"
          },
          "mlzTags": {
            "value": "[parameters('mlzTags')]"
          },
          "replicaCount": {
            "value": "[parameters('replicaCount')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "18262891690771946297"
            }
          },
          "parameters": {
            "allowDeletionOfReplicatedLocations": {
              "type": "bool",
              "defaultValue": true
            },
            "computeGalleryName": {
              "type": "string"
            },
            "computeGalleryImageResourceId": {
              "type": "string"
            },
            "excludeFromLatest": {
              "type": "bool"
            },
            "imageDefinitionName": {
              "type": "string"
            },
            "imageVersionNumber": {
              "type": "string"
            },
            "imageVirtualMachineResourceId": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "marketplaceImageOffer": {
              "type": "string"
            },
            "marketplaceImagePublisher": {
              "type": "string"
            },
            "mlzTags": {
              "type": "object"
            },
            "replicaCount": {
              "type": "int"
            },
            "tags": {
              "type": "object"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/galleries/images",
              "apiVersion": "2022-03-03",
              "name": "[format('{0}/{1}', parameters('computeGalleryName'), parameters('imageDefinitionName'))]",
              "location": "[parameters('location')]",
              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/galleries'), createObject()), parameters('mlzTags'))]",
              "properties": {
                "architecture": "x64",
                "features": [
                  {
                    "name": "SecurityType",
                    "value": "TrustedLaunch"
                  }
                ],
                "hyperVGeneration": "V2",
                "identifier": {
                  "offer": "[if(empty(parameters('computeGalleryImageResourceId')), parameters('marketplaceImageOffer'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('computeGalleryImageResourceId'), '/')[2], split(parameters('computeGalleryImageResourceId'), '/')[4]), 'Microsoft.Compute/galleries/images', split(parameters('computeGalleryImageResourceId'), '/')[8], split(parameters('computeGalleryImageResourceId'), '/')[10]), '2022-03-03').identifier.offer)]",
                  "publisher": "[if(empty(parameters('computeGalleryImageResourceId')), parameters('marketplaceImagePublisher'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('computeGalleryImageResourceId'), '/')[2], split(parameters('computeGalleryImageResourceId'), '/')[4]), 'Microsoft.Compute/galleries/images', split(parameters('computeGalleryImageResourceId'), '/')[8], split(parameters('computeGalleryImageResourceId'), '/')[10]), '2022-03-03').identifier.publisher)]",
                  "sku": "[parameters('imageDefinitionName')]"
                },
                "osState": "Generalized",
                "osType": "Windows"
              }
            },
            {
              "type": "Microsoft.Compute/galleries/images/versions",
              "apiVersion": "2022-03-03",
              "name": "[format('{0}/{1}/{2}', parameters('computeGalleryName'), parameters('imageDefinitionName'), parameters('imageVersionNumber'))]",
              "location": "[parameters('location')]",
              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/galleries'), createObject()), parameters('mlzTags'))]",
              "properties": {
                "publishingProfile": {
                  "excludeFromLatest": "[parameters('excludeFromLatest')]",
                  "replicaCount": "[parameters('replicaCount')]",
                  "replicationMode": "Full",
                  "storageAccountType": "Standard_LRS",
                  "targetRegions": [
                    {
                      "name": "[parameters('location')]",
                      "regionalReplicaCount": "[parameters('replicaCount')]",
                      "storageAccountType": "Standard_LRS"
                    }
                  ]
                },
                "safetyProfile": {
                  "allowDeletionOfReplicatedLocations": "[parameters('allowDeletionOfReplicatedLocations')]"
                },
                "storageProfile": {
                  "source": {
                    "id": "[parameters('imageVirtualMachineResourceId')]"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/galleries/images', parameters('computeGalleryName'), parameters('imageDefinitionName'))]"
              ]
            }
          ],
          "outputs": {
            "imageDefinitionResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/galleries/images', parameters('computeGalleryName'), parameters('imageDefinitionName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('generalize-vm-{0}', parameters('deploymentNameSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('remove-vm-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[variables('subscriptionId')]",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "enableBuildAutomation": {
            "value": "[parameters('enableBuildAutomation')]"
          },
          "imageVirtualMachineName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "mlzTags": {
            "value": "[parameters('mlzTags')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "userAssignedIdentityClientId": {
            "value": "[parameters('userAssignedIdentityClientId')]"
          },
          "virtualMachineName": "[if(parameters('enableBuildAutomation'), createObject('value', parameters('managementVirtualMachineName')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('management-vm-{0}', parameters('deploymentNameSuffix'))), '2022-09-01').outputs.name.value))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "16391379206468268227"
            }
          },
          "parameters": {
            "enableBuildAutomation": {
              "type": "bool"
            },
            "imageVirtualMachineName": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "mlzTags": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            },
            "userAssignedIdentityClientId": {
              "type": "string"
            },
            "virtualMachineName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'removeVirtualMachine')]",
              "location": "[parameters('location')]",
              "tags": "[union(if(contains(parameters('tags'), 'Microsoft.Compute/virtualMachines'), parameters('tags')['Microsoft.Compute/virtualMachines'], createObject()), parameters('mlzTags'))]",
              "properties": {
                "treatFailureAsDeploymentFailure": false,
                "asyncExecution": "[if(parameters('enableBuildAutomation'), false(), true())]",
                "parameters": [
                  {
                    "name": "EnableBuildAutomation",
                    "value": "[string(parameters('enableBuildAutomation'))]"
                  },
                  {
                    "name": "ResourceManagerUri",
                    "value": "[environment().resourceManager]"
                  },
                  {
                    "name": "ImageVmResourceId",
                    "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('imageVirtualMachineName'))]"
                  },
                  {
                    "name": "ManagementVmResourceId",
                    "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                  },
                  {
                    "name": "UserAssignedIdentityClientId",
                    "value": "[parameters('userAssignedIdentityClientId')]"
                  }
                ],
                "source": {
                  "script": "        param(\r\n            [Parameter(Mandatory=$false)]\r\n            [string]$EnableBuildAutomation,\r\n\r\n            [Parameter(Mandatory=$true)]\r\n            [string]$ResourceManagerUri,\r\n\r\n            [Parameter(Mandatory=$true)]\r\n            [string]$UserAssignedIdentityClientId,\r\n\r\n            [Parameter(Mandatory=$true)]\r\n            [string]$ImageVmResourceId,\r\n\r\n            [Parameter(Mandatory=$true)]\r\n            [string]$ManagementVmResourceId\r\n        )\r\n\r\n        $ErrorActionPreference = 'Stop'\r\n        $WarningPreference = 'SilentlyContinue'\r\n\r\n        Try {\r\n            # Fix the resource manager URI since only AzureCloud contains a trailing slash\r\n            $ResourceManagerUriFixed = if($ResourceManagerUri[-1] -eq '/'){$ResourceManagerUri.Substring(0,$ResourceManagerUri.Length - 1)} else {$ResourceManagerUri}\r\n\r\n            # Get an access token for Azure resources\r\n            $AzureManagementAccessToken = (Invoke-RestMethod `\r\n                -Headers @{Metadata=\"true\"} `\r\n                -Uri $('http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=' + $ResourceManagerUriFixed + '&client_id=' + $UserAssignedIdentityClientId)).access_token\r\n\r\n            # Set header for Azure Management API\r\n            $AzureManagementHeader = @{\r\n                'Content-Type'='application/json'\r\n                'Authorization'='Bearer ' + $AzureManagementAccessToken\r\n            }\r\n\r\n            # Delete Image VM\r\n            Invoke-RestMethod -Headers $AzureManagementHeader -Method 'DELETE' -Uri $($ResourceManagerUriFixed + $ImageVmResourceId + '?api-version=2024-03-01')\r\n            if($EnableBuildAutomation -eq 'false') {\r\n              # Wait 20 secs to make sure run command takes at least 20 secs to prevent failure.\r\n              Start-Sleep -Seconds 20\r\n              Invoke-RestMethod -Headers $AzureManagementHeader -Method 'DELETE' -Uri $($ResourceManagerUriFixed + $ManagementVmResourceId + '?api-version=2024-03-01')\r\n            }\r\n        }\r\n        catch {\r\n            throw\r\n        }\r\n      "
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-version-{0}', parameters('deploymentNameSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('management-vm-{0}', parameters('deploymentNameSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-vm-{0}', parameters('deploymentNameSuffix')))]"
      ]
    }
  ],
  "outputs": {
    "imageDefinitionResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('image-version-{0}', parameters('deploymentNameSuffix'))), '2022-09-01').outputs.imageDefinitionResourceId.value]"
    }
  }
}