{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.32.4.45862",
      "templateHash": "267262262820579554"
    }
  },
  "parameters": {
    "policySetName": {
      "type": "string",
      "metadata": {
        "description": "Policy set name"
      }
    },
    "policySetDisplayName": {
      "type": "string",
      "metadata": {
        "description": "Policy set display name"
      }
    },
    "policySetDescription": {
      "type": "string",
      "metadata": {
        "description": "Policy set description"
      }
    },
    "policySetCategory": {
      "type": "string",
      "metadata": {
        "description": "Policy set category"
      }
    },
    "targetManagementGroup": {
      "type": "string",
      "metadata": {
        "description": "Management group to assign the policy set"
      }
    }
  },
  "variables": {
    "$fxv#0": {
      "name": "Append-AppService-httpsonly",
      "type": "Microsoft.Authorization/policyDefinitions",
      "apiVersion": "2021-06-01",
      "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "AppService append enable https only setting to enforce https setting.",
        "description": "Appends the AppService sites object to ensure that HTTPS only is enabled for server/service authentication.",
        "metadata": {
          "version": "1.0.0",
          "category": "App Service"
        },
        "parameters": {
          "effect": {
            "type": "String",
            "defaultValue": "Append",
            "allowedValues": [
              "Append",
              "Disabled"
            ],
            "metadata": {
              "displayName": "Effect",
              "description": "Enable or disable the execution of the policy"
            }
          }
        },
        "policyRule": {
          "if": {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.Web/sites"
              },
              {
                "field": "Microsoft.Web/sites/httpsOnly",
                "notequals": true
              }
            ]
          },
          "then": {
            "effect": "[[parameters('effect')]",
            "details": [
              {
                "field": "Microsoft.Web/sites/httpsOnly",
                "value": true
              }
            ]
          }
        }
      }
    },
    "$fxv#1": {
      "name": "Append-AppService-latestTLS",
      "type": "Microsoft.Authorization/policyDefinitions",
      "apiVersion": "2021-06-01",
      "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "AppService append sites with minimum TLS version to enforce.",
        "description": "Append the AppService sites object to ensure that the minimum TLS version is set to the required minimum TLS version. Please note, Append does not enforce compliance; use 'Deny' for compliance enforcement.",
        "metadata": {
          "version": "1.1.0",
          "category": "App Service",
          "source": "https://github.com/Azure/Enterprise-Scale/",
          "alzCloudEnvironments": [
            "AzureCloud",
            "AzureChinaCloud",
            "AzureUSGovernment"
          ]
        },
        "parameters": {
          "effect": {
            "type": "String",
            "defaultValue": "Append",
            "allowedValues": [
              "Append",
              "Disabled"
            ],
            "metadata": {
              "displayName": "Effect",
              "description": "Enable or disable the execution of the policy"
            }
          },
          "minTlsVersion": {
            "type": "String",
            "defaultValue": "1.2",
            "allowedValues": [
              "1.2",
              "1.0",
              "1.1"
            ],
            "metadata": {
              "displayName": "Select minimum TLS version",
              "description": "Select the minimum TLS version for a Web App configuration to enforce"
            }
          }
        },
        "policyRule": {
          "if": {
            "allOf": [
              {
                "field": "Microsoft.Web/sites/config/minTlsVersion",
                "exists": "true"
              },
              {
                "field": "Microsoft.Web/sites/config/minTlsVersion",
                "notEquals": "[[parameters('minTlsVersion')]"
              }
            ]
          },
          "then": {
            "effect": "[[parameters('effect')]",
            "details": [
              {
                "field": "Microsoft.Web/sites/config/minTlsVersion",
                "value": "[[parameters('minTlsVersion')]"
              }
            ]
          }
        }
      }
    },
    "$fxv#2": {
      "name": "Deploy-Custom-Route-Table",
      "type": "Microsoft.Authorization/policyDefinitions",
      "apiVersion": "2021-06-01",
      "scope": null,
      "properties": {
        "policyType": "Custom",
        "mode": "Indexed",
        "displayName": "Deploy a route table with specific user defined routes",
        "description": "Deploys a route table with specific user defined routes when one does not exist. The route table deployed by the policy must be manually associated to subnet(s)",
        "metadata": {
          "version": "1.0.0",
          "category": "Network",
          "source": "https://github.com/Azure/Enterprise-Scale/",
          "alzCloudEnvironments": [
            "AzureCloud",
            "AzureChinaCloud",
            "AzureUSGovernment"
          ]
        },
        "parameters": {
          "effect": {
            "type": "String",
            "metadata": {
              "displayName": "Effect",
              "description": "Enable or disable the execution of the policy"
            },
            "allowedValues": [
              "DeployIfNotExists",
              "Disabled"
            ],
            "defaultValue": "DeployIfNotExists"
          },
          "vnetRegion": {
            "type": "String",
            "metadata": {
              "displayName": "vnetRegion",
              "description": "Only VNets in this region will be evaluated against this policy"
            },
            "defaultValue": "usgovvirginia"
          }
        },
        "policyRule": {
          "if": {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.Network/routeTables"
              },
              {
                "field": "location",
                "equals": "[[parameters('vnetRegion')]"
              }
            ]
          },
          "then": {
            "effect": "[[parameters('effect')]",
            "details": {
              "type": "Microsoft.Network/routeTables",
              "existenceCondition": {
                "anyOf": [
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Network/routeTables/routes[*].name",
                        "equals": "default_route"
                      },
                      {
                        "field": "Microsoft.Network/routeTables/routes[*].addressPrefix",
                        "equals": "0.0.0.0/0"
                      },
                      {
                        "field": "Microsoft.Network/routeTables/routes[*].nextHopIpAddress",
                        "equals": "10.1.1.1"
                      },
                      {
                        "field": "Microsoft.Network/routeTables/routes[*].nextHopType",
                        "equals": "VirtualAppliance"
                      }
                    ]
                  }
                ]
              },
              "roleDefinitionIds": [
                "/subscriptions/e867a45d-e513-44ac-931e-4741cef80b24/providers/Microsoft.Authorization/roleDefinitions/4d97b98b-1d4f-4787-a291-c67834d212e7"
              ],
              "deployment": {
                "properties": {
                  "mode": "incremental",
                  "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                      "vnetRegion": {
                        "type": "string"
                      }
                    },
                    "resources": [
                      {
                        "type": "Microsoft.Network/routeTables",
                        "apiVersion": "2021-02-01",
                        "name": "[[guid(resourceGroup().id, 'routeTable')]",
                        "location": "[[parameters('vnetRegion')]",
                        "properties": {
                          "routes": [
                            {
                              "name": "default_route",
                              "properties": {
                                "addressPrefix": "0.0.0.0/0",
                                "nextHopType": "VirtualAppliance",
                                "nextHopIpAddress": "10.0.128.68"
                              }
                            }
                          ]
                        }
                      }
                    ]
                  },
                  "parameters": {
                    "vnetRegion": {
                      "value": "usgovvirginia"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "customPolicyDefinitions": [
      "[variables('$fxv#0')]",
      "[variables('$fxv#1')]",
      "[variables('$fxv#2')]"
    ]
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "policyDefinitions",
      "scope": "[format('Microsoft.Management/managementGroups/{0}', parameters('targetManagementGroup'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "targetManagementGroup": {
            "value": "[parameters('targetManagementGroup')]"
          },
          "customPolicyDefinitions": {
            "value": "[variables('customPolicyDefinitions')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.32.4.45862",
              "templateHash": "12164790363675153553"
            }
          },
          "parameters": {
            "targetManagementGroup": {
              "type": "string",
              "metadata": {
                "description": "Target management group Id"
              }
            },
            "customPolicyDefinitions": {
              "type": "array",
              "metadata": {
                "description": "Array of custom policy definitions"
              }
            }
          },
          "resources": [
            {
              "copy": {
                "name": "policyDefinitions",
                "count": "[length(parameters('customPolicyDefinitions'))]"
              },
              "type": "Microsoft.Authorization/policyDefinitions",
              "apiVersion": "2023-04-01",
              "name": "[parameters('customPolicyDefinitions')[copyIndex()].name]",
              "properties": "[parameters('customPolicyDefinitions')[copyIndex()].properties]"
            }
          ],
          "outputs": {
            "policyDefinitionIds": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('customPolicyDefinitions'))]",
                "input": "[format('/providers/Microsoft.Management/managementGroups/{0}/providers/Microsoft.Authorization/policyDefinitions/{1}', parameters('targetManagementGroup'), parameters('customPolicyDefinitions')[copyIndex()].name)]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('policySet-{0}', parameters('policySetName'))]",
      "scope": "[format('Microsoft.Management/managementGroups/{0}', parameters('targetManagementGroup'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "policySetName": {
            "value": "[parameters('policySetName')]"
          },
          "policySetDisplayName": {
            "value": "[parameters('policySetDisplayName')]"
          },
          "policySetDescription": {
            "value": "[parameters('policySetDescription')]"
          },
          "policySetCategory": {
            "value": "[parameters('policySetCategory')]"
          },
          "policyDefinitionIds": {
            "value": "[reference(extensionResourceId(tenantResourceId('Microsoft.Management/managementGroups', parameters('targetManagementGroup')), 'Microsoft.Resources/deployments', 'policyDefinitions'), '2022-09-01').outputs.policyDefinitionIds.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.32.4.45862",
              "templateHash": "13640056829310916652"
            }
          },
          "parameters": {
            "policySetName": {
              "type": "string",
              "metadata": {
                "description": "Policy set name"
              }
            },
            "policySetDisplayName": {
              "type": "string",
              "metadata": {
                "description": "Policy set display name"
              }
            },
            "policySetDescription": {
              "type": "string",
              "metadata": {
                "description": "Policy set description"
              }
            },
            "policySetCategory": {
              "type": "string",
              "metadata": {
                "description": "Policy set category"
              }
            },
            "policyDefinitionIds": {
              "type": "array",
              "metadata": {
                "description": "Policy definition IDs"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/policySetDefinitions",
              "apiVersion": "2023-04-01",
              "name": "[parameters('policySetName')]",
              "properties": {
                "copy": [
                  {
                    "name": "policyDefinitions",
                    "count": "[length(parameters('policyDefinitionIds'))]",
                    "input": {
                      "policyDefinitionId": "[parameters('policyDefinitionIds')[copyIndex('policyDefinitions')]]"
                    }
                  }
                ],
                "displayName": "[parameters('policySetDisplayName')]",
                "description": "[parameters('policySetDescription')]",
                "metadata": {
                  "category": "[parameters('policySetCategory')]"
                },
                "policyType": "Custom"
              }
            }
          ],
          "outputs": {
            "policySetId": {
              "type": "string",
              "value": "[extensionResourceId(managementGroup().id, 'Microsoft.Authorization/policySetDefinitions', parameters('policySetName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(tenantResourceId('Microsoft.Management/managementGroups', parameters('targetManagementGroup')), 'Microsoft.Resources/deployments', 'policyDefinitions')]"
      ]
    }
  ]
}