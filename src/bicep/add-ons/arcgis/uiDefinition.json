{
    "$schema": "https://schema.management.azure.com/schemas/2021-09-09/uiFormDefinition.schema.json",
    "view": {
        "kind": "Form",
        "properties": {
            "title": "ArcGIS Enterprise on Azure with AVD",
            "steps": [
                {
                    "name": "basics",
                    "label": "Basics",
                    "elements": [
                        {
                            "name": "scope",
                            "type": "Microsoft.Common.ResourceScope",
                            "location": {
                                "resourceTypes": []
                            }
                        },
                        {
                            "name": "subscriptions",
                            "label": "Select Subscriptions",
                            "type": "Microsoft.Common.Section",
                            "elements": [
                                {
                                    "name": "api",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "subscriptions?api-version=2020-01-01"
                                    }
                                },
                                {
                                    "name": "hub",
                                    "label": "Hub Subscription",
                                    "type": "Microsoft.Common.DropDown",
                                    "defaultValue": "",
                                    "toolTip": "Select the subscription for your Mission Landing Zone Hub network, firewall, and remote access resources.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(steps('basics').subscriptions.api.value, (item) => parse(concat('{\"label\":\"', item.displayName, '\",\"value\":\"', item.id, '\",\"description\":\"', 'ID: ', item.subscriptionId, '\"}')))]",
                                        "required": true
                                    }
                                },
                                {
                                    "name": "spoke",
                                    "label": "ESRI Enterprise Subscription",
                                    "type": "Microsoft.Common.DropDown",
                                    "defaultValue": "",
                                    "toolTip": "Select the subscription for your ESRI Enterprise resources.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(steps('basics').subscriptions.api.value, (item) => parse(concat('{\"label\":\"', item.displayName, '\",\"value\":\"', item.id, '\",\"description\":\"', 'ID: ', item.subscriptionId, '\"}')))]",
                                        "required": true
                                    }
                                }
                            ]
                        },
                        {
                            "name": "hub",
                            "label": "Hub Resources",
                            "type": "Microsoft.Common.Section",
                            "elements": [
                                {
                                    "name": "virtualNetworksApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "[concat(steps('basics').subscriptions.hub, '/providers/Microsoft.Network/virtualNetworks?api-version=2023-05-01')]"
                                    }
                                },
                                {
                                    "name": "virtualNetwork",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "label": "Hub virtual network",
                                    "defaultValue": "",
                                    "toolTip": "Select the existing Hub virtual network.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": "[map(steps('basics').hub.virtualNetworksApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\"}')))]"
                                    }
                                },
                                {
                                    "name": "azureFirewallsApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "[concat(steps('basics').subscriptions.hub, '/providers/Microsoft.Network/azureFirewalls?api-version=2023-05-01')]"
                                    }
                                },
                                {
                                    "name": "azureFirewall",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "label": "Hub azure firewall",
                                    "defaultValue": "",
                                    "toolTip": "Select the existing Hub Azure firewall.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": "[map(steps('basics').hub.azureFirewallsApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\"}')))]"
                                    }
                                }
                            ]
                        },
                        {
                            "name": "naming",
                            "type": "Microsoft.Common.Section",
                            "label": "Resource Naming",
                            "elements": [
                                {
                                    "name": "resourceSuffix",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Resource Suffix",
                                    "toolTip": "Input a suffix for the resource names created with this solution. The suffix should represent a unique value within your organization, such as a business unit or project.",
                                    "placeholder": "",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z]+$",
                                        "validationMessage": "The value must be alphanumeric."
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "network",
                    "label": "Network",
                    "elements": [
                        {
                            "name": "spokeVirtualNetwork",
                            "label": "Spoke Virtual Network",
                            "type": "Microsoft.Common.Section",
                            "elements": [
                                {
                                    "name": "spokeNetowrkInfoBoxLocation",
                                    "type": "Microsoft.Common.InfoBox",
                                    "options": {
                                        "text": "Please update the spoke subnetting and the private ip address of the application gateway fields based on your networking requirements.",
                                        "style": "Info"
                                    }
                                },
                                {
                                    "name": "spokeVirtualNetworkAddressCidrRange",
                                    "label": "Spoke Virtual Network CIDR",
                                    "type": "Microsoft.Common.TextBox",
                                    "defaultValue": "10.140.0.0/16",
                                    "toolTip": "Specify an address CIDR range within the range [10,26].",
                                    "constraints": {
                                        "required": true,
                                        "validations": [
                                            {
                                                "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(1[0-9]|2[0-6]))$",
                                                "message": "Invalid CIDR range. The address prefix must be in the range [10,26]."
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "appGwSubnetAddressCidrRange",
                                    "label": "Application Gateway Subnet",
                                    "type": "Microsoft.Common.TextBox",
                                    "defaultValue": "10.140.1.0/24",
                                    "toolTip": "Specify a CIDR range for the Application Gateway subnet within the Spoke Virtual Network range [10,24].",
                                    "constraints": {
                                        "required": true,
                                        "validations": [
                                            {
                                                "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(1[0-9]|2[0-6]))$",
                                                "message": "Invalid CIDR range. The address prefix must be in the range [10,26]."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 8), equals(last(take(split(first(split(steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 1)), last(take(split(first(split(steps('network').spokeVirtualNetwork.appGwSubnetAddressCidrRange, '/')), '.'), 1))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (first octet)."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 16), equals(last(take(split(first(split(steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 2)), last(take(split(first(split(steps('network').spokeVirtualNetwork.appGwSubnetAddressCidrRange, '/')), '.'), 2))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (second octet)."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 24), equals(last(take(split(first(split(steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 3)), last(take(split(first(split(steps('network').spokeVirtualNetwork.appGwSubnetAddressCidrRange, '/')), '.'), 3))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (third octet)."
                                            },
                                            {
                                                "isValid": "[lessOrEquals(last(split(steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), last(split(steps('network').spokeVirtualNetwork.appGwSubnetAddressCidrRange, '/')))]",
                                                "message": "CIDR range not within virtual network CIDR range (subnet mask)."
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "privateIpAddress",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Private Ip Address of Application Gateway",
                                    "defaultValue": "10.140.1.7",
                                    "constraints": {
                                        "required": true
                                    }
                                },
                                {
                                    "name": "esriSubnetAddressCidrRange",
                                    "label": "ESRI Enterprise Virtual Machine Subnet",
                                    "type": "Microsoft.Common.TextBox",
                                    "defaultValue": "10.140.2.0/24",
                                    "toolTip": "Specify a CIDR range for the Management Virtual Machine subnet within the Spoke Virtual Network range [10,24].",
                                    "constraints": {
                                        "required": true,
                                        "validations": [
                                            {
                                                "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(1[0-9]|2[0-6]))$",
                                                "message": "Invalid CIDR range. The address prefix must be in the range [10,26]."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 8), equals(last(take(split(first(split(steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 1)), last(take(split(first(split(steps('network').spokeVirtualNetwork.esriSubnetAddressCidrRange, '/')), '.'), 1))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (first octet)."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 16), equals(last(take(split(first(split(steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 2)), last(take(split(first(split(steps('network').spokeVirtualNetwork.esriSubnetAddressCidrRange, '/')), '.'), 2))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (second octet)."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 24), equals(last(take(split(first(split(steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 3)), last(take(split(first(split(steps('network').spokeVirtualNetwork.esriSubnetAddressCidrRange, '/')), '.'), 3))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (third octet)."
                                            },
                                            {
                                                "isValid": "[lessOrEquals(last(split(steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), last(split(steps('network').spokeVirtualNetwork.esriSubnetAddressCidrRange, '/')))]",
                                                "message": "CIDR range not within virtual network CIDR range (subnet mask)."
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "logAnalyticsWorkspace",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "label": "Existing log analytics workspace",
                                    "visible": "true",
                                    "resourceType": "Microsoft.OperationalInsights/workspaces",
                                    "toolTip": "Select the log analytics workspace to capture runbook log output.",
                                    "options": {}
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "server",
                    "label": "Server",
                    "elements": [
                        {
                            "name": "esri",
                            "type": "Microsoft.Common.Section",
                            "label": "Architecture",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "architecture",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Select the ESRI architecture",
                                    "defaultValue": "Single Machine (Single-Tier)",
                                    "toolTip": "",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "Single Machine (Single-Tier)",
                                                "value": false
                                            },
                                            {
                                                "label": "Multiple Machines (Multi-Tier)",
                                                "value": true
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": true
                                }
                            ]
                        },
                        {
                            "name": "domain",
                            "type": "Microsoft.Common.Section",
                            "label": "Domain Settings",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "identity",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "visible": true,
                                    "label": "Microsoft Entra Domain Services",
                                    "defaultValue": "Microsoft Entra ID",
                                    "toolTip": "Choose the Active Directory solution that already exists.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Microsoft Entra ID",
                                                "value": false
                                            },
                                            {
                                                "label": "Active Directory Domain Services (ADDS)",
                                                "value": true
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "name",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": "[steps('server').domain.identity]",
                                    "label": "Domain Name",
                                    "toolTip": "Provide domain name for Active Directory Domain Services.",
                                    "placeholder": "Example: contoso.com",
                                    "constraints": {
                                        "required": true
                                    }
                                },
                                {
                                    "name": "ouPath",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": "[steps('server').domain.identity]",
                                    "label": "OU Path",
                                    "toolTip": "Input the distinguished name of the desired organization unit.",
                                    "placeholder": "Example: OU=servers,OU=arcgis,DC=contoso,DC=com",
                                    "constraints": {
                                        "required": true
                                    }
                                },
                                {
                                    "name": "userPrincipalName",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": "[steps('server').domain.identity]",
                                    "label": "User principal name (do not include the @ domainname)",
                                    "toolTip": "Enter the user principal name with domain join privileges.",
                                    "placeholder": "admin",
                                    "required": true,
                                    "constraints": {}
                                },
                                {
                                    "name": "password",
                                    "type": "Microsoft.Common.PasswordBox",
                                    "visible": "[steps('server').domain.identity]",
                                    "label": {
                                        "password": "Domain join password"
                                    },
                                    "toolTip": "Enter a password that is alphanumeric, contains at least 12 characters, 1 letter, 1 number and 1 special character.",
                                    "constraints": {
                                        "required": true
                                    },
                                    "options": {
                                        "hideConfirmation": true
                                    }
                                }
                            ]
                        },
                        {
                            "name": "localAdminCredentials",
                            "type": "Microsoft.Common.Section",
                            "visible": true,
                            "label": "Local administrator credential",
                            "elements": [
                                {
                                    "name": "username",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Username",
                                    "defaultValue": "",
                                    "toolTip": "Input the username for the local administrator account.",
                                    "constraints": {
                                        "required": true,
                                        "regex": "",
                                        "validationMessage": ""
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "password",
                                    "type": "Microsoft.Common.PasswordBox",
                                    "label": {
                                        "password": "Password",
                                        "confirmPassword": "Confirm Password"
                                    },
                                    "toolTip": "Input the password for the local administrator account.",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@#$%^&+=_!*<>()])(?=\\S+$).{12,123}$",
                                        "validationMessage": "The value must be within 12 to 123 characters, be alphanumeric, and include 1 lower case character, 1 upper case character, 1 number, and 1 special character that is not '\\' or '-'."
                                    },
                                    "options": {
                                        "hideConfirmation": false
                                    },
                                    "visible": true
                                }
                            ]
                        },
                        {
                            "name": "configuration",
                            "type": "Microsoft.Common.Section",
                            "label": "Configuration settings",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "useAzureStorage",
                                    "type": "Microsoft.Common.CheckBox",
                                    "label": "Use Azure Storage",
                                    "defaultValue": false,
                                    "visible": "[steps('server').esri.architecture]",
                                    "toolTip": "Indicates whether the server is store esri portal and server content on an Azure storage file share."
                                },
                                {
                                    "name": "osDiskSize",
                                    "type": "Microsoft.Common.Slider",
                                    "label": "OS Disk Size (GB)",
                                    "defaultValue": 128,
                                    "toolTip": "Input the virtual machine OS disk size in GB.",
                                    "min": 32,
                                    "max": 1024,
                                    "showStepMarkers": false,
                                    "constraints": {
                                        "required": true
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "enableVirtualMachineDataDisk",
                                    "type": "Microsoft.Common.CheckBox",
                                    "label": "Enable data disk",
                                    "defaultValue": false,
                                    "toolTip": "Indicates whether an additional Managed Disk is attached to the Virtual Machine(s)."
                                },
                                {
                                    "name": "enableMonitoring",
                                    "type": "Microsoft.Common.CheckBox",
                                    "label": "Enable monitoring",
                                    "defaultValue": false,
                                    "toolTip": "Indicates whether the Azure Monitor Agent will be installed on the virtual machine."
                                },
                                {
                                    "name": "diskEncryptionSetSelector",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "label": "Select disk encryption set",
                                    "resourceType": "Microsoft.Compute/diskEncryptionSets",
                                    "required": true,
                                    "options": {
                                        "filter": {
                                            "subscription": "onBasics",
                                            "location": "onBasics"
                                        }
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "portal",
                    "label": "Portal",
                    "elements": [
                        {
                            "name": "primarySiteAdministratorAccount",
                            "type": "Microsoft.Common.Section",
                            "label": "ArcGIS primary site administrator account",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "username",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Username",
                                    "defaultValue": "",
                                    "toolTip": "Input the username for the ArcGIS primary site administrator account.",
                                    "constraints": {
                                        "required": true,
                                        "regex": "",
                                        "validationMessage": ""
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "password",
                                    "type": "Microsoft.Common.PasswordBox",
                                    "label": {
                                        "password": "Password"
                                    },
                                    "toolTip": "Enter a password that is alphanumeric, contains at least 12 characters, a period special character.",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-zA-Z0-9.]+$",
                                        "validationMessage": "The value must be within 12 to 24 characters, and be alphanumeric, contains at least 12 characters, a period special character."
                                    },
                                    "options": {
                                        "hideConfirmation": false
                                    }
                                }
                            ]
                        },
                        {
                            "name": "arcgisServiceAccount",
                            "type": "Microsoft.Common.Section",
                            "label": "ArcGIS service account",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "isDomainAccount",
                                    "type": "Microsoft.Common.CheckBox",
                                    "label": "Is the ArcGIS service account a domain account?",
                                    "defaultValue": true,
                                    "toolTip": "Indicates whether the account is a domain or local account."
                                },
                                {
                                    "name": "username",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Username",
                                    "defaultValue": "arcgis",
                                    "toolTip": "Input the username for the service account.",
                                    "constraints": {
                                        "required": true,
                                        "regex": "",
                                        "validationMessage": ""
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "password",
                                    "type": "Microsoft.Common.PasswordBox",
                                    "label": {
                                        "password": "Password"
                                    },
                                    "toolTip": "Enter a password that is alphanumeric, contains at least 12 characters, 1 letter, 1 number and 1 special character.",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-zA-Z0-9@#$%^&+=_!*<>()]{12,123}$",
                                        "validationMessage": "The value must be within 12 to 123 characters, be alphanumeric, and include 1 lower case character, 1 upper case character, 1 number, and 1 special character that is not '\\' or '-'."
                                    },
                                    "options": {
                                        "hideConfirmation": false
                                    }
                                }
                            ]
                        },
                        {
                            "name": "configuration",
                            "type": "Microsoft.Common.Section",
                            "label": "Configuration settings",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "externalDnsHostname",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Fully Qualified Domain Name (FQDN) for the portal.",
                                    "toolTip": "Input the Fully Qualified Domain Name (FQDN) for the portal.",
                                    "placeholder": "Example: esri.contoso.com",
                                    "constraints": {
                                        "required": true,
                                        "regex": "(?=^.{1,253}$)(^(((?!-)[a-zA-Z0-9-]{1,63}(?<!-))|((?!-)[a-zA-Z0-9-]{1,63}(?<!-)\\.)+[a-zA-Z]{2,63})$)",
                                        "validationMessage": "The value must be a valid FQDN."
                                    }
                                },
                                {
                                    "name": "debugMode",
                                    "type": "Microsoft.Common.CheckBox",
                                    "label": "Enable debug mode",
                                    "defaultValue": false,
                                    "toolTip": "Indicates whether to enable the debug settings on the site deployment. Used for troubleshooting only and should not be used for a production deployment."
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "datastoretypes",
                    "label": "Data Store",
                    "elements": [
                        {
                            "name": "dataStores",
                            "type": "Microsoft.Common.Section",
                            "label": "Data Store Types",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "relational",
                                    "type": "Microsoft.Common.CheckBox",
                                    "defaultValue": true,
                                    "label": "Relational",
                                    "constraints": {
                                        "required": true,
                                        "value": true,
                                        "validationMessage": "This is a required datastore type used by hosted feature layers."
                                    }
                                },
                                {
                                    "name": "tilecache",
                                    "type": "Microsoft.Common.CheckBox",
                                    "defaultValue": false,
                                    "label": "Tilecache",
                                    "constraints": {}
                                },
                                {
                                    "name": "spatioTemporal",
                                    "type": "Microsoft.Common.CheckBox",
                                    "defaultValue": false,
                                    "label": "SpatioTemporal",
                                    "constraints": {}
                                },
                                {
                                    "name": "graphstore",
                                    "type": "Microsoft.Common.CheckBox",
                                    "defaultValue": false,
                                    "label": "Graph Store",
                                    "visible": "[steps('server').esri.architecture]",
                                    "constraints": {}
                                },
                                {
                                    "name": "objectstore",
                                    "type": "Microsoft.Common.CheckBox",
                                    "defaultValue": false,
                                    "label": "Object Store",
                                    "visible": "[steps('server').esri.architecture]",
                                    "constraints": {}
                                }
                            ]
                        },
                        {
                            "name": "multitier",
                            "type": "Microsoft.Common.Section",
                            "label": "Multitier settings",
                            "visible": "[steps('server').esri.architecture]",
                            "elements": [
                                {
                                    "name": "numnberOfPortalMachines",
                                    "type": "Microsoft.Common.Slider",
                                    "label": "Portal",
                                    "defaultValue": 2,
                                    "toolTip": "Input the ESRI portal virtual machine",
                                    "min": 1,
                                    "max": 2,
                                    "showStepMarkers": false,
                                    "constraints": {
                                        "required": true
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "numnberOfServerMachines",
                                    "type": "Microsoft.Common.Slider",
                                    "label": "Server",
                                    "defaultValue": 1,
                                    "toolTip": "Input the ESRI server virtual machine",
                                    "min": 1,
                                    "max": 10,
                                    "showStepMarkers": false,
                                    "constraints": {
                                        "required": true
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "numberOfFileShareMachines",
                                    "type": "Microsoft.Common.Slider",
                                    "label": "File Share",
                                    "defaultValue": 1,
                                    "toolTip": "Input the ESRI file server virtual machines",
                                    "min": 1,
                                    "max": 1,
                                    "showStepMarkers": false,
                                    "constraints": {
                                        "required": true
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "numberOfDataStoreMachines",
                                    "type": "Microsoft.Common.Slider",
                                    "label": "Relational Datastore",
                                    "defaultValue": 1,
                                    "toolTip": "Input the ESRI relation data store server virtual machines",
                                    "min": 1,
                                    "max": 2,
                                    "showStepMarkers": false,
                                    "constraints": {
                                        "required": true
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "numberOfTilecacheDataStoreMachines",
                                    "type": "Microsoft.Common.Slider",
                                    "label": "Tile Cache",
                                    "defaultValue": 1,
                                    "toolTip": "Input the ESRI tilecache data store server virtual machines",
                                    "min": 1,
                                    "max": 10,
                                    "showStepMarkers": false,
                                    "constraints": {
                                        "required": true
                                    },
                                    "visible": "[steps('datastoretypes').dataStores.tilecache]"
                                },
                                {
                                    "name": "numberOfSpatioTemporalDataStoreMachines",
                                    "type": "Microsoft.Common.Slider",
                                    "label": "SpatioTemporal",
                                    "defaultValue": 1,
                                    "toolTip": "Input the ESRI spatioTemporal data store server virtual machines",
                                    "min": 1,
                                    "max": 10,
                                    "showStepMarkers": false,
                                    "constraints": {
                                        "required": true
                                    },
                                    "visible": "[steps('datastoretypes').dataStores.spatioTemporal]"
                                },
                                {
                                    "name": "numberOfGraphStoreDataStoreMachines",
                                    "type": "Microsoft.Common.Slider",
                                    "label": "Graph Datastore",
                                    "defaultValue": 1,
                                    "toolTip": "Input the ESRI graphstore data store server virtual machines",
                                    "min": 1,
                                    "max": 1,
                                    "showStepMarkers": false,
                                    "constraints": {
                                        "required": true
                                    },
                                    "visible": "[steps('datastoretypes').dataStores.graphstore]"
                                },
                                {
                                    "name": "numberOfObjectStoreDataStoreMachines",
                                    "type": "Microsoft.Common.Slider",
                                    "label": "Object Datastore",
                                    "defaultValue": 1,
                                    "toolTip": "Input the ESRI object data store server virtual machines",
                                    "min": 3,
                                    "max": 9,
                                    "showStepMarkers": false,
                                    "constraints": {
                                        "required": true
                                    },
                                    "visible": "[steps('datastoretypes').dataStores.objectstore]"
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "licenses",
                    "label": "Licenses",
                    "elements": [
                        {
                            "name": "files",
                            "type": "Microsoft.Common.Section",
                            "label": "License files",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "portal",
                                    "type": "Microsoft.Common.FileUpload",
                                    "label": "Select your portal license file (.json)",
                                    "toolTip": "Upload the portal license file with the JSON file extension.",
                                    "constraints": {
                                        "required": true,
                                        "accept": ""
                                    },
                                    "options": {
                                        "multiple": false,
                                        "uploadMode": "file",
                                        "openMode": "binary",
                                        "encoding": ""
                                    },
                                    "visible": true,
                                    "scope": {
                                        "subscriptionId": "[steps('basics').resourceScope.subscription.subscriptionId]"
                                    },
                                    "resourceTypeMetadata": []
                                },
                                {
                                    "name": "server",
                                    "type": "Microsoft.Common.FileUpload",
                                    "label": "Select your server license file (.prvc)",
                                    "toolTip": "Upload the server license file with the PRVC file extension.",
                                    "constraints": {
                                        "required": true,
                                        "accept": ""
                                    },
                                    "options": {
                                        "multiple": false,
                                        "uploadMode": "file",
                                        "openMode": "binary",
                                        "encoding": ""
                                    },
                                    "visible": true,
                                    "scope": {
                                        "subscriptionId": "[steps('basics').resourceScope.subscription.subscriptionId]"
                                    },
                                    "resourceTypeMetadata": []
                                },
                                {
                                    "name": "licenseUserType",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "License Type",
                                    "placeholder": "",
                                    "defaultValue": [],
                                    "toolTip": "License User Type",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": false,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": false,
                                    "defaultDescription": "A value for selection",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "CreatorUT",
                                                "description": "The value to select for option 1.",
                                                "value": "CreatorUT"
                                            },
                                            {
                                                "label": "editorUT",
                                                "description": "The value to select for option 1.",
                                                "value": "editorUT"
                                            },
                                            {
                                                "label": "fieldWorkerUT",
                                                "description": "The value to select for option 1.",
                                                "value": "fieldWorkerUT"
                                            },
                                            {
                                                "label": "GISProfessionalAdvUT",
                                                "description": "The value to select for option 1.",
                                                "value": "GISProfessionalAdvUT"
                                            },
                                            {
                                                "label": "GISProfessionalBasicUTUT",
                                                "description": "The value to select for option 1.",
                                                "value": "GISProfessionalBasicUTUT"
                                            },
                                            {
                                                "value": "GISProfessionalStdUT",
                                                "label": "GISProfessionalStdUT",
                                                "description": "The value to select for option 1."
                                            },
                                            {
                                                "label": "IndoorsUserUT",
                                                "description": "The value to select for option 1.",
                                                "value": "IndoorsUserUT"
                                            },
                                            {
                                                "label": "insightsAnalystUT",
                                                "description": "The value to select for option 1.",
                                                "value": "insightsAnalystUT"
                                            },
                                            {
                                                "label": "viewerUT",
                                                "description": "The value to select for option 1.",
                                                "value": "viewerUT"
                                            }
                                        ],
                                        "required": true
                                    },
                                    "visible": true
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "certificates",
                    "label": "Certificates",
                    "elements": [
                        {
                            "name": "storageAccount",
                            "type": "Microsoft.Common.Section",
                            "label": "Storage Account",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "storageSelector",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "label": "Storage where your ESRI pre-req files uploaded",
                                    "resourceType": "Microsoft.Storage/storageAccounts",
                                    "required": true,
                                    "options": {
                                        "filter": {}
                                    }
                                },
                                {
                                    "name": "containerApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "[concat(steps('certificates').storageAccount.storageSelector.id, '/blobServices/default/containers?api-version=2023-01-01')]"
                                    }
                                },
                                {
                                    "name": "container",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "label": "Container",
                                    "defaultValue": "",
                                    "toolTip": "Select an existing container where your ESRI pre-req files are uploaded.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": "[map(steps('certificates').storageAccount.containerApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\"}')))]"
                                    }
                                }
                            ]
                        },
                        {
                            "name": "pfx",
                            "type": "Microsoft.Common.Section",
                            "label": "Certificate",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "certificateFileName",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Name",
                                    "defaultValue": "",
                                    "toolTip": "",
                                    "placeholder": "wildcard_contoso_com.pfx",
                                    "multiLine": false,
                                    "constraints": {
                                        "required": true,
                                        "validations": []
                                    },
                                    "visible": true,
                                    "required": true
                                },
                                {
                                    "name": "certificatePassword",
                                    "type": "Microsoft.Common.PasswordBox",
                                    "visible": true,
                                    "label": "certificate password",
                                    "toolTip": "Enter the password associated with the certificate.",
                                    "constraints": {
                                        "required": true
                                    },
                                    "options": {
                                        "hideConfirmation": true
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "tags",
                    "label": "Tags",
                    "elements": [
                        {
                            "name": "tags",
                            "type": "Microsoft.Common.TagsByResource",
                            "resources": [
                                "Microsoft.Compute/availabilitySets",
                                "Microsoft.Compute/virtualMachines",
                                "Microsoft.KeyVault/vaults",
                                "Microsoft.ManagedIdentity/userAssignedIdentities",
                                "Microsoft.Network/applicationGateways",
                                "Microsoft.Network/networkInterfaces",
                                "Microsoft.Network/publicIPAddresses",
                                "Microsoft.Network/virtualNetworks",
                                "Microsoft.Resources/deploymentScripts",
                                "Microsoft.Resources/resourceGroups",
                                "Microsoft.Storage/storageAccounts"
                            ]
                        }
                    ]
                }
            ]
        },
        "outputs": {
            "parameters": {
                "adminPassword": "[steps('server').localAdminCredentials.password]",
                "adminUsername": "[steps('server').localAdminCredentials.username]",
                "applicationGatewayPrivateIpAddress": "[steps('network').spokeVirtualNetwork.privateIpAddress]",
                "applicationGatewaySubnetAddressPrefix": "[steps('network').spokeVirtualNetwork.appGwSubnetAddressCidrRange]",
                "arcgisServiceAccountIsDomainAccount": "[steps('portal').arcgisServiceAccount.isDomainAccount]",
                "arcgisServiceAccountPassword": "[steps('portal').arcgisServiceAccount.password]",
                "arcgisServiceAccountUserName": "[steps('portal').arcgisServiceAccount.username]",
                "architecture": "[if(equals(steps('server').esri.architecture, true), 'multitier', 'singletier')]",
                "azureFirewallName": "[first(skip(split(steps('basics').hub.azureFirewall, '/'), 8))]",
                "certificateFileName": "[steps('certificates').pfx.certificateFileName]",
                "certificatePassword": "[steps('certificates').pfx.certificatePassword]",
                "debugMode": "[steps('portal').configuration.debugMode]",
                "defaultSubnetAddressPrefix": "[steps('network').spokeVirtualNetwork.esriSubnetAddressCidrRange]",
                "deployDefender": false,
                "diskEncryptionSetResourceId": "[steps('server').configuration.diskEncryptionSetSelector.id]",
                "emailSecurityContact": "",
                "enableMonitoring": "[steps('server').configuration.enableMonitoring]",
                "enableVirtualMachineDataDisk": "[steps('server').configuration.enableVirtualMachineDataDisk]",
                "enableGraphDataStore": "[if(equals(steps('server').esri.architecture, true), steps('datastoretypes').dataStores.graphstore, false)]",
                "enableObjectDataStore": "[if(equals(steps('server').esri.architecture, true), steps('datastoretypes').dataStores.objectstore, false)]",
                "enableSpatiotemporalBigDataStore": "[steps('datastoretypes').dataStores.spatioTemporal]",
                "enableTileCacheDataStore": "[steps('datastoretypes').dataStores.tilecache]",
                "externalDnsHostname": "[steps('portal').configuration.externalDnsHostname]",
                "hubResourceGroupName": "[first(skip(split(steps('basics').hub.azureFirewall, '/'), 4))]",
                "hubSubscriptionId": "[replace(steps('basics').subscriptions.hub, '/subscriptions/', '')]",
                "hubVirtualNetworkName": "[first(skip(split(steps('basics').hub.virtualNetwork, '/'), 8))]",
                "artifactsStorageAccountName": "[steps('certificates').storageAccount.storageSelector.name]",
                "artifactsContainerName": "[first(skip(split(steps('certificates').storageAccount.container, '/'), 12))]",
                "artifactsStorageAccountResourceGroupName": "[first(skip(split(steps('certificates').storageAccount.storageSelector.id, '/'), 4))]",
                "artifactsStorageAccountSubscriptionId": "[first(skip(split(steps('certificates').storageAccount.storageSelector.id, '/'), 2))]",
                "isTileCacheDataStoreClustered": false,
                "isUpdatingCertificates": false,
                "joinWindowsDomain": "[if(equals(steps('server').domain.identity, true), true, false)]",
                "joinEntraDomain": "[if(equals(steps('server').domain.identity, false), true, false)]",
                "logAnalyticsWorkspaceName": "[steps('network').spokeVirtualNetwork.logAnalyticsWorkspace.name]",
                "ouPath": "[if(equals(steps('server').domain.identity, true), steps('server').domain.ouPath, '')]",
                "numberOfDataStoreVirtualMachines": "[steps('datastoretypes').multitier.numnberOfPortalMachines]",
                "numberOfEsriServers": "[steps('datastoretypes').multitier.numnberOfServerMachines]",
                "numberOfFileShareVirtualMachines": "[steps('datastoretypes').multitier.numberOfFileShareMachines]",
                "numberOfGraphDataStoreVirtualMachines": "[if(equals(steps('datastoretypes').dataStores.graphstore, true), steps('datastoretypes').multitier.numberOfGraphStoreDataStoreMachines, 0)]",
                "numberOfObjectStoreDataStoreVirtualMachines": "[if(equals(steps('datastoretypes').dataStores.objectstore, true), steps('datastoretypes').multitier.numberOfObjectStoreDataStoreMachines, 0)]",
                "numberOfPortalVirtualMachines": "[steps('datastoretypes').multitier.numnberOfPortalMachines]",
                "numberOfRelationalDataStoreVirtualMachines": "[steps('datastoretypes').multitier.numberOfDataStoreMachines]",
                "numberOfEsrispatiotemporalBigDataStoreVirtualMachines": "[if(equals(steps('datastoretypes').dataStores.spatioTemporal, true), steps('datastoretypes').multitier.numberOfSpatioTemporalDataStoreMachines, 0)]",
                "numberOfTileCacheDataStoreVirtualMachines": "[if(equals(steps('datastoretypes').dataStores.tilecache, true), steps('datastoretypes').multitier.numberOfTilecacheDataStoreMachines, 0)]",
                "portalLicenseFile": "[steps('licenses').files.portal]",
                "portalLicenseUserTypeId": "[steps('licenses').files.licenseUserType]",
                "primarySiteAdministratorAccountPassword": "[steps('portal').primarySiteAdministratorAccount.password]",
                "primarySiteAdministratorAccountUserName": "[steps('portal').primarySiteAdministratorAccount.username]",
                "resourcePrefix": "[steps('basics').naming.resourceSuffix]",
                "resourceSuffix": "[steps('basics').naming.resourceSuffix]",
                "serverLicenseFile": "[steps('licenses').files.server]",
                "spokelogAnalyticsWorkspaceResourceId": "[steps('network').spokeVirtualNetwork.logAnalyticsWorkspace.id]",
                "selfSignedCertificatePassword": "[steps('certificates').pfx.certificatePassword]",
                "tags": "[steps('tags').tags]",
                "useCloudStorage": "[if(equals(steps('server').esri.architecture, true), steps('server').configuration.useAzureStorage, false)]",
                "useAzureFiles": "[if(equals(steps('server').esri.architecture, true), steps('server').configuration.useAzureStorage, false)]",
                "virtualNetworkAddressPrefix": "[steps('network').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange]",
                "virtualMachineOSDiskSize": "[steps('server').configuration.osDiskSize]",
                "windowsDomainAdministratorPassword": "[if(equals(steps('server').domain.identity, true), steps('server').domain.password, '')]",
                "windowsDomainAdministratorUserName": "[if(equals(steps('server').domain.identity, true), steps('server').domain.userPrincipalName, '')]",
                "windowsDomainName": "[if(equals(steps('server').domain.identity, true), steps('server').domain.name, '')]",
                "workloadSubscriptionId": "[replace(steps('basics').subscriptions.spoke , '/subscriptions/', '')]"
            },
            "kind": "Subscription",
            "location": "[steps('basics').scope.location.name]",
            "subscriptionId": "[steps('basics').scope.subscription.id]"
        }
    }
}