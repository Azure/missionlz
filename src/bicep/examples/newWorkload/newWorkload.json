{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1008.15138",
      "templateHash": "12771006393275245261"
    }
  },
  "parameters": {
    "mlzDeploymentVariables": {
      "type": "object",
      "defaultValue": "[json('{\r\n  \"mlzResourcePrefix\": {\r\n    \"Type\": \"String\",\r\n    \"Value\": \"contoso\"\r\n  },\r\n  \"firewallPrivateIPAddress\": {\r\n    \"Type\": \"String\",\r\n    \"Value\": \"10.0.100.4\"\r\n  },\r\n  \"hub\": {\r\n    \"Type\": \"Object\",\r\n    \"Value\": {\r\n      \"subscriptionId\": \"093847b0-f0dd-428f-a0b0-bd4245b99339\",\r\n      \"resourceGroupName\": \"contoso-rg-hub-mlz\",\r\n      \"resourceGroupResourceId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-hub-mlz\",\r\n      \"virtualNetworkName\": \"contoso-vnet-hub-mlz\",\r\n      \"virtualNetworkResourceId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-hub-mlz/providers/Microsoft.Network/virtualNetworks/contoso-vnet-hub-mlz\",\r\n      \"subnetName\": \"contoso-vnet-hub-mlz/contoso-snet-hub-mlz\",\r\n      \"subnetResourceId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-hub-mlz/providers/Microsoft.Network/virtualNetworks/contoso-vnet-hub-mlz/subnets/contoso-snet-hub-mlz\",\r\n      \"subnetAddressPrefix\": \"10.0.100.128/27\",\r\n      \"networkSecurityGroupName\": \"contoso-nsg-hub-mlz\",\r\n      \"networkSecurityGroupResourceId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-hub-mlz/providers/Microsoft.Network/networkSecurityGroups/contoso-nsg-hub-mlz\"\r\n    }\r\n  },\r\n  \"logAnalyticsWorkspaceName\": {\r\n    \"Type\": \"String\",\r\n    \"Value\": \"contoso-log-operations-mlz\"\r\n  },\r\n  \"logAnalyticsWorkspaceResourceId\": {\r\n    \"Type\": \"String\",\r\n    \"Value\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-operations-mlz/providers/Microsoft.OperationalInsights/workspaces/contoso-log-operations-mlz\"\r\n  },\r\n  \"spokes\": {\r\n    \"Type\": \"Array\",\r\n    \"Value\": [\r\n      {\r\n        \"name\": \"identity\",\r\n        \"subscriptionId\": \"093847b0-f0dd-428f-a0b0-bd4245b99339\",\r\n        \"resourceGroupName\": \"contoso-rg-identity-mlz\",\r\n        \"resourceGroupId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-identity-mlz\",\r\n        \"virtualNetworkName\": \"contoso-vnet-identity-mlz\",\r\n        \"virtualNetworkResourceId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-identity-mlz/providers/Microsoft.Network/virtualNetworks/contoso-vnet-identity-mlz\",\r\n        \"subnetName\": \"contoso-snet-identity-mlz\",\r\n        \"subnetResourceId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-identity-mlz/providers/Microsoft.Network/virtualNetworks/contoso-vnet-identity-mlz/subnets/contoso-snet-identity-mlz\",\r\n        \"subnetAddressPrefix\": \"10.0.110.0/27\",\r\n        \"networkSecurityGroupName\": \"contoso-nsg-identity-mlz\",\r\n        \"networkSecurityGroupResourceId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-identity-mlz/providers/Microsoft.Network/networkSecurityGroups/contoso-nsg-identity-mlz\"\r\n      },\r\n      {\r\n        \"name\": \"operations\",\r\n        \"subscriptionId\": \"093847b0-f0dd-428f-a0b0-bd4245b99339\",\r\n        \"resourceGroupName\": \"contoso-rg-operations-mlz\",\r\n        \"resourceGroupId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-operations-mlz\",\r\n        \"virtualNetworkName\": \"contoso-vnet-operations-mlz\",\r\n        \"virtualNetworkResourceId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-operations-mlz/providers/Microsoft.Network/virtualNetworks/contoso-vnet-operations-mlz\",\r\n        \"subnetName\": \"contoso-snet-operations-mlz\",\r\n        \"subnetResourceId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-operations-mlz/providers/Microsoft.Network/virtualNetworks/contoso-vnet-operations-mlz/subnets/contoso-snet-operations-mlz\",\r\n        \"subnetAddressPrefix\": \"10.0.115.0/27\",\r\n        \"networkSecurityGroupName\": \"contoso-nsg-operations-mlz\",\r\n        \"networkSecurityGroupResourceId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-operations-mlz/providers/Microsoft.Network/networkSecurityGroups/contoso-nsg-operations-mlz\"\r\n      },\r\n      {\r\n        \"name\": \"sharedServices\",\r\n        \"subscriptionId\": \"093847b0-f0dd-428f-a0b0-bd4245b99339\",\r\n        \"resourceGroupName\": \"contoso-rg-sharedServices-mlz\",\r\n        \"resourceGroupId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-sharedServices-mlz\",\r\n        \"virtualNetworkName\": \"contoso-vnet-sharedServices-mlz\",\r\n        \"virtualNetworkResourceId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-sharedServices-mlz/providers/Microsoft.Network/virtualNetworks/contoso-vnet-sharedServices-mlz\",\r\n        \"subnetName\": \"contoso-snet-sharedServices-mlz\",\r\n        \"subnetResourceId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-sharedServices-mlz/providers/Microsoft.Network/virtualNetworks/contoso-vnet-sharedServices-mlz/subnets/contoso-snet-sharedServices-mlz\",\r\n        \"subnetAddressPrefix\": \"10.0.120.0/27\",\r\n        \"networkSecurityGroupName\": \"contoso-nsg-sharedServices-mlz\",\r\n        \"networkSecurityGroupResourceId\": \"/subscriptions/093847b0-f0dd-428f-a0b0-bd4245b99339/resourceGroups/contoso-rg-sharedServices-mlz/providers/Microsoft.Network/networkSecurityGroups/contoso-nsg-sharedServices-mlz\"\r\n      }\r\n    ]\r\n  }\r\n}\r\n')]"
    },
    "workloadName": {
      "type": "string",
      "maxLength": 24,
      "minLength": 3
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[format('{0}-rg', parameters('workloadName'))]"
    },
    "location": {
      "type": "string",
      "defaultValue": "[deployment().location]"
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "resourceIdentifier": "[parameters('resourceIdentifier')]"
      }
    },
    "hubSubscriptionId": {
      "type": "string",
      "defaultValue": "[parameters('mlzDeploymentVariables').hub.Value.subscriptionId]"
    },
    "hubResourceGroupName": {
      "type": "string",
      "defaultValue": "[parameters('mlzDeploymentVariables').hub.Value.resourceGroupName]"
    },
    "hubVirtualNetworkName": {
      "type": "string",
      "defaultValue": "[parameters('mlzDeploymentVariables').hub.Value.virtualNetworkName]"
    },
    "hubVirtualNetworkResourceId": {
      "type": "string",
      "defaultValue": "[parameters('mlzDeploymentVariables').hub.Value.virtualNetworkResourceId]"
    },
    "logAnalyticsWorkspaceResourceId": {
      "type": "string",
      "defaultValue": "[parameters('mlzDeploymentVariables').logAnalyticsWorkspaceResourceId.Value]"
    },
    "firewallPrivateIPAddress": {
      "type": "string",
      "defaultValue": "[parameters('mlzDeploymentVariables').firewallPrivateIPAddress.Value]"
    },
    "virtualNetworkName": {
      "type": "string",
      "defaultValue": "[format('{0}-vnet', parameters('workloadName'))]"
    },
    "virtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.125.0/26"
    },
    "virtualNetworkDiagnosticsLogs": {
      "type": "array",
      "defaultValue": []
    },
    "virtualNetworkDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": []
    },
    "networkSecurityGroupName": {
      "type": "string",
      "defaultValue": "[format('{0}-nsg', parameters('workloadName'))]"
    },
    "networkSecurityGroupRules": {
      "type": "array",
      "defaultValue": []
    },
    "networkSecurityGroupDiagnosticsLogs": {
      "type": "array",
      "defaultValue": [
        {
          "category": "NetworkSecurityGroupEvent",
          "enabled": true
        },
        {
          "category": "NetworkSecurityGroupRuleCounter",
          "enabled": true
        }
      ]
    },
    "networkSecurityGroupDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": []
    },
    "subnetName": {
      "type": "string",
      "defaultValue": "[format('{0}-subnet', parameters('workloadName'))]"
    },
    "subnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.125.0/27"
    },
    "subnetServiceEndpoints": {
      "type": "array",
      "defaultValue": []
    },
    "logStorageAccountName": {
      "type": "string",
      "defaultValue": "[toLower(take(format('logs{0}', uniqueString(subscription().subscriptionId, parameters('workloadName'))), 24))]"
    },
    "logStorageSkuName": {
      "type": "string",
      "defaultValue": "Standard_GRS"
    },
    "resourceIdentifier": {
      "type": "string",
      "defaultValue": "[format('{0}{1}', parameters('workloadName'), uniqueString(parameters('workloadName')))]"
    }
  },
  "functions": [],
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[parameters('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "spokeNetwork",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "tags": {
            "value": "[parameters('tags')]"
          },
          "logStorageAccountName": {
            "value": "[parameters('logStorageAccountName')]"
          },
          "logStorageSkuName": {
            "value": "[parameters('logStorageSkuName')]"
          },
          "logAnalyticsWorkspaceResourceId": {
            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
          },
          "firewallPrivateIPAddress": {
            "value": "[parameters('firewallPrivateIPAddress')]"
          },
          "virtualNetworkName": {
            "value": "[parameters('virtualNetworkName')]"
          },
          "virtualNetworkAddressPrefix": {
            "value": "[parameters('virtualNetworkAddressPrefix')]"
          },
          "virtualNetworkDiagnosticsLogs": {
            "value": "[parameters('virtualNetworkDiagnosticsLogs')]"
          },
          "virtualNetworkDiagnosticsMetrics": {
            "value": "[parameters('virtualNetworkDiagnosticsMetrics')]"
          },
          "networkSecurityGroupName": {
            "value": "[parameters('networkSecurityGroupName')]"
          },
          "networkSecurityGroupRules": {
            "value": "[parameters('networkSecurityGroupRules')]"
          },
          "networkSecurityGroupDiagnosticsLogs": {
            "value": "[parameters('networkSecurityGroupDiagnosticsLogs')]"
          },
          "networkSecurityGroupDiagnosticsMetrics": {
            "value": "[parameters('networkSecurityGroupDiagnosticsMetrics')]"
          },
          "subnetName": {
            "value": "[parameters('subnetName')]"
          },
          "subnetAddressPrefix": {
            "value": "[parameters('subnetAddressPrefix')]"
          },
          "subnetServiceEndpoints": {
            "value": "[parameters('subnetServiceEndpoints')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "17180259987553481892"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "logStorageAccountName": {
              "type": "string"
            },
            "logStorageSkuName": {
              "type": "string"
            },
            "logAnalyticsWorkspaceResourceId": {
              "type": "string"
            },
            "firewallPrivateIPAddress": {
              "type": "string"
            },
            "virtualNetworkName": {
              "type": "string"
            },
            "virtualNetworkAddressPrefix": {
              "type": "string"
            },
            "virtualNetworkDiagnosticsLogs": {
              "type": "array"
            },
            "virtualNetworkDiagnosticsMetrics": {
              "type": "array"
            },
            "networkSecurityGroupName": {
              "type": "string"
            },
            "networkSecurityGroupRules": {
              "type": "array"
            },
            "networkSecurityGroupDiagnosticsLogs": {
              "type": "array"
            },
            "networkSecurityGroupDiagnosticsMetrics": {
              "type": "array"
            },
            "subnetName": {
              "type": "string"
            },
            "subnetAddressPrefix": {
              "type": "string"
            },
            "subnetServiceEndpoints": {
              "type": "array"
            },
            "routeTableName": {
              "type": "string",
              "defaultValue": "[format('{0}-routetable', parameters('subnetName'))]"
            },
            "routeTableRouteName": {
              "type": "string",
              "defaultValue": "default_route"
            },
            "routeTableRouteAddressPrefix": {
              "type": "string",
              "defaultValue": "0.0.0.0/0"
            },
            "routeTableRouteNextHopIpAddress": {
              "type": "string",
              "defaultValue": "[parameters('firewallPrivateIPAddress')]"
            },
            "routeTableRouteNextHopType": {
              "type": "string",
              "defaultValue": "VirtualAppliance"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "logStorage",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "storageAccountName": {
                    "value": "[parameters('logStorageAccountName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "skuName": {
                    "value": "[parameters('logStorageSkuName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "779275696574787628"
                    }
                  },
                  "parameters": {
                    "storageAccountName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2019-06-01",
                      "name": "[parameters('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "kind": "Storage",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "networkSecurityGroup",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('networkSecurityGroupName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "securityRules": {
                    "value": "[parameters('networkSecurityGroupRules')]"
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "logStorageAccountResourceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logStorage'), '2020-06-01').outputs.id.value]"
                  },
                  "logs": {
                    "value": "[parameters('networkSecurityGroupDiagnosticsLogs')]"
                  },
                  "metrics": {
                    "value": "[parameters('networkSecurityGroupDiagnosticsMetrics')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "4497555273030729522"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "securityRules": {
                      "type": "array"
                    },
                    "logStorageAccountResourceId": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "logs": {
                      "type": "array"
                    },
                    "metrics": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "securityRules": "[parameters('securityRules')]"
                      }
                    },
                    {
                      "type": "Microsoft.Insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "scope": "[format('Microsoft.Network/networkSecurityGroups/{0}', parameters('name'))]",
                      "name": "[format('{0}-diagnostics', parameters('name'))]",
                      "properties": {
                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]",
                        "logs": "[parameters('logs')]",
                        "metrics": "[parameters('metrics')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'logStorage')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "routeTable",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('routeTableName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "routeName": {
                    "value": "[parameters('routeTableRouteName')]"
                  },
                  "routeAddressPrefix": {
                    "value": "[parameters('routeTableRouteAddressPrefix')]"
                  },
                  "routeNextHopIpAddress": {
                    "value": "[parameters('routeTableRouteNextHopIpAddress')]"
                  },
                  "routeNextHopType": {
                    "value": "[parameters('routeTableRouteNextHopType')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "12136081248191573008"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "routeName": {
                      "type": "string"
                    },
                    "routeAddressPrefix": {
                      "type": "string"
                    },
                    "routeNextHopIpAddress": {
                      "type": "string"
                    },
                    "routeNextHopType": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "routes": [
                          {
                            "name": "[parameters('routeName')]",
                            "properties": {
                              "addressPrefix": "[parameters('routeAddressPrefix')]",
                              "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                              "nextHopType": "[parameters('routeNextHopType')]"
                            }
                          }
                        ]
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "virtualNetwork",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('virtualNetworkName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "addressPrefix": {
                    "value": "[parameters('virtualNetworkAddressPrefix')]"
                  },
                  "subnets": {
                    "value": [
                      {
                        "name": "[parameters('subnetName')]",
                        "properties": {
                          "addressPrefix": "[parameters('subnetAddressPrefix')]",
                          "networkSecurityGroup": {
                            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.id.value]"
                          },
                          "routeTable": {
                            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'routeTable'), '2020-06-01').outputs.id.value]"
                          },
                          "serviceEndpoints": "[parameters('subnetServiceEndpoints')]"
                        }
                      }
                    ]
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "logStorageAccountResourceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logStorage'), '2020-06-01').outputs.id.value]"
                  },
                  "logs": {
                    "value": "[parameters('virtualNetworkDiagnosticsLogs')]"
                  },
                  "metrics": {
                    "value": "[parameters('virtualNetworkDiagnosticsMetrics')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "12119421388421560495"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "addressPrefix": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "logStorageAccountResourceId": {
                      "type": "string"
                    },
                    "subnets": {
                      "type": "array"
                    },
                    "logs": {
                      "type": "array"
                    },
                    "metrics": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('addressPrefix')]"
                          ]
                        },
                        "subnets": "[parameters('subnets')]"
                      }
                    },
                    {
                      "type": "Microsoft.Insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "scope": "[format('Microsoft.Network/virtualNetworks/{0}', parameters('name'))]",
                      "name": "[format('{0}-diagnostics', parameters('name'))]",
                      "properties": {
                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]",
                        "logs": "[parameters('logs')]",
                        "metrics": "[parameters('metrics')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                    },
                    "subnets": {
                      "type": "array",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name'))).subnets]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'logStorage')]",
                "[resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup')]",
                "[resourceId('Microsoft.Resources/deployments', 'routeTable')]"
              ]
            }
          ],
          "outputs": {
            "virtualNetworkName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.name.value]"
            },
            "virtualNetworkResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.id.value]"
            },
            "subnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.subnets.value[0].name]"
            },
            "subnetAddressPrefix": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.subnets.value[0].properties.addressPrefix]"
            },
            "subnetResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.subnets.value[0].id]"
            },
            "networkSecurityGroupName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.name.value]"
            },
            "networkSecurityGroupResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.id.value]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[take(format('{0}--VNetPeerings', parameters('workloadName')), 64)]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "spokeName": {
            "value": "[parameters('workloadName')]"
          },
          "spokeResourceGroupName": {
            "value": "[parameters('resourceGroupName')]"
          },
          "spokeVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'spokeNetwork'), '2020-06-01').outputs.virtualNetworkName.value]"
          },
          "hubVirtualNetworkName": {
            "value": "[parameters('hubVirtualNetworkName')]"
          },
          "hubVirtualNetworkResourceId": {
            "value": "[parameters('hubVirtualNetworkResourceId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "9292126827663520366"
            }
          },
          "parameters": {
            "spokeName": {
              "type": "string"
            },
            "spokeResourceGroupName": {
              "type": "string"
            },
            "spokeVirtualNetworkName": {
              "type": "string"
            },
            "hubVirtualNetworkName": {
              "type": "string"
            },
            "hubVirtualNetworkResourceId": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}-to-hub-vnet-peering', parameters('spokeName'))]",
              "resourceGroup": "[parameters('spokeResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('{0}/to-{1}', parameters('spokeVirtualNetworkName'), parameters('hubVirtualNetworkName'))]"
                  },
                  "remoteVirtualNetworkResourceId": {
                    "value": "[parameters('hubVirtualNetworkResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "17516021996853951284"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                        }
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'spokeNetwork')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "hubToWorkloadVirtualNetworkPeering",
      "subscriptionId": "[parameters('hubSubscriptionId')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "hubResourceGroupName": {
            "value": "[parameters('hubResourceGroupName')]"
          },
          "hubVirtualNetworkName": {
            "value": "[parameters('hubVirtualNetworkName')]"
          },
          "spokeVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'spokeNetwork'), '2020-06-01').outputs.virtualNetworkName.value]"
          },
          "spokeVirtualNetworkResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'spokeNetwork'), '2020-06-01').outputs.virtualNetworkResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "5427670383068182025"
            }
          },
          "parameters": {
            "hubResourceGroupName": {
              "type": "string"
            },
            "hubVirtualNetworkName": {
              "type": "string"
            },
            "spokeVirtualNetworkName": {
              "type": "string"
            },
            "spokeVirtualNetworkResourceId": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "hubToSpokeVirtualNetworkPeering",
              "resourceGroup": "[parameters('hubResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('{0}/to-{1}', parameters('hubVirtualNetworkName'), parameters('spokeVirtualNetworkName'))]"
                  },
                  "remoteVirtualNetworkResourceId": {
                    "value": "[parameters('spokeVirtualNetworkResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "17516021996853951284"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                        }
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'spokeNetwork')]"
      ]
    }
  ],
  "outputs": {
    "virtualNetworkName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'spokeNetwork'), '2020-06-01').outputs.virtualNetworkName.value]"
    },
    "virtualNetworkResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'spokeNetwork'), '2020-06-01').outputs.virtualNetworkResourceId.value]"
    },
    "subnetName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'spokeNetwork'), '2020-06-01').outputs.subnetName.value]"
    },
    "subnetAddressPrefix": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'spokeNetwork'), '2020-06-01').outputs.subnetAddressPrefix.value]"
    },
    "subnetResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'spokeNetwork'), '2020-06-01').outputs.subnetResourceId.value]"
    },
    "networkSecurityGroupName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'spokeNetwork'), '2020-06-01').outputs.networkSecurityGroupName.value]"
    },
    "networkSecurityGroupResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'spokeNetwork'), '2020-06-01').outputs.networkSecurityGroupResourceId.value]"
    }
  }
}