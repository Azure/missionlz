{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.451.19169",
      "templateHash": "6513664242668600242"
    }
  },
  "parameters": {
    "resourcePrefix": {
      "type": "string",
      "defaultValue": "[format('mlz-{0}', parameters('uniqueId'))]",
      "metadata": {
        "description": "A name (3-24 alphanumeric characters in length without whitespace) used to prefix resources and generate uniqueness for resources with globally unique naming requirements like Storage Accounts and Log Analytics Workspaces"
      },
      "maxLength": 24,
      "minLength": 3
    },
    "hubSubscriptionId": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]"
    },
    "identitySubscriptionId": {
      "type": "string",
      "defaultValue": "[parameters('hubSubscriptionId')]"
    },
    "operationsSubscriptionId": {
      "type": "string",
      "defaultValue": "[parameters('hubSubscriptionId')]"
    },
    "sharedServicesSubscriptionId": {
      "type": "string",
      "defaultValue": "[parameters('hubSubscriptionId')]"
    },
    "firewallSkuTier": {
      "type": "string",
      "defaultValue": "Premium",
      "allowedValues": [
        "Standard",
        "Premium"
      ]
    },
    "hubResourceGroupName": {
      "type": "string",
      "defaultValue": "[format('{0}-hub', parameters('resourcePrefix'))]"
    },
    "hubLocation": {
      "type": "string",
      "defaultValue": "[deployment().location]"
    },
    "hubVirtualNetworkName": {
      "type": "string",
      "defaultValue": "hub-vnet"
    },
    "hubSubnetName": {
      "type": "string",
      "defaultValue": "hub-subnet"
    },
    "hubVirtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.100.0/24"
    },
    "hubSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.100.128/27"
    },
    "hubVirtualNetworkDiagnosticsLogs": {
      "type": "array",
      "defaultValue": []
    },
    "hubVirtualNetworkDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": []
    },
    "hubNetworkSecurityGroupName": {
      "type": "string",
      "defaultValue": "hub-nsg"
    },
    "hubNetworkSecurityGroupRules": {
      "type": "array",
      "defaultValue": []
    },
    "hubSubnetServiceEndpoints": {
      "type": "array",
      "defaultValue": []
    },
    "hubLogStorageAccountName": {
      "type": "string",
      "defaultValue": "[toLower(take(format('hublogs{0}', parameters('uniqueId')), 24))]"
    },
    "hubLogStorageSkuName": {
      "type": "string",
      "defaultValue": "Standard_GRS"
    },
    "firewallName": {
      "type": "string",
      "defaultValue": "firewall"
    },
    "firewallManagementSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.100.64/26"
    },
    "firewallClientSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.100.0/26"
    },
    "firewallPolicyName": {
      "type": "string",
      "defaultValue": "firewall-policy"
    },
    "firewallThreatIntelMode": {
      "type": "string",
      "defaultValue": "Alert"
    },
    "firewallClientIpConfigurationName": {
      "type": "string",
      "defaultValue": "firewall-client-ip-config"
    },
    "firewallClientSubnetServiceEndpoints": {
      "type": "array",
      "defaultValue": []
    },
    "firewallClientPublicIPAddressName": {
      "type": "string",
      "defaultValue": "firewall-client-public-ip"
    },
    "firewallClientPublicIPAddressSkuName": {
      "type": "string",
      "defaultValue": "Standard"
    },
    "firewallClientPublicIpAllocationMethod": {
      "type": "string",
      "defaultValue": "Static"
    },
    "firewallClientPublicIPAddressAvailabilityZones": {
      "type": "array",
      "defaultValue": []
    },
    "firewallManagementIpConfigurationName": {
      "type": "string",
      "defaultValue": "firewall-management-ip-config"
    },
    "firewallManagementSubnetServiceEndpoints": {
      "type": "array",
      "defaultValue": []
    },
    "firewallManagementPublicIPAddressName": {
      "type": "string",
      "defaultValue": "firewall-management-public-ip"
    },
    "firewallManagementPublicIPAddressSkuName": {
      "type": "string",
      "defaultValue": "Standard"
    },
    "firewallManagementPublicIpAllocationMethod": {
      "type": "string",
      "defaultValue": "Static"
    },
    "firewallManagementPublicIPAddressAvailabilityZones": {
      "type": "array",
      "defaultValue": []
    },
    "identityResourceGroupName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubResourceGroupName'), 'hub', 'identity')]"
    },
    "identityLocation": {
      "type": "string",
      "defaultValue": "[parameters('hubLocation')]"
    },
    "identityVirtualNetworkName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubVirtualNetworkName'), 'hub', 'identity')]"
    },
    "identitySubnetName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubSubnetName'), 'hub', 'identity')]"
    },
    "identityVirtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.110.0/26"
    },
    "identitySubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.110.0/27"
    },
    "identityVirtualNetworkDiagnosticsLogs": {
      "type": "array",
      "defaultValue": []
    },
    "identityVirtualNetworkDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": []
    },
    "identityNetworkSecurityGroupName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubNetworkSecurityGroupName'), 'hub', 'identity')]"
    },
    "identityNetworkSecurityGroupRules": {
      "type": "array",
      "defaultValue": []
    },
    "identitySubnetServiceEndpoints": {
      "type": "array",
      "defaultValue": []
    },
    "identityLogStorageAccountName": {
      "type": "string",
      "defaultValue": "[toLower(take(format('idlogs{0}', parameters('uniqueId')), 24))]"
    },
    "identityLogStorageSkuName": {
      "type": "string",
      "defaultValue": "[parameters('hubLogStorageSkuName')]"
    },
    "operationsResourceGroupName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubResourceGroupName'), 'hub', 'operations')]"
    },
    "operationsLocation": {
      "type": "string",
      "defaultValue": "[parameters('hubLocation')]"
    },
    "operationsVirtualNetworkName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubVirtualNetworkName'), 'hub', 'operations')]"
    },
    "operationsVirtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.115.0/26"
    },
    "operationsVirtualNetworkDiagnosticsLogs": {
      "type": "array",
      "defaultValue": []
    },
    "operationsVirtualNetworkDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": []
    },
    "operationsNetworkSecurityGroupName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubNetworkSecurityGroupName'), 'hub', 'operations')]"
    },
    "operationsNetworkSecurityGroupRules": {
      "type": "array",
      "defaultValue": []
    },
    "operationsSubnetName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubSubnetName'), 'hub', 'operations')]"
    },
    "operationsSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.115.0/27"
    },
    "operationsSubnetServiceEndpoints": {
      "type": "array",
      "defaultValue": []
    },
    "operationsLogStorageAccountName": {
      "type": "string",
      "defaultValue": "[toLower(take(format('opslogs{0}', parameters('uniqueId')), 24))]"
    },
    "operationsLogStorageSkuName": {
      "type": "string",
      "defaultValue": "[parameters('hubLogStorageSkuName')]"
    },
    "sharedServicesResourceGroupName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubResourceGroupName'), 'hub', 'sharedServices')]"
    },
    "sharedServicesLocation": {
      "type": "string",
      "defaultValue": "[parameters('hubLocation')]"
    },
    "sharedServicesVirtualNetworkName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubVirtualNetworkName'), 'hub', 'sharedServices')]"
    },
    "sharedServicesSubnetName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubSubnetName'), 'hub', 'sharedServices')]"
    },
    "sharedServicesVirtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.120.0/26"
    },
    "sharedServicesSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.120.0/27"
    },
    "sharedServicesVirtualNetworkDiagnosticsLogs": {
      "type": "array",
      "defaultValue": []
    },
    "sharedServicesVirtualNetworkDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": []
    },
    "sharedServicesNetworkSecurityGroupName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubNetworkSecurityGroupName'), 'hub', 'sharedServices')]"
    },
    "sharedServicesNetworkSecurityGroupRules": {
      "type": "array",
      "defaultValue": []
    },
    "sharedServicesSubnetServiceEndpoints": {
      "type": "array",
      "defaultValue": []
    },
    "sharedServicesLogStorageAccountName": {
      "type": "string",
      "defaultValue": "[toLower(take(format('shrdSvclogs{0}', parameters('uniqueId')), 24))]"
    },
    "sharedServicesLogStorageSkuName": {
      "type": "string",
      "defaultValue": "[parameters('hubLogStorageSkuName')]"
    },
    "logAnalyticsWorkspaceName": {
      "type": "string",
      "defaultValue": "[take(format('{0}-laws', parameters('resourcePrefix')), 63)]"
    },
    "logAnalyticsWorkspaceLocation": {
      "type": "string",
      "defaultValue": "[parameters('sharedServicesLocation')]"
    },
    "logAnalyticsWorkspaceCappingDailyQuotaGb": {
      "type": "int",
      "defaultValue": -1
    },
    "logAnalyticsWorkspaceRetentionInDays": {
      "type": "int",
      "defaultValue": 30
    },
    "logAnalyticsWorkspaceSkuName": {
      "type": "string",
      "defaultValue": "PerGB2018"
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "resourcePrefix": "[parameters('resourcePrefix')]"
      }
    },
    "uniqueId": {
      "type": "string",
      "defaultValue": "[uniqueString(deployment().name)]"
    }
  },
  "functions": [],
  "variables": {
    "firewallClientSubnetName": "AzureFirewallSubnet",
    "firewallManagementSubnetName": "AzureFirewallManagementSubnet"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "hubResourceGroup",
      "subscriptionId": "[parameters('hubSubscriptionId')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('hubResourceGroupName')]"
          },
          "location": {
            "value": "[parameters('hubLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.451.19169",
              "templateHash": "4391723078931511573"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "identityResourceGroup",
      "subscriptionId": "[parameters('identitySubscriptionId')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('identityResourceGroupName')]"
          },
          "location": {
            "value": "[parameters('identityLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.451.19169",
              "templateHash": "4391723078931511573"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "operationsResourceGroup",
      "subscriptionId": "[parameters('operationsSubscriptionId')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('operationsResourceGroupName')]"
          },
          "location": {
            "value": "[parameters('operationsLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.451.19169",
              "templateHash": "4391723078931511573"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "sharedServicesResourceGroup",
      "subscriptionId": "[parameters('sharedServicesSubscriptionId')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('sharedServicesResourceGroupName')]"
          },
          "location": {
            "value": "[parameters('sharedServicesLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.451.19169",
              "templateHash": "4391723078931511573"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "logAnalyticsWorkspace",
      "subscriptionId": "[parameters('operationsSubscriptionId')]",
      "resourceGroup": "[parameters('operationsResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('logAnalyticsWorkspaceName')]"
          },
          "location": {
            "value": "[parameters('logAnalyticsWorkspaceLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "retentionInDays": {
            "value": "[parameters('logAnalyticsWorkspaceRetentionInDays')]"
          },
          "skuName": {
            "value": "[parameters('logAnalyticsWorkspaceSkuName')]"
          },
          "workspaceCappingDailyQuotaGb": {
            "value": "[parameters('logAnalyticsWorkspaceCappingDailyQuotaGb')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.451.19169",
              "templateHash": "3654750523315639217"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 30
            },
            "skuName": {
              "type": "string",
              "defaultValue": "PerGB2018"
            },
            "workspaceCappingDailyQuotaGb": {
              "type": "int",
              "defaultValue": -1
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2021-06-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "retentionInDays": "[parameters('retentionInDays')]",
                "sku": {
                  "name": "[parameters('skuName')]"
                },
                "workspaceCapping": {
                  "dailyQuotaGb": "[parameters('workspaceCappingDailyQuotaGb')]"
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId(parameters('operationsSubscriptionId'), 'Microsoft.Resources/deployments', 'operationsResourceGroup')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('{0}-hub', parameters('resourcePrefix'))]",
      "subscriptionId": "[parameters('hubSubscriptionId')]",
      "resourceGroup": "[parameters('hubResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('hubLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "logStorageAccountName": {
            "value": "[parameters('hubLogStorageAccountName')]"
          },
          "logStorageSkuName": {
            "value": "[parameters('hubLogStorageSkuName')]"
          },
          "logAnalyticsWorkspaceResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', 'logAnalyticsWorkspace'), '2019-10-01').outputs.id.value]"
          },
          "virtualNetworkName": {
            "value": "[parameters('hubVirtualNetworkName')]"
          },
          "virtualNetworkAddressPrefix": {
            "value": "[parameters('hubVirtualNetworkAddressPrefix')]"
          },
          "virtualNetworkDiagnosticsLogs": {
            "value": "[parameters('hubVirtualNetworkDiagnosticsLogs')]"
          },
          "virtualNetworkDiagnosticsMetrics": {
            "value": "[parameters('hubVirtualNetworkDiagnosticsMetrics')]"
          },
          "networkSecurityGroupName": {
            "value": "[parameters('hubNetworkSecurityGroupName')]"
          },
          "networkSecurityGroupRules": {
            "value": "[parameters('hubNetworkSecurityGroupRules')]"
          },
          "subnetName": {
            "value": "[parameters('hubSubnetName')]"
          },
          "subnetAddressPrefix": {
            "value": "[parameters('hubSubnetAddressPrefix')]"
          },
          "subnetServiceEndpoints": {
            "value": "[parameters('hubSubnetServiceEndpoints')]"
          },
          "firewallName": {
            "value": "[parameters('firewallName')]"
          },
          "firewallSkuTier": {
            "value": "[parameters('firewallSkuTier')]"
          },
          "firewallPolicyName": {
            "value": "[parameters('firewallPolicyName')]"
          },
          "firewallThreatIntelMode": {
            "value": "[parameters('firewallThreatIntelMode')]"
          },
          "firewallClientIpConfigurationName": {
            "value": "[parameters('firewallClientIpConfigurationName')]"
          },
          "firewallClientSubnetName": {
            "value": "[variables('firewallClientSubnetName')]"
          },
          "firewallClientSubnetAddressPrefix": {
            "value": "[parameters('firewallClientSubnetAddressPrefix')]"
          },
          "firewallClientSubnetServiceEndpoints": {
            "value": "[parameters('firewallClientSubnetServiceEndpoints')]"
          },
          "firewallClientPublicIPAddressName": {
            "value": "[parameters('firewallClientPublicIPAddressName')]"
          },
          "firewallClientPublicIPAddressSkuName": {
            "value": "[parameters('firewallClientPublicIPAddressSkuName')]"
          },
          "firewallClientPublicIpAllocationMethod": {
            "value": "[parameters('firewallClientPublicIpAllocationMethod')]"
          },
          "firewallClientPublicIPAddressAvailabilityZones": {
            "value": "[parameters('firewallClientPublicIPAddressAvailabilityZones')]"
          },
          "firewallManagementIpConfigurationName": {
            "value": "[parameters('firewallManagementIpConfigurationName')]"
          },
          "firewallManagementSubnetName": {
            "value": "[variables('firewallManagementSubnetName')]"
          },
          "firewallManagementSubnetAddressPrefix": {
            "value": "[parameters('firewallManagementSubnetAddressPrefix')]"
          },
          "firewallManagementSubnetServiceEndpoints": {
            "value": "[parameters('firewallManagementSubnetServiceEndpoints')]"
          },
          "firewallManagementPublicIPAddressName": {
            "value": "[parameters('firewallManagementPublicIPAddressName')]"
          },
          "firewallManagementPublicIPAddressSkuName": {
            "value": "[parameters('firewallManagementPublicIPAddressSkuName')]"
          },
          "firewallManagementPublicIpAllocationMethod": {
            "value": "[parameters('firewallManagementPublicIpAllocationMethod')]"
          },
          "firewallManagementPublicIPAddressAvailabilityZones": {
            "value": "[parameters('firewallManagementPublicIPAddressAvailabilityZones')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.451.19169",
              "templateHash": "7795182658623507493"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "logStorageAccountName": {
              "type": "string"
            },
            "logStorageSkuName": {
              "type": "string"
            },
            "logAnalyticsWorkspaceResourceId": {
              "type": "string"
            },
            "virtualNetworkName": {
              "type": "string"
            },
            "virtualNetworkAddressPrefix": {
              "type": "string"
            },
            "virtualNetworkDiagnosticsLogs": {
              "type": "array"
            },
            "virtualNetworkDiagnosticsMetrics": {
              "type": "array"
            },
            "networkSecurityGroupName": {
              "type": "string"
            },
            "networkSecurityGroupRules": {
              "type": "array"
            },
            "subnetName": {
              "type": "string"
            },
            "subnetAddressPrefix": {
              "type": "string"
            },
            "subnetServiceEndpoints": {
              "type": "array"
            },
            "routeTableName": {
              "type": "string",
              "defaultValue": "[format('{0}-routetable', parameters('subnetName'))]"
            },
            "routeTableRouteName": {
              "type": "string",
              "defaultValue": "default_route"
            },
            "routeTableRouteAddressPrefix": {
              "type": "string",
              "defaultValue": "0.0.0.0/0"
            },
            "routeTableRouteNextHopType": {
              "type": "string",
              "defaultValue": "VirtualAppliance"
            },
            "firewallName": {
              "type": "string"
            },
            "firewallSkuTier": {
              "type": "string"
            },
            "firewallPolicyName": {
              "type": "string"
            },
            "firewallThreatIntelMode": {
              "type": "string"
            },
            "firewallClientIpConfigurationName": {
              "type": "string"
            },
            "firewallClientSubnetName": {
              "type": "string"
            },
            "firewallClientSubnetAddressPrefix": {
              "type": "string"
            },
            "firewallClientSubnetServiceEndpoints": {
              "type": "array"
            },
            "firewallClientPublicIPAddressName": {
              "type": "string"
            },
            "firewallClientPublicIPAddressSkuName": {
              "type": "string"
            },
            "firewallClientPublicIpAllocationMethod": {
              "type": "string"
            },
            "firewallClientPublicIPAddressAvailabilityZones": {
              "type": "array"
            },
            "firewallManagementIpConfigurationName": {
              "type": "string"
            },
            "firewallManagementSubnetName": {
              "type": "string"
            },
            "firewallManagementSubnetAddressPrefix": {
              "type": "string"
            },
            "firewallManagementSubnetServiceEndpoints": {
              "type": "array"
            },
            "firewallManagementPublicIPAddressName": {
              "type": "string"
            },
            "firewallManagementPublicIPAddressSkuName": {
              "type": "string"
            },
            "firewallManagementPublicIpAllocationMethod": {
              "type": "string"
            },
            "firewallManagementPublicIPAddressAvailabilityZones": {
              "type": "array"
            }
          },
          "functions": [],
          "variables": {
            "defaultVirtualNewtorkDiagnosticsLogs": [],
            "defaultVirtualNetworkDiagnosticsMetrics": [
              {
                "category": "AllMetrics",
                "enabled": true
              }
            ],
            "defaultSubnetServiceEndpoints": [
              {
                "service": "Microsoft.Storage"
              }
            ],
            "defaultNetworkSecurityGroupRules": [
              {
                "name": "allow_ssh",
                "properties": {
                  "description": "Allow SSH access from anywhere",
                  "access": "Allow",
                  "priority": 100,
                  "protocol": "Tcp",
                  "direction": "Inbound",
                  "sourcePortRange": "*",
                  "sourceAddressPrefix": "*",
                  "destinationPortRange": "22",
                  "destinationAddressPrefix": "*"
                }
              },
              {
                "name": "allow_rdp",
                "properties": {
                  "description": "Allow RDP access from anywhere",
                  "access": "Allow",
                  "priority": 200,
                  "protocol": "Tcp",
                  "direction": "Inbound",
                  "sourcePortRange": "*",
                  "sourceAddressPrefix": "*",
                  "destinationPortRange": "3389",
                  "destinationAddressPrefix": "*"
                }
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks/subnets",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('virtualNetworkName'), parameters('subnetName'))]",
              "properties": {
                "addressPrefix": "[parameters('subnetAddressPrefix')]",
                "networkSecurityGroup": {
                  "id": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2019-10-01').outputs.id.value]"
                },
                "routeTable": {
                  "id": "[reference(resourceId('Microsoft.Resources/deployments', 'routeTable'), '2019-10-01').outputs.id.value]"
                },
                "serviceEndpoints": "[if(empty(parameters('subnetServiceEndpoints')), variables('defaultSubnetServiceEndpoints'), parameters('subnetServiceEndpoints'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'firewall')]",
                "[resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup')]",
                "[resourceId('Microsoft.Resources/deployments', 'routeTable')]",
                "[resourceId('Microsoft.Resources/deployments', 'virtualNetwork')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "logStorage",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "storageAccountName": {
                    "value": "[parameters('logStorageAccountName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "skuName": {
                    "value": "[parameters('logStorageSkuName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "7478919688835670168"
                    }
                  },
                  "parameters": {
                    "storageAccountName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2019-06-01",
                      "name": "[parameters('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "kind": "Storage",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "networkSecurityGroup",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('networkSecurityGroupName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "securityRules": {
                    "value": "[if(empty(parameters('networkSecurityGroupRules')), variables('defaultNetworkSecurityGroupRules'), parameters('networkSecurityGroupRules'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "16344320883906419641"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "securityRules": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "securityRules": "[parameters('securityRules')]"
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "virtualNetwork",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('virtualNetworkName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "addressPrefix": {
                    "value": "[parameters('virtualNetworkAddressPrefix')]"
                  },
                  "diagnosticsLogs": {
                    "value": "[if(empty(parameters('virtualNetworkDiagnosticsLogs')), variables('defaultVirtualNewtorkDiagnosticsLogs'), parameters('virtualNetworkDiagnosticsLogs'))]"
                  },
                  "diagnosticsMetrics": {
                    "value": "[if(empty(parameters('virtualNetworkDiagnosticsMetrics')), variables('defaultVirtualNetworkDiagnosticsMetrics'), parameters('virtualNetworkDiagnosticsMetrics'))]"
                  },
                  "subnets": {
                    "value": [
                      {
                        "name": "[parameters('firewallClientSubnetName')]",
                        "properties": {
                          "addressPrefix": "[parameters('firewallClientSubnetAddressPrefix')]",
                          "serviceEndpoints": "[parameters('firewallClientSubnetServiceEndpoints')]"
                        }
                      },
                      {
                        "name": "[parameters('firewallManagementSubnetName')]",
                        "properties": {
                          "addressPrefix": "[parameters('firewallManagementSubnetAddressPrefix')]",
                          "serviceEndpoints": "[parameters('firewallManagementSubnetServiceEndpoints')]"
                        }
                      }
                    ]
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "logStorageAccountResourceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logStorage'), '2019-10-01').outputs.id.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "4251305185578211506"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "addressPrefix": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "logStorageAccountResourceId": {
                      "type": "string"
                    },
                    "subnets": {
                      "type": "array"
                    },
                    "diagnosticsMetrics": {
                      "type": "array"
                    },
                    "diagnosticsLogs": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('addressPrefix')]"
                          ]
                        },
                        "subnets": "[parameters('subnets')]"
                      }
                    },
                    {
                      "type": "Microsoft.Insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "scope": "[format('Microsoft.Network/virtualNetworks/{0}', parameters('name'))]",
                      "name": "[format('{0}-diagnostics', parameters('name'))]",
                      "properties": {
                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]",
                        "metrics": "[parameters('diagnosticsMetrics')]",
                        "logs": "[parameters('diagnosticsLogs')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                    },
                    "subnets": {
                      "type": "array",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name'))).subnets]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'logStorage')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "routeTable",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('routeTableName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "routeName": {
                    "value": "[parameters('routeTableRouteName')]"
                  },
                  "routeAddressPrefix": {
                    "value": "[parameters('routeTableRouteAddressPrefix')]"
                  },
                  "routeNextHopIpAddress": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'firewall'), '2019-10-01').outputs.privateIPAddress.value]"
                  },
                  "routeNextHopType": {
                    "value": "[parameters('routeTableRouteNextHopType')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "9581615100111735872"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "routeName": {
                      "type": "string"
                    },
                    "routeAddressPrefix": {
                      "type": "string"
                    },
                    "routeNextHopIpAddress": {
                      "type": "string"
                    },
                    "routeNextHopType": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "routes": [
                          {
                            "name": "[parameters('routeName')]",
                            "properties": {
                              "addressPrefix": "[parameters('routeAddressPrefix')]",
                              "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                              "nextHopType": "[parameters('routeNextHopType')]"
                            }
                          }
                        ]
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'firewall')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "firewallClientPublicIPAddress",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('firewallClientPublicIPAddressName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "skuName": {
                    "value": "[parameters('firewallClientPublicIPAddressSkuName')]"
                  },
                  "publicIpAllocationMethod": {
                    "value": "[parameters('firewallClientPublicIpAllocationMethod')]"
                  },
                  "availabilityZones": {
                    "value": "[parameters('firewallClientPublicIPAddressAvailabilityZones')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "11223093195346446502"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "publicIpAllocationMethod": {
                      "type": "string"
                    },
                    "availabilityZones": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "properties": {
                        "publicIPAllocationMethod": "[parameters('publicIpAllocationMethod')]"
                      },
                      "zones": "[parameters('availabilityZones')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('name'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "firewallManagementPublicIPAddress",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('firewallManagementPublicIPAddressName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "skuName": {
                    "value": "[parameters('firewallManagementPublicIPAddressSkuName')]"
                  },
                  "publicIpAllocationMethod": {
                    "value": "[parameters('firewallManagementPublicIpAllocationMethod')]"
                  },
                  "availabilityZones": {
                    "value": "[parameters('firewallManagementPublicIPAddressAvailabilityZones')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "11223093195346446502"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "publicIpAllocationMethod": {
                      "type": "string"
                    },
                    "availabilityZones": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "properties": {
                        "publicIPAllocationMethod": "[parameters('publicIpAllocationMethod')]"
                      },
                      "zones": "[parameters('availabilityZones')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('name'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "firewall",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('firewallName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "skuTier": {
                    "value": "[parameters('firewallSkuTier')]"
                  },
                  "firewallPolicyName": {
                    "value": "[parameters('firewallPolicyName')]"
                  },
                  "threatIntelMode": {
                    "value": "[parameters('firewallThreatIntelMode')]"
                  },
                  "clientIpConfigurationName": {
                    "value": "[parameters('firewallClientIpConfigurationName')]"
                  },
                  "clientIpConfigurationSubnetResourceId": {
                    "value": "[format('{0}/subnets/{1}', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.id.value, parameters('firewallClientSubnetName'))]"
                  },
                  "clientIpConfigurationPublicIPAddressResourceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'firewallClientPublicIPAddress'), '2019-10-01').outputs.id.value]"
                  },
                  "managementIpConfigurationName": {
                    "value": "[parameters('firewallManagementIpConfigurationName')]"
                  },
                  "managementIpConfigurationSubnetResourceId": {
                    "value": "[format('{0}/subnets/{1}', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.id.value, parameters('firewallManagementSubnetName'))]"
                  },
                  "managementIpConfigurationPublicIPAddressResourceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'firewallManagementPublicIPAddress'), '2019-10-01').outputs.id.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "1108501968354388067"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "skuTier": {
                      "type": "string"
                    },
                    "threatIntelMode": {
                      "type": "string"
                    },
                    "clientIpConfigurationName": {
                      "type": "string"
                    },
                    "clientIpConfigurationSubnetResourceId": {
                      "type": "string"
                    },
                    "clientIpConfigurationPublicIPAddressResourceId": {
                      "type": "string"
                    },
                    "managementIpConfigurationName": {
                      "type": "string"
                    },
                    "managementIpConfigurationSubnetResourceId": {
                      "type": "string"
                    },
                    "managementIpConfigurationPublicIPAddressResourceId": {
                      "type": "string"
                    },
                    "firewallPolicyName": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/firewallPolicies",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('firewallPolicyName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "threatIntelMode": "[parameters('threatIntelMode')]",
                        "sku": {
                          "tier": "[parameters('skuTier')]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Network/azureFirewalls",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "[parameters('clientIpConfigurationName')]",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('clientIpConfigurationSubnetResourceId')]"
                              },
                              "publicIPAddress": {
                                "id": "[parameters('clientIpConfigurationPublicIPAddressResourceId')]"
                              }
                            }
                          }
                        ],
                        "managementIpConfiguration": {
                          "name": "[parameters('managementIpConfigurationName')]",
                          "properties": {
                            "subnet": {
                              "id": "[parameters('managementIpConfigurationSubnetResourceId')]"
                            },
                            "publicIPAddress": {
                              "id": "[parameters('managementIpConfigurationPublicIPAddressResourceId')]"
                            }
                          }
                        },
                        "firewallPolicy": {
                          "id": "[resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName'))]"
                        },
                        "sku": {
                          "tier": "[parameters('skuTier')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateIPAddress": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/azureFirewalls', parameters('name'))).ipConfigurations[0].properties.privateIPAddress]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'firewallClientPublicIPAddress')]",
                "[resourceId('Microsoft.Resources/deployments', 'firewallManagementPublicIPAddress')]",
                "[resourceId('Microsoft.Resources/deployments', 'virtualNetwork')]"
              ]
            }
          ],
          "outputs": {
            "virtualNetworkName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.name.value]"
            },
            "virtualNetworkResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.id.value]"
            },
            "subnetName": {
              "type": "string",
              "value": "[format('{0}/{1}', parameters('virtualNetworkName'), parameters('subnetName'))]"
            },
            "subnetAddressPrefix": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', parameters('virtualNetworkName'), parameters('subnetName')), '/')[0], split(format('{0}/{1}', parameters('virtualNetworkName'), parameters('subnetName')), '/')[1])).addressPrefix]"
            },
            "subnetResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', parameters('virtualNetworkName'), parameters('subnetName')), '/')[0], split(format('{0}/{1}', parameters('virtualNetworkName'), parameters('subnetName')), '/')[1])]"
            },
            "networkSecurityGroupName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2019-10-01').outputs.name.value]"
            },
            "networkSecurityGroupResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2019-10-01').outputs.id.value]"
            },
            "firewallPrivateIPAddress": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'firewall'), '2019-10-01').outputs.privateIPAddress.value]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', 'logAnalyticsWorkspace')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('{0}-identity', parameters('resourcePrefix'))]",
      "subscriptionId": "[parameters('identitySubscriptionId')]",
      "resourceGroup": "[parameters('identityResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('identityLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "logStorageAccountName": {
            "value": "[parameters('identityLogStorageAccountName')]"
          },
          "logStorageSkuName": {
            "value": "[parameters('identityLogStorageSkuName')]"
          },
          "logAnalyticsWorkspaceResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', 'logAnalyticsWorkspace'), '2019-10-01').outputs.id.value]"
          },
          "firewallPrivateIPAddress": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.firewallPrivateIPAddress.value]"
          },
          "virtualNetworkName": {
            "value": "[parameters('identityVirtualNetworkName')]"
          },
          "virtualNetworkAddressPrefix": {
            "value": "[parameters('identityVirtualNetworkAddressPrefix')]"
          },
          "virtualNetworkDiagnosticsLogs": {
            "value": "[parameters('identityVirtualNetworkDiagnosticsLogs')]"
          },
          "virtualNetworkDiagnosticsMetrics": {
            "value": "[parameters('identityVirtualNetworkDiagnosticsMetrics')]"
          },
          "networkSecurityGroupName": {
            "value": "[parameters('identityNetworkSecurityGroupName')]"
          },
          "networkSecurityGroupRules": {
            "value": "[parameters('identityNetworkSecurityGroupRules')]"
          },
          "subnetName": {
            "value": "[parameters('identitySubnetName')]"
          },
          "subnetAddressPrefix": {
            "value": "[parameters('identitySubnetAddressPrefix')]"
          },
          "subnetServiceEndpoints": {
            "value": "[parameters('identitySubnetServiceEndpoints')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.451.19169",
              "templateHash": "102664795413105394"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "logStorageAccountName": {
              "type": "string"
            },
            "logStorageSkuName": {
              "type": "string"
            },
            "logAnalyticsWorkspaceResourceId": {
              "type": "string"
            },
            "firewallPrivateIPAddress": {
              "type": "string"
            },
            "virtualNetworkName": {
              "type": "string"
            },
            "virtualNetworkAddressPrefix": {
              "type": "string"
            },
            "virtualNetworkDiagnosticsLogs": {
              "type": "array"
            },
            "virtualNetworkDiagnosticsMetrics": {
              "type": "array"
            },
            "networkSecurityGroupName": {
              "type": "string"
            },
            "networkSecurityGroupRules": {
              "type": "array"
            },
            "subnetName": {
              "type": "string"
            },
            "subnetAddressPrefix": {
              "type": "string"
            },
            "subnetServiceEndpoints": {
              "type": "array"
            },
            "routeTableName": {
              "type": "string",
              "defaultValue": "[format('{0}-routetable', parameters('subnetName'))]"
            },
            "routeTableRouteName": {
              "type": "string",
              "defaultValue": "default_route"
            },
            "routeTableRouteAddressPrefix": {
              "type": "string",
              "defaultValue": "0.0.0.0/0"
            },
            "routeTableRouteNextHopIpAddress": {
              "type": "string",
              "defaultValue": "[parameters('firewallPrivateIPAddress')]"
            },
            "routeTableRouteNextHopType": {
              "type": "string",
              "defaultValue": "VirtualAppliance"
            }
          },
          "functions": [],
          "variables": {
            "defaultVirtualNetworkDiagnosticsLogs": [],
            "defaultVirtualNetworkDiagnosticsMetrics": [
              {
                "category": "AllMetrics",
                "enabled": true
              }
            ],
            "defaultSubnetServiceEndpoints": [
              {
                "service": "Microsoft.Storage"
              }
            ],
            "defaultNetworkSecurityGroupRules": [
              {
                "name": "allow_ssh",
                "properties": {
                  "description": "Allow SSH access from anywhere",
                  "access": "Allow",
                  "priority": 100,
                  "protocol": "Tcp",
                  "direction": "Inbound",
                  "sourcePortRange": "*",
                  "sourceAddressPrefix": "*",
                  "destinationPortRange": "22",
                  "destinationAddressPrefix": "*"
                }
              },
              {
                "name": "allow_rdp",
                "properties": {
                  "description": "Allow RDP access from anywhere",
                  "access": "Allow",
                  "priority": 200,
                  "protocol": "Tcp",
                  "direction": "Inbound",
                  "sourcePortRange": "*",
                  "sourceAddressPrefix": "*",
                  "destinationPortRange": "3389",
                  "destinationAddressPrefix": "*"
                }
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "logStorage",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "storageAccountName": {
                    "value": "[parameters('logStorageAccountName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "skuName": {
                    "value": "[parameters('logStorageSkuName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "7478919688835670168"
                    }
                  },
                  "parameters": {
                    "storageAccountName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2019-06-01",
                      "name": "[parameters('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "kind": "Storage",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "networkSecurityGroup",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('networkSecurityGroupName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "securityRules": {
                    "value": "[if(empty(parameters('networkSecurityGroupRules')), variables('defaultNetworkSecurityGroupRules'), parameters('networkSecurityGroupRules'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "16344320883906419641"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "securityRules": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "securityRules": "[parameters('securityRules')]"
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "routeTable",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('routeTableName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "routeName": {
                    "value": "[parameters('routeTableRouteName')]"
                  },
                  "routeAddressPrefix": {
                    "value": "[parameters('routeTableRouteAddressPrefix')]"
                  },
                  "routeNextHopIpAddress": {
                    "value": "[parameters('routeTableRouteNextHopIpAddress')]"
                  },
                  "routeNextHopType": {
                    "value": "[parameters('routeTableRouteNextHopType')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "9581615100111735872"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "routeName": {
                      "type": "string"
                    },
                    "routeAddressPrefix": {
                      "type": "string"
                    },
                    "routeNextHopIpAddress": {
                      "type": "string"
                    },
                    "routeNextHopType": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "routes": [
                          {
                            "name": "[parameters('routeName')]",
                            "properties": {
                              "addressPrefix": "[parameters('routeAddressPrefix')]",
                              "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                              "nextHopType": "[parameters('routeNextHopType')]"
                            }
                          }
                        ]
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "virtualNetwork",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('virtualNetworkName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "addressPrefix": {
                    "value": "[parameters('virtualNetworkAddressPrefix')]"
                  },
                  "diagnosticsLogs": {
                    "value": "[if(empty(parameters('virtualNetworkDiagnosticsLogs')), variables('defaultVirtualNetworkDiagnosticsLogs'), parameters('virtualNetworkDiagnosticsLogs'))]"
                  },
                  "diagnosticsMetrics": {
                    "value": "[if(empty(parameters('virtualNetworkDiagnosticsMetrics')), variables('defaultVirtualNetworkDiagnosticsMetrics'), parameters('virtualNetworkDiagnosticsMetrics'))]"
                  },
                  "subnets": {
                    "value": [
                      {
                        "name": "[parameters('subnetName')]",
                        "properties": {
                          "addressPrefix": "[parameters('subnetAddressPrefix')]",
                          "networkSecurityGroup": {
                            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2019-10-01').outputs.id.value]"
                          },
                          "routeTable": {
                            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'routeTable'), '2019-10-01').outputs.id.value]"
                          },
                          "serviceEndpoints": "[if(empty(parameters('subnetServiceEndpoints')), variables('defaultSubnetServiceEndpoints'), parameters('subnetServiceEndpoints'))]"
                        }
                      }
                    ]
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "logStorageAccountResourceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logStorage'), '2019-10-01').outputs.id.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "4251305185578211506"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "addressPrefix": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "logStorageAccountResourceId": {
                      "type": "string"
                    },
                    "subnets": {
                      "type": "array"
                    },
                    "diagnosticsMetrics": {
                      "type": "array"
                    },
                    "diagnosticsLogs": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('addressPrefix')]"
                          ]
                        },
                        "subnets": "[parameters('subnets')]"
                      }
                    },
                    {
                      "type": "Microsoft.Insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "scope": "[format('Microsoft.Network/virtualNetworks/{0}', parameters('name'))]",
                      "name": "[format('{0}-diagnostics', parameters('name'))]",
                      "properties": {
                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]",
                        "metrics": "[parameters('diagnosticsMetrics')]",
                        "logs": "[parameters('diagnosticsLogs')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                    },
                    "subnets": {
                      "type": "array",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name'))).subnets]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'logStorage')]",
                "[resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup')]",
                "[resourceId('Microsoft.Resources/deployments', 'routeTable')]"
              ]
            }
          ],
          "outputs": {
            "virtualNetworkName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.name.value]"
            },
            "virtualNetworkResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.id.value]"
            },
            "subnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.subnets.value[0].name]"
            },
            "subnetAddressPrefix": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.subnets.value[0].properties.addressPrefix]"
            },
            "subnetResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.subnets.value[0].id]"
            },
            "networkSecurityGroupName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2019-10-01').outputs.name.value]"
            },
            "networkSecurityGroupResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2019-10-01').outputs.id.value]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', 'logAnalyticsWorkspace')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('{0}-operations', parameters('resourcePrefix'))]",
      "subscriptionId": "[parameters('operationsSubscriptionId')]",
      "resourceGroup": "[parameters('operationsResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('operationsLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "logStorageAccountName": {
            "value": "[parameters('operationsLogStorageAccountName')]"
          },
          "logStorageSkuName": {
            "value": "[parameters('operationsLogStorageSkuName')]"
          },
          "logAnalyticsWorkspaceResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', 'logAnalyticsWorkspace'), '2019-10-01').outputs.id.value]"
          },
          "firewallPrivateIPAddress": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.firewallPrivateIPAddress.value]"
          },
          "virtualNetworkName": {
            "value": "[parameters('operationsVirtualNetworkName')]"
          },
          "virtualNetworkAddressPrefix": {
            "value": "[parameters('operationsVirtualNetworkAddressPrefix')]"
          },
          "virtualNetworkDiagnosticsLogs": {
            "value": "[parameters('operationsVirtualNetworkDiagnosticsLogs')]"
          },
          "virtualNetworkDiagnosticsMetrics": {
            "value": "[parameters('operationsVirtualNetworkDiagnosticsMetrics')]"
          },
          "networkSecurityGroupName": {
            "value": "[parameters('operationsNetworkSecurityGroupName')]"
          },
          "networkSecurityGroupRules": {
            "value": "[parameters('operationsNetworkSecurityGroupRules')]"
          },
          "subnetName": {
            "value": "[parameters('operationsSubnetName')]"
          },
          "subnetAddressPrefix": {
            "value": "[parameters('operationsSubnetAddressPrefix')]"
          },
          "subnetServiceEndpoints": {
            "value": "[parameters('operationsSubnetServiceEndpoints')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.451.19169",
              "templateHash": "102664795413105394"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "logStorageAccountName": {
              "type": "string"
            },
            "logStorageSkuName": {
              "type": "string"
            },
            "logAnalyticsWorkspaceResourceId": {
              "type": "string"
            },
            "firewallPrivateIPAddress": {
              "type": "string"
            },
            "virtualNetworkName": {
              "type": "string"
            },
            "virtualNetworkAddressPrefix": {
              "type": "string"
            },
            "virtualNetworkDiagnosticsLogs": {
              "type": "array"
            },
            "virtualNetworkDiagnosticsMetrics": {
              "type": "array"
            },
            "networkSecurityGroupName": {
              "type": "string"
            },
            "networkSecurityGroupRules": {
              "type": "array"
            },
            "subnetName": {
              "type": "string"
            },
            "subnetAddressPrefix": {
              "type": "string"
            },
            "subnetServiceEndpoints": {
              "type": "array"
            },
            "routeTableName": {
              "type": "string",
              "defaultValue": "[format('{0}-routetable', parameters('subnetName'))]"
            },
            "routeTableRouteName": {
              "type": "string",
              "defaultValue": "default_route"
            },
            "routeTableRouteAddressPrefix": {
              "type": "string",
              "defaultValue": "0.0.0.0/0"
            },
            "routeTableRouteNextHopIpAddress": {
              "type": "string",
              "defaultValue": "[parameters('firewallPrivateIPAddress')]"
            },
            "routeTableRouteNextHopType": {
              "type": "string",
              "defaultValue": "VirtualAppliance"
            }
          },
          "functions": [],
          "variables": {
            "defaultVirtualNetworkDiagnosticsLogs": [],
            "defaultVirtualNetworkDiagnosticsMetrics": [
              {
                "category": "AllMetrics",
                "enabled": true
              }
            ],
            "defaultSubnetServiceEndpoints": [
              {
                "service": "Microsoft.Storage"
              }
            ],
            "defaultNetworkSecurityGroupRules": [
              {
                "name": "allow_ssh",
                "properties": {
                  "description": "Allow SSH access from anywhere",
                  "access": "Allow",
                  "priority": 100,
                  "protocol": "Tcp",
                  "direction": "Inbound",
                  "sourcePortRange": "*",
                  "sourceAddressPrefix": "*",
                  "destinationPortRange": "22",
                  "destinationAddressPrefix": "*"
                }
              },
              {
                "name": "allow_rdp",
                "properties": {
                  "description": "Allow RDP access from anywhere",
                  "access": "Allow",
                  "priority": 200,
                  "protocol": "Tcp",
                  "direction": "Inbound",
                  "sourcePortRange": "*",
                  "sourceAddressPrefix": "*",
                  "destinationPortRange": "3389",
                  "destinationAddressPrefix": "*"
                }
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "logStorage",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "storageAccountName": {
                    "value": "[parameters('logStorageAccountName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "skuName": {
                    "value": "[parameters('logStorageSkuName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "7478919688835670168"
                    }
                  },
                  "parameters": {
                    "storageAccountName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2019-06-01",
                      "name": "[parameters('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "kind": "Storage",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "networkSecurityGroup",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('networkSecurityGroupName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "securityRules": {
                    "value": "[if(empty(parameters('networkSecurityGroupRules')), variables('defaultNetworkSecurityGroupRules'), parameters('networkSecurityGroupRules'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "16344320883906419641"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "securityRules": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "securityRules": "[parameters('securityRules')]"
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "routeTable",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('routeTableName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "routeName": {
                    "value": "[parameters('routeTableRouteName')]"
                  },
                  "routeAddressPrefix": {
                    "value": "[parameters('routeTableRouteAddressPrefix')]"
                  },
                  "routeNextHopIpAddress": {
                    "value": "[parameters('routeTableRouteNextHopIpAddress')]"
                  },
                  "routeNextHopType": {
                    "value": "[parameters('routeTableRouteNextHopType')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "9581615100111735872"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "routeName": {
                      "type": "string"
                    },
                    "routeAddressPrefix": {
                      "type": "string"
                    },
                    "routeNextHopIpAddress": {
                      "type": "string"
                    },
                    "routeNextHopType": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "routes": [
                          {
                            "name": "[parameters('routeName')]",
                            "properties": {
                              "addressPrefix": "[parameters('routeAddressPrefix')]",
                              "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                              "nextHopType": "[parameters('routeNextHopType')]"
                            }
                          }
                        ]
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "virtualNetwork",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('virtualNetworkName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "addressPrefix": {
                    "value": "[parameters('virtualNetworkAddressPrefix')]"
                  },
                  "diagnosticsLogs": {
                    "value": "[if(empty(parameters('virtualNetworkDiagnosticsLogs')), variables('defaultVirtualNetworkDiagnosticsLogs'), parameters('virtualNetworkDiagnosticsLogs'))]"
                  },
                  "diagnosticsMetrics": {
                    "value": "[if(empty(parameters('virtualNetworkDiagnosticsMetrics')), variables('defaultVirtualNetworkDiagnosticsMetrics'), parameters('virtualNetworkDiagnosticsMetrics'))]"
                  },
                  "subnets": {
                    "value": [
                      {
                        "name": "[parameters('subnetName')]",
                        "properties": {
                          "addressPrefix": "[parameters('subnetAddressPrefix')]",
                          "networkSecurityGroup": {
                            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2019-10-01').outputs.id.value]"
                          },
                          "routeTable": {
                            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'routeTable'), '2019-10-01').outputs.id.value]"
                          },
                          "serviceEndpoints": "[if(empty(parameters('subnetServiceEndpoints')), variables('defaultSubnetServiceEndpoints'), parameters('subnetServiceEndpoints'))]"
                        }
                      }
                    ]
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "logStorageAccountResourceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logStorage'), '2019-10-01').outputs.id.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "4251305185578211506"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "addressPrefix": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "logStorageAccountResourceId": {
                      "type": "string"
                    },
                    "subnets": {
                      "type": "array"
                    },
                    "diagnosticsMetrics": {
                      "type": "array"
                    },
                    "diagnosticsLogs": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('addressPrefix')]"
                          ]
                        },
                        "subnets": "[parameters('subnets')]"
                      }
                    },
                    {
                      "type": "Microsoft.Insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "scope": "[format('Microsoft.Network/virtualNetworks/{0}', parameters('name'))]",
                      "name": "[format('{0}-diagnostics', parameters('name'))]",
                      "properties": {
                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]",
                        "metrics": "[parameters('diagnosticsMetrics')]",
                        "logs": "[parameters('diagnosticsLogs')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                    },
                    "subnets": {
                      "type": "array",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name'))).subnets]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'logStorage')]",
                "[resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup')]",
                "[resourceId('Microsoft.Resources/deployments', 'routeTable')]"
              ]
            }
          ],
          "outputs": {
            "virtualNetworkName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.name.value]"
            },
            "virtualNetworkResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.id.value]"
            },
            "subnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.subnets.value[0].name]"
            },
            "subnetAddressPrefix": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.subnets.value[0].properties.addressPrefix]"
            },
            "subnetResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.subnets.value[0].id]"
            },
            "networkSecurityGroupName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2019-10-01').outputs.name.value]"
            },
            "networkSecurityGroupResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2019-10-01').outputs.id.value]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', 'logAnalyticsWorkspace')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('{0}-sharedServices', parameters('resourcePrefix'))]",
      "subscriptionId": "[parameters('sharedServicesSubscriptionId')]",
      "resourceGroup": "[parameters('sharedServicesResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('sharedServicesLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "logStorageAccountName": {
            "value": "[parameters('sharedServicesLogStorageAccountName')]"
          },
          "logStorageSkuName": {
            "value": "[parameters('sharedServicesLogStorageSkuName')]"
          },
          "logAnalyticsWorkspaceResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', 'logAnalyticsWorkspace'), '2019-10-01').outputs.id.value]"
          },
          "firewallPrivateIPAddress": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.firewallPrivateIPAddress.value]"
          },
          "virtualNetworkName": {
            "value": "[parameters('sharedServicesVirtualNetworkName')]"
          },
          "virtualNetworkAddressPrefix": {
            "value": "[parameters('sharedServicesVirtualNetworkAddressPrefix')]"
          },
          "virtualNetworkDiagnosticsLogs": {
            "value": "[parameters('sharedServicesVirtualNetworkDiagnosticsLogs')]"
          },
          "virtualNetworkDiagnosticsMetrics": {
            "value": "[parameters('sharedServicesVirtualNetworkDiagnosticsMetrics')]"
          },
          "networkSecurityGroupName": {
            "value": "[parameters('sharedServicesNetworkSecurityGroupName')]"
          },
          "networkSecurityGroupRules": {
            "value": "[parameters('sharedServicesNetworkSecurityGroupRules')]"
          },
          "subnetName": {
            "value": "[parameters('sharedServicesSubnetName')]"
          },
          "subnetAddressPrefix": {
            "value": "[parameters('sharedServicesSubnetAddressPrefix')]"
          },
          "subnetServiceEndpoints": {
            "value": "[parameters('sharedServicesSubnetServiceEndpoints')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.451.19169",
              "templateHash": "102664795413105394"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "logStorageAccountName": {
              "type": "string"
            },
            "logStorageSkuName": {
              "type": "string"
            },
            "logAnalyticsWorkspaceResourceId": {
              "type": "string"
            },
            "firewallPrivateIPAddress": {
              "type": "string"
            },
            "virtualNetworkName": {
              "type": "string"
            },
            "virtualNetworkAddressPrefix": {
              "type": "string"
            },
            "virtualNetworkDiagnosticsLogs": {
              "type": "array"
            },
            "virtualNetworkDiagnosticsMetrics": {
              "type": "array"
            },
            "networkSecurityGroupName": {
              "type": "string"
            },
            "networkSecurityGroupRules": {
              "type": "array"
            },
            "subnetName": {
              "type": "string"
            },
            "subnetAddressPrefix": {
              "type": "string"
            },
            "subnetServiceEndpoints": {
              "type": "array"
            },
            "routeTableName": {
              "type": "string",
              "defaultValue": "[format('{0}-routetable', parameters('subnetName'))]"
            },
            "routeTableRouteName": {
              "type": "string",
              "defaultValue": "default_route"
            },
            "routeTableRouteAddressPrefix": {
              "type": "string",
              "defaultValue": "0.0.0.0/0"
            },
            "routeTableRouteNextHopIpAddress": {
              "type": "string",
              "defaultValue": "[parameters('firewallPrivateIPAddress')]"
            },
            "routeTableRouteNextHopType": {
              "type": "string",
              "defaultValue": "VirtualAppliance"
            }
          },
          "functions": [],
          "variables": {
            "defaultVirtualNetworkDiagnosticsLogs": [],
            "defaultVirtualNetworkDiagnosticsMetrics": [
              {
                "category": "AllMetrics",
                "enabled": true
              }
            ],
            "defaultSubnetServiceEndpoints": [
              {
                "service": "Microsoft.Storage"
              }
            ],
            "defaultNetworkSecurityGroupRules": [
              {
                "name": "allow_ssh",
                "properties": {
                  "description": "Allow SSH access from anywhere",
                  "access": "Allow",
                  "priority": 100,
                  "protocol": "Tcp",
                  "direction": "Inbound",
                  "sourcePortRange": "*",
                  "sourceAddressPrefix": "*",
                  "destinationPortRange": "22",
                  "destinationAddressPrefix": "*"
                }
              },
              {
                "name": "allow_rdp",
                "properties": {
                  "description": "Allow RDP access from anywhere",
                  "access": "Allow",
                  "priority": 200,
                  "protocol": "Tcp",
                  "direction": "Inbound",
                  "sourcePortRange": "*",
                  "sourceAddressPrefix": "*",
                  "destinationPortRange": "3389",
                  "destinationAddressPrefix": "*"
                }
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "logStorage",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "storageAccountName": {
                    "value": "[parameters('logStorageAccountName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "skuName": {
                    "value": "[parameters('logStorageSkuName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "7478919688835670168"
                    }
                  },
                  "parameters": {
                    "storageAccountName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2019-06-01",
                      "name": "[parameters('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "kind": "Storage",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "networkSecurityGroup",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('networkSecurityGroupName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "securityRules": {
                    "value": "[if(empty(parameters('networkSecurityGroupRules')), variables('defaultNetworkSecurityGroupRules'), parameters('networkSecurityGroupRules'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "16344320883906419641"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "securityRules": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "securityRules": "[parameters('securityRules')]"
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "routeTable",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('routeTableName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "routeName": {
                    "value": "[parameters('routeTableRouteName')]"
                  },
                  "routeAddressPrefix": {
                    "value": "[parameters('routeTableRouteAddressPrefix')]"
                  },
                  "routeNextHopIpAddress": {
                    "value": "[parameters('routeTableRouteNextHopIpAddress')]"
                  },
                  "routeNextHopType": {
                    "value": "[parameters('routeTableRouteNextHopType')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "9581615100111735872"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "routeName": {
                      "type": "string"
                    },
                    "routeAddressPrefix": {
                      "type": "string"
                    },
                    "routeNextHopIpAddress": {
                      "type": "string"
                    },
                    "routeNextHopType": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "routes": [
                          {
                            "name": "[parameters('routeName')]",
                            "properties": {
                              "addressPrefix": "[parameters('routeAddressPrefix')]",
                              "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                              "nextHopType": "[parameters('routeNextHopType')]"
                            }
                          }
                        ]
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "virtualNetwork",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('virtualNetworkName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "addressPrefix": {
                    "value": "[parameters('virtualNetworkAddressPrefix')]"
                  },
                  "diagnosticsLogs": {
                    "value": "[if(empty(parameters('virtualNetworkDiagnosticsLogs')), variables('defaultVirtualNetworkDiagnosticsLogs'), parameters('virtualNetworkDiagnosticsLogs'))]"
                  },
                  "diagnosticsMetrics": {
                    "value": "[if(empty(parameters('virtualNetworkDiagnosticsMetrics')), variables('defaultVirtualNetworkDiagnosticsMetrics'), parameters('virtualNetworkDiagnosticsMetrics'))]"
                  },
                  "subnets": {
                    "value": [
                      {
                        "name": "[parameters('subnetName')]",
                        "properties": {
                          "addressPrefix": "[parameters('subnetAddressPrefix')]",
                          "networkSecurityGroup": {
                            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2019-10-01').outputs.id.value]"
                          },
                          "routeTable": {
                            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'routeTable'), '2019-10-01').outputs.id.value]"
                          },
                          "serviceEndpoints": "[if(empty(parameters('subnetServiceEndpoints')), variables('defaultSubnetServiceEndpoints'), parameters('subnetServiceEndpoints'))]"
                        }
                      }
                    ]
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "logStorageAccountResourceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logStorage'), '2019-10-01').outputs.id.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "4251305185578211506"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "addressPrefix": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "logStorageAccountResourceId": {
                      "type": "string"
                    },
                    "subnets": {
                      "type": "array"
                    },
                    "diagnosticsMetrics": {
                      "type": "array"
                    },
                    "diagnosticsLogs": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('addressPrefix')]"
                          ]
                        },
                        "subnets": "[parameters('subnets')]"
                      }
                    },
                    {
                      "type": "Microsoft.Insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "scope": "[format('Microsoft.Network/virtualNetworks/{0}', parameters('name'))]",
                      "name": "[format('{0}-diagnostics', parameters('name'))]",
                      "properties": {
                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]",
                        "metrics": "[parameters('diagnosticsMetrics')]",
                        "logs": "[parameters('diagnosticsLogs')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                    },
                    "subnets": {
                      "type": "array",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name'))).subnets]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'logStorage')]",
                "[resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup')]",
                "[resourceId('Microsoft.Resources/deployments', 'routeTable')]"
              ]
            }
          ],
          "outputs": {
            "virtualNetworkName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.name.value]"
            },
            "virtualNetworkResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.id.value]"
            },
            "subnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.subnets.value[0].name]"
            },
            "subnetAddressPrefix": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.subnets.value[0].properties.addressPrefix]"
            },
            "subnetResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2019-10-01').outputs.subnets.value[0].id]"
            },
            "networkSecurityGroupName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2019-10-01').outputs.name.value]"
            },
            "networkSecurityGroupResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2019-10-01').outputs.id.value]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', 'logAnalyticsWorkspace')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('{0}-hubVirtualNetworkPeerings', parameters('resourcePrefix'))]",
      "subscriptionId": "[parameters('hubSubscriptionId')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "hubResourceGroupName": {
            "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', 'hubResourceGroup'), '2019-10-01').outputs.name.value]"
          },
          "hubVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkName.value]"
          },
          "identityVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('identitySubscriptionId'), parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-identity', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkName.value]"
          },
          "operationsVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-operations', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkName.value]"
          },
          "sharedServicesVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('sharedServicesSubscriptionId'), parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-sharedServices', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkName.value]"
          },
          "identityVirtualNetworkResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('identitySubscriptionId'), parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-identity', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkResourceId.value]"
          },
          "operationsVirtualNetworkResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('sharedServicesSubscriptionId'), parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-sharedServices', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkResourceId.value]"
          },
          "sharedServicesVirtualNetworkResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-operations', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.451.19169",
              "templateHash": "1911650182896073393"
            }
          },
          "parameters": {
            "hubResourceGroupName": {
              "type": "string"
            },
            "hubVirtualNetworkName": {
              "type": "string"
            },
            "identityVirtualNetworkName": {
              "type": "string"
            },
            "identityVirtualNetworkResourceId": {
              "type": "string"
            },
            "operationsVirtualNetworkName": {
              "type": "string"
            },
            "operationsVirtualNetworkResourceId": {
              "type": "string"
            },
            "sharedServicesVirtualNetworkName": {
              "type": "string"
            },
            "sharedServicesVirtualNetworkResourceId": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "hubToIdentityVirtualNetworkPeering",
              "resourceGroup": "[parameters('hubResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('{0}/to-{1}', parameters('hubVirtualNetworkName'), parameters('identityVirtualNetworkName'))]"
                  },
                  "remoteVirtualNetworkResourceId": {
                    "value": "[parameters('identityVirtualNetworkResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "16145505190701732004"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                        }
                      }
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "hubToOperationsVirtualNetworkPeering",
              "resourceGroup": "[parameters('hubResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('{0}/to-{1}', parameters('hubVirtualNetworkName'), parameters('operationsVirtualNetworkName'))]"
                  },
                  "remoteVirtualNetworkResourceId": {
                    "value": "[parameters('operationsVirtualNetworkResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "16145505190701732004"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                        }
                      }
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "hubToSharedServicesVirtualNetworkPeering",
              "resourceGroup": "[parameters('hubResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('{0}/to-{1}', parameters('hubVirtualNetworkName'), parameters('sharedServicesVirtualNetworkName'))]"
                  },
                  "remoteVirtualNetworkResourceId": {
                    "value": "[parameters('sharedServicesVirtualNetworkResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "16145505190701732004"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                        }
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix')))]",
        "[subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', 'hubResourceGroup')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('identitySubscriptionId'), parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-identity', parameters('resourcePrefix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-operations', parameters('resourcePrefix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('sharedServicesSubscriptionId'), parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-sharedServices', parameters('resourcePrefix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('{0}-identityVirtualNetworkPeerings', parameters('resourcePrefix'))]",
      "subscriptionId": "[parameters('identitySubscriptionId')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "spokeResourceGroupName": {
            "value": "[reference(subscriptionResourceId(parameters('identitySubscriptionId'), 'Microsoft.Resources/deployments', 'identityResourceGroup'), '2019-10-01').outputs.name.value]"
          },
          "spokeVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('identitySubscriptionId'), parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-identity', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkName.value]"
          },
          "hubVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkName.value]"
          },
          "hubVirtualNetworkResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.451.19169",
              "templateHash": "13857954278136382775"
            }
          },
          "parameters": {
            "spokeResourceGroupName": {
              "type": "string"
            },
            "spokeVirtualNetworkName": {
              "type": "string"
            },
            "hubVirtualNetworkName": {
              "type": "string"
            },
            "hubVirtualNetworkResourceId": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "spokeNetworkPeering",
              "resourceGroup": "[parameters('spokeResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('{0}/to-{1}', parameters('spokeVirtualNetworkName'), parameters('hubVirtualNetworkName'))]"
                  },
                  "remoteVirtualNetworkResourceId": {
                    "value": "[parameters('hubVirtualNetworkResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "16145505190701732004"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                        }
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('identitySubscriptionId'), parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-identity', parameters('resourcePrefix')))]",
        "[subscriptionResourceId(parameters('identitySubscriptionId'), 'Microsoft.Resources/deployments', 'identityResourceGroup')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('{0}-operationsVirtualNetworkPeerings', parameters('resourcePrefix'))]",
      "subscriptionId": "[parameters('operationsSubscriptionId')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "spokeResourceGroupName": {
            "value": "[reference(subscriptionResourceId(parameters('operationsSubscriptionId'), 'Microsoft.Resources/deployments', 'operationsResourceGroup'), '2019-10-01').outputs.name.value]"
          },
          "spokeVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-operations', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkName.value]"
          },
          "hubVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkName.value]"
          },
          "hubVirtualNetworkResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.451.19169",
              "templateHash": "13857954278136382775"
            }
          },
          "parameters": {
            "spokeResourceGroupName": {
              "type": "string"
            },
            "spokeVirtualNetworkName": {
              "type": "string"
            },
            "hubVirtualNetworkName": {
              "type": "string"
            },
            "hubVirtualNetworkResourceId": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "spokeNetworkPeering",
              "resourceGroup": "[parameters('spokeResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('{0}/to-{1}', parameters('spokeVirtualNetworkName'), parameters('hubVirtualNetworkName'))]"
                  },
                  "remoteVirtualNetworkResourceId": {
                    "value": "[parameters('hubVirtualNetworkResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "16145505190701732004"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                        }
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-operations', parameters('resourcePrefix')))]",
        "[subscriptionResourceId(parameters('operationsSubscriptionId'), 'Microsoft.Resources/deployments', 'operationsResourceGroup')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('{0}-sharedServicesVirtualNetworkPeerings', parameters('resourcePrefix'))]",
      "subscriptionId": "[parameters('sharedServicesSubscriptionId')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "spokeResourceGroupName": {
            "value": "[reference(subscriptionResourceId(parameters('sharedServicesSubscriptionId'), 'Microsoft.Resources/deployments', 'sharedServicesResourceGroup'), '2019-10-01').outputs.name.value]"
          },
          "spokeVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('sharedServicesSubscriptionId'), parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-sharedServices', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkName.value]"
          },
          "hubVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkName.value]"
          },
          "hubVirtualNetworkResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.451.19169",
              "templateHash": "13857954278136382775"
            }
          },
          "parameters": {
            "spokeResourceGroupName": {
              "type": "string"
            },
            "spokeVirtualNetworkName": {
              "type": "string"
            },
            "hubVirtualNetworkName": {
              "type": "string"
            },
            "hubVirtualNetworkResourceId": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "spokeNetworkPeering",
              "resourceGroup": "[parameters('spokeResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('{0}/to-{1}', parameters('spokeVirtualNetworkName'), parameters('hubVirtualNetworkName'))]"
                  },
                  "remoteVirtualNetworkResourceId": {
                    "value": "[parameters('hubVirtualNetworkResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.451.19169",
                      "templateHash": "16145505190701732004"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                        }
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('sharedServicesSubscriptionId'), parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-sharedServices', parameters('resourcePrefix')))]",
        "[subscriptionResourceId(parameters('sharedServicesSubscriptionId'), 'Microsoft.Resources/deployments', 'sharedServicesResourceGroup')]"
      ]
    }
  ],
  "outputs": {
    "hubSubscriptionId": {
      "type": "string",
      "value": "[parameters('hubSubscriptionId')]"
    },
    "hubResourceGroupName": {
      "type": "string",
      "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', 'hubResourceGroup'), '2019-10-01').outputs.name.value]"
    },
    "hubResourceGroupResourceId": {
      "type": "string",
      "value": "[reference(subscriptionResourceId(parameters('hubSubscriptionId'), 'Microsoft.Resources/deployments', 'hubResourceGroup'), '2019-10-01').outputs.id.value]"
    },
    "hubVirtualNetworkName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkName.value]"
    },
    "hubVirtualNetworkResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkResourceId.value]"
    },
    "hubSubnetName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.subnetName.value]"
    },
    "hubSubnetResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.subnetResourceId.value]"
    },
    "hubSubnetAddressPrefix": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.subnetAddressPrefix.value]"
    },
    "hubNetworkSecurityGroupName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.networkSecurityGroupName.value]"
    },
    "hubNetworkSecurityGroupResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.networkSecurityGroupResourceId.value]"
    },
    "hubFirewallPrivateIPAddress": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.firewallPrivateIPAddress.value]"
    },
    "logAnalyticsWorkspaceName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', 'logAnalyticsWorkspace'), '2019-10-01').outputs.name.value]"
    },
    "logAnalyticsWorkspaceResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', 'logAnalyticsWorkspace'), '2019-10-01').outputs.id.value]"
    },
    "firewallPrivateIPAddress": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('hubSubscriptionId'), parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-hub', parameters('resourcePrefix'))), '2019-10-01').outputs.firewallPrivateIPAddress.value]"
    },
    "identitySubscriptionId": {
      "type": "string",
      "value": "[parameters('identitySubscriptionId')]"
    },
    "identityResourceGroupName": {
      "type": "string",
      "value": "[reference(subscriptionResourceId(parameters('identitySubscriptionId'), 'Microsoft.Resources/deployments', 'identityResourceGroup'), '2019-10-01').outputs.name.value]"
    },
    "identityResourceGroupResourceId": {
      "type": "string",
      "value": "[reference(subscriptionResourceId(parameters('identitySubscriptionId'), 'Microsoft.Resources/deployments', 'identityResourceGroup'), '2019-10-01').outputs.id.value]"
    },
    "identityVirtualNetworkName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('identitySubscriptionId'), parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-identity', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkName.value]"
    },
    "identityVirtualNetworkResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('identitySubscriptionId'), parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-identity', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkResourceId.value]"
    },
    "identitySubnetName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('identitySubscriptionId'), parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-identity', parameters('resourcePrefix'))), '2019-10-01').outputs.subnetName.value]"
    },
    "identitySubnetResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('identitySubscriptionId'), parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-identity', parameters('resourcePrefix'))), '2019-10-01').outputs.subnetResourceId.value]"
    },
    "identitySubnetAddressPrefix": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('identitySubscriptionId'), parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-identity', parameters('resourcePrefix'))), '2019-10-01').outputs.subnetAddressPrefix.value]"
    },
    "identityNetworkSecurityGroupName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('identitySubscriptionId'), parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-identity', parameters('resourcePrefix'))), '2019-10-01').outputs.networkSecurityGroupName.value]"
    },
    "identityNetworkSecurityGroupResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('identitySubscriptionId'), parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-identity', parameters('resourcePrefix'))), '2019-10-01').outputs.networkSecurityGroupResourceId.value]"
    },
    "operationsSubscriptionId": {
      "type": "string",
      "value": "[parameters('operationsSubscriptionId')]"
    },
    "operationsResourceGroupName": {
      "type": "string",
      "value": "[reference(subscriptionResourceId(parameters('operationsSubscriptionId'), 'Microsoft.Resources/deployments', 'operationsResourceGroup'), '2019-10-01').outputs.name.value]"
    },
    "operationsResourceGroupResourceId": {
      "type": "string",
      "value": "[reference(subscriptionResourceId(parameters('operationsSubscriptionId'), 'Microsoft.Resources/deployments', 'operationsResourceGroup'), '2019-10-01').outputs.id.value]"
    },
    "operationsVirtualNetworkName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-operations', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkName.value]"
    },
    "operationsVirtualNetworkResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-operations', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkResourceId.value]"
    },
    "operationsSubnetName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-operations', parameters('resourcePrefix'))), '2019-10-01').outputs.subnetName.value]"
    },
    "operationsSubnetResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-operations', parameters('resourcePrefix'))), '2019-10-01').outputs.subnetResourceId.value]"
    },
    "operationsSubnetAddressPrefix": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-operations', parameters('resourcePrefix'))), '2019-10-01').outputs.subnetAddressPrefix.value]"
    },
    "operationsNetworkSecurityGroupName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-operations', parameters('resourcePrefix'))), '2019-10-01').outputs.networkSecurityGroupName.value]"
    },
    "operationsNetworkSecurityGroupResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('operationsSubscriptionId'), parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-operations', parameters('resourcePrefix'))), '2019-10-01').outputs.networkSecurityGroupResourceId.value]"
    },
    "sharedServicesSubscriptionId": {
      "type": "string",
      "value": "[parameters('sharedServicesSubscriptionId')]"
    },
    "sharedServicesResourceGroupName": {
      "type": "string",
      "value": "[reference(subscriptionResourceId(parameters('sharedServicesSubscriptionId'), 'Microsoft.Resources/deployments', 'sharedServicesResourceGroup'), '2019-10-01').outputs.name.value]"
    },
    "sharedServicesResourceGroupResourceId": {
      "type": "string",
      "value": "[reference(subscriptionResourceId(parameters('sharedServicesSubscriptionId'), 'Microsoft.Resources/deployments', 'sharedServicesResourceGroup'), '2019-10-01').outputs.id.value]"
    },
    "sharedServicesVirtualNetworkName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('sharedServicesSubscriptionId'), parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-sharedServices', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkName.value]"
    },
    "sharedServicesVirtualNetworkResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('sharedServicesSubscriptionId'), parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-sharedServices', parameters('resourcePrefix'))), '2019-10-01').outputs.virtualNetworkResourceId.value]"
    },
    "sharedServicesSubnetName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('sharedServicesSubscriptionId'), parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-sharedServices', parameters('resourcePrefix'))), '2019-10-01').outputs.subnetName.value]"
    },
    "sharedServicesSubnetResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('sharedServicesSubscriptionId'), parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-sharedServices', parameters('resourcePrefix'))), '2019-10-01').outputs.subnetResourceId.value]"
    },
    "sharedServicesSubnetAddressPrefix": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('sharedServicesSubscriptionId'), parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-sharedServices', parameters('resourcePrefix'))), '2019-10-01').outputs.subnetAddressPrefix.value]"
    },
    "sharedServicesNetworkSecurityGroupName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('sharedServicesSubscriptionId'), parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-sharedServices', parameters('resourcePrefix'))), '2019-10-01').outputs.networkSecurityGroupName.value]"
    },
    "sharedServicesNetworkSecurityGroupResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('sharedServicesSubscriptionId'), parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('{0}-sharedServices', parameters('resourcePrefix'))), '2019-10-01').outputs.networkSecurityGroupResourceId.value]"
    }
  }
}